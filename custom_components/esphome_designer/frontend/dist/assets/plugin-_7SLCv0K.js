import{d as B,f as K,e as X,E as q,g as J,a as Q}from"./main-CoaHx0i1.js";const U=new Map,W=new Set,w=(i,t,{getColorStyle:e})=>{const s=t.props||{},o=t.entity_id||"",a=s.border!==!1,p=e()==="#ffffff";let c=s.background_color;(!c||c==="transparent"||c==="inherit")&&(c=p?"black":"white");let E=s.color||"theme_auto";E===c&&(E=c==="white"||c==="#ffffff"?"black":"white");const F=e(E),h=e(c);i.style.boxSizing="border-box",i.style.backgroundColor=h,i.style.overflow="hidden",a&&(i.style.border="2px solid "+F);const A="http://www.w3.org/2000/svg",d=document.createElementNS(A,"svg");d.setAttribute("width","100%"),d.setAttribute("height","100%"),d.setAttribute("viewBox",`0 0 ${t.width} ${t.height}`),d.style.display="block",B(d,t.width,t.height,s.x_grid,s.y_grid,p?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)");let _=s.auto_scale!==!1?NaN:parseFloat(s.min_value)||0,S=s.auto_scale!==!1?NaN:parseFloat(s.max_value)||100,f=null;if(o){const n=s.duration||"1h",r=`${o}_${n}`,T=U.get(r);T&&Date.now()-T.timestamp<6e4?f=T.data:W.has(r)||(W.add(r),K(o,n).then(N=>{U.set(r,{data:N,timestamp:Date.now()}),W.delete(r),X(q.WIDGET_UPDATED,t.id)}).catch(()=>{W.delete(r)}))}let $=_,g=S;if(f&&f.length>0&&(isNaN(_)||isNaN(S))){const n=f.map(r=>parseFloat(r.state)).filter(r=>!isNaN(r));if(n.length>0){$=Math.min(...n),g=Math.max(...n);const r=(g-$)*.1||1;$-=r,g+=r}}isNaN($)&&($=0),isNaN(g)&&(g=100);const m=J(t.width,t.height,$,g,f,s.duration),y=document.createElementNS(A,"polyline"),C=m.map(n=>`${n.x},${n.y}`).join(" ");y.setAttribute("points",C),y.setAttribute("fill","none"),y.setAttribute("stroke",F);const I=parseInt(s.line_thickness||3,10);y.setAttribute("stroke-width",I),y.setAttribute("stroke-linejoin","round");const k=s.line_type||"SOLID";k==="DASHED"?y.setAttribute("stroke-dasharray","5,5"):k==="DOTTED"&&y.setAttribute("stroke-dasharray","2,2"),d.appendChild(y),i.appendChild(d);const x=t.id;if(setTimeout(()=>{const r=i.closest(".artboard");r&&Q(r,t.x,t.y,t.width,t.height,$,g,s.duration,x,p?"#ffffff":"#666666")},0),t.title){const n=document.createElement("div");n.style.position="absolute",n.style.top="2px",n.style.left="50%",n.style.transform="translateX(-50%)",n.style.fontSize="10px",n.style.color=F,n.style.backgroundColor=c==="black"?"rgba(0,0,0,0.7)":"rgba(255,255,255,0.7)",n.style.padding="0 4px",n.style.borderRadius="2px",n.style.whiteSpace="nowrap",n.textContent=t.title,i.appendChild(n)}else if(!o){const n=document.createElement("div");n.style.position="absolute",n.style.top="50%",n.style.left="50%",n.style.transform="translate(-50%, -50%)",n.style.fontSize="10px",n.style.color=p?"#ccc":"#999",n.style.backgroundColor=c==="black"?"rgba(0,0,0,0.8)":"rgba(255,255,255,0.8)",n.style.padding="2px 6px",n.textContent="graph (No Entity)",i.appendChild(n)}},tt=(i,{common:t,convertColor:e})=>{const s=i.props||{},o=(i.entity_id||"").replace(/[^a-zA-Z0-9_]/g,"_"),a=`chart_${i.id}`.replace(/-/g,"_"),p={...t,id:a,type:"LINE",duration:s.duration||"1h",bg_color:e(s.background_color||s.bg_color||"white"),series:[{sensor:o,color:e(s.color||"black"),width:s.line_thickness||2}],y_min:s.min_value||0,y_max:s.max_value||100};return s.use_ha_history&&(p.use_ha_history=!0),{lv_chart:p}},it=(i,t)=>{const{lines:e,addFont:s,getColorConst:o,addDitherMask:a,getCondProps:p,getConditionCheck:c,isEpaper:E,sanitize:F}=t,h=i.props||{},A=(i.entity_id||"").trim(),d=F(i.title||""),_=h.duration||"1h",S=h.border!==!1,f=h.background_color||"transparent",$=f!=="transparent"?o(f):null,g=h.color||"theme_auto",m=o(g),y=h.line_type||"SOLID",C=parseInt(h.line_thickness||3,10),I=!!h.continuous,k=h.min_value||"",x=h.max_value||"",n=h.min_range||"",r=h.max_range||"",T=`graph_${i.id}`.replace(/-/g,"_"),N=s("Roboto",400,12),Z=h.grid!==!1;let G=h.x_grid||"",H=h.y_grid||"";if(Z){if(!G){const D=_.match(/^(\d+(?:\.\d+)?)(min|h|d)$/);if(D){const j=parseFloat(D[1]),O=D[2];let b=j/4;O==="h"?G=b>=1?`${Math.round(b)}h`:`${Math.round(b*60)}min`:O==="min"?G=`${Math.round(b)}min`:O==="d"&&(G=`${Math.round(b*24)}h`)}else G="1h"}if(!H){const D=parseFloat(k)||0,b=((parseFloat(x)||100)-D)/4,v=Math.pow(10,Math.floor(Math.log10(b))),V=b/v;let L=V<=1?v:V<=2?2*v:V<=5?5*v:10*v;H=String(L)}}e.push(`        // widget:graph id:${i.id} type:graph x:${i.x} y:${i.y} w:${i.width} h:${i.height} title:"${d}" entity:${A} local:${!!h.is_local_sensor} duration:${_} border:${S} color:${g} background:${f} x_grid:${G} y_grid:${H} line_type:${y} line_thickness:${C} continuous:${I} min_value:${k} max_value:${x} min_range:${n} max_range:${r} ${p(i)}`);const Y=c(i);if(Y&&e.push(`        ${Y}`),$&&e.push(`        it.fill_rectangle(${i.x}, ${i.y}, ${i.width}, ${i.height}, ${$});`),A){if(h.use_ha_history){const l=`hist_${i.id}`.replace(/-/g,"_"),u=h.history_points||100,M=h.auto_scale!==!1;e.push(`        // Draw historical graph from global array ${l}`),e.push("        {"),M?(e.push(`          float g_min = id(${l}_min);`),e.push(`          float g_max = id(${l}_max);`),e.push("          // Add slight padding to scale"),e.push("          float g_pad = (g_max - g_min) * 0.05;"),e.push("          if (g_pad == 0) g_pad = 1.0;"),e.push("          g_min -= g_pad; g_max += g_pad;"),e.push("          float g_range = g_max - g_min;")):(e.push(`          float g_min = ${k||"0"};`),e.push(`          float g_max = ${x||"100"};`),e.push("          float g_range = g_max - g_min;")),e.push("          if (g_range == 0) g_range = 1.0;"),e.push(`          for (int i = 0; i < ${u} - 1; i++) {`),e.push(`            float val1 = id(${l})[i];`),e.push(`            float val2 = id(${l})[i+1];`),e.push("            if (isnan(val1) || isnan(val2)) continue;"),e.push(`            int x1 = ${i.x} + (i * ${i.width}) / (${u}-1);`),e.push(`            int x2 = ${i.x} + ((i+1) * ${i.width}) / (${u}-1);`),e.push(`            int y1 = ${i.y} + ${i.height} - (int)((val1 - g_min) / g_range * ${i.height});`),e.push(`            int y2 = ${i.y} + ${i.height} - (int)((val2 - g_min) / g_range * ${i.height});`),e.push(`            it.line(x1, y1, x2, y2, ${m});`),C>1&&e.push(`            it.line(x1, y1+1, x2, y2+1, ${m});`),e.push("          }"),e.push("        }")}else e.push(`        it.graph(${i.x}, ${i.y}, id(${T}));`);if(S&&(e.push(`        for (int i = 0; i < ${C}; i++) {`),e.push(`          it.rectangle(${i.x} + i, ${i.y} + i, ${i.width} - 2 * i, ${i.height} - 2 * i, ${m});`),e.push("        }"),a(e,g,E,i.x,i.y,i.width,i.height)),H)for(let u=1;u<4;u++){const M=Math.round(i.height*(u/4));e.push(`        for (int i = 0; i < ${i.width}; i += 4) {`),e.push(`          it.draw_pixel_at(${i.x} + i, ${i.y+M}, ${m});`),e.push("        }")}if(G)for(let u=1;u<4;u++){const M=Math.round(i.width*(u/4));e.push(`        for (int i = 0; i < ${i.height}; i += 4) {`),e.push(`          it.draw_pixel_at(${i.x+M}, ${i.y} + i, ${m});`),e.push("        }")}d&&e.push(`        it.printf(${i.x}+4, ${i.y}+2, id(${N}), ${m}, TextAlign::TOP_LEFT, "${d}");`);const D=parseFloat(k)||0,O=(parseFloat(x)||100)-D,b=4;for(let l=0;l<=b;l++){const u=l/b,M=D+O*u,R=Math.round(i.height*(1-u)),P=O>=10?"%.0f":"%.1f";e.push(`        it.printf(${i.x} - 4, ${i.y} + ${R} - 6, id(${N}), ${m}, TextAlign::TOP_RIGHT, "${P}", (float)${M});`)}let v=3600;const V=_.match(/^(\d+)([a-z]+)$/i);if(V){const l=parseInt(V[1],10),u=V[2].toLowerCase();u.startsWith("s")?v=l:u.startsWith("m")?v=l*60:u.startsWith("h")?v=l*3600:u.startsWith("d")&&(v=l*86400)}const L=2;for(let l=0;l<=L;l++){const u=l/L,M=Math.round(i.width*u);let R="TextAlign::TOP_CENTER";l===0&&(R="TextAlign::TOP_LEFT"),l===L&&(R="TextAlign::TOP_RIGHT");let P=l===L?"Now":"";if(l!==L){const z=v*(1-u);z>=3600?P=`-${(z/3600).toFixed(1)}h`:z>=60?P=`-${(z/60).toFixed(0)}m`:P=`-${z.toFixed(0)}s`}e.push(`        it.printf(${i.x} + ${M}, ${i.y} + ${i.height} + 2, id(${N}), ${m}, ${R}, "${P}");`)}}else e.push(`        it.printf(${i.x}+5, ${i.y}+5, id(${N}), ${m}, TextAlign::TOP_LEFT, "Graph (no entity)");`);Y&&e.push("        }")},et=i=>{const{lines:t,widgets:e}=i,s=e.filter(o=>o.type==="graph");s.length>0&&(t.push("graph:"),s.forEach(o=>{const a=o.props||{},p=`graph_${o.id}`.replace(/-/g,"_"),c=a.duration||"1h",E=parseInt(o.width,10),F=parseInt(o.height,10),h=a.max_range?parseFloat(a.max_range):null,A=a.min_range?parseFloat(a.min_range):null,d=a.grid!==!1;let _=a.x_grid||"",S=a.y_grid||"";if(d){if(!_){const I=c.match(/^(\d+(?:\.\d+)?)(min|h|d)$/);if(I){const k=parseFloat(I[1]),x=I[2];let n=k/4;x==="h"?_=n>=1?`${Math.round(n)}h`:`${Math.round(n*60)}min`:x==="min"?_=`${Math.round(n)}min`:x==="d"&&(_=`${Math.round(n*24)}h`)}else _="1h"}if(!S){const I=parseFloat(a.min_value)||0,n=((parseFloat(a.max_value)||100)-I)/4,r=Math.pow(10,Math.floor(Math.log10(n))),T=n/r;let N=T<=1?r:T<=2?2*r:T<=5?5*r:10*r;S=String(N)}}let f=(o.entity_id||"").trim();f&&!f.includes(".")&&!a.is_local_sensor&&(f=`sensor.${f}`);const $=f.replace(/[^a-zA-Z0-9_]/g,"_")||"none",g=(a.line_type||"SOLID").toUpperCase(),m=parseInt(a.line_thickness||3,10),y=a.border!==!1,C=!!a.continuous;t.push(`  - id: ${p}`),t.push(`    duration: ${c}`),t.push(`    width: ${E}`),t.push(`    height: ${F}`),t.push(`    border: ${y}`),d&&_&&t.push(`    x_grid: ${_}`),d&&S&&t.push(`    y_grid: ${S}`),t.push("    traces:"),t.push(`      - sensor: ${$}`),t.push(`        line_thickness: ${m}`),g!=="SOLID"&&t.push(`        line_type: ${g}`),C&&t.push("        continuous: true"),a.min_value!==void 0&&a.min_value!==null&&String(a.min_value).trim()!==""&&t.push(`    min_value: ${a.min_value}`),a.max_value!==void 0&&a.max_value!==null&&String(a.max_value).trim()!==""&&t.push(`    max_value: ${a.max_value}`),h!==null&&t.push(`    max_range: ${h}`),A!==null&&t.push(`    min_range: ${A}`)}),t.push(""))},st=i=>{const{lines:t,widgets:e}=i;e.filter(s=>s.type==="graph"&&s.props?.use_ha_history).forEach(s=>{const o=`hist_${s.id}`.replace(/-/g,"_"),a=s.props.history_points||100;t.push(`- id: ${o}`),t.push(`  type: float[${a}]`),s.props.auto_scale!==!1&&(t.push(`- id: ${o}_min`),t.push("  type: float"),t.push("  initial_value: '0'"),t.push(`- id: ${o}_max`),t.push("  type: float"),t.push("  initial_value: '100'"))})},nt=i=>{const{lines:t,widgets:e}=i;e.some(o=>o.type==="graph"&&o.props?.use_ha_history)&&(t.includes("<sstream>")||t.push("<sstream>"),t.includes("<algorithm>")||t.push("<algorithm>"))},at=i=>{const{lines:t,widgets:e}=i;e.filter(s=>s.type==="graph"&&s.props?.use_ha_history).forEach(s=>{const o=s.props||{},a=(s.entity_id||"").trim();if(!a)return;const p=`hist_${s.id}`.replace(/-/g,"_"),c=o.history_points||100,E=o.history_attribute||"history";t.push("- platform: homeassistant"),t.push(`  entity_id: ${a}`),t.push(`  id: ${p}_fetcher`),t.push(`  attribute: ${E}`),t.push("  internal: true"),t.push("  on_value:"),t.push("    then:"),t.push("      - lambda: |-"),t.push("          std::string input = x;"),t.push("          if (input.empty()) return;"),t.push("          if (input.front() == '[') input.erase(0, 1);"),t.push("          if (input.back() == ']') input.pop_back();"),t.push("          std::replace(input.begin(), input.end(), ',', ' ');"),t.push("          std::stringstream ss(input);"),t.push("          float val;"),t.push("          int idx = 0;"),o.auto_scale!==!1&&t.push("          float min_v = 1e30, max_v = -1e30;"),t.push(`          while (ss >> val && idx < ${c}) {`),t.push(`            id(${p})[idx++] = val;`),o.auto_scale!==!1&&(t.push("            if (val < min_v) min_v = val;"),t.push("            if (val > max_v) max_v = val;")),t.push("          }"),o.auto_scale!==!1&&(t.push(`          id(${p}_min) = min_v;`),t.push(`          id(${p}_max) = max_v;`)),o.history_smoothing&&(t.push("          // Simple moving average smoothing (window=3)"),t.push("          for (int i = 1; i < idx - 1; i++) {"),t.push(`             id(${p})[i] = (id(${p})[i-1] + id(${p})[i] + id(${p})[i+1]) / 3.0;`),t.push("          }"))})},ot=i=>{const{widgets:t,isLvgl:e,pendingTriggers:s}=i;if(t)for(const o of t){if(o.type!=="graph")continue;let a=(o.entity_id||"").trim();const p=o.props||{};!a||p.is_local_sensor||(a.includes(".")||(a=`sensor.${a}`),e&&s&&(s.has(a)||s.set(a,new Set),s.get(a).add(`- lvgl.widget.refresh: ${o.id}`)))}},lt={id:"graph",name:"Graph / Chart",category:"Advanced",supportedModes:["lvgl","direct"],defaults:{width:205,height:100,duration:"1h",border:!0,grid:!0,color:"theme_auto",background_color:"transparent",title:"",x_grid:"",y_grid:"",line_thickness:3,line_type:"SOLID",continuous:!0,min_value:"",max_value:"",min_range:"",max_range:"",use_ha_history:!1,history_points:100,history_attribute:"history",history_smoothing:!1,auto_scale:!0},render:w,exportLVGL:tt,export:it,onExportComponents:et,onExportNumericSensors:ot,onExportGlobals:st,onExportEsphome:nt,onExportTextSensors:at};export{lt as default};
