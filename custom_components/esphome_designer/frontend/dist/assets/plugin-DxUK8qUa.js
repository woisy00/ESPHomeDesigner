const H=(s,e,t,{getColorStyle:a})=>{const d=e.width||400,u=e.height||300,f=t.text_color||"theme_auto",p=a(f);if(s.style.width=d+"px",s.style.height=u+"px",s.style.backgroundColor=t.background_color||"transparent",s.style.color=p,s.style.padding="4px",s.style.boxSizing="border-box",t.show_border!==!1){const n=t.border_color||f;s.style.border=`${t.border_width||2}px solid ${a(n)}`}const o=new Date,r=o.getDate(),h=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],m=["January","February","March","April","May","June","July","August","September","October","November","December"],c=h[o.getDay()],T=`${m[o.getMonth()]} ${o.getFullYear()}`,l=document.createElement("div");l.style.textAlign="center",l.style.padding="2px",l.style.borderBottom="1px solid "+p,l.style.flexShrink="0";const S=document.createElement("div");S.style.fontSize=Math.min((t.font_size_date||100)*.7,80)+"px",S.style.fontWeight="100",S.style.lineHeight="0.8",S.innerText=r,l.appendChild(S);const w=document.createElement("div");w.style.fontSize=(t.font_size_day||24)+"px",w.style.fontWeight="bold",w.style.marginTop="4px",w.innerText=c,l.appendChild(w);const z=document.createElement("div");z.style.fontSize=(t.font_size_grid||14)+"px",z.innerText=T,l.appendChild(z),s.style.display="flex",s.style.flexDirection="column",s.appendChild(l);const y=document.createElement("div");y.style.display="grid",y.style.gridTemplateColumns="repeat(7, 1fr)",y.style.padding="2px",y.style.gap="1px",y.style.flexShrink="0";const $=(t.font_size_grid||14)+"px";["Mo","Tu","We","Th","Fr","Sa","Su"].forEach(n=>{const i=document.createElement("div");i.innerText=n,i.style.textAlign="center",i.style.fontWeight="bold",i.style.fontSize=$,y.appendChild(i)});const I=new Date(o.getFullYear(),o.getMonth(),1),D=new Date(o.getFullYear(),o.getMonth()+1,0).getDate();let g=I.getDay();g===0&&(g=7),g-=1;for(let n=0;n<g;n++)y.appendChild(document.createElement("div"));for(let n=1;n<=D;n++){const i=document.createElement("div");i.innerText=n,i.style.textAlign="center",i.style.fontSize=$,n===r&&(i.style.backgroundColor=t.text_color||"theme_auto",i.style.color=t.background_color||"white",i.style.borderRadius="50%",i.style.width="1.5em",i.style.height="1.5em",i.style.lineHeight="1.5em",i.style.margin="0 auto"),y.appendChild(i)}s.appendChild(y);const _=document.createElement("div");_.style.padding="5px",_.style.fontSize=(t.font_size_event||18)+"px",_.style.flexGrow="1",_.style.overflow="hidden";let b=null;const v=(e.entity_id||t.entity_id||"sensor.esp_calendar_data").trim();if(console.log("[Calendar Preview] Looking for entity:",v),window.AppState&&window.AppState.entityStates){const n=window.AppState.entityStates[v];if(console.log("[Calendar Preview] Found stateObj:",n?"yes":"no",n?JSON.stringify(n).substring(0,300):""),n)try{if(n.attributes&&n.attributes.entries)if(typeof n.attributes.entries=="string"){const i=JSON.parse(n.attributes.entries);b=i.days||i}else b=n.attributes.entries.days||n.attributes.entries;else if(n.state&&n.state.length>5&&n.state!=="OK"&&n.state!=="unknown"){const i=JSON.parse(n.state);b=i.days||i}}catch(i){console.warn("[Calendar Widget] Failed to parse live state/attributes:",i)}}if(b&&Array.isArray(b)&&b.length>0){_.innerHTML="";const n=t.event_limit||4;let i=0;for(const x of b){if(i>=n)break;const J=x.day,M=(E,N)=>{if(i>=n)return;const F=E.summary||"No Title",O=E.start||"";let P=N?"All Day":"";!N&&O.includes("T")&&(P=O.split("T")[1].substring(0,5));const A=document.createElement("div");A.style.marginBottom="4px",A.style.display="flex",A.style.justifyContent="space-between",A.innerHTML=`<span style="flex-shrink:0;width:25px;"><b>${J}</b></span><span style="flex-grow:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-right:8px;">${F}</span><span style="flex-shrink:0;opacity:0.7;font-size:0.9em;">${P}</span>`,_.appendChild(A),i++};x.all_day&&x.all_day.forEach(E=>M(E,!0)),x.other&&x.other.forEach(E=>M(E,!1))}}else _.innerHTML=`
            <div style="margin-bottom:4px;"><b>${r}</b> Meeting with Team</div>
            <div><b>${Math.min(r+2,D)}</b> Dentist Appointment</div>
        `;s.appendChild(_)},W={id:"calendar",name:"Calendar",category:"Events",supportedModes:["lvgl","direct"],defaults:{entity_id:"sensor.esp_calendar_data",border_width:2,show_border:!0,border_color:"theme_auto",background_color:"transparent",text_color:"theme_auto",font_size_date:100,font_size_day:24,font_size_grid:14,font_size_event:18,width:335,height:340},render:(s,e,t)=>{const a=e.props||{};s.innerHTML="",H(s,e,a,t)},onExportTextSensors:s=>{const{lines:e,widgets:t}=s;if(!t)return;const a=t.filter(o=>o.type==="calendar");if(a.length===0)return;for(const o of a){const r=o.props||{},h=(o.entity_id||r.entity_id||"sensor.esp_calendar_data").trim(),m=h.startsWith("sensor."),c=`calendar_data_${h.replace(/[^a-zA-Z0-9_]/g,"_")}`;s.seenEntityIds&&s.seenEntityIds.has(h)||s.seenSensorIds&&s.seenSensorIds.has(c)||(s.seenEntityIds&&s.seenEntityIds.add(h),s.seenSensorIds&&s.seenSensorIds.add(c),e.push("- platform: homeassistant"),e.push(`  id: ${c}`),e.push(`  entity_id: ${h}`),m&&e.push("  attribute: entries"),e.push("  internal: true"))}const d=a[0],p=(d.props&&d.props.source_calendars?d.props.source_calendars:"calendar.example_1, calendar.example_2").split(",").map(o=>o.trim()).filter(o=>o).map(o=>`#           - ${o}`).join(`
`);e.push(""),e.push("# ============================================================================"),e.push("# CALENDAR EVENTS SETUP (HOME ASSISTANT)"),e.push("# 1. Download the 'Helper Script' from the Calendar widget's properties panel."),e.push("# 2. Place it in your /config/python_scripts/ folder."),e.push("# 3. Enable the python_script integration by adding this line to configuration.yaml:"),e.push("#"),e.push("#    python_script:"),e.push("#"),e.push("# 4. Add this template sensor configuration (configuration.yaml or packages):"),e.push("#"),e.push("# template:"),e.push("#   - trigger:"),e.push("#       - trigger: time_pattern"),e.push("#         minutes: '/15'"),e.push("#     action:"),e.push("#       - action: calendar.get_events"),e.push("#         target:"),e.push("#           entity_id:"),e.push(`${p}`),e.push("#         data:"),e.push("#           duration:"),e.push("#             days: 14"),e.push("#         response_variable: calendar_events"),e.push("#       - action: python_script.esp_calendar_data_conversion"),e.push("#         data:"),e.push('#           calendar: "{{ calendar_events }}"'),e.push(`#           now: "{{ now().isoformat().split('T')[0] }}"`),e.push("#         response_variable: output"),e.push("#     sensor:"),e.push("#       - name: ESP Calendar Data"),e.push("#         unique_id: esp_calendar_data"),e.push('#         state: "OK"'),e.push("#         attributes:"),e.push('#           entries: "{{ output.entries }}"'),e.push('#           closest_end_time: "{{ output.closest_end_time }}"'),e.push("#"),e.push("# 5. Restart HA (required for python_script), then Reload Template Entities."),e.push("# ============================================================================")},exportLVGL:(s,{common:e,convertColor:t,getLVGLFont:a})=>{const d=s.props||{},u=t(d.text_color||"theme_auto"),f=t(d.background_color||"white"),p=Math.round(Math.min((d.font_size_date||100)*.7,80)),o=parseInt(d.font_size_day||24,10),r=parseInt(d.font_size_grid||14,10),h=d.font_family||"Roboto",m=p+o+r+15,c=[{label:{align:"TOP_MID",y:2,height:p+4,text:`!lambda "char buf[4]; id(ha_time).now().strftime(buf, sizeof(buf), '%d'); return buf;"`,text_font:a(h,p,100),text_color:u}},{label:{align:"TOP_MID",y:p+6,height:o+4,text:`!lambda "char buf[16]; id(ha_time).now().strftime(buf, sizeof(buf), '%A'); return buf;"`,text_font:a(h,o,700),text_color:u}},{label:{align:"TOP_MID",y:p+o+10,height:r+4,text:`!lambda "char buf[32]; id(ha_time).now().strftime(buf, sizeof(buf), '%B %Y'); return buf;"`,text_font:a(h,r,400),text_color:u}},{obj:{width:"100%",height:1,y:m,bg_color:u,border_width:0}}];return c.push({obj:{width:"100%",height:"SIZE_CONTENT",y:m+5,bg_opa:"transp",border_width:0,layout:{type:"flex",flex_flow:"row_wrap",flex_align_main:"space_around"},widgets:["Mo","Tu","We","Th","Fr","Sa","Su"].map(T=>({label:{text:`"${T}"`,text_font:a(h,r,700),text_color:u,width:"14%",align:"center"}}))}}),c.push({label:{y:m+40,align:"TOP_MID",text:'"Calendar Grid Not Supported in LVGL Mode"',text_font:a("Roboto",12,400),text_color:"0x888888"}}),{obj:{...e,bg_color:f,bg_opa:"COVER",radius:8,border_width:d.show_border!==!1?d.border_width||2:0,border_color:t(d.border_color||"theme_auto"),widgets:c}}},export:(s,e)=>{const{lines:t,addFont:a,getColorConst:d,addDitherMask:u,getCondProps:f,getConditionCheck:p,isEpaper:o}=e,r=s.props||{},h=(s.entity_id||r.entity_id||"sensor.esp_calendar_data").trim(),m=r.border_color||"theme_auto",c=r.text_color||"theme_auto",T=r.background_color||"transparent",l=d(c),S=d(m),w=d(T),z=r.show_border!==!1,y=parseInt(r.border_width||2,10),$=Math.round(Math.min(parseInt(r.font_size_date||100,10)*.7,80)),I=parseInt(r.font_size_day||24,10),C=parseInt(r.font_size_grid||14,10),D=parseInt(r.font_size_event||18,10),g=r.font_family||"Roboto",_=a(g,100,$),b=a(g,700,I),v=a(g,400,C),n=a(g,400,D);t.push(`        // widget:calendar id:${s.id} type:calendar x:${s.x} y:${s.y} w:${s.width} h:${s.height} entity:${h} ${f(s)}`);const i=p(s);i&&t.push(`        ${i}`),t.push("        {"),t.push("          auto now = id(ha_time).now();"),t.push(`          int x = ${s.x}; int y = ${s.y}; int w = ${s.width}; int h = ${s.height};`),T!=="transparent"&&t.push(`          it.filled_rectangle(x, y, w, h, ${w});`),t.push("          // Header"),t.push(`          int headH = ${$+I+C+15};`),t.push(`          it.strftime(x + w/2, y + 2, id(${_}), ${l}, TextAlign::TOP_CENTER, "%d", now);`),t.push(`          it.strftime(x + w/2, y + ${$+6}, id(${b}), ${l}, TextAlign::TOP_CENTER, "%A", now);`),t.push(`          it.strftime(x + w/2, y + ${$+I+10}, id(${v}), ${l}, TextAlign::TOP_CENTER, "%B %Y", now);`),t.push(`          it.line(x, y + headH, x + w, y + headH, ${l});`),t.push("          // Days Grid"),t.push("          int gridY = y + headH + 5;"),t.push("          int cellW = w / 7;"),t.push('          const char* days[] = {"Mo", "Tu", "We", "Th", "Fr", "Sa", "Su"};'),t.push("          for(int i=0; i<7; i++) {"),t.push(`            it.print(x + i*cellW + cellW/2, gridY, id(${v}), ${l}, TextAlign::TOP_CENTER, days[i]);`),t.push("          }"),t.push("          // Simple logic to find start of month"),t.push("          time_t t = now.timestamp;"),t.push("          struct tm *tm = localtime(&t);"),t.push("          tm->tm_mday = 1;"),t.push("          mktime(tm);"),t.push("          int startDay = (tm->tm_wday + 6) % 7; // 0=Mon"),t.push("          int daysInMonth = 31; // Simplified"),t.push("          if(now.month == 2) daysInMonth = (now.year % 4 == 0) ? 29 : 28;"),t.push("          else if(now.month == 4 || now.month == 6 || now.month == 9 || now.month == 11) daysInMonth = 30;"),t.push("          int r = 1; int c = startDay;"),t.push(`          int rowH = ${C+4};`),t.push("          for(int d=1; d<=daysInMonth; d++) {"),t.push("            if(d == now.day_of_month) {"),t.push(`               it.filled_circle(x + c*cellW + cellW/2, gridY + r*rowH + 6, ${Math.floor(C/1.5)}, ${l});`),t.push(`               it.printf(x + c*cellW + cellW/2, gridY + r*rowH, id(${v}), ${w}, TextAlign::TOP_CENTER, "%d", d);`),t.push("            } else {"),t.push(`               it.printf(x + c*cellW + cellW/2, gridY + r*rowH, id(${v}), ${l}, TextAlign::TOP_CENTER, "%d", d);`),t.push("            }"),t.push("            c++; if(c>6) { c=0; r++; }"),t.push("          }"),t.push("          // Events (Real Data from Sensor)"),t.push("          auto extract_time = [](const char* datetime) -> std::string {"),t.push("              std::string datetimeStr(datetime);"),t.push("              size_t pos = datetimeStr.find('T');"),t.push("              if (pos != std::string::npos && pos + 3 < datetimeStr.size()) {"),t.push("                  return datetimeStr.substr(pos + 1, 5);"),t.push("              }"),t.push('              return "";'),t.push("          };"),t.push(""),t.push("          int eventY = gridY + (r+1)*rowH + 10;"),t.push("          int max_y = y + h - 5;"),t.push(`          const int event_limit = ${r.event_limit||4};`),t.push(""),t.push("          // Debug and parse JSON");const x=`calendar_data_${h.replace(/[^a-zA-Z0-9_]/g,"_")}`;t.push(`          if (id(${x}).state.length() > 5 && id(${x}).state != "unknown") {`),t.push("             JsonDocument doc;"),t.push(`             DeserializationError error = deserializeJson(doc, id(${x}).state);`),t.push(""),t.push("             if (!error) {"),t.push("                 JsonVariant root = doc.as<JsonVariant>();"),t.push("                 JsonArray days;"),t.push(""),t.push('                 if (root.is<JsonObject>() && root["days"].is<JsonArray>()) {'),t.push('                     days = root["days"];'),t.push("                 } else if (root.is<JsonArray>()) {"),t.push("                     days = root;"),t.push("                 }"),t.push(""),t.push("                 if (!days.isNull() && days.size() > 0) {"),t.push("                     int event_count = 0;"),t.push("                     // Separator line"),t.push(`                     it.filled_rectangle(x + 10, eventY - 5, w - 20, 2, ${l});`),t.push(""),t.push("                     for (JsonVariant dayEntry : days) {"),t.push("                         if (eventY > max_y || event_count >= event_limit) break;"),t.push('                         int currentDayNum = dayEntry["day"].as<int>();'),t.push(""),t.push("                         auto draw_row = [&](JsonVariant event, bool is_all_day) {"),t.push("                             if (eventY > max_y || event_count >= event_limit) return;"),t.push('                             const char* summary = event["summary"] | "No Title";'),t.push('                             const char* start = event["start"] | "";'),t.push(""),t.push("                             // Draw Day Number"),t.push(`                             it.printf(x + 10, eventY, id(${n}), ${l}, TextAlign::TOP_LEFT, "%d", currentDayNum);`),t.push(""),t.push("                             // Draw Summary"),t.push(`                             it.printf(x + 50, eventY, id(${n}), ${l}, TextAlign::TOP_LEFT, "%.25s", summary);`),t.push(""),t.push("                             // Draw Time"),t.push("                             if (is_all_day) {"),t.push(`                                 it.printf(x + w - 10, eventY, id(${n}), ${l}, TextAlign::TOP_RIGHT, "All Day");`),t.push("                             } else {"),t.push("                                 std::string timeStr = extract_time(start);"),t.push(`                                 it.printf(x + w - 10, eventY, id(${n}), ${l}, TextAlign::TOP_RIGHT, "%s", timeStr.c_str());`),t.push("                             }"),t.push(`                             eventY += ${D+6};`),t.push("                             event_count++;"),t.push("                         };"),t.push(""),t.push('                         if (dayEntry["all_day"].is<JsonArray>()) {'),t.push('                             for (JsonVariant event : dayEntry["all_day"].as<JsonArray>()) {'),t.push("                                 draw_row(event, true);"),t.push("                             }"),t.push("                         }"),t.push('                         if (dayEntry["other"].is<JsonArray>()) {'),t.push('                             for (JsonVariant event : dayEntry["other"].as<JsonArray>()) {'),t.push("                                 draw_row(event, false);"),t.push("                             }"),t.push("                         }"),t.push("                     }"),t.push("                 }"),t.push("             } else {"),t.push('                 ESP_LOGW("calendar", "JSON Parse Error: %s", error.c_str());'),t.push("             }"),t.push("          }"),z&&(t.push(`          for (int i = 0; i < ${y}; i++) {`),t.push(`            it.rectangle(x + i, y + i, w - 2*i, h - 2*i, ${S});`),t.push("          }")),u(t,c,o,s.x,s.y,s.width,s.height),t.push("        }"),i&&t.push("        }")},collectRequirements:(s,{addFont:e})=>{const t=s.props||{},a=Math.round(Math.min(parseInt(t.font_size_date||100,10)*.7,80)),d=parseInt(t.font_size_day||24,10),u=parseInt(t.font_size_grid||14,10),f=parseInt(t.font_size_event||18,10),p=t.font_family||"Roboto";e(p,100,a),e(p,700,d),e(p,400,u),e(p,400,f),e("Material Design Icons",400,24)}};export{W as default};
