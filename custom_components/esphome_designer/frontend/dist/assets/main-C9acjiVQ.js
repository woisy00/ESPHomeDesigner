(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))n(t);new MutationObserver(t=>{for(const o of t)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function i(t){const o={};return t.integrity&&(o.integrity=t.integrity),t.referrerPolicy&&(o.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?o.credentials="include":t.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(t){if(t.ep)return;t.ep=!0;const o=i(t);fetch(t.href,o)}})();function Ee(){return"w_"+Date.now().toString(36)+Math.random().toString(36).substr(2,5)}typeof crypto<"u"&&!crypto.randomUUID?crypto.randomUUID=function(){return("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,d=>(d^crypto.getRandomValues(new Uint8Array(1))[0]&15>>d/4).toString(16))}:typeof crypto>"u"&&(window.crypto={randomUUID:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,d=>{const e=Math.random()*16|0;return(d==="x"?e:e&3|8).toString(16)}),getRandomValues:d=>d.map(()=>Math.floor(Math.random()*256))});function ui(d,e){let i;return function(...t){const o=()=>{clearTimeout(i),d(...t)};clearTimeout(i),i=setTimeout(o,e)}}function at(d){return JSON.parse(JSON.stringify(d))}window.generateId=Ee;window.debounce=ui;window.deepClone=at;const gi=localStorage.getItem("esphome-designer-debug")==="true",_={log:(...d)=>gi&&console.log("[ESPHomeDesigner]",...d),warn:(...d)=>console.warn("[ESPHomeDesigner]",...d),error:(...d)=>console.error("[ESPHomeDesigner]",...d)};function bt(){let d=vt();if(d)return d=d.trim(),d.endsWith("/")&&(d=d.slice(0,-1)),d&&!d.includes("/api/")&&(d+="/api/esphome_designer"),d;try{const e=window.location;return e.protocol==="file:"?null:e.hostname==="homeassistant"||e.hostname==="hassio"||e.pathname.includes("/api/")||e.pathname.includes("/local/")||e.pathname.includes("/hacsfiles/")||e.pathname.includes("/esphome-designer")?`${e.origin}/api/esphome_designer`:null}catch{return null}}function vt(){try{return localStorage.getItem("ha_manual_url")}catch{return null}}function Ut(d){try{if(d){let e=d.trim();e.endsWith("/")&&(e=e.slice(0,-1)),e.includes("/api/")||(e+="/api/esphome_designer"),localStorage.setItem("ha_manual_url",e)}else localStorage.removeItem("ha_manual_url")}catch(e){_.error("Failed to save HA URL:",e)}}function Ke(){try{return localStorage.getItem("ha_llat_token")}catch{return null}}function Vt(d){try{d?localStorage.setItem("ha_llat_token",d):localStorage.removeItem("ha_llat_token")}catch(e){_.error("Failed to save HA Token:",e)}}let J=bt();function lt(){J=bt()}function q(){return!!J}window.detectHaBackendBaseUrl=bt;window.getHaManualUrl=vt;window.setHaManualUrl=Ut;window.getHaToken=Ke;window.setHaToken=Vt;window.HA_API_BASE=J;window.refreshHaBaseUrl=lt;window.hasHaBackend=q;function mi(d){const e=document.getElementById("importSnippetError");e&&(e.textContent=d||"")}function U(d,e="info",i=3e3){let n=document.getElementById("toast-container");n||(n=document.createElement("div"),n.id="toast-container",n.style.position="fixed",n.style.bottom="20px",n.style.right="20px",n.style.zIndex="9999",document.body.appendChild(n));const t=document.createElement("div");t.className="toast",e==="error"?t.style.background="rgba(255, 0, 0, 0.8)":e==="success"?t.style.background="rgba(0, 128, 0, 0.8)":t.style.background="rgba(0,0,0,0.8)",t.textContent=d,t.style.color="white",t.style.padding="10px 20px",t.style.borderRadius="4px",t.style.marginTop="10px",t.style.opacity="0",t.style.transition="opacity 0.3s",n.appendChild(t),requestAnimationFrame(()=>{t.style.opacity="1"}),setTimeout(()=>{t.style.opacity="0",setTimeout(()=>{t.remove()},300)},i)}const fi=Object.freeze(Object.defineProperty({__proto__:null,setImportError:mi,showToast:U},Symbol.toStringTag,{value:"Module"})),yi="modulepreload",_i=function(d,e){return new URL(d,e).href},Mt={},N=function(e,i,n){let t=Promise.resolve();if(i&&i.length>0){const s=document.getElementsByTagName("link"),r=document.querySelector("meta[property=csp-nonce]"),l=r?.nonce||r?.getAttribute("nonce");t=Promise.allSettled(i.map(c=>{if(c=_i(c,n),c in Mt)return;Mt[c]=!0;const a=c.endsWith(".css"),u=a?'[rel="stylesheet"]':"";if(!!n)for(let f=s.length-1;f>=0;f--){const y=s[f];if(y.href===c&&(!a||y.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${c}"]${u}`))return;const m=document.createElement("link");if(m.rel=a?"stylesheet":yi,a||(m.as="script"),m.crossOrigin="",m.href=c,l&&m.setAttribute("nonce",l),document.head.appendChild(m),a)return new Promise((f,y)=>{m.addEventListener("load",f),m.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${c}`)))})}))}function o(s){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=s,window.dispatchEvent(r),!r.defaultPrevented)throw s}return t.then(s=>{for(const r of s||[])r.status==="rejected"&&o(r.reason);return e().catch(o)})},Le=new EventTarget,B={STATE_CHANGED:"state-changed",SELECTION_CHANGED:"selection-changed",PAGE_CHANGED:"page-changed",HISTORY_CHANGED:"history-changed",SETTINGS_CHANGED:"settings-changed",LAYOUT_IMPORTED:"layout-imported",ENTITIES_LOADED:"entities-loaded",ZOOM_CHANGED:"zoom-changed"};function W(d,e={}){Le.dispatchEvent(new CustomEvent(d,{detail:e}))}function Q(d,e){Le.addEventListener(d,i=>e(i.detail))}function Yt(d,e){Le.removeEventListener(d,e)}window.EventBus=Le;window.EVENTS=B;window.emit=W;window.on=Q;window.off=Yt;const bi=Object.freeze(Object.defineProperty({__proto__:null,EVENTS:B,EventBus:Le,emit:W,off:Yt,on:Q},Symbol.toStringTag,{value:"Module"})),Je={WHITE:"#FFFFFF",BLACK:"#000000",GRAY:"#808080",GREY:"#808080",RED:"#FF0000",GREEN:"#00FF00",BLUE:"#0000FF",YELLOW:"#FFFF00",ORANGE:"#FFA500"},qt={GRID_SIZE:10,SNAP_THRESHOLD:10,SIDEBAR_WIDTH:300,PROPERTIES_WIDTH:350},Ze={TOP_LEFT:"TOP_LEFT",TOP_CENTER:"TOP_CENTER",TOP_RIGHT:"TOP_RIGHT",CENTER_LEFT:"CENTER_LEFT",CENTER:"CENTER",CENTER_RIGHT:"CENTER_RIGHT",BOTTOM_LEFT:"BOTTOM_LEFT",BOTTOM_CENTER:"BOTTOM_CENTER",BOTTOM_RIGHT:"BOTTOM_RIGHT"},wt={LANDSCAPE:"landscape",PORTRAIT:"portrait"},xt={snapEnabled:!0,showGrid:!0,showRulers:!1,gridOpacity:8,editor_light_mode:!1,aiProvider:"gemini",aiModelGemini:"gemini-1.5-flash",aiModelOpenAI:"gpt-4o",aiModelOpenRouter:"",aiModelFilter:"",extendedLatinGlyphs:!1,autoCycleEnabled:!1,autoCycleIntervalS:30,refreshInterval:600,manualRefreshOnly:!1,darkMode:!1,invertedColors:!1,lcdEcoStrategy:"backlight_off",sleepEnabled:!1,sleepStartHour:0,sleepEndHour:5,deepSleepEnabled:!1,deepSleepInterval:600,dailyRefreshEnabled:!1,dailyRefreshTime:"08:00",noRefreshStartHour:null,noRefreshEndHour:null,renderingMode:null},Xt={X:40,Y:40,WIDTH:200,HEIGHT:60},Et=50,Kt={RSS:300,ENTITIES:60},Jt=5e3,St={white:"COLOR_WHITE",black:"COLOR_BLACK",gray:"Color(160, 160, 160)",grey:"Color(160, 160, 160)",red:"COLOR_RED",green:"COLOR_GREEN",blue:"COLOR_BLUE",yellow:"COLOR_YELLOW",orange:"COLOR_ORANGE"},It=800,Ct=480,ye=10,Zt=10;window.ESPHomeDesigner=window.ESPHomeDesigner||{version:"0.9.0",constants:{COLORS:Je,UI_DEFAULTS:qt,ALIGNMENT:Ze,ORIENTATIONS:wt,DEFAULT_PREFERENCES:xt,WIDGET_DEFAULTS:Xt,HISTORY_LIMIT:Et,CACHE_TTL:Kt,ENTITY_LIMIT:Jt,ESPHOME_COLOR_MAPPING:St,DEFAULT_CANVAS_WIDTH:It,DEFAULT_CANVAS_HEIGHT:Ct,SNAP_DISTANCE:ye,GRID_SIZE:Zt}};window.COLORS=Je;window.UI_DEFAULTS=qt;window.ALIGNMENT=Ze;window.ORIENTATIONS=wt;window.DEFAULT_PREFERENCES=xt;window.WIDGET_DEFAULTS=Xt;window.HISTORY_LIMIT=Et;window.CACHE_TTL=Kt;window.ENTITY_LIMIT=Jt;window.ESPHOME_COLOR_MAPPING=St;window.DEFAULT_CANVAS_WIDTH=It;window.DEFAULT_CANVAS_HEIGHT=Ct;window.SNAP_DISTANCE=ye;window.GRID_SIZE=Zt;class vi{constructor(){this.state={pages:[],currentPageIndex:0,deviceName:"Layout 1",deviceModel:"reterminal_e1001",currentLayoutId:"reterminal_e1001",customHardware:{},widgetsById:new Map},this.reset()}reset(){this.state.pages=[{id:"page_0",name:"Overview",layout:null,widgets:[]}],this.state.currentPageIndex=0,this.rebuildWidgetsIndex()}get pages(){return this.state.pages}get currentPageIndex(){return this.state.currentPageIndex}get deviceName(){return this.state.deviceName}get deviceModel(){return this.state.deviceModel}get currentLayoutId(){return this.state.currentLayoutId}getCurrentPage(){return this.state.pages[this.state.currentPageIndex]||this.state.pages[0]}getWidgetById(e){return this.state.widgetsById.get(e)}rebuildWidgetsIndex(){this.state.widgetsById.clear();for(const e of this.state.pages)for(const i of e.widgets)this.state.widgetsById.set(i.id,i)}setPages(e){this.state.pages=e,this.rebuildWidgetsIndex(),W(B.STATE_CHANGED)}setCurrentPageIndex(e,i={}){e>=0&&e<this.state.pages.length&&(this.state.currentPageIndex=e,W(B.PAGE_CHANGED,{index:e,...i}))}reorderPage(e,i){if(e<0||e>=this.state.pages.length||i<0||i>=this.state.pages.length)return;const[n]=this.state.pages.splice(e,1);this.state.pages.splice(i,0,n),this.state.currentPageIndex===e?this.state.currentPageIndex=i:e<this.state.currentPageIndex&&i>=this.state.currentPageIndex?this.state.currentPageIndex--:e>this.state.currentPageIndex&&i<=this.state.currentPageIndex&&this.state.currentPageIndex++,W(B.STATE_CHANGED),W(B.PAGE_CHANGED,{index:this.state.currentPageIndex})}addPage(e=null){const i=this.state.pages.length,n={id:`page_${Date.now()}_${i}`,name:`Page ${i+1}`,widgets:[]},t=e!==null?e:this.state.pages.length;return this.state.pages.splice(t,0,n),e!==null&&e<=this.state.currentPageIndex?this.state.currentPageIndex++:e===null&&(this.state.currentPageIndex=this.state.pages.length-1),this.rebuildWidgetsIndex(),W(B.STATE_CHANGED),W(B.PAGE_CHANGED,{index:this.state.currentPageIndex}),n}deletePage(e){e<0||e>=this.state.pages.length||(this.state.pages.splice(e,1),this.state.currentPageIndex>=this.state.pages.length&&(this.state.currentPageIndex=Math.max(0,this.state.pages.length-1)),this.rebuildWidgetsIndex(),W(B.STATE_CHANGED),W(B.PAGE_CHANGED,{index:this.state.currentPageIndex}))}addWidget(e,i=null){const n=i!==null?i:this.state.currentPageIndex;(this.state.pages[n]||this.getCurrentPage()).widgets.push(e),this.state.widgetsById.set(e.id,e),W(B.STATE_CHANGED)}updateWidget(e,i){const n=this.getWidgetById(e);n&&(Object.assign(n,i),W(B.STATE_CHANGED))}deleteWidgets(e){const i=this.getCurrentPage();let n=!1;for(const t of e){const o=i.widgets.findIndex(s=>s.id===t);o!==-1&&(i.widgets.splice(o,1),this.state.widgetsById.delete(t),n=!0)}n&&W(B.STATE_CHANGED)}moveWidgetToPage(e,i,n=null,t=null){if(i<0||i>=this.state.pages.length)return!1;const o=this.state.pages[i],s=new Set,r=[];let l=e,c=this.state.widgetsById.get(e);if(c&&c.parentId){let g=c;for(;g.parentId;){const m=this.state.widgetsById.get(g.parentId);if(m)g=m;else break}l=g.id}const a=g=>{if(s.has(g))return;let m=null,f=null;for(const b of this.state.pages)if(m=b.widgets.find(w=>w.id===g),m){f=b;break}if(!m||!f||f===o)return;s.add(g),r.push({widget:m,sourcePage:f}),f.widgets.filter(b=>b.parentId===g).forEach(b=>a(b.id))};if(a(l),r.length===0)return!1;r.forEach((g,m)=>{const{widget:f,sourcePage:y}=g,b=y.widgets.indexOf(f);if(b!==-1&&y.widgets.splice(b,1),m===0&&f.parentId&&!s.has(f.parentId)&&(f.parentId=null),m===0){let w=0,S=0;if(n!==null&&t!==null&&(w=n-f.x,S=t-f.y,f.x=n,f.y=t),w!==0||S!==0)for(let T=1;T<r.length;T++){const R=r[T].widget;R.x+=w,R.y+=S}}o.widgets.push(f)});const u=this.getCanvasDimensions();for(const g of s){const m=this.state.widgetsById.get(g);if(!m||m.parentId&&s.has(m.parentId))continue;const f=m.x,y=m.y;m.x=Math.max(0,Math.min(u.width-(m.width||50),m.x)),m.y=Math.max(0,Math.min(u.height-(m.height||50),m.y));const b=m.x-f,w=m.y-y;if(b!==0||w!==0)for(const S of s){const T=this.state.widgetsById.get(S);T&&T.parentId===m.id&&(T.x+=b,T.y+=w)}}return this.rebuildWidgetsIndex(),W(B.STATE_CHANGED),!0}reorderWidget(e,i,n){const t=this.state.pages[e];if(!t)return;const o=t.widgets;if(i<0||i>=o.length||n<0||n>=o.length)return;const[s]=o.splice(i,1);o.splice(n,0,s),W(B.STATE_CHANGED)}clearCurrentPage(e=!1){const i=this.getCurrentPage();if(!i)return{deleted:0,preserved:0};const n=[],t=[];return i.widgets.forEach(o=>{e&&o.locked?t.push(o):n.push(o)}),i.widgets=t,n.forEach(o=>this.state.widgetsById.delete(o.id)),n.length>0&&W(B.STATE_CHANGED),{deleted:n.length,preserved:t.length}}setDeviceSettings(e,i){e&&(this.state.deviceName=e),i&&(this.state.deviceModel=i,window.currentDeviceModel=i),W(B.SETTINGS_CHANGED)}getCanvasDimensions(e){const i=this.state.deviceModel||"reterminal_e1001",n=G&&G[i]?G[i]:null;let t=It,o=Ct;if(n)n.resolution&&(t=n.resolution.width,o=n.resolution.height);else if(i==="custom"&&this.state.customHardware){const s=this.state.customHardware;s.resWidth&&s.resHeight&&(t=s.resWidth,o=s.resHeight)}return e===wt.PORTRAIT?{width:Math.min(t,o),height:Math.max(t,o)}:{width:Math.max(t,o),height:Math.min(t,o)}}getPagesPayload(){return{pages:this.state.pages,deviceName:this.state.deviceName,deviceModel:this.state.deviceModel,currentLayoutId:this.state.currentLayoutId,customHardware:this.state.customHardware}}getCanvasShape(){const e=G[this.state.deviceModel];return e&&e.shape?e.shape:this.state.customHardware&&this.state.customHardware.shape?this.state.customHardware.shape:"rect"}}class wi{constructor(){this.state={selectedWidgetIds:[],clipboardWidgets:[],zoomLevel:1,panX:0,panY:0},this.historyStack=[],this.historyIndex=-1}get selectedWidgetIds(){return this.state.selectedWidgetIds}get clipboardWidgets(){return this.state.clipboardWidgets}get zoomLevel(){return this.state.zoomLevel}setZoomLevel(e){this.state.zoomLevel=Math.max(.05,Math.min(5,e)),W(B.ZOOM_CHANGED,{zoomLevel:this.state.zoomLevel})}setSelectedWidgetIds(e){this.state.selectedWidgetIds=e||[],W(B.SELECTION_CHANGED,{widgetIds:this.state.selectedWidgetIds})}selectWidget(e,i=!1){if(i){const n=this.state.selectedWidgetIds.indexOf(e);n===-1?e&&this.state.selectedWidgetIds.push(e):this.state.selectedWidgetIds.splice(n,1)}else this.state.selectedWidgetIds=e?[e]:[];W(B.SELECTION_CHANGED,{widgetIds:this.state.selectedWidgetIds})}copyWidgets(e){this.state.clipboardWidgets=e.map(i=>at(i)),_.log("[EditorStore] Widgets copied to clipboard:",this.state.clipboardWidgets.length)}recordHistory(e){const i=at(e);if(this.historyIndex>=0){const n=this.historyStack[this.historyIndex];if(JSON.stringify(n)===JSON.stringify(i))return}this.historyIndex<this.historyStack.length-1&&(this.historyStack=this.historyStack.slice(0,this.historyIndex+1)),this.historyStack.push(i),this.historyIndex++,this.historyStack.length>Et&&(this.historyStack.shift(),this.historyIndex--),W(B.HISTORY_CHANGED,{canUndo:this.canUndo(),canRedo:this.canRedo()})}undo(){return this.canUndo()?(this.historyIndex--,this.historyStack[this.historyIndex]):null}redo(){return this.canRedo()?(this.historyIndex++,this.historyStack[this.historyIndex]):null}canUndo(){return this.historyIndex>0}canRedo(){return this.historyIndex<this.historyStack.length-1}}class xi{constructor(){this.state={...xt}}get snapEnabled(){return this.state.snapEnabled}get showGrid(){return this.state.showGrid}get showRulers(){return this.state.showRulers}get gridOpacity(){return this.state.gridOpacity}get editor_light_mode(){return this.state.editor_light_mode}update(e){this.state={...this.state,...e},W(B.SETTINGS_CHANGED,this.state),_.log("[PreferencesStore] Settings updated")}setSnapEnabled(e){this.state.snapEnabled=e,W(B.SETTINGS_CHANGED,{snapEnabled:e})}setShowGrid(e){this.state.showGrid=e,W(B.SETTINGS_CHANGED,{showGrid:e})}setShowRulers(e){this.state.showRulers=e,W(B.SETTINGS_CHANGED,{showRulers:e})}}class Ei{constructor(){this.keys={ai_api_key_gemini:"",ai_api_key_openai:"",ai_api_key_openrouter:""},this.loadFromLocalStorage()}get(e){return this.keys[e]}set(e,i){e in this.keys&&(this.keys[e]=i,this.saveToLocalStorage())}saveToLocalStorage(){try{const e={};Object.keys(this.keys).forEach(i=>{i.startsWith("ai_api_key_")&&(e[i]=this.keys[i])}),localStorage.setItem("esphome-designer-ai-keys",JSON.stringify(e))}catch(e){_.warn("[SecretsStore] Failed to save AI keys to localStorage:",e)}}loadFromLocalStorage(){try{const e=localStorage.getItem("esphome-designer-ai-keys");if(e){const i=JSON.parse(e);this.keys={...this.keys,...i},_.log("[SecretsStore] AI keys loaded from local storage")}}catch(e){_.warn("[SecretsStore] Failed to load AI keys from localStorage:",e)}}}class Si{constructor(){this.project=new vi,this.editor=new wi,this.preferences=new xi,this.secrets=new Ei,this._isRestoringHistory=!1,this.recordHistory()}reset(){this.project.reset(),this.editor.state.selectedWidgetIds=[],this.recordHistory()}get pages(){return this.project.pages}get currentPageIndex(){return this.project.currentPageIndex}get selectedWidgetId(){return this.editor.selectedWidgetIds[0]||null}get selectedWidgetIds(){return this.editor.selectedWidgetIds}get settings(){return{...this.preferences.state,device_name:this.project.deviceName,device_model:this.project.deviceModel,...this.secrets.keys}}get deviceName(){return this.project.deviceName}get deviceModel(){return this.project.deviceModel}get currentLayoutId(){return this.project.currentLayoutId}get snapEnabled(){return this.preferences.snapEnabled}get showGrid(){return this.preferences.showGrid}get showRulers(){return this.preferences.showRulers}get zoomLevel(){return this.editor.zoomLevel}getCurrentPage(){return this.project.getCurrentPage()}getWidgetById(e){return this.project.getWidgetById(e)}getSelectedWidget(){return this.project.getWidgetById(this.editor.selectedWidgetIds[0])}getSelectedWidgets(){return this.editor.selectedWidgetIds.map(e=>this.getWidgetById(e)).filter(e=>!!e)}getSelectedProfile(){return G[this.project.deviceModel]||null}getCanvasDimensions(){return this.project.getCanvasDimensions(this.preferences.state.orientation)}getCanvasShape(){return this.project.getCanvasShape()}getPagesPayload(){return{...this.project.getPagesPayload(),...this.settings}}getSettings(){return this.settings}setSettings(e){this.updateSettings(e)}saveToLocalStorage(){q()||localStorage.setItem("esphome-designer-layout",JSON.stringify(this.getPagesPayload()))}loadFromLocalStorage(){try{const e=localStorage.getItem("esphome-designer-layout");return e?JSON.parse(e):null}catch{return null}}setPages(e){this.project.setPages(e),this.recordHistory(),W(B.STATE_CHANGED)}reorderWidget(e,i,n){this.project.reorderWidget(e,i,n),this.syncWidgetOrderWithHierarchy(),this.recordHistory(),W(B.STATE_CHANGED)}setCurrentPageIndex(e,i={}){this.project.setCurrentPageIndex(e,i),this.editor.setSelectedWidgetIds([]),W(B.STATE_CHANGED)}reorderPage(e,i){this.project.reorderPage(e,i),this.recordHistory()}addPage(e=null){const i=this.project.addPage(e);return this.recordHistory(),i}deletePage(e){this.project.deletePage(e),this.recordHistory()}selectWidget(e,i){if(!e){this.editor.selectWidget(null,i);return}const n=this.getWidgetById(e),t=n?.parentId||(n?.type==="group"?n.id:null);if(t){const r=this.pages[this.currentPageIndex].widgets.filter(l=>l.parentId===t||l.id===t).map(l=>l.id);if(i)if(r.some(c=>this.editor.selectedWidgetIds.includes(c))){const c=this.editor.selectedWidgetIds.filter(a=>!r.includes(a));this.editor.setSelectedWidgetIds(c)}else this.editor.setSelectedWidgetIds([...new Set([...this.editor.selectedWidgetIds,...r])]);else this.editor.setSelectedWidgetIds(r)}else this.editor.selectWidget(e,i)}selectWidgets(e){this.editor.setSelectedWidgetIds(e)}selectAllWidgets(){const e=this.getCurrentPage();if(!e||!e.widgets)return;const i=e.widgets.map(n=>n.id);this.selectWidgets(i)}updateSettings(e){const i={},n={};Object.keys(e).forEach(t=>{t.startsWith("ai_api_key_")?i[t]=e[t]:n[t]=e[t]}),Object.keys(i).length&&Object.entries(i).forEach(([t,o])=>this.secrets.set(t,o)),this.preferences.update(n),e.device_name&&(this.project.state.deviceName=e.device_name),e.device_model&&(this.project.state.deviceModel=e.device_model),W(B.STATE_CHANGED)}setDeviceName(e){this.project.state.deviceName=e,this.updateLayoutIndicator()}setDeviceModel(e){this.project.state.deviceModel=e,this.updateLayoutIndicator()}setCurrentLayoutId(e){this.project.state.currentLayoutId=e,this.updateLayoutIndicator()}updateLayoutIndicator(){const e=document.getElementById("currentLayoutName");e&&(e.textContent=this.project.deviceName||this.project.currentLayoutId||"Unknown")}setSnapEnabled(e){this.preferences.setSnapEnabled(e)}setShowGrid(e){this.preferences.setShowGrid(e)}setShowRulers(e){this.preferences.setShowRulers(e)}setZoomLevel(e){this.editor.setZoomLevel(e)}setCustomHardware(e){this.project.state.customHardware=e,W(B.STATE_CHANGED)}addWidget(e,i=null){this._checkRenderingModeForWidget(e),this.project.addWidget(e,i),this.recordHistory(),this.selectWidget(e.id),W(B.STATE_CHANGED)}updateWidget(e,i){this.project.updateWidget(e,i);const n=this.getWidgetById(e);if(n&&n.type==="group"){const t=["locked","hidden"],o={};if(t.forEach(s=>{i[s]!==void 0&&(o[s]=i[s])}),Object.keys(o).length>0){const s=this.pages[this.currentPageIndex];s&&s.widgets&&s.widgets.filter(l=>l.parentId===e).forEach(l=>this.updateWidget(l.id,o))}}i.parentId!==void 0&&this.syncWidgetOrderWithHierarchy(),W(B.STATE_CHANGED)}updateWidgets(e,i){e.forEach(n=>this.project.updateWidget(n,i)),W(B.STATE_CHANGED)}deleteWidget(e){const i=e?[e]:[...this.editor.selectedWidgetIds],n=[...i];i.forEach(t=>{const o=this.getWidgetById(t);o&&o.type==="group"&&this.pages[this.currentPageIndex].widgets.filter(r=>r.parentId===t).forEach(r=>n.push(r.id))}),this.project.deleteWidgets([...new Set(n)]),this.editor.setSelectedWidgetIds([]),this.recordHistory(),W(B.STATE_CHANGED)}groupSelection(){const e=this.editor.selectedWidgetIds,i=this.getSelectedWidgets(),n=i.some(a=>a.type==="group"||a.parentId);if(e.length<2||n)return;let t=1/0,o=1/0,s=-1/0,r=-1/0;i.forEach(a=>{t=Math.min(t,a.x),o=Math.min(o,a.y),s=Math.max(s,a.x+(a.width||0)),r=Math.max(r,a.y+(a.height||0))});const l="group_"+Ee(),c={id:l,type:"group",title:"Group",x:t,y:o,width:s-t,height:r-o,props:{},expanded:!0};this.project.addWidget(c),i.forEach(a=>{this.project.updateWidget(a.id,{parentId:l})}),this.selectWidget(l),this.syncWidgetOrderWithHierarchy(),this.recordHistory(),W(B.STATE_CHANGED)}ungroupSelection(e=null){let i=[];if(e)i=Array.isArray(e)?e:[e];else{const r=this.getSelectedWidgets(),l=new Set;r.forEach(c=>{c.type==="group"?l.add(c.id):c.parentId&&l.add(c.parentId)}),i=[...l]}const n=new Set;i.forEach(r=>{const l=this.getWidgetById(r);l&&(l.type==="group"?n.add(l.id):l.parentId&&n.add(l.parentId))});const t=[...n];if(t.length===0)return;const o=[];t.forEach(r=>{const l=this.getWidgetById(r);if(!l||l.type!=="group")return;this.pages[this.currentPageIndex].widgets.filter(u=>u.parentId===r).forEach(u=>{this.project.updateWidget(u.id,{parentId:null}),o.push(u.id)})}),this.project.deleteWidgets(t);const s=this.pages[this.currentPageIndex];s&&s.widgets&&(s.widgets=s.widgets.filter(r=>!t.includes(r.id))),o.length>0&&this.selectWidgets(o),this.syncWidgetOrderWithHierarchy(),this.recordHistory(),W(B.STATE_CHANGED)}alignSelectedWidgets(e){const i=this.getSelectedWidgets();if(i.length<2)return;let n;switch(e){case"left":n=Math.min(...i.map(s=>s.x)),i.forEach(s=>this.project.updateWidget(s.id,{x:n}));break;case"right":n=Math.max(...i.map(s=>s.x+(s.width||0))),i.forEach(s=>this.project.updateWidget(s.id,{x:n-(s.width||0)}));break;case"center":const t=i.map(s=>s.x+(s.width||0)/2);n=t.reduce((s,r)=>s+r,0)/t.length,i.forEach(s=>this.project.updateWidget(s.id,{x:n-(s.width||0)/2}));break;case"top":n=Math.min(...i.map(s=>s.y)),i.forEach(s=>this.project.updateWidget(s.id,{y:n}));break;case"bottom":n=Math.max(...i.map(s=>s.y+(s.height||0))),i.forEach(s=>this.project.updateWidget(s.id,{y:n-(s.height||0)}));break;case"middle":const o=i.map(s=>s.y+(s.height||0)/2);n=o.reduce((s,r)=>s+r,0)/o.length,i.forEach(s=>this.project.updateWidget(s.id,{y:n-(s.height||0)/2}));break}this.recordHistory(),W(B.STATE_CHANGED)}distributeSelectedWidgets(e){const i=[...this.getSelectedWidgets()];if(!(i.length<3)){if(e==="horizontal"){i.sort((a,u)=>a.x-u.x);const n=i[0],t=i[i.length-1],o=i.reduce((a,u)=>a+(u.width||0),0),l=(t.x+(t.width||0)-n.x-o)/(i.length-1);let c=n.x;for(let a=0;a<i.length;a++)this.project.updateWidget(i[a].id,{x:Math.round(c)}),c+=(i[a].width||0)+l}else{i.sort((a,u)=>a.y-u.y);const n=i[0],t=i[i.length-1],o=i.reduce((a,u)=>a+(u.height||0),0),l=(t.y+(t.height||0)-n.y-o)/(i.length-1);let c=n.y;for(let a=0;a<i.length;a++)this.project.updateWidget(i[a].id,{y:Math.round(c)}),c+=(i[a].height||0)+l}this.recordHistory(),W(B.STATE_CHANGED)}}moveWidgetToPage(e,i,n=null,t=null){const o=this.project.moveWidgetToPage(e,i,n,t);return o&&(this.syncWidgetOrderWithHierarchy(),this.recordHistory(),W(B.STATE_CHANGED)),o}clearCurrentPage(e=!1){const i=this.project.clearCurrentPage(e);return i.deleted>0&&(this.editor.setSelectedWidgetIds([]),this.recordHistory(),W(B.STATE_CHANGED)),i}copyWidget(e){const n=(e?[e]:this.editor.selectedWidgetIds).map(t=>this.getWidgetById(t)).filter(t=>!!t);n.length>0&&this.editor.copyWidgets(n)}pasteWidget(){const e=this.editor.clipboardWidgets;if(!e||e.length===0)return;const i=e.map(n=>{const t=JSON.parse(JSON.stringify(n));return t.id=Ee(),t.x+=10,t.y+=10,t});i.forEach(n=>{this._checkRenderingModeForWidget(n),this.project.addWidget(n)}),this.editor.setSelectedWidgetIds(i.map(n=>n.id)),this.recordHistory(),W(B.STATE_CHANGED)}createDropShadow(e){const i=this.getWidgetById(e);if(!i)return;const n=JSON.parse(JSON.stringify(i));n.id=Ee(),n.x=(n.x||0)+5,n.y=(n.y||0)+5,n.props||(n.props={});const t=this.project.getCurrentPage(),o=t?t.dark_mode:void 0;let s=!1;o==="dark"?s=!0:o==="light"?s=!1:s=!!this.settings.dark_mode;const r=s?"white":"black";if(n.props.color=r,n.props.border_color=r,n.props.background_color=r,n.props.bg_color=r,n.props.fill=!0,n.props.name&&(n.props.name=n.props.name+" Shadow"),this.project.addWidget(n),["shape_rect","rounded_rect","shape_circle","rectangle","rrect","circle"].includes(i.type)){const u=s?"black":"white";i.props||(i.props={});const g=s?"white":"black",m=i.props.color||g;i.props.border_color||(i.props.border_color=m),i.props.fill=!0,i.props.color=u,i.props.background_color=u,i.props.bg_color=u}const c=t.widgets.findIndex(u=>u.id===e),a=t.widgets.findIndex(u=>u.id===n.id);c!==-1&&a!==-1&&this.project.reorderWidget(this.project.currentPageIndex,a,c),this.recordHistory(),W(B.STATE_CHANGED)}recordHistory(){this._isRestoringHistory||this.editor.recordHistory({pages:this.project.pages,deviceName:this.project.deviceName})}undo(){const e=this.editor.undo();e&&(this._isRestoringHistory=!0,this.restoreSnapshot(e),setTimeout(()=>{this._isRestoringHistory=!1},0))}redo(){const e=this.editor.redo();e&&(this._isRestoringHistory=!0,this.restoreSnapshot(e),setTimeout(()=>{this._isRestoringHistory=!1},0))}restoreSnapshot(e){this.project.state.pages=JSON.parse(JSON.stringify(e.pages)),this.project.state.deviceName=e.deviceName,this.project.rebuildWidgetsIndex(),W(B.STATE_CHANGED)}canUndo(){return this.editor.canUndo()}canRedo(){return this.editor.canRedo()}syncWidgetOrderWithHierarchy(){const e=this.getCurrentPage();if(!e||!e.widgets)return;const i=[...e.widgets],n=i.filter(r=>!r.parentId),t=new Map;i.forEach(r=>{r.parentId&&(t.has(r.parentId)||t.set(r.parentId,[]),t.get(r.parentId).push(r))});const o=[],s=r=>{o.push(r);const l=t.get(r.id);l&&(l.sort((c,a)=>i.indexOf(c)-i.indexOf(a)),l.forEach(s))};n.forEach(s),e.widgets=o,this.project.rebuildWidgetsIndex()}_checkRenderingModeForWidget(e){if(!e||!e.type)return;e.type.startsWith("lvgl_")&&this.preferences.state.renderingMode==="direct"&&(this.updateSettings({renderingMode:"lvgl"}),_.log(`[AppState] Auto-switched to LVGL rendering mode because an LVGL widget (${e.type}) was added.`),U("Auto-switched to LVGL rendering mode","info"))}}const Qt=new Si;window.AppState=Qt;const h=Qt;window.AppState=h;window.ESPHomeDesigner=window.ESPHomeDesigner||{};window.ESPHomeDesigner.state=h;function At(){if(!window.jsyaml)return null;if(window._esphomeYamlSchema)return window._esphomeYamlSchema;try{const d=new jsyaml.Type("!lambda",{kind:"scalar",construct:function(n){return n}}),e=new jsyaml.Type("!<!lambda>",{kind:"scalar",construct:function(n){return n}}),i=new jsyaml.Type("!secret",{kind:"scalar",construct:function(n){return`!secret ${n}`}});return window._esphomeYamlSchema=jsyaml.DEFAULT_SCHEMA.extend([d,e,i]),window._esphomeYamlSchema}catch(d){return _.error("[getESPHomeSchema] Error creating schema:",d),jsyaml.DEFAULT_SCHEMA}}function Bt(d){_.log("[parseSnippetYamlOffline] Start parsing with js-yaml...");const e=d.split(/\r?\n/),i=[];let n={};try{window.jsyaml&&(n=jsyaml.load(d,{schema:At()})||{},_.log("[parseSnippetYamlOffline] YAML parsed successfully with js-yaml"))}catch(E){_.error("[parseSnippetYamlOffline] YAML parse error:",E)}if(n.display&&(Array.isArray(n.display)?n.display:[n.display]).forEach(L=>{L&&L.lambda&&i.push(...L.lambda.split(`
`))}),i.length===0){let E=!1,L=0;for(const k of e){const H=k.replace(/\t/g,"    ");if(!E&&H.match(/^\s*lambda:\s*\|\-/)){E=!0;continue}if(E){const z=H.match(/^(\s+)/);if(z){const F=z[1].length;if(L===0&&(L=F),F<L){E=!1;continue}i.push(H.slice(L))}else H.trim()===""?i.push(""):H.match(/^\w+:/)&&(E=!1)}}}_.log(`[parseSnippetYamlOffline] Collected ${i.length} info lines`);const t=new Map,o=new Map,s=new Map,r=new Map,l=new Map,c=new Map,a=new Map,u=new Map,g=(E,L,k)=>{const H=[];let z=L;for(;z<E.length;){const F=E[z];if(!F){z++;continue}const A=F.trim();if(!A||A.startsWith("#")){H.push(F),z++;continue}const Y=F.match(/^(\s*)/);if((Y?Y[1].length:0)<k)break;H.push(F),z++}try{const F=H.join(`
`);return{value:jsyaml.load(F,{schema:At()}),nextJ:z}}catch(F){return _.error("Error parsing YAML sub-block:",F),{value:null,nextJ:z}}},m=e;let f=null,y=!1;const b=["label","button","arc","bar","slider","chart","dropdown","roller","spinbox","switch","textarea","obj","img","qrcode","led","spinner","line","meter","tabview","tileview","checkbox","keyboard","buttonmatrix","list","icon"],w={label:"lvgl_label",button:"lvgl_button",arc:"lvgl_arc",bar:"lvgl_bar",slider:"lvgl_slider",chart:"lvgl_chart",dropdown:"lvgl_dropdown",roller:"lvgl_roller",spinbox:"lvgl_spinbox",switch:"lvgl_switch",textarea:"lvgl_textarea",obj:"lvgl_obj",img:"lvgl_img",qrcode:"lvgl_qrcode",led:"lvgl_led",spinner:"lvgl_spinner",line:"lvgl_line",meter:"lvgl_meter",tabview:"lvgl_tabview",tileview:"lvgl_tileview",checkbox:"lvgl_checkbox",keyboard:"lvgl_keyboard",buttonmatrix:"lvgl_buttonmatrix",icon:"icon"};for(let E=0;E<i.length;E++){const L=i[E],k=L.trim();if(!k)continue;let H=L.match(/if\s*\(\s*(?:id\s*\(\s*display_page\s*\)|page|currentPage)\s*==\s*(\d+)\s*\)/);H&&(f=parseInt(H[1],10),y=!1,t.has(f)||t.set(f,[]));const z=L.match(/^\s*-\s*id:\s*(\w+)/);if(z){const P=z[1],X=P.match(/^page_(\d+)$/);let D=X?parseInt(X[1],10):t.size;t.has(D)||(t.set(D,[]),s.set(D,P)),f=D,y=!1,_.log(`[parseSnippetYamlOffline] Detected LVGL Page: ${P} (mapped to idx ${D})`)}const F=L.match(/^\s*layout:\s*(\d+x\d+)/);if(F&&f!==null&&(u.set(f,F[1]),_.log(`[parseSnippetYamlOffline] Detected layout: ${F[1]} for page ${f}`)),k.startsWith("widgets:")){y=!0;continue}const A=L.match(/case\s+(\d+):\s*interval\s*=\s*(\d+);/);if(A){const P=parseInt(A[1],10),X=parseInt(A[2],10);o.set(P,X),t.has(P)||t.set(P,[])}const Y=L.match(/\/\/\s*page:name\s+"(.+)"/);Y&&f!==null&&s.set(f,Y[1]);const Z=L.match(/\/\/\s*page:dark_mode\s+"(.+)"/);Z&&f!==null&&r.set(f,Z[1]);const j=L.match(/\/\/\s*page:refresh_type\s+"(.+)"/);j&&f!==null&&l.set(f,j[1]);const p=L.match(/\/\/\s*page:refresh_time\s+"(.*)"/);if(p&&f!==null&&c.set(f,p[1]),!y){const P=L.match(/^\s*bg_color:\s*(.*)/);if(P&&f!==null){let D=P[1].trim().replace(/^["']|["']$/g,"");if(D.startsWith("0x")&&(D="#"+D.substring(2)),a.has(f)||a.set(f,{}),a.get(f).bg_color=D,D.startsWith("#")){const I=D.substring(1);if(I.length===6){const ee=parseInt(I.substring(0,2),16),C=parseInt(I.substring(2,4),16),x=parseInt(I.substring(4,6),16);(ee*299+C*587+x*114)/1e3<128&&(r.has(f)||r.set(f,"dark"))}}}const X=L.match(/^\s*bg_opa:\s*(.*)/);if(X&&f!==null){let D=X[1].trim().replace(/^["']|["']$/g,"");D.endsWith("%")&&(D=String(Math.round(parseFloat(D)*2.55))),a.has(f)||a.set(f,{}),a.get(f).bg_opa=parseInt(D,10)}}}const S={orientation:"landscape",dark_mode:!1,sleep_enabled:!1,sleep_start_hour:0,sleep_end_hour:5,manual_refresh_only:!1,deep_sleep_enabled:!1,deep_sleep_interval:600,daily_refresh_enabled:!1,daily_refresh_time:"08:00",refresh_interval:600};for(const E of m){const L=E.trim();if(!L.startsWith("#"))continue;let k;if((k=L.match(/TARGET DEVICE:\s*(.*)/i))&&(S.target_device=k[1].trim()),(k=L.match(/Name:\s*(.*)/i))&&(S.name=k[1].trim()),(k=L.match(/Resolution:\s*(\d+)x(\d+)/i))&&(S.width=parseInt(k[1],10),S.height=parseInt(k[2],10)),(k=L.match(/Shape:\s*(rect|round|circle)/i))&&(S.shape=k[1].toLowerCase()==="rect"?"rect":"round"),(k=L.match(/Inverted:\s*(true|false)/i))&&(S.inverted_colors=k[1].toLowerCase()==="true"),(k=L.match(/Orientation:\s*(landscape|portrait)/i))&&(S.orientation=k[1].toLowerCase()),(k=L.match(/Dark Mode:\s*(enabled|disabled)/i))&&(S.dark_mode=k[1].toLowerCase()==="enabled"),(k=L.match(/Refresh Interval:\s*(\d+)/i))&&(S.refresh_interval=parseInt(k[1],10)),k=L.match(/Power Strategy:\s*(.*)/i)){const H=k[1].trim().toLowerCase();S.sleep_enabled=H.includes("night"),S.manual_refresh_only=H.includes("manual"),S.deep_sleep_enabled=H.includes("ultra")||H.includes("deep"),S.daily_refresh_enabled=H.includes("daily")}(k=L.match(/Sleep Mode:\s*(enabled|disabled)/i))&&(S.sleep_enabled=k[1].toLowerCase()==="enabled"),(k=L.match(/Sleep Start Hour:\s*(\d+)/i))&&(S.sleep_start_hour=parseInt(k[1],10)),(k=L.match(/Sleep End Hour:\s*(\d+)/i))&&(S.sleep_end_hour=parseInt(k[1],10)),(k=L.match(/Manual Refresh:\s*(enabled|disabled)/i))&&(S.manual_refresh_only=k[1].toLowerCase()==="enabled"),(k=L.match(/Deep Sleep:\s*(enabled|disabled)/i))&&(S.deep_sleep_enabled=k[1].toLowerCase()==="enabled"),(k=L.match(/Deep Sleep Interval:\s*(\d+)/i))&&(S.deep_sleep_interval=parseInt(k[1],10)),(k=L.match(/Refresh Time:\s*(\d{2}:\d{2})/i))&&(S.daily_refresh_time=k[1]),(k=L.match(/Disable updates from\s*(\d+)\s*to\s*(\d+)/i))&&(S.no_refresh_start_hour=parseInt(k[1],10),S.no_refresh_end_hour=parseInt(k[2],10))}t.size===0&&t.set(0,[]);const T={settings:S,pages:Array.from(t.entries()).sort((E,L)=>E[0]-L[0]).map(([E,L])=>({id:`page_${E}`,name:s.has(E)?s.get(E):`Page ${E+1}`,refresh_s:o.has(E)?o.get(E):null,refresh_type:l.has(E)?l.get(E):"interval",refresh_time:c.has(E)?c.get(E):"",dark_mode:r.has(E)?r.get(E):"inherit",layout:u.has(E)?u.get(E):null,bg_color:a.has(E)?a.get(E).bg_color:null,bg_opa:a.has(E)?a.get(E).bg_opa:null,widgets:[]}))};f=0;function R(){const E=T.pages.find((L,k)=>k===f);return E?E.widgets:T.pages[0].widgets}function v(E){const L=E.match(/^(?:#\s*|\/\/\s*)widget:(\w+)\s+(.+)$/);if(!L)return(E.startsWith("// widget:")||E.startsWith("# widget:"))&&_.warn("[parseWidgetMarker] Regex failed for:",E),null;const k=L[1],H=L[2],z={};_.log(`[parseWidgetMarker] Found widget: ${k}`);const F=/(\w+):(?:"([^"]*)"|([^:]*?)(?=\s+\w+:|$))/g;let A;for(;(A=F.exec(H))!==null;){let Y=A[2]!==void 0?A[2]:A[3];Y&&(Y=Y.trim()),z[A[1]]=Y}return{widgetType:k,props:z}}let M=!1;for(let E=0;E<i.length;E++){const L=i[E],k=L.trim();if(!k||k.startsWith("#")&&!k.match(/^#\s*widget:/))continue;let H=k.match(/if\s*\(\s*(?:id\s*\(\s*display_page\s*\)|page|currentPage)\s*==\s*(\d+)\s*\)/);if(H){f=parseInt(H[1],10);continue}const z=k.match(/^-\s*id:\s*(\w+)/);if(z){const j=z[1],p=j.match(/^page_(\d+)$/);f=p?parseInt(p[1],10):Array.from(s.entries()).find(([P,X])=>X===j)?.[0]||0,_.log(`[parseSnippetYamlOffline] Processing widgets for page: ${j} (idx ${f})`);continue}const F=R();if(M)if(k.match(/^(?:#\s*|\/\/\s*)widget:/)||k.match(/^\s*-\s*id:/)||!L.match(/^\s/))M=!1;else continue;if(k.startsWith("//")||k.startsWith("#")){const j=v(k);if(j&&j.props.id){const p=j.props,P=j.widgetType||p.type;if(!P){_.warn("[parseSnippetYamlOffline] Widget marker found but no type determined:",k);continue}let X=100,D=30;P==="template_nav_bar"?(X=200,D=50):P==="touch_area"?(X=100,D=100):["nav_next_page","nav_previous_page","nav_reload_page"].includes(P)?(X=80,D=80):(P==="battery_icon"||P==="wifi_signal"||P==="icon")&&(X=60,D=60);const I={id:p.id,type:P,x:parseInt(p.x||0,10),y:parseInt(p.y||0,10),width:parseInt(p.w||X,10),height:parseInt(p.h||D,10),title:p.title||"",entity_id:p.entity||p.ent||"",condition_entity:p.cond_ent||"",condition_operator:p.cond_op||"",condition_state:p.cond_state||"",condition_min:p.cond_min||"",condition_max:p.cond_max||"",props:{}};if(P.startsWith("lvgl_")){Object.entries(p).forEach(([x,O])=>{["id","type","x","y","w","h","width","height"].includes(x)||(O==="true"?I.props[x]=!0:O==="false"?I.props[x]=!1:I.props[x]=O)}),I.props.hidden=p.hidden==="true",I.props.clickable=p.clickable!=="false",I.props.checkable=p.checkable==="true",I.props.scrollable=p.scrollable!=="false",I.props.floating=p.floating==="true",I.props.ignore_layout=p.ignore_layout==="true",I.props.scrollbar_mode=p.scrollbar_mode||"AUTO",I.props.opa=parseInt(p.opa||255,10);const ee=p.grid_cell_row_pos??p.grid_row,C=p.grid_cell_column_pos??p.grid_col;I.props.grid_cell_row_pos=ee!=null?parseInt(ee,10):null,I.props.grid_cell_column_pos=C!=null?parseInt(C,10):null,I.props.grid_cell_row_span=parseInt(p.grid_cell_row_span||p.grid_row_span||1,10),I.props.grid_cell_column_span=parseInt(p.grid_cell_column_span||p.grid_col_span||1,10),I.props.grid_cell_x_align=p.grid_cell_x_align||p.grid_x_align||"STRETCH",I.props.grid_cell_y_align=p.grid_cell_y_align||p.grid_y_align||"STRETCH"}if(P==="icon")I.props={code:p.code||"F0595",size:parseInt(p.size||48,10),color:p.color||"black",fit_icon_to_frame:p.fit==="true"||p.fit==="1"};else if(P==="text"||P==="label")I.props={text:p.text||"",font_size:parseInt(p.font_size||p.size||20,10),font_family:p.font_family||p.font||"Roboto",font_weight:parseInt(p.font_weight||p.weight||400,10),italic:p.italic==="true"||p.italic===!0,bpp:parseInt(p.bpp||1,10),color:p.color||"black",text_align:p.align||p.text_align||"TOP_LEFT"};else if(P==="sensor_text")I.props={label_font_size:parseInt(p.label_font||p.label_font_size||14,10),value_font_size:parseInt(p.value_font||p.value_font_size||20,10),value_format:p.format||"label_value",color:p.color||"black",italic:p.italic==="true"||p.italic===!0||p.font_style==="italic",font_family:p.font_family||"Roboto",font_weight:parseInt(p.font_weight||400,10),prefix:p.prefix||"",postfix:p.postfix||"",unit:p.unit||"",hide_unit:p.hide_unit==="true"||p.hide_unit===!0,precision:parseInt(p.precision||-1,10),text_align:p.align||p.text_align||"TOP_LEFT",label_align:p.label_align||p.align||p.text_align||"TOP_LEFT",value_align:p.value_align||p.align||p.text_align||"TOP_LEFT",is_local_sensor:p.local==="true",is_text_sensor:p.text_sensor==="true",separator:p.separator||" ~ "},I.entity_id_2=p.entity_2||"";else if(P==="datetime")I.width=parseInt(p.w||200,10),I.height=parseInt(p.h||60,10),I.props={format:p.format||"time_date",time_font_size:parseInt(p.time_font_size||p.time_size||p.time_font||28,10),date_font_size:parseInt(p.date_font_size||p.date_size||p.date_font||16,10),color:p.color||"black",italic:p.italic==="true"||p.italic===!0||p.font_style==="italic",font_family:p.font_family||"Roboto",text_align:p.align||p.text_align||"CENTER"};else if(P==="progress_bar")I.props={show_label:p.show_label!=="false",show_percentage:p.show_pct!=="false",bar_height:parseInt(p.bar_h||p.bar_height||15,10),border_width:parseInt(p.border_w||p.border||1,10),color:p.color||"black",is_local_sensor:p.local==="true"};else if(P==="battery_icon")I.props={size:parseInt(p.size||32,10),font_size:parseInt(p.font_size||12,10),color:p.color||"black",is_local_sensor:p.local==="true",fit_icon_to_frame:p.fit==="true"||p.fit==="1"};else if(P==="wifi_signal")I.props={size:parseInt(p.size||24,10),font_size:parseInt(p.font_size||12,10),color:p.color||"black",is_local_sensor:p.local!=="false",show_dbm:p.show_dbm!=="false",fit_icon_to_frame:p.fit==="true"||p.fit==="1"};else if(P==="ondevice_temperature")I.props={size:parseInt(p.size||32,10),font_size:parseInt(p.font_size||16,10),label_font_size:parseInt(p.label_font_size||10,10),color:p.color||"black",unit:p.unit||"Â°C",precision:parseInt(p.precision||1,10),show_label:p.show_label!=="false",is_local_sensor:p.local!=="false",fit_icon_to_frame:p.fit==="true"||p.fit==="1"};else if(P==="ondevice_humidity")I.props={size:parseInt(p.size||32,10),font_size:parseInt(p.font_size||16,10),label_font_size:parseInt(p.label_font_size||10,10),color:p.color||"black",unit:p.unit||"%",precision:parseInt(p.precision||0,10),show_label:p.show_label!=="false",is_local_sensor:p.local!=="false",fit_icon_to_frame:p.fit==="true"||p.fit==="1"};else if(P==="weather_icon")I.props={size:parseInt(p.size||48,10),color:p.color||"black"};else if(P==="qr_code")I.props={value:p.value||"https://esphome.io",scale:parseInt(p.scale||2,10),ecc:p.ecc||"LOW",color:p.color||"black"};else if(P==="image")I.props={path:(p.path||"").replace(/^"|"$/g,""),invert:p.invert==="true"||p.invert==="1",dither:p.dither||"FLOYDSTEINBERG",transparency:p.transparency||"",image_type:p.img_type||"BINARY",render_mode:p.render_mode||"Auto"};else if(P==="online_image")I.props={url:p.url||"",invert:p.invert==="true"||p.invert==="1",interval_s:parseInt(p.interval||300,10),render_mode:p.render_mode||"Auto"};else if(P==="puppet")I.props={image_url:p.url||"",invert:p.invert==="true"||p.invert==="1",image_type:p.img_type||"RGB565",transparency:p.transparency||"opaque",render_mode:p.render_mode||"Auto"};else if(P==="shape_rect")I.props={fill:p.fill==="true"||p.fill==="1",border_width:parseInt(p.border||1,10),color:p.color||"black",border_color:p.border_color||p.color||"black",opacity:parseInt(p.opacity||100,10)};else if(P==="touch_area")I.props={title:p.title||"Touch Area",color:p.color||"rgba(0, 0, 255, 0.2)",border_color:p.border_color||"#0000ff",icon:p.icon||"",icon_pressed:p.icon_pressed||"",icon_size:parseInt(p.icon_size||40,10),icon_color:p.icon_color||"black",nav_action:p.nav_action||"none"};else if(P==="rounded_rect")I.props={fill:p.fill==="true"||p.fill==="1",show_border:p.show_border!=="false"&&p.show_border!=="0",border_width:parseInt(p.border||4,10),radius:parseInt(p.radius||10,10),color:p.color||"black",border_color:p.border_color||"black",opacity:parseInt(p.opacity||100,10)};else if(P==="shape_circle")I.props={fill:p.fill==="true"||p.fill==="1",border_width:parseInt(p.border||1,10),color:p.color||"black",border_color:p.border_color||p.color||"black",opacity:parseInt(p.opacity||100,10)};else if(P==="line")I.props={stroke_width:parseInt(p.stroke||3,10),color:p.color||"black",orientation:p.orientation||"horizontal"};else if(P==="graph")I.entity_id=p.entity||"",I.props={duration:p.duration||"1h",border:p.border==="true"||p.border==="1"||p.border==null,grid:p.grid==="true"||p.grid==="1"||p.grid==null,color:p.color||"black",x_grid:p.x_grid||"",y_grid:p.y_grid||"",line_thickness:parseInt(p.line_thickness||3,10),line_type:p.line_type||"SOLID",continuous:p.continuous!=="false"&&p.continuous!=="0",min_value:p.min_value||"",max_value:p.max_value||"",min_range:p.min_range||"",max_range:p.max_range||"",is_local_sensor:p.local==="true"};else if(P==="quote_rss")I.props={feed_url:p.feed_url||"https://www.brainyquote.com/link/quotebr.rss",show_author:p.show_author!=="false",random:p.random!=="false",refresh_interval:p.refresh_interval||p.refresh||"24h",quote_font_size:parseInt(p.quote_font_size||p.quote_font||18,10),author_font_size:parseInt(p.author_font_size||p.author_font||14,10),font_family:p.font_family||p.font||"Roboto",font_weight:parseInt(p.font_weight||p.weight||400,10),color:p.color||"black",text_align:p.align||p.text_align||"TOP_LEFT",word_wrap:p.word_wrap!=="false"&&p.wrap!=="false",italic_quote:p.italic_quote!=="false"};else if(P==="weather_forecast")I.props={weather_entity:p.weather_entity||"",layout:p.layout||"horizontal",show_high_low:p.show_high_low!=="false",day_font_size:parseInt(p.day_font_size||12,10),temp_font_size:parseInt(p.temp_font_size||14,10),icon_size:parseInt(p.icon_size||32,10),font_family:p.font_family||"Roboto",color:p.color||"black"};else if(P==="template_sensor_bar")I.props={show_wifi:p.wifi!=="false",show_temperature:p.temp!=="false",show_humidity:p.hum!=="false",show_battery:p.bat!=="false",show_background:p.bg!=="false",background_color:p.bg_color||"gray",border_radius:parseInt(p.radius||8,10),icon_size:parseInt(p.icon_size||20,10),font_size:parseInt(p.font_size||14,10),color:p.color||"black"};else if(P==="template_nav_bar")I.props={show_prev:p.prev!=="false",show_home:p.home!=="false",show_next:p.next!=="false",show_background:p.bg!=="false",background_color:p.bg_color||"gray",border_radius:parseInt(p.radius||8,10),icon_size:parseInt(p.icon_size||24,10),color:p.color||"black"};else if(P==="lvgl_button")_.log("[YAML_IMPORT] Parsing lvgl_button",p.id,p),I.props={...I.props,text:p.text||"BTN",bg_color:p.bg_color||"white",color:p.color||"black",border_width:parseInt(p.border_width||p.border||2,10),radius:parseInt(p.radius||5,10),checkable:p.checkable==="true"},p.title&&(I.title=p.title);else if(P==="lvgl_arc")I.props={...I.props,min:parseInt(p.min||0,10),max:parseInt(p.max||100,10),value:parseInt(p.value||0,10),thickness:parseInt(p.thickness||10,10),color:p.color||"blue",start_angle:parseInt(p.start_angle||135,10),end_angle:parseInt(p.end_angle||45,10),mode:p.mode||"NORMAL"},p.title&&(I.title=p.title,I.props.title=p.title);else if(P==="lvgl_chart")I.props={...I.props,title:p.title||"Graph",type:p.type||"LINE",color:p.color||"black",bg_color:p.bg_color||"white",point_count:parseInt(p.point_count||10,10),x_div_lines:parseInt(p.x_div_lines||3,10),y_div_lines:parseInt(p.y_div_lines||3,10)},p.title&&(I.title=p.title);else if(P==="lvgl_img")I.props={...I.props,src:p.src||"symbol_image",rotation:parseInt(p.rotation||0,10),scale:parseInt(p.scale||256,10),pivot_x:parseInt(p.pivot_x||0,10),pivot_y:parseInt(p.pivot_y||0,10),color:p.color||"black"};else if(P==="lvgl_qrcode")I.props={...I.props,text:p.text||"https://esphome.io",scale:parseInt(p.scale||2,10),color:p.color||"black",bg_color:p.bg_color||"white"};else if(P==="lvgl_bar")I.props={...I.props,min:parseInt(p.min||0,10),max:parseInt(p.max||100,10),value:parseInt(p.value||0,10),color:p.color||"blue",bg_color:p.bg_color||"gray",start_value:parseInt(p.start_value||0,10),mode:p.mode||"NORMAL"};else if(P==="lvgl_slider")I.props={...I.props,min:parseInt(p.min||0,10),max:parseInt(p.max||100,10),value:parseInt(p.value||30,10),border_width:parseInt(p.border_width||2,10),color:p.color||"blue",bg_color:p.bg_color||"gray",mode:p.mode||"NORMAL",vertical:p.vertical==="true"||p.vertical===!0};else if(P==="lvgl_tabview")I.props={...I.props,bg_color:p.bg_color||"white",tabs:(p.tabs||"").split(",").map(ee=>ee.trim()).filter(ee=>ee)};else if(P==="lvgl_tileview")I.props={...I.props,bg_color:p.bg_color||"white",tiles:[]};else if(P==="lvgl_led")I.props={...I.props,color:p.color||"red",brightness:parseInt(p.brightness||255,10)};else if(P==="lvgl_spinner")I.props={...I.props,spin_time:parseInt(p.spin_time||1e3,10),arc_length:parseInt(p.arc_length||60,10),arc_color:p.arc_color||"blue",track_color:p.track_color||"white"};else if(P==="lvgl_buttonmatrix")I.props={...I.props,rows:[]};else if(P==="lvgl_checkbox")I.props={...I.props,text:(p.text||"Checkbox").replace(/^"|"$/g,""),checked:p.checked==="true"||p.checked===!0,color:p.color||"blue"};else if(P==="lvgl_dropdown")I.props={...I.props,options:(p.options||"").replace(/\\n/g,`
`),selected_index:parseInt(p.selected_index||0,10),color:p.color||"white",direction:p.direction||"DOWN",max_height:parseInt(p.max_height||200,10)};else if(P==="lvgl_keyboard")I.props={...I.props,mode:p.mode||"TEXT_UPPER",textarea_id:p.textarea||""};else if(P==="lvgl_roller")I.props={...I.props,options:(p.options||"").replace(/\\n/g,`
`),visible_row_count:parseInt(p.visible_row_count||3,10),color:p.color||"white",bg_color:p.bg_color||"black",selected_bg_color:p.selected_bg_color||"blue",selected_text_color:p.selected_text_color||"white",mode:p.mode||"NORMAL"};else if(P==="lvgl_spinbox")I.props={...I.props,min:parseInt(p.range_from||p.min||0,10),max:parseInt(p.range_to||p.max||100,10),digit_count:parseInt(p.digits||p.digit_count||4,10),step:parseInt(p.step||1,10),value:parseInt(p.value||0,10)};else if(P==="lvgl_switch")I.props={...I.props,checked:p.state==="true"||p.state===!0||p.checked==="true",bg_color:p.bg_color||"gray",color:p.color||"blue",knob_color:p.knob_color||"white"};else if(P==="lvgl_textarea")I.props={...I.props,placeholder:(p.placeholder_text||p.placeholder||"").replace(/^"|"$/g,""),text:(p.text||"").replace(/^"|"$/g,""),one_line:p.one_line==="true"||p.one_line===!0,max_length:parseInt(p.max_length||0,10),password_mode:p.password_mode==="true",accepted_chars:p.accepted_chars||""};else if(P==="lvgl_label")I.props={...I.props,text:(p.text||"Label").replace(/^"|"$/g,""),font_size:parseInt(p.font_size||p.size||20,10),font_family:p.font_family||"Roboto",font_weight:parseInt(p.font_weight||400,10),italic:p.italic==="true"||p.italic===!0,color:p.color||"black",bg_color:p.bg_color||"transparent",text_align:p.text_align||p.align||"CENTER"};else if(P==="lvgl_line")I.props={...I.props,orientation:p.orientation||"horizontal",points:p.points||"",line_width:parseInt(p.line_width||3,10),line_color:p.line_color||p.color||"black",line_rounded:p.line_rounded!=="false"};else if(P==="lvgl_meter")I.props={...I.props,min:parseInt(p.min||0,10),max:parseInt(p.max||100,10),value:parseInt(p.value||60,10),color:p.color||"black",indicator_color:p.indicator_color||"red",tick_count:parseInt(p.tick_count||11,10),tick_length:parseInt(p.tick_length||10,10),label_gap:parseInt(p.label_gap||10,10),scale_width:parseInt(p.scale_width||10,10),indicator_width:parseInt(p.indicator_width||4,10)};else if(P==="lvgl_obj")I.props={...I.props,color:p.color||"white",border_width:parseInt(p.border_width||1,10),border_color:p.border_color||"gray",radius:parseInt(p.radius||0,10)};else if(P.startsWith("lvgl_")){_.log("[YAML_IMPORT] Parsing generic LVGL",P,p.id,p);const ee=I.props||{};I.props={...ee};const C=["hidden","clickable","checkable","scrollable","floating","ignore_layout","scrollbar_mode","opa","grid_cell_row_pos","grid_cell_column_pos","grid_cell_row_span","grid_cell_column_span","grid_cell_x_align","grid_cell_y_align"];Object.entries(p).forEach(([x,O])=>{if(!(x==="id"||x==="type"||x==="x"||x==="y"||x==="w"||x==="h")&&!C.includes(x)){if(x==="title"){I.title=O;return}O==="true"?I.props[x]=!0:O==="false"?I.props[x]=!1:Array.isArray(O)?x==="options"?I.props[x]=O.join(`
`):x==="points"?I.props[x]=O.map($=>Array.isArray($)?$.join(","):String($)).join(" "):I.props[x]=O:I.props[x]=O}})}else P==="calendar"&&(_.log("[YAML_IMPORT] Parsing calendar",p.id,p),I.props={entity_id:p.entity||"sensor.esp_calendar_data",border_width:parseInt(p.border_width||2,10),show_border:p.show_border!=="false",border_color:p.border_color||"black",background_color:p.background_color||"white",text_color:p.text_color||"black",font_size_date:parseInt(p.font_size_date||100,10),font_size_day:parseInt(p.font_size_day||24,10),font_size_grid:parseInt(p.font_size_grid||14,10),font_size_event:parseInt(p.font_size_event||18,10)});F.push(I),M=!0;continue}continue}let A;if(A=k.match(/^it\.rectangle\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*COLOR_OFF)?\s*\)\s*;?/),A){F.push({id:"w_rect_"+F.length,type:"shape_rect",x:parseInt(A[1],10),y:parseInt(A[2],10),width:parseInt(A[3],10),height:parseInt(A[4],10),title:"",entity_id:"",props:{fill:!1,border_width:1,color:"black",opacity:100}});continue}if(A=k.match(/^it\.filled_rectangle\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*COLOR_OFF)?\s*\)\s*;?/),A){F.push({id:"w_frect_"+F.length,type:"shape_rect",x:parseInt(A[1],10),y:parseInt(A[2],10),width:parseInt(A[3],10),height:parseInt(A[4],10),title:"",entity_id:"",props:{fill:!0,border_width:1,color:"black",opacity:100}});continue}if(A=k.match(/^it\.circle\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*COLOR_OFF)?\s*\)\s*;?/),A){const j=parseInt(A[3],10);F.push({id:"w_circle_"+F.length,type:"shape_circle",x:parseInt(A[1],10)-j,y:parseInt(A[2],10)-j,width:j*2,height:j*2,title:"",entity_id:"",props:{fill:!1,border_width:1,color:"black",opacity:100}});continue}if(A=k.match(/^it\.filled_circle\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*COLOR_OFF)?\s*\)\s*;?/),A){const j=parseInt(A[3],10);F.push({id:"w_fcircle_"+F.length,type:"shape_circle",x:parseInt(A[1],10)-j,y:parseInt(A[2],10)-j,width:j*2,height:j*2,title:"",entity_id:"",props:{fill:!0,border_width:1,color:"black",opacity:100}});continue}if(A=k.match(/^it\.line\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)\s*;?/),A){const j=parseInt(A[1],10),p=parseInt(A[2],10),P=parseInt(A[3],10),X=parseInt(A[4],10);F.push({id:"w_line_"+F.length,type:"line",x:j,y:p,width:P-j,height:X-p,title:"",entity_id:"",props:{stroke_width:1,color:"black",orientation:Math.abs(X-p)>Math.abs(P-j)?"vertical":"horizontal"}});continue}const Y=new RegExp(`^(\\s*)-?\\s*(${b.join("|")}):\\s*(.*)$`),Z=L.match(Y);if(Z){const j=Z[1].length,p=Z[2],P=Z[3].trim(),X=w[p]||`lvgl_${p}`,D={};P&&(D._inline=P.replace(/^["']|["']$/g,""));const I=g(i,E+1,j+2);Object.assign(D,I.value),E=I.nextJ-1;const C={id:D.id||`lv_${p}_${F.length}`,type:X,x:parseInt(D.x||0,10),y:parseInt(D.y||0,10),width:parseInt(D.width||D.w||100,10),height:parseInt(D.height||D.h||30,10),title:D.title||D.name||"",entity_id:D.entity_id||D.entity||D.sensor||"",props:{}};if(C.props.hidden=D.hidden==="true",C.props.clickable=D.clickable!=="false",C.props.scrollable=D.scrollable!=="false",D.bg_color&&(C.props.bg_color=D.bg_color),D.bg_opa){let x=D.bg_opa;x.toString().endsWith("%")&&(x=Math.round(parseFloat(x)*2.55)),C.props.opa=parseInt(x,10)}D.text?C.props.text=D.text:D._inline&&p==="label"&&(C.props.text=D._inline),Object.entries(D).forEach(([x,O])=>{if(["id","x","y","width","height","w","h","type","bg_color","bg_opa","_inline","widgets"].includes(x))return;if((x==="indicator"||x==="knob"||x==="selected")&&typeof O=="object"&&O!==null&&!Array.isArray(O)){Object.entries(O).forEach(([se,te])=>{C.props[`${x}_${se}`]=te});return}let $=O;if(Array.isArray(O)?x==="options"?$=O.join(`
`):x==="points"&&($=O.map(se=>Array.isArray(se)?se.join(","):String(se)).join(" ")):typeof O=="string"&&/^-?\d+(\.\d+)?(ms|deg|px|%)$/.test(O)&&($=O.replace(/(ms|deg|px|%)$/,"")),C.props[x]===void 0)if($==="true")C.props[x]=!0;else if($==="false")C.props[x]=!1;else if(!isNaN($)&&$!==""&&x!=="text"&&x!=="id"&&x!=="name"&&typeof $!="object")C.props[x]=parseFloat($);else if(typeof $=="string"&&$.includes("\\u"))try{C.props[x]=JSON.parse(`"${$}"`)}catch{C.props[x]=$}else C.props[x]=$}),F.push(C),Array.isArray(D.widgets)&&D.widgets.forEach(x=>{const O=Object.keys(x)[0],$=x[O];if(O&&$){const se=w[O]||`lvgl_${O}`,te={id:$.id||`lv_${O}_${F.length}`,type:se,x:C.x+parseInt($.x||0,10),y:C.y+parseInt($.y||0,10),width:parseInt($.width||$.w||50,10),height:parseInt($.height||$.h||20,10),props:{...$}};F.push(te)}})}}return T}function le(d){if(!d)throw _.error("Invalid layout - null or undefined"),new Error("invalid_layout");if(d.data&&d.data.devices){const g=Object.keys(d.data.devices);if(g.length>0){const m=g[0];_.log(`[loadLayoutIntoState] Detected legacy HA storage format. unwrapping device: ${m}`),d=d.data.devices[m]}}if(!Array.isArray(d.pages))throw _.error("Invalid layout - missing pages array"),new Error("invalid_layout");const e=d.pages.map((g,m)=>({...g,id:g.id||`page_${m}`,name:g.name||`Page ${m+1}`,widgets:Array.isArray(g.widgets)?g.widgets:[]}));e.length||(_.warn("No pages, creating default empty page"),e.push({id:"page_0",name:"Imported",widgets:[]}));const i=d.device_id||d.currentLayoutId;if(i){const g=h.currentLayoutId;g!==i&&(_.log(`[loadLayoutIntoState] Updating currentLayoutId: ${g} -> ${i}`),h.setCurrentLayoutId(i))}else _.log(`[loadLayoutIntoState] No device_id in layout, keeping currentLayoutId: ${h.currentLayoutId}`);const n=d.name||d.deviceName;n&&h.setDeviceName(n);const t=d.device_model||d.deviceModel||d.settings?.device_model;t&&h.setDeviceModel(t),d.customHardware&&h.setCustomHardware(d.customHardware);const o=h.getSettings(),s=d.settings||{},r={};["orientation","dark_mode","sleep_enabled","sleep_start_hour","sleep_end_hour","manual_refresh_only","deep_sleep_enabled","deep_sleep_interval","daily_refresh_enabled","daily_refresh_time","no_refresh_start_hour","no_refresh_end_hour","auto_cycle_enabled","auto_cycle_interval_s","refresh_interval","auto_cycle_enabled","auto_cycle_interval_s","refresh_interval","width","height","shape","inverted_colors","renderingMode","lcdEcoStrategy","extendedLatinGlyphs"].forEach(g=>{d[g]!==void 0&&(r[g]=d[g])});const c={...o,...s,...r};n&&(c.device_name=n),t&&(c.device_model=t),c.sleep_enabled===void 0&&(c.sleep_enabled=!1),c.sleep_start_hour===void 0&&(c.sleep_start_hour=0),c.sleep_end_hour===void 0&&(c.sleep_end_hour=5),c.manual_refresh_only===void 0&&(c.manual_refresh_only=!1),c.deep_sleep_enabled===void 0&&(c.deep_sleep_enabled=!1),c.deep_sleep_interval===void 0&&(c.deep_sleep_interval=600),c.daily_refresh_enabled===void 0&&(c.daily_refresh_enabled=!1),c.daily_refresh_time===void 0&&(c.daily_refresh_time="08:00"),c.refresh_interval===void 0&&(c.refresh_interval=600);const a=(window.DEVICE_PROFILES||{})[t];if(a&&a.features){const g=!!a.features.epaper,m=!!(a.features.lvgl||a.features.lv_display);g&&!m&&c.renderingMode==="lvgl"&&(e.some(y=>y.widgets&&y.widgets.some(b=>b.type&&b.type.startsWith("lvgl_")))||(_.log("[loadLayoutIntoState] E-Paper detected without LVGL support and NO LVGL widgets found. Repairing renderingMode: lvgl -> direct"),c.renderingMode="direct"))}h.setPages(e),h.setSettings(c);const u=h.currentPageIndex;u>=0&&u<e.length?h.setCurrentPageIndex(u):h.setCurrentPageIndex(0),_.log(`[loadLayoutIntoState] Layout loaded with ${e.length} pages. Current Layout ID: ${h.currentLayoutId}`),_.log("[loadLayoutIntoState] Power settings after merge:",{daily_refresh_enabled:c.daily_refresh_enabled,daily_refresh_time:c.daily_refresh_time,deep_sleep_enabled:c.deep_sleep_enabled,sleep_enabled:c.sleep_enabled})}let ce=[],tt=!1,Ii=!1,Te=!1;function oe(){const d={"Content-Type":"application/json"},e=Ke();return e&&e.trim()!==""&&e!=="null"&&(d.Authorization=`Bearer ${e}`),d}const dt="entity-datalist-global";let pe=null;function ei(){return pe||(pe=document.getElementById(dt),pe||(pe=document.createElement("datalist"),pe.id=dt,document.body.appendChild(pe))),pe}function Ci(d){const e=ei();e.innerHTML="",!(!d||d.length===0)&&(d.forEach(i=>{const n=document.createElement("option");n.value=i.entity_id,n.label=i.name||i.entity_id,e.appendChild(n)}),_.log(`[EntityDatalist] Updated with ${d.length} entities`))}async function ge(){if(!q())return[];if(tt)return ce;tt=!0;try{const d=new AbortController,e=setTimeout(()=>d.abort(),1e4),i=J.includes("api/esphome_designer")&&!window.location.pathname.includes("esphome-designer");let n,t=!1;const o=Ke();n=`${J}/entities?domains=sensor,binary_sensor,weather,light,switch,fan,cover,climate,media_player,input_number,number,input_boolean,input_text,input_select,button,input_button,scene,script`,_.log("[EntityStates] Fetching from:",n);let s;try{s=await fetch(n,{headers:oe(),signal:d.signal})}catch(l){if(o&&J)n=`${J.replace("/api/esphome_designer","")}/api/states`,_.log("[EntityStates] Custom endpoint failed, trying native HA API:",n),t=!0,s=await fetch(n,{headers:oe(),signal:d.signal});else throw l}if(clearTimeout(e),!s.ok)return _.warn("[EntityStates] Failed to fetch:",s.status),Te=!0,[];let r=await s.json();if(t&&Array.isArray(r)){const l=["sensor","binary_sensor","weather","light","switch","fan","cover","climate","media_player","input_number","number","input_boolean","input_text","input_select","button","input_button","scene","script"];r=r.filter(c=>{const a=c.entity_id?.split(".")[0];return l.includes(a)}).map(c=>({entity_id:c.entity_id,name:c.attributes?.friendly_name||c.entity_id,state:c.state,unit:c.attributes?.unit_of_measurement,attributes:c.attributes||{}}))}return Array.isArray(r)?(_.log(`[EntityStates] Received ${r.length} entities`),ce=r.map(l=>{const c=l.unit?`${l.state} ${l.unit}`:l.state;return{entity_id:l.entity_id,name:l.name||l.entity_id,state:l.state,unit:l.unit,attributes:l.attributes||{},formatted:c}}),Ii=!0,Te=!1,_.log(`[EntityStates] Cached ${ce.length} entity states`),h&&(h.entityStates={},ce.forEach(l=>{h.entityStates[l.entity_id]=l}),_.log(`[EntityStates] Populated AppState.entityStates with ${Object.keys(h.entityStates).length} entries`)),Ci(ce),W(B.ENTITIES_LOADED,ce),ce):(_.warn("[EntityStates] Invalid response format"),Te=!0,[])}catch(d){return d.name==="AbortError"?_.warn("[EntityStates] Request timed out after 10 seconds"):_.warn("[EntityStates] Error fetching:",d),Te=!0,[]}finally{tt=!1}}async function Li(){if(!q()){_.warn("Cannot load layout from backend: No HA backend detected.");return}try{let d=null;try{const n=await fetch(`${J}/layouts`,{headers:oe()});if(n.ok){const t=await n.json();_.log("[loadLayoutFromBackend] Available layouts:",t.layouts?.map(o=>o.id)),_.log(`[loadLayoutFromBackend] Last active layout ID from backend: ${t.last_active_layout_id}`),t.last_active_layout_id&&(t.layouts?.some(s=>s.id===t.last_active_layout_id)?(d=t.last_active_layout_id,_.log(`[loadLayoutFromBackend] Loading last active layout: ${d}`)):_.warn(`[loadLayoutFromBackend] Last active layout '${t.last_active_layout_id}' no longer exists`)),!d&&t.layouts&&t.layouts.length>0&&(d=t.layouts[0].id,_.log(`[loadLayoutFromBackend] No valid last active, using first layout: ${d}`))}}catch(n){_.warn("[loadLayoutFromBackend] Could not fetch layouts list:",n)}let e;if(d?e=await fetch(`${J}/layouts/${d}`,{headers:oe()}):e=await fetch(`${J}/layout`,{headers:oe()}),!e.ok)throw new Error(`Failed to load layout: ${e.status}`);const i=await e.json();!i.device_id&&d&&(i.device_id=d),_.log(`[loadLayoutFromBackend] Loaded layout '${i.device_id||d||"default"}':`,{name:i.name,device_model:i.device_model,pages:i.pages?.length,widgets:i.pages?.reduce((n,t)=>n+(t.widgets?.length||0),0)}),h&&(i.device_id||d)&&h.setCurrentLayoutId(i.device_id||d),typeof le=="function"?le(i):_.error("[loadLayoutFromBackend] loadLayoutIntoState function missing!"),W(B.LAYOUT_IMPORTED,i)}catch(d){_.error("Error loading layout from backend:",d),N(()=>Promise.resolve().then(()=>fi),void 0,import.meta.url).then(e=>e.showToast("Error loading layout from backend",5e3,"error"))}}let it=!1,st=!1;async function Se(){if(!q())return!1;if(it)return st=!0,_.log("[saveLayoutToBackend] Save already in progress, queuing..."),!1;if(!h)throw new Error("AppState not available");const d=h.currentLayoutId||"reterminal_e1001",e=h.settings.device_model||h.deviceModel||"reterminal_e1001",n={...h.getPagesPayload(),device_id:d,name:h.deviceName||"Layout 1",device_model:e,deviceName:h.deviceName||"Layout 1"};it=!0,st=!1;try{_.log(`[saveLayoutToBackend] Saving to layout '${d}':`,{device_model:e,pages:n.pages?.length,widgets:n.pages?.reduce((r,l)=>r+(l.widgets?.length||0),0)});const t=new AbortController,o=setTimeout(()=>t.abort(),1e4),s=await fetch(`${J}/layouts/${d}`,{method:"POST",headers:oe(),body:JSON.stringify(n),signal:t.signal});if(clearTimeout(o),!s.ok){const r=await s.json().catch(()=>({}));throw new Error(r.message||r.error||`Save failed: ${s.status}`)}return _.log(`[saveLayoutToBackend] Layout '${d}' saved successfully`),!0}catch(t){if(t.name==="AbortError")return!0;if(t.message?.includes("Failed to fetch")||t.message?.includes("NetworkError")||t.message?.includes("net::ERR_")||t.message?.includes("ERR_EMPTY_RESPONSE")||t.message?.includes("Load failed"))return!1;throw _.error("Failed to save layout to backend:",t),t}finally{it=!1,st&&setTimeout(()=>{Se().catch(()=>{})},500)}}async function ki(d){if(!q())throw new Error("No backend");const e=await fetch(`${J}/import_snippet`,{method:"POST",headers:oe(),body:JSON.stringify({yaml:d})});if(!e.ok){const i=await e.json().catch(()=>({}));throw new Error(i.message||i.error||`Import failed with status ${e.status}`)}return await e.json()}const Ti=["elecrow-esp32-7inch.yaml","guition-esp32-jc4827w543.yaml","guition-esp32-jc8048w535.yaml","guition-esp32-jc8048w550.yaml","guition-esp32-s3-4848s040.yaml","lilygo-tdisplays3.yaml","sunton-esp32-2432s028.yaml","sunton-esp32-2432s028R.yaml","sunton-esp32-4827s032R.yaml","sunton-esp32-8048s050.yaml","sunton-esp32-8048s070.yaml","waveshare-esp32-s3-touch-lcd-4.3.yaml","waveshare-esp32-s3-touch-lcd-7.yaml","waveshare-esp32-universal-epaper-7.5v2.yaml"];async function Pi(){if(q())try{const e=`${J}/hardware/templates`;_.log("[HardwareDiscovery] Fetching from:",e);const i=await fetch(e,{headers:oe(),cache:"no-store"});if(!i.ok)throw new Error(`HTTP ${i.status}`);return(await i.json()).templates||[]}catch(e){_.error("Failed to fetch dynamic hardware templates from HA:",e)}_.log("[HardwareDiscovery] Attempting to load fallback local profiles...");const d=[];for(const e of Ti)try{const i=await fetch(`hardware/${e}`);if(i.ok){const n=await i.text(),t=ti(n,e);t.id=e.replace(/\.yaml$/i,"").replace(/[^a-z0-9]/gi,"_").toLowerCase(),t.isPackageBased=!0,t.hardwarePackage=`hardware/${e}`,d.push(t)}}catch{}return _.log(`[HardwareDiscovery] Loaded ${d.length} local fallback profiles.`),d}async function Dt(d){if(!q())return _.log("[HardwareImport] Offline mode detected. Parsing locally..."),await Mi(d);const e=new FormData;e.append("file",d);try{const i=`${J}/hardware/upload`,n=oe();delete n["Content-Type"];const t=await fetch(i,{method:"POST",headers:n,body:e}),o=await t.json();if(!t.ok)throw new Error(o.message||o.error||"Upload failed");U("Hardware template uploaded successfully!","success");const{loadExternalProfiles:s}=await N(async()=>{const{loadExternalProfiles:r}=await Promise.resolve().then(()=>ii);return{loadExternalProfiles:r}},void 0,import.meta.url);return s&&await s(),o}catch(i){throw _.error("Hardware upload failed:",i),U(`Upload failed: ${i.message}`,"error"),i}}async function Mi(d){return new Promise((e,i)=>{const n=new FileReader;n.onload=async t=>{const o=t.target.result;try{if(!o.includes("__LAMBDA_PLACEHOLDER__"))throw new Error("Invalid template: Missing __LAMBDA_PLACEHOLDER__");const s=ti(o,d.name);_.log("[HardwareImport] Parsed offline profile:",s);const{DEVICE_PROFILES:r}=await N(async()=>{const{DEVICE_PROFILES:l}=await Promise.resolve().then(()=>ii);return{DEVICE_PROFILES:l}},void 0,import.meta.url);r&&(r[s.id]=s),U(`Imported ${s.name} (Offline Mode)`,"success"),window.app&&window.app.deviceSettings&&window.app.deviceSettings.populateDeviceSelect(),Ai(s),e(s)}catch(s){U(s.message,"error"),i(s)}},n.onerror=()=>i(new Error("File read failed")),n.readAsText(d)})}function ti(d,e){const i="dynamic_offline_"+e.replace(/[^a-z0-9]/gi,"_").toLowerCase();let n=e.replace(/\.yaml$/i,""),t=800,o=480,s="rect";const r=d.match(/#\s*Name:\s*(.*)/i);r&&(n=r[1].trim());const l=d.match(/#\s*Resolution:\s*(\d+)x(\d+)/i);l&&(t=parseInt(l[1]),o=parseInt(l[2]));const c=d.match(/#\s*Shape:\s*(rect|round)/i);c&&(s=c[1].toLowerCase());const u=!!d.match(/#\s*Inverted:\s*(true|yes|1)/i);return{id:i,name:n+" (Local)",resolution:{width:t,height:o},shape:s,isPackageBased:!0,isOfflineImport:!0,content:d,features:{psram:d.includes("psram:"),lcd:!d.includes("waveshare_epaper")&&!d.includes("epaper_spi"),lvgl:d.includes("lvgl:")||!d.includes("waveshare_epaper")&&!d.includes("epaper_spi"),epaper:d.includes("waveshare_epaper")||d.includes("epaper_spi"),touch:d.includes("touchscreen:"),inverted_colors:u}}}function Ai(d){try{const e=JSON.parse(localStorage.getItem("esphome-offline-profiles")||"{}");e[d.id]=d,localStorage.setItem("esphome-offline-profiles",JSON.stringify(e)),_.log("[HardwarePersistence] Saved offline profile to localStorage:",d.id)}catch(e){_.error("Failed to save profile to localStorage:",e)}}function Bi(){try{return JSON.parse(localStorage.getItem("esphome-offline-profiles")||"{}")}catch(d){return _.warn("Could not load offline profiles from storage:",d),{}}}const Re=["reterminal_e1001","reterminal_e1002","trmnl_diy_esp32s3","esp32_s3_photopainter","m5stack_paper","m5stack_coreink","trmnl","waveshare_esp32_s3_touch_lcd_7","waveshare_esp32_s3_touch_lcd_4_3"],G={reterminal_e1001:{name:"Seeedstudio reTerminal E1001 (Monochrome)",displayType:"binary",chip:"esp32-s3",board:"esp32-s3-devkitc-1",displayModel:"7.50inv2p",displayPlatform:"waveshare_epaper",resolution:{width:800,height:480},shape:"rect",psram_mode:"octal",pins:{display:{cs:"GPIO10",dc:"GPIO11",reset:{number:"GPIO12",inverted:!1},busy:{number:"GPIO13",inverted:!0}},i2c:{sda:"GPIO19",scl:"GPIO20"},spi:{clk:"GPIO7",mosi:"GPIO9"},batteryEnable:"GPIO21",batteryAdc:"GPIO1",buzzer:"GPIO45",buttons:{left:"GPIO5",right:"GPIO4",refresh:"GPIO3",home:"GPIO2"}},battery:{attenuation:"12db",multiplier:2,calibration:{min:3.27,max:4.15}},features:{psram:!0,buzzer:!0,buttons:!0,sht4x:!0,epaper:!0,inverted_colors:!0}},reterminal_e1002:{name:"Seeedstudio reTerminal E1002 (6-Color)",displayType:"color",displayModel:"Seeed-reTerminal-E1002",displayPlatform:"epaper_spi",resolution:{width:800,height:480},shape:"rect",psram_mode:"octal",pins:{display:{cs:null,dc:null,reset:null,busy:null},i2c:{sda:"GPIO19",scl:"GPIO20"},spi:{clk:"GPIO7",mosi:"GPIO9"},batteryEnable:"GPIO21",batteryAdc:"GPIO1",buzzer:"GPIO45",buttons:{left:"GPIO5",right:"GPIO4",refresh:"GPIO3",home:"GPIO2"}},battery:{attenuation:"12db",multiplier:2,calibration:{min:3.27,max:4.15}},features:{psram:!0,buzzer:!0,buttons:!0,sht4x:!0,epaper:!0}},trmnl_diy_esp32s3:{name:"Seeed Studio Trmnl DIY Kit (ESP32-S3)",displayType:"binary",displayModel:"7.50inv2p",displayPlatform:"waveshare_epaper",resolution:{width:800,height:480},shape:"rect",psram_mode:"octal",pins:{display:{cs:"GPIO44",dc:"GPIO10",reset:"GPIO38",busy:{number:"GPIO4",inverted:!0}},i2c:{sda:"GPIO17",scl:"GPIO18"},spi:{clk:"GPIO7",mosi:"GPIO9"},batteryEnable:"GPIO6",batteryAdc:"GPIO1",buzzer:null,buttons:{left:"GPIO2",refresh:"GPIO5"}},battery:{attenuation:"12db",multiplier:2,calibration:{min:3.27,max:4.15},curve:[{from:4.15,to:100},{from:3.96,to:90},{from:3.91,to:80},{from:3.85,to:70},{from:3.8,to:60},{from:3.75,to:50},{from:3.68,to:40},{from:3.58,to:30},{from:3.49,to:20},{from:3.41,to:10},{from:3.3,to:5},{from:3.27,to:0}]},features:{psram:!0,buzzer:!1,buttons:!0,sht4x:!1,epaper:!0,inverted_colors:!0}},trmnl:{name:"TRMNL (ESP32-C3)",displayType:"binary",displayModel:"7.50inv2",displayPlatform:"waveshare_epaper",resolution:{width:800,height:480},shape:"rect",pins:{display:{cs:"GPIO6",dc:"GPIO5",reset:{number:"GPIO10",inverted:!1},busy:{number:"GPIO4",inverted:!0}},i2c:{sda:"GPIO1",scl:"GPIO2"},spi:{clk:"GPIO7",mosi:"GPIO8"},batteryEnable:null,batteryAdc:"GPIO0",buzzer:null,buttons:null},battery:{attenuation:"12db",multiplier:2,calibration:{min:3.3,max:4.15}},features:{psram:!1,buzzer:!1,buttons:!1,sht4x:!1,epaper:!0,inverted_colors:!0}},esp32_s3_photopainter:{name:"Waveshare PhotoPainter (6-Color)",displayType:"color",displayModel:"7.30in-f",displayPlatform:"waveshare_epaper",resolution:{width:800,height:480},shape:"rect",psram_mode:"octal",pins:{display:{cs:"GPIO9",dc:"GPIO8",reset:"GPIO12",busy:{number:"GPIO13",inverted:!0}},i2c:{sda:"GPIO47",scl:"GPIO48"},spi:{clk:"GPIO10",mosi:"GPIO11"},batteryEnable:null,batteryAdc:null,buzzer:null,buttons:{left:"GPIO0",right:"GPIO4",refresh:null}},battery:{attenuation:"0db",multiplier:1,calibration:{min:3.3,max:4.2}},features:{psram:!0,buzzer:!1,buttons:!0,sht4x:!1,axp2101:!0,manual_pmic:!0,shtc3:!0,epaper:!0},i2c_config:{scan:!1,frequency:"10kHz"}},waveshare_esp32_s3_touch_lcd_7:{name:'Waveshare Touch LCD 7 7.0" 800x480',displayType:"color",isPackageBased:!0,hardwarePackage:"hardware/waveshare-esp32-s3-touch-lcd-7.yaml",resolution:{width:800,height:480},features:{psram:!0,buzzer:!1,buttons:!1,lcd:!0,lvgl:!0,touch:!0}},waveshare_esp32_s3_touch_lcd_4_3:{name:'Waveshare Touch LCD 4.3 4.3" 800x480',displayType:"color",isPackageBased:!0,hardwarePackage:"hardware/waveshare-esp32-s3-touch-lcd-4.3.yaml",resolution:{width:800,height:480},features:{psram:!0,buzzer:!1,buttons:!1,lcd:!0,touch:!0}},m5stack_coreink:{name:"M5Stack M5Core Ink (200x200)",displayType:"binary",displayModel:"1.54inv2",displayPlatform:"waveshare_epaper",resolution:{width:200,height:200},shape:"rect",features:{psram:!1,buzzer:!0,buttons:!0,lcd:!1,epaper:!0,inverted_colors:!0},pins:{display:{cs:"GPIO9",dc:"GPIO15",reset:"GPIO0",busy:null},i2c:{sda:"GPIO21",scl:"GPIO22"},spi:{clk:"GPIO18",mosi:"GPIO23"},batteryEnable:{number:"GPIO12",ignore_strapping_warning:!0},batteryAdc:"GPIO35",buzzer:"GPIO2",buttons:{left:{number:"GPIO39",mode:"INPUT"},right:{number:"GPIO37",mode:"INPUT"},refresh:{number:"GPIO38",mode:"INPUT"}}},battery:{attenuation:"12db",multiplier:2,calibration:{min:3.27,max:4.15}},i2c_config:{scan:!0}},m5stack_paper:{name:"M5Paper (540x960)",displayType:"grayscale",displayModel:"M5Paper",displayPlatform:"it8951e",resolution:{width:960,height:540},shape:"rect",features:{psram:!0,buzzer:!1,buttons:!0,lcd:!1,epaper:!0,touch:!0,inverted_colors:!0,sht3xd:!0},pins:{display:{cs:"GPIO15",dc:null,reset:"GPIO23",busy:"GPIO27"},i2c:{sda:"GPIO21",scl:"GPIO22"},spi:{clk:"GPIO14",mosi:"GPIO12",miso:"GPIO13"},batteryEnable:null,batteryAdc:"GPIO35",buzzer:null,buttons:{left:{number:"GPIO39",mode:"INPUT"},right:{number:"GPIO37",mode:"INPUT"},refresh:{number:"GPIO38",mode:"INPUT"}}},m5paper:{battery_power_pin:"GPIO5",main_power_pin:"GPIO2"},battery:{attenuation:"12db",multiplier:2,calibration:{min:3.27,max:4.15}},rotation_offset:180,touch:{platform:"gt911",i2c_id:"bus_a",address:93,interrupt_pin:"GPIO36",update_interval:"never",transform:{mirror_x:!1,mirror_y:!1,swap_xy:!0},calibration:{x_min:0,x_max:960,y_min:0,y_max:540}},external_components:["  - source: github://Passific/m5paper_esphome"]}};async function ct(){try{const d=await Pi();_.log(`[Devices] Loaded ${d.length} dynamic hardware templates.`),d.forEach(n=>{if(G[n.id]){const t=G[n.id];G[n.id]={...t,...n,features:{...t.features||{},...n.features||{}}}}else G[n.id]=n});const e=Bi(),i=Object.keys(e);i.length>0&&(_.log(`[Devices] Restoring ${i.length} offline profiles from localStorage.`),Object.entries(e).forEach(([n,t])=>{G[n]=t})),window.app&&window.app.deviceSettings&&typeof window.app.deviceSettings.populateDeviceSelect=="function"&&window.app.deviceSettings.populateDeviceSelect()}catch(d){_.error("Failed to load external hardware profiles:",d)}}const ii=Object.freeze(Object.defineProperty({__proto__:null,DEVICE_PROFILES:G,SUPPORTED_DEVICE_IDS:Re,loadExternalProfiles:ct},Symbol.toStringTag,{value:"Module"}));function Ie(){return window.currentDeviceModel||"reterminal_e1001"}function Di(d){if(G&&G[d])return G[d].name;switch(d){case"reterminal_e1002":return"reTerminal E1002 (6-Color)";case"esp32_s3_photopainter":return"Waveshare PhotoPainter (7-Color)";case"trmnl":return"Official TRMNL (ESP32-C3)";case"reterminal_e1001":default:return"reTerminal E1001 (Monochrome)"}}function si(){const d=Ie();return!!(G&&G[d]&&(G[d].features?.lcd||G[d].features?.oled))}function ni(){if(si())return["black","white","red","green","blue","yellow","orange","gray","purple","cyan","magenta"];const d=Ie();return d==="reterminal_e1002"?["black","white","gray","red","green","blue","yellow"]:d==="esp32_s3_photopainter"?["black","white","gray","red","green","blue","yellow","orange"]:["black","white","gray"]}function Lt(d){if(!d)return"#000000";if(d.startsWith("#"))return d;if(d.startsWith("0x"))return"#"+d.substring(2);switch(d.toLowerCase()){case"white":return"#ffffff";case"red":return"#ff0000";case"green":return"#00ff00";case"blue":return"#0000ff";case"yellow":return"#ffff00";case"orange":return"#ffa500";case"gray":return"#a0a0a0";case"black":default:return"#000000"}}window.getDeviceModel=Ie;window.getDeviceDisplayName=Di;window.isRGBDevice=si;window.getAvailableColors=ni;window.getColorStyle=Lt;function Ri(d){if(!d)return 3600;const e=d.match(/^(\d+)([a-z]+)$/i);if(!e)return 3600;const i=parseInt(e[1],10),n=e[2].toLowerCase();return n.startsWith("s")?i:n.startsWith("m")?i*60:n.startsWith("h")?i*3600:n.startsWith("d")?i*86400:i}function Ts(d,e,i,n){const t=[];for(let s=0;s<50;s++){const r=s/49*d,l=s/50,c=Math.sin(l*Math.PI*2),a=(Math.random()-.5)*.2;let u=.5+c*.3+a;u=Math.max(.1,Math.min(.9,u));const g=e-u*e;t.push({x:r,y:g})}return t}function Ps(d,e,i,n,t){const o=document.createElementNS("http://www.w3.org/2000/svg","g");o.setAttribute("stroke","rgba(0,0,0,0.1)"),o.setAttribute("stroke-dasharray","2,2"),o.setAttribute("stroke-width","1");const s=4,r=4;for(let l=1;l<s;l++){const c=l/s*e,a=document.createElementNS("http://www.w3.org/2000/svg","line");a.setAttribute("x1",c),a.setAttribute("y1",0),a.setAttribute("x2",c),a.setAttribute("y2",i),o.appendChild(a)}for(let l=1;l<r;l++){const c=l/r*i,a=document.createElementNS("http://www.w3.org/2000/svg","line");a.setAttribute("x1",0),a.setAttribute("y1",c),a.setAttribute("x2",e),a.setAttribute("y2",c),o.appendChild(a)}d.appendChild(o)}function Ms(d,e,i,n,t,o,s,r){d.querySelectorAll(".graph-axis-label").forEach(f=>f.remove());const c=s-o,a=4,u=typeof CANVAS_WIDTH<"u"?CANVAS_WIDTH:typeof window.CANVAS_WIDTH<"u"?window.CANVAS_WIDTH:800;for(let f=0;f<=a;f++){const y=o+c*(f/a),b=i+t-f/a*t,w=document.createElement("div");w.className="graph-axis-label",w.style.position="absolute",w.style.right=`${u-e+4}px`,w.style.top=`${b-6}px`,w.style.fontSize="10px",w.style.color="#666",w.style.textAlign="right",w.textContent=y.toFixed(1),d.appendChild(w)}const g=Ri(r),m=2;for(let f=0;f<=m;f++){const y=f/m,b=e+n*y;let w="";if(f===m)w="Now";else{const T=g*(1-y);T>=3600?w=`-${(T/3600).toFixed(1)}h`:T>=60?w=`-${(T/60).toFixed(0)}m`:w=`-${T.toFixed(0)}s`}const S=document.createElement("div");S.className="graph-axis-label",S.style.position="absolute",S.style.left=`${b}px`,S.style.top=`${i+t+4}px`,S.style.fontSize="10px",S.style.color="#666",S.style.transform="translateX(-50%)",S.textContent=w,d.appendChild(S)}}const K={getColorConst:d=>{if(!d)return"COLOR_BLACK";const e=d.toLowerCase();if(e.startsWith("#")&&e.length===7){const i=parseInt(e.substring(1,3),16),n=parseInt(e.substring(3,5),16),t=parseInt(e.substring(5,7),16);return`Color(${i}, ${n}, ${t})`}return St[e]||"COLOR_BLACK"},getAlignX:(d,e,i)=>d.includes("LEFT")?`${e}`:d.includes("RIGHT")?`${e} + ${i}`:`${e} + ${i}/2`,getAlignY:(d,e,i)=>d.includes("TOP")?`${e}`:d.includes("BOTTOM")?`${e} + ${i}`:`${e} + ${i}/2`,sanitize:d=>d?d.replace(/"/g,'\\"'):"",addDitherMask:(d,e,i,n,t,o,s,r=0)=>{if(!i||!e)return;const l=e.toLowerCase();let c=l==="gray"||l==="grey";if(!c&&l.startsWith("#")&&l.length===7){const a=parseInt(l.substring(1,3),16),u=parseInt(l.substring(3,5),16),g=parseInt(l.substring(5,7),16);Math.abs(a-u)<15&&Math.abs(u-g)<15&&a>40&&a<210&&(c=!0)}c&&d.push(`          apply_grey_dither_mask(${Math.round(n)}, ${Math.round(t)}, ${Math.round(o)}, ${Math.round(s)}, ${Math.round(r)});`)},isGrayColor:d=>{if(!d)return!1;const e=d.toLowerCase();if(e==="gray"||e==="grey")return!0;if(e.startsWith("#")&&e.length===7){const i=parseInt(e.substring(1,3),16),n=parseInt(e.substring(3,5),16),t=parseInt(e.substring(5,7),16);if(Math.abs(i-n)<15&&Math.abs(n-t)<15&&i>40&&i<210)return!0}return!1},addDitherMaskForText:(d,e,i,n,t,o,s)=>!i||!K.isGrayColor(e)?!1:(d.push(`        apply_grey_dither_to_text(${Math.round(n)}, ${Math.round(t)}, ${Math.round(o)}, ${Math.round(s)});`),!0),getIconCode:d=>{if(!d||!window.iconPickerData)return null;const e=window.iconPickerData.find(i=>i.name===d);return e?e.code:null}};window.Utils=K;window.ESPHomeDesigner=window.ESPHomeDesigner||{};window.ESPHomeDesigner.utils=K;const oi=[{code:"F0004",name:"account"},{code:"F0026",name:"alert"},{code:"F0028",name:"alert-circle"},{code:"F0045",name:"arrow-down"},{code:"F004D",name:"arrow-left"},{code:"F0054",name:"arrow-right"},{code:"F005D",name:"arrow-up"},{code:"F0079",name:"battery"},{code:"F007C",name:"battery-50"},{code:"F0084",name:"battery-charging"},{code:"F009A",name:"bell"},{code:"F00AF",name:"bluetooth"},{code:"F00D8",name:"brightness-5"},{code:"F00ED",name:"calendar"},{code:"F0100",name:"camera"},{code:"F012C",name:"check"},{code:"F05E0",name:"check-circle"},{code:"F0140",name:"chevron-down"},{code:"F0141",name:"chevron-left"},{code:"F0142",name:"chevron-right"},{code:"F0143",name:"chevron-up"},{code:"F0150",name:"clock"},{code:"F0156",name:"close"},{code:"F015F",name:"cloud"},{code:"F0493",name:"cog"},{code:"F01B4",name:"delete"},{code:"F01D9",name:"dots-vertical"},{code:"F01DA",name:"download"},{code:"F01EE",name:"email"},{code:"F0208",name:"eye"},{code:"F0209",name:"eye-off"},{code:"F0210",name:"fan"},{code:"F0214",name:"file"},{code:"F021E",name:"flash"},{code:"F024B",name:"folder"},{code:"F0279",name:"format-list-bulleted"},{code:"F02D1",name:"heart"},{code:"F02DC",name:"home"},{code:"F07D0",name:"home-assistant"},{code:"F02E9",name:"image"},{code:"F02FC",name:"information"},{code:"F0322",name:"layers"},{code:"F0335",name:"lightbulb"},{code:"F06E8",name:"lightbulb-on"},{code:"F033E",name:"lock"},{code:"F033F",name:"lock-open"},{code:"F0349",name:"magnify"},{code:"F034E",name:"map-marker"},{code:"F035C",name:"menu"},{code:"F036C",name:"microphone"},{code:"F0374",name:"minus"},{code:"F075A",name:"music"},{code:"F03EB",name:"pencil"},{code:"F040A",name:"play"},{code:"F0415",name:"plus"},{code:"F0425",name:"power"},{code:"F0450",name:"refresh"},{code:"F048A",name:"send"},{code:"F0497",name:"share-variant"},{code:"F0565",name:"shield-check"},{code:"F04CE",name:"star"},{code:"F04DB",name:"stop"},{code:"F050F",name:"thermometer"},{code:"F0513",name:"thumb-up"},{code:"F051B",name:"timer-outline"},{code:"F0A79",name:"trash-can"},{code:"F0552",name:"upload"},{code:"F0571",name:"video"},{code:"F057E",name:"volume-high"},{code:"F0581",name:"volume-off"},{code:"F0585",name:"water"},{code:"F05E3",name:"water-percent"},{code:"F0590",name:"weather-cloudy"},{code:"F0591",name:"weather-fog"},{code:"F0592",name:"weather-hail"},{code:"F0593",name:"weather-lightning"},{code:"F0594",name:"weather-night"},{code:"F0595",name:"weather-partly-cloudy"},{code:"F0596",name:"weather-pouring"},{code:"F0597",name:"weather-rainy"},{code:"F0598",name:"weather-snowy"},{code:"F0599",name:"weather-sunny"},{code:"F059D",name:"weather-windy"},{code:"F05A9",name:"wifi"},{code:"F05AD",name:"window-close"}],Rt=typeof import.meta.glob=="function"?Object.assign({"../../features/battery_icon/plugin.js":()=>N(()=>import("./plugin-Bnm7TpR-.js"),[],import.meta.url),"../../features/calendar/plugin.js":()=>N(()=>import("./plugin-KeAjb8Za.js"),[],import.meta.url),"../../features/datetime/plugin.js":()=>N(()=>import("./plugin-cmnEGYTT.js"),[],import.meta.url),"../../features/graph/plugin.js":()=>N(()=>import("./plugin-CX4Wy_3l.js"),[],import.meta.url),"../../features/icon/plugin.js":()=>N(()=>import("./plugin-CJ1qVVh0.js"),[],import.meta.url),"../../features/image/plugin.js":()=>N(()=>import("./plugin-C4YqxiVZ.js"),[],import.meta.url),"../../features/line/plugin.js":()=>N(()=>import("./plugin-CwLUHNuJ.js"),[],import.meta.url),"../../features/lvgl_arc/plugin.js":()=>N(()=>import("./plugin-JeawKOBF.js"),[],import.meta.url),"../../features/lvgl_bar/plugin.js":()=>N(()=>import("./plugin-DbLnvUdU.js"),[],import.meta.url),"../../features/lvgl_button/plugin.js":()=>N(()=>import("./plugin-BQlK-sSj.js"),[],import.meta.url),"../../features/lvgl_buttonmatrix/plugin.js":()=>N(()=>import("./plugin-DJJBIUVn.js"),[],import.meta.url),"../../features/lvgl_chart/plugin.js":()=>N(()=>import("./plugin-DBkyZgmB.js"),[],import.meta.url),"../../features/lvgl_checkbox/plugin.js":()=>N(()=>import("./plugin-BLLmkpKs.js"),[],import.meta.url),"../../features/lvgl_dropdown/plugin.js":()=>N(()=>import("./plugin-BASqPqZZ.js"),[],import.meta.url),"../../features/lvgl_img/plugin.js":()=>N(()=>import("./plugin-89YElWur.js"),[],import.meta.url),"../../features/lvgl_keyboard/plugin.js":()=>N(()=>import("./plugin-DeB-lHQz.js"),[],import.meta.url),"../../features/lvgl_label/plugin.js":()=>N(()=>import("./plugin-Buv4FyHf.js"),[],import.meta.url),"../../features/lvgl_led/plugin.js":()=>N(()=>import("./plugin-DhQy58ex.js"),[],import.meta.url),"../../features/lvgl_line/plugin.js":()=>N(()=>import("./plugin-Drklb84p.js"),[],import.meta.url),"../../features/lvgl_meter/plugin.js":()=>N(()=>import("./plugin-Ddxk4ROY.js"),[],import.meta.url),"../../features/lvgl_obj/plugin.js":()=>N(()=>import("./plugin-C9NtUHZv.js"),[],import.meta.url),"../../features/lvgl_qrcode/plugin.js":()=>N(()=>import("./plugin-TE63bYc8.js"),[],import.meta.url),"../../features/lvgl_roller/plugin.js":()=>N(()=>import("./plugin-CvtWvIYB.js"),[],import.meta.url),"../../features/lvgl_slider/plugin.js":()=>N(()=>import("./plugin-CAk77t2m.js"),[],import.meta.url),"../../features/lvgl_spinbox/plugin.js":()=>N(()=>import("./plugin-DNQHeoO9.js"),[],import.meta.url),"../../features/lvgl_spinner/plugin.js":()=>N(()=>import("./plugin-Ck_yh4qJ.js"),[],import.meta.url),"../../features/lvgl_switch/plugin.js":()=>N(()=>import("./plugin-CWeiiLg4.js"),[],import.meta.url),"../../features/lvgl_tabview/plugin.js":()=>N(()=>import("./plugin-BToZq9GB.js"),[],import.meta.url),"../../features/lvgl_textarea/plugin.js":()=>N(()=>import("./plugin-BE3ZZhsJ.js"),[],import.meta.url),"../../features/lvgl_tileview/plugin.js":()=>N(()=>import("./plugin-eSvwYPfG.js"),[],import.meta.url),"../../features/ondevice_humidity/plugin.js":()=>N(()=>import("./plugin-9crfYiKD.js"),[],import.meta.url),"../../features/ondevice_temperature/plugin.js":()=>N(()=>import("./plugin-BveszIVu.js"),[],import.meta.url),"../../features/online_image/plugin.js":()=>N(()=>import("./plugin-CbsIhniV.js"),[],import.meta.url),"../../features/progress_bar/plugin.js":()=>N(()=>import("./plugin-DKKhgw8V.js"),[],import.meta.url),"../../features/qr_code/plugin.js":()=>N(()=>import("./plugin-5FN-PdZb.js"),[],import.meta.url),"../../features/quote_rss/plugin.js":()=>N(()=>import("./plugin-DLOREUXQ.js"),[],import.meta.url),"../../features/rounded_rect/plugin.js":()=>N(()=>import("./plugin-CfxFPOa3.js"),[],import.meta.url),"../../features/sensor_text/plugin.js":()=>N(()=>import("./plugin-C8WxlQyw.js"),[],import.meta.url),"../../features/shape_circle/plugin.js":()=>N(()=>import("./plugin-Z8_Jynrv.js"),[],import.meta.url),"../../features/shape_rect/plugin.js":()=>N(()=>import("./plugin-DhFGWrnD.js"),[],import.meta.url),"../../features/template_nav_bar/plugin.js":()=>N(()=>import("./plugin-C3Qm4N4_.js"),[],import.meta.url),"../../features/template_sensor_bar/plugin.js":()=>N(()=>import("./plugin-Dr3W49j-.js"),[],import.meta.url),"../../features/text/plugin.js":()=>N(()=>import("./plugin-BP87zLmu.js"),[],import.meta.url),"../../features/touch_area/plugin.js":()=>N(()=>import("./plugin-BokcJ6ld.js"),[],import.meta.url),"../../features/weather_forecast/plugin.js":()=>N(()=>import("./plugin-EaAUcZQv.js"),[],import.meta.url),"../../features/weather_icon/plugin.js":()=>N(()=>import("./plugin-BMs_S8mm.js"),[],import.meta.url),"../../features/wifi_signal/plugin.js":()=>N(()=>import("./plugin-D_sDDMNQ.js"),[],import.meta.url)}):{};class Oi{constructor(){this.plugins=new Map,this.loading=new Map,this.aliases={label:"text",rectangle:"shape_rect",rrect:"rounded_rect",circle:"shape_circle",nav_next_page:"touch_area",nav_previous_page:"touch_area",nav_reload_page:"touch_area",puppet:"online_image"}}register(e){if(!e||!e.id){_.warn("[Registry] Invalid plugin registration attempt:",e);return}const i=e.id,n=this.plugins.get(i)||{};this.plugins.set(i,{...n,...e}),_.log(`[Registry] Registered: ${i}`)}get(e){const i=this.aliases[e]||e;return this.plugins.get(i)}getAll(){return Array.from(this.plugins.values())}async load(e){const i=this.aliases[e]||e;if(i==="group")return null;if(this.plugins.has(i))return this.plugins.get(i);if(this.loading.has(i))return this.loading.get(i);const n=(async()=>{try{const t=`../../features/${i}/plugin.js`;let o;return Rt[t]?o=await Rt[t]():(_.log(`[Registry] Using dynamic import fallback for: ${i}`),o=await import(t)),o.default?this.register(o.default):this.register({id:i,...o}),this.loading.delete(i),this.plugins.get(i)}catch(t){return _.error(`[Registry] Failed to load plugin "${i}" from ESM:`,t),this.loading.delete(i),null}})();return this.loading.set(i,n),n}onExportGlobals(e){this.getAll().forEach(i=>i.onExportGlobals&&i.onExportGlobals(e))}onExportNumericSensors(e){this.getAll().forEach(i=>i.onExportNumericSensors&&i.onExportNumericSensors(e))}onExportTextSensors(e){this.getAll().forEach(i=>i.onExportTextSensors&&i.onExportTextSensors(e))}onExportBinarySensors(e){this.getAll().forEach(i=>i.onExportBinarySensors&&i.onExportBinarySensors(e))}onExportHelpers(e){this.getAll().forEach(i=>i.onExportHelpers&&i.onExportHelpers(e))}onExportComponents(e){this.getAll().forEach(i=>i.onExportComponents&&i.onExportComponents(e))}onCollectRequirements(e){this.getAll().forEach(i=>i.collectRequirements&&i.collectRequirements(e))}}const V=new Oi;window.PluginRegistry=V;window.FeatureRegistry=V;_.log("[Registry] Modular system ready.");let Qe=class he{static getEffectiveDarkMode(){const i=h?.getCurrentPage?.()?.dark_mode;return i==="dark"?!0:i==="light"?!1:!!(h&&h.settings&&h.settings.dark_mode)}static getDefaultColor(){return he.getEffectiveDarkMode()?"white":"black"}static getDefaultBgColor(){return he.getEffectiveDarkMode()?"black":"white"}static getGridCellDefaults(){return{grid_cell_row_pos:null,grid_cell_column_pos:null,grid_cell_row_span:1,grid_cell_column_span:1,grid_cell_x_align:"STRETCH",grid_cell_y_align:"STRETCH"}}static isLvglWidget(e){return e&&e.startsWith("lvgl_")}static createWidget(e){const i=Ee(),n=he.getDefaultColor(),t=he.getDefaultBgColor();let o={id:i,type:e,x:40,y:40,width:120,height:40,title:"",entity_id:"",locked:!1,props:{}};switch(e){case"nav_next_page":return o.props={title:"Next",color:"rgba(0, 128, 255, 0.2)",border_color:"#0080ff",nav_action:"next_page",icon:"F0142",icon_size:48},o.width=80,o.height=80,o;case"nav_previous_page":return o.props={title:"Previous",color:"rgba(0, 128, 255, 0.2)",border_color:"#0080ff",nav_action:"previous_page",icon:"F0141",icon_size:48},o.width=80,o.height=80,o;case"nav_reload_page":return o.props={title:"Reload",color:"rgba(0, 128, 255, 0.2)",border_color:"#0080ff",nav_action:"reload_page",icon:"F0450",icon_size:48},o.width=80,o.height=80,o}const s=V.get(e);return s&&s.defaults?(o.props={...s.defaults},(o.props.color==="black"||o.props.color==="white")&&(o.props.color=n),(o.props.bg_color==="black"||o.props.bg_color==="white")&&(o.props.bg_color=t),(o.props.background_color==="black"||o.props.background_color==="white")&&(o.props.background_color=t),(o.props.border_color==="black"||o.props.border_color==="white")&&(o.props.border_color=n),s.width&&(o.width=s.width),s.height&&(o.height=s.height),s.defaults.width&&(o.width=s.defaults.width),s.defaults.height&&(o.height=s.defaults.height),s.defaults.w&&(o.width=s.defaults.w),s.defaults.h&&(o.height=s.defaults.h),o):(he.isLvglWidget(e)&&(o.props={...he.getGridCellDefaults(),...o.props}),o)}};window.WidgetFactory=Qe;class Wi{constructor(){_.log("Sidebar: Constructor called"),this.pageListEl=document.getElementById("pageList"),this.pagesHeader=document.getElementById("pagesHeader"),this.pagesContent=document.getElementById("pagesContent"),this.widgetPaletteEl=document.getElementById("widgetPalette"),_.log("Sidebar: widgetPaletteEl found?",!!this.widgetPaletteEl),this.widgetPaletteEl||_.error("Sidebar: widgetPalette element not found!"),this.addPageBtn=document.getElementById("addPageBtn"),this.currentPageNameEl=document.getElementById("currentPageName"),this.hoverTimeout=null,this.hoveredPageIndex=-1}init(){_.log("Sidebar: init called");const e=document.getElementById("debug-overlay");e&&(e.innerHTML+="Sidebar.init called<br>"),Q(B.STATE_CHANGED,()=>this.render()),Q(B.PAGE_CHANGED,()=>this.render()),this.pagesHeader&&this.pagesContent&&this.pagesHeader.addEventListener("click",()=>{const t=this.pagesContent.classList.toggle("hidden"),o=this.pagesHeader.querySelector(".chevron");o&&(o.style.transform=t?"rotate(-90deg)":"rotate(0deg)")}),this.addPageBtn&&this.addPageBtn.addEventListener("click",()=>this.handleAddPage()),this.widgetPaletteEl&&(this.widgetPaletteEl.addEventListener("click",t=>this.handlePaletteClick(t)),this.widgetPaletteEl.addEventListener("dragstart",t=>{const o=t.target.closest(".item[data-widget-type]");if(o){const s=o.getAttribute("data-widget-type");_.log("[Sidebar] Drag start:",s),t.dataTransfer.setData("application/widget-type",s),t.dataTransfer.effectAllowed="copy"}})),document.addEventListener("click",t=>{const o=document.getElementById("debug-overlay");o&&(o.innerHTML+="Global click: "+t.target.tagName+"<br>")});const i=document.getElementById("clearAllBtn");i&&i.addEventListener("click",()=>this.handleClearPage());const n=document.getElementById("quickSearchBtn");n&&n.addEventListener("click",t=>{t.stopPropagation(),window.QuickSearch?window.QuickSearch.open():_.warn("Sidebar: QuickSearch instance not found on window")}),this.setupMobileToggles(),this.render()}render(){if(!this.pageListEl)return;this.pageListEl.innerHTML="";const e=h.pages,i=h.currentPageIndex;if(e.forEach((n,t)=>{const o=document.createElement("div");o.className="item"+(t===i?" active":""),o.draggable=!0,o.ondragstart=a=>{a.dataTransfer.setData("text/plain",t),a.dataTransfer.effectAllowed="move",o.style.opacity="0.5"},o.ondragend=()=>{o.style.opacity="1",Array.from(this.pageListEl.children).forEach(a=>{a.style.borderTop="",a.style.borderBottom=""})},o.ondragover=a=>{a.preventDefault();const u=a.dataTransfer.types.includes("application/widget-id"),g=a.dataTransfer.types.includes("application/widget-type");if(u||g){a.dataTransfer.dropEffect=u?"move":"copy",o.style.backgroundColor="var(--primary-subtle)",h.currentPageIndex!==t&&h.setCurrentPageIndex(t);return}const m=o.getBoundingClientRect(),f=m.top+m.height/2;a.clientY<f?(o.style.borderTop="2px solid var(--primary)",o.style.borderBottom=""):(o.style.borderTop="",o.style.borderBottom="2px solid var(--primary)")},o.ondragleave=a=>{const u=a.relatedTarget;o.contains(u)||this.hoveredPageIndex===t&&(this.hoverTimeout&&(clearTimeout(this.hoverTimeout),this.hoverTimeout=null),this.hoveredPageIndex=-1),o.style.borderTop="",o.style.borderBottom="",o.style.backgroundColor=""},o.ondrop=a=>{a.preventDefault(),this.hoverTimeout&&(clearTimeout(this.hoverTimeout),this.hoverTimeout=null),this.hoveredPageIndex=-1,o.style.borderTop="",o.style.borderBottom="",o.style.backgroundColor="";const u=a.dataTransfer.getData("application/widget-id");if(_.log(`[Sidebar] Drop detected on page ${t}. Widget ID:`,u),u){const f=t;f!==h.currentPageIndex&&(h.moveWidgetToPage(u,f),_.log(`[Sidebar] Moved widget ${u} to page ${f}`));return}const g=parseInt(a.dataTransfer.getData("text/plain"),10),m=t;this.handlePageReorder(g,m,a.clientY,o)},o.onclick=()=>{h.setCurrentPageIndex(t)};const s=document.createElement("span");s.className="item-icon",s.innerHTML=`<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="3" y1="9" x2="21" y2="9"></line>
                <line x1="9" y1="21" x2="9" y2="9"></line>
            </svg>`,o.appendChild(s);const r=document.createElement("span");r.className="label",r.textContent=n.name,o.appendChild(r);const l=document.createElement("div");l.style.marginLeft="auto",l.style.display="flex",l.style.gap="2px";const c=document.createElement("button");if(c.textContent="â",c.className="btn btn-secondary",c.style.padding="1px 4px",c.style.fontSize="8px",c.onclick=a=>{a.stopPropagation(),this.openPageSettings(t)},l.appendChild(c),e.length>1){const a=document.createElement("button");a.textContent="â",a.className="btn btn-secondary",a.style.padding="1px 4px",a.style.fontSize="8px",a.style.color="var(--danger)",a.onclick=u=>{u.stopPropagation(),this.handlePageDelete(t,n)},l.appendChild(a)}o.appendChild(l),this.pageListEl.appendChild(o)}),this.currentPageNameEl){const n=h.getCurrentPage();this.currentPageNameEl.textContent=n?n.name:"None"}}handleAddPage(){h.addPage()}handlePageReorder(e,i,n,t){if(e===i)return;const o=t.getBoundingClientRect(),s=o.top+o.height/2;let r=i;n>=s&&r++,e<r&&r--,e!==r&&h.reorderPage(e,r)}handlePaletteClick(e){const i=document.getElementById("debug-overlay");i&&(i.innerHTML+="handlePaletteClick triggered<br>"),_.log("Sidebar: handlePaletteClick",e.target);const n=e.target.closest(".item[data-widget-type]");if(!n){_.log("Sidebar: No item found"),i&&(i.innerHTML+="No item found<br>");return}const t=n.getAttribute("data-widget-type");_.log("Sidebar: Creating widget of type",t),i&&(i.innerHTML+="Creating widget: "+t+"<br>");try{const o=Qe.createWidget(t);_.log("Sidebar: Widget created",o),i&&(i.innerHTML+="Widget created<br>"),h.addWidget(o),_.log("Sidebar: Widget added to state"),i&&(i.innerHTML+="Widget added to state<br>")}catch(o){_.error("Sidebar: Error creating/adding widget",o),i&&(i.innerHTML+="Error: "+o.message+"<br>")}}openPageSettings(e){if(window.app&&window.app.pageSettings)window.app.pageSettings.open(e);else{_.error("Sidebar: PageSettings instance not found on window.app");const i=h.pages[e];window.currentPageSettingsTarget=i;const n=document.getElementById("pageSettingsModal");n&&(n.classList.remove("hidden"),n.style.display="flex")}}handlePageDelete(e,i){const n=document.createElement("div");n.className="modal-backdrop",n.style.display="flex",n.innerHTML=`
            <div class="modal" style="width: 320px; height: auto; min-height: 150px; padding: var(--space-4);">
                <div class="modal-header" style="font-size: var(--fs-md); padding-bottom: var(--space-2);">
                    <div>Delete Page</div>
                </div>
                <div class="modal-body" style="padding: var(--space-2) 0;">
                    <p style="margin-bottom: var(--space-3); font-size: var(--fs-sm);">
                        Are you sure you want to delete the page <b>"${i.name}"</b>?
                        <br><br>
                        This action cannot be undone.
                    </p>
                </div>
                <div class="modal-actions" style="padding-top: var(--space-3); border-top: 1px solid var(--border-subtle);">
                    <button class="btn btn-secondary close-btn btn-xs">Cancel</button>
                    <button class="btn btn-primary confirm-btn btn-xs" style="background: var(--danger); color: white; border: none;">Delete</button>
                </div>
            </div>
        `,document.body.appendChild(n);const t=()=>n.remove(),o=()=>{t();try{typeof h.deletePage=="function"?h.deletePage(e):(console.error("AppState.deletePage is missing"),typeof U=="function"&&U("Error: AppState.deletePage not found","error"))}catch(s){console.error("[Sidebar] Error deleting page:",s),typeof U=="function"&&U("Error deleting page: "+s.message,"error")}};n.querySelectorAll(".close-btn").forEach(s=>s.onclick=t),n.querySelector(".confirm-btn").onclick=o,n.onclick=s=>{s.target===n&&t()}}handleClearPage(){const e=h||window.AppState;if(!e){console.error("[Sidebar] AppState is not defined!"),typeof U=="function"&&U("Error: Application State is not ready.","error");return}const i=document.createElement("div");i.className="modal-backdrop",i.style.display="flex",i.innerHTML=`
            <div class="modal" style="width: 320px; height: auto; min-height: 180px; padding: var(--space-4);">
                <div class="modal-header" style="font-size: var(--fs-md); padding-bottom: var(--space-2);">
                    <div>Clear Page</div>
                </div>
                <div class="modal-body" style="padding: var(--space-2) 0;">
                    <p style="margin-bottom: var(--space-3); font-size: var(--fs-sm);">Are you sure you want to clear all widgets? <b>Locked</b> widgets will stay.</p>
                </div>
                <div class="modal-actions" style="padding-top: var(--space-3); border-top: 1px solid var(--border-subtle);">
                    <button class="btn btn-secondary close-btn btn-xs">Cancel</button>
                    <button class="btn btn-primary confirm-btn btn-xs" style="background: var(--danger); color: white; border: none;">Clear All</button>
                </div>
            </div>
        `,document.body.appendChild(i);const n=()=>{i.remove()},t=()=>{n();try{console.log("[Sidebar] Executing clearCurrentPage...");const r=e.clearCurrentPage(!0);r.preserved>0&&typeof U=="function"?U(`Cleared ${r.deleted} widgets. ${r.preserved} locked widget(s) were preserved.`,"info"):r.deleted>0?U(`Cleared all ${r.deleted} widgets.`,"success"):r.preserved>0?U(`No widgets cleared. ${r.preserved} locked widget(s) preserved.`,"info"):U("Page is already empty.","info"),_.log("Cleared widgets from current page via AppState")}catch(r){console.error("[Sidebar] Error clearing page:",r),typeof U=="function"&&U("Error clearing page: "+r.message,"error")}};i.querySelectorAll(".close-btn").forEach(r=>r.onclick=n);const s=i.querySelector(".confirm-btn");s.onclick=t,i.onclick=r=>{r.target===i&&n()}}setupMobileToggles(){const e=document.getElementById("mobileWidgetsBtn"),i=document.getElementById("mobilePropsBtn"),n=document.getElementById("mobileDeviceBtn"),t=document.getElementById("mobileBackdrop"),o=document.querySelector(".sidebar"),s=document.querySelector(".right-panel"),r=()=>{o?.classList.remove("mobile-active"),s?.classList.remove("mobile-active"),t?.classList.remove("active")};e?.addEventListener("click",()=>{const c=o?.classList.contains("mobile-active");r(),c||(o?.classList.add("mobile-active"),t?.classList.add("active"))}),i?.addEventListener("click",()=>{const c=s?.classList.contains("mobile-active");r(),c||(s?.classList.add("mobile-active"),t?.classList.add("active"))}),n?.addEventListener("click",()=>{r(),window.app?.deviceSettings?.open()}),t?.addEventListener("click",r),Q(B.SELECTION_CHANGED,()=>{window.innerWidth<=768&&(o?.classList.remove("mobile-active"),!s?.classList.contains("mobile-active")&&!o?.classList.contains("mobile-active")&&t?.classList.remove("active"))});const l=this.handlePaletteClick.bind(this);this.handlePaletteClick=c=>{l(c),window.innerWidth<=768&&r()}}}function ve(d){if(!d.canvas)return;const e=h.pages,i=h.getCanvasDimensions();d.canvas.querySelectorAll(".snap-guide");const n=d.canvas.querySelector(".lasso-selection");d.canvas.innerHTML="",h.settings.editor_light_mode?d.canvas.classList.add("light-mode"):d.canvas.classList.remove("light-mode");const t=h.getCurrentPage();t&&Ot(t)?d.viewport&&d.viewport.classList.add("device-dark-mode"):d.viewport&&d.viewport.classList.remove("device-dark-mode"),e.forEach((s,r)=>{const l=document.createElement("div");l.className="artboard-wrapper",l.dataset.index=r,r===h.currentPageIndex&&l.classList.add("active-page");const c=document.createElement("div");c.className="artboard-header",c.appendChild(me("mdi-cog-outline","Page Settings",()=>{window.pageSettings&&window.pageSettings.open(r)}));const a=document.createElement("span");a.className="artboard-name",a.textContent=s.name||`Page ${r+1}`,c.appendChild(a);const u=document.createElement("div");u.className="artboard-actions",r>0&&u.appendChild(me("mdi-chevron-left","Move Left",()=>{h.reorderPage(r,r-1)})),r<e.length-1&&u.appendChild(me("mdi-chevron-right","Move Right",()=>{h.reorderPage(r,r+1)})),u.appendChild(me("mdi-plus","Add Page After",()=>{h.addPage(r+1)})),u.appendChild(me("mdi-eraser","Clear Current Page",()=>{Wt({title:"Clear Page",message:`Are you sure you want to clear all widgets from <b>"${s.name||`Page ${r+1}`}"</b>?<br><br>This cannot be undone.`,confirmLabel:"Clear Page",confirmClass:"btn-danger",onConfirm:()=>{h.setCurrentPageIndex(r),h.clearCurrentPage()}})})),u.appendChild(me("mdi-delete-outline","Delete Page",()=>{Wt({title:"Delete Page",message:`Are you sure you want to delete the page <b>"${s.name||`Page ${r+1}`}"</b>?<br><br>All widgets on this page will be lost.`,confirmLabel:"Delete Page",confirmClass:"btn-danger",onConfirm:()=>{h.deletePage(r)}})})),c.appendChild(u),l.appendChild(c);const g=h.getCanvasShape(),m=g==="round"||g==="circle",f=document.createElement("div");f.className="artboard",f.dataset.index=r;const y=i.width,b=i.height;f.style.width=`${y}px`,f.style.height=`${b}px`;const w=Ot(s);if(f.classList.toggle("dark",w),f.classList.toggle("round-display",m),h.showGrid){const S=document.createElement("div");S.className="canvas-grid",f.appendChild(S)}s.layout&&/^\d+x\d+$/.test(s.layout)&&$i(f,s.layout,i,w);for(const S of s.widgets){const T=document.createElement("div");T.className="widget",T.style.left=S.x+"px",T.style.top=S.y+"px",T.style.width=S.width+"px",T.style.height=S.height+"px",T.dataset.id=S.id,T.dataset.pageIndex=r,h.selectedWidgetIds.includes(S.id)&&T.classList.add("active"),S.locked&&T.classList.add("locked"),S.hidden&&T.classList.add("hidden-widget");const R=(S.type||"").toLowerCase(),v=V?V.get(R):null;if(R==="group")T.classList.add("widget-group"),T.innerHTML="";else if(v&&v.render)try{const M=H=>H?Lt(H):w?"#ffffff":"#000000",E=h.selectedWidgetIds.includes(S.id),L=h.settings.device_model||"reterminal_e1001",k=G?G[L]:null;v.render(T,S,{getColorStyle:M,selected:E,profile:k})}catch{T.textContent=`Error: ${R}`,T.style.border="2px solid red"}else T.innerText=`Missing: ${R}`,T.style.color="red",T.style.border="1px dashed red";R!=="group"&&Ni(T),f.appendChild(T)}l.appendChild(f),d.canvas.appendChild(l)});const o=document.createElement("div");o.className="add-page-placeholder",o.title="Click to add a new page",o.style.width=`${i.width}px`,o.style.height=`${i.height}px`,o.style.marginTop="32px",o.innerHTML=`
        <div class="plus-icon">+</div>
        <div class="label">Add Page</div>
    `,o.onclick=s=>{if(s.stopPropagation(),h.addPage()){const l=h.pages.length-1;h.setCurrentPageIndex(l),W(B.STATE_CHANGED)}},d.canvas.appendChild(o),n&&d.canvas.appendChild(n),kt(d)}function Ot(d){const e=d?.dark_mode;return e==="dark"?!0:e==="light"?!1:!!h.settings.dark_mode}function $i(d,e,i,n){const t=e.match(/^(\d+)x(\d+)$/);if(!t)return;const o=parseInt(t[1],10),s=parseInt(t[2],10),r=document.createElement("div");r.className="lvgl-grid-overlay",r.style.cssText=`
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        display: grid;
        grid-template-rows: repeat(${o}, 1fr);
        grid-template-columns: repeat(${s}, 1fr);
        pointer-events: none;
        z-index: 1;
    `;const l=n?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)",c=n?"rgba(255,255,255,0.3)":"rgba(0,0,0,0.25)";for(let a=0;a<o;a++)for(let u=0;u<s;u++){const g=document.createElement("div");g.style.cssText=`border: 1px dashed ${l}; position: relative; box-sizing: border-box;`;const m=document.createElement("span");m.textContent=`${a},${u}`,m.style.cssText=`position: absolute; top: 2px; left: 4px; font-size: 8px; color: ${c}; pointer-events: none;`,g.appendChild(m),r.appendChild(g)}d.appendChild(r)}function re(d){const e=h.zoomLevel,i=h.settings;d.canvasContainer&&(d.canvasContainer.style.transform=`translate(${d.panX}px, ${d.panY}px) scale(${e})`,d.canvasContainer.style.transformOrigin="0 0");const n=(i.grid_opacity!==void 0?i.grid_opacity:8)/100;document.documentElement.style.setProperty("--grid-opacity",n.toString());const t=document.getElementById("zoomLevel");t&&(t.textContent=Math.round(e*100)+"%")}function Oe(d,e,i=!0){const t=d.canvas.querySelectorAll(".artboard-wrapper")[e];if(t){const o=d.viewport.getBoundingClientRect(),s=o.width,r=o.height;if(s===0||r===0){requestAnimationFrame(()=>Oe(d,e,i));return}const l=h.zoomLevel,c=t.offsetLeft+t.offsetWidth/2,a=t.offsetTop+t.offsetHeight/2;d.panX=s/2-c*l,d.panY=r/2-a*l,re(d)}}function Be(d,e,i=!1){if(!e||!e.id)return;const n=d.canvas.querySelector(`.widget[data-id="${e.id}"]`);if(n){n.style.left=e.x+"px",n.style.top=e.y+"px",n.style.width=e.width+"px",n.style.height=e.height+"px";const t=(e.type||"").toLowerCase(),o=V?V.get(t):null;if(t==="group")n.classList.add("widget-group");else if(!i&&o&&o.render)try{const s=a=>{const u=ri()?"dark":"light";return a?Lt(a):u==="dark"?"#ffffff":"#000000"},r=h.selectedWidgetIds.includes(e.id),l=h.settings.device_model||"reterminal_e1001",c=G?G[l]:null;o.render(n,e,{getColorStyle:s,selected:r,profile:c})}catch{}}}function ri(){const e=h.getCurrentPage()?.dark_mode;return e==="dark"?!0:e==="light"?!1:!!h.settings.dark_mode}function Ni(d){["tl","tc","tr","rc","br","bc","bl","lc"].forEach(i=>{const n=document.createElement("div");n.className=`widget-resize-handle handle-${i}`,n.dataset.handle=i,d.appendChild(n)})}function kt(d){const e=h.selectedWidgetIds,i=d.canvas.querySelector(`.artboard[data-index="${h.currentPageIndex}"]`);let n=d.canvas.querySelector(".context-toolbar");if(e.length===0||d.dragState||d.lassoState||!i){n&&n.remove();return}const t=h.getSelectedWidgets();if(t.length===0){n&&n.remove();return}let o=1/0,s=1/0,r=-1/0,l=-1/0;t.forEach(g=>{o=Math.min(o,g.x),s=Math.min(s,g.y),r=Math.max(r,g.x+(g.width||0)),l=Math.max(l,g.y+(g.height||0))});const c=o,a=s-45;if(n?n.parentElement!==i&&i.appendChild(n):(n=document.createElement("div"),n.className="context-toolbar",i.appendChild(n)),n.style.left=c+"px",n.style.top=a+"px",n.innerHTML="",e.length>1&&([{icon:"mdi-align-horizontal-left",title:"Align Left",action:"left"},{icon:"mdi-align-horizontal-center",title:"Align Center",action:"center"},{icon:"mdi-align-horizontal-right",title:"Align Right",action:"right"},{separator:!0},{icon:"mdi-align-vertical-top",title:"Align Top",action:"top"},{icon:"mdi-align-vertical-center",title:"Align Middle",action:"middle"},{icon:"mdi-align-vertical-bottom",title:"Align Bottom",action:"bottom"}].forEach(m=>{if(m.separator){Pe(n);return}xe(n,m.icon,m.title,()=>h.alignSelectedWidgets(m.action))}),e.length>=3&&(Pe(n),xe(n,"mdi-distribute-horizontal-center","Distribute Horizontally",()=>h.distributeSelectedWidgets("horizontal")),xe(n,"mdi-distribute-vertical-center","Distribute Vertically",()=>h.distributeSelectedWidgets("vertical")))),t.some(g=>g.type==="group"||g.parentId)?(n.children.length>0&&Pe(n),xe(n,"mdi-ungroup","Ungroup (Ctrl+Shift+G)",()=>h.ungroupSelection())):e.length>1&&(n.children.length>0&&Pe(n),xe(n,"mdi-group","Group Selection (Ctrl+G)",()=>h.groupSelection())),n.children.length===0){n.remove();return}}function xe(d,e,i,n){const t=document.createElement("button");t.className="btn-icon",t.title=i,t.innerHTML=`<i class="mdi ${e}"></i>`,t.onclick=o=>{o.stopPropagation(),n()},d.appendChild(t)}function Pe(d){if(!d.lastElementChild||d.lastElementChild.classList.contains("separator"))return;const e=document.createElement("div");e.className="separator",d.appendChild(e)}function me(d,e,i){const n=document.createElement("button");return n.className="artboard-btn",n.title=e,n.innerHTML=`<i class="mdi ${d}"></i>`,n.onclick=t=>{t.stopPropagation(),i()},n}function Wt({title:d,message:e,confirmLabel:i,confirmClass:n,onConfirm:t}){const o=document.createElement("div");o.className="modal-backdrop",o.style.display="flex",o.innerHTML=`
        <div class="modal" style="width: 340px; height: auto; padding: var(--space-4); border-radius: 12px; border: 1px solid var(--glass-border);">
            <div class="modal-header" style="font-size: var(--fs-md); font-weight: 600; padding-bottom: var(--space-3); border-bottom: 1px solid var(--border-subtle);">
                <div>${d}</div>
            </div>
            <div class="modal-body" style="padding: var(--space-4) 0;">
                <p style="font-size: var(--fs-sm); line-height: 1.5; color: var(--text-dim);">
                    ${e}
                </p>
            </div>
            <div class="modal-actions" style="display: flex; gap: 8px; justify-content: flex-end; padding-top: var(--space-3);">
                <button class="btn btn-secondary close-btn btn-xs" style="border-radius: 6px;">Cancel</button>
                <button class="btn ${n} confirm-btn btn-xs" style="border-radius: 6px;">${i||"Confirm"}</button>
            </div>
        </div>
    `,document.body.appendChild(o);const s=o.querySelector(".close-btn"),r=o.querySelector(".confirm-btn");s.onclick=()=>o.remove(),r.onclick=()=>{t(),o.remove()}}const Hi=Object.freeze(Object.defineProperty({__proto__:null,applyZoom:re,focusPage:Oe,getEffectiveDarkMode:ri,render:ve,renderContextToolbar:kt,updateWidgetDOM:Be},Symbol.toStringTag,{value:"Module"}));class Fi{constructor(e){this.canvasInstance=e,this.topRuler=document.getElementById("rulerTop"),this.leftRuler=document.getElementById("rulerLeft"),this.container=document.querySelector(".canvas-rulers"),this.viewport=e.viewport,this.indicators=null,this.init()}init(){!this.topRuler||!this.leftRuler||(this.topCtx=this.createRulerCanvas(this.topRuler),this.leftCtx=this.createRulerCanvas(this.leftRuler),this.update())}createRulerCanvas(e){const i=document.createElement("canvas");return e.appendChild(i),i.getContext("2d")}setIndicators(e){this.indicators=e,this.update()}update(){if(!h.showRulers){this.container&&(this.container.style.display="none"),this.viewport&&this.viewport.classList.remove("with-rulers");return}this.container&&(this.container.style.display="block"),this.viewport&&this.viewport.classList.add("with-rulers");const e=document.querySelector(".artboard-wrapper.active-page .artboard");if(!e)return;const i=this.topRuler.getBoundingClientRect(),n=this.leftRuler.getBoundingClientRect(),t=e.getBoundingClientRect(),o=h.zoomLevel;this.drawHorizontal(i,t,o),this.drawVertical(n,t,o)}drawHorizontal(e,i,n){const t=this.topCtx,o=t.canvas,s=window.devicePixelRatio||1;(o.width!==e.width*s||o.height!==e.height*s)&&(o.width=e.width*s,o.height=e.height*s,t.scale(s,s),o.style.width=e.width+"px",o.style.height=e.height+"px"),t.clearRect(0,0,e.width,e.height);const r=i.left-e.left;if(this.indicators){const a=r+this.indicators.x*n,u=(this.indicators.w||0)*n;t.fillStyle="hsla(var(--accent-h), 85%, 65%, 0.15)",t.fillRect(a,0,u,e.height),t.fillStyle="var(--accent)",t.fillRect(a,e.height-2,u,2)}t.strokeStyle="#4b5563",t.fillStyle="#9ca3af",t.font='9px "JetBrains Mono", monospace',t.lineWidth=1;const l=Math.floor(-r/n/10)*10,c=Math.ceil((e.width-r)/n/10)*10;for(let a=l;a<=c;a+=10){const u=r+a*n;if(u<0||u>e.width)continue;const g=a%100===0,m=a%50===0,f=g?12:m?8:4;t.beginPath(),t.moveTo(u,e.height),t.lineTo(u,e.height-f),t.stroke(),g&&t.fillText(a.toString(),u+2,10)}}drawVertical(e,i,n){const t=this.leftCtx,o=t.canvas,s=window.devicePixelRatio||1;(o.width!==e.width*s||o.height!==e.height*s)&&(o.width=e.width*s,o.height=e.height*s,t.scale(s,s),o.style.width=e.width+"px",o.style.height=e.height+"px"),t.clearRect(0,0,e.width,e.height);const r=i.top-e.top;if(this.indicators){const a=r+this.indicators.y*n,u=(this.indicators.h||0)*n;t.fillStyle="hsla(var(--accent-h), 85%, 65%, 0.15)",t.fillRect(0,a,e.width,u),t.fillStyle="var(--accent)",t.fillRect(e.width-2,a,2,u)}t.strokeStyle="#4b5563",t.fillStyle="#9ca3af",t.font='9px "JetBrains Mono", monospace',t.lineWidth=1;const l=Math.floor(-r/n/10)*10,c=Math.ceil((e.height-r)/n/10)*10;for(let a=l;a<=c;a+=10){const u=r+a*n;if(u<0||u>e.height)continue;const g=a%100===0,m=a%50===0,f=g?12:m?8:4;t.beginPath(),t.moveTo(e.width,u),t.lineTo(e.width-f,u),t.stroke(),g&&(t.save(),t.translate(10,u+2),t.rotate(-Math.PI/2),t.fillText(a.toString(),0,0),t.restore())}}}function de(){document.querySelectorAll(".snap-guide").forEach(e=>e.remove())}function zi(d,e,i){const n=i||d.canvas;if(!n||typeof n.appendChild!="function")return;const t=document.createElement("div");t.className="snap-guide snap-guide-vertical",t.style.left=`${Math.round(e)}px`,n.appendChild(t)}function Gi(d,e,i){const n=i||d.canvas;if(!n||typeof n.appendChild!="function")return;const t=document.createElement("div");t.className="snap-guide snap-guide-horizontal",t.style.top=`${Math.round(e)}px`,n.appendChild(t)}function ji(d,e){const i=h.getCurrentPage(),n=[],t=[];if(n.push(0,e.width/2,e.width),t.push(0,e.height/2,e.height),i&&Array.isArray(i.widgets))for(const o of i.widgets){if(!o||o.id===d)continue;const s=o.x,r=o.x+(o.width||0),l=o.y,c=o.y+(o.height||0),a=s+(o.width||0)/2,u=l+(o.height||0)/2;n.push(s,a,r),t.push(l,u,c)}return{vertical:n,horizontal:t}}function $t(d,e,i,n,t){const o=t||d.canvas;if(!o)return;const s=document.createElement("div");s.className=`snap-guide distance-marker distance-marker-${n}`;let r,l,c,a,u;if(n==="h"){const m=e.x<i.x?e.x+e.w:i.x+i.w,f=e.x<i.x?i.x:e.x;if(r=m,l=Math.min(e.y+e.h/2,i.y+i.h/2),c=f-m,c<=0)return;u=Math.round(c),s.style.left=`${r}px`,s.style.top=`${l}px`,s.style.width=`${c}px`,s.style.height="1px";const y=document.createElement("div");y.className="distance-marker-h-tick-start";const b=document.createElement("div");b.className="distance-marker-h-tick-end",s.appendChild(y),s.appendChild(b)}else{const m=e.y<i.y?e.y+e.h:i.y+i.h,f=e.y<i.y?i.y:e.y;if(l=m,r=Math.min(e.x+e.w/2,i.x+i.w/2),a=f-m,a<=0)return;u=Math.round(a),s.style.left=`${r}px`,s.style.top=`${l}px`,s.style.width="1px",s.style.height=`${a}px`;const y=document.createElement("div");y.className="distance-marker-v-tick-start";const b=document.createElement("div");b.className="distance-marker-v-tick-end",s.appendChild(y),s.appendChild(b)}const g=document.createElement("div");g.className="distance-marker-label",g.textContent=u,s.appendChild(g),o.appendChild(s)}function Tt(d,e,i,n,t,o,s,r=!1){if(!h.snapEnabled||t)return de(),{x:Math.round(i),y:Math.round(n)};const c=(h.getCurrentPage()?.widgets||[]).filter(M=>M.id!==e.id&&!M.hidden),a=ji(e.id,o),u=e.width||0,g=e.height||0;let m=i,f=n,y=null,b=null;const w=[{val:i,apply:M=>m=M},{val:i+u/2,apply:M=>m=M-u/2},{val:i+u,apply:M=>m=M-u}];let S=ye+1;for(const M of w)for(const E of a.vertical){const L=Math.abs(M.val-E);L<=ye&&L<S&&(S=L,y=E,M.apply(E))}const T=[{val:n,apply:M=>f=M},{val:n+g/2,apply:M=>f=M-g/2},{val:n+g,apply:M=>f=M-g}];let R=ye+1;for(const M of T)for(const E of a.horizontal){const L=Math.abs(M.val-E);L<=ye&&L<R&&(R=L,b=E,M.apply(E))}const v={x:m,y:f,w:u,h:g};return de(),y!=null&&zi(d,y,s),b!=null&&Gi(d,b,s),r&&c.forEach(M=>{const E={x:M.x,y:M.y,w:M.width,h:M.height};if(v.y<E.y+E.h&&v.y+v.h>E.y){const H=v.x<E.x?E.x-(v.x+v.w):v.x-(E.x+E.w);H>0&&H<150&&$t(d,v,E,"h",s)}if(v.x<E.x+E.w&&v.x+v.w>E.x){const H=v.y<E.y?E.y-(v.y+v.h):v.y-(E.y+E.h);H>0&&H<150&&$t(d,v,E,"v",s)}}),{x:Math.round(m),y:Math.round(f)}}function Pt(d,e,i,n,t,o){const s=t.match(/^(\d+)x(\d+)$/);if(!s)return{x:d,y:e};const r=parseInt(s[1],10),l=parseInt(s[2],10),c=o.width/l,a=o.height/r,u=d+i/2,g=e+n/2,m=Math.round(u/c-.5),f=Math.round(g/a-.5),y=Math.max(0,Math.min(l-1,m)),b=Math.max(0,Math.min(r-1,f));return{x:Math.round(y*c),y:Math.round(b*a)}}function ai(d){const e=h.getCurrentPage();if(!e||!e.layout)return;const i=e.layout.match(/^(\d+)x(\d+)$/);if(!i)return;const n=h.getWidgetById(d);if(!n)return;const t=parseInt(i[1],10),o=parseInt(i[2],10),s=h.getCanvasDimensions(),r=s.width/o,l=s.height/t,c=n.x+n.width/2,a=n.y+n.height/2,u=Math.floor(c/r),g=Math.floor(a/l),m=Math.max(0,Math.min(t-1,g)),f=Math.max(0,Math.min(o-1,u)),y={...n.props,grid_cell_row_pos:m,grid_cell_column_pos:f},b=Math.max(1,Math.round(n.height/l)),w=Math.max(1,Math.round(n.width/r));y.grid_cell_row_span=b,y.grid_cell_column_span=w,h.updateWidget(d,{props:y})}function Ui(d){const e=h.getWidgetById(d);if(!e)return;const i=h.getCanvasDimensions(),n=h.getCurrentPage();let t;if(n?.layout)t=Pt(e.x,e.y,e.width,e.height,n.layout,i);else{const o=h.snapEnabled;h.snapEnabled=!0,t=Tt({canvas:{querySelectorAll:()=>[]}},e,e.x,e.y,!1,i),h.snapEnabled=o}t&&(h.updateWidget(d,{x:t.x,y:t.y}),ai(d),h.recordHistory())}let pt=null,Nt=!1;Object.defineProperty(window,"lastHighlightRange",{get:()=>pt,set:function(d){pt=d},configurable:!0});Object.defineProperty(window,"isAutoHighlight",{get:()=>Nt,set:function(d){Nt=d},configurable:!0});function Me(d){const e=document.getElementById("snippetBox");if(!e)return;const i=e.value;if(!i)return;const n=Array.isArray(d)?d:d?[d]:[];if(n.length===0){try{e.setSelectionRange(0,0),e.scrollTop=0,pt=null}catch{}return}let t=-1,o=-1;if(n.forEach(s=>{const r=`id:${s}`,l=i.indexOf(r);if(l!==-1){const c=i.lastIndexOf(`
`,l)+1,a=["# widget:","// widget:","// page:"],u=["esphome:","logger:","api:","ota:","wifi:","ethernet:","psram:","substitutions:","external_components:","packages:","globals:","sensor:","binary_sensor:","text_sensor:","time:","script:","font:","image:","animation:","display:","lvgl:","i2c:","spi:","uart:","output:","light:","switch:","button:","number:","select:","climate:","fan:","cover:"];let g=-1;a.forEach(f=>{const y=i.indexOf(f,l+r.length);y!==-1&&(g===-1||y<g)&&(g=y)}),u.forEach(f=>{const y=`
`+f,b=i.indexOf(y,l+r.length);b!==-1&&(g===-1||b<g)&&(g=b+1)});const m=g!==-1?g:i.length;(t===-1||c<t)&&(t=c),m>o&&(o=m)}}),t!==-1&&o!==-1){const s=document.activeElement?document.activeElement.tagName.toLowerCase():"",r=(s==="input"||s==="textarea")&&document.activeElement!==e,l=window.Canvas&&(window.Canvas.dragState||window.Canvas.lassoState);if(!r&&!l){window.isAutoHighlight=!0;try{e.setSelectionRange(t,o),n.length===1&&!window._undoRedoInProgress&&e.focus()}catch{}}window.lastHighlightRange={start:t,end:o},setTimeout(()=>{if(e.scrollTo){const c=i.substring(0,t).split(`
`),a=i.split(`
`).length,u=c.length,g=e.scrollHeight/a;e.scrollTop=u*g-50,e.scrollLeft=0}},10)}}function Ht(){const d=document.getElementById("snippetBox");if(!d)return;const e=()=>{window.isAutoHighlight&&(window.isAutoHighlight=!1)};d.addEventListener("mousedown",e),d.addEventListener("input",e),d.addEventListener("keydown",i=>{(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Tab","Home","End"].includes(i.key)||!i.ctrlKey&&!i.metaKey)&&e()}),_.log("[YAML Export] Interaction listeners attached to Snippet Box.")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ht):Ht();let nt=0,ot=null;function Vi(d,e){const i=h.getWidgetById(e);if(!i)return;const n=(i.type||"").toLowerCase();if(n!=="text"&&n!=="label")return;const t=d.canvas.querySelector(`.widget[data-id="${e}"]`);if(!t)return;const o=h.zoomLevel,s=t.getBoundingClientRect(),r=document.createElement("textarea");r.value=i.props.text||i.title||"",r.style.position="absolute",r.style.left=s.left+window.scrollX+"px",r.style.top=s.top+window.scrollY+"px",r.style.width=Math.max(50,s.width)+"px",r.style.height=Math.max(30,s.height)+"px",r.style.zIndex="99999";const l=i.props||{},c=(l.font_size||20)*o;r.style.fontSize=c+"px",r.style.fontFamily=(l.font_family||"Roboto")+", sans-serif",r.style.fontWeight=l.font_weight||400,r.style.fontStyle=l.italic?"italic":"normal",r.style.textAlign=(l.text_align||"LEFT").split("_").pop().toLowerCase(),r.style.color=l.color||"black",r.style.background="rgba(255, 255, 255, 0.9)",r.style.border="1px solid #1a73e8",r.style.padding="0px",r.style.resize="both",r.style.outline="none",r.style.overflow="hidden",r.style.lineHeight="1.2",document.body.appendChild(r),r.focus(),r.select();const a=()=>{if(!r.isConnected&&!r.parentElement)return;r.removeEventListener("blur",u),r.removeEventListener("keydown",g);const m=r.value;m!==(i.props.text||i.title)&&h.updateWidget(e,{props:{...i.props,text:m}}),r.remove()},u=()=>a(),g=m=>{m.key==="Enter"&&!m.shiftKey&&(m.preventDefault(),a()),m.key==="Escape"&&r.remove(),r.style.height=r.scrollHeight+"px"};r.addEventListener("blur",u),r.addEventListener("keydown",g)}function Yi(d){d.canvas.addEventListener("mousedown",e=>{if(e.button!==0)return;de();const i=e.target.closest(".artboard-wrapper");if(!i||e.target.closest(".artboard-btn")||e.target.closest("button")){document.activeElement&&!e.target.closest("button")&&document.activeElement.blur();return}const n=parseInt(i.dataset.index,10),t=i.querySelector(".artboard");let o=t;const s=e.target.closest(".widget");let r=s?.dataset.id;const l=h.currentPageIndex!==n,c=!!e.target.closest(".artboard-header"),a=!!e.target.closest(".artboard")&&!s;if(l){const m=[...h.selectedWidgetIds];h.setCurrentPageIndex(n,{suppressFocus:!0}),r&&h.selectWidgets(m.includes(r)?m:[r]),Oe(d,n,!0);const f=d.canvas.querySelector(`.artboard[data-index="${n}"]`);f&&(o=f)}else(c||a)&&Oe(d,n,!0);const u=o.getBoundingClientRect(),g=h.zoomLevel;if(s){const m=s.dataset.id,f=e.shiftKey||e.ctrlKey,y=Date.now();if(m===ot&&y-nt<300){Vi(d,m),nt=0,ot=null,e.preventDefault(),e.stopPropagation();return}nt=y,ot=m,f?h.selectWidget(m,!0):h.selectedWidgetIds.includes(m)||h.selectWidget(m,!1);const b=h.getWidgetById(m);if(!b)return;let w=b,S=m;if(b.parentId){const R=h.getWidgetById(b.parentId);R&&(w=R,S=R.id,h.selectWidget(S,f))}if(e.target.classList.contains("widget-resize-handle")){if(b.parentId||w.locked)return;d.dragState={mode:"resize",handle:e.target.dataset.handle||"br",id:S,startX:e.clientX,startY:e.clientY,startW:w.width,startH:w.height,startWidgetX:w.x,startWidgetY:w.y,artboardEl:o,dragStartPanX:d.panX,dragStartPanY:d.panY}}else{if(w.locked)return;const v=h.getSelectedWidgets().map(M=>({id:M.id,startX:M.x,startY:M.y,clickOffsetX:(e.clientX-u.left)/g-M.x,clickOffsetY:(e.clientY-u.top)/g-M.y}));d.dragState={mode:"move",id:S,widgets:v,artboardEl:o,dragStartX:e.clientX,dragStartY:e.clientY,dragStartPanX:d.panX,dragStartPanY:d.panY},d.rulers&&d.rulers.setIndicators({x:w.x,y:w.y,w:w.width,h:w.height})}window.addEventListener("mousemove",d._boundMouseMove),window.addEventListener("mouseup",d._boundMouseUp),e.preventDefault()}else{const m=(e.clientX-u.left)/g,f=(e.clientY-u.top)/g;d.lassoState={startX:m,startY:f,rect:null,isAdditive:e.shiftKey||e.ctrlKey,initialSelection:[...h.selectedWidgetIds],artboardEl:o},d.lassoEl=document.createElement("div"),d.lassoEl.className="lasso-selection",t.appendChild(d.lassoEl),window.addEventListener("mousemove",d._boundMouseMove),window.addEventListener("mouseup",d._boundMouseUp),e.preventDefault()}}),d.canvas.addEventListener("contextmenu",e=>{e.preventDefault();const i=e.target.closest(".widget"),n=i?i.dataset.id:null;window.RadialMenu&&window.RadialMenu.show(e.clientX,e.clientY,n)})}function qi(d,e){const i=h.zoomLevel,n=h.getCanvasDimensions();if(e.dragState){if(e.dragState.mode==="move"){const t=document.querySelector(`.artboard[data-index="${h.currentPageIndex}"]`);if(!t)return;const o=(d.clientX-e.dragState.dragStartX)/i+(e.dragState.dragStartPanX-e.panX)/i,s=(d.clientY-e.dragState.dragStartY)/i+(e.dragState.dragStartPanY-e.panY)/i,r=h.getWidgetById(e.dragState.id);if(!r)return;const l=e.dragState.widgets.find(b=>b.id===e.dragState.id);if(!l)return;let c=l.startX+o,a=l.startY+s;const u=h.getCurrentPage();if(u?.layout&&!d.altKey){de();const b=Pt(c,a,r.width,r.height,u.layout,n);c=b.x,a=b.y}else if(h.snapEnabled&&!d.altKey){const b=Tt(e,r,c,a,d.altKey,n,t,d.ctrlKey);c=b.x,a=b.y}else de();c=Math.max(0,Math.min(n.width-r.width,c)),a=Math.max(0,Math.min(n.height-r.height,a));const g=c-l.startX,m=a-l.startY,f=g,y=m;for(const b of e.dragState.widgets){const w=h.getWidgetById(b.id);w&&!w.locked&&(w.x=b.startX+f,w.y=b.startY+y,Be(e,w,!0),w.type==="group"&&u.widgets.filter(T=>T.parentId===w.id).forEach(T=>{e.dragState.widgets.find(R=>R.id===T.id)||(T.x+=f-(e.dragState.lastDx||0),T.y+=y-(e.dragState.lastDy||0),Be(e,T,!0))}))}e.dragState.lastDx=f,e.dragState.lastDy=y,e.rulers&&e.rulers.setIndicators({x:c,y:a,w:r.width,h:r.height})}else if(e.dragState.mode==="resize"){const t=h.getWidgetById(e.dragState.id);if(!t)return;const o=e.dragState,s=o.handle,r=(o.dragStartPanX-e.panX)/i,l=(o.dragStartPanY-e.panY)/i,c=(d.clientX-o.startX)/i+r,a=(d.clientY-o.startY)/i+l;let u=o.startWidgetX,g=o.startWidgetY,m=o.startW,f=o.startH;s.includes("l")?(m=o.startW-c,u=o.startWidgetX+c):s.includes("r")&&(m=o.startW+c),s.includes("t")?(f=o.startH-a,g=o.startWidgetY+a):s.includes("b")&&(f=o.startH+a);const y=4;isNaN(m)&&(m=o.startW),isNaN(f)&&(f=o.startH),m<y&&(s.includes("l")&&(u=o.startWidgetX+o.startW-y),m=y),f<y&&(s.includes("t")&&(g=o.startWidgetY+o.startH-y),f=y);const b=(t.type||"").toLowerCase();if(b==="line"||b==="lvgl_line"){const w=t.props||{},S=w.orientation||"horizontal",T=parseInt(w.stroke_width||w.line_width||3,10);S==="vertical"?(m=T,f=Math.max(10,f)):(f=T,m=Math.max(10,m))}if(u=Math.max(0,Math.min(n.width-m,u)),g=Math.max(0,Math.min(n.height-f,g)),t.x=Math.round(u),t.y=Math.round(g),t.width=Math.round(m),t.height=Math.round(f),b==="icon"||b==="weather_icon"||b==="battery_icon"||b==="wifi_signal"||b==="ondevice_temperature"||b==="ondevice_humidity"){const w=t.props||{};if(w.fit_icon_to_frame){const T=Math.max(8,Math.min(t.width-8,t.height-8));w.size=Math.round(T)}else{const S=Math.max(8,Math.min(t.width,t.height));w.size=Math.round(S)}}else if(b==="shape_circle"){const w=Math.max(t.width,t.height);t.width=w,t.height=w}Be(e,t),e.rulers&&e.rulers.setIndicators({x:t.x,y:t.y,w:t.width,h:t.height})}}else if(e.lassoState){const t=e.lassoState.artboardEl;if(!t)return;const o=t.getBoundingClientRect(),s=(d.clientX-o.left)/i,r=(d.clientY-o.top)/i,l=Math.min(e.lassoState.startX,s),c=Math.min(e.lassoState.startY,r),a=Math.abs(s-e.lassoState.startX),u=Math.abs(r-e.lassoState.startY);e.lassoState.rect={x:l,y:c,w:a,h:u},e.lassoEl&&(e.lassoEl.style.left=l+"px",e.lassoEl.style.top=c+"px",e.lassoEl.style.width=a+"px",e.lassoEl.style.height=u+"px");const g=h.getCurrentPage();if(g){const m=new Set(e.lassoState.isAdditive?e.lassoState.initialSelection:[]);e.lassoState.currentSelection=[];const f={x1:l,y1:c,x2:l+a,y2:c+u};for(const y of g.widgets){const b={x1:y.x,y1:y.y,x2:y.x+y.width,y2:y.y+y.height},w=!(b.x2<f.x1||b.x1>f.x2||b.y2<f.y1||b.y1>f.y2),S=e.canvas.querySelector(`.widget[data-id="${y.id}"]`);S&&(w?(S.classList.add("active"),m.add(y.id)):e.lassoState.isAdditive&&e.lassoState.initialSelection.includes(y.id)?S.classList.add("active"):S.classList.remove("active"))}e.lassoState.currentSelection=Array.from(m),h.selectWidgets(e.lassoState.currentSelection)}d.preventDefault(),d.stopPropagation()}}function Xi(d,e){if(e.dragState){const i=e.dragState.id;if(e.dragState.mode==="move"){const t=e.canvas.querySelector(`.widget[data-id="${i}"]`),o=t?t.style.pointerEvents:"";t&&(t.style.pointerEvents="none");const s=document.elementFromPoint(d.clientX,d.clientY);t&&(t.style.pointerEvents=o);const r=s?.closest(".artboard");let l=-1;if(r)l=parseInt(r.dataset.index,10);else{const c=s?.closest("#pageList .item");if(c){const a=document.getElementById("pageList");l=Array.from(a.querySelectorAll(".item")).indexOf(c)}}if(l!==-1&&l!==h.currentPageIndex){const c=e.dragState.widgets,a=e.canvas.querySelector(`.artboard[data-index="${l}"]`);let u=0;window.removeEventListener("mousemove",e._boundMouseMove),window.removeEventListener("mouseup",e._boundMouseUp),e.dragState=null,de();let g=null;const m=h.zoomLevel;a&&(g=a.getBoundingClientRect());const f=new Set(c.map(b=>b.id));if(c.filter(b=>{const w=h.getWidgetById(b.id);return!w.parentId||!f.has(w.parentId)}).forEach(b=>{let w=b.startX,S=b.startY;if(g){const T=h.getWidgetById(b.id),R=h.getCanvasDimensions();w=Math.round((d.clientX-g.left)/m-b.clickOffsetX),S=Math.round((d.clientY-g.top)/m-b.clickOffsetY);const v=T?.width||50,M=T?.height||50;w=Math.max(0,Math.min(R.width-v,w)),S=Math.max(0,Math.min(R.height-M,S))}h.moveWidgetToPage(b.id,l,w,S)&&u++}),u>0){_.log(`[Canvas] Moved ${u} widgets to page ${l}`),ve(e);return}}}window.removeEventListener("mousemove",e._boundMouseMove),window.removeEventListener("mouseup",e._boundMouseUp),e.dragState=null,e.rulers&&e.rulers.setIndicators(null),de(),ai(i),h.recordHistory(),W(B.STATE_CHANGED),ve(e)}else if(e.lassoState){if(window.removeEventListener("mousemove",e._boundMouseMove),window.removeEventListener("mouseup",e._boundMouseUp),e.lassoEl&&(e.lassoEl.remove(),e.lassoEl=null),e.lassoState.rect){const i=e.lassoState.currentSelection||[];h.selectWidgets(i)}else e.lassoState.isAdditive||h.selectWidgets([]);e.lassoState=null,ve(e),d.preventDefault(),d.stopPropagation()}}function Ki(d){d.viewport&&d.viewport.addEventListener("mousedown",e=>{if(e.button===1){e.preventDefault(),e.stopPropagation(),d.panState={startX:e.clientX,startY:e.clientY,startPanX:d.panX,startPanY:d.panY},d.viewport.style.cursor="grabbing",document.body.classList.add("panning-active");const i=t=>{if(d.panState){const o=t.clientX-d.panState.startX,s=t.clientY-d.panState.startY;d.panX=d.panState.startPanX+o,d.panY=d.panState.startPanY+s,re(d)}},n=()=>{d.panState=null,d.viewport.style.cursor="auto",document.body.classList.remove("panning-active"),window.removeEventListener("mousemove",i),window.removeEventListener("mouseup",n)};window.addEventListener("mousemove",i),window.addEventListener("mouseup",n)}})}function Ji(d){const e=document.getElementById("zoomInBtn"),i=document.getElementById("zoomOutBtn"),n=document.getElementById("zoomResetBtn"),t=document.getElementById("gridToggleBtn"),o=document.getElementById("rulersToggleBtn"),s=document.getElementById("editorGridOpacity");e&&e.addEventListener("click",()=>ht(d)),i&&i.addEventListener("click",()=>ut(d)),n&&n.addEventListener("click",()=>De(d)),t&&(t.classList.toggle("active",!!h.showGrid),t.addEventListener("click",()=>{const r=!h.showGrid;h.setShowGrid(r),t.classList.toggle("active",r),_.log(`[Canvas] Grid toggled: ${r}`)})),o&&(o.classList.toggle("active",!!h.showRulers),o.addEventListener("click",()=>{const r=!h.showRulers;h.setShowRulers(r),o.classList.toggle("active",r),_.log(`[Canvas] Rulers toggled: ${r}`)})),s&&s.addEventListener("input",r=>{h.updateSettings({grid_opacity:parseInt(r.target.value,10)})}),d.canvasContainer&&d.canvasContainer.addEventListener("wheel",r=>{r.preventDefault(),Ft(r,d)},{passive:!1}),d.viewport&&d.viewport.addEventListener("wheel",r=>{r.preventDefault(),Ft(r,d)},{passive:!1}),document.addEventListener("keydown",r=>{r.ctrlKey&&(r.key==="+"||r.key==="=")?(r.preventDefault(),ht(d)):r.ctrlKey&&r.key==="-"?(r.preventDefault(),ut(d)):r.ctrlKey&&r.key==="0"||r.ctrlKey&&r.key.toLowerCase()==="r"?(r.preventDefault(),De(d)):r.ctrlKey&&r.key.toLowerCase()==="g"&&(r.preventDefault(),r.shiftKey?h.ungroupSelection():h.groupSelection())})}function Ft(d,e){const i=h.zoomLevel;let n=0;if(d.ctrlKey)n=d.deltaY>0?-.02:.02;else if(d.deltaMode===0&&d.deltaX===0&&Math.abs(d.deltaY)>=50)n=d.deltaY>0?-.05:.05;else{e.panX-=d.deltaX,e.panY-=d.deltaY,re(e);return}if(n===0)return;const t=Math.min(Math.max(i+n,.1),5);if(t===i)return;const o=e.viewport.getBoundingClientRect(),s=d.clientX-o.left,r=d.clientY-o.top,l=(s-e.panX)/i,c=(r-e.panY)/i;e.panX=s-l*t,e.panY=r-c*t,h.setZoomLevel(t),re(e)}function ht(d){li(.05,d)}function ut(d){li(-.05,d)}function li(d,e){const i=h.zoomLevel,n=Math.min(Math.max(i+d,.1),5);if(n!==i){if(e&&e.viewport){const t=e.viewport.getBoundingClientRect(),o=t.width/2,s=t.height/2,r=(o-e.panX)/i,l=(s-e.panY)/i;e.panX=o-r*n,e.panY=s-l*n}h.setZoomLevel(n),e&&re(e)}}function De(d){h.setZoomLevel(1),d.focusPage(0,!0)}function Zi(d){d.canvas&&(d.canvas.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy"}),d.canvas.addEventListener("drop",async e=>{e.preventDefault();const i=e.dataTransfer.getData("application/widget-type");_.log("[Canvas] Drop detected type:",i);const n=e.target.closest(".artboard");if(!n){_.warn("[Canvas] Drop outside of any artboard");return}const t=parseInt(n.dataset.index,10),o=n.getBoundingClientRect(),s=h.zoomLevel;if(h.currentPageIndex!==t&&h.setCurrentPageIndex(t),i){const r=(e.clientX-o.left)/s,l=(e.clientY-o.top)/s;try{await V.load(i);const c=Qe.createWidget(i);c.x=Math.round(r-c.width/2),c.y=Math.round(l-c.height/2),h.addWidget(c,t)}catch(c){_.error("[Canvas] error creating widget from drop:",c)}}}))}function Qi(d){!d.canvas||!d.canvasContainer||(d.canvas.addEventListener("touchstart",e=>{const i=e.touches;if(i.length===2){e.preventDefault(),d.pinchState={startDistance:gt(i[0],i[1]),startZoom:h.zoomLevel,startPanX:d.panX,startPanY:d.panY,startCenterX:(i[0].clientX+i[1].clientX)/2,startCenterY:(i[0].clientY+i[1].clientY)/2},d.touchState=null;return}if(i.length===1){const n=i[0],t=n.target.closest(".widget");if(d.longPressTimer&&clearTimeout(d.longPressTimer),d.longPressTimer=setTimeout(()=>{const o=t?t.dataset.id:null;window.RadialMenu&&window.RadialMenu.show(n.clientX,n.clientY,o),d.touchState=null},600),t){e.preventDefault();const o=t.dataset.id,s=h.getWidgetById(o);if(!s)return;n.target.classList.contains("widget-resize-handle")?d.touchState={mode:"resize",id:o,startX:n.clientX,startY:n.clientY,startW:s.width,startH:s.height,el:t}:d.touchState={mode:"move",id:o,startTouchX:n.clientX,startTouchY:n.clientY,startWidgetX:s.x,startWidgetY:s.y,hasMoved:!1,el:t},window.addEventListener("touchmove",l=>rt(l,d),{passive:!1}),window.addEventListener("touchend",l=>fe(l,d)),window.addEventListener("touchcancel",l=>fe(l,d))}else{const o=Date.now();if(o-d.lastTapTime<300){h.setZoomLevel(1),d.panX=0,d.panY=0,re(d),d.lastTapTime=0,e.preventDefault();return}d.lastTapTime=o,e.preventDefault(),d.touchState={mode:"pan",startTouchX:n.clientX,startTouchY:n.clientY,startPanX:d.panX,startPanY:d.panY},window.addEventListener("touchmove",s=>rt(s,d),{passive:!1}),window.addEventListener("touchend",s=>fe(s,d)),window.addEventListener("touchcancel",s=>fe(s,d))}}},{passive:!1}),d.canvasContainer.addEventListener("touchstart",e=>{if(e.touches.length===2){e.preventDefault();const i=e.touches;d.pinchState={startDistance:gt(i[0],i[1]),startZoom:h.zoomLevel,startPanX:d.panX,startPanY:d.panY,startCenterX:(i[0].clientX+i[1].clientX)/2,startCenterY:(i[0].clientY+i[1].clientY)/2},d.touchState=null,window.addEventListener("touchmove",n=>rt(n,d),{passive:!1}),window.addEventListener("touchend",n=>fe(n,d)),window.addEventListener("touchcancel",n=>fe(n,d))}},{passive:!1}))}function rt(d,e){const i=d.touches;if(e.pinchState&&i.length===2){d.preventDefault();const t=gt(i[0],i[1])/e.pinchState.startDistance,o=Math.max(.25,Math.min(4,e.pinchState.startZoom*t));h.setZoomLevel(o);const s=(i[0].clientX+i[1].clientX)/2,r=(i[0].clientY+i[1].clientY)/2,l=s-e.pinchState.startCenterX,c=r-e.pinchState.startCenterY;e.panX=e.pinchState.startPanX+l,e.panY=e.pinchState.startPanY+c,re(e);return}if(i.length===1&&e.longPressTimer){const n=i[0],t=n.clientX-(e.touchState?.startTouchX||n.clientX),o=n.clientY-(e.touchState?.startTouchY||n.clientY);Math.hypot(t,o)>10&&(clearTimeout(e.longPressTimer),e.longPressTimer=null)}if(e.touchState&&i.length===1){d.preventDefault();const n=i[0];if(e.touchState.mode==="pan"){const t=n.clientX-e.touchState.startTouchX,o=n.clientY-e.touchState.startTouchY;e.panX=e.touchState.startPanX+t,e.panY=e.touchState.startPanY+o,re(e)}else if(e.touchState.mode==="move"){const t=n.clientX-e.touchState.startTouchX,o=n.clientY-e.touchState.startTouchY;if(!e.touchState.hasMoved&&Math.hypot(t,o)<5)return;e.touchState.hasMoved=!0;const s=h.getWidgetById(e.touchState.id);if(!s)return;const r=h.getCanvasDimensions(),l=h.zoomLevel;let c=e.touchState.startWidgetX+t/l,a=e.touchState.startWidgetY+o/l;c=Math.max(0,Math.min(r.width-s.width,c)),a=Math.max(0,Math.min(r.height-s.height,a)),s.x=c,s.y=a,e.touchState.el&&(e.touchState.el.style.left=c+"px",e.touchState.el.style.top=a+"px")}else if(e.touchState.mode==="resize"){const t=h.getWidgetById(e.touchState.id);if(!t)return;const o=h.getCanvasDimensions(),s=h.zoomLevel;let r=e.touchState.startW+(n.clientX-e.touchState.startX)/s,l=e.touchState.startH+(n.clientY-e.touchState.startY)/s;const c=(t.type||"").toLowerCase();if(c==="line"||c==="lvgl_line"){const u=t.props||{},g=u.orientation||"horizontal",m=parseInt(u.stroke_width||u.line_width||3,10);g==="vertical"?(r=m,l=Math.max(10,l)):(l=m,r=Math.max(10,r))}const a=20;r=Math.max(a,Math.min(o.width-t.x,r)),l=Math.max(a,Math.min(o.height-t.y,l)),t.width=r,t.height=l,e.touchState.el&&(e.touchState.el.style.width=r+"px",e.touchState.el.style.height=l+"px")}}}function fe(d,e){if(e.touchState){const i=e.touchState.id,n=e.touchState.mode,t=e.touchState.hasMoved;if(i){const o=h.getWidgetById(i);if(o){if(n==="move"&&t){const s=h.getCanvasDimensions(),r=h.getCurrentPage();if(r?.layout){const l=Pt(o.x,o.y,o.width,o.height,r.layout,s);o.x=l.x,o.y=l.y}else{const l=Tt(e,o,o.x,o.y,!1,s);o.x=l.x,o.y=l.y}}else n==="resize"&&(o.width=Math.round(o.width),o.height=Math.round(o.height));h.selectWidget(i)}(n==="move"||n==="resize")&&t&&(es(e,i),h.recordHistory(),W(B.STATE_CHANGED))}e.touchState=null,de(),ve(e)}e.pinchState&&(e.pinchState=null),e.longPressTimer&&(clearTimeout(e.longPressTimer),e.longPressTimer=null)}function gt(d,e){return Math.hypot(e.clientX-d.clientX,e.clientY-d.clientY)}function es(d,e){const i=h.getCurrentPage();if(!i||!i.layout)return;const n=i.layout.match(/^(\d+)x(\d+)$/);if(!n)return;const t=h.getWidgetById(e);if(!t)return;const o=parseInt(n[1],10),s=parseInt(n[2],10),r=h.getCanvasDimensions(),l=r.width/s,c=r.height/o,a=t.x+t.width/2,u=t.y+t.height/2,g=Math.floor(a/l),m=Math.floor(u/c),f=Math.max(0,Math.min(o-1,m)),y=Math.max(0,Math.min(s-1,g)),b={...t.props,grid_cell_row_pos:f,grid_cell_column_pos:y},w=Math.max(1,Math.round(t.height/c)),S=Math.max(1,Math.round(t.width/l));b.grid_cell_row_span=w,b.grid_cell_column_span=S,h.updateWidget(e,{props:b})}class ts{constructor(){this.canvas=document.getElementById("canvas"),this.canvasContainer=document.getElementById("canvasContainer"),this.viewport=document.querySelector(".canvas-viewport"),this.dragState=null,this.panX=0,this.panY=0,this.touchState=null,this.pinchState=null,this.lastTapTime=0,this._boundMouseMove=e=>qi(e,this),this._boundMouseUp=e=>Xi(e,this),this.rulers=new Fi(this),this.init()}init(){Q(B.STATE_CHANGED,()=>this.render()),Q(B.PAGE_CHANGED,e=>{this.render(),e.suppressFocus||this.focusPage(e.index)}),Q(B.SELECTION_CHANGED,()=>this.updateSelectionVisuals()),Q(B.SETTINGS_CHANGED,()=>{this.render(),this.applyZoom(),this.rulers.update()}),Q(B.ZOOM_CHANGED,()=>{this.applyZoom(),this.rulers.update()}),this._boundResize=()=>{h.currentPageIndex!==-1&&this.focusPage(h.currentPageIndex,!1)},window.addEventListener("resize",this._boundResize),this.setupInteractions(),this.render(),this.applyZoom(),this.updateInterval&&clearInterval(this.updateInterval),this.updateInterval=setInterval(()=>{if(this.touchState||this.pinchState||this.dragState||this.panState||this.lassoState)return;const e=h.getCurrentPage();e&&e.widgets.some(i=>i.type==="datetime")&&this.render()},1e3)}render(){ve(this)}applyZoom(){re(this),this.rulers&&this.rulers.update()}updateSelectionVisuals(){const e=h.selectedWidgetIds;this.canvas.querySelectorAll(".widget").forEach(n=>{const t=n.dataset.id;e.includes(t)?n.classList.add("active"):n.classList.remove("active")}),kt(this)}setupInteractions(){Ki(this),Yi(this),Ji(this),Zi(this),Qi(this)}zoomIn(){ht(this)}zoomOut(){ut(this)}zoomReset(){De(this)}focusPage(e,i=!0){N(()=>Promise.resolve().then(()=>Hi),[],import.meta.url).then(n=>n.focusPage(this,e,i))}destroy(){this.updateInterval&&(clearInterval(this.updateInterval),this.updateInterval=null),this._boundResize&&window.removeEventListener("resize",this._boundResize)}}function is(d,e,i){if(!q()){_.warn("Entity Picker: No HA backend detected.");return}const n=document.getElementById("propertiesPanel")||document.body,t=document.querySelector(".entity-picker-overlay");t&&t.remove();const o=document.createElement("div");o.className="entity-picker-overlay";const s=document.createElement("div");s.className="entity-picker-header",s.textContent="Pick Home Assistant entity";const r=document.createElement("button");r.className="btn btn-secondary",r.textContent="Ã",r.style.padding="0 4px",r.style.fontSize="9px",r.type="button",r.addEventListener("click",()=>{o.remove()});const l=document.createElement("div");l.style.display="flex",l.style.alignItems="center",l.style.gap="4px",l.appendChild(r);const c=document.createElement("div");c.style.display="flex",c.style.justifyContent="space-between",c.style.alignItems="center",c.style.gap="4px",c.appendChild(s),c.appendChild(l);const a=document.createElement("div");a.style.display="flex",a.style.gap="4px",a.style.alignItems="center";const u=document.createElement("input");u.type="text",u.className="prop-input",u.placeholder="Search name or entity_id",u.style.flex="1";const g=document.createElement("select");g.className="prop-input",g.style.width="80px",["all","sensor","binary_sensor","light","switch","fan","cover","climate","media_player","input_number","number","input_boolean","input_text","input_select","weather","scene","script","button","input_button"].forEach(y=>{const b=document.createElement("option");b.value=y,b.textContent=y,g.appendChild(b)}),a.appendChild(u),a.appendChild(g);const m=document.createElement("div");m.className="entity-picker-list",o.appendChild(c),o.appendChild(a),o.appendChild(m),n.appendChild(o);function f(y){if(m.innerHTML="",!y||y.length===0){const b=document.createElement("div");b.style.color="var(--muted)",b.style.fontSize="var(--fs-xs)",b.textContent="No entities match.",m.appendChild(b);return}y.forEach(b=>{const w=document.createElement("div");w.className="entity-picker-row";const S=document.createElement("div");S.className="entity-picker-name",S.textContent=b.name||b.entity_id;const T=document.createElement("div");T.className="entity-picker-meta",T.textContent=`${b.entity_id} Â· ${b.domain||b.entity_id.split(".")[0]}`,w.appendChild(S),w.appendChild(T),w.addEventListener("click",()=>{if(i&&i(b.entity_id),e&&(e.value=b.entity_id),d&&h){if(h.updateWidget(d.id,{entity_id:b.entity_id,title:b.name||b.entity_id||""}),d.type==="graph"&&b.attributes){const R=b.attributes,v={};if(R.unit_of_measurement==="%"&&(d.props.min_value||(v.min_value="0"),d.props.max_value||(v.max_value="100")),R.min!==void 0&&!d.props.min_value&&(v.min_value=String(R.min)),R.max!==void 0&&!d.props.max_value&&(v.max_value=String(R.max)),Object.keys(v).length>0){const M={...d.props,...v};h.updateWidget(d.id,{props:M})}}if(d.type==="sensor_text"){const R={...d.props};b.attributes&&b.attributes.unit_of_measurement?R.unit=b.attributes.unit_of_measurement:b.unit&&(R.unit=b.unit);const v=b.state;if(b.entity_id.startsWith("weather.")||b.entity_id.startsWith("text_sensor."))R.is_text_sensor=!0;else if(v!=null&&v!==""){const E=parseFloat(v);isNaN(E)?R.is_text_sensor=!0:R.is_text_sensor=!1}h.updateWidget(d.id,{props:R})}}o.remove()}),m.appendChild(w)})}ge().then(y=>{if(!y||y.length===0){f([]);return}function b(){const w=(u.value||"").toLowerCase(),S=g.value,T=y.filter(R=>{const v=R.domain||R.entity_id.split(".")[0];return S!=="all"&&v!==S?!1:w?`${R.entity_id} ${R.name||""}`.toLowerCase().includes(w):!0});f(T)}u.addEventListener("input",b),g.addEventListener("change",b),b()})}let ie=null,ue=null,_e=null,Ae=null,ae=null,be=null;function ss(){ie||(ie=document.getElementById("iconPickerModal"),ue=document.getElementById("iconPickerFilter"),_e=document.getElementById("iconPickerList"),Ae=document.getElementById("iconPickerClose"),ie||(ie=document.createElement("div"),ie.id="iconPickerModal",ie.className="modal-backdrop hidden",ie.style.zIndex="2000",ie.innerHTML=`
            <div class="modal" style="max-width: 500px; height: 80vh; display: flex; flex-direction: column;">
                <div class="modal-header">
                    <div>Select Icon</div>
                    <button id="iconPickerClose" class="btn btn-secondary">Ã</button>
                </div>
                <div class="modal-body" style="flex: 1; overflow: hidden; display: flex; flex-direction: column; padding: 15px;">
                    <input type="text" id="iconPickerFilter" class="prop-input" placeholder="Filter icons..." style="width: 100%; margin-bottom: 12px;">
                    <div id="iconPickerList" style="flex: 1; overflow-y: auto; border: 1px solid var(--border-subtle); border-radius: 4px; display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px; padding: 10px; background: var(--bg-canvas);"></div>
                </div>
            </div>
        `,document.body.appendChild(ie),ue=document.getElementById("iconPickerFilter"),_e=document.getElementById("iconPickerList"),Ae=document.getElementById("iconPickerClose")),Ae&&(Ae.onclick=mt),ue&&(ue.oninput=d=>{const e=d.target;ns(e.value)}),ie.onclick=d=>{d.target===ie&&mt()})}function zt(d,e){ss(),ae=d,be=e,ie.classList.remove("hidden"),ie.style.display="flex",ue&&(ue.value="",ue.focus()),ft(oi||[])}function mt(){ie&&(ie.classList.add("hidden"),ie.style.display="none"),ae=null,be=null}function ft(d){if(!_e)return;if(_e.innerHTML="",!d||d.length===0){_e.innerHTML='<div style="padding: 10px; color: var(--muted); grid-column: 1 / -1; text-align: center;">No icons found.</div>';return}const e=document.createDocumentFragment();d.forEach(i=>{const n=document.createElement("div");n.className="icon-item",n.style.padding="8px",n.style.border="1px solid var(--border-subtle)",n.style.borderRadius="4px",n.style.cursor="pointer",n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="center",n.style.justifyContent="center",n.style.textAlign="center",n.style.background="var(--bg)",n.title=i.name;const t=document.createElement("div");t.className="mdi",t.style.fontSize="24px",t.style.color="var(--accent)";const o=parseInt(i.code,16);t.textContent=String.fromCodePoint(o);const s=document.createElement("div");s.style.fontSize="9px",s.style.marginTop="4px",s.style.overflow="hidden",s.style.textOverflow="ellipsis",s.style.whiteSpace="nowrap",s.style.width="100%",s.style.color="var(--muted)",s.textContent=i.name,n.appendChild(t),n.appendChild(s),n.onclick=()=>os(i),n.onmouseenter=()=>{n.style.borderColor="var(--accent)",n.style.background="rgba(110, 68, 255, 0.05)"},n.onmouseleave=()=>{n.style.borderColor="var(--border-subtle)",n.style.background="var(--bg)"},e.appendChild(n)}),_e.appendChild(e)}function ns(d){const e=oi||[];if(!d){ft(e);return}const i=d.toLowerCase(),n=e.filter(t=>t.name.toLowerCase().includes(i)||t.code.toLowerCase().includes(i));ft(n)}function os(d){ae&&(be?(be.value=d.code,be.dispatchEvent(new Event("input")),be.dispatchEvent(new Event("change"))):(ae.props||(ae.props={}),ae.props.code=d.code,h&&h.updateWidget(ae.id,ae))),mt()}const rs=`# Dictionary to map calendar keys to their corresponding names
# One word calandars don't need to be added calendar.jobs would map to Jobs by default without adding it here
# calendar.hello_world should be added on the other hand
CALENDAR_NAMES = {"calendar.x": "X", "calendar.Y": "Y"}
# Day names (which are displayed in the calendar event list) can be translated here if required
DAY_NAMES = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"]
# How many entries to send to the ESPHome device
MAX_ENTRIES = 8

def convert_calendar_format(data, today):
    # Initialize a dictionary to store events grouped by date
    events_by_date = {}
    entrie_count = 0
    
    # Variable to store the end time of the closest event that will end
    closest_end_time = None
    
    # Iterate through calendar keys and events
    for calendar_key, events_list in data.items():
        for event in events_list['events']:
            if 'description' in event:
                event.pop('description')
                
            # Attempt to split the 'event[start]' into date and time parts
            parts = event['start'].split("T")
            event_date = parts[0]
            event_time = parts[1] if len(parts) > 1 else None  # event_time might not be present
            
            # Compare the event_date with today's date
            if event_date < today:
                # If the event's date is before today, update it to today's date (in case of multi day event starting before today)
                event['start'] = today if event_time is None else f"{today}T{event_time}"
                event_date = today
            
            # Add calendar name to event
            # If calendar key exists in CALENDAR_NAMES, use its value, otherwise capitalize the second part of the key
            event['calendar_name'] = CALENDAR_NAMES.get(calendar_key, calendar_key.split(".")[1].capitalize())
            
            # Parse location_name and location_address
            if 'location' in event:
                # Split the 'location' string into lines based on the newline character
                location_lines = event['location'].split('\\\\n')
                if len(location_lines) >= 2:
                    # If there are at least two lines, consider the first line as 'location_name' and the second line as 'location_address'
                    event['location_name'] = location_lines[0]
                    # event['location_address'] = location_lines[1]
                elif len(location_lines) == 1:
                    # If there's only one line, consider it as 'location_name'
                    event['location_name'] = location_lines[0]
                    
                # Remove the 'location' key from the event since it's been parsed into 'location_name' and 'location_address'
                event.pop('location')
                    
            # Add event to events_by_date dictionary
            if event_date in events_by_date:
                events_by_date[event_date].append(event)
            else:
                events_by_date[event_date] = [event]
                
    # Sort events by date
    sorted_dates = sorted(events_by_date.keys())
    
    # Initialize a list to store the final date objects
    result = []
    
    # Iterate through sorted dates
    for date in sorted_dates:
        all_day_events = []
        other_events = []
        for event in events_by_date[date]:
            if entrie_count == MAX_ENTRIES:
                break
            
            # Check if the event lasts for the whole day
            start_date = event['start']
            end_date = event['end']
            if 'T' not in event['start']:
                all_day_events.append(event)
            else:
                other_events.append(event)
                
            entrie_count = entrie_count + 1
        
        if other_events and date == today:
            closest_end_time = sorted(other_events, key=lambda item:dt_util.parse_datetime(item['end']), reverse=False)[0]["end"]
        
        if all_day_events or other_events:
            # Sort other_events by start time
            other_events.sort(key=lambda item:dt_util.parse_datetime(item['start']), reverse=False)
            
            # Construct dictionary for the date
            # is_today cast to int because a bool somehow crashes my esphome config
            day_item = {
                'date': date,
                'day': dt_util.parse_datetime(date).day,
                'is_today': int(date == dt_util.now().isoformat().split("T")[0]),
                'day_name': DAY_NAMES[dt_util.parse_datetime(date).weekday()],
                'all_day': all_day_events,
                'other': other_events
            }
            result.append(day_item)
        
    return (result, closest_end_time)

# Access the data received from the Home Assistant service call
input_data = data["calendar"]
today = data["now"]

# Convert the received data into the format expected by the epaper display
converted_data = convert_calendar_format(input_data, today)

# Pass the output back to Home Assistant
output["entries"] = {"days": converted_data[0]}
output["closest_end_time"] = converted_data[1]
`;class as{constructor(){this.panel=document.getElementById("propertiesPanel"),this.lastRenderedWidgetId=null,this.containerStack=[],this.sectionStates={},this.init()}init(){Q(B.SELECTION_CHANGED,()=>this.render()),Q(B.STATE_CHANGED,()=>this.render());const e=document.getElementById("snapToggle");e&&(e.checked=h.snapEnabled,e.addEventListener("change",n=>{h.setSnapEnabled(n.target.checked)}),Q(B.SETTINGS_CHANGED,n=>{n.snapEnabled!==void 0&&(e.checked=n.snapEnabled)}));const i=document.getElementById("lockPositionToggle");i&&i.addEventListener("change",n=>{const t=h.selectedWidgetIds;t.length>0&&h.updateWidgets(t,{locked:n.target.checked})}),this.render()}render(){if(!this.panel||window.Canvas&&window.Canvas.lassoState)return;const e=h.selectedWidgetId;if(!(this.lastRenderedWidgetId!==e)&&this.panel&&this.panel.isConnected){const c=document.activeElement;if(c&&this.panel.contains(c)){const a=c.tagName.toLowerCase();if(c.type&&c.type.toLowerCase(),a==="input"||a==="textarea"||a==="select"||c.classList.contains("prop-input"))return}}this.lastRenderedWidgetId=e,this.containerStack=[],this.panel.innerHTML="";const n=document.getElementById("lockPositionToggle");if(n){const c=h.getSelectedWidgets(),a=c.length>0&&c.every(g=>g.locked),u=c.some(g=>g.locked);n.checked=a,n.indeterminate=u&&!a,n.disabled=c.length===0}if(h.selectedWidgetIds.length===0){this.panel.innerHTML="<div style='padding:16px;color:#aaa;text-align:center;'>Select a widget to edit properties</div>";return}if(h.selectedWidgetIds.length>1){this.panel.innerHTML=`
                <div style='padding:16px; text-align:center;'>
                    <div style="font-size: 24px; margin-bottom: 12px;">ð</div>
                    <div style="font-weight: 600; color: var(--text);">${h.selectedWidgetIds.length} widgets selected</div>
                    <div style="font-size: 11px; color: var(--muted); margin-top: 8px; margin-bottom: 16px;">
                        Move, group, or delete the selection. Use the Lock toggle above to lock all.
                    </div>
                    <button id="multiDeleteBtn" class="btn btn-secondary btn-xs" style="background: var(--danger); color: white; border: none; width: 100%;">
                        ð Delete Selected Widgets
                    </button>
                </div>
    `;const c=this.panel.querySelector("#multiDeleteBtn");c&&c.addEventListener("click",()=>{confirm(`Are you sure you want to delete ${h.selectedWidgetIds.length} widgets ? `)&&h.deleteWidget(null)});return}const t=h.getSelectedWidget();if(!t)return;const o=(t.type||"").toLowerCase();let s=o;o==="nav_next_page"?s="next page":o==="nav_previous_page"?s="previous page":o==="nav_reload_page"?s="reload page":s=o.replace(/_/g," ");const r=document.createElement("div");if(r.className="sidebar-section-label",r.style.marginTop="0",r.style.textTransform="capitalize",r.textContent=`${s} Properties`,this.panel.appendChild(r),["shape_rect","rounded_rect","shape_circle","rectangle","rrect","circle"].includes(t.type)){const c=document.createElement("button");c.className="btn btn-secondary",c.style.marginBottom="16px",c.style.width="100%",c.innerHTML='<span class="mdi mdi-box-shadow"></span> Create Drop Shadow',c.onclick=()=>h.createDropShadow(t.id),this.panel.appendChild(c)}if(this.createSection("Transform",!1),this.addCompactPropertyRow(()=>{this.addLabeledInput("Pos X","number",t.x,c=>{h.updateWidget(t.id,{x:parseInt(c,10)||0})}),this.addLabeledInput("Pos Y","number",t.y,c=>{h.updateWidget(t.id,{y:parseInt(c,10)||0})})}),this.addCompactPropertyRow(()=>{this.addLabeledInput("Width","number",t.width,c=>{h.updateWidget(t.id,{width:parseInt(c,10)||10})}),this.addLabeledInput("Height","number",t.height,c=>{h.updateWidget(t.id,{height:parseInt(c,10)||10})})}),this.endSection(),V){const c=V.get(o);c&&c.schema}this.renderLegacyProperties(t,o),this.createSection("Grid Layout",!1),this.renderGridCellProperties(t,o),this.endSection(),this.createSection("Visibility Conditions",!1),this.addVisibilityConditions(t),this.endSection()}createSection(e,i=!0){const n=this.sectionStates[e]!==void 0?this.sectionStates[e]===!1:!i,t=document.createElement("div");t.className="properties-section"+(n?" collapsed":"");const o=document.createElement("div");o.className="properties-section-header",o.innerHTML=`<span > ${e}</span> <span class="icon mdi mdi-chevron-down"></span>`,o.onclick=r=>{r.stopPropagation();const l=t.classList.toggle("collapsed");this.sectionStates[e]=!l};const s=document.createElement("div");s.className="properties-section-content",t.appendChild(o),t.appendChild(s),this.sectionStates[e]===void 0&&(this.sectionStates[e]=!n),this.getContainer().appendChild(t),this.containerStack.push(s)}endSection(){this.containerStack.length>0&&this.containerStack.pop()}getContainer(){return this.containerStack.length>0?this.containerStack[this.containerStack.length-1]:this.panel}renderGridCellProperties(e,i){const n=h.getCurrentPage(),o=(n?.layout||"absolute")!=="absolute";if(!n)return;if(!o){const u=this.getContainer(),g=document.createElement("div");g.style.padding="8px 0",g.style.fontSize="11px",g.style.color="var(--muted)",g.textContent="Page is currently in Absolute Positioning mode.",u.appendChild(g);const m=document.createElement("button");m.className="btn btn-secondary btn-xs",m.style.width="100%",m.innerHTML='<span class="mdi mdi-grid"></span> Enable Page Grid Layout',m.onclick=()=>{window.app&&window.app.pageSettings&&window.app.pageSettings.open(h.currentPageIndex)},u.appendChild(m);return}const s=Qe.isLvglWidget(i),r=e.props||{},l=(u,g)=>{const m={...e.props,[u]:g};h.updateWidget(e.id,{props:m})},c=(u,g,m,f)=>{const y=n.layout.match(/^(\d+)x(\d+)$/);if(!y)return null;const b=parseInt(y[1],10),w=parseInt(y[2],10),S=h.getCanvasDimensions(),T=S.width/w,R=S.height/b;return{x:Math.round(g*T),y:Math.round(u*R),width:Math.round(T*f),height:Math.round(R*m)}};if(this.addLabeledInput("Row (0-indexed)","number",r.grid_cell_row_pos??"",u=>{const g=u===""?null:parseInt(u,10);l("grid_cell_row_pos",isNaN(g)?null:g);const f=h.getWidgetById(e.id)?.props||{};if(g!=null&&f.grid_cell_column_pos!=null){const y=c(g,f.grid_cell_column_pos,f.grid_cell_row_span||1,f.grid_cell_column_span||1);y&&h.updateWidget(e.id,{x:y.x,y:y.y,width:y.width,height:y.height})}}),this.addLabeledInput("Column (0-indexed)","number",r.grid_cell_column_pos??"",u=>{const g=u===""?null:parseInt(u,10);l("grid_cell_column_pos",isNaN(g)?null:g);const f=h.getWidgetById(e.id)?.props||{};if(g!=null&&f.grid_cell_row_pos!=null){const y=c(f.grid_cell_row_pos,g,f.grid_cell_row_span||1,f.grid_cell_column_span||1);y&&h.updateWidget(e.id,{x:y.x,y:y.y,width:y.width,height:y.height})}}),this.addLabeledInput("Row Span","number",r.grid_cell_row_span||1,u=>{const g=Math.max(1,parseInt(u,10)||1);l("grid_cell_row_span",g);const f=h.getWidgetById(e.id)?.props||{};if(f.grid_cell_row_pos!=null&&f.grid_cell_column_pos!=null){const y=c(f.grid_cell_row_pos,f.grid_cell_column_pos,g,f.grid_cell_column_span||1);y&&h.updateWidget(e.id,{x:y.x,y:y.y,width:y.width,height:y.height})}}),this.addLabeledInput("Column Span","number",r.grid_cell_column_span||1,u=>{const g=Math.max(1,parseInt(u,10)||1);l("grid_cell_column_span",g);const f=h.getWidgetById(e.id)?.props||{};if(f.grid_cell_row_pos!=null&&f.grid_cell_column_pos!=null){const y=c(f.grid_cell_row_pos,f.grid_cell_column_pos,f.grid_cell_row_span||1,g);y&&h.updateWidget(e.id,{x:y.x,y:y.y,width:y.width,height:y.height})}}),s){const u=["START","END","CENTER","STRETCH"];this.addSelect("X Align",r.grid_cell_x_align||"STRETCH",u,g=>{l("grid_cell_x_align",g)}),this.addSelect("Y Align",r.grid_cell_y_align||"STRETCH",u,g=>{l("grid_cell_y_align",g)})}const a=document.createElement("button");a.className="btn btn-secondary btn-xs",a.style.marginTop="8px",a.style.width="100%",a.innerHTML='<span class="mdi mdi-cog"></span> Open Page Grid Settings',a.onclick=()=>{const u=h.currentPageIndex;window.app&&window.app.pageSettings&&window.app.pageSettings.open(u)},this.getContainer().appendChild(a)}renderLegacyProperties(e,i){const n=ni(),t=e.props||{},o=(s,r)=>{const l={...e.props,[s]:r};h.updateWidget(e.id,{props:l})};if(i==="shape_rect"||i==="shape_circle")this.createSection("Appearance",!0),this.addNumberWithSlider("Opacity (%)",t.opacity!==void 0?t.opacity:100,0,100,s=>{o("opacity",s)}),this.addCheckbox("Fill",t.fill||!1,s=>o("fill",s)),this.addLabeledInput("Border Width","number",t.border_width||1,s=>o("border_width",parseInt(s,10))),this.addColorSelector("Color",t.color||"black",n,s=>o("color",s)),this.addColorSelector("Border Color",t.border_color||"black",n,s=>o("border_color",s)),this.endSection();else if(i==="rounded_rect")this.createSection("Appearance",!0),this.addNumberWithSlider("Opacity (%)",t.opacity!==void 0?t.opacity:100,0,100,s=>{o("opacity",s)}),this.addCheckbox("Fill",t.fill||!1,s=>o("fill",s)),t.fill&&this.addCheckbox("Show Border",t.show_border||!1,s=>o("show_border",s)),this.addCompactPropertyRow(()=>{this.addLabeledInput("Border Width","number",t.border_width||4,s=>o("border_width",parseInt(s,10))),this.addLabeledInput("Corner Radius","number",t.radius||10,s=>o("radius",parseInt(s,10)))}),this.addColorSelector("Color",t.color||"black",n,s=>o("color",s)),this.addColorSelector("Border Color",t.border_color||"black",n,s=>o("border_color",s)),this.endSection();else if(i==="line"){this.createSection("Appearance",!0),this.addLabeledInput("Opacity (%)","number",t.opacity!==void 0?t.opacity:100,l=>{o("opacity",parseInt(l,10))}),this.addSegmentedControl("Orientation",[{value:"horizontal",label:"Horiz",icon:"mdi-arrow-left-right"},{value:"vertical",label:"Vert",icon:"mdi-arrow-up-down"}],t.orientation||"horizontal",l=>{const c=parseInt(t.stroke_width||3,10),a=e.width,u=e.height;l==="vertical"?h.updateWidget(e.id,{width:c,height:Math.max(a,u,20)}):h.updateWidget(e.id,{width:Math.max(a,u,20),height:c}),o("orientation",l)});const s=(t.orientation||"horizontal")==="vertical";this.addLabeledInput("Line Length (px)","number",s?e.height:e.width,l=>{const c=parseInt(l,10)||20;s?h.updateWidget(e.id,{height:c}):h.updateWidget(e.id,{width:c})}),this.addLabeledInput("Stroke Width (px)","number",t.stroke_width||3,l=>{const c=parseInt(l,10)||1;o("stroke_width",c),(t.orientation||"horizontal")==="vertical"?h.updateWidget(e.id,{width:c}):h.updateWidget(e.id,{height:c})});const r=document.createElement("button");r.textContent="Fill Canvas Length",r.className="btn btn-secondary",r.style.marginTop="8px",r.style.width="100%",r.onclick=()=>{const l=h.getCanvasDimensions();(t.orientation||"horizontal")==="vertical"?h.updateWidget(e.id,{y:0,height:l.height}):h.updateWidget(e.id,{x:0,width:l.width})},this.getContainer().appendChild(r),this.addColorSelector("Color",t.color||"black",n,l=>o("color",l)),this.endSection()}else if(i==="text"||i==="label"){this.createSection("Content",!0),this.addLabeledInput("Text","text",t.text||"",a=>o("text",a)),this.endSection(),this.createSection("Appearance",!0),this.addNumberWithSlider("Opacity (%)",t.opacity!==void 0?t.opacity:100,0,100,a=>{o("opacity",a)}),this.addLabeledInput("Font Size","number",t.font_size||20,a=>o("font_size",parseInt(a,10))),this.addColorSelector("Color",t.color||"black",n,a=>o("color",a));const s=["Roboto","Inter","Open Sans","Lato","Montserrat","Poppins","Raleway","Roboto Mono","Ubuntu","Nunito","Playfair Display","Merriweather","Work Sans","Source Sans Pro","Quicksand","Custom..."],r=t.font_family||"Roboto",l=!s.slice(0,-1).includes(r);this.addSelect("Font",l?"Custom...":r,s,a=>{a!=="Custom..."?(o("font_family",a),o("custom_font_family","")):o("font_family","Custom...")}),(l||t.font_family==="Custom...")&&(this.addLabeledInput("Custom Font Name","text",t.custom_font_family||(l?r:""),a=>{o("font_family",a||"Roboto"),o("custom_font_family",a)}),this.addHint('Browse <a href="https://fonts.google.com" target="_blank">fonts.google.com</a>')),this.addSelect("Weight",t.font_weight||400,[100,200,300,400,500,600,700,800,900],a=>o("font_weight",parseInt(a,10))),this.addCheckbox("Italic",t.italic||!1,a=>o("italic",a));const c=["TOP_LEFT","TOP_CENTER","TOP_RIGHT","CENTER_LEFT","CENTER","CENTER_RIGHT","BOTTOM_LEFT","BOTTOM_CENTER","BOTTOM_RIGHT"];this.addSelect("Align",t.text_align||"TOP_LEFT",c,a=>o("text_align",a)),this.addSelect("BPP (Anti-aliasing)",String(t.bpp||1),["1","2","4","8"],a=>o("bpp",parseInt(a,10))),this.addHint("1=no AA, 2=4 levels, 4=16 levels, 8=256 levels"),this.endSection()}else if(i==="sensor_text"){this.createSection("Data Source",!0),this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",a=>{h.updateWidget(e.id,{entity_id:a}),a&&!e.title&&window.AppState&&window.AppState.entityStates&&this.autoPopulateTitleFromEntity(e.id,a)},e),this.addCheckbox("Text Sensor (string value)",t.is_text_sensor||!1,a=>o("is_text_sensor",a)),this.addHint("Enable if entity returns text instead of numbers."),this.addCheckbox("Local / On-Device Sensor",!!t.is_local_sensor,a=>o("is_local_sensor",a)),this.addHint("Use internal battery_level/signal sensor."),this.addLabeledInputWithPicker("Secondary Entity ID","text",e.entity_id_2||"",a=>{h.updateWidget(e.id,{entity_id_2:a})},e),this.addLabeledInput("Title/Label","text",e.title||"",a=>{h.updateWidget(e.id,{title:a})}),this.endSection(),this.createSection("Format",!1),this.addSelect("Display Format",t.value_format||"label_value",[{value:"label_value",label:"Label: Value & Unit"},{value:"label_value_no_unit",label:"Label: Value Only"},{value:"label_newline_value",label:"Label [newline] Value & Unit"},{value:"label_newline_value_no_unit",label:"Label [newline] Value Only"},{value:"value_only",label:"Value & Unit"},{value:"value_only_no_unit",label:"Value Only"}],a=>o("value_format",a)),this.addLabeledInput("Precision","number",t.precision!==void 0?t.precision:2,a=>o("precision",parseInt(a,10))),this.addLabeledInputWithDataList("Prefix","text",t.prefix||"",["â¬","$","Â£","Â¥","CHF","kr"],a=>o("prefix",a)),this.addLabeledInputWithDataList("Postfix","text",t.postfix||"",[" kWh"," W"," V"," A"," Â°C"," %"," ppm"," lx"],a=>o("postfix",a)),this.addLabeledInput("Unit (Manual helper)","text",t.unit||"",a=>o("unit",a)),this.addCheckbox("Hide default unit",t.hide_unit||!1,a=>o("hide_unit",a)),this.endSection(),this.createSection("Appearance",!0),this.addNumberWithSlider("Opacity (%)",t.opacity!==void 0?t.opacity:100,0,100,a=>{o("opacity",a)}),this.addCompactPropertyRow(()=>{this.addLabeledInput("Label Size","number",t.label_font_size||14,a=>o("label_font_size",parseInt(a,10))),this.addLabeledInput("Value Size","number",t.value_font_size||20,a=>o("value_font_size",parseInt(a,10)))}),this.addColorSelector("Color",t.color||"black",n,a=>o("color",a));const s=["Roboto","Inter","Open Sans","Lato","Montserrat","Poppins","Raleway","Roboto Mono","Ubuntu","Nunito","Playfair Display","Merriweather","Work Sans","Source Sans Pro","Quicksand","Custom..."],r=t.font_family||"Roboto",l=!s.slice(0,-1).includes(r);this.addSelect("Font",l?"Custom...":r,s,a=>{a!=="Custom..."?(o("font_family",a),o("custom_font_family","")):o("font_family","Custom...")}),(l||t.font_family==="Custom...")&&(this.addLabeledInput("Custom Font Name","text",t.custom_font_family||(l?r:""),a=>{o("font_family",a||"Roboto"),o("custom_font_family",a)}),this.addHint('Browse <a href="https://fonts.google.com" target="_blank">fonts.google.com</a>')),this.addSelect("Weight",t.font_weight||400,[100,200,300,400,500,600,700,800,900],a=>o("font_weight",parseInt(a,10))),this.addCheckbox("Italic",t.italic||!1,a=>o("italic",a));const c=["TOP_LEFT","TOP_CENTER","TOP_RIGHT","CENTER_LEFT","CENTER","CENTER_RIGHT","BOTTOM_LEFT","BOTTOM_CENTER","BOTTOM_RIGHT"];this.addSelect("Align",t.text_align||"TOP_LEFT",c,a=>{o("text_align",a),o("label_align",a),o("value_align",a)}),this.endSection()}else if(i==="datetime"){this.createSection("Appearance",!0),this.addLabeledInput("Opacity (%)","number",t.opacity!==void 0?t.opacity:100,a=>{o("opacity",parseInt(a,10))}),this.addSelect("Display Format",t.format||"time_date",["time_date","time_only","date_only","weekday_day_month"],a=>o("format",a)),this.addLabeledInput("Time Font Size","number",t.time_font_size||28,a=>o("time_font_size",parseInt(a,10))),this.addLabeledInput("Date Font Size","number",t.date_font_size||16,a=>o("date_font_size",parseInt(a,10))),this.addColorSelector("Color",t.color||"black",n,a=>o("color",a));const s=["Roboto","Inter","Open Sans","Lato","Montserrat","Poppins","Raleway","Roboto Mono","Ubuntu","Nunito","Playfair Display","Merriweather","Work Sans","Source Sans Pro","Quicksand","Custom..."],r=t.font_family||"Roboto",l=!s.slice(0,-1).includes(r);this.addSelect("Font",l?"Custom...":r,s,a=>{a!=="Custom..."?(o("font_family",a),o("custom_font_family","")):o("font_family","Custom...")}),(l||t.font_family==="Custom...")&&(this.addLabeledInput("Custom Font Name","text",t.custom_font_family||(l?r:""),a=>{o("font_family",a||"Roboto"),o("custom_font_family",a)}),this.addHint('Browse <a href="https://fonts.google.com" target="_blank">fonts.google.com</a>')),this.addCheckbox("Italic",t.italic||!1,a=>o("italic",a));const c=["TOP_LEFT","TOP_CENTER","TOP_RIGHT","CENTER_LEFT","CENTER","CENTER_RIGHT","BOTTOM_LEFT","BOTTOM_CENTER","BOTTOM_RIGHT"];this.addSelect("Align",t.text_align||"CENTER",c,a=>o("text_align",a)),this.endSection()}else if(i==="progress_bar")this.createSection("Data Source",!0),this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",s=>{h.updateWidget(e.id,{entity_id:s}),s&&!e.title&&window.AppState&&window.AppState.entityStates&&this.autoPopulateTitleFromEntity(e.id,s)},e),this.addCheckbox("Local / On-Device Sensor",!!t.is_local_sensor,s=>o("is_local_sensor",s)),this.addHint("Use internal battery_level/signal sensor."),this.addLabeledInput("Title/Label","text",e.title||"",s=>{h.updateWidget(e.id,{title:s})}),this.endSection(),this.createSection("Appearance",!0),this.addNumberWithSlider("Opacity (%)",t.opacity!==void 0?t.opacity:100,0,100,s=>{o("opacity",s)}),this.addCheckbox("Show Label",t.show_label!==!1,s=>o("show_label",s)),this.addCheckbox("Show Percentage",t.show_percentage!==!1,s=>o("show_percentage",s)),this.addCompactPropertyRow(()=>{this.addLabeledInput("Bar H","number",t.bar_height||15,s=>{const r=parseInt(s,10);o("bar_height",isNaN(r)?15:r)}),this.addLabeledInput("Border W","number",t.border_width||1,s=>{const r=parseInt(s,10);o("border_width",isNaN(r)?1:r)})}),this.addColorSelector("Color",t.color||"black",n,s=>o("color",s)),this.endSection();else if(i==="graph")this.createSection("Data Source",!0),this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",s=>{h.updateWidget(e.id,{entity_id:s})},e),this.addLabeledInput("Title","text",e.title||"",s=>{h.updateWidget(e.id,{title:s})}),this.addLabeledInput("Duration","text",t.duration||"1h",s=>o("duration",s)),this.endSection(),this.createSection("Appearance",!0),this.addColorSelector("Line Color",t.color||"black",n,s=>o("color",s)),this.addSelect("Line Type",t.line_type||"SOLID",["SOLID","DASHED","DOTTED"],s=>o("line_type",s)),this.addLabeledInput("Line Thickness","number",t.line_thickness||3,s=>o("line_thickness",parseInt(s,10))),this.addCheckbox("Show Border",t.border!==!1,s=>o("border",s)),this.addCheckbox("Show Grid",t.grid!==!1,s=>o("grid",s)),this.addLabeledInput("X Grid Interval","text",t.x_grid||"1h",s=>o("x_grid",s)),this.addLabeledInput("Y Grid Step","text",t.y_grid||"auto",s=>o("y_grid",s)),this.addCompactPropertyRow(()=>{this.addLabeledInput("Min Value","number",t.min_value||"",s=>o("min_value",s)),this.addLabeledInput("Max Value","number",t.max_value||"",s=>o("max_value",s))}),this.endSection();else if(i==="icon")this.createSection("Appearance",!0),this.addCheckbox("Fit icon to frame",t.fit_icon_to_frame||!1,s=>o("fit_icon_to_frame",s)),this.addIconPicker("Select Icon",t.code||"F07D0",s=>o("code",s),e),this.addLabeledInput("Icon Size (px)","number",t.size||40,s=>{let r=parseInt(s||"40",10);(Number.isNaN(r)||r<8)&&(r=8),r>260&&(r=260),o("size",r)}),this.addSelect("Font Reference",t.font_ref||"font_mdi_medium",["font_mdi_medium","font_mdi_large"],s=>o("font_ref",s)),this.addColorSelector("Color",t.color||"black",n,s=>o("color",s)),this.endSection();else if(i==="battery_icon")this.createSection("Data Source",!0),this.addLabeledInputWithPicker("Battery Entity ID","text",e.entity_id||"",s=>{h.updateWidget(e.id,{entity_id:s})},e),this.addCheckbox("Local / On-Device Sensor",!!t.is_local_sensor,s=>o("is_local_sensor",s)),this.endSection(),this.createSection("Appearance",!0),this.addCheckbox("Fit icon to frame",t.fit_icon_to_frame||!1,s=>o("fit_icon_to_frame",s)),this.addLabeledInput("Icon Size (px)","number",t.size||48,s=>{let r=parseInt(s||"48",10);(Number.isNaN(r)||r<16)&&(r=16),r>200&&(r=200),o("size",r)}),this.addLabeledInput("Percentage Font Size (px)","number",t.font_size||12,s=>{let r=parseInt(s||"12",10);(Number.isNaN(r)||r<8)&&(r=8),r>100&&(r=100),o("font_size",r)}),this.addColorSelector("Color",t.color||"black",n,s=>o("color",s)),this.endSection();else if(i==="wifi_signal")this.createSection("Data Source",!0),this.addLabeledInputWithPicker("WiFi Signal Entity ID","text",e.entity_id||"",s=>{h.updateWidget(e.id,{entity_id:s})},e),this.addCheckbox("Local / On-Device Sensor",t.is_local_sensor!==!1,s=>o("is_local_sensor",s)),this.endSection(),this.createSection("Appearance",!0),this.addCheckbox("Show dBm value",t.show_dbm!==!1,s=>o("show_dbm",s)),this.addCheckbox("Fit icon to frame",t.fit_icon_to_frame||!1,s=>o("fit_icon_to_frame",s)),this.addLabeledInput("Icon Size (px)","number",t.size||24,s=>{let r=parseInt(s||"24",10);(Number.isNaN(r)||r<16)&&(r=16),r>200&&(r=200),o("size",r)}),this.addLabeledInput("dBm Font Size (px)","number",t.font_size||12,s=>{let r=parseInt(s||"12",10);(Number.isNaN(r)||r<8)&&(r=8),r>100&&(r=100),o("font_size",r)}),this.addColorSelector("Color",t.color||"black",n,s=>o("color",s)),this.endSection();else if(i==="ondevice_temperature"){this.createSection("Data Source",!0),this.addLabeledInputWithPicker("Temperature Entity ID","text",e.entity_id||"",l=>{h.updateWidget(e.id,{entity_id:l})},e),this.addCheckbox("Local / On-Device Sensor",t.is_local_sensor!==!1,l=>o("is_local_sensor",l));let s=!1;const r=h.getSelectedProfile();r&&r.features&&(s=!!(r.features.sht4x||r.features.sht3x||r.features.shtc3)),t.is_local_sensor!==!1&&!s&&(this.addHint('â ï¸ <span style="color:orange">This hardware profile has no onboard temperature sensor.</span><br/>Uncheck this or select an HA entity.'),e.props&&e.props.is_local_sensor===void 0&&setTimeout(()=>o("is_local_sensor",!1),0)),this.endSection(),this.createSection("Appearance",!0),this.addCheckbox("Fit icon to frame",t.fit_icon_to_frame||!1,l=>o("fit_icon_to_frame",l)),this.addCheckbox("Show Label",t.show_label!==!1,l=>o("show_label",l)),this.addLabeledInput("Icon Size (px)","number",t.size||32,l=>{let c=parseInt(l||"32",10);(Number.isNaN(c)||c<16)&&(c=16),c>200&&(c=200),o("size",c)}),this.addLabeledInput("Value Font Size (px)","number",t.font_size||16,l=>{let c=parseInt(l||"16",10);(Number.isNaN(c)||c<8)&&(c=8),c>200&&(c=200),o("font_size",c)}),this.addLabeledInput("Label Font Size (px)","number",t.label_font_size||10,l=>{let c=parseInt(l||"10",10);(Number.isNaN(c)||c<8)&&(c=8),c>100&&(c=100),o("label_font_size",c)}),this.addSelect("Unit",t.unit||"Â°C",["Â°C","Â°F"],l=>o("unit",l)),this.addLabeledInput("Precision","number",t.precision??1,l=>o("precision",parseInt(l,10))),this.addColorSelector("Color",t.color||"black",n,l=>o("color",l)),this.endSection()}else if(i==="ondevice_humidity"){this.createSection("Data Source",!0),this.addLabeledInputWithPicker("Humidity Entity ID","text",e.entity_id||"",l=>{h.updateWidget(e.id,{entity_id:l})},e),this.addCheckbox("Local / On-Device Sensor",t.is_local_sensor!==!1,l=>o("is_local_sensor",l));let s=!1;const r=h.getSelectedProfile();r&&r.features&&(s=!!(r.features.sht4x||r.features.sht3x||r.features.shtc3)),t.is_local_sensor!==!1&&!s&&(this.addHint('â ï¸ <span style="color:orange">This hardware profile has no onboard humidity sensor.</span><br/>Uncheck this or select an HA entity.'),e.props&&e.props.is_local_sensor===void 0&&setTimeout(()=>o("is_local_sensor",!1),0)),this.endSection(),this.createSection("Appearance",!0),this.addCheckbox("Fit icon to frame",t.fit_icon_to_frame||!1,l=>o("fit_icon_to_frame",l)),this.addCheckbox("Show Label",t.show_label!==!1,l=>o("show_label",l)),this.addLabeledInput("Icon Size (px)","number",t.size||32,l=>{let c=parseInt(l||"32",10);(Number.isNaN(c)||c<16)&&(c=16),c>200&&(c=200),o("size",c)}),this.addLabeledInput("Value Font Size (px)","number",t.font_size||16,l=>{let c=parseInt(l||"16",10);(Number.isNaN(c)||c<8)&&(c=8),c>200&&(c=200),o("font_size",c)}),this.addLabeledInput("Label Font Size (px)","number",t.label_font_size||10,l=>{let c=parseInt(l||"10",10);(Number.isNaN(c)||c<8)&&(c=8),c>100&&(c=100),o("label_font_size",c)}),this.addLabeledInput("Unit","text",t.unit||"%",l=>o("unit",l)),this.addLabeledInput("Precision","number",t.precision??0,l=>o("precision",parseInt(l,10))),this.addColorSelector("Color",t.color||"black",n,l=>o("color",l)),this.endSection()}else if(i==="weather_icon")this.createSection("Data Source",!0),this.addLabeledInputWithPicker("Weather Entity ID","text",e.entity_id||t.weather_entity||"weather.forecast_home",s=>{h.updateWidget(e.id,{entity_id:s})},e),this.endSection(),this.createSection("Appearance",!0),this.addCheckbox("Fit icon to frame",t.fit_icon_to_frame||!1,s=>o("fit_icon_to_frame",s)),this.addLabeledInput("Icon Size (px)","number",t.size||48,s=>{let r=parseInt(s||"48",10);(Number.isNaN(r)||r<8)&&(r=8),r>260&&(r=260),o("size",r)}),this.addColorSelector("Color",t.color||"black",n,s=>o("color",s)),this.endSection();else if(i==="weather_forecast"){this.createSection("Data Source",!0),this.addLabeledInputWithPicker("Weather Entity ID","text",e.entity_id||t.weather_entity||"weather.forecast_home",c=>{h.updateWidget(e.id,{entity_id:c})},e),this.endSection(),this.createSection("Appearance",!0),this.addSelect("Layout",t.layout||"horizontal",["horizontal","vertical"],c=>o("layout",c)),this.addCheckbox("Show High/Low Temp",t.show_high_low!==!1,c=>o("show_high_low",c)),this.addSelect("Temperature Unit",t.temp_unit||"C",["C","F"],c=>o("temp_unit",c)),this.addLabeledInput("Day Font Size","number",t.day_font_size||14,c=>o("day_font_size",parseInt(c,10))),this.addLabeledInput("Temp Font Size","number",t.temp_font_size||14,c=>o("temp_font_size",parseInt(c,10))),this.addLabeledInput("Icon Size","number",t.icon_size||24,c=>o("icon_size",parseInt(c,10)));const s=["Roboto","Inter","Open Sans","Lato","Montserrat","Poppins","Raleway","Roboto Mono","Ubuntu","Nunito","Playfair Display","Merriweather","Work Sans","Source Sans Pro","Quicksand","Custom..."],r=t.font_family||"Roboto",l=!s.slice(0,-1).includes(r);this.addSelect("Font",l?"Custom...":r,s,c=>{c!=="Custom..."?(o("font_family",c),o("custom_font_family","")):o("font_family","Custom...")}),(l||t.font_family==="Custom...")&&(this.addLabeledInput("Custom Font Name","text",t.custom_font_family||(l?r:""),c=>{o("font_family",c||"Roboto"),o("custom_font_family",c)}),this.addHint('Browse <a href="https://fonts.google.com" target="_blank">fonts.google.com</a>')),this.addColorSelector("Color",t.color||"black",n,c=>o("color",c)),this.addCheckbox("Show Border",t.show_border!==!1,c=>o("show_border",c)),t.show_border!==!1&&(this.addLabeledInput("Border Width","number",t.border_width!==void 0?t.border_width:1,c=>o("border_width",parseInt(c,10))),this.addColorSelector("Border Color",t.border_color||"black",n,c=>o("border_color",c))),this.addColorSelector("Background Color",t.background_color||"transparent",n,c=>o("background_color",c)),this.endSection()}else if(i==="template_sensor_bar")this.createSection("Sensor Visibility",!0),this.addCheckbox("Show WiFi",t.show_wifi!==!1,s=>o("show_wifi",s)),this.addCheckbox("Show Temperature",t.show_temperature!==!1,s=>o("show_temperature",s)),this.addCheckbox("Show Humidity",t.show_humidity!==!1,s=>o("show_humidity",s)),this.addCheckbox("Show Battery",t.show_battery!==!1,s=>o("show_battery",s)),this.endSection(),this.createSection("Sensor Data Sources",!1),this.addLabeledInput("WiFi Entity","text",t.wifi_entity||"",s=>o("wifi_entity",s)),this.addLabeledInput("Temp Entity","text",t.temp_entity||"",s=>o("temp_entity",s)),this.addSelect("Temperature Unit",t.temp_unit||"Â°C",["Â°C","Â°F"],s=>o("temp_unit",s)),this.addLabeledInput("Hum Entity","text",t.hum_entity||"",s=>o("hum_entity",s)),this.addLabeledInput("Battery Entity","text",t.bat_entity||"",s=>o("bat_entity",s)),this.endSection(),this.createSection("Appearance",!0),this.addCheckbox("Show Background",t.show_background!==!1,s=>o("show_background",s)),t.show_background!==!1&&(this.addColorSelector("Background Color",t.background_color||"black",n,s=>{o("background_color",s);const r=["black","gray","grey","#000000","#808080"],l=["white","#ffffff","#fff"],c=t.color||"white";r.includes(s.toLowerCase())&&r.includes(c.toLowerCase())?o("color","white"):l.includes(s.toLowerCase())&&l.includes(c.toLowerCase())&&o("color","black")}),this.addLabeledInput("Border Radius","number",t.border_radius||8,s=>o("border_radius",parseInt(s,10))),this.addLabeledInput("Border Thickness","number",t.border_thickness||0,s=>o("border_thickness",parseInt(s,10))),this.addColorSelector("Border Color",t.border_color||"white",n,s=>o("border_color",s))),this.endSection(),this.createSection("Sizes & Color",!1),this.addLabeledInput("Icon Size","number",t.icon_size||20,s=>o("icon_size",parseInt(s,10))),this.addLabeledInput("Font Size","number",t.font_size||14,s=>o("font_size",parseInt(s,10))),this.addColorSelector("Foreground Color",t.color||"white",n,s=>o("color",s)),this.endSection();else if(i==="template_nav_bar")this.createSection("Button Visibility",!0),this.addCheckbox("Show Previous",t.show_prev!==!1,s=>o("show_prev",s)),this.addCheckbox("Show Home",t.show_home!==!1,s=>o("show_home",s)),this.addCheckbox("Show Next",t.show_next!==!1,s=>o("show_next",s)),this.endSection(),this.createSection("Appearance",!0),this.addCheckbox("Show Background",t.show_background!==!1,s=>o("show_background",s)),t.show_background!==!1&&(this.addColorSelector("Background Color",t.background_color||"black",n,s=>{o("background_color",s);const r=["black","gray","grey","#000000","#808080"],l=["white","#ffffff","#fff"],c=t.color||"white";r.includes(s.toLowerCase())&&r.includes(c.toLowerCase())?o("color","white"):l.includes(s.toLowerCase())&&l.includes(c.toLowerCase())&&o("color","black")}),this.addLabeledInput("Border Radius","number",t.border_radius||8,s=>o("border_radius",parseInt(s,10))),this.addLabeledInput("Border Thickness","number",t.border_thickness||0,s=>o("border_thickness",parseInt(s,10))),this.addColorSelector("Border Color",t.border_color||"white",n,s=>o("border_color",s))),this.endSection(),this.createSection("Sizes & Color",!1),this.addLabeledInput("Icon Size","number",t.icon_size||24,s=>o("icon_size",parseInt(s,10))),this.addColorSelector("Foreground Color",t.color||"white",n,s=>o("color",s)),this.endSection();else if(i==="touch_area"||i==="nav_next_page"||i==="nav_previous_page"||i==="nav_reload_page"){this.createSection("Action",!0),this.addSelect("Navigation Action",t.nav_action||"none",[{value:"none",label:"None (Entity Toggle)"},{value:"next_page",label:"Next Page"},{value:"previous_page",label:"Previous Page"},{value:"reload_page",label:"Reload Page"}],c=>{o("nav_action",c),(t.icon==="F0142"||t.icon==="F0141"||t.icon==="F0450"||!t.icon)&&(c==="next_page"?o("icon","F0142"):c==="previous_page"?o("icon","F0141"):c==="reload_page"&&o("icon","F0450"))}),(t.nav_action||"none")==="none"&&this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",c=>{h.updateWidget(e.id,{entity_id:c})},e),this.endSection(),this.createSection("Content",!0),this.addLabeledInput("Title","text",t.title||"",c=>o("title",c)),this.addIconPicker("Normal Icon",t.icon||"",c=>o("icon",c),e),this.addIconPicker("Pressed Icon",t.icon_pressed||"",c=>o("icon_pressed",c),e),this.addLabeledInput("Icon Size","number",t.icon_size||40,c=>o("icon_size",parseInt(c,10))),this.addColorSelector("Icon Color",t.icon_color||"black",n,c=>o("icon_color",c)),this.endSection(),this.createSection("Appearance",!0);const s=t.color||"rgba(0, 0, 255, 0.2)";let r="#0000ff",l=.2;if(s.startsWith("#"))r=s,l=1;else if(s.startsWith("rgba")){const c=s.match(/([\d\.]+)/g);if(c&&c.length>=4){const a=parseInt(c[0]),u=parseInt(c[1]),g=parseInt(c[2]);l=parseFloat(c[3]),r="#"+((1<<24)+(a<<16)+(u<<8)+g).toString(16).slice(1)}}this.addLabeledInput("Preview Color","color",r,c=>{const a=parseInt(c.slice(1,3),16),u=parseInt(c.slice(3,5),16),g=parseInt(c.slice(5,7),16);o("color",`rgba(${a}, ${u}, ${g}, ${l})`),o("border_color",c)}),this.addLabeledInput("Opacity (0.0 - 1.0)","number",l,c=>{let a=parseFloat(c);a<0&&(a=0),a>1&&(a=1);const u=parseInt(r.slice(1,3),16),g=parseInt(r.slice(3,5),16),m=parseInt(r.slice(5,7),16);o("color",`rgba(${u}, ${g}, ${m}, ${a})`)}),this.addColorSelector("Border Color",t.border_color||"#0000ff",n,c=>o("border_color",c)),this.endSection()}else if(i==="image"){this.createSection("Content",!0),this.addHint("ð¼ï¸ Static image from ESPHome:<br/><code style='background:#f0f0f0;padding:2px 4px;border-radius:2px;'>/config/esphome/images/logo.png</code><br/><span style='color:#4a9eff;'>â¹ï¸ Place images in /config/esphome/images/ folder</span>"),this.addLabeledInput("Image Path","text",t.path||"",c=>o("path",c)),this.endSection(),this.createSection("Appearance",!0),t.invert===void 0&&o("invert",Ie()==="reterminal_e1001"),this.addCheckbox("Invert colors",t.invert||!1,c=>o("invert",c)),this.addSelect("Render Mode",t.render_mode||"Auto",["Auto","Binary","Grayscale","Color (RGB565)"],c=>o("render_mode",c));const s=document.createElement("div");s.className="field",s.style.marginTop="12px";const r=e.x===0&&e.y===0&&e.width===800&&e.height===480,l=document.createElement("button");l.className="btn "+(r?"btn-primary":"btn-secondary")+" btn-full",l.textContent=r?"â Full Screen (click to restore)":"â¶ Fill Screen",l.type="button",l.addEventListener("click",()=>{r?h.updateWidget(e.id,{x:50,y:50,width:200,height:150}):h.updateWidget(e.id,{x:0,y:0,width:800,height:480})}),s.appendChild(l),this.getContainer().appendChild(s),this.endSection()}else if(i==="online_image"){this.createSection("Content",!0),this.addHint("ð¡ Fetch remote images dynamically (Puppet support):<br/><code style='background:#f0f0f0;padding:2px 4px;border-radius:2px;'>https://example.com/camera/snapshot.jpg </code><br/><span style='color:#4a9eff;'>â¹ï¸ Images are downloaded at specified intervals</span>"),this.addLabeledInput("Remote URL","text",t.url||"",c=>o("url",c)),this.addLabeledInput("Update interval (seconds)","number",t.interval_s||300,c=>o("interval_s",parseInt(c,10))),this.endSection(),this.createSection("Appearance",!0),t.invert===void 0&&o("invert",Ie()==="reterminal_e1001"),this.addCheckbox("Invert colors",t.invert||!1,c=>o("invert",c)),this.addSelect("Render Mode",t.render_mode||"Auto",["Auto","Binary","Grayscale","Color (RGB565)"],c=>o("render_mode",c));const s=document.createElement("div");s.className="field",s.style.marginTop="12px";const r=e.x===0&&e.y===0&&e.width===800&&e.height===480,l=document.createElement("button");l.className="btn "+(r?"btn-primary":"btn-secondary")+" btn-full",l.textContent=r?"â Full Screen (click to restore)":"â¶ Fill Screen",l.type="button",l.addEventListener("click",()=>{r?h.updateWidget(e.id,{x:50,y:50,width:200,height:150}):h.updateWidget(e.id,{x:0,y:0,width:800,height:480})}),s.appendChild(l),this.getContainer().appendChild(s),this.endSection()}else if(i==="qr_code")this.createSection("Content",!0),this.addHint("ð± Generate QR codes that can be scanned by phones/tablets"),this.addLabeledInput("QR Content","text",t.value||"https://esphome.io",s=>o("value",s)),this.addHint("Enter a URL, text, or any string to encode"),this.endSection(),this.createSection("Appearance",!0),this.addLabeledInput("Scale","number",t.scale||2,s=>{let r=parseInt(s||"2",10);(Number.isNaN(r)||r<1)&&(r=1),r>10&&(r=10),o("scale",r)}),this.addHint("Size multiplier (1-10). Larger = bigger QR code"),this.addSelect("Error Correction",t.ecc||"LOW",["LOW","MEDIUM","QUARTILE","HIGH"],s=>o("ecc",s)),this.addHint("Higher = more redundancy, can recover from damage"),this.addSelect("Color",t.color||"black",["black","white"],s=>o("color",s)),this.endSection();else if(i==="quote_rss"){this.createSection("Feed Settings",!0),this.addHint("ð° Display quotes from an RSS feed (Quote of the Day)"),this.addLabeledInput("Feed URL","text",t.feed_url||"https://www.brainyquote.com/link/quotebr.rss",u=>o("feed_url",u)),this.addHint("Enter any RSS feed URL. Default: BrainyQuote daily quotes"),this.addCheckbox("Show Author",t.show_author!==!1,u=>o("show_author",u)),this.addCheckbox("Random Quote",t.random!==!1,u=>o("random",u)),this.addHint("Pick a random quote from the feed, or use the first one");const s=["15min","30min","1h","2h","4h","8h","12h","24h"];this.addSelect("Refresh Interval",t.refresh_interval||"24h",s,u=>o("refresh_interval",u)),this.addLabeledInput("Home Assistant URL","text",t.ha_url||"http://homeassistant.local:8123",u=>o("ha_url",u)),this.addHint("Address of your Home Assistant instance (for Proxy)"),this.endSection(),this.createSection("Typography",!1),this.addLabeledInput("Quote Text Size (Line 1)","number",t.quote_font_size||18,u=>o("quote_font_size",parseInt(u,10))),this.addLabeledInput("Author Size (Line 2)","number",t.author_font_size||14,u=>o("author_font_size",parseInt(u,10)));const r=["Roboto","Inter","Open Sans","Lato","Montserrat","Poppins","Raleway","Roboto Mono","Ubuntu","Nunito","Playfair Display","Merriweather","Work Sans","Source Sans Pro","Quicksand","Custom..."],l=t.font_family||"Roboto",c=!r.slice(0,-1).includes(l);this.addSelect("Font",c?"Custom...":l,r,u=>{u!=="Custom..."?(o("font_family",u),o("custom_font_family","")):o("font_family","Custom...")}),(c||t.font_family==="Custom...")&&(this.addLabeledInput("Custom Font Name","text",t.custom_font_family||(c?l:""),u=>{o("font_family",u||"Roboto"),o("custom_font_family",u)}),this.addHint('Browse <a href="https://fonts.google.com" target="_blank">fonts.google.com</a>')),this.addSelect("Weight",t.font_weight||400,[100,200,300,400,500,600,700,800,900],u=>o("font_weight",parseInt(u,10)));const a=["TOP_LEFT","TOP_CENTER","TOP_RIGHT","CENTER_LEFT","CENTER","CENTER_RIGHT","BOTTOM_LEFT","BOTTOM_CENTER","BOTTOM_RIGHT"];this.addSelect("Align",t.text_align||"TOP_LEFT",a,u=>o("text_align",u)),this.addColorSelector("Color",t.color||"black",n,u=>o("color",u)),this.endSection(),this.createSection("Display Options",!1),this.addCheckbox("Word Wrap",t.word_wrap!==!1,u=>o("word_wrap",u)),this.addCheckbox("Auto Scale Text",t.auto_scale||!1,u=>o("auto_scale",u)),this.addHint("Automatically reduce font size if text is too long"),this.addCheckbox("Italic Quote",t.italic_quote!==!1,u=>o("italic_quote",u)),this.endSection()}else if(i==="calendar"){this.createSection("Appearance",!0),this.addColorSelector("Text Color",t.text_color||"black",n,l=>o("text_color",l)),this.addColorSelector("Border Color",t.border_color||"black",n,l=>o("border_color",l)),this.addColorSelector("Background",t.background_color||"white",n,l=>o("background_color",l)),this.addLabeledInput("Border Width","number",t.border_width||2,l=>o("border_width",parseInt(l,10))),this.addCheckbox("Show Border",t.show_border!==!1,l=>o("show_border",l)),this.endSection(),this.createSection("Font Sizes",!1),this.addLabeledInput("Big Date Size","number",t.font_size_date||100,l=>o("font_size_date",parseInt(l,10))),this.addLabeledInput("Day Name Size","number",t.font_size_day||24,l=>o("font_size_day",parseInt(l,10))),this.addLabeledInput("Grid Text Size","number",t.font_size_grid||14,l=>o("font_size_grid",parseInt(l,10))),this.addLabeledInput("Event Text Size","number",t.font_size_event||18,l=>o("font_size_event",parseInt(l,10))),this.endSection(),this.createSection("Data Source",!0),this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"sensor.esp_calendar_data",l=>{h.updateWidget(e.id,{entity_id:l})},e),this.addLabeledInput("Max Events","number",t.max_events||8,l=>o("max_events",parseInt(l,10))),this.addHint("Must be a sensor with attribute 'entries'");const s=document.createElement("button");s.className="btn btn-secondary btn-full btn-xs",s.textContent="Download Helper Script",s.style.marginTop="10px",s.addEventListener("click",()=>{const l=document.createElement("a");l.setAttribute("href","data:text/x-python;charset=utf-8,"+encodeURIComponent(rs)),l.setAttribute("download","esp_calendar_data_conversion.py"),l.style.display="none",document.body.appendChild(l),l.click(),document.body.removeChild(l)}),this.getContainer().appendChild(s),this.addHint("Place in /config/python_scripts/");const r=document.createElement("div");r.style.marginTop="5px",r.style.fontSize="10px",r.style.color="#888",r.style.textAlign="center",r.innerText="Check widget instructions for HA setup.",this.getContainer().appendChild(r),this.endSection()}else if(i==="puppet")this.createSection("Content",!0),this.addLabeledInput("File path / URL","text",t.image_url||"",s=>o("image_url",s)),this.addHint('Tip: Use mdi:icon-name for Material Design Icons. <br><b>Important:</b> Ensure `materialdesignicons - webfont.ttf` is in your ESPHome `fonts / ` folder. <a href="https://pictogrammers.com/library/mdi/" target="_blank" style="color: #52c7ea">MDI Library</a>'),this.endSection(),this.createSection("Appearance",!0),this.addSelect("Image type",t.image_type||"RGB565",["RGB565","RGB","GRAYSCALE","BINARY"],s=>o("image_type",s)),this.addHint("RGB565=2B/px, RGB=3B/px, GRAYSCALE=1B/px, BINARY=1bit/px"),this.addSelect("Transparency",t.transparency||"opaque",["opaque","chroma_key","alpha_channel"],s=>o("transparency",s)),this.addHint("opaque=no transparency, chroma_key=color key, alpha_channel=smooth blend"),this.endSection();else if(i==="lvgl_label"||i.startsWith("lvgl_")){if(this.addCommonLVGLProperties(e,t),this.createSection("Widget Settings",!0),i==="lvgl_label"){this.addLabeledInput("Text","text",t.text||"Label",a=>o("text",a)),this.addLabeledInput("Font Size","number",t.font_size||20,a=>o("font_size",parseInt(a,10))),this.addColorMixer("Text Color",t.color||"black",a=>o("color",a)),this.addColorMixer("Background Color",t.bg_color||"transparent",a=>o("bg_color",a));const s=["Roboto","Inter","Open Sans","Lato","Montserrat","Poppins","Raleway","Roboto Mono","Ubuntu","Nunito","Playfair Display","Merriweather","Work Sans","Source Sans Pro","Quicksand","Custom..."],r=t.font_family||"Roboto",l=!s.slice(0,-1).includes(r);this.addSelect("Font",l?"Custom...":r,s,a=>{a!=="Custom..."?o("font_family",a):o("font_family","Custom...")}),this.addSelect("Weight",t.font_weight||400,[100,200,300,400,500,600,700,800,900],a=>o("font_weight",parseInt(a,10))),this.addCheckbox("Italic",t.italic||!1,a=>o("italic",a));const c=["TOP_LEFT","TOP_CENTER","TOP_RIGHT","CENTER_LEFT","CENTER","CENTER_RIGHT","BOTTOM_LEFT","BOTTOM_CENTER","BOTTOM_RIGHT"];this.addSelect("Align",t.text_align||"CENTER",c,a=>o("text_align",a))}else if(i==="lvgl_line"){const s=t.orientation||"horizontal";this.addSelect("Orientation",s,["horizontal","vertical"],m=>{const f=e.width,y=e.height;h.updateWidget(e.id,{props:{...t,orientation:m},width:y,height:f})}),this.addLabeledInput("Line Width","number",t.line_width||3,m=>o("line_width",parseInt(m,10))),this.addColorMixer("Line Color",t.line_color||t.color||"black",m=>o("line_color",m)),this.addCheckbox("Rounded Ends",t.line_rounded!==!1,m=>o("line_rounded",m)),this.addLabeledInput("Opacity (0-255)","number",t.opa||255,m=>o("opa",parseInt(m,10))),this.createSection("Quick Size",!1);const r=document.createElement("div");r.style.display="flex",r.style.gap="8px",r.style.marginBottom="8px";const l=h.getCanvasDimensions(),c=l.width,a=l.height,u=document.createElement("button");u.className="btn btn-secondary",u.style.flex="1",u.textContent="â Fill Horizontal",u.addEventListener("click",()=>{const m=t.line_width||3;h.updateWidget(e.id,{x:0,y:e.y,width:c,height:m,props:{...t,orientation:"horizontal"}})});const g=document.createElement("button");g.className="btn btn-secondary",g.style.flex="1",g.textContent="â Fill Vertical",g.addEventListener("click",()=>{const m=t.line_width||3;h.updateWidget(e.id,{x:e.x,y:0,width:m,height:a,props:{...t,orientation:"vertical"}})}),r.appendChild(g),this.getContainer().appendChild(r),this.endSection()}else i==="lvgl_meter"?(this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",s=>{h.updateWidget(e.id,{entity_id:s})},e),this.createSection("Scale",!1),this.addLabeledInput("Min Value","number",t.min||0,s=>o("min",parseInt(s,10))),this.addLabeledInput("Max Value","number",t.max||100,s=>o("max",parseInt(s,10))),this.endSection(),this.createSection("Preview",!1),this.addLabeledInput("Value (Preview)","number",t.value!==void 0?t.value:60,s=>o("value",parseInt(s,10))),this.endSection(),this.createSection("Appearance",!1),this.addColorMixer("Scale Color",t.color||"black",s=>o("color",s)),this.addColorMixer("Needle Color",t.indicator_color||"red",s=>o("indicator_color",s)),this.addLabeledInput("Scale Width","number",t.scale_width||10,s=>o("scale_width",parseInt(s,10))),this.addLabeledInput("Needle Width","number",t.indicator_width||4,s=>o("indicator_width",parseInt(s,10))),this.addLabeledInput("Ticks","number",t.tick_count||11,s=>o("tick_count",parseInt(s,10))),this.addLabeledInput("Tick Length","number",t.tick_length||10,s=>o("tick_length",parseInt(s,10))),this.addLabeledInput("Label Gap","number",t.label_gap||10,s=>o("label_gap",parseInt(s,10))),this.endSection()):i==="lvgl_button"?(this.addLabeledInputWithPicker("Action Entity ID","text",e.entity_id||"",s=>{h.updateWidget(e.id,{entity_id:s})},e),this.addHint("Entity to toggle/trigger when clicked"),this.addLabeledInput("Text","text",t.text||"BTN",s=>o("text",s)),this.addColorMixer("Background Color",t.bg_color||"white",s=>o("bg_color",s)),this.addColorMixer("Text Color",t.color||"black",s=>o("color",s)),this.addLabeledInput("Border Width","number",t.border_width||2,s=>o("border_width",parseInt(s,10))),this.addLabeledInput("Corner Radius","number",t.radius||5,s=>o("radius",parseInt(s,10))),this.addCheckbox("Checkable (Toggle)",t.checkable||!1,s=>o("checkable",s))):i==="lvgl_arc"?(this.addLabeledInputWithPicker("Sensor Entity ID","text",e.entity_id||"",s=>{h.updateWidget(e.id,{entity_id:s})},e),this.addHint("Sensor to bind to arc value"),this.addLabeledInput("Title / Label","text",t.title||"",s=>{const r={...e.props,title:s};h.updateWidget(e.id,{props:r})}),this.addLabeledInput("Min Value","number",t.min||0,s=>o("min",parseInt(s,10))),this.addLabeledInput("Max Value","number",t.max||100,s=>o("max",parseInt(s,10))),this.addLabeledInput("Default/Preview Value","number",t.value||0,s=>o("value",parseInt(s,10))),this.addLabeledInput("Thickness","number",t.thickness||10,s=>o("thickness",parseInt(s,10))),this.addLabeledInput("Start Angle","number",t.start_angle||135,s=>o("start_angle",parseInt(s,10))),this.addLabeledInput("End Angle","number",t.end_angle||45,s=>o("end_angle",parseInt(s,10))),this.addSelect("Mode",t.mode||"NORMAL",["NORMAL","SYMMETRICAL","REVERSE"],s=>o("mode",s)),this.addColorMixer("Color",t.color||"blue",s=>o("color",s))):i==="lvgl_chart"?(this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",s=>{h.updateWidget(e.id,{entity_id:s})},e),this.addLabeledInput("Title","text",t.title||"",s=>o("title",s)),this.addSelect("Type",t.type||"LINE",["LINE","SCATTER","BAR"],s=>o("type",s)),this.addLabeledInput("Min Value","number",t.min||0,s=>o("min",parseInt(s,10))),this.addLabeledInput("Max Value","number",t.max||100,s=>o("max",parseInt(s,10))),this.addLabeledInput("Point Count","number",t.point_count||10,s=>o("point_count",parseInt(s,10))),this.addLabeledInput("X Div Lines","number",t.x_div_lines||3,s=>o("x_div_lines",parseInt(s,10))),this.addLabeledInput("Y Div Lines","number",t.y_div_lines||3,s=>o("y_div_lines",parseInt(s,10))),this.addColorMixer("Color",t.color||"black",s=>o("color",s))):i==="lvgl_img"?(this.addLabeledInput("Source (Image/Symbol)","text",t.src||"",s=>o("src",s)),this.addHint("e.g. symbol_ok, symbol_home, or /image.png"),this.addLabeledInput("Rotation (0.1 deg)","number",t.rotation||0,s=>o("rotation",parseInt(s,10))),this.addLabeledInput("Scale (256 = 1x)","number",t.scale||256,s=>o("scale",parseInt(s,10))),this.addColorMixer("Color (Tint)",t.color||"black",s=>o("color",s))):i==="lvgl_qrcode"?(this.createSection("Content",!0),this.addLabeledInput("Content / URL","text",t.text||"",s=>o("text",s)),this.addLabeledInput("Size (px)","number",t.size||100,s=>o("size",parseInt(s,10))),this.addColorMixer("Color",t.color||"black",s=>o("color",s)),this.addColorMixer("Background Color",t.bg_color||"white",s=>o("bg_color",s)),this.endSection()):i==="lvgl_bar"?(this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",s=>{h.updateWidget(e.id,{entity_id:s})},e),this.addLabeledInput("Min Value","number",t.min||0,s=>o("min",parseInt(s,10))),this.addLabeledInput("Max Value","number",t.max||100,s=>o("max",parseInt(s,10))),this.addLabeledInput("Preview Value","number",t.value||50,s=>o("value",parseInt(s,10))),this.addColorMixer("Bar Color",t.color||"black",s=>o("color",s)),this.addColorMixer("Background Color",t.bg_color||"gray",s=>o("bg_color",s)),this.addLabeledInput("Start Value","number",t.start_value||0,s=>o("start_value",parseInt(s,10))),this.addSelect("Mode",t.mode||"NORMAL",["NORMAL","SYMMETRICAL","REVERSE"],s=>o("mode",s)),this.addCheckbox("Range Mode",t.range_mode||!1,s=>o("range_mode",s))):i==="lvgl_slider"?(this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",s=>{h.updateWidget(e.id,{entity_id:s})},e),this.addHint("Controls this entity number/level"),this.addSegmentedControl("Orientation",[{value:"Horizontal",label:"Horiz",icon:"mdi-arrow-left-right"},{value:"Vertical",label:"Vert",icon:"mdi-arrow-up-down"}],t.vertical?"Vertical":"Horizontal",s=>{const r=s==="Vertical",l=e.width,c=e.height;h.updateWidget(e.id,{props:{...t,vertical:r},width:c,height:l})}),this.addCompactPropertyRow(()=>{this.addLabeledInput("Min","number",t.min||0,s=>o("min",parseInt(s,10))),this.addLabeledInput("Max","number",t.max||100,s=>o("max",parseInt(s,10)))}),this.addNumberWithSlider("Value",t.value||30,t.min||0,t.max||100,s=>o("value",s)),this.addColorMixer("Knob/Bar Color",t.color||"black",s=>o("color",s)),this.addColorMixer("Track Color",t.bg_color||"gray",s=>o("bg_color",s)),this.addLabeledInput("Border Width","number",t.border_width||2,s=>o("border_width",parseInt(s,10))),this.addSelect("Mode",t.mode||"NORMAL",["NORMAL","SYMMETRICAL","REVERSE"],s=>o("mode",s))):i==="lvgl_tabview"?(this.addLabeledInput("Tabs (comma separated)","text",(t.tabs||[]).join(", "),s=>{const r=s.split(",").map(l=>l.trim()).filter(l=>l);o("tabs",r)}),this.addColorMixer("Background Color",t.bg_color||"white",s=>o("bg_color",s))):i==="lvgl_tileview"?(this.addHint("Tiles are currently configured via YAML or advanced properties."),this.addColorMixer("Background Color",t.bg_color||"white",s=>o("bg_color",s))):i==="lvgl_led"?(this.addColorMixer("Color",t.color||"red",s=>o("color",s)),this.addLabeledInput("Brightness (0-255)","number",t.brightness||255,s=>o("brightness",parseInt(s,10)))):i==="lvgl_spinner"?(this.addLabeledInput("Spin Time (ms)","number",t.spin_time||1e3,s=>o("spin_time",parseInt(s,10))),this.addLabeledInput("Arc Length (deg)","number",t.arc_length||60,s=>o("arc_length",parseInt(s,10))),this.addColorMixer("Arc Color",t.arc_color||"blue",s=>o("arc_color",s)),this.addColorMixer("Track Color",t.track_color||"white",s=>o("track_color",s))):i==="lvgl_buttonmatrix"?(this.addHint("Edit rows via YAML or simple comma-separated lists per row."),t.rows):i==="lvgl_checkbox"?(this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",s=>{h.updateWidget(e.id,{entity_id:s})},e),this.addHint("Toggle input_boolean when tapped"),this.addLabeledInput("Label","text",t.text||"Checkbox",s=>o("text",s)),this.addCheckbox("Checked",t.checked||!1,s=>o("checked",s)),this.addColorMixer("Color",t.color||"blue",s=>o("color",s))):i==="lvgl_dropdown"?(this.addLabeledInput("Options (one per line)","textarea",t.options||"",s=>o("options",s)),this.addCompactPropertyRow(()=>{this.addLabeledInput("Index","number",t.selected_index||0,s=>o("selected_index",parseInt(s,10))),this.addLabeledInput("Max H","number",t.max_height||200,s=>o("max_height",parseInt(s,10)))}),this.addSegmentedControl("Direction",[{value:"DOWN",icon:"mdi-arrow-down"},{value:"UP",icon:"mdi-arrow-up"},{value:"LEFT",icon:"mdi-arrow-left"},{value:"RIGHT",icon:"mdi-arrow-right"}],t.direction||"DOWN",s=>o("direction",s)),this.addColorMixer("Color",t.color||"white",s=>o("color",s))):i==="lvgl_keyboard"?(this.addSelect("Mode",t.mode||"TEXT_UPPER",["TEXT_LOWER","TEXT_UPPER","SPECIAL","NUMBER"],s=>o("mode",s)),this.addLabeledInput("Textarea ID Link","text",t.textarea_id||"",s=>o("textarea_id",s))):i==="lvgl_roller"?(this.addLabeledInput("Options (one per line)","textarea",t.options||"",s=>o("options",s)),this.addLabeledInput("Visible Rows","number",t.visible_row_count||3,s=>o("visible_row_count",parseInt(s,10))),this.addColorMixer("Color",t.color||"white",s=>o("color",s)),this.addColorMixer("Background Color",t.bg_color||"black",s=>o("bg_color",s)),this.addColorMixer("Selected BG Color",t.selected_bg_color||"blue",s=>o("selected_bg_color",s)),this.addColorMixer("Selected Text Color",t.selected_text_color||"white",s=>o("selected_text_color",s)),this.addSelect("Mode",t.mode||"NORMAL",["NORMAL","INFINITE"],s=>o("mode",s))):i==="lvgl_spinbox"?(this.addLabeledInput("Min","number",t.min||0,s=>o("min",parseInt(s,10))),this.addLabeledInput("Max","number",t.max||100,s=>o("max",parseInt(s,10))),this.addLabeledInput("Value","number",t.value||0,s=>o("value",parseInt(s,10))),this.addLabeledInput("Digits","number",t.digit_count||4,s=>o("digit_count",parseInt(s,10))),this.addLabeledInput("Step","number",t.step||1,s=>o("step",parseInt(s,10)))):i==="lvgl_switch"?(this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",s=>{h.updateWidget(e.id,{entity_id:s})},e),this.addHint("Toggle switch/light/input_boolean when tapped"),this.addCheckbox("Checked",t.checked||!1,s=>o("checked",s)),this.addColorMixer("Indicator Color",t.color||"blue",s=>o("color",s)),this.addColorMixer("Background Color",t.bg_color||"gray",s=>o("bg_color",s)),this.addColorMixer("Knob Color",t.knob_color||"white",s=>o("knob_color",s))):i==="lvgl_textarea"?(this.addLabeledInput("Placeholder","text",t.placeholder||"",s=>o("placeholder",s)),this.addLabeledInput("Text","text",t.text||"",s=>o("text",s)),this.addCheckbox("One Line",t.one_line||!1,s=>o("one_line",s)),this.addCheckbox("Password Mode",t.password_mode||!1,s=>o("password_mode",s)),this.addLabeledInput("Accepted Chars","text",t.accepted_chars||"",s=>o("accepted_chars",s)),this.addLabeledInput("Max Length","number",t.max_length||0,s=>o("max_length",parseInt(s,10)))):i==="lvgl_obj"&&(this.addColorMixer("Color",t.color||"white",s=>o("color",s)),this.addLabeledInput("Border Width","number",t.border_width||1,s=>o("border_width",parseInt(s,10))),this.addColorMixer("Border Color",t.border_color||"gray",s=>o("border_color",s)),this.addLabeledInput("Radius","number",t.radius||0,s=>o("radius",parseInt(s,10))));this.endSection()}}addCommonLVGLProperties(e,i){const n=(s,r)=>{const l={...e.props,[s]:r};h.updateWidget(e.id,{props:l})};this.createSection("Common LVGL",!1);const t=document.createElement("div");t.style.display="grid",t.style.gridTemplateColumns="1fr 1fr",t.style.gap="4px",this.getContainer().appendChild(t);const o=(s,r,l=!1)=>{const c=document.createElement("div"),a=document.createElement("input");a.type="checkbox",a.checked=i[r]!==void 0?i[r]:l,a.addEventListener("change",()=>n(r,a.checked));const u=document.createElement("span");u.textContent=" "+s,u.style.fontSize="10px",c.appendChild(a),c.appendChild(u),t.appendChild(c)};o("Hidden","hidden",!1),o("Clickable","clickable",!0),o("Checkable","checkable",!1),o("Scrollable","scrollable",!0),o("Floating","floating",!1),o("Ignore Layout","ignore_layout",!1),this.addSelect("Scrollbar Mode",i.scrollbar_mode||"AUTO",["AUTO","ON","OFF","ACTIVE"],s=>n("scrollbar_mode",s)),this.endSection()}addNumberWithSlider(e,i,n,t,o){const s=document.createElement("div");s.className="field";const r=document.createElement("div");r.className="prop-label",r.textContent=e;const l=document.createElement("div");l.className="slider-hybrid";const c=document.createElement("input");c.type="range",c.min=n,c.max=t,c.value=i;const a=document.createElement("input");a.className="prop-input",a.type="number",a.value=i,a.min=n,a.max=t,c.addEventListener("input",()=>{a.value=c.value,o(parseInt(c.value,10))}),a.addEventListener("input",()=>{c.value=a.value,o(parseInt(a.value,10))}),l.appendChild(c),l.appendChild(a),s.appendChild(r),s.appendChild(l),this.getContainer().appendChild(s)}addSegmentedControl(e,i,n,t){const o=document.createElement("div");o.className="field";const s=document.createElement("div");s.className="prop-label",s.textContent=e;const r=document.createElement("div");r.className="segmented-control",i.forEach(l=>{const c=document.createElement("div");c.className="segment-item"+(l.value===n?" active":""),c.title=l.label||l.value,l.icon?c.innerHTML=`< i class="mdi ${l.icon}" ></i > `:c.textContent=l.label||l.value,c.onclick=()=>{r.querySelectorAll(".segment-item").forEach(a=>a.classList.remove("active")),c.classList.add("active"),t(l.value)},r.appendChild(c)}),o.appendChild(s),o.appendChild(r),this.getContainer().appendChild(o)}addCompactPropertyRow(e){const i=document.createElement("div");i.className="prop-grid-2",this.getContainer().appendChild(i),this.containerStack.push(i),e(),this.containerStack.pop()}addLabeledInput(e,i,n,t){const o=document.createElement("div");o.className="field";const s=document.createElement("div");s.className="prop-label",s.textContent=e;const r=document.createElement("input");r.className="prop-input",r.type=i,r.value=n,r.addEventListener("input",()=>{t(r.value)}),r.addEventListener("change",()=>{t(r.value)}),o.appendChild(s),o.appendChild(r),this.getContainer().appendChild(o)}addSelect(e,i,n,t){const o=document.createElement("div");o.className="field";const s=document.createElement("div");s.className="prop-label",s.textContent=e;const r=document.createElement("select");r.className="prop-input",n.forEach(l=>{const c=document.createElement("option");typeof l=="object"&&l!==null?(c.value=l.value,c.textContent=l.label,l.value===i&&(c.selected=!0)):(c.value=l,c.textContent=l,l===i&&(c.selected=!0)),r.appendChild(c)}),r.addEventListener("change",()=>t(r.value)),o.appendChild(s),o.appendChild(r),this.getContainer().appendChild(o)}addCheckbox(e,i,n){const t=document.createElement("div");t.className="field",t.style.marginBottom="8px";const o=document.createElement("label");o.style.display="flex",o.style.alignItems="center",o.style.gap="8px",o.style.fontSize="13px",o.style.cursor="pointer";const s=document.createElement("input");s.type="checkbox",s.checked=!!i,s.style.width="16px",s.style.height="16px",s.style.margin="0",s.style.cursor="pointer",s.addEventListener("change",()=>n(s.checked));const r=document.createElement("span");r.textContent=e,o.appendChild(s),o.appendChild(r),t.appendChild(o),this.getContainer().appendChild(t)}addHint(e){const i=document.createElement("div");i.style.fontSize="11px",i.style.color="#666",i.style.marginTop="4px",i.style.marginBottom="12px",i.style.lineHeight="1.4",i.innerHTML=e,this.getContainer().appendChild(i)}addLabeledInputWithDataList(e,i,n,t,o){const s=document.createElement("div");s.className="field";const r=document.createElement("div");r.className="prop-label",r.textContent=e;const l="datalist_"+Math.random().toString(36).substr(2,9),c=document.createElement("datalist");c.id=l,t.forEach(u=>{const g=document.createElement("option");g.value=u,c.appendChild(g)});const a=document.createElement("input");a.className="prop-input",a.type=i,a.value=n,a.setAttribute("list",l),a.addEventListener("input",()=>o(a.value)),a.addEventListener("change",()=>o(a.value)),s.appendChild(r),s.appendChild(a),s.appendChild(c),this.getContainer().appendChild(s)}addSectionLabel(e){const i=document.createElement("div");i.className="sidebar-section-label",i.textContent=e,this.getContainer().appendChild(i)}autoPopulateTitleFromEntity(e,i){!i||!window.AppState||typeof ge=="function"&&ge().then(n=>{if(!n||n.length===0)return;const t=n.find(o=>o.entity_id===i);if(t&&t.name){const o=h.getSelectedWidget();o&&o.id===e&&!o.title&&h.updateWidget(e,{title:t.name})}}).catch(()=>{})}addVisibilityConditions(e){e.condition_entity=e.condition_entity||"",e.condition_operator=e.condition_operator||"==",e.condition_state=e.condition_state||"",e.condition_min=e.condition_min||"",e.condition_max=e.condition_max||"";const i=document.createElement("div");i.className="field",i.style.fontSize="9px",i.style.color="#9499a6",i.style.marginBottom="6px",i.innerHTML="Show/hide this widget based on an entity's state.",this.getContainer().appendChild(i),this.addLabeledInputWithPicker("Condition Entity","text",e.condition_entity,r=>{h.updateWidget(e.id,{condition_entity:r})},e);const n=["==","!=","<",">","<=",">="];this.addSelect("Operator",e.condition_operator,n,r=>{h.updateWidget(e.id,{condition_operator:r})});const t=["on","off","open","closed","true","false","home","not_home","locked","unlocked","active","inactive","detected","clear","occupied"];this.addLabeledInputWithDataList("Condition State","text",e.condition_state,t,r=>{h.updateWidget(e.id,{condition_state:r})}),this.addLabeledInput("Min Value (Range)","text",e.condition_min,r=>{h.updateWidget(e.id,{condition_min:r})}),this.addLabeledInput("Max Value (Range)","text",e.condition_max,r=>{h.updateWidget(e.id,{condition_max:r})});const o=document.createElement("div");o.className="field",o.style.marginTop="8px";const s=document.createElement("button");s.className="btn btn-secondary btn-full",s.textContent="Clear Condition",s.type="button",s.addEventListener("click",()=>{h.updateWidget(e.id,{condition_entity:"",condition_operator:"==",condition_state:"",condition_min:"",condition_max:""})}),o.appendChild(s),this.getContainer().appendChild(o)}addLabeledInputWithPicker(e,i,n,t,o){const s=document.createElement("div");s.className="field";const r=document.createElement("div");r.className="prop-label",r.textContent=e;const l=document.createElement("div");l.style.display="flex",l.style.gap="4px";const c=document.createElement("input");c.className="prop-input",c.type=i,c.value=n,c.style.flex="1",c.placeholder="Start typing or click â¼ to pick...",c.autocomplete="off",c.setAttribute("list",dt),ei(),c.addEventListener("input",()=>t(c.value));const a=document.createElement("button");a.className="btn btn-secondary",a.innerHTML="â¼",a.style.padding="4px 8px",a.style.fontSize="10px",a.style.minWidth="32px",a.type="button",a.title="Browse all entities",a.addEventListener("click",()=>{is(o,c,u=>{c.value=u,t(u)})}),l.appendChild(c),l.appendChild(a),s.appendChild(r),s.appendChild(l),this.getContainer().appendChild(s)}addIconPicker(e,i,n,t){const o=window.iconPickerData||[],s=document.createElement("div");s.className="field";const r=document.createElement("div");r.className="prop-label",r.textContent=e,s.appendChild(r);const l=document.createElement("select");l.className="select",l.style.fontFamily="MDI, monospace, system-ui",l.style.fontSize="16px",l.style.lineHeight="1.5",l.style.width="100%",l.style.marginBottom="4px";const c=document.createElement("option");c.value="",c.textContent="-- Quick visual picker --",c.style.fontFamily="system-ui, -apple-system, BlinkMacSystemFont, sans-serif",l.appendChild(c);const a=(i||"").replace("mdi:","").toUpperCase();o.forEach(y=>{const b=document.createElement("option");b.value=y.code;const w=983040+parseInt(y.code.slice(1),16),S=String.fromCodePoint(w);b.textContent=S+"  "+y.code+(y.name?` (${y.name})`:""),b.style.fontFamily="MDI, monospace, system-ui",y.code===a&&(b.selected=!0),l.appendChild(b)}),l.addEventListener("change",()=>{l.value&&(g.value=l.value,n(l.value))}),s.appendChild(l);const u=document.createElement("div");u.style.display="flex",u.style.gap="4px";const g=document.createElement("input");g.className="prop-input",g.type="text",g.placeholder="MDI Hex (Fxxxx)",g.value=a,g.style.flex="1",g.style.fontFamily="monospace",g.addEventListener("input",()=>{const y=(g.value||"").trim().toUpperCase().replace(/^0X/,"").replace(/^MDI:/,"");/^F[0-9A-F]{4}$/i.test(y)?(n(y),Array.from(l.options).find(w=>w.value===y)?l.value=y:l.value=""):y===""&&(n(""),l.value="")}),u.appendChild(g);const m=document.createElement("button");m.className="btn btn-secondary",m.textContent="â",m.style.padding="4px 8px",m.style.fontSize="14px",m.type="button",m.title="Open full icon browser",m.addEventListener("click",()=>{zt(t,g)}),u.appendChild(m),s.appendChild(u);const f=document.createElement("div");f.className="prop-hint",f.innerHTML='Browse <a href="https://pictogrammers.com/library/mdi/icon/" target="_blank" style="color: #03a9f4; text-decoration: none;">Pictogrammers MDI</a>',s.appendChild(f),this.getContainer().appendChild(s)}addIconInput(e,i,n,t){const o=document.createElement("div");o.className="field";const s=document.createElement("div");s.className="prop-label",s.textContent=e;const r=document.createElement("div");r.style.display="flex",r.style.gap="4px";const l=document.createElement("input");l.className="prop-input",l.type="text",l.value=i,l.style.flex="1",l.addEventListener("input",()=>n(l.value));const c=document.createElement("button");c.className="btn btn-secondary",c.textContent="â",c.style.padding="4px 8px",c.style.fontSize="14px",c.type="button",c.addEventListener("click",()=>{zt(t,l)}),r.appendChild(l),r.appendChild(c),o.appendChild(s),o.appendChild(r),this.getContainer().appendChild(o)}addColorSelector(e,i,n,t){typeof isRGBDevice=="function"&&isRGBDevice()?this.addColorMixer(e,i,t):this.addSelect(e,i,n,t)}addColorMixer(e,i,n){const t=document.createElement("div");t.className="field",t.style.marginBottom="10px";const o=document.createElement("div");o.className="prop-label",o.textContent=e,t.appendChild(o);let s=0,r=0,l=0,c="#000000";const a=L=>{const k={black:"#000000",white:"#FFFFFF",red:"#FF0000",green:"#00FF00",blue:"#0000FF",yellow:"#FFFF00",gray:"#808080",grey:"#808080"};return L?k[L.toLowerCase()]?k[L.toLowerCase()]:L.startsWith("0x")?"#"+L.substring(2):L.startsWith("#")?L:"#000000":"#000000"},u=L=>{const k=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(L);return k?{r:parseInt(k[1],16),g:parseInt(k[2],16),b:parseInt(k[3],16)}:{r:0,g:0,b:0}},g=(L,k,H)=>{const z=F=>{const A=Math.max(0,Math.min(255,F)).toString(16);return A.length===1?"0"+A:A};return"#"+z(L)+z(k)+z(H)};c=a(i);const m=u(c);s=m.r,r=m.g,l=m.b;const f=document.createElement("div");f.style.background="var(--bg)",f.style.padding="8px",f.style.borderRadius="6px",f.style.border="1px solid var(--border-subtle)";const y=document.createElement("div");y.style.display="flex",y.style.alignItems="center",y.style.marginBottom="8px",y.style.gap="8px";const b=document.createElement("div");b.style.width="24px",b.style.height="24px",b.style.borderRadius="3px",b.style.backgroundColor=c,b.style.border="1px solid var(--border-subtle)";const w=document.createElement("input");w.type="text",w.value=c.toUpperCase(),w.className="prop-input",w.style.flex="1",w.style.fontFamily="monospace",y.appendChild(b),y.appendChild(w),f.appendChild(y);const S=(L,k,H)=>{const z=document.createElement("div");z.style.display="flex",z.style.alignItems="center",z.style.marginBottom="4px",z.style.fontSize="11px";const F=document.createElement("span");F.textContent=L,F.style.width="15px",F.style.fontWeight="bold",F.style.color="var(--text)";const A=document.createElement("input");A.type="range",A.min="0",A.max="255",A.value=k,A.style.flex="1",A.style.marginLeft="4px",A.style.accentColor=H;const Y=document.createElement("span");return Y.textContent=k,Y.style.width="25px",Y.style.textAlign="right",Y.style.marginLeft="4px",Y.style.color="var(--muted)",z.appendChild(F),z.appendChild(A),z.appendChild(Y),{row:z,slider:A,valLbl:Y}},T=S("R",s,"red"),R=S("G",r,"green"),v=S("B",l,"blue");f.appendChild(T.row),f.appendChild(R.row),f.appendChild(v.row),t.appendChild(f),this.getContainer().appendChild(t);const M=()=>{s=parseInt(T.slider.value),r=parseInt(R.slider.value),l=parseInt(v.slider.value),T.valLbl.textContent=s,R.valLbl.textContent=r,v.valLbl.textContent=l;const L=g(s,r,l).toUpperCase();w.value=L,b.style.backgroundColor=L,n(L)},E=()=>{let L=w.value.trim();if(L.startsWith("#")||(L="#"+L),/^#[0-9A-F]{6}$/i.test(L)){const k=u(L);s=k.r,r=k.g,l=k.b,T.slider.value=s,T.valLbl.textContent=s,R.slider.value=r,R.valLbl.textContent=r,v.slider.value=l,v.valLbl.textContent=l,b.style.backgroundColor=L,n(L)}};T.slider.addEventListener("input",M),R.slider.addEventListener("input",M),v.slider.addEventListener("input",M),w.addEventListener("input",E),w.addEventListener("change",E)}}class di{constructor(){this.init()}init(){window.addEventListener("keydown",e=>this.handleKeyDown(e))}handleKeyDown(e){const i=h||window.AppState;if(!i){_.error("KeyboardHandler: AppState not found!");return}const n=i.selectedWidgetIds.length>0;i.selectedWidgetId;const t=window.isAutoHighlight||!1;if(e.shiftKey&&e.code==="Space"){(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")&&e.target.blur(),e.preventDefault(),window.QuickSearch&&window.QuickSearch.open();return}if((e.key==="Delete"||e.key==="Backspace")&&n){const o=window.lastHighlightRange;if(e.target.id==="snippetBox"&&o&&e.target.selectionStart===o.start&&e.target.selectionEnd===o.end){e.preventDefault(),this.deleteWidget(null);return}if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")return;e.preventDefault(),this.deleteWidget(null);return}if((e.ctrlKey||e.metaKey)&&e.key&&e.key.toLowerCase()==="c"){if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"){if(e.target.id==="snippetBox"&&t){e.preventDefault(),this.copyWidget();return}return}e.preventDefault(),this.copyWidget();return}if((e.ctrlKey||e.metaKey)&&e.key&&e.key.toLowerCase()==="v"){if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"){if(e.target.id==="snippetBox"&&t){e.preventDefault(),this.pasteWidget();return}return}e.preventDefault(),this.pasteWidget();return}if((e.ctrlKey||e.metaKey)&&e.key&&e.key.toLowerCase()==="z"&&!e.shiftKey){if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"){if(e.target.id==="snippetBox"&&t){e.preventDefault(),window._undoRedoInProgress=!0,i.undo(),setTimeout(()=>{window._undoRedoInProgress=!1},100);return}return}e.preventDefault(),window._undoRedoInProgress=!0,i.undo(),setTimeout(()=>{window._undoRedoInProgress=!1},100);return}if((e.ctrlKey||e.metaKey)&&e.key&&(e.key.toLowerCase()==="y"||e.key.toLowerCase()==="z"&&e.shiftKey)){if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"){if(e.target.id==="snippetBox"&&t){e.preventDefault(),window._undoRedoInProgress=!0,i.redo(),setTimeout(()=>{window._undoRedoInProgress=!1},100);return}return}e.preventDefault(),window._undoRedoInProgress=!0,i.redo(),setTimeout(()=>{window._undoRedoInProgress=!1},100);return}if((e.ctrlKey||e.metaKey)&&e.key&&e.key.toLowerCase()==="l"&&n){e.preventDefault();const s=i.getSelectedWidgets().every(r=>r.locked);i.updateWidgets(i.selectedWidgetIds,{locked:!s})}if((e.ctrlKey||e.metaKey)&&e.key&&e.key.toLowerCase()==="a"){const o=e.target.id==="snippetBox"&&t;if(e.target.tagName!=="INPUT"&&e.target.tagName!=="TEXTAREA"||o){e.preventDefault(),i.selectAllWidgets();return}}if(e.key&&e.key.toLowerCase()==="g"&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey&&!e.altKey&&e.target.tagName!=="INPUT"&&e.target.tagName!=="TEXTAREA"){e.preventDefault();const o=!i.showGrid;i.setShowGrid(o);const s=document.getElementById("gridToggleBtn");s&&s.classList.toggle("active",o),_.log(`[Keyboard] Grid toggled: ${o}`);return}if(e.key&&e.key.toLowerCase()==="r"&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey&&!e.altKey&&e.target.tagName!=="INPUT"&&e.target.tagName!=="TEXTAREA"){e.preventDefault();const o=!i.showRulers;i.setShowRulers(o);const s=document.getElementById("rulersToggleBtn");s&&s.classList.toggle("active",o),_.log(`[Keyboard] Rulers toggled: ${o}`);return}}static isInput(e){return e.tagName==="INPUT"||e.tagName==="TEXTAREA"}deleteWidget(e){const i=h||window.AppState;i&&i.deleteWidget(e)}copyWidget(){const e=h||window.AppState;e&&e.copyWidget()}pasteWidget(){const e=h||window.AppState;e&&e.pasteWidget()}}window.KeyboardHandler=di;window.LAYOUT={WIDGET:{SMALL:{W:100,H:20},MEDIUM:{W:200,H:60},LARGE:{W:200,H:100}},FONT:{SIZE:{XS:12,S:14,M:16,L:20,XL:28,XXL:40},DEFAULT:{LABEL:14,VALUE:20,TITLE:28,DATE:16}},GRID:{GAP:10,MARGIN:10}};Object.freeze(window.LAYOUT);function ls(){const d=h.getPagesPayload(),e=JSON.stringify(d,null,2),i=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(i),t=document.createElement("a");t.href=n,t.download=`reterminal_layout_${Date.now()}.json`,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(n)}function ds(d){if(!d)return;const e=new FileReader;e.onload=i=>{try{const n=i.target.result,t=JSON.parse(n);le(t)}catch(n){_.error("Failed to parse layout file:",n),alert("Error parsing layout file. Please ensure it is a valid JSON file.")}},e.readAsText(d)}function cs(d){const e=d.target.files[0];ds(e),d.target.value=""}class ke{constructor(){if(this.constructor===ke)throw new Error("BaseAdapter is abstract and cannot be instantiated directly.")}async generate(e){throw new Error("Method 'generate()' must be implemented.")}generatePage(e,i){throw new Error("Method 'generatePage()' must be implemented.")}generateWidget(e,i){throw new Error("Method 'generateWidget()' must be implemented.")}sanitize(e){return e}}window.BaseAdapter=ke;function ps(d,e="my_display",i=0){if(!d||!d.touch)return[];const n=d.touch,t=["touchscreen:"];t.push(`  - platform: ${n.platform}`),t.push("    id: my_touchscreen"),t.push(`    display: ${e}`),n.i2c_id&&t.push(`    i2c_id: ${n.i2c_id}`),n.spi_id&&t.push(`    spi_id: ${n.spi_id}`),n.address&&t.push(`    address: ${n.address}`),n.update_interval&&t.push(`    update_interval: ${n.update_interval}`);const o=(l,c)=>{c&&(typeof c=="string"||typeof c=="number"?t.push(`    ${l}: ${c}`):(t.push(`    ${l}:`),Object.entries(c).forEach(([a,u])=>t.push(`      ${a}: ${u}`))))};o("interrupt_pin",n.interrupt_pin),o("reset_pin",n.reset_pin),o("cs_pin",n.cs_pin);const s=[],r=n.transform||{};if((n.mirror_x||r.mirror_x)&&s.push("mirror_x: true"),(n.mirror_y||r.mirror_y)&&s.push("mirror_y: true"),(n.swap_xy||r.swap_xy)&&s.push("swap_xy: true"),s.length>0&&(t.push("    transform:"),s.forEach(l=>t.push(`      ${l}`))),n.calibration){t.push("    calibration:");const l=n.calibration;Object.entries(l).forEach(([c,a])=>t.push(`      ${c}: ${a}`))}return t.push(""),t}function We(d){const e=[];if(!d||!d.backlight)return e;const i=d.backlight;return(i.platform==="ledc"||i.platform==="gpio"||i.platform==="switch")&&(i.platform==="switch"?(e.push("switch:"),e.push("  - platform: gpio"),e.push("    id: lcdbacklight"),e.push("    name: lcdbacklight"),typeof i.pin=="object"?(e.push("    pin:"),Object.entries(i.pin).forEach(([n,t])=>{typeof t=="object"?(e.push(`      ${n}:`),Object.entries(t).forEach(([o,s])=>e.push(`        ${o}: ${s}`))):e.push(`      ${n}: ${t}`)})):e.push(`    pin: ${i.pin}`),e.push("    restore_mode: ALWAYS_ON"),e.push("")):(e.push("output:"),e.push(`  - platform: ${i.platform}`),e.push("    id: gpio_backlight_pwm"),e.push(`    pin: ${i.pin}`),i.frequency&&e.push(`    frequency: ${i.frequency}`),e.push(""))),e.push("light:"),e.push("  - platform: monochromatic"),e.push("    name: Display Backlight"),e.push("    id: display_backlight"),e.push("    restore_mode: ALWAYS_ON"),i.platform==="switch"?(e.push("    output: fake_backlight_output"),e.push("    default_transition_length: 0s"),e.push(""),e.push("output:"),e.push("  - platform: template"),e.push("    id: fake_backlight_output"),e.push("    type: float"),e.push("    write_action:"),e.push("      - if:"),e.push("          condition:"),e.push("            lambda: 'return state > 0.0;'"),e.push("          then:"),e.push("            - switch.turn_on: lcdbacklight"),e.push("          else:"),e.push("            - switch.turn_off: lcdbacklight")):e.push("    output: gpio_backlight_pwm"),e.push(""),e}function $e(d){const e=[];return d.external_components&&Array.isArray(d.external_components)&&d.external_components.length>0&&(e.push("external_components:"),e.push(...d.external_components),e.push("")),d.extra_components&&Array.isArray(d.extra_components)&&(e.push(...d.extra_components),e.push("")),d.extra_components_raw&&(e.push(d.extra_components_raw),e.push("")),e}function Ne(d){const e=[];return d&&d.pins&&d.pins.i2c&&(e.push("i2c:"),e.push("  - sda: "+d.pins.i2c.sda),e.push("    scl: "+d.pins.i2c.scl),e.push("    scan: "+(d.i2c_config?.scan!==!1)),e.push("    id: bus_a"),d.i2c_config?.frequency&&e.push("    frequency: "+d.i2c_config.frequency),e.push("")),e}function He(d){const e=[];if(d&&d.pins&&d.pins.spi){e.push("spi:");const i=d.pins.spi;i.id?e.push(`  - id: ${i.id}`):e.push("  - id: spi_bus"),e.push(`    clk_pin: ${i.clk}`),i.mosi&&e.push(`    mosi_pin: ${i.mosi}`),i.miso&&e.push(`    miso_pin: ${i.miso}`),i.type==="quad"&&(e.push("    interface: triple"),i.data_pins&&e.push(`    data_pins: [${i.data_pins.join(", ")}]`)),e.push(""),d.extra_spi&&(e.push(...d.extra_spi),e.push(""))}return e}function Fe(d,e="landscape"){const i=[];if(!d)return i;const n=d.resolution||{width:800,height:480},t=n.height>n.width,o=e==="portrait";let s=0;if(t?s=o?0:90:s=o?90:0,d.rotation_offset&&(s=(s+d.rotation_offset)%360),d.display_config)i.push("display:"),i.push(...d.display_config),i.push("");else{i.push("display:"),i.push(`  - platform: ${d.displayPlatform}`),i.push("    id: epaper_display");const l=d.pins&&d.pins.display?d.pins.display:null;if(l){const a=(u,g)=>{g&&(typeof g=="object"?(i.push(`    ${u}:`),i.push(`      number: ${g.number}`),g.inverted!==void 0&&i.push(`      inverted: ${g.inverted}`)):i.push(`    ${u}: ${g}`))};a("cs_pin",l.cs),a("dc_pin",l.dc),a("reset_pin",l.reset),a("busy_pin",l.busy)}if(d.displayPlatform==="waveshare_epaper"&&d.displayModel&&i.push(`    model: "${d.displayModel}"`),i.push(`    rotation: ${s}`),d.displayModel==="M5Paper"||d.displayPlatform==="it8951e")i.push("    reversed: false"),i.push("    reset_duration: 100ms");else if(d.displayModel&&d.displayPlatform!=="waveshare_epaper"){let a=`    model: "${d.displayModel}"`;d.displayModel==="Seeed-reTerminal-E1002"&&(a+=" #Please update your ESPHome version to 2025.11.1 above"),i.push(a)}i.push("    update_interval: never");const c=["1.54in","1.54inv2","2.13in","2.13in-ttgo","2.13in-ttgo-b1","2.13in-ttgo-b73","2.13in-ttgo-b74","2.13in-ttgo-dke","2.13inv2","2.13inv3","2.90in","2.90in-dke","2.90inv2","2.90inv2-r2","7.50inv2","7.50inv2p","gdew029t5","gdey029t94","gdey042t81","gdey0583t81"];d.displayModel&&c.includes(d.displayModel)&&i.push("    full_update_every: 30"),i.push("")}const r=d.display_config?"my_display":"epaper_display";return i.push(...ps(d,r,s)),i}function ze(d,e=[],i="my_display",n=[]){const t=[];if(!d)return t;const o=d.pins||{},s=o.batteryAdc,r=d.features&&d.features.sht4x,l=d.features&&d.features.shtc3,c=e.length>0;if(!s&&!r&&!l&&!c)return t;if(t.push("sensor:"),s&&(t.push("  - platform: adc"),t.push(`    pin: ${o.batteryAdc}`),t.push('    name: "Battery Voltage"'),t.push('    unit_of_measurement: "V"'),t.push("    device_class: voltage"),t.push("    state_class: measurement"),t.push("    id: battery_voltage"),t.push("    update_interval: 60s"),t.push("    attenuation: "+d.battery.attenuation),t.push("    filters:"),t.push("      - multiply: "+d.battery.multiplier)),r&&(t.push("  - platform: sht4x"),t.push("    id: sht4x_sensor"),t.push("    temperature:"),t.push('      name: "Temperature"'),t.push("      id: sht4x_temperature"),t.push("    humidity:"),t.push('      name: "Humidity"'),t.push("      id: sht4x_humidity"),t.push("    address: 0x44"),t.push("    update_interval: 60s")),(d.features.sht3xd||d.displayModel==="M5Paper"||d.name&&d.name.includes("M5Paper"))&&(t.push("  - platform: sht3xd"),t.push("    address: 0x44"),t.push("    temperature:"),t.push('      name: "Temperature"'),t.push("      id: sht3x_temperature"),t.push("    humidity:"),t.push('      name: "Humidity"'),t.push("      id: sht3x_humidity"),t.push("    update_interval: 60s")),l&&(t.push("  - platform: shtcx"),t.push("    id: shtc3_sensor"),t.push("    i2c_id: bus_a"),t.push("    address: 0x70"),t.push("    temperature:"),t.push('      name: "Temperature"'),t.push("      id: shtc3_temperature"),t.push("    humidity:"),t.push('      name: "Humidity"'),t.push("      id: shtc3_humidity"),t.push("    update_interval: 60s")),e.length>0&&t.push(...e),s)if(t.push(""),t.push("  - platform: template"),t.push('    name: "Battery Level"'),t.push("    id: battery_level"),t.push('    unit_of_measurement: "%"'),t.push('    icon: "mdi:battery"'),t.push("    device_class: battery"),t.push("    state_class: measurement"),d.battery.curve)t.push("    lambda: 'return id(battery_voltage).state;'"),t.push("    update_interval: 60s"),t.push("    filters:"),t.push("      - calibrate_linear:"),d.battery.curve.forEach(a=>{t.push(`          - ${a.from} -> ${a.to}`)}),t.push("      - clamp:"),t.push("          min_value: 0"),t.push("          max_value: 100");else{const a=d.battery.calibration?d.battery.calibration.min:3.27,u=d.battery.calibration?d.battery.calibration.max:4.15;t.push("    lambda: |-"),t.push(`      if (id(battery_voltage).state > ${u}) return 100;`),t.push(`      if (id(battery_voltage).state < ${a}) return 0;`),t.push(`      return (id(battery_voltage).state - ${a}) / (${u} - ${a}) * 100.0;`)}return t.push(""),t}function Ge(d,e,i="my_display",n=[]){const t=[],o=d&&d.features&&d.features.buttons,s=n.length>0;if(!o&&!s)return t;if(t.push("binary_sensor:"),o){const r=d.name&&d.name.includes("CoreInk"),l=d.pins.buttons||{};if(l.left&&(t.push("  - platform: gpio"),t.push("    pin:"),typeof l.left=="object"?(t.push(`      number: ${l.left.number}`),t.push(`      mode: ${l.left.mode||"INPUT_PULLUP"}`),t.push(`      inverted: ${l.left.inverted!==void 0?l.left.inverted:!0}`)):(t.push(`      number: ${l.left}`),t.push("      mode: INPUT_PULLUP"),t.push("      inverted: true")),t.push('    name: "Left Button"'),t.push("    id: button_left"),t.push("    on_press:"),t.push("      then:"),r?(t.push("        - script.execute:"),t.push("            id: change_page_to"),t.push(`            target_page: !lambda 'return id(display_page) > 0 ? id(display_page) - 1 : ${e-1};'`),t.push("        - script.stop: activity_timer"),t.push("        - script.execute: activity_timer")):(t.push("        - script.execute:"),t.push("            id: change_page_to"),t.push(`            target_page: !lambda 'return id(display_page) > 0 ? id(display_page) - 1 : ${e-1};'`))),l.right&&(t.push("  - platform: gpio"),t.push("    pin:"),typeof l.right=="object"?(t.push(`      number: ${l.right.number}`),t.push(`      mode: ${l.right.mode||"INPUT_PULLUP"}`),t.push(`      inverted: ${l.right.inverted!==void 0?l.right.inverted:!0}`)):(t.push(`      number: ${l.right}`),t.push("      mode: INPUT_PULLUP"),t.push("      inverted: true")),t.push('    name: "Right Button"'),t.push("    id: button_right"),t.push("    on_press:"),t.push("      then:"),r?(t.push("        - script.execute:"),t.push("            id: change_page_to"),t.push(`            target_page: !lambda 'return id(display_page) < ${e-1} ? id(display_page) + 1 : 0;'`),t.push("        - script.stop: activity_timer"),t.push("        - script.execute: activity_timer")):(t.push("        - script.execute:"),t.push("            id: change_page_to"),t.push(`            target_page: !lambda 'return id(display_page) < ${e-1} ? id(display_page) + 1 : 0;'`))),l.refresh){t.push("  - platform: gpio"),t.push("    pin:"),typeof l.refresh=="object"?(t.push(`      number: ${l.refresh.number}`),t.push(`      mode: ${l.refresh.mode||"INPUT_PULLUP"}`),t.push(`      inverted: ${l.refresh.inverted!==void 0?l.refresh.inverted:!0}`)):(t.push(`      number: ${l.refresh}`),t.push("      mode: INPUT_PULLUP"),t.push("      inverted: true"));const c=r?"Enter Button":"Refresh Button",a=r?"button_enter":"button_refresh";t.push(`    name: "${c}"`),t.push(`    id: ${a}`),t.push("    on_press:"),t.push("      then:"),t.push(`        - component.update: ${i}`),r&&(t.push("        - script.stop: activity_timer"),t.push("        - script.execute: activity_timer"))}l.home&&(t.push("  - platform: gpio"),t.push("    pin:"),typeof l.home=="object"?(t.push(`      number: ${l.home.number}`),t.push(`      mode: ${l.home.mode||"INPUT_PULLUP"}`),t.push(`      inverted: ${l.home.inverted!==void 0?l.home.inverted:!0}`)):(t.push(`      number: ${l.home}`),t.push("      mode: INPUT_PULLUP"),t.push("      inverted: true")),t.push('    name: "Home Button"'),t.push("    id: button_home"),t.push("    on_press:"),t.push("      then:"),t.push("        - script.execute:"),t.push("            id: change_page_to"),t.push("            target_page: 0"),t.push("        - script.execute: manage_run_and_sleep"),r&&(t.push("        - script.stop: activity_timer"),t.push("        - script.execute: activity_timer")))}return s&&(t.push("  # Touch Area Binary Sensors"),n.forEach(r=>{const l=(r.type||"").toLowerCase(),c=r.props||{};if(l==="template_nav_bar"){const a=c.show_prev!==!1,u=c.show_home!==!1,g=c.show_next!==!1;let m=0;if(a&&m++,u&&m++,g&&m++,m>0){const f=Math.floor(r.width/m);let y=0;const b=(w,S)=>{const T=r.x+y*f,R=T+f,v=r.y,M=r.y+r.height;t.push("  - platform: touchscreen"),t.push(`    id: nav_${w}_${r.id}`),t.push("    touchscreen_id: my_touchscreen"),t.push(`    x_min: ${T}`),t.push(`    x_max: ${R}`),t.push(`    y_min: ${v}`),t.push(`    y_max: ${M}`),t.push("    on_press:");const E=r._pageIndex!==void 0?r._pageIndex:0;t.push("      - if:"),t.push("          condition:"),t.push(`            lambda: 'return id(display_page) == ${E};'`),t.push("          then:"),w==="prev"?(t.push("            - script.execute:"),t.push("                id: change_page_to"),t.push("                target_page: !lambda 'return id(display_page) - 1;'")):w==="home"?t.push("            - script.execute: manage_run_and_sleep"):w==="next"&&(t.push("            - script.execute:"),t.push("                id: change_page_to"),t.push("                target_page: !lambda 'return id(display_page) + 1;'")),y++};a&&b("prev"),u&&b("home"),g&&b("next")}}else{const a=(r.entity_id||`touch_area_${r.id}`).replace(/[^a-zA-Z0-9_]/g,"_"),u=parseInt(String(c.icon_size||40),10),g=Math.max(r.width,u),m=Math.max(r.height,u);let f=r.x-Math.floor((g-r.width)/2),y=f+g,b=r.y-Math.floor((m-r.height)/2),w=b+m;f=Math.max(0,f),b=Math.max(0,b);const S=c.nav_action||"none",T=r._pageIndex!==void 0?r._pageIndex:0;t.push("  - platform: touchscreen"),t.push(`    id: ${a}`),t.push("    touchscreen_id: my_touchscreen"),t.push(`    x_min: ${f}`),t.push(`    x_max: ${y}`),t.push(`    y_min: ${b}`),t.push(`    y_max: ${w}`),(S!=="none"||r.entity_id)&&(t.push("    on_press:"),t.push("      - if:"),t.push("          condition:"),t.push(`            lambda: 'return id(display_page) == ${T};'`),t.push("          then:"),S==="next_page"?(t.push("            - script.execute:"),t.push("                id: change_page_to"),t.push("                target_page: !lambda 'return id(display_page) + 1;'")):S==="previous_page"?(t.push("            - script.execute:"),t.push("                id: change_page_to"),t.push("                target_page: !lambda 'return id(display_page) - 1;'")):S==="reload_page"?t.push("            - script.execute: manage_run_and_sleep"):r.entity_id&&(t.push("            - homeassistant.service:"),t.push("                service: homeassistant.toggle"),t.push("                data:"),t.push(`                  entity_id: ${r.entity_id}`)))}})),t.push(""),t}function je(d,e,i="my_display"){const n=[];n.push("button:"),n.push("  - platform: template"),n.push('    name: "Next Page"'),n.push("    on_press:"),n.push("      then:"),n.push("        - script.execute:"),n.push("            id: change_page_to"),n.push("            target_page: !lambda 'return id(display_page) + 1;'"),n.push("  - platform: template"),n.push('    name: "Previous Page"'),n.push("    on_press:"),n.push("      then:"),n.push("        - script.execute:"),n.push("            id: change_page_to"),n.push("            target_page: !lambda 'return id(display_page) - 1;'"),n.push("  - platform: template"),n.push('    name: "Refresh Display"'),n.push("    on_press:"),n.push("      then:"),n.push(`        - component.update: ${i}`);for(let t=0;t<e;t++)n.push("  - platform: template"),n.push(`    name: "Go to Page ${t+1}"`),n.push("    on_press:"),n.push("      then:"),n.push("        - script.execute:"),n.push("            id: change_page_to"),n.push(`            target_page: ${t}`);return d.features&&d.features.buzzer&&(n.push("  # Buzzer Sounds"),n.push("  - platform: template"),n.push('    name: "Play Beep Short"'),n.push('    icon: "mdi:bell-ring"'),n.push("    on_press:"),n.push('      - rtttl.play: "beep:d=32,o=5,b=200:16e6"'),n.push(""),n.push("  - platform: template"),n.push('    name: "Play Beep OK"'),n.push('    icon: "mdi:check-circle-outline"'),n.push("    on_press:"),n.push('      - rtttl.play: "ok:d=16,o=5,b=200:e6"'),n.push(""),n.push("  - platform: template"),n.push('    name: "Play Beep Error"'),n.push('    icon: "mdi:alert-circle-outline"'),n.push("    on_press:"),n.push('      - rtttl.play: "error:d=16,o=5,b=200:c6"'),n.push(""),n.push("  - platform: template"),n.push('    name: "Play Star Wars"'),n.push('    icon: "mdi:music-note"'),n.push("    on_press:"),n.push('      - rtttl.play: "StarWars:d=4,o=5,b=45:32p,32f,32f,32f,8a#.,8f.6,32d#,32d,32c,8a#.6,4f.6,32d#,32d,32c,8a#.6,4f.6,32d#,32d,32d#,8c6"')),n.push(""),n}function Ue(d){if(!(d.features&&d.features.psram||d.features&&d.features.features&&d.features.features.psram))return[];const i=["psram:"];return d.psram_mode&&(i.push(`  mode: ${d.psram_mode}`),i.push("  speed: 80MHz")),i.push(""),i}function Ve(d){return!d.features||!d.features.axp2101||d.features.manual_pmic?[]:["axp2101:","  i2c_id: bus_a","  address: 0x34","  irq_pin: GPIO21","  battery_voltage:",'    name: "Battery Voltage"',"    id: battery_voltage","  battery_level:",'    name: "Battery Level"',"    id: battery_level","  on_setup:","    - axp2101.set_ldo_voltage:","        id: bldo1","        voltage: 3300mv","    - switch.turn_on: bldo1  # EPD_VCC (Screen Power)","    - axp2101.set_ldo_voltage:","        id: aldo1","        voltage: 3300mv","    - switch.turn_on: aldo1  # Peripherals","    - axp2101.set_ldo_voltage:","        id: aldo3","        voltage: 3300mv","    - switch.turn_on: aldo3  # Backlight/Logic",""]}function Ye(d){const e=[];return!d||!d.pins||!d.pins.batteryEnable&&!d.pins.buzzer||(e.push("output:"),d.pins.batteryEnable&&(e.push("  - platform: gpio"),typeof d.pins.batteryEnable=="object"?(e.push("    pin:"),e.push(`      number: ${d.pins.batteryEnable.number}`),d.pins.batteryEnable.ignore_strapping_warning&&e.push("      ignore_strapping_warning: true"),d.pins.batteryEnable.inverted!==void 0&&e.push(`      inverted: ${d.pins.batteryEnable.inverted}`)):e.push(`    pin: ${d.pins.batteryEnable}`),e.push("    id: bsp_battery_enable")),d.pins.buzzer&&(d.pins.batteryEnable&&e.push(""),e.push("  - platform: ledc"),e.push(`    pin: ${d.pins.buzzer}`),e.push("    id: buzzer_output")),e.push("")),e}function qe(d){return!d.features||!d.features.buzzer?[]:["rtttl:","  id: reterminal_buzzer","  output: buzzer_output",""]}function Xe(d){if(!d||!d.audio)return[];const e=[];return d.audio.i2s_audio&&(e.push("i2s_audio:"),e.push(`  i2s_lrclk_pin: ${d.audio.i2s_audio.i2s_lrclk_pin}`),e.push(`  i2s_bclk_pin: ${d.audio.i2s_audio.i2s_bclk_pin}`),d.audio.i2s_audio.i2s_mclk_pin&&e.push(`  i2s_mclk_pin: ${d.audio.i2s_audio.i2s_mclk_pin}`),e.push("")),d.audio.speaker&&(e.push("speaker:"),e.push(`  - platform: ${d.audio.speaker.platform}`),e.push("    id: my_speaker"),d.audio.speaker.dac_type&&e.push(`    dac_type: ${d.audio.speaker.dac_type}`),d.audio.speaker.i2s_dout_pin&&e.push(`    i2s_dout_pin: ${d.audio.speaker.i2s_dout_pin}`),d.audio.speaker.mode&&e.push(`    mode: ${d.audio.speaker.mode}`),e.push("")),e}function we(d,e,i=null){const n=[],t=i||(G?G[e]||{}:{});n.push("# ============================================================================"),n.push("# LVGL Configuration"),n.push("# ============================================================================"),n.push(""),n.push("lvgl:"),n.push("  id: my_lvgl"),n.push("  log_level: WARN"),n.push('  bg_color: "0xFFFFFF"'),n.push("  displays:");const o=t.features?.lcd?"my_display":"epaper_display";return n.push(`    - ${o}`),t.touch&&(n.push("  touchscreens:"),n.push("    - my_touchscreen")),n.push(""),n.push("  pages:"),d.forEach((s,r)=>{n.push(`    - id: page_${r}`),s.layout&&/^\d+x\d+$/.test(s.layout)&&n.push(`      layout: ${s.layout}`),n.push("      widgets:");const l=s.widgets||[];if(l.length===0){n.push("        []");return}l.filter(c=>c.type!=="group").forEach(c=>{n.push(`        ${Ce(c)}`);const a=hs(c,t);if(a){const u=Object.keys(a)[0],g=a[u];n.push(`        - ${u}:`),yt(g,n,12)}})}),n}function yt(d,e,i){const n=" ".repeat(i);Object.entries(d).forEach(([t,o])=>{if(!(o==null||o===""))if(Array.isArray(o))o.length===0?e.push(`${n}${t}: []`):(e.push(`${n}${t}:`),o.forEach(s=>{typeof s=="object"?(e.push(`${n}  -`),yt(s,e,i+4)):e.push(`${n}  - ${s}`)}));else if(typeof o=="object")e.push(`${n}${t}:`),yt(o,e,i+2);else if(typeof o=="string"&&o.includes(`
`)){const s=o.split(`
`);if(o.trim().startsWith("!lambda")){e.push(`${n}${t}: ${s[0].trim()}`);const l=s.slice(1).reduce((a,u)=>{if(!u.trim())return a;const g=u.match(/^ */);return Math.min(a,g?g[0].length:0)},1/0),c=l===1/0?0:l;for(let a=1;a<s.length;a++){const u=s[a].trim()===""?"":s[a].substring(c);e.push(`${n}  ${u}`)}}else e.push(`${n}${t}: |-`),s.forEach(r=>{e.push(`${n}  ${r}`)})}else e.push(`${n}${t}: ${o}`)})}function Ce(d){const e=[`# widget:${d.type}`];e.push(`id:${d.id}`),e.push(`type:${d.type}`),e.push(`x:${Math.round(d.x)}`),e.push(`y:${Math.round(d.y)}`);const i=d.w!==void 0?d.w:d.width!==void 0?d.width:0,n=d.h!==void 0?d.h:d.height!==void 0?d.height:0;return e.push(`w:${Math.round(i)}`),e.push(`h:${Math.round(n)}`),d.entity_id&&e.push(`entity:${d.entity_id}`),d.props&&Object.entries(d.props).forEach(([t,o])=>{if(!(o==null||o==="")&&!(t==="id"||t==="type"||t==="x"||t==="y"||t==="w"||t==="h"||t==="entity_id"))if(typeof o=="object")try{e.push(`${t}:${JSON.stringify(o)}`)}catch(s){_.warn(`[serializeWidget] Failed to serialize prop ${t}`,s)}else e.push(`${t}:${o}`)}),e.join(" ")}function hs(d,e){const i=d.props||{};e?.touch||e?.features&&e.features.touch;const n=Math.round(d.x||0),t=Math.round(d.y||0),o=Math.round(d.w||d.width||100),s=Math.round(d.h||d.height||100),r={id:d.id,x:n,y:t,width:o,height:s,hidden:i.hidden||void 0,clickable:i.clickable===!1?!1:void 0,checkable:i.checkable||void 0,scrollable:i.scrollable===!1?!1:void 0,floating:i.floating||void 0,ignore_layout:i.ignore_layout||void 0,scrollbar_mode:i.scrollbar_mode!=="AUTO"?i.scrollbar_mode:void 0},l=window.PluginRegistry;if(l){const m=l.get(d.type);if(m&&typeof m.exportLVGL=="function")return m.exportLVGL(d,{profile:e,common:r,convertColor:c,convertAlign:a,getLVGLFont:u,formatOpacity:g})}if(d.type&&(d.type.startsWith("lvgl_")||d.type.startsWith("shape_")||d.type==="rounded_rect"||d.type==="line"||d.type==="text"||d.type==="progress_bar"||d.type==="qr_code"))return _.warn(`[transpileToLVGL] Widget type ${d.type} has no exportLVGL function. Falling back to generic obj.`),{obj:{...r,bg_color:c(i.bg_color||i.color||"white")}};return null;function c(m){return!m||m==="transparent"?'"0x000000"':m.startsWith("#")?'"0x'+m.substring(1).toUpperCase()+'"':`"${m}"`}function a(m){return m?{left:"top_left",center:"center",right:"top_right"}[m.toLowerCase()]||m.toLowerCase():"top_left"}function u(m,f,y,b){return`font_${(m||"Roboto").toLowerCase().replace(/\s+/g,"_")}_${y||400}_${f||20}${b?"_italic":""}`}function g(m){return m==null?"cover":typeof m=="number"?m>=255?"cover":m<=0?"transp":Math.round(m/255*100)+"%":m}}class ci{constructor(){this.reset(),this.EXTENDED_GLYPHS=[...Array.from({length:95},(e,i)=>`\\U000000${(i+32).toString(16).toUpperCase().padStart(2,"0")}`),...Array.from({length:96},(e,i)=>`\\U000000${(i+160).toString(16).toUpperCase().padStart(2,"0")}`),"\\U000003BC","\\U000003A9","\\U000020AC","\\U00002122"]}reset(){this.definedFontIds=new Set,this.fontLines=[],this.iconCodesBySize=new Map}addFont(e,i,n,t=!1){const o=e.replace(/\s+/g,"_").toLowerCase(),s=parseInt(i)||400,r=t?"_italic":"",l=String(n).replace(".","_"),c=`font_${o}_${s}_${l}${r}`;if(this.definedFontIds.has(c))return c;if(this.definedFontIds.add(c),e!=="Material Design Icons"){const a={id:c,file:{type:"gfonts",family:e,weight:s,italic:t},size:n,glyphs:[...this.EXTENDED_GLYPHS]};this.fontLines.push(a)}return c}trackIcon(e,i){if(!e)return;const n=parseInt(i,10);this.iconCodesBySize.has(n)||this.iconCodesBySize.set(n,new Set);let t=e;/^F[0-9A-F]{4}$/i.test(e)?t=e.toUpperCase():t=window.Utils?window.Utils.getIconCode(e):null,t&&this.iconCodesBySize.get(n).add(t)}getLines(){this.definedFontIds.size===0&&this.addFont("Roboto",400,20);const e=["font:"];this.fontLines.forEach(i=>{e.push("  - file:"),e.push(`      type: ${i.file.type}`),e.push(`      family: "${i.file.family}"`),e.push(`      weight: ${i.file.weight}`),e.push(`      italic: ${i.file.italic?"true":"false"}`),e.push(`    id: ${i.id}`),e.push(`    size: ${Math.round(i.size)}`);const n=i.glyphs.map(t=>`"${t}"`).join(", ");e.push(`    glyphs: [${n}]`)});for(const[i,n]of this.iconCodesBySize.entries()){const t=`font_material_design_icons_400_${i}`;e.push('  - file: "fonts/materialdesignicons-webfont.ttf"'),e.push(`    id: ${t}`),e.push(`    size: ${i}`);const o=Array.from(n).sort().map(s=>`"\\U000${s}"`).join(", ");e.push(`    glyphs: [${o}]`)}return e.length>1?e:[]}}class pi{generateInstructionHeader(e,i){const n=[];n.push("# ============================================================================"),n.push("# ESPHome YAML - Generated by ESPHome Designer"),n.push("# ============================================================================"),n.push(`# TARGET DEVICE: ${e.name||"Unknown"}`);const t=e.features||{},o=e.displayPlatform||(t.lcd?e.id==="reterminal_e1001"?"reterminal_e1001":"LCD":t.epaper?"waveshare_epaper":"Unknown");n.push(`#         - Display Platform: ${o}`),n.push(`#         - PSRAM: ${t.psram?"Yes":"No"}`),n.push(`#         - Touchscreen: ${t.touch?e.touch?.platform||"Yes":"No"}`);let s="esp-idf (Recommended)";t.psram&&(e.chip?.includes("s3")||e.id?.includes("s3"))&&(s="ESP-IDF (Required for stable PSRAM/LVGL)"),n.push(`#         - Framework: ${s}`),n.push("# ============================================================================"),n.push("#"),n.push("# SETUP INSTRUCTIONS:"),n.push("#"),n.push("# STEP 1: Copy the Material Design Icons font file"),n.push("#         - From this repo: resources/fonts/materialdesignicons-webfont.ttf"),n.push("#         - To ESPHome: /config/esphome/fonts/materialdesignicons-webfont.ttf"),n.push("#"),n.push("# STEP 2: Create a new device in ESPHome"),n.push('#         - Click "New Device"'),n.push("#         - Select: ESP32-S3 (or appropriate for your board)"),n.push("#         - Framework: ESP-IDF (Essential for S3 stability)"),n.push("#"),n.push("# STEP 3: MERGE this snippet into your YAML"),n.push("#         - Paste this snippet at the end of your configuration."),n.push("#         - System sections (esphome, esp32, wifi, logger) are commented"),n.push("#           out to avoid conflicts with your existing base setup."),n.push("#"),n.push("# TIP: For reTerminal / S3 devices, if you cannot see logs via USB,"),n.push("#      add this to your base 'logger:' section:"),n.push("#      hardware_uart: USB_CDC"),n.push("#"),n.push("# ============================================================================"),n.push(""),n.push("# ===================================="),n.push("# Device Settings"),n.push("# ===================================="),n.push(`# Orientation: ${i.orientation||"landscape"}`),n.push(`# Dark Mode: ${i.darkMode?"enabled":"disabled"}`),n.push(`# Refresh Interval: ${i.refreshInterval||600}`);const r=!!(e.features&&(e.features.lcd||e.features.oled));let l;if(r){const c=i.lcdEcoStrategy||"backlight_off";l={always_on:"Always On",backlight_off:"Backlight Off Schedule",halt_updates:"Halt Updates",deep_sleep:"Deep Sleep"}[c]||c}else l=i.deepSleepEnabled?"Ultra Eco (Deep Sleep)":i.sleepEnabled?"Eco (Light Sleep)":"Always On";return n.push(`# Power Strategy: ${l}`),n.push(`# Deep Sleep Interval: ${i.deepSleepInterval||600}`),n.push("# ===================================="),n.push(""),n}generateSystemSections(e,i){const n=[],t=e.chip||"esp32-s3",o=e.board||"esp32-s3-devkitc-1";return n.push("# esphome:"),n.push("#   name: your-device-name"),n.push("#   comment: 'Snippet generated by ESPHome Designer'"),n.push("#   on_boot:"),n.push("#     priority: 600"),n.push("#     then:"),e.battery&&e.pins&&e.pins.batteryEnable&&n.push("#       - output.turn_on: bsp_battery_enable"),n.push("#       - delay: 2s"),n.push("#       - script.execute: manage_run_and_sleep"),i.autoCycleEnabled&&n.push("#       - script.execute: auto_cycle_timer"),n.push("#"),n.push("# esp32:"),n.push(`#   board: ${o}`),n.push("#   framework:"),n.push("#     type: esp-idf"),t.includes("s3")&&(n.push("#     sdkconfig_options:"),n.push("#       CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240: y"),n.push("#       CONFIG_ESP32S3_DATA_CACHE_64KB: y")),n.push("#"),n.push("# logger:"),t.includes("s3")&&n.push("#   hardware_uart: USB_CDC # Enable for USB debugging on S3"),n.push("#   level: DEBUG"),n.push("#"),n.push("# api:"),n.push("# ota:"),n.push("# wifi:"),n.push("#   # ... your wifi config here"),n.push(""),n}generateScriptSection(e,i,n){const t=[],o=n.features?.lcd?"my_display":"epaper_display",s=e.autoCycleEnabled&&i.length>1,r=!!(n.features&&(n.features.lcd||n.features.oled)),l=r?500:3e3;if(t.push("script:"),t.push("  - id: change_page_to"),t.push("    parameters:"),t.push("      target_page: int"),t.push("    then:"),t.push("      - lambda: |-"),t.push(`          int pages_count = ${i.length};`),t.push("          int target = target_page;"),t.push("          while (target < 0) target += pages_count;"),t.push("          target %= pages_count;"),t.push(""),t.push(`          // Debounce: Ignore page changes within ${l}ms of last change`),t.push(`          // (adjusted for ${r?"LCD":"e-paper"} display update time)`),t.push("          uint32_t now = millis();"),t.push(`          if (now - id(last_page_switch_time) < ${l}) {`),t.push('            ESP_LOGD("display", "Page change ignored (debounce), last switch was %d ms ago", now - id(last_page_switch_time));'),t.push("            return;"),t.push("          }"),t.push(""),t.push("          if (id(display_page) != target) {"),t.push("            // Set debounce time BEFORE display update (update takes ~1.6s)"),t.push("            id(last_page_switch_time) = now;"),t.push("            id(display_page) = target;"),t.push(`            id(${o}).update();`),t.push('            ESP_LOGI("display", "Switched to page %d", target);'),t.push("            // Restart refresh logic"),t.push("            if (id(manage_run_and_sleep).is_running()) id(manage_run_and_sleep).stop();"),t.push("            id(manage_run_and_sleep).execute();"),t.push("          }"),t.push("  - id: manage_run_and_sleep","    mode: restart","    then:"),t.push('      - logger.log: "Waiting for sync..."'),t.push("      - wait_until:"),t.push("          condition:"),t.push("            lambda: 'return id(ha_time).now().is_valid() && api_is_connected();'"),t.push("          timeout: 60s"),t.push("      - delay: 5s"),t.push("      - lambda: 'id(page_refresh_current_s) = id(page_refresh_default_s);'"),t.push(`      - component.update: ${o}`),t.push("      - delay: !lambda 'return id(page_refresh_current_s) * 1000;'"),t.push("      - script.execute: manage_run_and_sleep"),s){const c=e.autoCycleIntervalS||30;t.push("  - id: auto_cycle_timer","    mode: restart","    then:"),t.push(`      - delay: ${c}s`),t.push("      - script.execute:"),t.push("          id: change_page_to"),t.push("          target_page: !lambda 'return id(display_page) + 1;'"),t.push("      - script.execute: auto_cycle_timer")}return t}}let us=class extends ke{constructor(){super(),this.fonts=new ci,this.yaml=new pi,this.reset()}reset(){this.fonts&&this.fonts.reset(),this.usedPlugins=new Set}async generate(e){if(!e)return console.error("ESPHomeAdapter: Missing layout"),"";this.reset();const i=e.pages||[],n=e.deviceModel||(h?h.deviceModel:null)||window.currentDeviceModel||"reterminal_e1001",t=G||{},o=window.DEVICE_PROFILES||{};let r={...t,...o}[n]||{};if(n==="custom"&&e.customHardware){const v=e.customHardware;r={id:"custom",name:"Custom Device",chip:v.chip||"esp32-s3",displayPlatform:v.displayDriver||"generic_st7789",resolution:{width:v.resWidth||800,height:v.resHeight||480},shape:v.shape||"rect",pins:{i2c:v.pins?.sda?{sda:v.pins.sda,scl:v.pins.scl}:null,spi:v.pins?.clk?{clk:v.pins.clk,mosi:v.pins.mosi}:null,display:{cs:v.pins?.cs,dc:v.pins?.dc,reset:v.pins?.rst,busy:v.pins?.busy}},features:{psram:!!v.psram,lcd:v.tech==="lcd",epaper:v.tech==="epaper",touch:v.touchTech&&v.touchTech!=="none"},backlight:v.pins?.backlight?{platform:"gpio",pin:v.pins.backlight}:null,touch:v.touchTech&&v.touchTech!=="none"?{platform:v.touchTech,sda:v.pins?.sda,scl:v.pins?.scl,interrupt_pin:v.pins?.touch_int,reset_pin:v.pins?.touch_rst}:null}}let l=!!(r.features&&(r.features.lvgl||r.features.lv_display));const c=e.renderingMode||(h?h.settings?.renderingMode:null);if(c==="direct"?(l=!1,_.log("[ESPHomeAdapter] Rendering mode set to 'direct', skipping LVGL generation")):c==="lvgl"&&(l=!0,_.log("[ESPHomeAdapter] Rendering mode set to 'lvgl', forcing LVGL generation")),!l)for(const v of i){if(v.widgets){for(const M of v.widgets.filter(E=>!E.hidden))if(M.type.startsWith("lvgl_")){l=!0;break}}if(l)break}const a=[];r.isPackageBased||(a.push(...this.yaml.generateInstructionHeader(r,e)),a.push(...this.yaml.generateSystemSections(r,e)),a.push(""));const u=r.features?.lcd?"my_display":"epaper_display";this.preProcessWidgetsPromise=this.preProcessWidgets(i),await this.preProcessWidgetsPromise;let g=null;r.isPackageBased&&(r.isOfflineImport&&r.content?g=r.content:r.hardwarePackage&&(g=await this.fetchHardwarePackage(r.hardwarePackage)));const m=[];i.forEach((v,M)=>{v.widgets&&v.widgets.forEach(E=>{E.hidden||(E._pageIndex=M,m.push(E))})});const f=new Set,y=new Set,b=new Map,w={widgets:m,profile:r,displayId:u,adapter:this,isLvgl:l,seenEntityIds:f,seenSensorIds:y,pendingTriggers:b};if(V){const v=[];v.push("- id: display_page","  type: int","  restore_value: true","  initial_value: '0'");const M=!!(r.features&&r.features.epaper),E=!!(r.features&&r.features.lcd)||!M,L=e.refreshInterval||(E?60:e.deepSleepInterval||600);v.push("- id: page_refresh_default_s","  type: int","  restore_value: true",`  initial_value: '${L}'`),v.push("- id: page_refresh_current_s","  type: int","  restore_value: false","  initial_value: '60'"),v.push("- id: last_page_switch_time","  type: uint32_t","  restore_value: false","  initial_value: '0'"),V.onExportGlobals({...w,lines:v}),v.length>0&&(a.push("globals:"),a.push(...v.map(C=>"  "+C))),!(g&&g.includes("psram:"))&&r.features?.psram&&Ue&&a.push(...Ue(r)),r.isPackageBased?a.some(x=>String(x).split(`
`).some(O=>O.trim()==="time:"))||(a.push("time:","  - platform: homeassistant","    id: ha_time"),y.add("ha_time")):(a.push("http_request:","  verify_ssl: false","  timeout: 20s","  buffer_size_rx: 4096"),Ne&&a.push(...Ne(r)),He&&a.push(...He(r)),$e&&a.push(...$e(r)),Ve&&a.push(...Ve(r)),Ye&&a.push(...Ye(r)),We&&a.push(...We(r)),qe&&a.push(...qe(r)),Xe&&a.push(...Xe(r)),a.some(x=>String(x).split(`
`).some(O=>O.trim()==="time:"))||(a.push("time:","  - platform: homeassistant","    id: ha_time"),y.add("ha_time"))),r.features&&(r.pins?.batteryAdc&&(y.add("battery_voltage"),y.add("battery_level")),r.features.sht4x&&(y.add("sht4x_sensor"),y.add("sht4x_temperature"),y.add("sht4x_humidity")),(r.features.sht3x||r.features.sht3xd)&&(y.add("sht3x_sensor"),y.add("sht3x_temperature"),y.add("sht3x_humidity")),r.features.shtc3&&(y.add("shtc3_sensor"),y.add("shtc3_temperature"),y.add("shtc3_humidity"))),ze&&a.push(...ze(r,[],u,m));const H=[];V.onExportNumericSensors({...w,lines:H,mainLines:a});const z=this.processPendingTriggers(H,b,l,"on_value");z.length>0&&(a.some(C=>C==="sensor:")||a.push("sensor:"),a.push(...z.flatMap(C=>C.split(`
`).map(x=>"  "+x))));const F=i.flatMap(C=>C.widgets||[]),A=[];if(F.forEach(C=>{let x=(C.entity_id||"").trim();const O=C.props||{};if(!x||O.is_local_sensor)return;["progress_bar","sensor_text","graph","battery_icon","wifi_signal","ondevice_temperature","ondevice_humidity"].includes(C.type)&&!x.includes(".")&&(x=`sensor.${x}`);const se=x.includes(".")&&!x.startsWith("weather.")&&!x.startsWith("text_sensor.")&&!x.startsWith("binary_sensor."),et=["switch.","light.","fan.","input_boolean.","cover.","lock."].some(ne=>x.startsWith(ne));if(se&&!et&&!f.has(x)){const ne=x.replace(/[^a-zA-Z0-9_]/g,"_");y.has(ne)||(f.add(x),y.add(ne),A.push("- platform: homeassistant"),A.push(`  id: ${ne}`),A.push(`  entity_id: ${x}`),A.push("  internal: true"))}}),A.length>0){a.some(x=>x==="sensor:")||a.push("sensor:");const C=this.processPendingTriggers(A,b,l,"on_value");a.push(...C.flatMap(x=>x.split(`
`).map(O=>"  "+O)))}const Y=[];V.onExportTextSensors({...w,lines:Y});const Z=this.processPendingTriggers(Y,b,l,"on_value");Z.length>0&&(a.push("text_sensor:"),a.push(...Z.flatMap(C=>C.split(`
`).map(x=>"  "+x))));const j=[];if(!r.isPackageBased&&Ge){const C=Ge(r,i.length,u,[]);C.length>0&&C[0].trim()==="binary_sensor:"?j.push(...C.slice(1).map(x=>x.startsWith("  ")?x.slice(2):x)):j.push(...C)}V.onExportBinarySensors({...w,lines:j});const p=this.processPendingTriggers(j,b,l,"on_state");p.length>0&&(a.push("binary_sensor:"),a.push(...p.flatMap(C=>C.split(`
`).map(x=>"  "+x))));const P=i.flatMap(C=>C.widgets||[]),X=["binary_sensor.","switch.","light.","input_boolean.","fan.","cover.","vacuum.","lock."],D=[];if(P.forEach(C=>{const x=(C.condition_entity||"").trim(),O=(C.entity_id||"").trim();[x,O].forEach($=>{if(!$)return;if(X.some(te=>$.startsWith(te))&&!f.has($)){const te=$.replace(/[^a-zA-Z0-9_]/g,"_");y.has(te)||(f.add($),y.add(te),D.push("- platform: homeassistant"),D.push(`  id: ${te}`),D.push(`  entity_id: ${$}`),D.push("  internal: true"))}})}),D.length>0){a.some(x=>x==="binary_sensor:")||a.push("binary_sensor:");const C=this.processPendingTriggers(D,b,l,"on_state");a.push(...C.flatMap(x=>x.split(`
`).map(O=>"  "+O)))}if(!r.isPackageBased&&je){const C=je(r,i.length,u);C.length>0&&a.push(...C)}const I=V.getAll(),ee=["image","online_image","graph","qr_code"];I.sort((C,x)=>{const O=ee.indexOf(C.id),$=ee.indexOf(x.id);return O!==-1&&$!==-1?O-$:O!==-1?-1:$!==-1?1:C.id.localeCompare(x.id)}),I.forEach(C=>C.onExportComponents&&C.onExportComponents({...w,lines:a}))}const S=this.generateDisplayLambda(i,e,r);a.push(...this.fonts.getLines());const T=this.yaml.generateScriptSection(e,i,r);if(T.length>0&&a.push(...T),l&&we){const v=we(i,n,r);v&&v.length>0&&a.push(...v)}const R=l&&we;if(r.isPackageBased){if(g){const v=/^(\s*)# __LAMBDA_PLACEHOLDER__/m,M=g.match(v);if(M){const E=M[1],L="# __LAMBDA_PLACEHOLDER__",k=new RegExp(`lambda:\\s*\\|-\\s*[\\r\\n]+\\s*${L.replace("#","\\#")}`).test(g);if(R)g=g.replace(v,"");else{const H=(k?"":E+`lambda: |-
`)+S.map(z=>E+"  "+z).join(`
`);g=g.replace(v,H)}}return g=this.applyPackageOverrides(g,r,e.orientation),this.sanitizePackageContent(g)+`

`+a.join(`
`)}}else{const v=Fe?Fe(r,e.orientation):[];a.push(...v);for(let M=0;M<a.length;M++)if(a[M].trim()==="display:"){let E=M+1;for(;E<a.length&&(a[E].startsWith("  ")||a[E].trim()==="");)E++;R||a.splice(E,0,"    lambda: |-",...S.map(L=>"      "+L));break}}return a.join(`
`)}async preProcessWidgets(e){for(const i of e)if(i.widgets)for(const n of i.widgets.filter(t=>!t.hidden&&t.type!=="group")){const t=n.type,o=V?await V.load(t):null;o&&(this.usedPlugins.add(o),typeof o.collectRequirements=="function"&&o.collectRequirements(n,{trackIcon:(s,r)=>this.fonts.trackIcon(s,r),addFont:(s,r,l,c)=>this.fonts.addFont(s,r,l,c)}))}}generateDisplayLambda(e,i,n){const t=[],o=n.features?.inverted_colors||i.invertedColors,s=!!(n.features&&n.features.epaper);return o?(t.push("const auto COLOR_WHITE = Color(0, 0, 0); // Inverted for e-ink"),t.push("const auto COLOR_BLACK = Color(255, 255, 255); // Inverted for e-ink")):(t.push("const auto COLOR_WHITE = Color(255, 255, 255);"),t.push("const auto COLOR_BLACK = Color(0, 0, 0);")),t.push("const auto COLOR_RED = Color(255, 0, 0);"),t.push("const auto COLOR_GREEN = Color(0, 255, 0);"),t.push("const auto COLOR_BLUE = Color(0, 0, 255);"),t.push("const auto COLOR_YELLOW = Color(255, 255, 0);"),t.push("const auto COLOR_ORANGE = Color(255, 165, 0);"),t.push("auto color_off = COLOR_WHITE;"),t.push("auto color_on = COLOR_BLACK;"),t.push(""),t.push("// Helper to apply a simple grey dither mask for e-paper (checkerboard)"),t.push("auto apply_grey_dither_mask = [&](int x_start, int y_start, int w, int h, int r = 0) {"),t.push("  for (int y = y_start; y < y_start + h; y++) {"),t.push("    for (int x = x_start; x < x_start + w; x++) {"),t.push("      if (r > 0) {"),t.push("        int dx = 0, dy = 0;"),t.push("        if (x < x_start + r && y < y_start + r) { dx = x_start + r - x; dy = y_start + r - y; }"),t.push("        else if (x >= x_start + w - r && y < y_start + r) { dx = x - (x_start + w - r - 1); dy = y_start + r - y; }"),t.push("        else if (x < x_start + r && y >= y_start + h - r) { dx = x_start + r - x; dy = y - (y_start + h - r - 1); }"),t.push("        else if (x >= x_start + w - r && y >= y_start + h - r) { dx = x - (x_start + w - r - 1); dy = y - (y_start + h - r - 1); }"),t.push("        if (dx*dx + dy*dy > r*r) continue;"),t.push("      }"),t.push("      if ((x + y) % 2 == 0) it.draw_pixel_at(x, y, COLOR_WHITE);"),t.push("      else it.draw_pixel_at(x, y, COLOR_BLACK);"),t.push("    }"),t.push("  }"),t.push("};"),t.push(""),t.push("// Helper to apply grey dither to text (subtractive - erases every other black pixel)"),t.push("auto apply_grey_dither_to_text = [&](int x_start, int y_start, int w, int h) {"),t.push("  for (int y = y_start; y < y_start + h; y++) {"),t.push("    for (int x = x_start; x < x_start + w; x++) {"),t.push("      if ((x + y) % 2 == 0) it.draw_pixel_at(x, y, COLOR_WHITE);"),t.push("    }"),t.push("  }"),t.push("};"),window.PluginRegistry&&window.PluginRegistry.onExportHelpers({lines:t,widgets:e.flatMap(r=>r.widgets||[])}),t.push("int currentPage = id(display_page);"),e.forEach((r,l)=>{t.push(`if (currentPage == ${l}) {`),t.push(`  // page:name "${r.name||"Page "+(l+1)}"`),t.push(`  // page:dark_mode "${r.dark_mode||"inherit"}"`),t.push(`  // page:refresh_type "${r.refresh_type||"interval"}"`),t.push(`  // page:refresh_time "${r.refresh_time||""}"`),t.push("  // Clear screen for this page"),t.push("  it.fill(COLOR_WHITE);"),t.push("  color_off = COLOR_WHITE;"),t.push("  color_on = COLOR_BLACK;"),r.widgets&&r.widgets.filter(c=>!c.hidden&&c.type!=="group").forEach(c=>{const a=this.generateWidget(c,{profile:n,layout:i,adapter:this,isEpaper:s});if(a.length>0){const u=a.reduce((m,f)=>{if(!f.trim())return m;const y=f.match(/^ */);return Math.min(m,y?y[0].length:0)},1/0),g=u===1/0?0:u;t.push(...a.map(m=>m.trim()?"  "+m.substring(g):""))}}),t.push("}")}),t}generateWidget(e,i){if(e.type==="group")return[];const n=[],t=V?V.get(e.type):null,o=e.type&&e.type.startsWith("lvgl_");if(t&&typeof t.export=="function"){const s={...i,lines:n,addFont:(l,c,a,u)=>this.fonts.addFont(l,c,a,u),getColorConst:l=>K?K.getColorConst(l):`"${l}"`,getAlignX:(l,c,a)=>K?K.getAlignX(l,c,a):c,getAlignY:(l,c,a)=>K?K.getAlignY(l,c,a):c,addDitherMask:(l,c,a,u,g,m,f,y)=>K?K.addDitherMask(l,c,a,u,g,m,f,y||0):null,sanitize:l=>this.sanitize(l),getCondProps:l=>this.getCondProps(l),getConditionCheck:l=>this.getConditionCheck(l),Utils:K,COLORS:Je,ALIGNMENT:Ze,TEXT_Y_OFFSET:0,RECT_Y_OFFSET:0},r=t.export(e,s);r&&Array.isArray(r)?n.push(...r):r&&typeof r=="string"&&n.push(r)}else o?Ce?n.push(Ce(e)):n.push(`// widget:${e.type} id:${e.id} x:${e.x} y:${e.y} w:${e.width} h:${e.height}`):(n.push(`// widget:${e.type} id:${e.id} status:unsupported`),n.push(`        // Unsupported widget type: ${e.type}`));return n}processPendingTriggers(e,i,n,t="on_value"){if(!n||!i||i.size===0)return e;const o=[];for(let s=0;s<e.length;s++){const r=e[s];o.push(r);const l=r.match(/^\s*(entity_id|id):\s*"?([^"]+)"?/);if(l){const c=l[2].trim();if(i.has(c)){let a=!1;for(let u=s+1;u<Math.min(s+5,e.length);u++)if(e[u].trim()===`${t}:`){a=!0;break}if(!a){const u=(r.match(/^\s*/)||[""])[0].length,g=" ".repeat(u);o.push(`${g}${t}:`),o.push(`${g}  then:`);for(const m of i.get(c))m.split(`
`).forEach(y=>{o.push(`${g}    ${y}`)})}}}}return o}async fetchHardwarePackage(e){let i=e;window.location.pathname.includes("/esphome-designer/editor")&&!e.startsWith("http")&&!e.startsWith("/")&&(i="/esphome-designer/editor/static/"+e);try{const n=await fetch(i,{cache:"no-store"});if(!n.ok)throw new Error(`HTTP ${n.status}`);return await n.text()}catch(n){return _.error("Failed to fetch hardware package:",n),`# ERROR LOADING PROFILE: ${n.message}`}}sanitizePackageContent(e){if(!e)return"";const i=["esphome:","esp32:","psram:","wifi:","api:","ota:","logger:","web_server:","captive_portal:","platformio_options:","preferences:","substitutions:"],n=e.split(`
`),t=[];let o=!1;for(let s of n){const r=s.trim();if(r.length===0){t.push(s);continue}(s.match(/^\s*/)||[""])[0].length===0&&r.endsWith(":")?(o=i.some(c=>r.startsWith(c)),o?t.push("# "+s+" # (Auto-commented)"):t.push(s)):o?t.push("# "+s):t.push(s)}return t.join(`
`)}applyPackageOverrides(e,i,n){if(i.name?.includes("Waveshare Touch LCD 7")){let t=0;n==="portrait"?t=90:n==="landscape"?t=0:n==="portrait_inverted"?t=270:n==="landscape_inverted"&&(t=180),e=e.replace(/rotation:\s*\d+/g,`rotation: ${t}`);const o=e.match(/^(\s*)id:\s*my_touchscreen/m);if(o){const s=o[1];let r="";t===0?r=`transform:
${s}  swap_xy: false
${s}  mirror_x: false
${s}  mirror_y: false`:t===90?r=`transform:
${s}  swap_xy: true
${s}  mirror_x: false
${s}  mirror_y: true`:t===180?r=`transform:
${s}  swap_xy: false
${s}  mirror_x: true
${s}  mirror_y: true`:t===270&&(r=`transform:
${s}  swap_xy: true
${s}  mirror_x: true
${s}  mirror_y: false`),r&&(e=e.replace(/(id:\s*my_touchscreen[^\n\r]*[\r\n]+)/,`$1${s}${r}
`))}}return e}getCondProps(e){const i=(e.condition_entity||"").trim();if(!i)return"";const n=e.condition_operator||"==";let t=` cond_ent:"${i}" cond_op:"${n}"`;return n==="range"?(e.condition_min!==void 0&&e.condition_min!==null&&(t+=` cond_min:"${e.condition_min}"`),e.condition_max!==void 0&&e.condition_max!==null&&(t+=` cond_max:"${e.condition_max}"`)):e.condition_state!==void 0&&e.condition_state!==null&&(t+=` cond_state:"${e.condition_state}"`),t}getConditionCheck(e){const i=(e.condition_entity||"").trim();if(!i)return"";const n=e.condition_operator||"==",t=(e.condition_state||"").trim(),o=t.toLowerCase(),s=e.condition_min,r=e.condition_max,l=i.replace(/[^a-zA-Z0-9_]/g,"_"),a=["binary_sensor.","switch.","light.","input_boolean.","fan.","cover.","vacuum.","lock."].some(y=>i.startsWith(y));let g=i.startsWith("text_sensor.");if(!g&&!a&&n!=="range"){const y=parseFloat(t),b=["on","off","true","false","open","closed","locked","unlocked","home","not_home","occupied","clear","active","inactive","detected","idle"];t&&isNaN(y)&&!b.includes(o)&&(g=!0)}let m=`id(${l}).state`;g&&i.startsWith("text_sensor.");let f="";if(n==="=="||n==="!="||n===">"||n==="<"||n===">="||n==="<=")if(g)f=`${m} ${n} "${t}"`;else if(a){const b=["on","true","1","open","locked","home","occupied","active","detected"].includes(o);n==="=="?f=b?m:`!${m}`:n==="!="?f=b?`!${m}`:m:f=`(int)${m} ${n} ${b?1:0}`}else{let y=parseFloat(t);isNaN(y)&&(["on","true","open","locked","home","occupied","active","detected"].includes(o)?y=1:["off","false","closed","unlocked","not_home","clear","inactive","idle"].includes(o)&&(y=0)),f=`${m} ${n} ${isNaN(y)?0:y}`}else if(n==="range"){const y=parseFloat(s),b=parseFloat(r);f=`${m} >= ${isNaN(y)?0:y} && ${m} <= ${isNaN(b)?100:b}`}return f?`if (${f}) {`:""}sanitize(e){return e?e.replace(/"/g,'\\"'):""}};window.ESPHomeAdapter=us;function gs(d){const{name:e,chip:i,resWidth:n,resHeight:t,shape:o,psram:s,displayDriver:r,pins:l,touchTech:c}=d,a=[];if(a.push("# ============================================================================"),a.push(`# TARGET DEVICE: ${e}`),a.push(`# Name: ${e}`),a.push(`# Resolution: ${n}x${t}`),a.push(`# Shape: ${o}`),a.push("#"),a.push(`#         - Display Platform: ${r||"Unknown"}`),a.push(`#         - Touchscreen: ${c||"None"}`),a.push(`#         - PSRAM: ${s?"Yes":"No"}`),a.push("# ============================================================================"),a.push("#"),a.push("# SETUP INSTRUCTIONS:"),a.push("#"),a.push("# STEP 1: Copy the Material Design Icons font file"),a.push("#         - From this repo: font_ttf/font_ttf/materialdesignicons-webfont.ttf"),a.push("#         - To ESPHome: /config/esphome/fonts/materialdesignicons-webfont.ttf"),a.push("#         (Create the fonts folder if it doesn't exist)"),a.push("#"),a.push("# STEP 2: Create a new device in ESPHome"),a.push('#         - Click "New Device"'),a.push("#         - Name: your-device-name"),i==="ESP32 (Standard)"?(a.push("#         - Select: ESP32"),a.push("#         - Board: esp32dev (or specific board)"),a.push("#         - Framework: esp-idf (Recommended) or arduino")):(a.push("#         - Select: ESP32-S3"),a.push("#         - Board: esp32-s3-devkitc-1"),a.push("#         - Framework: esp-idf (Recommended) or arduino")),a.push("#"),a.push("# ============================================================================"),a.push(""),a.push("# Infrastructure (Comment out if pasting into existing config)"),a.push("# esphome: # (Auto-commented)"),a.push(`#   name: ${e.toLowerCase().replace(/[^a-z0-9]/g,"-")}`),a.push("#"),a.push("# esp32: # (Auto-commented)"),a.push(`#   board: ${ms(i)}`),a.push("#   framework:"),a.push("#     type: esp-idf"),s&&i.includes("s3")&&(a.push("#     # For stability on S3 devices with high-res displays/LVGL:"),a.push("#     advanced:"),a.push("#       execute_from_psram: true")),a.push(""),s&&(a.push("# psram: # (Auto-commented)"),i.includes("s3")&&(a.push("#   # Quad or Octal depending on your board"),a.push("#   mode: quad"),a.push("#   speed: 80MHz")),a.push("")),l.clk&&l.mosi&&(a.push("spi:"),a.push(`  clk_pin: ${l.clk}`),a.push(`  mosi_pin: ${l.mosi}`),l.miso&&a.push(`  miso_pin: ${l.miso}`),a.push("")),l.sda&&l.scl&&(a.push("i2c:"),a.push(`  sda: ${l.sda}`),a.push(`  scl: ${l.scl}`),a.push("  scan: true"),a.push("")),a.push("display:"),a.push(`  - platform: ${r}`),l.cs&&a.push(`    cs_pin: ${l.cs}`),l.dc&&a.push(`    dc_pin: ${l.dc}`),l.rst&&a.push(`    reset_pin: ${l.rst}`),l.busy&&a.push(`    busy_pin: ${l.busy}`),r==="st7789v"&&(a.push("    model: Custom"),a.push("    id: my_display"),a.push(`    width: ${n}`),a.push(`    height: ${t}`),a.push("    offset_height: 0"),a.push("    offset_width: 0")),a.push("    lambda: |-"),a.push("      # __LAMBDA_PLACEHOLDER__"),a.push(""),l.backlight){const u=d.backlightMinPower??.07,g=d.backlightInitial??.8,m=!!d.antiburn;a.push("output:"),a.push("  - platform: ledc"),a.push(`    pin: ${l.backlight}`),a.push("    id: backlight_brightness_output"),a.push(`    min_power: "${u}"`),a.push("    zero_means_zero: true"),a.push(""),a.push("light:"),a.push("  - platform: monochromatic"),a.push("    output: backlight_brightness_output"),a.push("    id: lcdbacklight_brightness"),a.push("    name: LCD Backlight"),a.push("    icon: mdi:wall-sconce-flat-outline"),a.push("    restore_mode: ALWAYS_ON"),a.push("    initial_state:"),a.push(`      brightness: "${g}"`),m&&(a.push("    on_turn_off:"),a.push("      - script.execute: start_antiburn"),a.push("    on_turn_on:"),a.push("      - script.execute: stop_antiburn")),a.push(""),m&&(a.push("script:"),a.push("  - id: start_antiburn"),a.push("    then:"),a.push("      - delay: 5min"),a.push("      - logger.log: Starting automatic antiburn."),a.push("      - switch.turn_on: switch_antiburn"),a.push("  - id: stop_antiburn"),a.push("    then:"),a.push("      - script.stop: start_antiburn"),a.push("      - switch.turn_off: switch_antiburn"),a.push(""),a.push("switch:"),a.push("  - platform: template"),a.push("    name: Antiburn"),a.push("    id: switch_antiburn"),a.push("    icon: mdi:television-shimmer"),a.push("    optimistic: true"),a.push("    entity_category: config"),a.push("    turn_on_action:"),a.push('      - logger.log: "Starting Antiburn"'),a.push("      - if:"),a.push("          condition: lvgl.is_paused"),a.push("          then:"),a.push("            - lvgl.resume:"),a.push("            - lvgl.widget.redraw:"),a.push("      - lvgl.pause:"),a.push("          show_snow: true"),a.push("    turn_off_action:"),a.push('      - logger.log: "Stopping Antiburn"'),a.push("      - if:"),a.push("          condition: lvgl.is_paused"),a.push("          then:"),a.push("            - lvgl.resume:"),a.push("            - lvgl.widget.redraw:"),a.push(""))}return c!=="none"&&(a.push("touchscreen:"),a.push(`  - platform: ${c}`),l.touch_int&&a.push(`    interrupt_pin: ${l.touch_int}`),l.touch_rst&&a.push(`    reset_pin: ${l.touch_rst}`),a.push("")),a.join(`
`)}function ms(d){switch(d){case"esp32-s3":return"esp32-s3-devkitc-1";case"esp32-c3":return"esp32-c3-devkitm-1";case"esp32-c6":return"esp32-c6-devkitc-1";case"esp32":return"esp32dev";default:return"esp32-s3-devkitc-1"}}class fs{constructor(){_.log("[DeviceSettings] Constructor called - Instance ID check"),this.modal=document.getElementById("deviceSettingsModal"),this.closeBtn=document.getElementById("deviceSettingsClose"),this.saveBtn=document.getElementById("deviceSettingsSave"),this.nameInput=document.getElementById("deviceName"),this.modelInput=document.getElementById("deviceModel"),this.orientationInput=document.getElementById("deviceOrientation"),this.darkModeInput=document.getElementById("deviceDarkMode"),this.extendedLatinGlyphsInput=document.getElementById("deviceExtendedLatinGlyphs"),this.invertedColorsInput=document.getElementById("deviceInvertedColors"),this.modeStandard=document.getElementById("mode-standard"),this.modeSleep=document.getElementById("setting-sleep-enabled"),this.modeManual=document.getElementById("setting-manual-refresh"),this.modeDeepSleep=document.getElementById("setting-deep-sleep-enabled"),this.modeDaily=document.getElementById("setting-daily-refresh-enabled"),this.sleepStart=document.getElementById("setting-sleep-start"),this.sleepEnd=document.getElementById("setting-sleep-end"),this.sleepRow=document.getElementById("sleep-times-row"),this.dailyRefreshTime=document.getElementById("setting-daily-refresh-time"),this.dailyRefreshRow=document.getElementById("daily-refresh-row"),this.deepSleepInterval=document.getElementById("setting-deep-sleep-interval"),this.deepSleepRow=document.getElementById("deep-sleep-interval-row"),this.refreshIntervalInput=document.getElementById("setting-refresh-interval"),this.refreshIntervalRow=document.getElementById("global-refresh-row"),this.noRefreshStart=document.getElementById("setting-no-refresh-start"),this.noRefreshEnd=document.getElementById("setting-no-refresh-end"),this.autoCycleEnabled=document.getElementById("setting-auto-cycle"),this.autoCycleInterval=document.getElementById("setting-auto-cycle-interval"),this.autoCycleRow=document.getElementById("field-auto-cycle-interval"),this.customHardwareSection=document.getElementById("customHardwareSection"),this.customFieldsContainer=this.customHardwareSection,this.customChip=document.getElementById("customChip"),this.customTech=document.getElementById("customTech"),this.customRes=document.getElementById("customRes"),this.customShape=document.getElementById("customShape"),this.customPsram=document.getElementById("customPsram"),this.customDisplayDriver=document.getElementById("customDisplayDriver"),this.customTouchTech=document.getElementById("customTouchTech"),this.touchPinsGrid=document.getElementById("touchPinsGrid"),this.customProfileNameInput=document.getElementById("customProfileName"),this.strategyEpaperGroup=document.getElementById("strategy-epaper-group"),this.strategyLcdGroup=document.getElementById("strategy-lcd-group"),this.renderingModeInput=document.getElementById("renderingMode"),this.renderingModeField=document.getElementById("renderingModeField")}init(){this.closeBtn&&this.closeBtn.addEventListener("click",()=>this.close());const e=document.getElementById("importHardwareBtn"),i=document.getElementById("hardwareFileInput");e&&i&&(e.addEventListener("click",n=>{n.preventDefault(),i.click()}),i.addEventListener("change",async n=>{if(n.target.files.length>0){const t=n.target.files[0];try{await Dt(t)}catch{}i.value=""}})),this.populateDeviceSelect(),this.saveBtn&&this.saveBtn.addEventListener("click",()=>this.close()),this.setupAutoSaveListeners(),this.setupCustomHardwareListeners()}setupCustomHardwareListeners(){this.modelInput&&(this.modelInput.addEventListener("change",()=>{this.updateCustomSectionVisibility()}),this.customTech&&this.customTech.addEventListener("change",()=>{this.updateStrategyGroupVisibility()}),this.customTouchTech&&this.customTouchTech.addEventListener("change",()=>{this.touchPinsGrid&&(this.touchPinsGrid.style.display=this.customTouchTech.value==="none"?"none":"grid")}),this.customShape&&this.customShape.addEventListener("change",()=>{if(this.customShape.value==="round"&&this.customRes){const e=(this.customRes.value||"800x480").split("x"),i=parseInt(e[0])||480,n=parseInt(e[1])||480,t=Math.min(i,n);this.customRes.value=`${t}x${t}`,_.log(`[DeviceSettings] Auto-set square resolution for round display: ${t}x${t}`),this.customRes.dispatchEvent(new Event("change"))}}),document.body.addEventListener("click",async e=>{if(e.target&&e.target.id==="saveCustomProfileBtn"){if(e.preventDefault(),e.stopImmediatePropagation(),this._isSavingProfile)return;this._isSavingProfile=!0,_.log("[DeviceSettings] saveCustomProfileBtn clicked (Delegate+Debounce)");try{typeof this.handleSaveCustomProfile=="function"?await this.handleSaveCustomProfile():(_.error("[DeviceSettings] handleSaveCustomProfile missing"),alert("Error: Save function missing on DeviceSettings instance"))}catch(i){console.error(i),alert("Error saving profile: "+i.message)}finally{setTimeout(()=>{this._isSavingProfile=!1},1e3)}}}),this.setupCustomHardwareAutoSave())}setupCustomHardwareAutoSave(){const e=[this.customChip,this.customTech,this.customRes,this.customShape,this.customPsram,this.customDisplayDriver,this.customTouchTech,"pin_cs","pin_dc","pin_rst","pin_busy","pin_clk","pin_mosi","pin_backlight","pin_sda","pin_scl","pin_touch_int","pin_touch_rst"],i=()=>{if(this.modelInput.value==="custom"){const n=this.getCustomHardwareConfig();h.setCustomHardware(n)}};e.forEach(n=>{const t=typeof n=="string"?document.getElementById(n):n;if(!t)return;const o=t.type==="checkbox"||t.tagName==="SELECT"?"change":"input";t.addEventListener(o,i)})}getCustomHardwareConfig(){const e=(this.customRes.value||"800x480").split("x"),i=n=>{const t=document.getElementById(n);return t?t.value:""};return{chip:this.customChip.value,tech:this.customTech.value,resWidth:parseInt(e[0])||800,resHeight:parseInt(e[1])||480,shape:this.customShape.value,psram:this.customPsram.checked,displayDriver:this.customDisplayDriver.value,touchTech:this.customTouchTech.value,backlightMinPower:parseFloat(i("customBacklightMinPower"))||.07,backlightInitial:parseFloat(i("customBacklightInitial"))||.8,antiburn:!!document.getElementById("customAntiburn")?.checked,pins:{cs:i("pin_cs"),dc:i("pin_dc"),rst:i("pin_rst"),busy:i("pin_busy"),clk:i("pin_clk"),mosi:i("pin_mosi"),backlight:i("pin_backlight"),sda:i("pin_sda"),scl:i("pin_scl"),touch_int:i("pin_touch_int"),touch_rst:i("pin_touch_rst")}}}updateCustomSectionVisibility(){this.customHardwareSection&&(this.customHardwareSection.style.display=this.modelInput.value==="custom"?"block":"none")}async handleSaveCustomProfile(){_.log("[DeviceSettings] handleSaveCustomProfile called");try{const e=this.customProfileNameInput?this.customProfileNameInput.value.trim():"";if(!e){U("Please enter a name for your custom profile first.","warning"),this.customProfileNameInput&&this.customProfileNameInput.focus();return}const i=(this.customRes.value||"800x480").split("x"),n=u=>{const g=document.getElementById(u);return g?g.value:""},t={name:e,chip:this.customChip.value,tech:this.customTech.value,resWidth:parseInt(i[0])||800,resHeight:parseInt(i[1])||480,shape:this.customShape.value,psram:this.customPsram.checked,displayDriver:this.customDisplayDriver.value,touchTech:this.customTouchTech.value,pins:{cs:n("pin_cs"),dc:n("pin_dc"),rst:n("pin_rst"),busy:n("pin_busy"),clk:n("pin_clk"),mosi:n("pin_mosi"),backlight:n("pin_backlight"),sda:n("pin_sda"),scl:n("pin_scl"),touch_int:n("pin_touch_int"),touch_rst:n("pin_touch_rst")}},o=gs(t),s=new Blob([o],{type:"text/yaml"}),r=`${e.toLowerCase().replace(/\s+/g,"_")}.yaml`,l=new File([s],r);U("Generating hardware recipe...","info"),await Dt(l);let c=0;const a=()=>{const g=Object.values(window.DEVICE_PROFILES||G||{}).find(m=>m.name===e||m.name===e+" (Local)"||m.name&&m.name.includes(e));if(g){const m=Object.keys(window.DEVICE_PROFILES||G||{}).find(f=>(window.DEVICE_PROFILES||G)[f]===g);m&&(this.modelInput.value=m,this.modelInput.dispatchEvent(new Event("change")),U(`Profile "${e}" created and loaded!`,"success"))}else c<10?(c++,_.log(`[DeviceSettings] New profile not found yet (attempt ${c}), retrying...`),setTimeout(a,500)):(_.error("[DeviceSettings] Failed to find the newly created profile in the list."),U("Profile created, but could not be auto-selected. Please find it in the list.","warning"))};setTimeout(a,1e3)}catch(e){_.error("Failed to save custom profile:",e),U("Failed to create profile: "+e.message,"error")}}open(){if(_.log("DeviceSettings.open() called"),!this.modal){_.error("DeviceSettings modal element not found!");return}_.log("Opening Device Settings modal..."),this.nameInput&&(this.nameInput.value=h.settings.device_name||"My E-Ink Display"),this.modelInput&&(this.modelInput.value=h.settings.device_model||"reterminal_e1001"),this.orientationInput&&(this.orientationInput.value=h.settings.orientation||"landscape"),this.darkModeInput&&(this.darkModeInput.checked=!!h.settings.darkMode),this.extendedLatinGlyphsInput&&(this.extendedLatinGlyphsInput.checked=!!h.settings.extendedLatinGlyphs),this.invertedColorsInput&&(this.invertedColorsInput.checked=!!h.settings.invertedColors);const e=h.settings,i=!!e.sleepEnabled,n=!!e.manualRefreshOnly,t=!!e.deepSleepEnabled,o=!!e.dailyRefreshEnabled,s=!i&&!n&&!t&&!o;this.modeStandard&&(this.modeStandard.checked=s),this.modeSleep&&(this.modeSleep.checked=i),this.modeManual&&(this.modeManual.checked=n),this.modeDeepSleep&&(this.modeDeepSleep.checked=t),this.modeDaily&&(this.modeDaily.checked=o),this.sleepStart&&(this.sleepStart.value=e.sleepStartHour??0),this.sleepEnd&&(this.sleepEnd.value=e.sleepEndHour??5),this.dailyRefreshTime&&(this.dailyRefreshTime.value=e.dailyRefreshTime||"08:00"),this.deepSleepInterval&&(this.deepSleepInterval.value=e.deepSleepInterval??600),this.refreshIntervalInput&&(this.refreshIntervalInput.value=e.refreshInterval??600),this.noRefreshStart&&(this.noRefreshStart.value=e.noRefreshStartHour??""),this.noRefreshEnd&&(this.noRefreshEnd.value=e.noRefreshEndHour??""),this.autoCycleEnabled&&(this.autoCycleEnabled.checked=!!e.autoCycleEnabled),this.autoCycleInterval&&(this.autoCycleInterval.value=e.autoCycleIntervalS??30),this.updateVisibility(),this.updateStrategyGroupVisibility(),this.populateCustomFields(),this.updateCustomSectionVisibility(),this.modal.classList.remove("hidden"),this.modal.style.display="flex",_.log("Device Settings modal should be visible now.")}close(){this.modal&&(this.modal.classList.add("hidden"),this.modal.style.display="none")}populateCustomFields(){const e=h.project&&h.project.state&&h.project.state.customHardware||{};if(!e||Object.keys(e).length===0)return;this.customChip&&(this.customChip.value=e.chip||"esp32-s3"),this.customTech&&(this.customTech.value=e.tech||"lcd"),this.customRes&&(this.customRes.value=`${e.resWidth||800}x${e.resHeight||480}`),this.customShape&&(this.customShape.value=e.shape||"rect"),this.customPsram&&(this.customPsram.checked=!!e.psram),this.customDisplayDriver&&(this.customDisplayDriver.value=e.displayDriver||"generic_st7789"),this.customTouchTech&&(this.customTouchTech.value=e.touchTech||"none",this.touchPinsGrid&&(this.touchPinsGrid.style.display=e.touchTech&&e.touchTech!=="none"?"grid":"none"));const i=e.pins||{},n=(t,o)=>{const s=document.getElementById(t);s&&(s.value=o||"")};n("pin_cs",i.cs),n("pin_dc",i.dc),n("pin_rst",i.rst),n("pin_busy",i.busy),n("pin_clk",i.clk),n("pin_mosi",i.mosi),n("pin_backlight",i.backlight),n("pin_sda",i.sda),n("pin_scl",i.scl),n("pin_touch_int",i.touch_int),n("pin_touch_rst",i.touch_rst)}populateDeviceSelect(){if(this.modelInput&&G){const e=this.modelInput.value;_.log("[DeviceSettings] Populating dropdown with",Object.keys(G).length,"profiles"),this.modelInput.innerHTML="";const i=Re||[];Object.entries(G).forEach(([t,o])=>{_.log(`  - Adding: ${t} (${o.name})`);const s=document.createElement("option");s.value=t;let r=o.name;i.includes(t)||(r+=" (untested)"),s.textContent=r,this.modelInput.appendChild(s)});const n=document.createElement("option");n.value="custom",n.textContent="Custom Profile...",n.style.fontWeight="bold",n.style.color="var(--accent)",this.modelInput.appendChild(n),e&&(G[e]||e==="custom")?this.modelInput.value=e:this.modelInput.value||(this.modelInput.value="reterminal_e1001"),this.updateCustomSectionVisibility()}}updateVisibility(){const e=this.modeSleep&&this.modeSleep.checked,i=this.modeDaily&&this.modeDaily.checked,n=this.modeDeepSleep&&this.modeDeepSleep.checked,t=this.modeManual&&this.modeManual.checked;this.sleepRow&&(this.sleepRow.style.display=e?"flex":"none"),this.dailyRefreshRow&&(this.dailyRefreshRow.style.display=i?"flex":"none"),this.deepSleepRow&&(this.deepSleepRow.style.display=n?"block":"none");const o=!i&&!t;this.refreshIntervalRow&&(this.refreshIntervalRow.style.display=o?"block":"none"),this.autoCycleRow&&(this.autoCycleRow.style.display=this.autoCycleEnabled&&this.autoCycleEnabled.checked?"flex":"none")}persistToBackend(){this.saveDebounceTimer&&clearTimeout(this.saveDebounceTimer),this.saveDebounceTimer=setTimeout(async()=>{if(q()&&typeof saveLayoutToBackend=="function")try{await saveLayoutToBackend(),_.log("[DeviceSettings] All settings persisted to backend")}catch(e){_.warn("[DeviceSettings] Failed to auto-save settings:",e)}else try{const e=h.getPagesPayload();e.deviceName=h.deviceName,e.deviceModel=h.deviceModel,localStorage.setItem("esphome-designer-layout",JSON.stringify(e)),_.log("[DeviceSettings] Settings persisted to localStorage (offline mode)")}catch(e){_.warn("[DeviceSettings] Failed to save to localStorage:",e)}},1e3)}setupAutoSaveListeners(){const e=(o,s)=>{h.updateSettings({[o]:s}),_.log(`Auto-saved ${o}:`,s),this.persistToBackend()};let i=null;this.nameInput&&this.nameInput.addEventListener("input",()=>{const o=this.nameInput.value.trim();h.setDeviceName(o),W(B.STATE_CHANGED),i&&clearTimeout(i),i=setTimeout(async()=>{if(typeof saveLayoutToBackend=="function")try{await saveLayoutToBackend(),_.log("[DeviceSettings] Device name saved to backend")}catch(s){_.warn("[DeviceSettings] Failed to save device name:",s)}},500)}),this.modelInput&&this.modelInput.addEventListener("change",async()=>{const o=this.modelInput.value;window.currentDeviceModel=o,h.setDeviceModel(o),e("device_model",o),this.updateStrategyGroupVisibility(),_.log("Device model changed to:",o)}),this.orientationInput&&this.orientationInput.addEventListener("change",()=>{e("orientation",this.orientationInput.value)}),this.darkModeInput&&this.darkModeInput.addEventListener("change",()=>{e("darkMode",this.darkModeInput.checked)}),this.extendedLatinGlyphsInput&&this.extendedLatinGlyphsInput.addEventListener("change",()=>{e("extendedLatinGlyphs",this.extendedLatinGlyphsInput.checked)}),this.invertedColorsInput&&this.invertedColorsInput.addEventListener("change",()=>{e("invertedColors",this.invertedColorsInput.checked)}),this.renderingModeInput&&this.renderingModeInput.addEventListener("change",()=>{e("renderingMode",this.renderingModeInput.value),_.log("Rendering mode changed to:",this.renderingModeInput.value)}),[this.modeStandard,this.modeSleep,this.modeManual,this.modeDeepSleep,this.modeDaily].forEach(o=>{o&&o.addEventListener("change",()=>{o.checked&&(e("sleepEnabled",!!(this.modeSleep&&this.modeSleep.checked)),e("manualRefreshOnly",!!(this.modeManual&&this.modeManual.checked)),e("deepSleepEnabled",!!(this.modeDeepSleep&&this.modeDeepSleep.checked)),e("dailyRefreshEnabled",!!(this.modeDaily&&this.modeDaily.checked)),this.updateVisibility())})}),this.sleepStart&&this.sleepStart.addEventListener("change",()=>{e("sleepStartHour",parseInt(this.sleepStart.value)||0)}),this.sleepEnd&&this.sleepEnd.addEventListener("change",()=>{e("sleepEndHour",parseInt(this.sleepEnd.value)||0)}),this.dailyRefreshTime&&this.dailyRefreshTime.addEventListener("change",()=>{e("dailyRefreshTime",this.dailyRefreshTime.value)}),this.deepSleepInterval&&this.deepSleepInterval.addEventListener("input",()=>{const o=parseInt(this.deepSleepInterval.value)||600;e("deepSleepInterval",o),this.refreshIntervalInput&&(this.refreshIntervalInput.value=o,h.updateSettings({refreshInterval:o}))}),this.refreshIntervalInput&&this.refreshIntervalInput.addEventListener("input",()=>{const o=parseInt(this.refreshIntervalInput.value)||600;e("refreshInterval",o),this.deepSleepInterval&&this.modeDeepSleep&&this.modeDeepSleep.checked&&(this.deepSleepInterval.value=o,h.updateSettings({deepSleepInterval:o}))}),this.noRefreshStart&&this.noRefreshStart.addEventListener("change",()=>{const o=this.noRefreshStart.value===""?null:parseInt(this.noRefreshStart.value);e("noRefreshStartHour",o)}),this.noRefreshEnd&&this.noRefreshEnd.addEventListener("change",()=>{const o=this.noRefreshEnd.value===""?null:parseInt(this.noRefreshEnd.value);e("noRefreshEndHour",o)}),this.autoCycleEnabled&&this.autoCycleEnabled.addEventListener("change",()=>{e("autoCycleEnabled",this.autoCycleEnabled.checked),this.updateVisibility()}),this.autoCycleInterval&&this.autoCycleInterval.addEventListener("input",()=>{const o=Math.max(5,parseInt(this.autoCycleInterval.value)||30);e("autoCycleIntervalS",o)}),document.querySelectorAll('input[name="lcdEcoStrategy"]').forEach(o=>{o.addEventListener("change",()=>{o.checked&&(e("lcdEcoStrategy",o.value),this.sleepRow&&(this.sleepRow.style.display=o.value==="backlight_off"?"flex":"none"))})})}updateStrategyGroupVisibility(){const e=this.modelInput?this.modelInput.value:"reterminal_e1001";let i=!1;if(e==="custom")i=(h.project&&h.project.state&&h.project.state.customHardware||{}).tech==="lcd";else{const t=(window.DEVICE_PROFILES||G||{})[e];i=!!(t&&t.features&&(t.features.lcd||t.features.oled)),t&&t.features&&(t.features.lvgl||t.features.lv_display)}if(this.strategyEpaperGroup&&(this.strategyEpaperGroup.style.display=i?"none":"flex"),this.strategyLcdGroup&&(this.strategyLcdGroup.style.display=i?"flex":"none",i)){const n=h.settings.lcdEcoStrategy||"backlight_off",t=document.querySelector(`input[name="lcdEcoStrategy"][value="${n}"]`);t&&(t.checked=!0)}this.renderingModeField&&(this.renderingModeField.style.display=i?"block":"none",i&&this.renderingModeInput&&(this.renderingModeInput.value=h.settings.renderingMode||"lvgl"))}openSaveProfileModal(){return new Promise(e=>{if(!this.saveProfileModal){_.error("Save Profile Modal not found in DOM"),e(null);return}this.saveProfileResolve=e,this.saveProfileNameInput.value="My Custom Device",this.saveProfileModal.classList.remove("hidden"),this.saveProfileModal.style.display="flex",this.saveProfileNameInput.focus(),this.saveProfileNameInput.select();const i=()=>{this.saveProfileModal.classList.add("hidden"),this.saveProfileModal.style.display="none",this.saveProfileResolve&&(this.saveProfileResolve(null),this.saveProfileResolve=null),o()},n=()=>{const s=this.saveProfileNameInput.value.trim();if(!s){U("Please enter a profile name","warning"),this.saveProfileNameInput.focus();return}this.saveProfileModal.classList.add("hidden"),this.saveProfileModal.style.display="none",this.saveProfileResolve&&(this.saveProfileResolve(s),this.saveProfileResolve=null),o()},t=s=>{s.key==="Enter"&&n(),s.key==="Escape"&&i()},o=()=>{this.saveProfileCloseBtn.removeEventListener("click",i),this.saveProfileConfirmBtn.removeEventListener("click",n),this.saveProfileNameInput.removeEventListener("keyup",t)};this.saveProfileCloseBtn.addEventListener("click",i),this.saveProfileConfirmBtn.addEventListener("click",n),this.saveProfileNameInput.addEventListener("keyup",t)})}}class ys{constructor(){this.modal=document.getElementById("editorSettingsModal"),this.closeBtn=document.getElementById("editorSettingsClose"),this.doneBtn=document.getElementById("editorSettingsDone"),this.snapToGrid=document.getElementById("editorSnapToGrid"),this.showGrid=document.getElementById("editorShowGrid"),this.lightMode=document.getElementById("editorLightMode"),this.refreshEntitiesBtn=document.getElementById("editorRefreshEntities"),this.entityCountLabel=document.getElementById("editorEntityCount"),this.gridOpacity=document.getElementById("editorGridOpacity"),this.haManualUrl=document.getElementById("haManualUrl"),this.haLlatToken=document.getElementById("haLlatToken"),this.testHaBtn=document.getElementById("editorTestHaBtn"),this.haTestResult=document.getElementById("haTestResult"),this.aiProvider=document.getElementById("aiProvider"),this.aiApiKeyGemini=document.getElementById("aiApiKeyGemini"),this.aiApiKeyOpenai=document.getElementById("aiApiKeyOpenai"),this.aiApiKeyOpenrouter=document.getElementById("aiApiKeyOpenrouter"),this.aiModelFilter=document.getElementById("aiModelFilter"),this.aiModelSelect=document.getElementById("aiModelSelect"),this.aiRefreshModelsBtn=document.getElementById("aiRefreshModelsBtn"),this.aiTestResult=document.getElementById("aiTestResult"),this.aiKeyRows={gemini:document.getElementById("aiKeyGeminiRow"),openai:document.getElementById("aiKeyOpenaiRow"),openrouter:document.getElementById("aiKeyOpenrouterRow")}}init(){this.modal&&(this.closeBtn&&this.closeBtn.addEventListener("click",()=>this.close()),this.doneBtn&&this.doneBtn.addEventListener("click",()=>this.close()),this.setupListeners())}open(){if(!this.modal)return;const e=h.settings;this.snapToGrid&&(this.snapToGrid.checked=h.snapEnabled!==!1),this.showGrid&&(this.showGrid.checked=h.showGrid!==!1),this.lightMode&&(this.lightMode.checked=!!e.editor_light_mode),this.aiProvider&&(this.aiProvider.value=e.ai_provider||"gemini"),this.aiApiKeyGemini&&(this.aiApiKeyGemini.value=e.ai_api_key_gemini||""),this.aiApiKeyOpenai&&(this.aiApiKeyOpenai.value=e.ai_api_key_openai||""),this.aiApiKeyOpenrouter&&(this.aiApiKeyOpenrouter.value=e.ai_api_key_openrouter||""),this.aiModelFilter&&(this.aiModelFilter.value=e.ai_model_filter||""),this.updateAIKeyVisibility(),this.refreshModelSelect(),this.gridOpacity&&(this.gridOpacity.value=e.grid_opacity!==void 0?e.grid_opacity:20),this.haManualUrl&&(this.haManualUrl.value=vt()||""),this.haLlatToken&&(this.haLlatToken.value=Ke()||""),this.haTestResult&&(this.haTestResult.textContent=""),this.aiTestResult&&(this.aiTestResult.textContent="");const i=document.getElementById("haOriginPlaceholder");i&&(i.textContent=window.location.origin),this.updateEntityCount(),this.modal.classList.remove("hidden"),this.modal.style.display="flex"}close(){this.modal&&(this.modal.classList.add("hidden"),this.modal.style.display="none")}updateEntityCount(){if(this.entityCountLabel&&window.entityStatesCache){const e=Object.keys(window.entityStatesCache).length;this.entityCountLabel.textContent=`${e} entities cached`}}setupListeners(){this.snapToGrid&&this.snapToGrid.addEventListener("change",()=>{h.setSnapEnabled(this.snapToGrid.checked)}),this.showGrid&&this.showGrid.addEventListener("change",()=>{h.setShowGrid(this.showGrid.checked);const i=document.querySelector(".canvas-grid");i&&(i.style.display=this.showGrid.checked?"block":"none")}),this.lightMode&&this.lightMode.addEventListener("change",()=>{const i=this.lightMode.checked;h.updateSettings({editor_light_mode:i}),this.applyEditorTheme(i),W(B.STATE_CHANGED)}),this.gridOpacity&&this.gridOpacity.addEventListener("input",()=>{const i=parseInt(this.gridOpacity.value,10);h.updateSettings({grid_opacity:i})}),this.refreshEntitiesBtn&&this.refreshEntitiesBtn.addEventListener("click",async()=>{this.refreshEntitiesBtn.disabled=!0,this.refreshEntitiesBtn.textContent="Refreshing...",ge?await ge():window.fetchEntityStates&&await window.fetchEntityStates(),this.updateEntityCount(),this.refreshEntitiesBtn.disabled=!1,this.refreshEntitiesBtn.textContent="â» Refresh Entity List"}),this.haManualUrl&&this.haManualUrl.addEventListener("change",()=>{Ut(this.haManualUrl.value.trim()),lt()}),this.haLlatToken&&this.haLlatToken.addEventListener("change",()=>{Vt(this.haLlatToken.value.trim())}),this.testHaBtn&&this.testHaBtn.addEventListener("click",async()=>{this.testHaBtn.disabled=!0,this.haTestResult.textContent="Testing...",this.haTestResult.style.color="var(--muted)";try{lt();const i=await ge();i&&i.length>0?(this.haTestResult.textContent="â Success!",this.haTestResult.style.color="var(--success)",this.updateEntityCount()):(this.haTestResult.innerHTML="â Failed.<br>Did you add <strong>cors_allowed_origins</strong> to HA and <strong>restart</strong> it?",this.haTestResult.style.color="var(--danger)")}catch{this.haTestResult.innerHTML="â Connection Error.<br>Check browser console.",this.haTestResult.style.color="var(--danger)"}finally{this.testHaBtn.disabled=!1}}),this.aiProvider&&this.aiProvider.addEventListener("change",()=>{h.updateSettings({ai_provider:this.aiProvider.value}),this.updateAIKeyVisibility(),this.refreshModelSelect()});const e=(i,n)=>{const t=document.getElementById(i);t&&t.addEventListener("input",()=>h.updateSettings({[n]:t.value.trim()}))};e("aiApiKeyGemini","ai_api_key_gemini"),e("aiApiKeyOpenai","ai_api_key_openai"),e("aiApiKeyOpenrouter","ai_api_key_openrouter"),this.aiModelFilter&&this.aiModelFilter.addEventListener("input",()=>{h.updateSettings({ai_model_filter:this.aiModelFilter.value}),this.filterModels()}),this.aiModelSelect&&this.aiModelSelect.addEventListener("change",()=>{const i=h.settings.ai_provider;h.updateSettings({[`ai_model_${i}`]:this.aiModelSelect.value})}),this.aiRefreshModelsBtn&&this.aiRefreshModelsBtn.addEventListener("click",async()=>{const i=h.settings.ai_provider||"gemini";let n=h.settings[`ai_api_key_${i}`];const t=`aiApiKey${i.charAt(0).toUpperCase()+i.slice(1)}`,o=document.getElementById(t);if(o&&(n=o.value.trim(),h.updateSettings({[`ai_api_key_${i}`]:n})),!n){U("Please enter an API key first",3e3,"error");return}this.aiRefreshModelsBtn.disabled=!0,this.aiRefreshModelsBtn.textContent="...",this.aiTestResult&&(this.aiTestResult.textContent="Testing...",this.aiTestResult.style.color="var(--muted)");try{const s=await window.aiService.fetchModels(i,n);window.aiService.cache.models[i]=s,this.refreshModelSelect(),this.aiTestResult&&(this.aiTestResult.textContent=`â Success! Found ${s.length} models.`,this.aiTestResult.style.color="var(--success)")}catch{this.aiTestResult&&(this.aiTestResult.textContent="â Failed. Check key/console.",this.aiTestResult.style.color="var(--danger)")}finally{this.aiRefreshModelsBtn.disabled=!1,this.aiRefreshModelsBtn.textContent="Test & Load Models"}})}updateAIKeyVisibility(){const e=h.settings.ai_provider||"gemini";Object.keys(this.aiKeyRows).forEach(i=>{this.aiKeyRows[i]&&(this.aiKeyRows[i].style.display=i===e?"block":"none")})}async refreshModelSelect(){if(!this.aiModelSelect)return;const e=h.settings.ai_provider||"gemini";if(!window.aiService||!window.aiService.cache)return;let i=window.aiService.cache.models[e];i||(i=[],window.aiService.cache.models[e]=i),this.filterModels()}filterModels(){if(!this.aiModelSelect)return;const e=h.settings.ai_provider||"gemini",i=(h.settings.ai_model_filter||"").toLowerCase();if(!window.aiService||!window.aiService.cache)return;const t=(window.aiService.cache.models[e]||[]).filter(s=>s.name.toLowerCase().includes(i)||s.id.toLowerCase().includes(i));this.aiModelSelect.innerHTML="",t.forEach(s=>{const r=document.createElement("option");r.value=s.id,r.textContent=s.name,this.aiModelSelect.appendChild(r)});const o=h.settings[`ai_model_${e}`];o&&(this.aiModelSelect.value=o)}applyEditorTheme(e){e?document.documentElement.setAttribute("data-theme","light"):document.documentElement.removeAttribute("data-theme");try{localStorage.setItem("reterminal-editor-theme",e?"light":"dark")}catch(i){_.log("Could not save theme preference:",i)}}}class _s{constructor(){this.modal=document.getElementById("aiPromptModal"),this.closeBtn=document.getElementById("aiPromptClose"),this.submitBtn=document.getElementById("aiPromptSubmit"),this.applyBtn=document.getElementById("aiPromptApply"),this.input=document.getElementById("aiPromptInput"),this.status=document.getElementById("aiPromptStatus"),this.diffPanel=document.getElementById("aiPreviewDiff"),this.diffContent=document.getElementById("aiDiffContent"),this.generatedWidgets=null}init(){this.modal&&(this.closeBtn.onclick=()=>this.close(),this.submitBtn.onclick=()=>this.handleSubmit(),this.applyBtn.onclick=()=>this.handleApply(),window.addEventListener("click",e=>{e.target===this.modal&&this.close()}))}open(){if(!this.modal)return;this.modal.classList.remove("hidden"),this.modal.style.display="flex",this.input.focus();const e=window.AppState.settings.ai_provider||"gemini",i=window.AppState.settings[`ai_api_key_${e}`],n=document.getElementById("aiConfigWarning");n&&(n.style.display=i?"none":"block"),this.status.textContent="",this.status.style.color="",this.diffPanel.style.display="none",this.applyBtn.style.display="none",this.generatedWidgets=null}close(){this.modal&&(this.modal.classList.add("hidden"),this.modal.style.display="none")}async handleSubmit(){const e=this.input.value.trim();if(e){this.setLoading(!0),this.status.textContent="AI is thinking...",this.status.style.color="var(--accent)",this.diffPanel.style.display="none",this.applyBtn.style.display="none";try{const i=window.AppState.getCurrentPage(),n=h.deviceModel,t=G?.[n];let o="monochrome";t&&(t.features?.lcd?o="color_lcd":t.name?.includes("6-Color")||t.name?.includes("Color")?o="color_epaper":o="monochrome");const s={canvas:window.AppState.getCanvasDimensions(),current_page:i.id,widgets:i.widgets,selected_widget_id:window.AppState.selectedWidgetId,display_type:o},r=await window.aiService.processPrompt(e,s);if(r&&Array.isArray(r))this.generatedWidgets=r,this.showDiffPreview(i.widgets,r),this.status.textContent="Successfully generated changes!",this.status.style.color="var(--success)",this.applyBtn.style.display="inline-block";else throw new Error("Invalid response format from AI")}catch(i){_.error(i),this.status.textContent="Error: "+i.message,this.status.style.color="var(--danger)"}finally{this.setLoading(!1)}}}handleApply(){if(this.generatedWidgets)try{const e=window.AppState.getCurrentPage();e.widgets=this.generatedWidgets,window.AppState.project.rebuildWidgetsIndex(),W(B.STATE_CHANGED),U("AI changes applied!","success"),this.close()}catch(e){_.error(e),U("Failed to apply changes: "+e.message,"error")}}showDiffPreview(e,i){this.diffPanel.style.display="block";let n=`Widgets: ${e.length} â ${i.length}

`;const t=e.map(c=>c.id),o=i.map(c=>c.id),s=i.filter(c=>!t.includes(c.id)),r=e.filter(c=>!o.includes(c.id)),l=i.filter(c=>{const a=e.find(u=>u.id===c.id);return a&&JSON.stringify(a)!==JSON.stringify(c)});s.length>0&&(n+=`[ADDED]
${s.map(c=>`+ ${c.type} (${c.id})`).join(`
`)}

`),r.length>0&&(n+=`[REMOVED]
${r.map(c=>`- ${c.type} (${c.id})`).join(`
`)}

`),l.length>0&&(n+=`[MODIFIED]
${l.map(c=>`~ ${c.type} (${c.id})`).join(`
`)}`),s.length===0&&r.length===0&&l.length===0&&(n+="(No changes detected)"),this.diffContent.textContent=n}setLoading(e){this.submitBtn.disabled=e,this.submitBtn.textContent=e?"Processing...":"Generate",this.input.disabled=e}}window.llmPrompt=new _s;class bs{constructor(){this.modal=document.getElementById("pageSettingsModal"),this.closeBtn=document.getElementById("pageSettingsClose"),this.saveBtn=document.getElementById("pageSettingsSave"),this.nameInput=document.getElementById("pageSettingsName"),this.refreshInput=document.getElementById("pageSettingsRefresh"),this.refreshModeInput=document.getElementById("pageSettingsRefreshMode"),this.refreshTimeInput=document.getElementById("pageSettingsRefreshTime"),this.fieldInterval=document.getElementById("field-refresh-interval"),this.fieldTime=document.getElementById("field-refresh-time"),this.darkModeInput=document.getElementById("pageSettingsDarkMode"),this.layoutModeInput=document.getElementById("pageSettingsLayoutMode"),this.gridSizeInput=document.getElementById("pageSettingsGridSize"),this.fieldGridSize=document.getElementById("field-grid-size"),this.pageIndex=-1}init(){this.modal&&(this.closeBtn&&this.closeBtn.addEventListener("click",()=>this.close()),this.saveBtn&&this.saveBtn.addEventListener("click",()=>this.save()),this.refreshModeInput&&this.refreshModeInput.addEventListener("change",()=>this.updateVisibility()),this.layoutModeInput&&this.layoutModeInput.addEventListener("change",()=>this.updateGridVisibility()))}updateVisibility(){if(!this.refreshModeInput)return;const e=this.refreshModeInput.value;this.fieldInterval&&(this.fieldInterval.style.display=e==="interval"?"block":"none"),this.fieldTime&&(this.fieldTime.style.display=e==="daily"?"block":"none")}updateGridVisibility(){if(!this.layoutModeInput||!this.fieldGridSize)return;const e=this.layoutModeInput.value;this.fieldGridSize.style.display=e==="grid"?"block":"none"}open(e){if(!this.modal)return;this.pageIndex=e;const i=h.pages[e];if(!i)return;this.nameInput&&(this.nameInput.value=i.name||"");const n=i.refresh_type||"interval";this.refreshModeInput&&(this.refreshModeInput.value=n),this.refreshInput&&(this.refreshInput.value=i.refresh_s||""),this.refreshTimeInput&&(this.refreshTimeInput.value=i.refresh_time||"08:00"),this.darkModeInput&&(this.darkModeInput.value=i.dark_mode||"inherit"),this.layoutModeInput&&(this.layoutModeInput.value=i.layout?"grid":"absolute"),this.gridSizeInput&&(this.gridSizeInput.value=i.layout||"4x4"),this.updateVisibility(),this.updateGridVisibility(),this.modal.classList.remove("hidden"),this.modal.style.display="flex"}close(){this.modal&&(this.modal.classList.add("hidden"),this.modal.style.display="none")}save(){if(this.pageIndex===-1)return;const e=h.pages[this.pageIndex];if(!e)return;const i=this.nameInput?this.nameInput.value:e.name,n=this.refreshModeInput?this.refreshModeInput.value:"interval",t=this.refreshInput?parseInt(this.refreshInput.value,10):NaN,o=this.refreshTimeInput?this.refreshTimeInput.value:"08:00",s=this.darkModeInput?this.darkModeInput.value:"inherit",r=this.layoutModeInput?this.layoutModeInput.value:"absolute",l=this.gridSizeInput?this.gridSizeInput.value.trim():"";e.name=i,e.refresh_type=n,n==="interval"?(!isNaN(t)&&t>=0?e.refresh_s=t:delete e.refresh_s,delete e.refresh_time):(e.refresh_time=o,delete e.refresh_s),e.dark_mode=s,r==="grid"&&/^\d+x\d+$/.test(l)?e.layout=l:e.layout=null,h.setPages(h.pages),q()&&typeof Se=="function"&&Se().then(()=>_.log("[PageSettings] Pages persisted to backend")).catch(c=>_.warn("[PageSettings] Failed to save pages to backend:",c)),this.close()}}class vs{constructor(){this.modal=null,this.currentLayoutId="reterminal_e1001",this.layouts=[]}init(){this.createModal(),this.bindButton(),_.log("[LayoutManager] Initialized")}bindButton(){const e=document.getElementById("manageLayoutsBtn");e&&e.addEventListener("click",()=>this.open())}createModal(){if(document.getElementById("layoutManagerModal")){this.modal=document.getElementById("layoutManagerModal");return}const e=document.createElement("div");e.id="layoutManagerModal",e.className="modal-backdrop hidden",e.innerHTML=`
            <div class="modal" style="max-width: 600px;">
                <div class="modal-header">
                    <div>ð Manage Layouts</div>
                    <button id="layoutManagerClose" class="btn btn-secondary">Ã</button>
                </div>
                <div class="modal-body">
                    <div class="layout-manager-current" style="margin-bottom: 12px; padding: 8px; background: var(--bg-subtle); border-radius: 4px;">
                        <span class="prop-label" style="font-size: 11px; color: var(--muted);">Current Layout:</span>
                        <span id="layoutManagerCurrentName" style="font-weight: 500; margin-left: 8px;">Loading...</span>
                    </div>
                    
                    <div class="layout-manager-list-container" style="max-height: 300px; overflow-y: auto; margin-bottom: 12px;">
                        <table class="layout-manager-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 1px solid var(--border);">
                                    <th style="text-align: left; padding: 8px 4px; font-size: 11px;">Name</th>
                                    <th style="text-align: left; padding: 8px 4px; font-size: 11px;">Device</th>
                                    <th style="text-align: left; padding: 8px 4px; font-size: 11px;">Pages</th>
                                    <th style="text-align: right; padding: 8px 4px; font-size: 11px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="layoutManagerTableBody">
                                <tr><td colspan="4" style="text-align: center; color: var(--muted); padding: 16px;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="layout-manager-actions" style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button id="layoutManagerNew" class="btn btn-primary" style="flex: 1;">+ New Layout</button>
                        <button id="layoutManagerImport" class="btn btn-secondary" style="flex: 1;">ð¥ Import from File</button>
                        <input type="file" id="layoutManagerFileInput" accept=".json" style="display: none;">
                    </div>
                    
                    <div id="layoutManagerStatus" class="layout-manager-status" style="margin-top: 8px; font-size: 11px; min-height: 20px;"></div>
                </div>
            </div>
        `,document.body.appendChild(e),this.modal=e,document.getElementById("layoutManagerClose").addEventListener("click",()=>this.close()),document.getElementById("layoutManagerNew").addEventListener("click",()=>this.showNewLayoutDialog()),document.getElementById("layoutManagerImport").addEventListener("click",()=>{document.getElementById("layoutManagerFileInput").click()}),document.getElementById("layoutManagerFileInput").addEventListener("change",i=>this.handleFileImport(i)),e.addEventListener("click",i=>{i.target===e&&this.close()})}async open(){this.modal||this.createModal(),this.modal.classList.remove("hidden"),await this.loadLayouts()}close(){this.modal&&this.modal.classList.add("hidden")}setStatus(e,i="info"){const n=document.getElementById("layoutManagerStatus");if(n){const t={success:"var(--success, #22c55e)",error:"var(--danger, #ef4444)",info:"var(--muted, #888)"};n.textContent=e,n.style.color=t[i]||t.info,e&&setTimeout(()=>{n.textContent=""},5e3)}}async loadLayouts(){if(typeof q!="function"||!q()){this.setStatus("Not connected to Home Assistant","error");return}try{const e=await fetch(`${J}/layouts`);if(!e.ok)throw new Error(`Failed to load layouts: ${e.status}`);const i=await e.json();this.layouts=i.layouts||[],i.last_active_layout_id&&this.layouts.some(n=>n.id===i.last_active_layout_id)&&(!window.AppState?.currentLayoutId||window.AppState.currentLayoutId==="reterminal_e1001")&&this.layouts.find(t=>t.id===i.last_active_layout_id)&&i.last_active_layout_id!==window.AppState?.currentLayoutId&&(_.log(`[LayoutManager] Syncing to last active layout: ${i.last_active_layout_id}`),this.currentLayoutId=i.last_active_layout_id,window.AppState&&typeof window.AppState.setCurrentLayoutId=="function"&&window.AppState.setCurrentLayoutId(i.last_active_layout_id)),this.renderLayoutList()}catch(e){_.error("[LayoutManager] Error loading layouts:",e),this.setStatus("Failed to load layouts","error")}}renderLayoutList(){const e=document.getElementById("layoutManagerTableBody"),i=document.getElementById("layoutManagerCurrentName");if(!e)return;window.AppState&&window.AppState.currentLayoutId&&(this.currentLayoutId=window.AppState.currentLayoutId);const n=this.layouts.find(t=>t.id===this.currentLayoutId);if(i&&(i.textContent=n?n.name:this.currentLayoutId),this.layouts.length===0){e.innerHTML='<tr><td colspan="4" style="text-align: center; color: var(--muted); padding: 16px;">No layouts found</td></tr>';return}e.innerHTML=this.layouts.map(t=>{const o=t.id===this.currentLayoutId,s=this.layouts.filter(r=>r.name===t.name).length>1;return`
                <tr style="border-bottom: 1px solid var(--border-subtle); ${o?"background: var(--accent-soft);":""}">
                    <td style="padding: 8px 4px;">
                        <span style="font-weight: 500;">${this.escapeHtml(t.name)}</span>
                        ${o?'<span style="background: var(--accent); color: white; font-size: 9px; padding: 2px 4px; border-radius: 2px; margin-left: 4px;">current</span>':""}
                        ${s?'<br><span style="font-size: 9px; color: var(--muted);">'+this.escapeHtml(t.id)+"</span>":""}
                    </td>
                    <td style="padding: 8px 4px; font-size: 11px; color: var(--muted);">${this.getDeviceDisplayName(t.device_model||t.device_type)}</td>
                    <td style="padding: 8px 4px; font-size: 11px; color: var(--muted);">${t.page_count} pages</td>
                    <td style="padding: 8px 4px; text-align: right;">
                        <div style="display: flex; gap: 4px; justify-content: flex-end;">
                            ${o?"":`<button class="btn btn-sm btn-primary" style="font-size: 10px; padding: 4px 8px;" onclick="window.layoutManager.loadLayout('${t.id}')">Load</button>`}
                            <button class="btn btn-sm btn-secondary" style="font-size: 10px; padding: 4px 8px;" onclick="window.layoutManager.exportLayout('${t.id}')">ð¤</button>
                            ${!o&&this.layouts.length>1?`<button class="btn btn-sm btn-secondary" style="font-size: 10px; padding: 4px 8px; color: var(--danger);" onclick="window.layoutManager.deleteLayout('${t.id}', '${this.escapeHtml(t.name)}')">ð</button>`:""}
                        </div>
                    </td>
                </tr>
            `}).join("")}escapeHtml(e){const i=document.createElement("div");return i.textContent=e||"",i.innerHTML}getDeviceDisplayName(e){if(G&&G[e]){let t=G[e].name;return(Re||[]).includes(e)||(t+=" (untested)"),t}return{reterminal_e1001:"E1001 (Mono)",reterminal_e1002:"E1002 (Color)",trmnl:"TRMNL",esp32_s3_photopainter:"PhotoPainter (7-Color)"}[e]||e||"Unknown"}async loadLayout(e){if(!(typeof q!="function"||!q()))try{this.setStatus("Loading layout...","info");const i=await fetch(`${J}/layouts/${e}`);if(!i.ok)throw new Error(`Failed to load layout: ${i.status}`);const n=await i.json();n.device_id||(n.device_id=e),this.currentLayoutId=e,window.AppState&&typeof window.AppState.setCurrentLayoutId=="function"&&(window.AppState.setCurrentLayoutId(e),_.log(`[LayoutManager] Set currentLayoutId to: ${e}`));const t=document.getElementById("canvas");if(t){const o=t.querySelector(".canvas-grid");t.innerHTML="",o&&t.appendChild(o),_.log("[LayoutManager] Cleared canvas before loading layout")}document.querySelectorAll(".graph-axis-label").forEach(o=>o.remove()),typeof le=="function"&&le(n),window.AppState&&window.AppState.currentLayoutId!==e&&(window.AppState.setCurrentLayoutId(e),_.log(`[LayoutManager] Re-set currentLayoutId to: ${e} (was changed by loadLayoutIntoState)`)),typeof W=="function"&&typeof B<"u"&&W(B.LAYOUT_IMPORTED,n),this.setStatus(`Loaded: ${n.name||e}`,"success"),this.renderLayoutList(),setTimeout(()=>this.close(),500)}catch(i){_.error("[LayoutManager] Error loading layout:",i),this.setStatus("Failed to load layout","error")}}async exportLayout(e){if(!(typeof q!="function"||!q()))try{const i=`${J}/export?id=${e}`,n=document.createElement("a");n.href=i,n.download=`${e}_layout.json`,document.body.appendChild(n),n.click(),document.body.removeChild(n),this.setStatus("Export started...","success")}catch(i){_.error("[LayoutManager] Error exporting layout:",i),this.setStatus("Failed to export layout","error")}}async deleteLayout(e,i){if(!(typeof q!="function"||!q()||!confirm(`Are you sure you want to delete "${i}"?

This cannot be undone.`))){this.setStatus("Deleting layout...","info");try{const t=await fetch(`${J}/layouts/${e}`,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify({action:"delete"})});if(!t.ok){const o=await t.json().catch(()=>({}));if(o.error==="cannot_delete_last_layout"){this.setStatus("Cannot delete the last layout","error");return}throw new Error(o.error||`Delete failed: ${t.status}`)}this.setStatus(`Deleted: ${i}`,"success"),await this.loadLayouts()}catch(t){_.warn("[LayoutManager] Network error during delete, verifying if operation completed..."),await new Promise(s=>setTimeout(s,1500)),await this.loadLayouts(),this.layouts.some(s=>s.id===e)?(_.error("[LayoutManager] Error deleting layout:",t),this.setStatus("Failed to delete layout","error")):(_.log("[LayoutManager] Layout was successfully deleted (verified after refresh)"),this.setStatus(`Deleted: ${i}`,"success"))}}}showNewLayoutDialog(){if(!document.getElementById("newLayoutModal")){const o=document.createElement("div");o.id="newLayoutModal",o.className="modal-backdrop hidden",o.innerHTML=`
                <div class="modal" style="max-width: 400px;">
                    <div class="modal-header">
                        <div>Create New Layout</div>
                        <button id="newLayoutClose" class="btn btn-secondary">Ã</button>
                    </div>
                    <div class="modal-body">
                        <div class="field" style="margin-bottom: 12px;">
                            <div class="prop-label">Layout Name</div>
                            <input id="newLayoutName" class="prop-input" type="text" placeholder="e.g. Living Room Display" />
                        </div>
                        <div class="field">
                            <div class="prop-label">Device Type</div>
                            <select id="newLayoutDeviceType" class="prop-input">
                                ${this.generateDeviceOptions()}
                            </select>
                            <p class="hint" style="color: var(--muted); font-size: 11px; margin-top: 4px;">Select the device that will display this layout.</p>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button id="newLayoutCancel" class="btn btn-secondary">Cancel</button>
                        <button id="newLayoutConfirm" class="btn btn-primary">Create Layout</button>
                    </div>
                </div>
            `,document.body.appendChild(o),document.getElementById("newLayoutClose").addEventListener("click",()=>{o.classList.add("hidden")}),document.getElementById("newLayoutCancel").addEventListener("click",()=>{o.classList.add("hidden")}),document.getElementById("newLayoutConfirm").addEventListener("click",()=>{this.handleCreateLayoutConfirm()}),document.getElementById("newLayoutName").addEventListener("keydown",s=>{s.key==="Enter"?(s.preventDefault(),this.handleCreateLayoutConfirm()):s.key==="Escape"&&o.classList.add("hidden"),s.stopPropagation()}),o.addEventListener("click",s=>{if(s.target===o){const r=document.getElementById("newLayoutName");document.activeElement!==r&&o.classList.add("hidden")}})}const e=document.getElementById("newLayoutName"),n=`Layout ${this.layouts.length+1}`;e.value=n,h.deviceModel||h.settings&&h.settings.device_model;const t=G?Object.keys(G)[0]:"reterminal_e1001";document.getElementById("newLayoutDeviceType").value=t,document.getElementById("newLayoutModal").classList.remove("hidden"),setTimeout(()=>e.focus(),100)}handleCreateLayoutConfirm(){const e=document.getElementById("newLayoutName").value.trim(),i=document.getElementById("newLayoutDeviceType").value;if(!e){alert("Please enter a layout name.");return}document.getElementById("newLayoutModal").classList.add("hidden"),this.createLayout(e,i)}generateDeviceOptions(){if(G){const e=Re||[];return Object.entries(G).map(([i,n])=>{let t=n.name;return e.includes(i)||(t+=" (untested)"),`<option value="${i}">${t}</option>`}).join("")}return'<option value="reterminal_e1001">reTerminal E1001</option>'}async createLayout(e,i="reterminal_e1001"){if(typeof q!="function"||!q())return;let n=e.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_]/g,"");n||(n="layout");const t=n+"_"+Date.now();this.setStatus("Creating layout...","info");let o=!1;try{const s=await fetch(`${J}/layouts`,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify({id:t,name:e,device_type:i,device_model:i})});if(!s.ok){const r=await s.json().catch(()=>({}));throw new Error(r.error||`Create failed: ${s.status}`)}o=!0}catch(s){if(_.warn("[LayoutManager] Network error during create, verifying if operation completed..."),await new Promise(l=>setTimeout(l,1500)),await this.loadLayouts(),this.layouts.some(l=>l.id===t))_.log("[LayoutManager] Layout was successfully created (verified after refresh)"),o=!0;else{_.error("[LayoutManager] Error creating layout:",s),this.setStatus("Failed to create layout","error");return}}if(o){this.setStatus(`Created: ${e}`,"success"),await this.loadLayouts();const s=G[i],r=s&&s.features&&s.features.epaper,l=s&&s.features&&s.features.lvgl,c=r&&!l?"direct":"lvgl";_.log(`[LayoutManager] New layout ${t} detected device type. isEpaper=${r}, hasLvgl=${l}. Setting initial renderingMode to: ${c}`),window.AppState&&(window.AppState.setPages([{id:"page_0",name:"Page 1",widgets:[]}]),window.AppState.setCurrentPageIndex(0),window.AppState.updateSettings({renderingMode:c,device_model:i}),_.log("[LayoutManager] Cleared state and set initial settings before loading new layout")),await this.loadLayout(t),window.AppState&&(window.AppState.setDeviceModel(i),window.AppState.settings&&(window.AppState.settings.device_model=i),window.currentDeviceModel=i,typeof W=="function"&&typeof B<"u"&&W(B.STATE_CHANGED),_.log(`[LayoutManager] Created layout '${t}' with device_model: ${i}, pages: ${window.AppState.pages?.length}, widgets: ${window.AppState.getCurrentPage()?.widgets?.length||0}`))}}async handleFileImport(e){const i=e.target.files[0];if(i){try{const n=await i.text(),t=JSON.parse(n);if(!t.pages&&!t.device_id){this.setStatus("Invalid layout file","error");return}await this.importLayout(t)}catch(n){_.error("[LayoutManager] Error importing file:",n),this.setStatus("Failed to import file: "+n.message,"error")}e.target.value=""}}async importLayout(e,i=!1){if(!(typeof q!="function"||!q()))try{const n=`${J}/import${i?"?overwrite=true":""}`,t=await fetch(n,{method:"POST",headers:oe(),body:JSON.stringify(e)}),o=await t.json();if(!t.ok){if(o.error==="layout_exists"){if(confirm(`A layout with ID "${o.existing_id}" already exists.

Do you want to overwrite it?`)){await this.importLayout(e,!0);return}return}throw new Error(o.error||`Import failed: ${t.status}`)}this.setStatus(`Imported: ${o.name||o.id}`,"success"),await this.loadLayouts()}catch(n){_.error("[LayoutManager] Error importing layout:",n),this.setStatus("Failed to import layout","error")}}}window.layoutManager=new vs;function _t(){const d=document.getElementById("resizer-left"),e=document.getElementById("resizer-right"),i=document.querySelector(".sidebar"),n=document.querySelector(".right-panel");if(document.querySelector(".app-content"),!d||!e||!i||!n){_.warn("[Splitters] Layout elements not found, retrying..."),setTimeout(_t,500);return}_.log("[Splitters] Initializing draggable panels...");function t(r,l,c){let a,u;r.addEventListener("mousedown",function(g){c==="vertical"?(a=g.clientX,u=l.offsetWidth,document.body.style.cursor="col-resize"):(a=g.clientY,u=l.offsetHeight,document.body.style.cursor="row-resize"),r.classList.add("dragging"),document.body.style.userSelect="none";function m(y){let b;if(c==="vertical"){b=y.clientX-a,r.id==="resizer-right"&&(b=-b);const w=u+b,S=parseInt(getComputedStyle(l).minWidth)||100,T=parseInt(getComputedStyle(l).maxWidth)||800;w>=S&&w<=T&&(l.style.width=w+"px")}else{b=a-y.clientY;const w=u+b,S=parseInt(getComputedStyle(l).minHeight)||50,T=parseInt(getComputedStyle(l).maxHeight)||800;w>=S&&w<=T&&(l.style.height=w+"px")}window.dispatchEvent&&window.dispatchEvent(new Event("resize"))}function f(){r.classList.remove("dragging"),document.body.style.cursor="default",document.body.style.userSelect="",window.removeEventListener("mousemove",m),window.removeEventListener("mouseup",f)}window.addEventListener("mousemove",m),window.addEventListener("mouseup",f)})}const o=document.getElementById("resizer-bottom"),s=document.querySelector(".code-panel");t(d,i,"vertical"),t(e,n,"vertical"),o&&s&&t(o,s,"horizontal")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",_t):_t();function Gt(){_.log("[ModalWiring] Initializing modal buttons...");const d=document.getElementById("deviceSettingsBtn"),e=document.getElementById("deviceSettingsModal"),i=document.getElementById("deviceSettingsClose"),n=document.getElementById("deviceSettingsSave"),t=document.getElementById("deviceName"),o=document.getElementById("deviceModel"),s=document.getElementById("deviceOrientation"),r=document.getElementById("deviceDarkMode"),l=document.getElementById("mode-standard"),c=document.getElementById("setting-sleep-enabled"),a=document.getElementById("setting-manual-refresh"),u=document.getElementById("setting-deep-sleep-enabled"),g=document.getElementById("sleep-times-row"),m=document.getElementById("deep-sleep-interval-row"),f=document.getElementById("setting-sleep-start"),y=document.getElementById("setting-sleep-end"),b=document.getElementById("setting-deep-sleep-interval");function w(){_.log("[ModalWiring] Opening device settings");const A=window.AppState?h.settings:{},Y=window.AppState?h.settings.device_name:"reTerminal E1001";t&&(t.value=Y||"reTerminal E1001"),o&&(o.value=window.currentDeviceModel||"reterminal_e1001"),s&&(s.value=A.orientation||"landscape"),r&&(r.checked=!!A.dark_mode);const Z=!!A.sleep_enabled,j=!!A.manual_refresh_only,p=!!A.deep_sleep_enabled,P=!Z&&!j&&!p;l&&(l.checked=P),c&&(c.checked=Z),a&&(a.checked=j),u&&(u.checked=p),f&&(f.value=A.sleep_start_hour??0),y&&(y.value=A.sleep_end_hour??5),b&&(b.value=A.deep_sleep_interval??600),g&&(g.style.display=Z?"flex":"none"),m&&(m.style.display=p?"flex":"none"),e.classList.remove("hidden"),e.style.display="flex"}function S(){e.style.display="none",e.classList.add("hidden")}d&&d.addEventListener("click",w),i&&i.addEventListener("click",S),n&&n.addEventListener("click",S),c&&c.addEventListener("change",()=>{g&&(g.style.display=c.checked?"flex":"none")}),u&&u.addEventListener("change",()=>{m&&(m.style.display=u.checked?"flex":"none")});const T=document.getElementById("editorSettingsBtn"),R=document.getElementById("editorSettingsModal"),v=document.getElementById("editorSettingsClose"),M=document.getElementById("editorSettingsDone");function E(){_.log("[ModalWiring] Opening editor settings"),R.classList.remove("hidden"),R.style.display="flex"}function L(){R.classList.add("hidden"),R.style.display="none"}T&&T.addEventListener("click",E),v&&v.addEventListener("click",L),M&&M.addEventListener("click",L);const k=document.getElementById("pageSettingsClose"),H=document.getElementById("pageSettingsSave"),z=document.getElementById("pageSettingsModal");function F(){z&&(z.classList.add("hidden"),z.style.display="none"),window.currentPageSettingsTarget=null}k&&k.addEventListener("click",F),H&&H.addEventListener("click",F),_.log("[ModalWiring] Modal buttons initialized")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Gt):Gt();class ws{constructor(){this.isOpen=!1,this.selectedIndex=0,this.filteredWidgets=[],this.allWidgets=[],this.modal=null,this.input=null,this.resultsContainer=null,this.init()}init(){this.createModal(),this.bindEvents()}discoverWidgets(){this.allWidgets=[];const e=document.querySelectorAll(".widget-category .item[data-widget-type]");if(e.length===0){_.warn("[QuickSearch] No widgets found in palette");return}e.forEach(i=>{const n=i.getAttribute("data-widget-type"),t=i.querySelector(".label"),o=t?t.textContent.trim():n,s=i.closest(".widget-category"),r=s?s.querySelector(".category-name"):null,l=r?r.textContent.trim():"Widgets";this.allWidgets.push({type:n,label:o,category:l,searchText:`${o} ${n} ${l}`.toLowerCase()})}),_.log(`[QuickSearch] Discovered ${this.allWidgets.length} widgets`)}createModal(){this.modal=document.createElement("div"),this.modal.id="quick-search-modal",this.modal.className="quick-search-modal hidden",this.modal.innerHTML=`
            <div class="quick-search-backdrop"></div>
            <div class="quick-search-container">
                <div class="quick-search-header">
                    <span class="quick-search-icon">ð</span>
                    <input type="text" class="quick-search-input" placeholder="Search widgets..." autocomplete="off" />
                </div>
                <div class="quick-search-results"></div>
                <div class="quick-search-hint">
                    <span>ââ Navigate</span>
                    <span>âµ Add Widget</span>
                    <span>Esc Close</span>
                </div>
            </div>
        `,document.body.appendChild(this.modal),this.input=this.modal.querySelector(".quick-search-input"),this.resultsContainer=this.modal.querySelector(".quick-search-results")}bindEvents(){this.modal.querySelector(".quick-search-backdrop").addEventListener("click",()=>this.close()),this.input.addEventListener("input",()=>this.handleSearch()),this.input.addEventListener("keydown",e=>this.handleKeyDown(e))}open(){this.discoverWidgets(),this.isOpen=!0,this.modal.classList.remove("hidden"),this.input.value="",this.selectedIndex=0,this.handleSearch(),setTimeout(()=>this.input.focus(),50)}close(){this.isOpen=!1,this.modal.classList.add("hidden"),this.input.blur()}handleSearch(){const e=this.input.value.toLowerCase().trim();e===""?this.filteredWidgets=[...this.allWidgets]:this.filteredWidgets=this.allWidgets.filter(i=>i.searchText.includes(e)),this.selectedIndex=0,this.renderResults()}renderResults(){if(this.filteredWidgets.length===0){this.resultsContainer.innerHTML=`
                <div class="quick-search-empty">No widgets found</div>
            `;return}this.resultsContainer.innerHTML=this.filteredWidgets.map((i,n)=>`
            <div class="quick-search-item ${n===this.selectedIndex?"selected":""}" 
                 data-index="${n}" data-type="${i.type}">
                <span class="quick-search-item-label">${i.label}</span>
                <span class="quick-search-item-category">${i.category}</span>
            </div>
        `).join(""),this.resultsContainer.querySelectorAll(".quick-search-item").forEach(i=>{i.addEventListener("click",()=>{const n=parseInt(i.getAttribute("data-index"),10);this.selectedIndex=n,this.addSelectedWidget()})});const e=this.resultsContainer.querySelector(".quick-search-item.selected");e&&e.scrollIntoView({block:"nearest"})}handleKeyDown(e){switch(e.key){case"ArrowDown":e.preventDefault(),this.selectedIndex=Math.min(this.selectedIndex+1,this.filteredWidgets.length-1),this.renderResults();break;case"ArrowUp":e.preventDefault(),this.selectedIndex=Math.max(this.selectedIndex-1,0),this.renderResults();break;case"Enter":e.preventDefault(),this.addSelectedWidget();break;case"Escape":e.preventDefault(),this.close();break}}addSelectedWidget(){if(this.filteredWidgets.length===0)return;const e=this.filteredWidgets[this.selectedIndex];if(e)try{const i=WidgetFactory.createWidget(e.type);AppState.addWidget(i),_.log(`[QuickSearch] Added widget: ${e.label}`),this.close()}catch(i){_.error("[QuickSearch] Error adding widget:",i),AppState.notify("Failed to add widget: "+i.message,"error")}}}class xs{constructor(){this.active=!1,this.element=null,this.targetWidgetId=null,this.position={x:0,y:0},this.init()}init(){this.element||(this.element=document.createElement("div"),this.element.className="radial-menu",this.element.innerHTML=`
                <div class="radial-menu-center"></div>
                <div class="radial-menu-items"></div>
            `,document.body.appendChild(this.element),window.addEventListener("mousedown",e=>{this.active&&!this.element.contains(e.target)&&this.hide()},!0),window.addEventListener("keydown",e=>{e.key==="Escape"&&this.active&&this.hide()}))}show(e,i,n=null){this.targetWidgetId=n,this.position={x:e,y:i},this.active=!0,this.element.style.left=`${e}px`,this.element.style.top=`${i}px`,this.renderItems(),requestAnimationFrame(()=>{this.element.classList.add("active")})}hide(){this.active=!1,this.element.classList.remove("active"),this.targetWidgetId=null}renderItems(){const e=this.element.querySelector(".radial-menu-items");e.innerHTML="";const i=this.getAvailableActions(),n=2*Math.PI/i.length,t=70;i.forEach((o,s)=>{const r=s*n-Math.PI/2,l=Math.cos(r)*t,c=Math.sin(r)*t,a=document.createElement("div");a.className=`radial-menu-item ${o.className||""}`,a.style.setProperty("--x",`${l}px`),a.style.setProperty("--y",`${c}px`),a.title=o.label,a.innerHTML=`<i class="mdi ${o.icon}"></i>`,a.addEventListener("click",u=>{u.stopPropagation(),o.callback(),this.hide()}),e.appendChild(a)})}getAvailableActions(){const e=h,i=this.targetWidgetId?e.getWidgetById(this.targetWidgetId):null,n=[];if(i){n.push({label:"Copy",icon:"mdi-content-copy",callback:()=>{e.selectWidget(this.targetWidgetId,!1),e.copyWidget()}});const t=e.selectedWidgetIds,o=t.some(l=>{const c=e.getWidgetById(l);return c&&(c.type==="group"||c.parentId)});t.length>1&&!o&&n.push({label:"Group",icon:"mdi-group",callback:()=>e.groupSelection()}),(i.type==="group"||i.parentId)&&n.push({label:"Ungroup",icon:"mdi-ungroup",callback:()=>e.ungroupSelection(this.targetWidgetId)}),n.push({label:"Duplicate",icon:"mdi-content-duplicate",callback:()=>{e.copyWidget(),e.pasteWidget()}}),n.push({label:i.locked?"Unlock":"Lock",icon:i.locked?"mdi-lock-open-outline":"mdi-lock-outline",callback:()=>{e.updateWidget(this.targetWidgetId,{locked:!i.locked})}}),n.push({label:"Snap",icon:"mdi-magnet",callback:()=>{Ui(this.targetWidgetId)}}),n.push({label:"Delete",icon:"mdi-delete-outline",className:"danger",callback:()=>{e.deleteWidget(this.targetWidgetId)}});const s=e.getCurrentPage(),r=s?.widgets.findIndex(l=>l.id===this.targetWidgetId);r!==-1&&(n.push({label:"Bring to Front",icon:"mdi-arrange-bring-to-front",callback:()=>{e.reorderWidget(e.currentPageIndex,r,s.widgets.length-1)}}),n.push({label:"Send to Back",icon:"mdi-arrange-send-to-back",callback:()=>{e.reorderWidget(e.currentPageIndex,r,0)}}))}else n.push({label:"Paste",icon:"mdi-content-paste",callback:()=>{e.pasteWidget()}});return n}}window.RadialMenu=new xs;class Es{constructor(){this.patterns=[{name:"comment",regex:/(#.*)/g},{name:"key",regex:/^(\s*)([^:\n]+)(:)/gm},{name:"string",regex:/("[^"]*"|'[^']*')/g},{name:"value",regex:/\b(true|false|null|[0-9]+(\.[0-9]+)?)\b/g},{name:"keyword",regex:/\b(lambda|script|on_.*|if|then|else|wait_until|delay)\b/g},{name:"tag",regex:/(![a-z_]+)/g}]}highlight(e){if(!e)return"";let i=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");const n=/^(\s*(?:-\s+)?)([^:\n]+)(:)|(#.*)|("[^"]*"|'[^']*')|(![a-z_]+)|\b(lambda|script|on_[a-z_]+|if|then|else|wait_until|delay)\b|\b(true|false|null|[0-9]+(?:\.[0-9]+)?)\b|(\|[-+]?|>[-+]?)/gm;return i.replace(n,(t,o,s,r,l,c,a,u,g,m)=>o!==void 0?`${o}<span class="hl-key">${s}</span><span class="hl-punc">${r}</span>`:l!==void 0?`<span class="hl-comment">${l}</span>`:c!==void 0?`<span class="hl-string">${c}</span>`:a!==void 0?`<span class="hl-tag">${a}</span>`:m!==void 0?`<span class="hl-punc">${m}</span>`:u!==void 0?`<span class="hl-keyword">${u}</span>`:g!==void 0?`<span class="hl-value">${g}</span>`:t)}}class Ss{constructor(e){this.adapter=e,this.highlighter=new Es,this.suppressSnippetUpdate=!1,this.snippetDebounceTimer=null,this.lastGeneratedYaml="",this.isHighlighted=localStorage.getItem("esphome_designer_yaml_highlight")!=="false",this.init()}init(){this.bindEvents(),this.setupAutoUpdate(),this.setupScrollSync(),this.updateSnippetBox()}bindEvents(){const e=document.getElementById("fullscreenSnippetBtn");e&&e.addEventListener("click",()=>{this.openSnippetModal()});const i=document.getElementById("snippetFullscreenClose");i&&i.addEventListener("click",()=>{const a=document.getElementById("snippetFullscreenModal");a&&a.classList.add("hidden")});const n=document.getElementById("importSnippetConfirm");n&&n.addEventListener("click",async()=>{await this.handleImportSnippet()});const t=document.getElementById("updateLayoutBtn");t&&t.addEventListener("click",async()=>{await this.handleUpdateLayoutFromSnippetBox()});const o=document.getElementById("copySnippetBtn");o&&o.addEventListener("click",async()=>{this.copySnippetToClipboard(o)});const s=document.getElementById("toggleYamlBtn"),r=document.querySelector(".code-panel");s&&r&&(localStorage.getItem("esphome_designer_yaml_collapsed")==="true"&&r.classList.add("collapsed"),s.addEventListener("click",()=>{const u=r.classList.toggle("collapsed");localStorage.setItem("esphome_designer_yaml_collapsed",u),window.dispatchEvent(new Event("resize"))}));const l=document.getElementById("toggleHighlightBtn");document.querySelector(".snippet-container"),l&&(document.querySelectorAll(".snippet-container").forEach(a=>{a.classList.toggle("highlighted",this.isHighlighted)}),document.querySelectorAll('[id*="ToggleHighlightBtn"]').forEach(a=>{a.classList.toggle("active",this.isHighlighted)}),l.addEventListener("click",()=>{this.isHighlighted=!this.isHighlighted,localStorage.setItem("esphome_designer_yaml_highlight",this.isHighlighted),document.querySelectorAll(".snippet-container").forEach(a=>{a.classList.toggle("highlighted",this.isHighlighted)}),document.querySelectorAll('[id*="ToggleHighlightBtn"]').forEach(a=>{a.classList.toggle("active",this.isHighlighted)}),this.isHighlighted&&this.updateHighlightLayer()}));const c=document.getElementById("snippetBox");c&&c.addEventListener("input",()=>{this.isHighlighted&&this.updateHighlightLayer()})}setupScrollSync(){const e=document.getElementById("snippetBox"),i=document.getElementById("highlightLayer");e&&i&&e.addEventListener("scroll",()=>{i.scrollTop=e.scrollTop,i.scrollLeft=e.scrollLeft})}setupAutoUpdate(){Q(B.STATE_CHANGED,()=>{this.suppressSnippetUpdate||this.updateSnippetBox()}),Q(B.SELECTION_CHANGED,e=>{const i=e&&e.widgetIds?e.widgetIds:[];typeof Me=="function"&&Me(i)})}updateHighlightLayer(){if(!this.isHighlighted)return;const e=document.getElementById("snippetBox"),i=document.getElementById("highlightLayer");e&&i&&(i.innerHTML=this.highlighter.highlight(e.value));const n=document.getElementById("snippetFullscreenHighlight"),t=document.getElementById("snippetFullscreenContent");if(n&&t){const o=t.querySelector("textarea");o&&(n.innerHTML=this.highlighter.highlight(o.value))}}updateSnippetBox(){const e=document.getElementById("snippetBox");e&&(this.snippetDebounceTimer&&clearTimeout(this.snippetDebounceTimer),this.snippetDebounceTimer=setTimeout(()=>{if(!this.suppressSnippetUpdate)try{const i=window.AppState?window.AppState.getPagesPayload():{pages:[]};this.adapter.generate(i).then(n=>{this.lastGeneratedYaml=n,e.value=n,this.isHighlighted&&this.updateHighlightLayer();const t=window.AppState?window.AppState.selectedWidgetIds:[];typeof Me=="function"&&Me(t)}).catch(n=>{_.error("Error generating snippet via adapter:",n),e.value="# Error generating YAML (adapter): "+n.message,this.isHighlighted&&this.updateHighlightLayer()})}catch(i){_.error("Error generating snippet:",i),e.value="# Error generating YAML: "+i.message,this.isHighlighted&&this.updateHighlightLayer()}},50))}openSnippetModal(){const e=document.getElementById("snippetFullscreenModal"),i=document.getElementById("snippetFullscreenContainer"),n=document.getElementById("snippetFullscreenContent"),t=document.getElementById("snippetFullscreenHighlight"),o=document.getElementById("snippetBox"),s=document.getElementById("toggleFullscreenHighlightBtn");if(!e||!i||!n||!t||!o)return;i.classList.toggle("highlighted",this.isHighlighted),s&&s.classList.toggle("active",this.isHighlighted),s&&!s.hasListener&&(s.addEventListener("click",()=>{this.isHighlighted=!this.isHighlighted,localStorage.setItem("esphome_designer_yaml_highlight",this.isHighlighted);const l=document.querySelector(".snippet-container"),c=document.getElementById("toggleHighlightBtn");l&&l.classList.toggle("highlighted",this.isHighlighted),c&&c.classList.toggle("active",this.isHighlighted),i.classList.toggle("highlighted",this.isHighlighted),s.classList.toggle("active",this.isHighlighted),this.isHighlighted&&(t.innerHTML=this.highlighter.highlight(r.value),this.updateHighlightLayer())}),s.hasListener=!0);let r=n.querySelector("textarea");if(!r){n.innerHTML="",r=document.createElement("textarea"),r.className="snippet-box",r.style.width="100%",r.style.height="100%",r.style.background="transparent",r.spellcheck=!1,n.appendChild(r),r.addEventListener("scroll",()=>{t.scrollTop=r.scrollTop,t.scrollLeft=r.scrollLeft}),r.addEventListener("input",()=>{this.isHighlighted&&(t.innerHTML=this.highlighter.highlight(r.value))});let l=e.querySelector(".modal-actions");if(l&&!l.querySelector("#fullscreenUpdateBtn")){const c=document.createElement("button");c.id="fullscreenUpdateBtn",c.className="btn btn-primary",c.textContent="Update Layout from YAML",c.onclick=()=>{o.value=r.value,this.handleUpdateLayoutFromSnippetBox(),e.classList.add("hidden")},l.insertBefore(c,l.firstChild)}}r.value=o.value||"",this.isHighlighted&&(t.innerHTML=this.highlighter.highlight(r.value),setTimeout(()=>{t.scrollTop=r.scrollTop,t.scrollLeft=r.scrollLeft},50)),e.style.display="",e.classList.remove("hidden")}async handleImportSnippet(){const e=document.getElementById("importSnippetTextarea"),i=document.getElementById("importSnippetError");if(!e)return;const n=e.value;if(n.trim())try{i&&(i.textContent="");let t;try{t=Bt(n),_.log("[handleImportSnippet] Successfully used offline parser.")}catch(s){if(_.warn("[handleImportSnippet] Offline parser failed, falling back to backend:",s),q())t=await ki(n);else throw s}le(t);const o=document.getElementById("importSnippetModal");o&&(o.classList.add("hidden"),o.style.display="none"),U("Layout imported successfully","success")}catch(t){_.error("Import failed:",t),i&&(i.textContent=`Error: ${t.message}`)}}async handleUpdateLayoutFromSnippetBox(){const e=document.getElementById("snippetBox");if(!e)return;const i=e.value;if(i.trim()){if(this.lastGeneratedYaml&&i.trim()===this.lastGeneratedYaml.trim()){_.log("[handleUpdateLayoutFromSnippetBox] Skipping update: Snippet matches last generated state.");return}try{const n=window.AppState?.currentLayoutId||"reterminal_e1001",t=window.AppState?.deviceName||"Layout 1",o=window.AppState?.deviceModel||window.AppState?.settings?.device_model||"reterminal_e1001";_.log(`[handleUpdateLayoutFromSnippetBox] Preserving context - ID: ${n}, Name: ${t}`);let s=Bt(i);s.device_id=n,s.name=t,s.device_model=o,s.settings||(s.settings={}),s.settings.device_model=o,s.settings.device_name=t;const r=window.AppState?.settings?.dark_mode||!1;s.settings.dark_mode=r,this.suppressSnippetUpdate=!0,this.snippetDebounceTimer&&(clearTimeout(this.snippetDebounceTimer),this.snippetDebounceTimer=null),le(s),setTimeout(()=>{this.suppressSnippetUpdate=!1},1500),U("Layout updated from YAML","success"),(i.includes("lambda:")||i.includes("script:"))&&setTimeout(()=>{U("Note: Custom C++ (lambda/script) may not fully preview.","warning",4e3)},800)}catch(n){_.error("Update layout failed:",n),U(`Update failed: ${n.message}`,"error"),this.suppressSnippetUpdate=!1}}}async copySnippetToClipboard(e){const i=document.getElementById("snippetBox");if(!i)return;const n=i.value||"",t=e.textContent,o=()=>{e.textContent="Copied!",e.style.minWidth=e.offsetWidth+"px",setTimeout(()=>{e.textContent=t,e.style.minWidth=""},2e3)};try{if(navigator.clipboard&&window.isSecureContext)await navigator.clipboard.writeText(n),U("Snippet copied to clipboard","success"),o();else{const s=document.createElement("textarea");s.value=n,s.style.position="fixed",s.style.left="-999999px",s.style.top="-999999px",document.body.appendChild(s),s.focus(),s.select();try{document.execCommand("copy"),U("Snippet copied to clipboard","success"),o()}catch{U("Unable to copy. Try selecting and copying manually.","error")}document.body.removeChild(s)}}catch(s){_.error("Copy failed:",s),U("Unable to copy snippet","error")}}}class hi extends ke{constructor(){super(),this.fonts=new ci,this.yaml=new pi,this.reset()}reset(){this.fonts&&this.fonts.reset(),this.usedPlugins=new Set}async generate(e){if(!e)return console.error("ESPHomeAdapter: Missing layout"),"";this.reset();const i=e.pages||[],n=e.deviceModel||(h?h.deviceModel:null)||window.currentDeviceModel||"reterminal_e1001",t=G||{},o=window.DEVICE_PROFILES||{};let r={...t,...o}[n]||{};if(n==="custom"&&e.customHardware){const v=e.customHardware;r={id:"custom",name:"Custom Device",chip:v.chip||"esp32-s3",displayPlatform:v.displayDriver||"generic_st7789",resolution:{width:v.resWidth||800,height:v.resHeight||480},shape:v.shape||"rect",pins:{i2c:v.pins?.sda?{sda:v.pins.sda,scl:v.pins.scl}:null,spi:v.pins?.clk?{clk:v.pins.clk,mosi:v.pins.mosi}:null,display:{cs:v.pins?.cs,dc:v.pins?.dc,reset:v.pins?.rst,busy:v.pins?.busy}},features:{psram:!!v.psram,lcd:v.tech==="lcd",epaper:v.tech==="epaper",touch:v.touchTech&&v.touchTech!=="none"},backlight:v.pins?.backlight?{platform:"gpio",pin:v.pins.backlight}:null,touch:v.touchTech&&v.touchTech!=="none"?{platform:v.touchTech,sda:v.pins?.sda,scl:v.pins?.scl,interrupt_pin:v.pins?.touch_int,reset_pin:v.pins?.touch_rst}:null}}let l=!!(r.features&&(r.features.lvgl||r.features.lv_display));const c=e.renderingMode||(h?h.settings?.renderingMode:null);if(c==="direct"?(l=!1,_.log("[ESPHomeAdapter] Rendering mode set to 'direct', skipping LVGL generation")):c==="lvgl"&&(l=!0,_.log("[ESPHomeAdapter] Rendering mode set to 'lvgl', forcing LVGL generation")),!l)for(const v of i){if(v.widgets){for(const M of v.widgets.filter(E=>!E.hidden))if(M.type.startsWith("lvgl_")){l=!0;break}}if(l)break}const a=[];r.isPackageBased||(a.push(...this.yaml.generateInstructionHeader(r,e)),a.push(...this.yaml.generateSystemSections(r,e)),a.push(""));const u=r.features?.lcd?"my_display":"epaper_display";this.preProcessWidgetsPromise=this.preProcessWidgets(i),await this.preProcessWidgetsPromise;let g=null;r.isPackageBased&&(r.isOfflineImport&&r.content?g=r.content:r.hardwarePackage&&(g=await this.fetchHardwarePackage(r.hardwarePackage)));const m=[];i.forEach((v,M)=>{v.widgets&&v.widgets.forEach(E=>{E.hidden||(E._pageIndex=M,m.push(E))})});const f=new Set,y=new Set,b=new Map,w={widgets:m,profile:r,displayId:u,adapter:this,isLvgl:l,seenEntityIds:f,seenSensorIds:y,pendingTriggers:b};if(V){const v=[];v.push("- id: display_page","  type: int","  restore_value: true","  initial_value: '0'");const M=!!(r.features&&r.features.epaper),E=!!(r.features&&r.features.lcd)||!M,L=e.refreshInterval||(E?60:e.deepSleepInterval||600);v.push("- id: page_refresh_default_s","  type: int","  restore_value: true",`  initial_value: '${L}'`),v.push("- id: page_refresh_current_s","  type: int","  restore_value: false","  initial_value: '60'"),v.push("- id: last_page_switch_time","  type: uint32_t","  restore_value: false","  initial_value: '0'"),V.onExportGlobals({...w,lines:v}),v.length>0&&(a.push("globals:"),a.push(...v.map(C=>"  "+C))),!(g&&g.includes("psram:"))&&r.features?.psram&&Ue&&a.push(...Ue(r)),r.isPackageBased?a.some(x=>String(x).split(`
`).some(O=>O.trim()==="time:"))||(a.push("time:","  - platform: homeassistant","    id: ha_time"),y.add("ha_time")):(a.push("http_request:","  verify_ssl: false","  timeout: 20s","  buffer_size_rx: 4096"),Ne&&a.push(...Ne(r)),He&&a.push(...He(r)),$e&&a.push(...$e(r)),Ve&&a.push(...Ve(r)),Ye&&a.push(...Ye(r)),We&&a.push(...We(r)),qe&&a.push(...qe(r)),Xe&&a.push(...Xe(r)),a.some(x=>String(x).split(`
`).some(O=>O.trim()==="time:"))||(a.push("time:","  - platform: homeassistant","    id: ha_time"),y.add("ha_time"))),r.features&&(r.pins?.batteryAdc&&(y.add("battery_voltage"),y.add("battery_level")),r.features.sht4x&&(y.add("sht4x_sensor"),y.add("sht4x_temperature"),y.add("sht4x_humidity")),(r.features.sht3x||r.features.sht3xd)&&(y.add("sht3x_sensor"),y.add("sht3x_temperature"),y.add("sht3x_humidity")),r.features.shtc3&&(y.add("shtc3_sensor"),y.add("shtc3_temperature"),y.add("shtc3_humidity"))),ze&&a.push(...ze(r,[],u,m));const H=[];V.onExportNumericSensors({...w,lines:H,mainLines:a});const z=this.processPendingTriggers(H,b,l,"on_value");z.length>0&&(a.some(C=>C==="sensor:")||a.push("sensor:"),a.push(...z.flatMap(C=>C.split(`
`).map(x=>"  "+x))));const F=i.flatMap(C=>C.widgets||[]),A=[];if(F.forEach(C=>{let x=(C.entity_id||"").trim();const O=C.props||{};if(!x||O.is_local_sensor)return;["progress_bar","sensor_text","graph","battery_icon","wifi_signal","ondevice_temperature","ondevice_humidity"].includes(C.type)&&!x.includes(".")&&(x=`sensor.${x}`);const se=x.includes(".")&&!x.startsWith("weather.")&&!x.startsWith("text_sensor.")&&!x.startsWith("binary_sensor."),et=["switch.","light.","fan.","input_boolean.","cover.","lock."].some(ne=>x.startsWith(ne));if(se&&!et&&!f.has(x)){const ne=x.replace(/[^a-zA-Z0-9_]/g,"_");y.has(ne)||(f.add(x),y.add(ne),A.push("- platform: homeassistant"),A.push(`  id: ${ne}`),A.push(`  entity_id: ${x}`),A.push("  internal: true"))}}),A.length>0){a.some(x=>x==="sensor:")||a.push("sensor:");const C=this.processPendingTriggers(A,b,l,"on_value");a.push(...C.flatMap(x=>x.split(`
`).map(O=>"  "+O)))}const Y=[];V.onExportTextSensors({...w,lines:Y});const Z=this.processPendingTriggers(Y,b,l,"on_value");Z.length>0&&(a.push("text_sensor:"),a.push(...Z.flatMap(C=>C.split(`
`).map(x=>"  "+x))));const j=[];if(!r.isPackageBased&&Ge){const C=Ge(r,i.length,u,[]);C.length>0&&C[0].trim()==="binary_sensor:"?j.push(...C.slice(1).map(x=>x.startsWith("  ")?x.slice(2):x)):j.push(...C)}V.onExportBinarySensors({...w,lines:j});const p=this.processPendingTriggers(j,b,l,"on_state");p.length>0&&(a.push("binary_sensor:"),a.push(...p.flatMap(C=>C.split(`
`).map(x=>"  "+x))));const P=i.flatMap(C=>C.widgets||[]),X=["binary_sensor.","switch.","light.","input_boolean.","fan.","cover.","vacuum.","lock."],D=[];if(P.forEach(C=>{const x=(C.condition_entity||"").trim(),O=(C.entity_id||"").trim();[x,O].forEach($=>{if(!$)return;if(X.some(te=>$.startsWith(te))&&!f.has($)){const te=$.replace(/[^a-zA-Z0-9_]/g,"_");y.has(te)||(f.add($),y.add(te),D.push("- platform: homeassistant"),D.push(`  id: ${te}`),D.push(`  entity_id: ${$}`),D.push("  internal: true"))}})}),D.length>0){a.some(x=>x==="binary_sensor:")||a.push("binary_sensor:");const C=this.processPendingTriggers(D,b,l,"on_state");a.push(...C.flatMap(x=>x.split(`
`).map(O=>"  "+O)))}if(!r.isPackageBased&&je){const C=je(r,i.length,u);C.length>0&&a.push(...C)}const I=V.getAll(),ee=["image","online_image","graph","qr_code"];I.sort((C,x)=>{const O=ee.indexOf(C.id),$=ee.indexOf(x.id);return O!==-1&&$!==-1?O-$:O!==-1?-1:$!==-1?1:C.id.localeCompare(x.id)}),I.forEach(C=>C.onExportComponents&&C.onExportComponents({...w,lines:a}))}const S=this.generateDisplayLambda(i,e,r);a.push(...this.fonts.getLines());const T=this.yaml.generateScriptSection(e,i,r);if(T.length>0&&a.push(...T),l&&we){const v=we(i,n,r);v&&v.length>0&&a.push(...v)}const R=l&&we;if(r.isPackageBased){if(g){const v=/^(\s*)# __LAMBDA_PLACEHOLDER__/m,M=g.match(v);if(M){const E=M[1],L="# __LAMBDA_PLACEHOLDER__",k=new RegExp(`lambda:\\s*\\|-\\s*[\\r\\n]+\\s*${L.replace("#","\\#")}`).test(g);if(R)g=g.replace(v,"");else{const H=(k?"":E+`lambda: |-
`)+S.map(z=>E+"  "+z).join(`
`);g=g.replace(v,H)}}return g=this.applyPackageOverrides(g,r,e.orientation),this.sanitizePackageContent(g)+`

`+a.join(`
`)}}else{const v=Fe?Fe(r,e.orientation):[];a.push(...v);for(let M=0;M<a.length;M++)if(a[M].trim()==="display:"){let E=M+1;for(;E<a.length&&(a[E].startsWith("  ")||a[E].trim()==="");)E++;R||a.splice(E,0,"    lambda: |-",...S.map(L=>"      "+L));break}}return a.join(`
`)}async preProcessWidgets(e){for(const i of e)if(i.widgets)for(const n of i.widgets.filter(t=>!t.hidden&&t.type!=="group")){const t=n.type,o=V?await V.load(t):null;o&&(this.usedPlugins.add(o),typeof o.collectRequirements=="function"&&o.collectRequirements(n,{trackIcon:(s,r)=>this.fonts.trackIcon(s,r),addFont:(s,r,l,c)=>this.fonts.addFont(s,r,l,c)}))}}generateDisplayLambda(e,i,n){const t=[],o=n.features?.inverted_colors||i.invertedColors,s=!!(n.features&&n.features.epaper);return o?(t.push("const auto COLOR_WHITE = Color(0, 0, 0); // Inverted for e-ink"),t.push("const auto COLOR_BLACK = Color(255, 255, 255); // Inverted for e-ink")):(t.push("const auto COLOR_WHITE = Color(255, 255, 255);"),t.push("const auto COLOR_BLACK = Color(0, 0, 0);")),t.push("const auto COLOR_RED = Color(255, 0, 0);"),t.push("const auto COLOR_GREEN = Color(0, 255, 0);"),t.push("const auto COLOR_BLUE = Color(0, 0, 255);"),t.push("const auto COLOR_YELLOW = Color(255, 255, 0);"),t.push("const auto COLOR_ORANGE = Color(255, 165, 0);"),t.push("auto color_off = COLOR_WHITE;"),t.push("auto color_on = COLOR_BLACK;"),t.push(""),t.push("// Helper to apply a simple grey dither mask for e-paper (checkerboard)"),t.push("auto apply_grey_dither_mask = [&](int x_start, int y_start, int w, int h, int r = 0) {"),t.push("  for (int y = y_start; y < y_start + h; y++) {"),t.push("    for (int x = x_start; x < x_start + w; x++) {"),t.push("      if (r > 0) {"),t.push("        int dx = 0, dy = 0;"),t.push("        if (x < x_start + r && y < y_start + r) { dx = x_start + r - x; dy = y_start + r - y; }"),t.push("        else if (x >= x_start + w - r && y < y_start + r) { dx = x - (x_start + w - r - 1); dy = y_start + r - y; }"),t.push("        else if (x < x_start + r && y >= y_start + h - r) { dx = x_start + r - x; dy = y - (y_start + h - r - 1); }"),t.push("        else if (x >= x_start + w - r && y >= y_start + h - r) { dx = x - (x_start + w - r - 1); dy = y - (y_start + h - r - 1); }"),t.push("        if (dx*dx + dy*dy > r*r) continue;"),t.push("      }"),t.push("      if ((x + y) % 2 == 0) it.draw_pixel_at(x, y, COLOR_WHITE);"),t.push("      else it.draw_pixel_at(x, y, COLOR_BLACK);"),t.push("    }"),t.push("  }"),t.push("};"),t.push(""),t.push("// Helper to apply grey dither to text (subtractive - erases every other black pixel)"),t.push("auto apply_grey_dither_to_text = [&](int x_start, int y_start, int w, int h) {"),t.push("  for (int y = y_start; y < y_start + h; y++) {"),t.push("    for (int x = x_start; x < x_start + w; x++) {"),t.push("      if ((x + y) % 2 == 0) it.draw_pixel_at(x, y, COLOR_WHITE);"),t.push("    }"),t.push("  }"),t.push("};"),window.PluginRegistry&&window.PluginRegistry.onExportHelpers({lines:t,widgets:e.flatMap(r=>r.widgets||[])}),t.push("int currentPage = id(display_page);"),e.forEach((r,l)=>{t.push(`if (currentPage == ${l}) {`),t.push(`  // page:name "${r.name||"Page "+(l+1)}"`),t.push(`  // page:dark_mode "${r.dark_mode||"inherit"}"`),t.push(`  // page:refresh_type "${r.refresh_type||"interval"}"`),t.push(`  // page:refresh_time "${r.refresh_time||""}"`),t.push("  // Clear screen for this page"),t.push("  it.fill(COLOR_WHITE);"),t.push("  color_off = COLOR_WHITE;"),t.push("  color_on = COLOR_BLACK;"),r.widgets&&r.widgets.filter(c=>!c.hidden&&c.type!=="group").forEach(c=>{const a=this.generateWidget(c,{profile:n,layout:i,adapter:this,isEpaper:s});if(a.length>0){const u=a.reduce((m,f)=>{if(!f.trim())return m;const y=f.match(/^ */);return Math.min(m,y?y[0].length:0)},1/0),g=u===1/0?0:u;t.push(...a.map(m=>m.trim()?"  "+m.substring(g):""))}}),t.push("}")}),t}generateWidget(e,i){if(e.type==="group")return[];const n=[],t=V?V.get(e.type):null,o=e.type&&e.type.startsWith("lvgl_");if(t&&typeof t.export=="function"){const s={...i,lines:n,addFont:(l,c,a,u)=>this.fonts.addFont(l,c,a,u),getColorConst:l=>K?K.getColorConst(l):`"${l}"`,getAlignX:(l,c,a)=>K?K.getAlignX(l,c,a):c,getAlignY:(l,c,a)=>K?K.getAlignY(l,c,a):c,addDitherMask:(l,c,a,u,g,m,f,y)=>K?K.addDitherMask(l,c,a,u,g,m,f,y||0):null,sanitize:l=>this.sanitize(l),getCondProps:l=>this.getCondProps(l),getConditionCheck:l=>this.getConditionCheck(l),Utils:K,COLORS:Je,ALIGNMENT:Ze,TEXT_Y_OFFSET:0,RECT_Y_OFFSET:0},r=t.export(e,s);r&&Array.isArray(r)?n.push(...r):r&&typeof r=="string"&&n.push(r)}else o?Ce?n.push(Ce(e)):n.push(`// widget:${e.type} id:${e.id} x:${e.x} y:${e.y} w:${e.width} h:${e.height}`):(n.push(`// widget:${e.type} id:${e.id} status:unsupported`),n.push(`        // Unsupported widget type: ${e.type}`));return n}processPendingTriggers(e,i,n,t="on_value"){if(!n||!i||i.size===0)return e;const o=[];for(let s=0;s<e.length;s++){const r=e[s];o.push(r);const l=r.match(/^\s*(entity_id|id):\s*"?([^"]+)"?/);if(l){const c=l[2].trim();if(i.has(c)){let a=!1;for(let u=s+1;u<Math.min(s+5,e.length);u++)if(e[u].trim()===`${t}:`){a=!0;break}if(!a){const u=(r.match(/^\s*/)||[""])[0].length,g=" ".repeat(u);o.push(`${g}${t}:`),o.push(`${g}  then:`);for(const m of i.get(c))m.split(`
`).forEach(y=>{o.push(`${g}    ${y}`)})}}}}return o}async fetchHardwarePackage(e){let i=e;window.location.pathname.includes("/esphome-designer/editor")&&!e.startsWith("http")&&!e.startsWith("/")&&(i="/esphome-designer/editor/static/"+e);try{const n=await fetch(i,{cache:"no-store"});if(!n.ok)throw new Error(`HTTP ${n.status}`);return await n.text()}catch(n){return _.error("Failed to fetch hardware package:",n),`# ERROR LOADING PROFILE: ${n.message}`}}sanitizePackageContent(e){if(!e)return"";const i=["esphome:","esp32:","psram:","wifi:","api:","ota:","logger:","web_server:","captive_portal:","platformio_options:","preferences:","substitutions:"],n=e.split(`
`),t=[];let o=!1;for(let s of n){const r=s.trim();if(r.length===0){t.push(s);continue}(s.match(/^\s*/)||[""])[0].length===0&&r.endsWith(":")?(o=i.some(c=>r.startsWith(c)),o?t.push("# "+s+" # (Auto-commented)"):t.push(s)):o?t.push("# "+s):t.push(s)}return t.join(`
`)}applyPackageOverrides(e,i,n){if(i.name?.includes("Waveshare Touch LCD 7")){let t=0;n==="portrait"?t=90:n==="landscape"?t=0:n==="portrait_inverted"?t=270:n==="landscape_inverted"&&(t=180),e=e.replace(/rotation:\s*\d+/g,`rotation: ${t}`);const o=e.match(/^(\s*)id:\s*my_touchscreen/m);if(o){const s=o[1];let r="";t===0?r=`transform:
${s}  swap_xy: false
${s}  mirror_x: false
${s}  mirror_y: false`:t===90?r=`transform:
${s}  swap_xy: true
${s}  mirror_x: false
${s}  mirror_y: true`:t===180?r=`transform:
${s}  swap_xy: false
${s}  mirror_x: true
${s}  mirror_y: true`:t===270&&(r=`transform:
${s}  swap_xy: true
${s}  mirror_x: true
${s}  mirror_y: false`),r&&(e=e.replace(/(id:\s*my_touchscreen[^\n\r]*[\r\n]+)/,`$1${s}${r}
`))}}return e}getCondProps(e){const i=(e.condition_entity||"").trim();if(!i)return"";const n=e.condition_operator||"==";let t=` cond_ent:"${i}" cond_op:"${n}"`;return n==="range"?(e.condition_min!==void 0&&e.condition_min!==null&&(t+=` cond_min:"${e.condition_min}"`),e.condition_max!==void 0&&e.condition_max!==null&&(t+=` cond_max:"${e.condition_max}"`)):e.condition_state!==void 0&&e.condition_state!==null&&(t+=` cond_state:"${e.condition_state}"`),t}getConditionCheck(e){const i=(e.condition_entity||"").trim();if(!i)return"";const n=e.condition_operator||"==",t=(e.condition_state||"").trim(),o=t.toLowerCase(),s=e.condition_min,r=e.condition_max,l=i.replace(/[^a-zA-Z0-9_]/g,"_"),a=["binary_sensor.","switch.","light.","input_boolean.","fan.","cover.","vacuum.","lock."].some(y=>i.startsWith(y));let g=i.startsWith("text_sensor.");if(!g&&!a&&n!=="range"){const y=parseFloat(t),b=["on","off","true","false","open","closed","locked","unlocked","home","not_home","occupied","clear","active","inactive","detected","idle"];t&&isNaN(y)&&!b.includes(o)&&(g=!0)}let m=`id(${l}).state`;g&&i.startsWith("text_sensor.");let f="";if(n==="=="||n==="!="||n===">"||n==="<"||n===">="||n==="<=")if(g)f=`${m} ${n} "${t}"`;else if(a){const b=["on","true","1","open","locked","home","occupied","active","detected"].includes(o);n==="=="?f=b?m:`!${m}`:n==="!="?f=b?`!${m}`:m:f=`(int)${m} ${n} ${b?1:0}`}else{let y=parseFloat(t);isNaN(y)&&(["on","true","open","locked","home","occupied","active","detected"].includes(o)?y=1:["off","false","closed","unlocked","not_home","clear","inactive","idle"].includes(o)&&(y=0)),f=`${m} ${n} ${isNaN(y)?0:y}`}else if(n==="range"){const y=parseFloat(s),b=parseFloat(r);f=`${m} >= ${isNaN(y)?0:y} && ${m} <= ${isNaN(b)?100:b}`}return f?`if (${f}) {`:""}sanitize(e){return e?e.replace(/"/g,'\\"'):""}}window.ESPHomeAdapter=hi;class Is{constructor(){this.cache={models:{}}}getSettings(){return window.AppState.settings}async fetchModels(e,i){if(!i)return[];try{if(e==="openrouter")return(await(await fetch("https://openrouter.ai/api/v1/models",{headers:{Authorization:`Bearer ${i}`}})).json()).data.map(o=>({id:o.id,name:o.name,context:o.context_length}));if(e==="openai")return(await(await fetch("https://api.openai.com/v1/models",{headers:{Authorization:`Bearer ${i}`}})).json()).data.filter(o=>o.id.startsWith("gpt-")).map(o=>({id:o.id,name:o.id}));if(e==="gemini"){try{const t=await(await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${i}`)).json();if(t.models&&Array.isArray(t.models))return t.models.filter(o=>o.supportedGenerationMethods.includes("generateContent")).map(o=>({id:o.name.replace("models/",""),name:o.displayName||o.name.replace("models/",""),description:o.description}))}catch(n){throw _.warn("Dynamic Gemini model fetch failed:",n),new Error("Failed to fetch Gemini models. Check your API key.")}return[]}}catch(n){throw _.error(`Error fetching models for ${e}:`,n),n}return[]}async processPrompt(e,i){const n=this.getSettings(),t=n.ai_provider||"gemini",o=n[`ai_api_key_${t}`];let s=n[`ai_model_${t}`];if(!s&&t==="gemini"){_.log("No model selected, attempting to auto-detect...");try{const a=await this.fetchModels(t,o);if(a.length>0)s=(a.find(g=>g.id.includes("flash"))||a.find(g=>g.id.includes("1.5-pro"))||a.find(g=>g.id.includes("gemini-pro"))||a[0]).id,_.log(`Auto-detected model: ${s}`),window.AppState.updateSettings({[`ai_model_${t}`]:s});else throw new Error("No models found for this API Key.")}catch(a){_.error("Auto-detection failed:",a),s="gemini-1.5-flash"}}if(!o)throw new Error(`Missing API Key for ${t}`);if(!s)throw new Error(`No model selected for ${t}`);const r=this.getSystemPrompt(),l={...i,widgets:i.widgets.map(a=>this.minifyWidget(a))},c=`
Current Layout Context:
${JSON.stringify(l,null,2)}

User Request:
${e}

Respond ONLY with valid JSON containing the updated "widgets" array for the current page. Do not include any explanation.
`.trim();try{let a="";t==="gemini"?a=await this.callGemini(o,s,r,c):t==="openai"?a=await this.callOpenAI(o,s,r,c):t==="openrouter"&&(a=await this.callOpenRouter(o,s,r,c));let u=a.trim();if(u.includes("```")){const b=u.match(/```(?:json)?\s*([\s\S]*?)\s*```/);b&&b[1]&&(u=b[1].trim())}const g=u.indexOf("["),m=u.indexOf("{");let f=-1,y=-1;g!==-1&&(m===-1||g<m)?(f=g,y=u.lastIndexOf("]")):m!==-1&&(f=m,y=u.lastIndexOf("}")),f!==-1&&y!==-1&&y>f&&(u=u.substring(f,y+1));try{const b=JSON.parse(u);return Array.isArray(b)?b:b.widgets||b}catch(b){_.warn("Fast JSON parse failed, trying repair...",b);try{const w=this.repairJson(u),S=JSON.parse(w);return Array.isArray(S)?S:S.widgets||S}catch(w){throw _.error("JSON repair failed:",w),new Error("AI returned malformed JSON (possibly truncated). Try a shorter prompt or a more powerful model.")}}}catch(a){throw _.error("AI processing failed:",a),a}}async callGemini(e,i,n,t){const o=`https://generativelanguage.googleapis.com/v1beta/models/${i}:generateContent?key=${e}`,s={contents:[{role:"user",parts:[{text:n+`

`+t}]}],generationConfig:{temperature:.1,topP:.95,topK:40,maxOutputTokens:8192,responseMimeType:"application/json"}},r=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),l=await r.json();if(r.status===429)throw new Error("â ï¸ Rate Limit Exceeded: You are sending requests too quickly for the free tier. Please wait a minute and try again.");if(l.error)throw new Error(l.error.message);return l.candidates[0].content.parts[0].text}async callOpenAI(e,i,n,t){const s=i&&i.toLowerCase().includes("gpt-5")?{type:"json_schema",json_schema:{name:"widget_layout",strict:!0,schema:{type:"object",properties:{widgets:{type:"array",items:{type:"object"}}},required:["widgets"],additionalProperties:!1}}}:{type:"json_object"},l=await(await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:i,messages:[{role:"system",content:n},{role:"user",content:t}],temperature:.1,max_tokens:8192,response_format:s})})).json();if(l.error)throw new Error(l.error.message);return l.choices[0].message.content}async callOpenRouter(e,i,n,t){const s=await(await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:i,messages:[{role:"system",content:n},{role:"user",content:t}],temperature:.1,max_tokens:4096})})).json();if(s.error)throw new Error(s.error.message);return s.choices[0].message.content}getSystemPrompt(){return`
You are an expert UI designer and developer for ESPHome devices. 
Your task is to modify or create a widget list based on user instructions.

WIDGET TYPES & PROPS:
- text: { x, y, width, height, text, font_size, font_family, font_weight (400 or 700), color, align }
- sensor_text: { x, y, width, height, entity, prefix, suffix, font_size, color }
- datetime: { x, y, width, height, format, time_font_size, date_font_size, color }
- weather_forecast: { x, y, width, height, entity, layout ("horizontal"/"vertical"), icon_size, temp_font_size, day_font_size }
- weather_icon: { x, y, width, height, entity, size, color }
- icon: { x, y, width, height, icon, icon_size, color }
- battery_icon: { x, y, width, height, entity, color }
- progress_bar: { x, y, width, height, color, bar_height }
- graph: { x, y, width, height, entity, color, duration }
- shape_rect / rounded_rect / shape_circle: { x, y, width, height, color, fill (bool), border_width, opacity }
- lvgl_*: Advanced widgets (lvgl_button, lvgl_switch, lvgl_slider, lvgl_arc, etc).

STRICT OPERATIONAL RULES:
1. CONTENT ACCURACY: If the user says "reads 'X'", the 'text' property MUST BE "X". NEVER use generic placeholders like "Text".
2. TYPOGRAPHY: "Bold" = font_weight: 700. "Normal/Regular" = font_weight: 400. "Large" = font_size: 28+.
3. VISUAL HIERARCHY: Use 'shape_rect' or 'rounded_rect' to create headers, footers, or background cards for groups of widgets. Use small thin shapes as dividers.
4. UNIQUE IDS: Every new widget MUST have a unique ID like "w_" + timestamp or a short descriptive string. Never leave ID as null or undefined.
5. CANVAS BOUNDS: Stay within ${JSON.stringify(window.AppState.getCanvasDimensions())}.
6. COLOR USAGE: Check "display_type" in context:
   - "monochrome": Use ONLY "black" or "white". No grays, no colors.
   - "color_epaper": Use limited palette: black, white, red, green, blue, yellow, orange. No gradients.
   - "color_lcd": Full RGB colors allowed. Use hex codes like "#FF5722" or CSS names.
7. LVGL WIDGETS: If "display_type" is "monochrome" or "color_epaper", do NOT use lvgl_* widgets unless the user explicitly requests LVGL. Use standard widgets (text, shape_rect, icon, etc.) instead. LVGL is designed for LCDs with fast refresh.

FEW-SHOT EXAMPLE:
User: "Add a large bold title that reads 'Home Status' at the top with a separator line."
Response: [
  {"id": "w_title", "type": "text", "x": 20, "y": 10, "width": 760, "height": 50, "text": "Home Status", "font_size": 32, "font_weight": 700, "align": "CENTER"},
  {"id": "w_sep", "type": "shape_rect", "x": 20, "y": 65, "width": 760, "height": 2, "color": "black", "fill": true}
]

8. DROP SHADOWS: For LCD displays ("color_lcd"), add subtle drop shadows to shapes and cards.
   HOW TO: Create a DUPLICATE of the widget to be shadowed.
           - ID: [original_id]_shadow
           - X/Y: original.x + 4, original.y + 4
           - Color: "black" (or "white" if background is dark)
           - Z-Order: Place the shadow widget BEFORE the main widget in the list so it renders behind.
           - Opacity: If supported by the widget type ('shape_rect'), set opacity to 0.4. If not, use a gray color like "#333333".

DESIGN GOAL: Create "Beautiful" layouts. Use whitespace, professional alignment, and decorative shapes to make the UI look premium.
`.trim()}repairJson(e){let i=[],n=!1,t=!1;for(let s=0;s<e.length;s++){const r=e[s];if(t){t=!1;continue}if(r==="\\"){t=!0;continue}if(r==='"'){n=!n;continue}n||(r==="["||r==="{"?i.push(r==="["?"]":"}"):(r==="]"||r==="}")&&i.length>0&&i[i.length-1]===r&&i.pop())}let o=e;for(n&&(o+='"'),o=o.trim().replace(/,\s*$/,"");i.length>0;)o+=i.pop();return o}minifyWidget(e){const{id:i,type:n,x:t,y:o,width:s,height:r,...l}=e;return{id:i,type:n,x:t,y:o,width:s,height:r,...l}}}const jt=[{id:"core",name:"Core Widgets",expanded:!0,widgets:[{type:"label",label:"Floating text",tag:"Text",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><text x="4" y="17" font-size="14" font-weight="bold" fill="currentColor">Aa</text></svg>'},{type:"sensor_text",label:"Sensor text",tag:"Entity",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><circle cx="8" cy="12" r="3" fill="none" stroke="currentColor" stroke-width="2" /><path d="M11 12h9M14 9l3 3-3 3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'},{type:"datetime",label:"Date & Time",tag:"Time",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2" /><path d="M12 7v5l3 3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'},{type:"icon",label:"MDI icon",tag:"Icon",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M12 2L9 9H2l6 4.5L5.5 22 12 17l6.5 5-2.5-8.5L22 9h-7z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round" /></svg>'},{type:"weather_icon",label:"Weather icon",tag:"Icon",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><circle cx="12" cy="10" r="4" fill="none" stroke="currentColor" stroke-width="2" /><path d="M12 2v2M12 16v2M4 10H2M22 10h-2M5.6 4.6l1.4 1.4M17 6l1.4-1.4M5.6 15.4l1.4-1.4M17 14l1.4 1.4" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'},{type:"image",label:"Image",tag:"Media",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="3" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><circle cx="8.5" cy="8.5" r="1.5" fill="currentColor" /><path d="M21 15l-5-5L11 15l-3-3-5 5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'},{type:"online_image",label:"Puppet image",tag:"Remote",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="5" width="14" height="14" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><circle cx="8" cy="10" r="1.5" fill="currentColor" /><path d="M17 12l-4-4-4 4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" /><circle cx="19" cy="6" r="3" fill="none" stroke="currentColor" stroke-width="2" /><path d="M19 5v2M19 9v.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'}]},{id:"shapes",name:"Shapes",expanded:!0,widgets:[{type:"shape_rect",label:"Rectangle",tag:"Shape",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="14" rx="2" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"rounded_rect",label:"Rounded Rect",tag:"Shape",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="14" rx="6" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"shape_circle",label:"Circle",tag:"Shape",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"line",label:"Line",tag:"Shape",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><line x1="4" y1="12" x2="20" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'}]},{id:"advanced",name:"Advanced",expanded:!0,widgets:[{type:"graph",label:"Graph / Chart",tag:"Data",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M3 3v18h18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" /><path d="M7 14l4-4 4 4 5-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'},{type:"progress_bar",label:"Progress bar",tag:"Entity",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="9" width="20" height="6" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><rect x="3" y="10" width="12" height="4" rx="1" fill="currentColor" /></svg>'},{type:"qr_code",label:"QR Code",tag:"Tools",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" fill="currentColor" /><rect x="14" y="3" width="7" height="7" fill="currentColor" /><rect x="3" y="14" width="7" height="7" fill="currentColor" /><rect x="14" y="14" width="3" height="3" fill="currentColor" /></svg>'},{type:"calendar",label:"Calendar",tag:"Events",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><path d="M16 2v4M8 2v4M3 10h18" stroke="currentColor" stroke-width="2" /></svg>'},{type:"weather_forecast",label:"Weather Forecast",tag:"Forecast",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><circle cx="12" cy="10" r="4" fill="none" stroke="currentColor" stroke-width="2" /><path d="M12 2v2M12 16v2M4 10H2M22 10h-2M5.6 4.6l1.4 1.4M17 6l1.4-1.4M5.6 15.4l1.4-1.4M17 14l1.4 1.4" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'},{type:"quote_rss",label:"Quote / RSS",tag:"Info",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M6 17h3l2-4V7H5v6h3M13 17h3l2-4V7h-6v6h3" fill="none" stroke="currentColor" stroke-width="2" /></svg>'}]},{id:"inputs",name:"Inputs",expanded:!1,icon:'<svg class="category-svg" viewBox="0 0 24 24" width="16" height="16"><path d="M9 11.24V7.5C9 6.12 10.12 5 11.5 5S14 6.12 14 7.5v3.74c1.21-.81 2-2.18 2-3.74C16 5.01 13.99 3 11.5 3S7 5.01 7 7.5c0 1.56.79 2.93 2 3.74zM16.06 17H15v-1l-1-1h-6l-1 1v1H5.94c-.58 0-1.06-.48-1.06-1.06V7.5c0-3.59 2.91-6.5 6.5-6.5s6.5 2.91 6.5 6.5v8.44c0 .58-.48 1.06-1.06 1.06z" fill="none" stroke="currentColor" stroke-width="2" /><circle cx="12" cy="13" r="1.5" fill="currentColor" /></svg>',widgets:[{type:"touch_area",label:"Touch Area",tag:"Input",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="5" y="5" width="14" height="14" rx="2" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="2,2" /><circle cx="12" cy="12" r="3" fill="currentColor" /></svg>'},{type:"nav_next_page",label:"Next Page",tag:"Nav",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M10 6l6 6-6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'},{type:"nav_previous_page",label:"Prev Page",tag:"Nav",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M14 6l-6 6 6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'},{type:"nav_reload_page",label:"Reload Page",tag:"Nav",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M23 4v6h-6M1 20v-6h6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'},{type:"template_nav_bar",label:"Navigation Bar",tag:"Template",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><path d="M7 12l-3-3 3-3M17 12l3-3-3-3M12 9v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'}]},{id:"ondevice",name:"On Device Sensors",expanded:!0,widgets:[{type:"battery_icon",label:"Battery",tag:"Sensor",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="7" width="18" height="10" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><rect x="4" y="9" width="8" height="6" fill="currentColor" /><path d="M20 10h2v4h-2" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"wifi_signal",label:"WiFi Signal",tag:"Sensor",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M12 3C7.5 3 3.8 5.4 2 9l2 2c1.3-2.5 4-4.2 8-4.2s6.7 1.7 8 4.2l2-2c-1.8-3.6-5.5-6-10-6z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" /><path d="M12 9c-2.7 0-5.1 1.4-6.5 3.5L7 14c1-1.4 2.8-2.3 5-2.3s4 .9 5 2.3l1.5-1.5C17.1 10.4 14.7 9 12 9z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" /><circle cx="12" cy="18" r="2" fill="currentColor" /></svg>'},{type:"ondevice_temperature",label:"Temperature",tag:"SHT4x",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M12 2a2 2 0 00-2 2v10.1a4 4 0 104 0V4a2 2 0 00-2-2z" fill="none" stroke="currentColor" stroke-width="2" /><circle cx="12" cy="18" r="2" fill="currentColor" /></svg>'},{type:"ondevice_humidity",label:"Humidity",tag:"SHT4x",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M12 2.69l5.66 5.66a8 8 0 11-11.31 0z" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"template_sensor_bar",label:"On-Board Sensor Bar",tag:"New",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><path d="M5 12h2M10 12h2M15 12h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'}]},{id:"lvgl",name:"LVGL Components",expanded:!1,icon:'<svg class="category-svg" viewBox="0 0 24 24" width="16" height="16"><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5l-2.5 1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round" /></svg>',widgets:[{type:"lvgl_obj",label:"Base Object",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"lvgl_label",label:"Label",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><text x="4" y="17" font-size="14" font-weight="bold" fill="currentColor">Aa</text></svg>'},{type:"lvgl_line",label:"LVGL Line",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><line x1="4" y1="12" x2="20" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'},{type:"lvgl_button",label:"Button",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="4" y="8" width="16" height="8" rx="2" fill="currentColor" fill-opacity="0.2" stroke="currentColor" stroke-width="2" /><text x="12" y="16.5" font-size="8" text-anchor="middle" fill="currentColor">BTN</text></svg>'},{type:"lvgl_switch",label:"Switch",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="4" y="8" width="16" height="8" rx="4" fill="none" stroke="currentColor" stroke-width="2" /><circle cx="16" cy="12" r="3" fill="currentColor" /></svg>'},{type:"lvgl_checkbox",label:"Checkbox",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><polyline points="9 12 11 14 15 10" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"lvgl_slider",label:"Slider",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><line x1="4" y1="12" x2="20" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" /><circle cx="12" cy="12" r="3" fill="currentColor" /></svg>'},{type:"lvgl_bar",label:"Bar",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="9" width="20" height="6" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><rect x="3" y="10" width="12" height="4" rx="1" fill="currentColor" /></svg>'},{type:"lvgl_arc",label:"Arc",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M4 18 A 10 10 0 1 1 20 18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'},{type:"lvgl_meter",label:"Meter",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M4 18 A 10 10 0 1 1 20 18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" /><line x1="12" y1="18" x2="16" y2="10" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'},{type:"lvgl_spinner",label:"Spinner",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"lvgl_led",label:"LED",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="6" fill="currentColor" /><circle cx="12" cy="12" r="8" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"lvgl_chart",label:"Chart",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M3 3v18h18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" /><path d="M7 14l4-4 4 4 5-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'},{type:"lvgl_img",label:"Image",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="3" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><circle cx="8.5" cy="8.5" r="1.5" fill="currentColor" /><path d="M21 15l-5-5L11 15l-3-3-5 5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'},{type:"lvgl_qrcode",label:"QR Code",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" fill="currentColor" /><rect x="14" y="3" width="7" height="7" fill="currentColor" /><rect x="3" y="14" width="7" height="7" fill="currentColor" /><rect x="14" y="14" width="3" height="3" fill="currentColor" /></svg>'},{type:"lvgl_dropdown",label:"Dropdown",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="8" width="20" height="8" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><polyline points="16 11 18 13 20 11" fill="currentColor" /></svg>'},{type:"lvgl_roller",label:"Roller",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="6" y="2" width="12" height="20" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><line x1="6" y1="10" x2="18" y2="10" stroke="currentColor" stroke-width="1" /><line x1="6" y1="14" x2="18" y2="14" stroke="currentColor" stroke-width="1" /></svg>'},{type:"lvgl_spinbox",label:"Spinbox",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="4" y="8" width="16" height="8" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><path d="M6 12l2-2 2 2" fill="none" stroke="currentColor" stroke-width="1" /><path d="M14 12l2 2 2-2" fill="none" stroke="currentColor" stroke-width="1" /></svg>'},{type:"lvgl_textarea",label:"Textarea",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" fill="none" stroke="currentColor" stroke-width="2" /><line x1="6" y1="8" x2="14" y2="8" stroke="currentColor" stroke-width="2" /></svg>'},{type:"lvgl_keyboard",label:"Keyboard",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><line x1="6" y1="10" x2="8" y2="10" stroke="currentColor" stroke-width="2" /><line x1="10" y1="10" x2="12" y2="10" stroke="currentColor" stroke-width="2" /></svg>'},{type:"lvgl_buttonmatrix",label:"Btn Matrix",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="7" width="9" height="4" fill="none" stroke="currentColor" stroke-width="1" /><rect x="13" y="7" width="9" height="4" fill="none" stroke="currentColor" stroke-width="1" /><rect x="2" y="13" width="9" height="4" fill="none" stroke="currentColor" stroke-width="1" /><rect x="13" y="13" width="9" height="4" fill="none" stroke="currentColor" stroke-width="1" /></svg>'},{type:"lvgl_tabview",label:"Tabview",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><line x1="2" y1="8" x2="22" y2="8" stroke="currentColor" stroke-width="1" /></svg>'},{type:"lvgl_tileview",label:"Tileview",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="2" width="9" height="9" fill="none" stroke="currentColor" stroke-width="2" /><rect x="13" y="2" width="9" height="9" fill="none" stroke="currentColor" stroke-width="2" /><rect x="2" y="13" width="9" height="9" fill="none" stroke="currentColor" stroke-width="2" /><rect x="13" y="13" width="9" height="9" fill="none" stroke="currentColor" stroke-width="2" /></svg>'}]}];async function Cs(d){const e=document.getElementById(d);if(!e)return;e.innerHTML='<div class="palette-loading" style="padding: 20px; color: #999; text-align: center; font-size: 13px;">Loading widgets...</div>';const i=[];jt.forEach(n=>{n.widgets.forEach(t=>{i.includes(t.type)||i.push(t.type)})}),_.log(`[Palette] Pre-loading ${i.length} widget plugins...`);try{await Promise.all(i.map(n=>V.load(n)))}catch(n){_.error("[Palette] Failed to load some plugins:",n)}e.innerHTML="",jt.forEach(n=>{const t=document.createElement("div");t.className=`widget-category ${n.expanded?"expanded":""}`,t.dataset.category=n.id;const o=document.createElement("div");o.className="widget-category-header";let s='<span class="category-icon">âº</span>';n.icon&&(s+=n.icon),o.innerHTML=`
            ${s}
            <span class="category-name">${n.name}</span>
            ${n.widgets.length>0&&!n.expanded?`<span class="category-count">${n.widgets.length}</span>`:""}
        `,o.addEventListener("click",()=>{t.classList.toggle("expanded")});const r=document.createElement("div");r.className="widget-category-items",n.widgets.forEach(l=>{const c=document.createElement("div");c.className="item",c.draggable=!0,c.dataset.widgetType=l.type;const a=V.get(l.type),u=l.label||a?.name;let g="";l.tag&&(g=`<span class="tag">${l.tag}</span>`),c.innerHTML=`
                ${l.icon}
                <span class="label">${u}</span>
                ${g}
            `,c.title=`Add ${u} to canvas`,c.addEventListener("dragstart",m=>{m.dataTransfer.setData("application/widget-type",l.type),m.dataTransfer.effectAllowed="copy"}),r.appendChild(c)}),t.appendChild(o),t.appendChild(r),e.appendChild(t)})}class Ls{constructor(){this.listContainer=null,this.header=null,this.panel=null,this.draggedIndex=null,this.render=this.render.bind(this),this.highlightSelected=this.highlightSelected.bind(this)}init(){if(this.listContainer=document.getElementById("hierarchyList"),this.header=document.getElementById("hierarchyHeader"),this.panel=document.getElementById("hierarchyPanel"),!this.listContainer||!this.header||!this.panel){_.error("[HierarchyView] Required DOM elements not found");return}this.controlsContainer=document.createElement("div"),this.controlsContainer.id="hierarchyControls",this.controlsContainer.className="hierarchy-controls",this.controlsContainer.style.padding="8px 8px",this.controlsContainer.style.borderTop="1px solid var(--border-subtle)",this.panel.appendChild(this.controlsContainer),this.bindEvents(),this.render(),this.renderHeaderActions(),_.log("[HierarchyView] Initialized")}renderHeaderActions(){if(!this.header)return;let e=this.header.querySelector(".hierarchy-header-toggles");if(!e){e=document.createElement("div"),e.className="hierarchy-header-toggles";const i=this.header.querySelector(".chevron");this.header.insertBefore(e,i);const n=this.createHeaderToggle("mdi-lock-outline","Toggle All Locks",()=>{const o=h.getCurrentPage()?.widgets||[],s=o.every(r=>r.locked);o.forEach(r=>h.updateWidget(r.id,{locked:!s}))}),t=this.createHeaderToggle("mdi-eye-outline","Toggle All Visibility",()=>{const o=h.getCurrentPage()?.widgets||[],s=o.every(r=>r.hidden);o.forEach(r=>h.updateWidget(r.id,{hidden:!s}))});e.appendChild(n),e.appendChild(t)}}createHeaderToggle(e,i,n){const t=document.createElement("div");return t.className="h-toggle",t.title=i,t.innerHTML=`<i class="mdi ${e}"></i>`,t.onclick=o=>{o.stopPropagation(),n()},t}bindEvents(){this.header.addEventListener("click",()=>this.toggleCollapse()),Q(B.STATE_CHANGED,this.render),Q(B.PAGE_CHANGED,this.render),Q(B.SELECTION_CHANGED,this.highlightSelected)}toggleCollapse(){const e=this.panel.classList.toggle("hidden"),i=this.header.querySelector(".chevron");i&&(i.style.transform=e?"rotate(-90deg)":"rotate(0deg)")}highlightSelected(){const e=h.selectedWidgetIds||[];this.listContainer.querySelectorAll(".hierarchy-item").forEach(n=>{e.includes(n.dataset.id)?n.classList.add("selected"):n.classList.remove("selected")}),this.renderControls()}render(){const e=h.getCurrentPage();if(!e)return;if(this.listContainer.innerHTML="",!e.widgets||e.widgets.length===0){this.listContainer.innerHTML='<div style="font-size: 10px; color: var(--muted); text-align: center; padding: 12px;">No widgets on this page</div>',this.controlsContainer.style.display="none";return}const i=e.widgets.filter(o=>!o.parentId).reverse(),n=new Map;e.widgets.forEach(o=>{o.parentId&&(n.has(o.parentId)||n.set(o.parentId,[]),n.get(o.parentId).push(o))});const t=(o,s=0)=>{const r=e.widgets.indexOf(o),l=this.createItem(o,r,s);this.listContainer.appendChild(l);const c=n.get(o.id);c&&o.expanded!==!1&&[...c].reverse().forEach(a=>t(a,s+1))};i.forEach(o=>t(o)),this.highlightSelected(),this.renderControls()}createItem(e,i,n=0){const t=document.createElement("div");t.className=`hierarchy-item ${e.hidden?"hidden-widget":""}`,n>0&&t.classList.add("child-item"),(h.selectedWidgetIds||[]).includes(e.id)&&t.classList.add("selected"),t.dataset.id=e.id,t.dataset.index=i,t.draggable=!e.locked,e.locked&&t.classList.add("locked"),t.style.paddingLeft=12+n*20+"px";const s=this.getWidgetIcon(e.type),r=this.getWidgetLabel(e),l=e.type==="group";return t.innerHTML=`
            <div class="hierarchy-item-drag-handle" style="${e.locked?"display:none":""}">
                <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="9" cy="5" r="1"></circle><circle cx="9" cy="12" r="1"></circle><circle cx="9" cy="19" r="1"></circle>
                    <circle cx="15" cy="5" r="1"></circle><circle cx="15" cy="12" r="1"></circle><circle cx="15" cy="19" r="1"></circle>
                </svg>
            </div>
            ${l?`
            <div class="hierarchy-group-toggle ${e.expanded!==!1?"expanded":""}">
                <i class="mdi mdi-chevron-down"></i>
            </div>
            `:'<div style="width: 16px;"></div>'}
            <div class="hierarchy-item-icon">${s}</div>
            <div class="hierarchy-item-label">${r}</div>
            <div class="hierarchy-item-actions">
                <div class="hierarchy-item-action toggle-lock" title="${e.locked?"Unlock":"Lock"}">
                     <i class="mdi ${e.locked?"mdi-lock-outline":"mdi-lock-open-outline"}"></i>
                </div>
                <div class="hierarchy-item-action toggle-visibility" title="Toggle Visibility">
                    <i class="mdi ${e.hidden?"mdi-eye-off-outline":"mdi-eye-outline"}"></i>
                </div>
                <div class="hierarchy-item-action delete-widget danger" title="Delete Widget">
                    <i class="mdi mdi-delete-outline"></i>
                </div>
            </div>
        `,l&&t.querySelector(".hierarchy-group-toggle").addEventListener("click",a=>{h.updateWidget(e.id,{expanded:e.expanded===!1}),a.stopPropagation()}),t.querySelector(".hierarchy-item-label").addEventListener("click",a=>{if(h.selectedWidgetIds.includes(e.id)){const u=prompt("Rename:",r);u!==null&&u!==""&&u!==r&&h.updateWidget(e.id,{title:u}),a.stopPropagation();return}}),t.addEventListener("click",a=>{const u=a.ctrlKey||a.shiftKey;h.selectWidget(e.id,u),a.stopPropagation()}),t.querySelector(".toggle-lock").addEventListener("click",a=>{h.updateWidget(e.id,{locked:!e.locked}),a.stopPropagation()}),t.querySelector(".toggle-visibility").addEventListener("click",a=>{h.updateWidget(e.id,{hidden:!e.hidden}),a.stopPropagation()}),t.querySelector(".delete-widget").addEventListener("click",a=>{confirm(`Delete widget "${r}"?`)&&h.deleteWidget(e.id),a.stopPropagation()}),t.addEventListener("dragstart",a=>{this.draggedIndex=i,t.classList.add("dragging"),a.dataTransfer.setData("application/widget-id",e.id),a.dataTransfer.effectAllowed="move"}),t.addEventListener("dragend",()=>{t.classList.remove("dragging"),this.draggedIndex=null,this.listContainer.querySelectorAll(".hierarchy-item").forEach(u=>u.classList.remove("drag-over"))}),t.addEventListener("dragover",a=>{a.preventDefault(),a.dataTransfer.dropEffect="move",t.classList.add("drag-over")}),t.addEventListener("dragleave",()=>{t.classList.remove("drag-over")}),t.addEventListener("drop",a=>{a.preventDefault();const u=a.dataTransfer.getData("application/widget-id"),g=t.dataset.id;if(u===g)return;const m=h.getWidgetById(g);if(!m)return;m.type==="group"?h.updateWidget(u,{parentId:g,expanded:!0}):h.updateWidget(u,{parentId:m.parentId||null});const f=parseInt(t.dataset.index);this.draggedIndex!==null&&h.reorderWidget(h.currentPageIndex,this.draggedIndex,f)}),t}renderControls(){const e=h.getSelectedWidgets();if(e.length===0){this.controlsContainer.style.display="none";return}this.controlsContainer.style.display="block",this.controlsContainer.innerHTML="";const i=l=>{const c=document.createElement("div");c.style.fontSize="10px",c.style.color="var(--muted)",c.style.marginBottom="6px",c.style.fontWeight="600",c.style.marginTop="8px",c.textContent=l,this.controlsContainer.appendChild(c)},n=()=>{const l=document.createElement("div");return l.style.display="flex",l.style.gap="4px",this.controlsContainer.appendChild(l),l};i("GROUPING");const t=n(),o=e.some(l=>l.type==="group"||l.parentId),s=document.createElement("button");s.className="btn btn-secondary",s.innerHTML='<i class="mdi mdi-group" style="margin-right:4px"></i>Group',s.style.flex="1",s.style.fontSize="10px",s.disabled=e.length<2||o,s.onclick=()=>h.groupSelection(),t.appendChild(s);const r=document.createElement("button");if(r.className="btn btn-secondary",r.innerHTML='<i class="mdi mdi-ungroup" style="margin-right:4px"></i>Ungroup',r.style.flex="1",r.style.fontSize="10px",r.disabled=!o,r.onclick=()=>h.ungroupSelection(),t.appendChild(r),e.length===1){const l=e[0];i("LAYER ORDER");const c=n();[{label:"Front",icon:"mdi-arrange-bring-to-front",action:()=>this.moveToFront(l)},{label:"Back",icon:"mdi-arrange-send-to-back",action:()=>this.moveToBack(l)},{label:"Up",icon:"mdi-arrow-up",action:()=>this.moveUp(l)},{label:"Down",icon:"mdi-arrow-down",action:()=>this.moveDown(l)}].forEach(u=>{const g=document.createElement("button");g.className="btn btn-secondary",g.innerHTML=`<i class="mdi ${u.icon}"></i>`,g.title=u.label,g.style.flex="1",g.style.fontSize="12px",g.style.padding="4px",g.onclick=()=>u.action(),c.appendChild(g)})}}moveToFront(e){const i=h.getCurrentPage(),n=i.widgets.findIndex(t=>t.id===e.id);n>-1&&n<i.widgets.length-1&&(i.widgets.splice(n,1),i.widgets.push(e),h.setPages(h.pages))}moveToBack(e){const i=h.getCurrentPage(),n=i.widgets.findIndex(t=>t.id===e.id);n>0&&(i.widgets.splice(n,1),i.widgets.unshift(e),h.setPages(h.pages))}moveUp(e){const i=h.getCurrentPage(),n=i.widgets.findIndex(t=>t.id===e.id);n>-1&&n<i.widgets.length-1&&([i.widgets[n],i.widgets[n+1]]=[i.widgets[n+1],i.widgets[n]],h.setPages(h.pages))}moveDown(e){const i=h.getCurrentPage(),n=i.widgets.findIndex(t=>t.id===e.id);n>0&&([i.widgets[n],i.widgets[n-1]]=[i.widgets[n-1],i.widgets[n]],h.setPages(h.pages))}getWidgetLabel(e){let i=e.props?.name||e.props?.title||e.props?.text||e.title;if(!i||i===""){const n=V.get(e.type);i=n?n.name:e.type}if(i===e.type||V.get(e.type)&&i===V.get(e.type).name){const n=e.id.split("_").pop();i=`${i} (${n})`}return i}getWidgetIcon(e){return`<i class="mdi ${{text:"mdi-format-text",sensor_text:"mdi-numeric",icon:"mdi-emoticon-outline",image:"mdi-image",qr_code:"mdi-qrcode",line:"mdi-vector-line",lvgl_line:"mdi-vector-line",rect:"mdi-square-outline",shape_rect:"mdi-square-outline",arc:"mdi-circle-outline",shape_circle:"mdi-circle-outline",bar:"mdi-chart-gantt",button:"mdi-gesture-tap-button",checkbox:"mdi-checkbox-marked-outline",calendar:"mdi-calendar",weather_forecast:"mdi-weather-partly-cloudy",datetime:"mdi-clock-outline",graph:"mdi-chart-timeline-variant",touch_area:"mdi-fingerprint",group:"mdi-folder-outline"}[e]||"mdi-widgets-outline"}"></i>`}}window.aiService=new Is;class ks{constructor(){try{_.log("[App] Constructor started"),this.sidebar=new Wi,_.log("[App] Sidebar created"),this.canvas=new ts,_.log("[App] Canvas created"),this.propertiesPanel=new as,_.log("[App] PropertiesPanel created"),this.hierarchyView=new Ls,_.log("[App] HierarchyView created"),this.deviceSettings=new fs,_.log("[App] DeviceSettings created"),this.editorSettings=new ys,_.log("[App] EditorSettings created"),this.pageSettings=new bs,_.log("[App] PageSettings created"),this.keyboardHandler=new di,_.log("[App] KeyboardHandler created"),this.llmPrompt=window.llmPrompt,_.log("[App] LLMPrompt linked"),this.quickSearch=new ws,window.QuickSearch=this.quickSearch,_.log("[App] QuickSearch initialized"),this.adapter=new hi,_.log("[App] ESPHomeAdapter initialized"),this.snippetManager=new Ss(this.adapter),_.log("[App] SnippetManager initialized"),window.layoutManager&&(this.layoutManager=window.layoutManager,_.log("[App] LayoutManager linked")),this.init()}catch(e){_.error("[App] Critical Error in Constructor:",e)}}async init(){_.log("[App] Initializing ESPHome Designer Designer..."),_.log("[App] AppState:",window.AppState),this.isInitializing=!0,await Cs("widgetPalette"),this.sidebar.init(),this.propertiesPanel.init(),this.hierarchyView.init(),this.deviceSettings.init(),this.editorSettings.init(),this.quickSearch.discoverWidgets(),await ct();try{localStorage.getItem("reterminal-editor-theme")==="light"?(h.updateSettings({editor_light_mode:!0}),this.editorSettings.applyEditorTheme(!0)):this.editorSettings.applyEditorTheme(!1)}catch(e){_.log("Could not load theme preference:",e)}this.pageSettings.init(),this.llmPrompt&&this.llmPrompt.init(),this.layoutManager&&this.layoutManager.init(),this.setupAutoSave(),this.bindGlobalButtons();try{q()?(_.log("HA Backend detected attempt. Loading layout from backend..."),await Li(),await ct(),await ge()):(_.log("Running in standalone/offline mode."),this.loadFromLocalStorage())}catch(e){_.error("[App] Failed to load from backend, falling back to local storage:",e),this.loadFromLocalStorage()}window.AppState&&typeof window.AppState.updateLayoutIndicator=="function"&&window.AppState.updateLayoutIndicator(),setTimeout(()=>{this.canvas&&(_.log("[App] Forcing initial canvas centering..."),this.canvas.focusPage(h.currentPageIndex,!1))},100),_.log("Initialization complete."),this.isInitializing=!1}bindGlobalButtons(){const e=document.getElementById("saveLayoutBtn");e&&e.addEventListener("click",()=>{q()?Se().then(()=>U("Layout saved to Home Assistant","success")).catch(r=>U(`Save failed: ${r.message}`,"error")):ls()});const i=document.getElementById("loadLayoutBtn");i&&i.addEventListener("change",cs);const n=document.getElementById("importProjectBtn");n&&i&&n.addEventListener("click",()=>{i.click()});const t=document.getElementById("deviceSettingsBtn");t?(_.log("Device Settings button found, binding click listener."),t.addEventListener("click",()=>{_.log("Device Settings button clicked."),this.deviceSettings?this.deviceSettings.open():_.error("DeviceSettings instance not found on App.")})):_.error("Device Settings button NOT found in DOM.");const o=document.getElementById("editorSettingsBtn");o&&o.addEventListener("click",()=>{this.editorSettings.open()});const s=document.getElementById("aiPromptBtn");s&&s.addEventListener("click",()=>{this.llmPrompt?this.llmPrompt.open():_.error("LLMPrompt instance not found.")})}loadFromLocalStorage(){try{const e=h.loadFromLocalStorage();e?(_.log("[App] Found saved layout in localStorage, loading..."),le(e)):_.log("[App] No saved layout in localStorage, starting fresh.")}catch(e){_.error("[App] Error loading from local storage:",e)}}setupAutoSave(){let e=null;const i=2e3;N(async()=>{const{on:n,EVENTS:t}=await Promise.resolve().then(()=>bi);return{on:n,EVENTS:t}},void 0,import.meta.url).then(({on:n,EVENTS:t})=>{n(t.STATE_CHANGED,()=>{if(this.isInitializing){_.log("[AutoSave] Skipping during initialization...");return}e&&clearTimeout(e),e=setTimeout(()=>{q()?(_.log("[AutoSave] Triggering background save to HA..."),Se().catch(()=>{})):(_.log("[AutoSave] Saving to local storage..."),h.saveToLocalStorage())},i)})})}}document.addEventListener("DOMContentLoaded",()=>{const d=new ks;window.app=d,window.openDeviceSettings=()=>d.deviceSettings?.open(),window.openEditorSettingsModal=e=>d.editorSettings?.open(e),window.pageSettings=d.pageSettings,window.ESPHomeDesigner=window.ESPHomeDesigner||{},window.ESPHomeDesigner.app=d,window.ESPHomeDesigner.ui={sidebar:d.sidebar,canvas:d.canvas,properties:d.propertiesPanel}});export{Ms as a,Ps as d,Ts as g};
