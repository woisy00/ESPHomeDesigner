import{T as X}from"./template_converter-Dp-G9w6d.js";const at=(e,_,{getColorStyle:l})=>{const s=_.props||{},y=_.entity_id||"",c=_.title||"",r=s.value_format||"label_value";let o=parseInt(s.precision,10);isNaN(o)&&(o=2);const t=s.unit||"",n=s.label_font_size||14,p=s.value_font_size||20,d=(s.font_family||"Roboto")+", sans-serif",h=String(s.font_weight||400),C=s.italic?"italic":"normal",A=s.color||"theme_auto",P=l(A),I=_.entity_id_2||"",E=s.separator||" ~ ";let g="--";const m=r.endsWith("_no_unit");let $=s.hide_unit||m?"":t;const N=u=>{if(window.AppState&&window.AppState.entityStates&&u){const f=window.AppState.entityStates[u];if(f&&f.state!==void 0){const v=f.formatted||String(f.state);f.state;const z=v.match(/^([-+]?\d*[.,]?\d+)(.*)$/);if(z){const F=parseFloat(z[1].replace(",",".")),O=z[2]?z[2].trim():"";if(u===y&&(t===void 0||t==="")&&!s.hide_unit&&!m&&($=O),!isNaN(F))return!isNaN(o)&&o>=0?F.toFixed(o):F.toString()}if(u===y&&(t===void 0||t==="")&&f.attributes&&f.attributes.unit_of_measurement&&!s.hide_unit&&!m&&($=f.attributes.unit_of_measurement),m||s.hide_unit){const F=v.match(/^([-+]?\d*[.,]?\d+)/);if(F){const O=parseFloat(F[1].replace(",","."));if(!isNaN(O))return!isNaN(o)&&o>=0?O.toFixed(o):O.toString()}return v.replace(/\s*[°%]?[A-Za-z/²³]+\s*$/,"").trim()||v}return v}}return"--"},B=N(y);let D=null;I&&(D=N(I)),g=B,D!==null&&(g=`${B}${E}${D}`),$&&g.endsWith($)&&($="");let b=c;if(!b&&(r.startsWith("label_")||r==="value_label")&&window.AppState&&window.AppState.entityStates&&y){const u=window.AppState.entityStates[y];u&&u.attributes&&u.attributes.friendly_name?b=u.attributes.friendly_name:y&&(b=y.split(".").pop().replace(/_/g," "))}const V=s.prefix||"",L=s.postfix||"",S=`${V}${g}${$?" "+$:""}${L}`.trim();e.innerHTML="",e.style.display="flex";const W=(u,f)=>{u&&(u.includes("LEFT")?f.style.textAlign="left":u.includes("RIGHT")?f.style.textAlign="right":f.style.textAlign="center")};((u,f)=>{u.includes("LEFT")?f.style.justifyContent="flex-start":u.includes("RIGHT")?f.style.justifyContent="flex-end":f.style.justifyContent="center",u.includes("TOP")?f.style.alignItems="flex-start":u.includes("BOTTOM")?f.style.alignItems="flex-end":f.style.alignItems="center"})(s.text_align||"TOP_LEFT",e);const a=document.createElement("div");if(a.style.color=P,a.style.fontFamily=d,a.style.fontWeight=h,a.style.fontStyle=C,a.style.wordWrap="break-word",a.style.overflowWrap="break-word",a.style.maxWidth="100%",(r==="label_value"||r==="label_value_no_unit")&&b){a.style.display="flex",a.style.alignItems="baseline",a.style.justifyContent="flex-start",a.style.gap="4px";const u=document.createElement("span");u.style.fontSize=`${n}px`,u.textContent=b+":";const f=document.createElement("span");f.style.fontSize=`${p}px`,f.textContent=S;const v=s.label_align||s.text_align||"TOP_LEFT";v.includes("CENTER")?a.style.justifyContent="center":v.includes("RIGHT")?a.style.justifyContent="flex-end":a.style.justifyContent="flex-start",a.appendChild(u),a.appendChild(f)}else if((r==="label_newline_value"||r==="label_newline_value_no_unit")&&b){a.style.display="flex",a.style.flexDirection="column",a.style.gap="2px",a.style.width="100%";const u=document.createElement("div");u.style.fontSize=`${n}px`,u.textContent=b,W(s.label_align||s.text_align||"TOP_LEFT",u);const f=document.createElement("div");f.style.fontSize=`${p}px`,f.textContent=S,W(s.value_align||s.text_align||"TOP_LEFT",f),a.appendChild(u),a.appendChild(f)}else if(r==="value_label"&&b){a.style.display="flex",a.style.alignItems="baseline",a.style.gap="4px";const u=document.createElement("span");u.style.fontSize=`${p}px`,u.textContent=S;const f=document.createElement("span");f.style.fontSize=`${n}px`,f.textContent=b,a.appendChild(u),a.appendChild(f)}else r==="label_only"?(a.style.fontSize=`${n}px`,a.textContent=b,W(s.text_align||"TOP_LEFT",a)):(a.style.fontSize=`${p}px`,a.textContent=S,W(s.value_align||s.text_align||"TOP_LEFT",a));e.appendChild(a)},ft={id:"sensor_text",name:"Sensor Text",category:"Sensors",supportedModes:["lvgl","direct","oepl","opendisplay"],defaults:{entity_id:"",title:"",value_format:"label_value",label_font_size:14,value_font_size:20,unit:"",precision:2,text_align:"TOP_LEFT",color:"theme_auto",font_family:"Roboto"},render:at,exportOpenDisplay:(e,{layout:_,page:l})=>{const s=e.props||{},y=(e.entity_id||"").trim(),c=s.value_format||"label_value",r=s.value_font_size||20;let o=s.color||"black";o==="theme_auto"&&(o=_?.darkMode?"white":"black");let t="";if(window.AppState&&window.AppState.entityStates&&y){const d=window.AppState.entityStates[y];t=d?d.formatted||String(d.state):"--"}else t="{{ state }}";let n=(e.title||s.title||"").trim();!n&&c.startsWith("label_")&&(n=y.split(".").pop().replace(/_/g," "));let p="";if(c==="label_only")p=n;else if(c==="label_value")p=`${n}: ${t}`;else{if(c==="label_newline_value"||c==="label_newline_value_no_unit")return{type:"multiline",value:`${n}
${t}`,delimiter:`
`,x:Math.round(e.x),offset_y:r+5,size:r,color:o,font:s.font_family?.includes("Mono")?"mononoki.ttf":"ppb.ttf"};p=t}return{type:"draw_text",x:Math.round(e.x),y:Math.round(e.y),text:p,size:r,color:o,font:s.font_family?.toLowerCase()||"roboto"}},exportOEPL:(e,{layout:_,page:l})=>{const s=e.props||{},y=(e.entity_id||"").trim(),c=(e.entity_id_2||"").trim(),r=s.value_format||"label_value",o=parseInt(s.precision,10)||0,t=s.separator||" ~ ",n=s.prefix||"",p=s.postfix||"",d=(s.unit||"").trim();let h=s.color||"black";h==="theme_auto"&&(h=_?.darkMode?"white":"black");const C=X.toHATemplate(y,{precision:o,isNumeric:!s.is_text_sensor}),A=c?X.toHATemplate(c,{precision:o,isNumeric:!s.is_text_sensor}):null,P=A?`${C}${t}${A}`:C,I=`${n}${P}${d?" "+d:""}${p}`.trim();let E=(e.title||s.title||"").trim();!E&&r.startsWith("label_")&&(E=y.split(".").pop().replace(/_/g," "));let g="";r==="label_only"?g=E:r==="label_value"||r==="label_value_no_unit"?g=`${E}: ${I}`:r==="label_newline_value"||r==="label_newline_value_no_unit"?g=`${E}
${I}`:r==="value_label"?g=`${I} ${E}`:g=I;const m=s.value_font_size||20,$=5,N={type:"text",value:g,x:Math.round(e.x),y:Math.round(e.y),size:m,font:s.font_family?.includes("Mono")?"mononoki.ttf":"ppb.ttf",color:h,align:(s.text_align||"TOP_LEFT").toLowerCase().replace("top_","").replace("bottom_","").replace("_",""),anchor:"lt"};return e.width&&e.width>0&&(N.max_width=Math.round(e.width),N.spacing=$),N},collectRequirements:(e,{addFont:_})=>{const l=e.props||{},s=l.font_family||"Roboto",y=l.font_weight||400,c=!!l.italic;_(s,y,l.label_font_size||14,c),_(s,y,l.value_font_size||20,c)},export:(e,_)=>{const{lines:l,getColorConst:s,addFont:y,getCondProps:c,getConditionCheck:r,Utils:o}=_,t=e.props||{};let n=(e.entity_id||"").trim(),p=(e.entity_id_2||"").trim();n&&!t.is_local_sensor&&!n.includes(".")&&!n.startsWith("text_sensor.")&&(n=`sensor.${n}`),p&&!t.is_local_sensor&&!p.includes(".")&&!p.startsWith("text_sensor.")&&(p=`sensor.${p}`);const d=t.value_format||"label_value";let h=(t.unit||"").trim();if(!h&&!t.hide_unit&&!d.endsWith("_no_unit")&&window.AppState&&window.AppState.entityStates){const i=window.AppState.entityStates[n];if(i){if(i.attributes&&i.attributes.unit_of_measurement)h=i.attributes.unit_of_measurement;else if(i.formatted){const x=i.formatted.match(/^([-+]?\d*[.,]?\d+)\s*(.*)$/);x&&x[2]&&(h=x[2].trim())}}}if(!h&&!t.hide_unit&&!d.endsWith("_no_unit")&&n){const i=n.toLowerCase();i.includes("_power")||i.includes("_watt")?h="W":i.includes("_energy")||i.includes("_kwh")?h="kWh":i.includes("_temperature")||i.includes("_temp")?h="°C":i.includes("_humidity")?h="%":i.includes("_voltage")||i.includes("_volt")?h="V":i.includes("_current")||i.includes("_amp")?h="A":i.includes("_battery")?h="%":i.includes("_pressure")||i.includes("_hpa")?h="hPa":i.includes("_speed")||i.includes("_kmh")?h="km/h":(i.includes("_percent")||i.includes("_pct"))&&(h="%")}const C=t.label_font_size||14,A=t.value_font_size||20,P=t.font_family||"Roboto",I=t.font_weight||400,E=!!t.italic,g=t.color||"theme_auto",m=s(g),$=t.text_align||"TOP_LEFT",N=t.separator||" ~ ",B=t.prefix||"",D=t.postfix||"";let b=parseInt(t.precision,10);(isNaN(b)||b<0)&&(b=2);const V=i=>(i||"").replace(/%/g,"%%");if(l.push(`        // widget:sensor_text id:${e.id} type:sensor_text x:${e.x} y:${e.y} w:${e.width} h:${e.height} entity:"${n}" format:"${d}" ${c(e)}`),!n&&!t.is_local_sensor){l.push("        // Sensor ID missing for this widget");return}const L=y(P,I,C,E),S=y(P,I,A,E),W=r(e);W&&l.push(`        ${W}`);const G=i=>{if(!i||!window.AppState?.entityStates)return!1;const x=window.AppState.entityStates[i];if(!x||x.state===void 0)return!1;const k=String(x.state);return isNaN(parseFloat(k))||!isFinite(parseFloat(k))},a=(i,x="")=>{let k=i.replace(/[^a-zA-Z0-9_]/g,"_");const Q=63-x.length;return k.length>Q&&(k=k.substring(0,Q)),k+x},u=!t.is_local_sensor&&G(n),f=!t.is_local_sensor&&p&&G(p),v=t.is_text_sensor||u||n&&(n.startsWith("text_sensor.")||n.startsWith("weather.")),z=p&&(t.is_text_sensor||f||p.startsWith("text_sensor.")||p.startsWith("weather.")),F=(i,x)=>t.is_local_sensor?`id(${i||"battery_level"})`:x?`id(${a(i,"_txt")})`:`id(${a(i)})`,O=F(n,v),H=p?F(p,z):null,Y=v?"%s":`%.${b}f`,tt=z?"%s":`%.${b}f`;let M=(e.title||t.title||"").trim();!M&&d.startsWith("label_")&&(M=n.split(".").pop().replace(/_/g," "));const J=t.hide_unit||d.endsWith("_no_unit")?"":V(h),et=V(B),st=V(D),nt=V(N),Z=i=>i?i==="CENTER"?"TextAlign::CENTER":`TextAlign::${i}`:"TextAlign::TOP_LEFT",q=Z(t.label_align||$),U=Z(t.value_align||$);let T=e.x,w=e.y;const it=$.includes("CENTER"),lt=$.includes("RIGHT");it?T=Math.round(e.x+e.width/2):lt&&(T=Math.round(e.x+e.width)),$.includes("BOTTOM")?w=Math.round(e.y+e.height):$.includes("TOP")||(w=Math.round(e.y+e.height/2));const j=`${et}${Y}${H?nt+tt:""}${J?" "+J:""}${st}`,K=v?`${O}.state.c_str()`:`${O}.state`,ot=H?z?`${H}.state.c_str()`:`${H}.state`:null,R=H?`${K}, ${ot}`:K;if(d==="label_only")l.push(`        it.printf(${T}, ${w}, id(${L}), ${m}, ${q}, "${M}");`);else if(d==="value_only"||d==="value_only_no_unit"||!M)if(e.width&&e.width>50){const x=A+4;l.push("        {"),l.push("          char wrap_buf[256];"),l.push(`          sprintf(wrap_buf, "${j}", ${R});`),l.push(`          print_wrapped_text(${T}, ${w}, ${e.width}, ${x}, id(${S}), ${m}, ${U}, wrap_buf);`),l.push("        }")}else l.push(`        it.printf(${T}, ${w}, id(${S}), ${m}, ${U}, "${j}", ${R});`);else if(d==="label_value"||d==="label_value_no_unit"){const i=`${M}${M.endsWith(":")?"":":"} `;if(C!==A&&$.includes("LEFT")){const x=Z($);l.push("        {"),l.push("          int w1, h1, xoff1, bl1;"),l.push("          int w2, h2, xoff2, bl2;"),l.push("          char value_buf[64];"),l.push(`          sprintf(value_buf, "${j}", ${R});`),l.push(`          id(${L})->measure("${i}", &w1, &xoff1, &bl1, &h1);`),l.push(`          id(${S})->measure(value_buf, &w2, &xoff2, &bl2, &h2);`),l.push("          // Align baselines: yVal + bl1 = yVal2 + bl2 => yVal2 = yVal + bl1 - bl2"),l.push(`          it.printf(${T}, ${w}, id(${L}), ${m}, ${x}, "${i}");`),l.push(`          it.printf(${T} + w1, ${w} + (bl1 - bl2), id(${S}), ${m}, ${x}, "%s", value_buf);`),l.push("        }")}else l.push(`        it.printf(${T}, ${w}, id(${S}), ${m}, ${U}, "${i}${j}", ${R});`)}else if(d==="label_newline_value"||d==="label_newline_value_no_unit")l.push(`        it.printf(${T}, ${w}, id(${L}), ${m}, ${q}, "${M}");`),l.push(`        it.printf(${T}, ${w} + ${C+4}, id(${S}), ${m}, ${U}, "${j}", ${R});`);else if(d==="value_label"){l.push(`        it.printf(${T}, ${w}, id(${S}), ${m}, ${U}, "${j}", ${R});`);const i=Math.round(A*.6*6)+10;l.push(`        it.printf(${T} + ${i}, ${w}, id(${L}), ${m}, ${q}, "${M}");`)}W&&l.push("        }")},onExportTextSensors:e=>{const{lines:_,widgets:l}=e;if(!l)return;const s=o=>{if(!o||!window.AppState?.entityStates)return!1;const t=window.AppState.entityStates[o];if(!t||t.state===void 0)return!1;const n=String(t.state);return isNaN(parseFloat(n))||!isFinite(parseFloat(n))},y=(o,t="")=>{let n=o.replace(/[^a-zA-Z0-9_]/g,"_");const p=63-t.length;return n.length>p&&(n=n.substring(0,p)),n+t},c=new Set,r=new Set;for(const o of l){if(o.type!=="sensor_text")continue;const t=o.props||{},n=(o.entity_id||"").trim(),p=!t.is_local_sensor&&s(n);n.startsWith("weather.")?c.add(n):(t.is_text_sensor||p||n.startsWith("text_sensor."))&&r.add(n);const d=(o.entity_id_2||t.entity_id_2||"").trim();if(d){const h=!t.is_local_sensor&&s(d);d.startsWith("weather.")?c.add(d):(t.is_text_sensor||h||d.startsWith("text_sensor."))&&r.add(d)}}if(c.size>0){let o=!1;for(let t of c){t&&!t.includes(".")&&(t=`weather.${t}`);const n=y(t,"_txt");e.seenSensorIds&&e.seenSensorIds.has(n)||e.seenTextEntityIds&&e.seenTextEntityIds.has(t)||(o||(_.push("# Weather Entity Sensors (Detected from Sensor Text)"),o=!0),e.seenSensorIds&&e.seenSensorIds.add(n),e.seenTextEntityIds&&e.seenTextEntityIds.add(t),_.push("- platform: homeassistant"),_.push(`  id: ${n}`),_.push(`  entity_id: ${t}`),_.push("  internal: true"))}}if(r.size>0){let o=!1;for(let t of r){const n=y(t,"_txt");e.seenSensorIds&&e.seenSensorIds.has(n)||e.seenTextEntityIds&&e.seenTextEntityIds.has(t)||(o||(_.push("# Text Sensors (Detected from Sensor Text)"),o=!0),e.seenSensorIds&&e.seenSensorIds.add(n),e.seenTextEntityIds&&e.seenTextEntityIds.add(t),_.push("- platform: homeassistant"),_.push(`  id: ${n}`),_.push(`  entity_id: ${t}`),_.push("  internal: true"))}}},onExportNumericSensors:e=>{const{widgets:_,isLvgl:l,pendingTriggers:s}=e;if(!_)return;const y=c=>{if(!c||!window.AppState?.entityStates)return!1;const r=window.AppState.entityStates[c];if(!r||r.state===void 0)return!1;const o=String(r.state);return isNaN(parseFloat(o))||!isFinite(parseFloat(o))};for(const c of _){if(c.type!=="sensor_text")continue;const r=c.props||{};if(r.is_local_sensor)continue;const o=[c.entity_id,c.entity_id_2].filter(t=>t&&t.trim());for(let t of o)t=t.trim(),!(r.is_text_sensor||t.startsWith("weather.")||t.startsWith("text_sensor."))&&(y(t)||(t.includes(".")||(t=`sensor.${t}`),l&&s&&(s.has(t)||s.set(t,new Set),s.get(t).add(`- lvgl.widget.refresh: ${c.id}`))))}}};export{ft as default};
