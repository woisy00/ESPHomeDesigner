const A=(s,t,e)=>{const o=t.props||{},{getColorStyle:_}=e,u=o.show_author!==!1,h=parseInt(o.quote_font_size||18,10),r=parseInt(o.author_font_size||14,10),n=o.font_family||"Roboto",l=parseInt(o.font_weight||400,10),c=o.color||"theme_auto",f=_(c);s.style.color=f;const y=o.text_align||"TOP_LEFT",q=o.italic_quote!==!1,g=[{quote:"The only way to do great work is to love what you do.",author:"Steve Jobs"},{quote:"In the middle of difficulty lies opportunity.",author:"Albert Einstein"},{quote:"Life is what happens when you're busy making other plans.",author:"John Lennon"},{quote:"The future belongs to those who believe in the beauty of their dreams.",author:"Eleanor Roosevelt"},{quote:"Success is not final, failure is not fatal: it is the courage to continue that counts.",author:"Winston Churchill"},{quote:"Be yourself; everyone else is already taken.",author:"Oscar Wilde"},{quote:"Two things are infinite: the universe and human stupidity.",author:"Albert Einstein"},{quote:"Be the change that you wish to see in the world.",author:"Mahatma Gandhi"}],w=o.feed_url||"https://www.brainyquote.com/link/quotebr.rss",S=(w+(t.id||"default")).split("").reduce((a,z)=>(a<<5)-a+z.charCodeAt(0),0),x=g[Math.abs(S)%g.length],m=window.location.protocol==="file:"||typeof window.hasHaBackend!="function"||!window.hasHaBackend();window.quoteCache=window.quoteCache||{},window.quoteFetchTimers=window.quoteFetchTimers||{};const b=t.id+"|"+w,C=b+"_fetching",v=t.id+"_lastUrl";if(window.quoteCache[v]!==w&&(window.quoteCache[v]=w,window.quoteFetchTimers[t.id]&&(clearTimeout(window.quoteFetchTimers[t.id]),window.quoteFetchTimers[t.id]=null)),!window.quoteCache[b]&&!window.quoteCache[C]){window.quoteCache[C]=!0;const a=w,z=b,k=C;window.quoteFetchTimers[t.id]=setTimeout(async()=>{try{let $;m?$=null:$=await(await fetch(`/api/esphome_designer/rss_proxy?url=${encodeURIComponent(a)}`)).json(),$&&$.success&&$.quote&&(window.quoteCache[z]=$.quote,window.emit&&window.EVENTS&&window.emit(window.EVENTS.STATE_CHANGED))}catch{}finally{window.quoteCache[k]=!1,window.quoteFetchTimers[t.id]=null}},500)}const T=window.quoteCache[b]||x,E=!!window.quoteCache[b];s.style.display="flex",s.style.flexDirection="column",s.style.boxSizing="border-box",s.style.padding="8px",s.style.overflow="hidden",s.style.fontFamily=n+", serif",s.style.fontWeight=String(l),s.style.color=f,s.style.lineHeight="1.3",y.includes("CENTER")?(s.style.textAlign="center",s.style.alignItems="center"):y.includes("RIGHT")?(s.style.textAlign="right",s.style.alignItems="flex-end"):(s.style.textAlign="left",s.style.alignItems="flex-start"),y.startsWith("CENTER")?s.style.justifyContent="center":y.startsWith("BOTTOM")?s.style.justifyContent="flex-end":s.style.justifyContent="flex-start",s.innerHTML="";const I=o.word_wrap!==!1,i=document.createElement("div");if(i.style.fontSize=h+"px",i.style.fontStyle=q?"italic":"normal",i.style.marginBottom="8px",I?(i.style.wordWrap="break-word",i.style.overflowWrap="break-word",i.style.whiteSpace="normal"):(i.style.whiteSpace="nowrap",i.style.overflow="hidden",i.style.textOverflow="ellipsis"),i.textContent='"'+T.quote+'"',s.appendChild(i),u){const a=document.createElement("div");a.style.fontSize=r+"px",a.style.fontStyle="normal",a.style.opacity="0.8",a.textContent="â€” "+T.author,s.appendChild(a)}const d=document.createElement("div");d.style.fontSize="9px",d.style.opacity="0.5",d.style.marginTop="auto",d.style.paddingTop="4px";try{const a=new URL(w);m?d.textContent="ðŸ”Œ OFFLINE - "+a.hostname:E?d.textContent="ðŸŸ¢ "+a.hostname:d.textContent="âšª "+a.hostname}catch{d.textContent=m?"ðŸ”Œ OFFLINE":"ðŸ“° RSS Feed"}s.appendChild(d)},L=(s,{common:t,convertColor:e,getLVGLFont:o})=>{const u=((f,y="")=>{let q=f.replace(/[^a-zA-Z0-9_]/g,"_");const g=63-y.length;return q.length>g&&(q=q.substring(0,g)),q+y})(`quote_${s.id}`,""),h=parseInt(p.quote_font_size||18,10),r=p.font_family||"Roboto",n=parseInt(p.font_weight||400,10),l=e(p.color||"black"),c=`!lambda |-
      std::string q = id(${u}_text_global);
      std::string a = id(${u}_author_global);
      if (q.empty()) return "Loading quote...";
      if (a.empty()) return ("\\"" + q + "\\"").c_str();
      return ("\\"" + q + "\\"\\nâ€” " + a).c_str();
    `;return{label:{...t,text:c,text_font:o(r,h,n,p.italic_quote!==!1),text_color:l,text_align:"center"}}},R=(s,t)=>{const{lines:e,addFont:o,getColorConst:_,getCondProps:u,getConditionCheck:h,getAlignX:r}=t,n=s.props||{},l=parseInt(n.quote_font_size||18,10),c=parseInt(n.author_font_size||14,10),f=n.font_family||"Roboto",y=parseInt(n.font_weight||400,10),q=n.color||"theme_auto",g=_(q),w=n.text_align||"TOP_LEFT",F=n.italic_quote!==!1,S=n.word_wrap!==!1,m=((I,i="")=>{let d=I.replace(/[^a-zA-Z0-9_]/g,"_");const a=63-i.length;return d.length>a&&(d=d.substring(0,a)),d+i})(`quote_${s.id}`,""),b=`${m}_text_global`,C=`${m}_author_global`,v=o(f,y,l,F),T=o(f,y,c,!1);e.push(`        // widget:quote_rss id:${s.id} type:quote_rss x:${s.x} y:${s.y} w:${s.width} h:${s.height} color:${q} align:${w} ${u(s)}`);const E=h(s);if(E&&e.push(`        ${E}`),e.push("        {"),e.push(`          std::string q_text = id(${b});`),n.show_author!==!1&&e.push(`          std::string q_author = id(${C});`),S)e.push(`          int max_w = ${s.width-16};`),e.push(`          int q_h = ${l+4};`),e.push('          std::string display_text = "\\"" + q_text + "\\"";'),e.push("          auto print_q = [&](esphome::font::Font *f, int line_h, bool draw) -> int {"),e.push(`            int y_curr = ${s.y+8};`),e.push("            std::string text_to_print = display_text;"),e.push('            std::string curr_line = "";'),e.push("            std::string word;"),e.push("            size_t pos = 0;"),e.push("            while (pos < text_to_print.length()) {"),e.push("                size_t space_pos = text_to_print.find(' ', pos);"),e.push("                if (space_pos == std::string::npos) {"),e.push("                    word = text_to_print.substr(pos);"),e.push("                    pos = text_to_print.length();"),e.push("                } else {"),e.push("                    word = text_to_print.substr(pos, space_pos - pos);"),e.push("                    pos = space_pos + 1;"),e.push("                }"),e.push("                if (word.empty()) continue;"),e.push('                std::string test_line = curr_line.empty() ? word : curr_line + " " + word;'),e.push("                int w_m, h_m, xoff_m, bl_m;"),e.push("                f->measure(test_line.c_str(), &w_m, &xoff_m, &bl_m, &h_m);"),e.push("                if (w_m > max_w && !curr_line.empty()) {"),e.push(`                    if (draw) it.printf(${s.x+8}, y_curr, f, ${g}, "%s", curr_line.c_str());`),e.push("                    y_curr += line_h;"),e.push("                    curr_line = word;"),e.push("                } else { curr_line = test_line; }"),e.push("            }"),e.push("            if (!curr_line.empty()) {"),e.push(`                if (draw) it.printf(${s.x+8}, y_curr, f, ${g}, "%s", curr_line.c_str());`),e.push("                y_curr += line_h;"),e.push("            }"),e.push(`            return y_curr - ${s.y+8};`),e.push("          };"),e.push(`          print_q(id(${v}), q_h, true);`),n.show_author!==!1&&e.push(`          if (!q_author.empty()) it.printf(${s.x+8}, ${s.y} + ${s.height} - ${c+4}, id(${T}), ${g}, "â€” %s", q_author.c_str());`);else{const I=r(w,s.x,s.width),i=`TextAlign::${w}`;e.push(`          it.printf(${I}, ${s.y}, id(${v}), ${g}, ${i}, "\\"%s\\"", q_text.c_str());`),n.show_author!==!1&&e.push(`          if (!q_author.empty()) it.printf(${I}, ${s.y+l+4}, id(${T}), ${g}, ${i}, "â€” %s", q_author.c_str());`)}e.push("        }"),E&&e.push("        }")},O=s=>{const{lines:t,widgets:e}=s;e.filter(o=>o.type==="quote_rss").forEach(o=>{const u=((h,r="")=>{let n=h.replace(/[^a-zA-Z0-9_]/g,"_");const l=63-r.length;return n.length>l&&(n=n.substring(0,l)),n+r})(`quote_${o.id}`,"");t.push(`- id: ${u}_text_global`),t.push("  type: std::string"),t.push("  restore_value: true"),t.push(`  initial_value: '""'`),o.props&&o.props.show_author!==!1&&(t.push(`- id: ${u}_author_global`),t.push("  type: std::string"),t.push("  restore_value: true"),t.push(`  initial_value: '""'`))})},W=s=>{const{lines:t,widgets:e,displayId:o}=s,_=e.filter(u=>u.type==="quote_rss");if(_.length>0){t.some(h=>h.trim().startsWith("http_request:"))||(t.push(""),t.push("http_request:"),t.push("  verify_ssl: false"),t.push("  timeout: 20s"),t.push("  buffer_size_rx: 4096")),t.push(""),t.push("# Quote RSS Widget Update Loop"),t.push("interval:");for(const h of _){const r=h.props||{},n=r.refresh_interval||"1h",c=((F,S="")=>{let x=F.replace(/[^a-zA-Z0-9_]/g,"_");const m=63-S.length;return x.length>m&&(x=x.substring(0,m)),x+S})(`quote_${h.id}`,""),f=r.feed_url||"https://www.brainyquote.com/link/quotebr.rss",y=r.random!==!1,w=`${(r.ha_url||"http://homeassistant.local:8123").replace(/\/$/,"")}/api/esphome_designer/rss_proxy?url=${encodeURIComponent(f)}${y?"&random=true":""}`;t.push(`  - interval: ${n}`),t.push("    startup_delay: 20s"),t.push("    then:"),t.push("      - if:"),t.push("          condition:"),t.push("            wifi.connected:"),t.push("          then:"),t.push("            - http_request.get:"),t.push(`                url: "${w}"`),t.push("                capture_response: true"),t.push("                on_response:"),t.push("                  - lambda: |-"),t.push("                      if (response->status_code == 200) {"),t.push('                        ESP_LOGD("quote", "Raw body: %s", body.c_str());'),t.push("                        JsonDocument doc;"),t.push("                        DeserializationError error = deserializeJson(doc, body);"),t.push("                        if (error) {"),t.push('                          ESP_LOGW("quote", "Failed to parse JSON: %s", error.c_str());'),t.push("                          return;"),t.push("                        }"),t.push('                        if (doc["success"].as<bool>()) {'),t.push('                          JsonVariant q_var = doc["quote"];'),t.push("                          if (q_var.is<JsonObject>()) {"),t.push("                            JsonObject q = q_var.as<JsonObject>();"),t.push('                            std::string q_str = q["quote"] | "";'),t.push("                            if (!q_str.empty()) {"),t.push(`                              id(${c}_text_global) = q_str;`),r.show_author!==!1&&t.push(`                              id(${c}_author_global) = q["author"] | "Unknown";`),t.push('                              ESP_LOGI("quote", "Fetched quote: %s", q_str.c_str());'),t.push("                            }"),t.push("                          }"),t.push("                        }"),t.push("                      }"),t.push("                  - if:"),t.push("                      condition:"),t.push("                        lambda: 'return response->status_code == 200;'"),t.push("                      then:"),s.isLvgl?t.push(`                        - lvgl.widget.refresh: ${h.id}`):t.push(`                        - component.update: ${o}`),t.push("                      else:"),t.push(`                        - lambda: 'ESP_LOGW("quote", "HTTP Request failed with code: %d", response->status_code);'`)}t.push("")}},P=s=>{const{lines:t,widgets:e}=s,o=e.filter(_=>_.type==="quote_rss");if(o.length>0){t.push("# Quote RSS Widget Text Sensors (visible in Home Assistant)");for(const _ of o){const u=_.props||{},r=((n,l="")=>{let c=n.replace(/[^a-zA-Z0-9_]/g,"_");const f=63-l.length;return c.length>f&&(c=c.substring(0,f)),c+l})(`quote_${_.id}`,"");t.push("- platform: template"),t.push(`  id: ${r}_txt`),t.push('  name: "Quote Text"'),t.push('  icon: "mdi:format-quote-close"'),t.push(`  lambda: 'return id(${r}_text_global);'`),t.push("  update_interval: 60s"),u.show_author!==!1&&(t.push("- platform: template"),t.push(`  id: ${r}_author_sensor`),t.push('  name: "Quote Author"'),t.push('  icon: "mdi:account"'),t.push(`  lambda: 'return id(${r}_author_global);'`),t.push("  update_interval: 60s"))}}},B={id:"quote_rss",name:"Quote RSS",category:"Events",supportedModes:["lvgl","direct"],defaults:{feed_url:"https://www.brainyquote.com/link/quotebr.rss",quote_font_size:18,author_font_size:14,font_family:"Roboto",font_weight:400,color:"theme_auto",text_align:"TOP_LEFT",show_author:!0,italic_quote:!0,word_wrap:!0,width:400,height:120,refresh_interval:"1h",ha_url:"http://homeassistant.local:8123",random:!0},render:A,onExportGlobals:O,onExportTextSensors:P,onExportComponents:W,exportLVGL:L,export:R};export{B as default};
