const P=(e,s,t)=>{const l=s.width||400,i=s.height||300;e.style.width=l+"px",e.style.height=i+"px",e.style.position="relative",e.style.backgroundColor=t.background_color||"white",e.style.color=t.text_color||"black",e.style.padding="4px",e.style.boxSizing="border-box",t.show_border!==!1&&(e.style.border=`${t.border_width||2}px solid ${t.border_color||"black"}`);const r=new Date,c=r.getDate(),p=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],g=["January","February","March","April","May","June","July","August","September","October","November","December"],a=p[r.getDay()],b=`${g[r.getMonth()]} ${r.getFullYear()}`,h=document.createElement("div");h.style.textAlign="center",h.style.padding="2px",h.style.borderBottom="1px solid "+(t.text_color||"black"),h.style.flexShrink="0";const y=document.createElement("div");y.style.fontSize=Math.min((t.font_size_date||100)*.7,80)+"px",y.style.fontWeight="100",y.style.lineHeight="0.8",y.innerText=c,h.appendChild(y);const f=document.createElement("div");f.style.fontSize=(t.font_size_day||24)+"px",f.style.fontWeight="bold",f.style.marginTop="4px",f.innerText=a,h.appendChild(f);const d=document.createElement("div");d.style.fontSize=(t.font_size_grid||14)+"px",d.innerText=b,h.appendChild(d),e.style.display="flex",e.style.flexDirection="column",e.appendChild(h);const _=document.createElement("div");_.style.display="grid",_.style.gridTemplateColumns="repeat(7, 1fr)",_.style.padding="2px",_.style.gap="1px",_.style.flexShrink="0";const D=(t.font_size_grid||14)+"px";["Mo","Tu","We","Th","Fr","Sa","Su"].forEach(o=>{const n=document.createElement("div");n.innerText=o,n.style.textAlign="center",n.style.fontWeight="bold",n.style.fontSize=D,_.appendChild(n)});const A=new Date(r.getFullYear(),r.getMonth(),1),T=new Date(r.getFullYear(),r.getMonth()+1,0).getDate();let x=A.getDay();x===0&&(x=7),x-=1;for(let o=0;o<x;o++)_.appendChild(document.createElement("div"));for(let o=1;o<=T;o++){const n=document.createElement("div");n.innerText=o,n.style.textAlign="center",n.style.fontSize=D,o===c&&(n.style.backgroundColor=t.text_color||"black",n.style.color=t.background_color||"white",n.style.borderRadius="50%",n.style.width="1.5em",n.style.height="1.5em",n.style.lineHeight="1.5em",n.style.margin="0 auto"),_.appendChild(n)}e.appendChild(_);const u=document.createElement("div");u.style.padding="5px",u.style.fontSize=(t.font_size_event||18)+"px",u.style.flexGrow="1",u.style.overflow="hidden";let w=null;const S=(s.entity_id||t.entity_id||"sensor.esp_calendar_data").trim();if(window.AppState&&window.AppState.entityStates){const o=window.AppState.entityStates[S];if(o&&o.state&&o.state!=="unknown"&&o.state.length>5)try{const n=JSON.parse(o.state);w=n.days||n}catch(n){console.warn("[Calendar Widget] Failed to parse live state:",n)}}if(w&&Array.isArray(w)&&w.length>0){u.innerHTML="";const o=t.event_limit||4;let n=0;for(const m of w){if(n>=o)break;const $=m.day,v=(E,I)=>{if(n>=o)return;const N=E.summary||"No Title",M=E.start||"";let k=I?"All Day":"";!I&&M.includes("T")&&(k=M.split("T")[1].substring(0,5));const z=document.createElement("div");z.style.marginBottom="4px",z.style.display="flex",z.style.justifyContent="space-between",z.innerHTML=`<span style="flex-shrink:0;width:25px;"><b>${$}</b></span><span style="flex-grow:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-right:8px;">${N}</span><span style="flex-shrink:0;opacity:0.7;font-size:0.9em;">${k}</span>`,u.appendChild(z),n++};m.all_day&&m.all_day.forEach(E=>v(E,!0)),m.other&&m.other.forEach(E=>v(E,!1))}}else u.innerHTML=`
            <div style="margin-bottom:4px;"><b>${c}</b> Meeting with Team</div>
            <div><b>${Math.min(c+2,T)}</b> Dentist Appointment</div>
        `;e.appendChild(u)},O={id:"calendar",name:"Calendar",category:"Events",defaults:{entity_id:"sensor.esp_calendar_data",border_width:2,show_border:!0,border_color:"black",background_color:"white",text_color:"black",font_size_date:100,font_size_day:24,font_size_grid:14,font_size_event:18,width:335,height:340},render:(e,s)=>{const t=s.props||{};e.innerHTML="",P(e,s,t)},onExportTextSensors:e=>{const{lines:s,widgets:t}=e;if(!t)return;const l=t.filter(i=>i.type==="calendar");if(l.length!==0){for(const i of l){const r=i.props||{},c=(i.entity_id||r.entity_id||"sensor.esp_calendar_data").trim(),p=`calendar_data_${i.id}`;e.seenEntityIds&&e.seenEntityIds.has(c)||e.seenSensorIds&&e.seenSensorIds.has(p)||(e.seenEntityIds&&e.seenEntityIds.add(c),e.seenSensorIds&&e.seenSensorIds.add(p),s.push("- platform: homeassistant"),s.push(`  id: ${p}`),s.push(`  entity_id: ${c}`),s.push("  attribute: entries"),s.push("  internal: true"))}s.push(""),s.push("# ============================================================================"),s.push("# CALENDAR EVENTS SETUP (HOME ASSISTANT)"),s.push("# 1. Download the 'Helper Script' from the Calendar widget's properties panel."),s.push("# 2. Place it in your /config/python_scripts/ folder."),s.push("# 3. Add this automation to your automations.yaml to update the sensor:"),s.push("#"),s.push("# automation:"),s.push("#   - alias: Update ESP Calendar Data"),s.push("#     trigger:"),s.push("#       - platform: time_pattern"),s.push("#         minutes: '/15'"),s.push("#     action:"),s.push("#       - service: python_script.esp_calendar_data_conversion"),s.push("#         data:"),s.push("#           calendar:"),s.push("#             calendar.your_calendar: {}  # Add your calendars here"),s.push('#           now: "{{ now().isoformat() }}"'),s.push("#         response_variable: output"),s.push("#       - service: input_text.set_value"),s.push("#         target:"),s.push("#           entity_id: input_text.esp_calendar_data_json"),s.push("#         data:"),s.push('#           value: "{{ output.entries | to_json }}"'),s.push("# ============================================================================")}},exportLVGL:(e,{common:s,convertColor:t,getLVGLFont:l})=>{const i=e.props||{},r=t(i.text_color||"black"),c=t(i.background_color||"white"),p=Math.round(Math.min((i.font_size_date||100)*.7,80)),g=parseInt(i.font_size_day||24,10),a=parseInt(i.font_size_grid||14,10),b=i.font_family||"Roboto",h=p+g+a+15,y=[{label:{align:"TOP_MID",y:2,height:p+4,text:`!lambda "char buf[4]; id(ha_time).now().strftime(buf, sizeof(buf), '%d'); return buf;"`,text_font:l(b,p,100),text_color:r}},{label:{align:"TOP_MID",y:p+6,height:g+4,text:`!lambda "char buf[16]; id(ha_time).now().strftime(buf, sizeof(buf), '%A'); return buf;"`,text_font:l(b,g,700),text_color:r}},{label:{align:"TOP_MID",y:p+g+10,height:a+4,text:`!lambda "char buf[32]; id(ha_time).now().strftime(buf, sizeof(buf), '%B %Y'); return buf;"`,text_font:l(b,a,400),text_color:r}},{obj:{width:"100%",height:1,y:h,bg_color:r,border_width:0}}];return y.push({obj:{width:"100%",height:"SIZE_CONTENT",y:h+5,bg_opa:"transp",border_width:0,layout:{type:"flex",flex_flow:"row_wrap",flex_align_main:"space_around"},widgets:["Mo","Tu","We","Th","Fr","Sa","Su"].map(f=>({label:{text:`"${f}"`,text_font:l(b,a,700),text_color:r,width:"14%",align:"center"}}))}}),y.push({label:{y:h+40,align:"TOP_MID",text:'"Calendar Grid Not Supported in LVGL Mode"',text_font:l("Roboto",12,400),text_color:"0x888888"}}),{obj:{...s,bg_color:c,bg_opa:"COVER",radius:8,border_width:i.show_border!==!1?i.border_width||2:0,border_color:t(i.border_color||"black"),widgets:y}}},export:(e,s)=>{const{lines:t,addFont:l,getColorConst:i,addDitherMask:r,getCondProps:c,getConditionCheck:p,isEpaper:g}=s,a=e.props||{},b=(e.entity_id||a.entity_id||"sensor.esp_calendar_data").trim(),h=a.border_color||"black",y=a.text_color||"black",f=a.background_color||"white",d=i(y),_=i(h),D=i(f),A=a.show_border!==!1,C=parseInt(a.border_width||2,10),T=Math.round(Math.min(parseInt(a.font_size_date||100,10)*.7,80)),x=parseInt(a.font_size_day||24,10),u=parseInt(a.font_size_grid||14,10),w=parseInt(a.font_size_event||18,10),S=a.font_family||"Roboto",o=l(S,100,T),n=l(S,700,x),m=l(S,400,u),$=l(S,400,w);t.push(`        // widget:calendar id:${e.id} type:calendar x:${e.x} y:${e.y} w:${e.width} h:${e.height} entity:${b} ${c(e)}`);const v=p(e);v&&t.push(`        ${v}`),t.push("        {"),t.push("          auto now = id(ha_time).now();"),t.push(`          int x = ${e.x}; int y = ${e.y}; int w = ${e.width}; int h = ${e.height};`),f!=="transparent"&&t.push(`          it.filled_rectangle(x, y, w, h, ${D});`),t.push("          // Header"),t.push(`          int headH = ${T+x+u+15};`),t.push(`          it.strftime(x + w/2, y + 2, id(${o}), ${d}, TextAlign::TOP_CENTER, "%d", now);`),t.push(`          it.strftime(x + w/2, y + ${T+6}, id(${n}), ${d}, TextAlign::TOP_CENTER, "%A", now);`),t.push(`          it.strftime(x + w/2, y + ${T+x+10}, id(${m}), ${d}, TextAlign::TOP_CENTER, "%B %Y", now);`),t.push(`          it.line(x, y + headH, x + w, y + headH, ${d});`),t.push("          // Days Grid"),t.push("          int gridY = y + headH + 5;"),t.push("          int cellW = w / 7;"),t.push('          const char* days[] = {"Mo", "Tu", "We", "Th", "Fr", "Sa", "Su"};'),t.push("          for(int i=0; i<7; i++) {"),t.push(`            it.print(x + i*cellW + cellW/2, gridY, id(${m}), ${d}, TextAlign::TOP_CENTER, days[i]);`),t.push("          }"),t.push("          // Simple logic to find start of month"),t.push("          time_t t = now.timestamp;"),t.push("          struct tm *tm = localtime(&t);"),t.push("          tm->tm_mday = 1;"),t.push("          mktime(tm);"),t.push("          int startDay = (tm->tm_wday + 6) % 7; // 0=Mon"),t.push("          int daysInMonth = 31; // Simplified"),t.push("          if(now.month == 2) daysInMonth = (now.year % 4 == 0) ? 29 : 28;"),t.push("          else if(now.month == 4 || now.month == 6 || now.month == 9 || now.month == 11) daysInMonth = 30;"),t.push("          int r = 1; int c = startDay;"),t.push(`          int rowH = ${u+4};`),t.push("          for(int d=1; d<=daysInMonth; d++) {"),t.push("            if(d == now.day_of_month) {"),t.push(`               it.filled_circle(x + c*cellW + cellW/2, gridY + r*rowH + 6, ${Math.floor(u/1.5)}, ${d});`),t.push(`               it.printf(x + c*cellW + cellW/2, gridY + r*rowH, id(${m}), ${D}, TextAlign::TOP_CENTER, "%d", d);`),t.push("            } else {"),t.push(`               it.printf(x + c*cellW + cellW/2, gridY + r*rowH, id(${m}), ${d}, TextAlign::TOP_CENTER, "%d", d);`),t.push("            }"),t.push("            c++; if(c>6) { c=0; r++; }"),t.push("          }"),t.push("          // Events (Real Data from Sensor)"),t.push("          auto extract_time = [](const char* datetime) -> std::string {"),t.push("              std::string datetimeStr(datetime);"),t.push("              size_t pos = datetimeStr.find('T');"),t.push("              if (pos != std::string::npos && pos + 3 < datetimeStr.size()) {"),t.push("                  return datetimeStr.substr(pos + 1, 5);"),t.push("              }"),t.push('              return "";'),t.push("          };"),t.push(""),t.push("          int eventY = gridY + (r+1)*rowH + 10;"),t.push("          int max_y = y + h - 5;"),t.push(`          const int event_limit = ${a.event_limit||4};`),t.push("          "),t.push("          // Debug and parse JSON"),t.push(`          if (id(calendar_data_${e.id}).state.length() > 5 && id(calendar_data_${e.id}).state != "unknown") {`),t.push("             JsonDocument doc;"),t.push(`             DeserializationError error = deserializeJson(doc, id(calendar_data_${e.id}).state);`),t.push(""),t.push("             if (!error) {"),t.push("                 JsonVariant root = doc.as<JsonVariant>();"),t.push("                 JsonArray days;"),t.push(""),t.push('                 if (root.is<JsonObject>() && root["days"].is<JsonArray>()) {'),t.push('                     days = root["days"];'),t.push("                 } else if (root.is<JsonArray>()) {"),t.push("                     days = root;"),t.push("                 }"),t.push("                 "),t.push("                 if (!days.isNull() && days.size() > 0) {"),t.push("                     int event_count = 0;"),t.push("                     // Separator line"),t.push(`                     it.filled_rectangle(x + 10, eventY - 5, w - 20, 2, ${d});`),t.push(""),t.push("                     for (JsonVariant dayEntry : days) {"),t.push("                         if (eventY > max_y || event_count >= event_limit) break;"),t.push('                         int currentDayNum = dayEntry["day"].as<int>();'),t.push(""),t.push("                         auto draw_row = [&](JsonVariant event, bool is_all_day) {"),t.push("                             if (eventY > max_y || event_count >= event_limit) return;"),t.push('                             const char* summary = event["summary"] | "No Title";'),t.push('                             const char* start = event["start"] | "";'),t.push(""),t.push("                             // Draw Day Number"),t.push(`                             it.printf(x + 10, eventY, id(${$}), ${d}, TextAlign::TOP_LEFT, "%d", currentDayNum);`),t.push("                             "),t.push("                             // Draw Summary"),t.push(`                             it.printf(x + 50, eventY, id(${$}), ${d}, TextAlign::TOP_LEFT, "%.25s", summary);`),t.push(""),t.push("                             // Draw Time"),t.push("                             if (is_all_day) {"),t.push(`                                 it.printf(x + w - 10, eventY, id(${$}), ${d}, TextAlign::TOP_RIGHT, "All Day");`),t.push("                             } else {"),t.push("                                 std::string timeStr = extract_time(start);"),t.push(`                                 it.printf(x + w - 10, eventY, id(${$}), ${d}, TextAlign::TOP_RIGHT, "%s", timeStr.c_str());`),t.push("                             }"),t.push(`                             eventY += ${w+6};`),t.push("                             event_count++;"),t.push("                         };"),t.push(""),t.push('                         if (dayEntry["all_day"].is<JsonArray>()) {'),t.push('                             for (JsonVariant event : dayEntry["all_day"].as<JsonArray>()) {'),t.push("                                 draw_row(event, true);"),t.push("                             }"),t.push("                         }"),t.push('                         if (dayEntry["other"].is<JsonArray>()) {'),t.push('                             for (JsonVariant event : dayEntry["other"].as<JsonArray>()) {'),t.push("                                 draw_row(event, false);"),t.push("                             }"),t.push("                         }"),t.push("                     }"),t.push("                 }"),t.push("             } else {"),t.push('                 ESP_LOGW("calendar", "JSON Parse Error: %s", error.c_str());'),t.push("             }"),t.push("          }"),A&&(t.push(`          for (int i = 0; i < ${C}; i++) {`),t.push(`            it.rectangle(x + i, y + i, w - 2*i, h - 2*i, ${_});`),t.push("          }")),r(t,y,g,e.x,e.y,e.width,e.height),t.push("        }"),v&&t.push("        }")}};export{O as default};
