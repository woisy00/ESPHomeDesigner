import{T as X}from"./template_converter-Dp-G9w6d.js";const ot=(e,_,{getColorStyle:i})=>{const s=_.props||{},h=_.entity_id||"",p=_.title||"",r=s.value_format||"label_value";let a=parseInt(s.precision,10);isNaN(a)&&(a=2);const t=s.unit||"",n=s.label_font_size||14,c=s.value_font_size||20,d=(s.font_family||"Roboto")+", sans-serif",y=String(s.font_weight||400),N=s.italic?"italic":"normal",A=s.color||"theme_auto",k=i(A),F=_.entity_id_2||"",I=s.separator||" ~ ";let v="--";const $=r.endsWith("_no_unit");let m=s.hide_unit||$?"":t;const W=f=>{if(window.AppState&&window.AppState.entityStates&&f){const u=window.AppState.entityStates[f];if(u&&u.state!==void 0){const T=u.formatted||String(u.state);u.state;const M=T.match(/^([-+]?\d*[.,]?\d+)(.*)$/);if(M){const C=parseFloat(M[1].replace(",",".")),L=M[2]?M[2].trim():"";if(f===h&&(t===void 0||t==="")&&!s.hide_unit&&!$&&(m=L),!isNaN(C))return!isNaN(a)&&a>=0?C.toFixed(a):C.toString()}if(f===h&&(t===void 0||t==="")&&u.attributes&&u.attributes.unit_of_measurement&&!s.hide_unit&&!$&&(m=u.attributes.unit_of_measurement),$||s.hide_unit){const C=T.match(/^([-+]?\d*[.,]?\d+)/);if(C){const L=parseFloat(C[1].replace(",","."));if(!isNaN(L))return!isNaN(a)&&a>=0?L.toFixed(a):L.toString()}return T.replace(/\s*[°%]?[A-Za-z/²³]+\s*$/,"").trim()||T}return T}}return"--"},B=W(h);let H=null;F&&(H=W(F)),v=B,H!==null&&(v=`${B}${I}${H}`),m&&v.endsWith(m)&&(m="");let b=p;if(!b&&(r.startsWith("label_")||r==="value_label")&&window.AppState&&window.AppState.entityStates&&h){const f=window.AppState.entityStates[h];f&&f.attributes&&f.attributes.friendly_name?b=f.attributes.friendly_name:h&&(b=h.split(".").pop().replace(/_/g," "))}const P=s.prefix||"",z=s.postfix||"",w=`${P}${v}${m?" "+m:""}${z}`.trim();e.innerHTML="",e.style.display="flex";const O=(f,u)=>{f&&(f.includes("LEFT")?u.style.textAlign="left":f.includes("RIGHT")?u.style.textAlign="right":u.style.textAlign="center")};((f,u)=>{f.includes("LEFT")?u.style.justifyContent="flex-start":f.includes("RIGHT")?u.style.justifyContent="flex-end":u.style.justifyContent="center",f.includes("TOP")?u.style.alignItems="flex-start":f.includes("BOTTOM")?u.style.alignItems="flex-end":u.style.alignItems="center"})(s.text_align||"TOP_LEFT",e);const o=document.createElement("div");if(o.style.color=k,o.style.fontFamily=d,o.style.fontWeight=y,o.style.fontStyle=N,o.style.wordWrap="break-word",o.style.overflowWrap="break-word",o.style.maxWidth="100%",(r==="label_value"||r==="label_value_no_unit")&&b){o.style.display="flex",o.style.alignItems="baseline",o.style.justifyContent="flex-start",o.style.gap="4px";const f=document.createElement("span");f.style.fontSize=`${n}px`,f.textContent=b+":";const u=document.createElement("span");u.style.fontSize=`${c}px`,u.textContent=w;const T=s.label_align||s.text_align||"TOP_LEFT";T.includes("CENTER")?o.style.justifyContent="center":T.includes("RIGHT")?o.style.justifyContent="flex-end":o.style.justifyContent="flex-start",o.appendChild(f),o.appendChild(u)}else if((r==="label_newline_value"||r==="label_newline_value_no_unit")&&b){o.style.display="flex",o.style.flexDirection="column",o.style.gap="2px",o.style.width="100%";const f=document.createElement("div");f.style.fontSize=`${n}px`,f.textContent=b,O(s.label_align||s.text_align||"TOP_LEFT",f);const u=document.createElement("div");u.style.fontSize=`${c}px`,u.textContent=w,O(s.value_align||s.text_align||"TOP_LEFT",u),o.appendChild(f),o.appendChild(u)}else if(r==="value_label"&&b){o.style.display="flex",o.style.alignItems="baseline",o.style.gap="4px";const f=document.createElement("span");f.style.fontSize=`${c}px`,f.textContent=w;const u=document.createElement("span");u.style.fontSize=`${n}px`,u.textContent=b,o.appendChild(f),o.appendChild(u)}else r==="label_only"?(o.style.fontSize=`${n}px`,o.textContent=b,O(s.text_align||"TOP_LEFT",o)):(o.style.fontSize=`${c}px`,o.textContent=w,O(s.value_align||s.text_align||"TOP_LEFT",o));e.appendChild(o)},ut={id:"sensor_text",name:"Sensor Text",category:"Sensors",supportedModes:["lvgl","direct","oepl","opendisplay"],defaults:{entity_id:"",title:"",value_format:"label_value",label_font_size:14,value_font_size:20,unit:"",precision:2,text_align:"TOP_LEFT",color:"theme_auto",font_family:"Roboto"},render:ot,exportOpenDisplay:(e,{layout:_,page:i})=>{const s=e.props||{},h=(e.entity_id||"").trim(),p=s.value_format||"label_value",r=s.value_font_size||20;let a=s.color||"black";a==="theme_auto"&&(a=_?.darkMode?"white":"black");let t="";if(window.AppState&&window.AppState.entityStates&&h){const d=window.AppState.entityStates[h];t=d?d.formatted||String(d.state):"--"}else t="{{ state }}";let n=(e.title||s.title||"").trim();!n&&p.startsWith("label_")&&(n=h.split(".").pop().replace(/_/g," "));let c="";if(p==="label_only")c=n;else if(p==="label_value")c=`${n}: ${t}`;else{if(p==="label_newline_value"||p==="label_newline_value_no_unit")return{type:"multiline",value:`${n}
${t}`,delimiter:`
`,x:Math.round(e.x),offset_y:r+5,size:r,color:a,font:s.font_family?.includes("Mono")?"mononoki.ttf":"ppb.ttf"};c=t}return{type:"draw_text",x:Math.round(e.x),y:Math.round(e.y),text:c,size:r,color:a,font:s.font_family?.toLowerCase()||"roboto"}},exportOEPL:(e,{layout:_,page:i})=>{const s=e.props||{},h=(e.entity_id||"").trim(),p=(e.entity_id_2||"").trim(),r=s.value_format||"label_value",a=parseInt(s.precision,10)||0,t=s.separator||" ~ ",n=s.prefix||"",c=s.postfix||"",d=(s.unit||"").trim();let y=s.color||"black";y==="theme_auto"&&(y=_?.darkMode?"white":"black");const N=X.toHATemplate(h,{precision:a,isNumeric:!s.is_text_sensor}),A=p?X.toHATemplate(p,{precision:a,isNumeric:!s.is_text_sensor}):null,k=A?`${N}${t}${A}`:N,F=`${n}${k}${d?" "+d:""}${c}`.trim();let I=(e.title||s.title||"").trim();!I&&r.startsWith("label_")&&(I=h.split(".").pop().replace(/_/g," "));let v="";r==="label_only"?v=I:r==="label_value"||r==="label_value_no_unit"?v=`${I}: ${F}`:r==="label_newline_value"||r==="label_newline_value_no_unit"?v=`${I}
${F}`:r==="value_label"?v=`${F} ${I}`:v=F;const $=s.value_font_size||20,m=5,W={type:"text",value:v,x:Math.round(e.x),y:Math.round(e.y),size:$,font:s.font_family?.includes("Mono")?"mononoki.ttf":"ppb.ttf",color:y,align:(s.text_align||"TOP_LEFT").toLowerCase().replace("top_","").replace("bottom_","").replace("_",""),anchor:"lt"};return e.width&&e.width>0&&(W.max_width=Math.round(e.width),W.spacing=m),W},collectRequirements:(e,{addFont:_})=>{const i=e.props||{},s=i.font_family||"Roboto",h=i.font_weight||400,p=!!i.italic;_(s,h,i.label_font_size||14,p),_(s,h,i.value_font_size||20,p)},export:(e,_)=>{const{lines:i,getColorConst:s,addFont:h,getCondProps:p,getConditionCheck:r,Utils:a}=_,t=e.props||{};let n=(e.entity_id||"").trim(),c=(e.entity_id_2||"").trim();n&&!t.is_local_sensor&&!n.includes(".")&&!n.startsWith("text_sensor.")&&(n=`sensor.${n}`),c&&!t.is_local_sensor&&!c.includes(".")&&!c.startsWith("text_sensor.")&&(c=`sensor.${c}`);const d=t.value_format||"label_value";let y=(t.unit||"").trim();if(!y&&!t.hide_unit&&!d.endsWith("_no_unit")&&window.AppState&&window.AppState.entityStates){const l=window.AppState.entityStates[n];if(l){if(l.attributes&&l.attributes.unit_of_measurement)y=l.attributes.unit_of_measurement;else if(l.formatted){const x=l.formatted.match(/^([-+]?\d*[.,]?\d+)\s*(.*)$/);x&&x[2]&&(y=x[2].trim())}}}if(!y&&!t.hide_unit&&!d.endsWith("_no_unit")&&n){const l=n.toLowerCase();l.includes("_power")||l.includes("_watt")?y="W":l.includes("_energy")||l.includes("_kwh")?y="kWh":l.includes("_temperature")||l.includes("_temp")?y="°C":l.includes("_humidity")?y="%":l.includes("_voltage")||l.includes("_volt")?y="V":l.includes("_current")||l.includes("_amp")?y="A":l.includes("_battery")?y="%":l.includes("_pressure")||l.includes("_hpa")?y="hPa":l.includes("_speed")||l.includes("_kmh")?y="km/h":(l.includes("_percent")||l.includes("_pct"))&&(y="%")}const N=t.label_font_size||14,A=t.value_font_size||20,k=t.font_family||"Roboto",F=t.font_weight||400,I=!!t.italic,v=t.color||"theme_auto",$=s(v),m=t.text_align||"TOP_LEFT",W=t.separator||" ~ ",B=t.prefix||"",H=t.postfix||"";let b=parseInt(t.precision,10);(isNaN(b)||b<0)&&(b=2);const P=l=>(l||"").replace(/%/g,"%%");if(i.push(`        // widget:sensor_text id:${e.id} type:sensor_text x:${e.x} y:${e.y} w:${e.width} h:${e.height} entity:"${n}" format:"${d}" ${p(e)}`),!n&&!t.is_local_sensor){i.push("        // Sensor ID missing for this widget");return}const z=h(k,F,N,I),w=h(k,F,A,I),O=r(e);O&&i.push(`        ${O}`);const Z=l=>{if(!l||!window.AppState?.entityStates)return!1;const x=window.AppState.entityStates[l];if(!x||x.state===void 0)return!1;const E=String(x.state);return isNaN(parseFloat(E))||!isFinite(parseFloat(E))},o=(l,x="")=>{let E=l.replace(/[^a-zA-Z0-9_]/g,"_");const G=63-x.length;return E.length>G&&(E=E.substring(0,G)),E+x},f=!t.is_local_sensor&&Z(n),u=!t.is_local_sensor&&c&&Z(c),T=t.is_text_sensor||f||n&&(n.startsWith("text_sensor.")||n.startsWith("weather.")),M=c&&(t.is_text_sensor||u||c.startsWith("text_sensor.")||c.startsWith("weather.")),C=(l,x)=>t.is_local_sensor?`id(${l||"battery_level"})`:x?`id(${o(l,"_txt")})`:`id(${o(l)})`,L=C(n,T),D=c?C(c,M):null,Y=T?"%s":`%.${b}f`,tt=M?"%s":`%.${b}f`;let j=(e.title||t.title||"").trim();!j&&d.startsWith("label_")&&(j=n.split(".").pop().replace(/_/g," "));const K=t.hide_unit||d.endsWith("_no_unit")?"":P(y),et=P(B),st=P(H),it=P(W),q=l=>l?l==="CENTER"?"TextAlign::CENTER":`TextAlign::${l}`:"TextAlign::TOP_LEFT",J=q(t.label_align||m),U=q(t.value_align||m);let g=e.x,S=e.y;const nt=m.includes("CENTER"),lt=m.includes("RIGHT");nt?g=Math.round(e.x+e.width/2):lt&&(g=Math.round(e.x+e.width)),m.includes("BOTTOM")?S=Math.round(e.y+e.height):m.includes("TOP")||(S=Math.round(e.y+e.height/2));const V=`${et}${Y}${D?it+tt:""}${K?" "+K:""}${st}`,Q=T?`${L}.state.c_str()`:`${L}.state`,at=D?M?`${D}.state.c_str()`:`${D}.state`:null,R=D?`${Q}, ${at}`:Q;if(d==="label_only")i.push(`        it.printf(${g}, ${S}, id(${z}), ${$}, ${J}, "${j}");`);else if(d==="value_only"||d==="value_only_no_unit"||!j)if(e.width&&e.width>50){const x=A+4;i.push("        {"),i.push("          char wrap_buf[512];"),i.push(`          sprintf(wrap_buf, "${V}", ${R});`),i.push(`          print_wrapped_text(${g}, ${S}, ${e.width}, ${x}, id(${w}), ${$}, ${U}, wrap_buf);`),i.push("        }")}else i.push(`        it.printf(${g}, ${S}, id(${w}), ${$}, ${U}, "${V}", ${R});`);else if(d==="label_value"||d==="label_value_no_unit"){const l=`${j}${j.endsWith(":")?"":":"} `,x=e.width&&e.width>50;if(N!==A&&m.includes("LEFT")||x){const E=q(m);if(i.push("        {"),i.push("          int w1, h1, xoff1, bl1;"),i.push("          int w2, h2, xoff2, bl2;"),i.push("          char value_buf[512];"),i.push(`          sprintf(value_buf, "${V}", ${R});`),i.push(`          id(${z})->measure("${l}", &w1, &xoff1, &bl1, &h1);`),x){const G=A+4;i.push("          // Align baselines for first line: yVal + bl1 = yVal2 + bl2"),i.push("          // Note: we can't easily align baselines perfectly without measuring the value's first line first,"),i.push("          // but we can approximate or just use top-aligned reference."),i.push("          // For wrapped text, we print the label, then wrap the rest."),i.push(`          it.printf(${g}, ${S}, id(${z}), ${$}, ${E}, "${l}");`),i.push(`          int val_max_w = ${e.width} - w1;`),i.push("          // Heuristic: if label is taller than value font, adjust y? mostly fine to align tops or just let baselines float."),i.push("          // Let's assume top alignment is safer for multi-line flow."),i.push(`          print_wrapped_text(${g} + w1, ${S} + (bl1 - ${Math.round(A*.8)}), val_max_w, ${G}, id(${w}), ${$}, ${E}, value_buf);`)}else i.push(`          id(${w})->measure(value_buf, &w2, &xoff2, &bl2, &h2);`),i.push("          // Align baselines: yVal + bl1 = yVal2 + bl2 => yVal2 = yVal + bl1 - bl2"),i.push(`          it.printf(${g}, ${S}, id(${z}), ${$}, ${E}, "${l}");`),i.push(`          it.printf(${g} + w1, ${S} + (bl1 - bl2), id(${w}), ${$}, ${E}, "%s", value_buf);`);i.push("        }")}else i.push(`        it.printf(${g}, ${S}, id(${w}), ${$}, ${U}, "${l}${V}", ${R});`)}else if(d==="label_newline_value"||d==="label_newline_value_no_unit")i.push(`        it.printf(${g}, ${S}, id(${z}), ${$}, ${J}, "${j}");`),i.push(`        it.printf(${g}, ${S} + ${N+4}, id(${w}), ${$}, ${U}, "${V}", ${R});`);else if(d==="value_label"){i.push(`        it.printf(${g}, ${S}, id(${w}), ${$}, ${U}, "${V}", ${R});`);const l=Math.round(A*.6*6)+10;i.push(`        it.printf(${g} + ${l}, ${S}, id(${z}), ${$}, ${J}, "${j}");`)}O&&i.push("        }")},onExportTextSensors:e=>{const{lines:_,widgets:i}=e;if(!i)return;const s=a=>{if(!a||!window.AppState?.entityStates)return!1;const t=window.AppState.entityStates[a];if(!t||t.state===void 0)return!1;const n=String(t.state);return isNaN(parseFloat(n))||!isFinite(parseFloat(n))},h=(a,t="")=>{let n=a.replace(/[^a-zA-Z0-9_]/g,"_");const c=63-t.length;return n.length>c&&(n=n.substring(0,c)),n+t},p=new Set,r=new Set;for(const a of i){if(a.type!=="sensor_text")continue;const t=a.props||{},n=(a.entity_id||"").trim(),c=!t.is_local_sensor&&s(n);n.startsWith("weather.")?p.add(n):(t.is_text_sensor||c||n.startsWith("text_sensor."))&&r.add(n);const d=(a.entity_id_2||t.entity_id_2||"").trim();if(d){const y=!t.is_local_sensor&&s(d);d.startsWith("weather.")?p.add(d):(t.is_text_sensor||y||d.startsWith("text_sensor."))&&r.add(d)}}if(p.size>0){let a=!1;for(let t of p){t&&!t.includes(".")&&(t=`weather.${t}`);const n=h(t,"_txt");e.seenSensorIds&&e.seenSensorIds.has(n)||e.seenTextEntityIds&&e.seenTextEntityIds.has(t)||(a||(_.push("# Weather Entity Sensors (Detected from Sensor Text)"),a=!0),e.seenSensorIds&&e.seenSensorIds.add(n),e.seenTextEntityIds&&e.seenTextEntityIds.add(t),_.push("- platform: homeassistant"),_.push(`  id: ${n}`),_.push(`  entity_id: ${t}`),_.push("  internal: true"))}}if(r.size>0){let a=!1;for(let t of r){const n=h(t,"_txt");e.seenSensorIds&&e.seenSensorIds.has(n)||e.seenTextEntityIds&&e.seenTextEntityIds.has(t)||(a||(_.push("# Text Sensors (Detected from Sensor Text)"),a=!0),e.seenSensorIds&&e.seenSensorIds.add(n),e.seenTextEntityIds&&e.seenTextEntityIds.add(t),_.push("- platform: homeassistant"),_.push(`  id: ${n}`),_.push(`  entity_id: ${t}`),_.push("  internal: true"))}}},onExportNumericSensors:e=>{const{widgets:_,isLvgl:i,pendingTriggers:s}=e;if(!_)return;const h=p=>{if(!p||!window.AppState?.entityStates)return!1;const r=window.AppState.entityStates[p];if(!r||r.state===void 0)return!1;const a=String(r.state);return isNaN(parseFloat(a))||!isFinite(parseFloat(a))};for(const p of _){if(p.type!=="sensor_text")continue;const r=p.props||{};if(r.is_local_sensor)continue;const a=[p.entity_id,p.entity_id_2].filter(t=>t&&t.trim());for(let t of a)t=t.trim(),!(r.is_text_sensor||t.startsWith("weather.")||t.startsWith("text_sensor."))&&(h(t)||(t.includes(".")||(t=`sensor.${t}`),i&&s&&(s.has(t)||s.set(t,new Set),s.get(t).add(`- lvgl.widget.refresh: ${p.id}`))))}}};export{ut as default};
