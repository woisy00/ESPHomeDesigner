const L=(s,t,e)=>{const o=t.props||{},{getColorStyle:n}=e,a=o.show_author!==!1,r=parseInt(o.quote_font_size||18,10),h=parseInt(o.author_font_size||14,10),i=o.font_family||"Roboto",l=parseInt(o.font_weight||400,10),f=o.color||"black",g=n(f),y=o.text_align||"TOP_LEFT",$=o.italic_quote!==!1,c=[{quote:"The only way to do great work is to love what you do.",author:"Steve Jobs"},{quote:"In the middle of difficulty lies opportunity.",author:"Albert Einstein"},{quote:"Life is what happens when you're busy making other plans.",author:"John Lennon"},{quote:"The future belongs to those who believe in the beauty of their dreams.",author:"Eleanor Roosevelt"},{quote:"Success is not final, failure is not fatal: it is the courage to continue that counts.",author:"Winston Churchill"},{quote:"Be yourself; everyone else is already taken.",author:"Oscar Wilde"},{quote:"Two things are infinite: the universe and human stupidity.",author:"Albert Einstein"},{quote:"Be the change that you wish to see in the world.",author:"Mahatma Gandhi"}],d=o.feed_url||"https://www.brainyquote.com/link/quotebr.rss",E=(d+(t.id||"default")).split("").reduce((u,F)=>(u<<5)-u+F.charCodeAt(0),0),T=c[Math.abs(E)%c.length],b=window.location.protocol==="file:"||typeof window.hasHaBackend!="function"||!window.hasHaBackend();window.quoteCache=window.quoteCache||{},window.quoteFetchTimers=window.quoteFetchTimers||{};const q=t.id+"|"+d,m=q+"_fetching",C=t.id+"_lastUrl";if(window.quoteCache[C]!==d&&(window.quoteCache[C]=d,window.quoteFetchTimers[t.id]&&(clearTimeout(window.quoteFetchTimers[t.id]),window.quoteFetchTimers[t.id]=null)),!window.quoteCache[q]&&!window.quoteCache[m]){window.quoteCache[m]=!0;const u=d,F=q,z=m;window.quoteFetchTimers[t.id]=setTimeout(async()=>{try{let w;b?w=null:w=await(await fetch(`/api/esphome_designer/rss_proxy?url=${encodeURIComponent(u)}`)).json(),w&&w.success&&w.quote&&(window.quoteCache[F]=w.quote,window.emit&&window.EVENTS&&window.emit(window.EVENTS.STATE_CHANGED))}catch{}finally{window.quoteCache[z]=!1,window.quoteFetchTimers[t.id]=null}},500)}const x=window.quoteCache[q]||T,v=!!window.quoteCache[q];s.style.display="flex",s.style.flexDirection="column",s.style.boxSizing="border-box",s.style.padding="8px",s.style.overflow="hidden",s.style.fontFamily=i+", serif",s.style.fontWeight=String(l),s.style.color=g,s.style.lineHeight="1.3",y.includes("CENTER")?(s.style.textAlign="center",s.style.alignItems="center"):y.includes("RIGHT")?(s.style.textAlign="right",s.style.alignItems="flex-end"):(s.style.textAlign="left",s.style.alignItems="flex-start"),y.startsWith("CENTER")?s.style.justifyContent="center":y.startsWith("BOTTOM")?s.style.justifyContent="flex-end":s.style.justifyContent="flex-start",s.innerHTML="";const S=o.word_wrap!==!1,p=document.createElement("div");if(p.style.fontSize=r+"px",p.style.fontStyle=$?"italic":"normal",p.style.marginBottom="8px",S?(p.style.wordWrap="break-word",p.style.overflowWrap="break-word",p.style.whiteSpace="normal"):(p.style.whiteSpace="nowrap",p.style.overflow="hidden",p.style.textOverflow="ellipsis"),p.textContent='"'+x.quote+'"',s.appendChild(p),a){const u=document.createElement("div");u.style.fontSize=h+"px",u.style.fontStyle="normal",u.style.opacity="0.8",u.textContent="â€” "+x.author,s.appendChild(u)}const _=document.createElement("div");_.style.fontSize="9px",_.style.opacity="0.5",_.style.marginTop="auto",_.style.paddingTop="4px";try{const u=new URL(d);b?_.textContent="ðŸ”Œ OFFLINE - "+u.hostname:v?_.textContent="ðŸŸ¢ "+u.hostname:_.textContent="âšª "+u.hostname}catch{_.textContent=b?"ðŸ”Œ OFFLINE":"ðŸ“° RSS Feed"}s.appendChild(_)},R=(s,{common:t,convertColor:e,getLVGLFont:o})=>{const n=s.props||{},a=`quote_${s.id.replace(/-/g,"_")}`,r=parseInt(n.quote_font_size||18,10),h=n.font_family||"Roboto",i=parseInt(n.font_weight||400,10),l=e(n.color||"black"),f=`!lambda |-
      std::string q = id(${a}_text_global);
      std::string a = id(${a}_author_global);
      if (q.empty()) return "Loading quote...";
      if (a.empty()) return ("\\"" + q + "\\"").c_str();
      return ("\\"" + q + "\\"\\nâ€” " + a).c_str();
    `;return{label:{...t,text:f,text_font:o(h,r,i,n.italic_quote!==!1),text_color:l,text_align:"center"}}},O=(s,t)=>{const{lines:e,addFont:o,getColorConst:n,getCondProps:a,getConditionCheck:r,getAlignX:h}=t,i=s.props||{},l=parseInt(i.quote_font_size||18,10),f=parseInt(i.author_font_size||14,10),g=i.font_family||"Roboto",y=parseInt(i.font_weight||400,10),$=i.color||"black",c=n($),d=i.text_align||"TOP_LEFT",I=i.italic_quote!==!1,E=i.word_wrap!==!1,T=`quote_${s.id.replace(/-/g,"_")}`,b=`${T}_text_global`,q=`${T}_author_global`,m=o(g,y,l,I),C=o(g,y,f,!1);e.push(`        // widget:quote_rss id:${s.id} type:quote_rss x:${s.x} y:${s.y} w:${s.width} h:${s.height} color:${$} align:${d} ${a(s)}`);const x=r(s);if(x&&e.push(`        ${x}`),e.push("        {"),e.push(`          std::string q_text = id(${b});`),i.show_author!==!1&&e.push(`          std::string q_author = id(${q});`),E)e.push(`          int max_w = ${s.width-16};`),e.push(`          int q_h = ${l+4};`),e.push('          std::string display_text = "\\"" + q_text + "\\"";'),e.push("          auto print_q = [&](esphome::font::Font *f, int line_h, bool draw) -> int {"),e.push(`            int y_curr = ${s.y+8};`),e.push("            std::string text_to_print = display_text;"),e.push('            std::string curr_line = "";'),e.push("            std::string word;"),e.push("            size_t pos = 0;"),e.push("            while (pos < text_to_print.length()) {"),e.push("                size_t space_pos = text_to_print.find(' ', pos);"),e.push("                if (space_pos == std::string::npos) {"),e.push("                    word = text_to_print.substr(pos);"),e.push("                    pos = text_to_print.length();"),e.push("                } else {"),e.push("                    word = text_to_print.substr(pos, space_pos - pos);"),e.push("                    pos = space_pos + 1;"),e.push("                }"),e.push("                if (word.empty()) continue;"),e.push('                std::string test_line = curr_line.empty() ? word : curr_line + " " + word;'),e.push("                int w_m, h_m, xoff_m, bl_m;"),e.push("                f->measure(test_line.c_str(), &w_m, &xoff_m, &bl_m, &h_m);"),e.push("                if (w_m > max_w && !curr_line.empty()) {"),e.push(`                    if (draw) it.printf(${s.x+8}, y_curr, f, ${c}, "%s", curr_line.c_str());`),e.push("                    y_curr += line_h;"),e.push("                    curr_line = word;"),e.push("                } else { curr_line = test_line; }"),e.push("            }"),e.push("            if (!curr_line.empty()) {"),e.push(`                if (draw) it.printf(${s.x+8}, y_curr, f, ${c}, "%s", curr_line.c_str());`),e.push("                y_curr += line_h;"),e.push("            }"),e.push(`            return y_curr - ${s.y+8};`),e.push("          };"),e.push(`          print_q(id(${m}), q_h, true);`),i.show_author!==!1&&e.push(`          if (!q_author.empty()) it.printf(${s.x+8}, ${s.y} + ${s.height} - ${f+4}, id(${C}), ${c}, "â€” %s", q_author.c_str());`);else{const v=h(d,s.x,s.width),S=`TextAlign::${d}`;e.push(`          it.printf(${v}, ${s.y}, id(${m}), ${c}, ${S}, "\\"%s\\"", q_text.c_str());`),i.show_author!==!1&&e.push(`          if (!q_author.empty()) it.printf(${v}, ${s.y+l+4}, id(${C}), ${c}, ${S}, "â€” %s", q_author.c_str());`)}e.push("        }"),x&&e.push("        }")},A=s=>{const{lines:t,widgets:e}=s;e.filter(o=>o.type==="quote_rss").forEach(o=>{const n=`quote_${o.id.replace(/-/g,"_")}`;t.push(`- id: ${n}_text_global`),t.push("  type: std::string"),t.push("  restore_value: true"),t.push(`  initial_value: '""'`),o.props&&o.props.show_author!==!1&&(t.push(`- id: ${n}_author_global`),t.push("  type: std::string"),t.push("  restore_value: true"),t.push(`  initial_value: '""'`))})},W=s=>{const{lines:t,widgets:e,displayId:o}=s,n=e.filter(a=>a.type==="quote_rss");if(n.length>0){t.some(r=>r.trim().startsWith("http_request:"))||(t.push(""),t.push("http_request:"),t.push("  verify_ssl: false"),t.push("  timeout: 20s"),t.push("  buffer_size_rx: 4096")),t.push(""),t.push("# Quote RSS Widget Update Loop"),t.push("interval:");for(const r of n){const h=r.props||{},i=h.refresh_interval||"1h",l=`quote_${r.id.replace(/-/g,"_")}`,f=h.feed_url||"https://www.brainyquote.com/link/quotebr.rss",g=h.random!==!1,c=`${(h.ha_url||"http://homeassistant.local:8123").replace(/\/$/,"")}/api/esphome_designer/rss_proxy?url=${encodeURIComponent(f)}${g?"&random=true":""}`;t.push(`  - interval: ${i}`),t.push("    startup_delay: 20s"),t.push("    then:"),t.push("      - if:"),t.push("          condition:"),t.push("            wifi.connected:"),t.push("          then:"),t.push("            - http_request.get:"),t.push(`                url: "${c}"`),t.push("                capture_response: true"),t.push("                on_response:"),t.push("                  - lambda: |-"),t.push("                      if (response->status_code == 200) {"),t.push('                        ESP_LOGD("quote", "Raw body: %s", body.c_str());'),t.push("                        JsonDocument doc;"),t.push("                        DeserializationError error = deserializeJson(doc, body);"),t.push("                        if (error) {"),t.push('                          ESP_LOGW("quote", "Failed to parse JSON: %s", error.c_str());'),t.push("                          return;"),t.push("                        }"),t.push('                        if (doc["success"].as<bool>()) {'),t.push('                          JsonVariant q_var = doc["quote"];'),t.push("                          if (q_var.is<JsonObject>()) {"),t.push("                            JsonObject q = q_var.as<JsonObject>();"),t.push('                            std::string q_str = q["quote"] | "";'),t.push("                            if (!q_str.empty()) {"),t.push(`                              id(${l}_text_global) = q_str;`),h.show_author!==!1&&t.push(`                              id(${l}_author_global) = q["author"] | "Unknown";`),t.push('                              ESP_LOGI("quote", "Fetched quote: %s", q_str.c_str());'),t.push("                            }"),t.push("                          }"),t.push("                        }"),t.push("                      }"),t.push("                  - if:"),t.push("                      condition:"),t.push("                        lambda: 'return response->status_code == 200;'"),t.push("                      then:"),s.isLvgl?t.push(`                        - lvgl.widget.refresh: ${r.id}`):t.push(`                        - component.update: ${o}`),t.push("                      else:"),t.push(`                        - lambda: 'ESP_LOGW("quote", "HTTP Request failed with code: %d", response->status_code);'`)}t.push("")}},k=s=>{const{lines:t,widgets:e}=s,o=e.filter(n=>n.type==="quote_rss");if(o.length>0){t.push("# Quote RSS Widget Text Sensors (visible in Home Assistant)");for(const n of o){const a=n.props||{},r=`quote_${n.id.replace(/-/g,"_")}`;t.push("- platform: template"),t.push(`  id: ${r}_text_sensor`),t.push('  name: "Quote Text"'),t.push('  icon: "mdi:format-quote-close"'),t.push(`  lambda: 'return id(${r}_text_global);'`),t.push("  update_interval: 60s"),a.show_author!==!1&&(t.push("- platform: template"),t.push(`  id: ${r}_author_sensor`),t.push('  name: "Quote Author"'),t.push('  icon: "mdi:account"'),t.push(`  lambda: 'return id(${r}_author_global);'`),t.push("  update_interval: 60s"))}}},U={id:"quote_rss",name:"Quote RSS",category:"Events",defaults:{feed_url:"https://www.brainyquote.com/link/quotebr.rss",quote_font_size:18,author_font_size:14,font_family:"Roboto",font_weight:400,color:"black",text_align:"TOP_LEFT",show_author:!0,italic_quote:!0,word_wrap:!0,width:400,height:120,refresh_interval:"1h",ha_url:"http://homeassistant.local:8123",random:!0},render:L,onExportGlobals:A,onExportTextSensors:k,onExportComponents:W,exportLVGL:R,export:O};export{U as default};
