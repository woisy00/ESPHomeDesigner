const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./plugin-DyzZDkz_.js","./template_converter-Dp-G9w6d.js","./plugin-CG2xI9fV.js"])))=>i.map(i=>d[i]);
(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))i(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function n(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(t){if(t.ep)return;t.ep=!0;const s=n(t);fetch(t.href,s)}})();function Se(){return"w_"+Date.now().toString(36)+Math.random().toString(36).substr(2,5)}typeof crypto<"u"&&!crypto.randomUUID?crypto.randomUUID=function(){return("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,a=>(a^crypto.getRandomValues(new Uint8Array(1))[0]&15>>a/4).toString(16))}:typeof crypto>"u"&&(window.crypto={randomUUID:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{const e=Math.random()*16|0;return(a==="x"?e:e&3|8).toString(16)}),getRandomValues:a=>a.map(()=>Math.floor(Math.random()*256))});function Ei(a,e){let n;return function(...t){const s=()=>{clearTimeout(n),a(...t)};clearTimeout(n),n=setTimeout(s,e)}}function Ue(a){return JSON.parse(JSON.stringify(a))}window.generateId=Se;window.debounce=Ei;window.deepClone=Ue;var Si={};const Ii=(typeof localStorage<"u"?localStorage.getItem("esphome-designer-debug"):Si.DEBUG)==="true",_={log:(...a)=>Ii&&console.log("[ESPHomeDesigner]",...a),warn:(...a)=>console.warn("[ESPHomeDesigner]",...a),error:(...a)=>console.error("[ESPHomeDesigner]",...a)};function rt(){let a=at();if(a)return a=a.trim(),a.endsWith("/")&&(a=a.slice(0,-1)),a&&!a.includes("/api/")&&(a+="/api/esphome_designer"),a;try{const e=window.location;return e.protocol==="file:"?null:e.hostname==="homeassistant"||e.hostname==="hassio"||e.pathname.includes("/api/")||e.pathname.includes("/local/")||e.pathname.includes("/hacsfiles/")||e.pathname.includes("/esphome-designer")?`${e.origin}/api/esphome_designer`:null}catch{return null}}function at(){try{return localStorage.getItem("ha_manual_url")}catch{return null}}function Qt(a){try{if(a){let e=a.trim();e.endsWith("/")&&(e=e.slice(0,-1)),e.includes("/api/")||(e+="/api/esphome_designer"),localStorage.setItem("ha_manual_url",e)}else localStorage.removeItem("ha_manual_url")}catch(e){_.error("Failed to save HA URL:",e)}}function Re(){try{return localStorage.getItem("ha_llat_token")}catch{return null}}function Zt(a){try{a?localStorage.setItem("ha_llat_token",a):localStorage.removeItem("ha_llat_token")}catch(e){_.error("Failed to save HA Token:",e)}}let Q=rt();function Ve(){Q=rt()}function q(){return!!Q}window.detectHaBackendBaseUrl=rt;window.getHaManualUrl=at;window.setHaManualUrl=Qt;window.getHaToken=Re;window.setHaToken=Zt;window.HA_API_BASE=Q;window.refreshHaBaseUrl=Ve;window.hasHaBackend=q;function Ci(a){const e=document.getElementById("importSnippetError");e&&(e.textContent=a||"")}function z(a,e="info",n=3e3){let i=document.getElementById("toast-container");i||(i=document.createElement("div"),i.id="toast-container",i.style.position="fixed",i.style.bottom="20px",i.style.right="20px",i.style.zIndex="9999",document.body.appendChild(i));const t=document.createElement("div");t.className="toast",e==="error"?t.style.background="rgba(255, 0, 0, 0.8)":e==="success"?t.style.background="rgba(0, 128, 0, 0.8)":t.style.background="rgba(0,0,0,0.8)",t.textContent=a,t.style.color="white",t.style.padding="10px 20px",t.style.borderRadius="4px",t.style.marginTop="10px",t.style.opacity="0",t.style.transition="opacity 0.3s",i.appendChild(t),requestAnimationFrame(()=>{t.style.opacity="1"}),setTimeout(()=>{t.style.opacity="0",setTimeout(()=>{t.remove()},300)},n)}const ei=Object.freeze(Object.defineProperty({__proto__:null,setImportError:Ci,showToast:z},Symbol.toStringTag,{value:"Module"})),Li="modulepreload",ki=function(a,e){return new URL(a,e).href},vt={},N=function(e,n,i){let t=Promise.resolve();if(n&&n.length>0){const o=document.getElementsByTagName("link"),r=document.querySelector("meta[property=csp-nonce]"),d=r?.nonce||r?.getAttribute("nonce");t=Promise.allSettled(n.map(c=>{if(c=ki(c,i),c in vt)return;vt[c]=!0;const l=c.endsWith(".css"),h=l?'[rel="stylesheet"]':"";if(!!i)for(let f=o.length-1;f>=0;f--){const y=o[f];if(y.href===c&&(!l||y.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${c}"]${h}`))return;const m=document.createElement("link");if(m.rel=l?"stylesheet":Li,l||(m.as="script"),m.crossOrigin="",m.href=c,d&&m.setAttribute("nonce",d),document.head.appendChild(m),l)return new Promise((f,y)=>{m.addEventListener("load",f),m.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${c}`)))})}))}function s(o){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=o,window.dispatchEvent(r),!r.defaultPrevented)throw o}return t.then(o=>{for(const r of o||[])r.status==="rejected"&&s(r.reason);return e().catch(s)})},Le=new EventTarget,P={STATE_CHANGED:"state-changed",SELECTION_CHANGED:"selection-changed",PAGE_CHANGED:"page-changed",HISTORY_CHANGED:"history-changed",SETTINGS_CHANGED:"settings-changed",LAYOUT_IMPORTED:"layout-imported",ENTITIES_LOADED:"entities-loaded",ZOOM_CHANGED:"zoom-changed"};function O(a,e={}){Le.dispatchEvent(new CustomEvent(a,{detail:e}))}function Z(a,e){Le.addEventListener(a,n=>e(n.detail))}function ti(a,e){Le.removeEventListener(a,e)}window.EventBus=Le;window.EVENTS=P;window.emit=O;window.on=Z;window.off=ti;const Ti=Object.freeze(Object.defineProperty({__proto__:null,EVENTS:P,EventBus:Le,emit:O,off:ti,on:Z},Symbol.toStringTag,{value:"Module"})),lt={WHITE:"#FFFFFF",BLACK:"#000000",GRAY:"#808080",GREY:"#808080",RED:"#FF0000",GREEN:"#00FF00",BLUE:"#0000FF",YELLOW:"#FFFF00",ORANGE:"#FFA500"},ii={GRID_SIZE:10,SNAP_THRESHOLD:10,SIDEBAR_WIDTH:300,PROPERTIES_WIDTH:350},dt={TOP_LEFT:"TOP_LEFT",TOP_CENTER:"TOP_CENTER",TOP_RIGHT:"TOP_RIGHT",CENTER_LEFT:"CENTER_LEFT",CENTER:"CENTER",CENTER_RIGHT:"CENTER_RIGHT",BOTTOM_LEFT:"BOTTOM_LEFT",BOTTOM_CENTER:"BOTTOM_CENTER",BOTTOM_RIGHT:"BOTTOM_RIGHT"},ct={LANDSCAPE:"landscape",PORTRAIT:"portrait"},pt={snapEnabled:!0,showGrid:!0,showDebugGrid:!1,showRulers:!1,gridOpacity:8,editor_light_mode:!1,aiProvider:"gemini",aiModelGemini:"gemini-1.5-flash",aiModelOpenAI:"gpt-4o",aiModelOpenRouter:"",aiModelFilter:"",extendedLatinGlyphs:!1,autoCycleEnabled:!1,autoCycleIntervalS:30,refreshInterval:600,manualRefreshOnly:!1,darkMode:!1,invertedColors:!1,lcdEcoStrategy:"backlight_off",sleepEnabled:!1,sleepStartHour:0,sleepEndHour:5,deepSleepEnabled:!1,deepSleepInterval:600,dailyRefreshEnabled:!1,dailyRefreshTime:"08:00",noRefreshStartHour:null,noRefreshEndHour:null,renderingMode:"direct",oeplEntityId:"",oeplDither:2,glyphsets:["GF_Latin_Kernel"]},si={X:40,Y:40,WIDTH:200,HEIGHT:60},ht=50,ni={RSS:300,ENTITIES:60},oi=5e3,ut={white:"COLOR_WHITE",black:"COLOR_BLACK",gray:"Color(160, 160, 160)",grey:"Color(160, 160, 160)",red:"COLOR_RED",green:"COLOR_GREEN",blue:"COLOR_BLUE",yellow:"COLOR_YELLOW",orange:"COLOR_ORANGE"},gt=800,mt=480,be=10,ri=10;window.ESPHomeDesigner=window.ESPHomeDesigner||{version:"0.9.0",constants:{COLORS:lt,UI_DEFAULTS:ii,ALIGNMENT:dt,ORIENTATIONS:ct,DEFAULT_PREFERENCES:pt,WIDGET_DEFAULTS:si,HISTORY_LIMIT:ht,CACHE_TTL:ni,ENTITY_LIMIT:oi,ESPHOME_COLOR_MAPPING:ut,DEFAULT_CANVAS_WIDTH:gt,DEFAULT_CANVAS_HEIGHT:mt,SNAP_DISTANCE:be,GRID_SIZE:ri}};window.COLORS=lt;window.UI_DEFAULTS=ii;window.ALIGNMENT=dt;window.ORIENTATIONS=ct;window.DEFAULT_PREFERENCES=pt;window.WIDGET_DEFAULTS=si;window.HISTORY_LIMIT=ht;window.CACHE_TTL=ni;window.ENTITY_LIMIT=oi;window.ESPHOME_COLOR_MAPPING=ut;window.DEFAULT_CANVAS_WIDTH=gt;window.DEFAULT_CANVAS_HEIGHT=mt;window.SNAP_DISTANCE=be;window.GRID_SIZE=ri;class Pi{constructor(){this.state={pages:[],currentPageIndex:0,deviceName:"Layout 1",deviceModel:"reterminal_e1001",currentLayoutId:"reterminal_e1001",customHardware:{},protocolHardware:{width:400,height:300,colorMode:"bw"},widgetsById:new Map},this.reset()}reset(){this.state.pages=[{id:"page_0",name:"Overview",layout:null,widgets:[]}],this.state.currentPageIndex=0,this.rebuildWidgetsIndex()}get pages(){return this.state.pages}get currentPageIndex(){return this.state.currentPageIndex}get deviceName(){return this.state.deviceName}get deviceModel(){return this.state.deviceModel}get currentLayoutId(){return this.state.currentLayoutId}get protocolHardware(){return this.state.protocolHardware}getCurrentPage(){return this.state.pages[this.state.currentPageIndex]||this.state.pages[0]}getWidgetById(e){return this.state.widgetsById.get(e)}rebuildWidgetsIndex(){this.state.widgetsById.clear();for(const e of this.state.pages)for(const n of e.widgets)this.state.widgetsById.set(n.id,n)}setPages(e){this.state.pages=e,this.rebuildWidgetsIndex(),O(P.STATE_CHANGED)}setCurrentPageIndex(e,n={}){e>=0&&e<this.state.pages.length&&(this.state.currentPageIndex=e,O(P.PAGE_CHANGED,{index:e,...n}))}reorderPage(e,n){if(e<0||e>=this.state.pages.length||n<0||n>=this.state.pages.length)return;const[i]=this.state.pages.splice(e,1);this.state.pages.splice(n,0,i),this.state.currentPageIndex===e?this.state.currentPageIndex=n:e<this.state.currentPageIndex&&n>=this.state.currentPageIndex?this.state.currentPageIndex--:e>this.state.currentPageIndex&&n<=this.state.currentPageIndex&&this.state.currentPageIndex++,O(P.STATE_CHANGED),O(P.PAGE_CHANGED,{index:this.state.currentPageIndex})}addPage(e=null){const n=this.state.pages.length,i={id:`page_${Date.now()}_${n}`,name:`Page ${n+1}`,widgets:[]},t=e!==null?e:this.state.pages.length;return this.state.pages.splice(t,0,i),e!==null&&e<=this.state.currentPageIndex?this.state.currentPageIndex++:e===null&&(this.state.currentPageIndex=this.state.pages.length-1),this.rebuildWidgetsIndex(),O(P.STATE_CHANGED),O(P.PAGE_CHANGED,{index:this.state.currentPageIndex}),i}deletePage(e){e<0||e>=this.state.pages.length||(this.state.pages.splice(e,1),this.state.currentPageIndex>=this.state.pages.length&&(this.state.currentPageIndex=Math.max(0,this.state.pages.length-1)),this.rebuildWidgetsIndex(),O(P.STATE_CHANGED),O(P.PAGE_CHANGED,{index:this.state.currentPageIndex}))}addWidget(e,n=null){const i=n!==null?n:this.state.currentPageIndex;(this.state.pages[i]||this.getCurrentPage()).widgets.push(e),this.state.widgetsById.set(e.id,e),O(P.STATE_CHANGED)}updateWidget(e,n){const i=this.getWidgetById(e);i&&(Object.assign(i,n),O(P.STATE_CHANGED))}deleteWidgets(e){const n=this.getCurrentPage();let i=!1;for(const t of e){const s=n.widgets.findIndex(o=>o.id===t);s!==-1&&(n.widgets.splice(s,1),this.state.widgetsById.delete(t),i=!0)}i&&O(P.STATE_CHANGED)}moveWidgetToPage(e,n,i=null,t=null){if(n<0||n>=this.state.pages.length)return!1;const s=this.state.pages[n],o=new Set,r=[];let d=e,c=this.state.widgetsById.get(e);if(c&&c.parentId){let g=c;for(;g.parentId;){const m=this.state.widgetsById.get(g.parentId);if(m)g=m;else break}d=g.id}const l=g=>{if(o.has(g))return;let m=null,f=null;for(const b of this.state.pages)if(m=b.widgets.find(w=>w.id===g),m){f=b;break}if(!m||!f||f===s)return;o.add(g),r.push({widget:m,sourcePage:f}),f.widgets.filter(b=>b.parentId===g).forEach(b=>l(b.id))};if(l(d),r.length===0)return!1;r.forEach((g,m)=>{const{widget:f,sourcePage:y}=g,b=y.widgets.indexOf(f);if(b!==-1&&y.widgets.splice(b,1),m===0&&f.parentId&&!o.has(f.parentId)&&(f.parentId=null),m===0){let w=0,v=0;if(i!==null&&t!==null&&(w=i-f.x,v=t-f.y,f.x=i,f.y=t),w!==0||v!==0)for(let I=1;I<r.length;I++){const k=r[I].widget;k.x+=w,k.y+=v}}s.widgets.push(f)});const h=this.getCanvasDimensions();for(const g of o){const m=this.state.widgetsById.get(g);if(!m||m.parentId&&o.has(m.parentId))continue;const f=m.x,y=m.y;m.x=Math.max(0,Math.min(h.width-(m.width||50),m.x)),m.y=Math.max(0,Math.min(h.height-(m.height||50),m.y));const b=m.x-f,w=m.y-y;if(b!==0||w!==0)for(const v of o){const I=this.state.widgetsById.get(v);I&&I.parentId===m.id&&(I.x+=b,I.y+=w)}}return this.rebuildWidgetsIndex(),O(P.STATE_CHANGED),!0}reorderWidget(e,n,i){const t=this.state.pages[e];if(!t)return;const s=t.widgets;if(n<0||n>=s.length||i<0||i>=s.length)return;const[o]=s.splice(n,1);s.splice(i,0,o),O(P.STATE_CHANGED)}clearCurrentPage(e=!1){const n=this.getCurrentPage();if(!n)return{deleted:0,preserved:0};const i=[],t=[];return n.widgets.forEach(s=>{e&&s.locked?t.push(s):i.push(s)}),n.widgets=t,i.forEach(s=>this.state.widgetsById.delete(s.id)),i.length>0&&O(P.STATE_CHANGED),{deleted:i.length,preserved:t.length}}setDeviceSettings(e,n){e&&(this.state.deviceName=e),n&&(this.state.deviceModel=n,window.currentDeviceModel=n),O(P.SETTINGS_CHANGED)}getCanvasDimensions(e){const n=this.state.deviceModel||"reterminal_e1001",i=F&&F[n]?F[n]:null;let t=gt,s=mt;if(i)i.resolution&&(t=i.resolution.width,s=i.resolution.height);else if(n==="custom"&&this.state.customHardware){const o=this.state.customHardware;o.resWidth&&o.resHeight&&(t=o.resWidth,s=o.resHeight)}return e===ct.PORTRAIT?{width:Math.min(t,s),height:Math.max(t,s)}:{width:Math.max(t,s),height:Math.min(t,s)}}getPagesPayload(){return{pages:this.state.pages,deviceName:this.state.deviceName,deviceModel:this.state.deviceModel,currentLayoutId:this.state.currentLayoutId,customHardware:this.state.customHardware}}getCanvasShape(){const e=F[this.state.deviceModel];return e&&e.shape?e.shape:this.state.customHardware&&this.state.customHardware.shape?this.state.customHardware.shape:"rect"}}class Mi{constructor(){this.state={selectedWidgetIds:[],clipboardWidgets:[],zoomLevel:1,panX:0,panY:0},this.historyStack=[],this.historyIndex=-1}get selectedWidgetIds(){return this.state.selectedWidgetIds}get clipboardWidgets(){return this.state.clipboardWidgets}get zoomLevel(){return this.state.zoomLevel}setZoomLevel(e){this.state.zoomLevel=Math.max(.05,Math.min(5,e)),O(P.ZOOM_CHANGED,{zoomLevel:this.state.zoomLevel})}setSelectedWidgetIds(e){this.state.selectedWidgetIds=e||[],O(P.SELECTION_CHANGED,{widgetIds:this.state.selectedWidgetIds})}selectWidget(e,n=!1){if(n){const i=this.state.selectedWidgetIds.indexOf(e);i===-1?e&&this.state.selectedWidgetIds.push(e):this.state.selectedWidgetIds.splice(i,1)}else this.state.selectedWidgetIds=e?[e]:[];O(P.SELECTION_CHANGED,{widgetIds:this.state.selectedWidgetIds})}copyWidgets(e){this.state.clipboardWidgets=e.map(n=>Ue(n)),_.log("[EditorStore] Widgets copied to clipboard:",this.state.clipboardWidgets.length)}recordHistory(e){const n=Ue(e);if(this.historyIndex>=0){const i=this.historyStack[this.historyIndex];if(JSON.stringify(i)===JSON.stringify(n))return}this.historyIndex<this.historyStack.length-1&&(this.historyStack=this.historyStack.slice(0,this.historyIndex+1)),this.historyStack.push(n),this.historyIndex++,this.historyStack.length>ht&&(this.historyStack.shift(),this.historyIndex--),O(P.HISTORY_CHANGED,{canUndo:this.canUndo(),canRedo:this.canRedo()})}undo(){return this.canUndo()?(this.historyIndex--,this.historyStack[this.historyIndex]):null}redo(){return this.canRedo()?(this.historyIndex++,this.historyStack[this.historyIndex]):null}canUndo(){return this.historyIndex>0}canRedo(){return this.historyIndex<this.historyStack.length-1}}class Ai{constructor(){this.state={...pt}}get snapEnabled(){return this.state.snapEnabled}get showGrid(){return this.state.showGrid}get showDebugGrid(){return this.state.showDebugGrid}get showRulers(){return this.state.showRulers}get gridOpacity(){return this.state.gridOpacity}get editor_light_mode(){return this.state.editor_light_mode}update(e){this.state={...this.state,...e},O(P.SETTINGS_CHANGED,this.state),_.log("[PreferencesStore] Settings updated")}setSnapEnabled(e){this.state.snapEnabled=e,O(P.SETTINGS_CHANGED,{snapEnabled:e})}setShowGrid(e){this.state.showGrid=e,O(P.SETTINGS_CHANGED,{showGrid:e})}setShowDebugGrid(e){this.state.showDebugGrid=e,O(P.SETTINGS_CHANGED,{showDebugGrid:e})}setShowRulers(e){this.state.showRulers=e,O(P.SETTINGS_CHANGED,{showRulers:e})}}class Di{constructor(){this.keys={ai_api_key_gemini:"",ai_api_key_openai:"",ai_api_key_openrouter:""},this.loadFromLocalStorage()}get(e){return this.keys[e]}set(e,n){e in this.keys&&(this.keys[e]=n,this.saveToLocalStorage())}saveToLocalStorage(){try{const e={};Object.keys(this.keys).forEach(n=>{n.startsWith("ai_api_key_")&&(e[n]=this.keys[n])}),localStorage.setItem("esphome-designer-ai-keys",JSON.stringify(e))}catch(e){_.warn("[SecretsStore] Failed to save AI keys to localStorage:",e)}}loadFromLocalStorage(){try{const e=localStorage.getItem("esphome-designer-ai-keys");if(e){const n=JSON.parse(e);this.keys={...this.keys,...n},_.log("[SecretsStore] AI keys loaded from local storage")}}catch(e){_.warn("[SecretsStore] Failed to load AI keys from localStorage:",e)}}}class Bi{constructor(){this.project=new Pi,this.editor=new Mi,this.preferences=new Ai,this.secrets=new Di,this._isRestoringHistory=!1,this.recordHistory(),Z(P.SETTINGS_CHANGED,e=>{e&&e.renderingMode!==void 0&&this.syncWidgetVisibilityWithMode()})}reset(){this.project.reset(),this.editor.state.selectedWidgetIds=[],this.recordHistory()}get pages(){return this.project.pages}get currentPageIndex(){return this.project.currentPageIndex}get selectedWidgetId(){return this.editor.selectedWidgetIds[0]||null}get selectedWidgetIds(){return this.editor.selectedWidgetIds}get settings(){return{...this.preferences.state,device_name:this.project.deviceName,deviceName:this.project.deviceName,device_model:this.project.deviceModel,deviceModel:this.project.deviceModel,customHardware:this.project.customHardware,custom_hardware:this.project.customHardware,protocolHardware:this.project.protocolHardware,protocol_hardware:this.project.protocolHardware,...this.secrets.keys}}get deviceName(){return this.project.deviceName}get deviceModel(){return this.project.deviceModel}get currentLayoutId(){return this.project.currentLayoutId}get snapEnabled(){return this.preferences.snapEnabled}get showGrid(){return this.preferences.showGrid}get showDebugGrid(){return this.preferences.showDebugGrid}get showRulers(){return this.preferences.showRulers}get zoomLevel(){return this.editor.zoomLevel}getCurrentPage(){return this.project.getCurrentPage()}getWidgetById(e){return this.project.getWidgetById(e)}getSelectedWidget(){return this.project.getWidgetById(this.editor.selectedWidgetIds[0])}getSelectedWidgets(){return this.editor.selectedWidgetIds.map(e=>this.getWidgetById(e)).filter(e=>!!e)}getSelectedProfile(){return F[this.project.deviceModel]||null}getCanvasDimensions(){const e=this.preferences.state.renderingMode||"direct";if(e==="oepl"||e==="opendisplay"){const n=this.project.protocolHardware;return this.preferences.state.orientation==="portrait"?{width:Math.min(n.width,n.height),height:Math.max(n.width,n.height)}:{width:Math.max(n.width,n.height),height:Math.min(n.width,n.height)}}return this.project.getCanvasDimensions(this.preferences.state.orientation)}getCanvasShape(){return this.project.getCanvasShape()}getPagesPayload(){const e={...this.project.getPagesPayload(),currentPageIndex:this.currentPageIndex,...this.settings};return e.device_model=this.project.deviceModel,e.custom_hardware=this.project.customHardware,e.protocol_hardware=this.project.protocolHardware,e}getSettings(){return this.settings}setSettings(e){this.updateSettings(e)}updateProtocolHardware(e){Object.assign(this.project.state.protocolHardware,e),O(P.SETTINGS_CHANGED)}saveToLocalStorage(){if(!q()){const e=this.getPagesPayload();console.log("[saveToLocalStorage] DEBUG renderingMode being saved:",e.renderingMode),localStorage.setItem("esphome-designer-layout",JSON.stringify(e))}}loadFromLocalStorage(){try{const e=localStorage.getItem("esphome-designer-layout"),n=e?JSON.parse(e):null;return console.log("[loadFromLocalStorage] DEBUG raw data exists:",!!e),console.log("[loadFromLocalStorage] DEBUG parsed renderingMode:",n?.renderingMode),console.log("[loadFromLocalStorage] DEBUG parsed rendering_mode:",n?.rendering_mode),n}catch(e){return console.error("[loadFromLocalStorage] Parse error:",e),null}}setPages(e){this.project.setPages(e),this.recordHistory(),O(P.STATE_CHANGED)}reorderWidget(e,n,i){this.project.reorderWidget(e,n,i),this.syncWidgetOrderWithHierarchy(),this.recordHistory(),O(P.STATE_CHANGED)}setCurrentPageIndex(e,n={}){this.project.setCurrentPageIndex(e,n),this.editor.setSelectedWidgetIds([]),O(P.STATE_CHANGED)}reorderPage(e,n){this.project.reorderPage(e,n),this.recordHistory()}addPage(e=null){const n=this.project.addPage(e);return this.recordHistory(),n}deletePage(e){this.project.deletePage(e),this.recordHistory()}selectWidget(e,n){if(!e){this.editor.selectWidget(null,n);return}const i=this.getWidgetById(e),t=i?.parentId||(i?.type==="group"?i.id:null);if(t){const r=this.pages[this.currentPageIndex].widgets.filter(d=>d.parentId===t||d.id===t).map(d=>d.id);if(n)if(r.some(c=>this.editor.selectedWidgetIds.includes(c))){const c=this.editor.selectedWidgetIds.filter(l=>!r.includes(l));this.editor.setSelectedWidgetIds(c)}else this.editor.setSelectedWidgetIds([...new Set([...this.editor.selectedWidgetIds,...r])]);else this.editor.setSelectedWidgetIds(r)}else this.editor.selectWidget(e,n)}selectWidgets(e){this.editor.setSelectedWidgetIds(e)}selectAllWidgets(){const e=this.getCurrentPage();if(!e||!e.widgets)return;const n=e.widgets.map(i=>i.id);this.selectWidgets(n)}updateSettings(e){e.renderingMode!==void 0&&(console.log("[updateSettings] DEBUG renderingMode changing to:",e.renderingMode),console.trace("[updateSettings] Call stack"));const n={},i={};Object.keys(e).forEach(t=>{t.startsWith("ai_api_key_")?n[t]=e[t]:i[t]=e[t]}),Object.keys(n).length&&Object.entries(n).forEach(([t,s])=>this.secrets.set(t,s)),this.preferences.update(i),e.device_name&&(this.project.state.deviceName=e.device_name),e.device_model&&(this.project.state.deviceModel=e.device_model),O(P.STATE_CHANGED)}setDeviceName(e){this.project.state.deviceName=e,this.updateLayoutIndicator(),O(P.STATE_CHANGED)}setDeviceModel(e){this.project.state.deviceModel=e,this.updateLayoutIndicator(),O(P.STATE_CHANGED)}setCurrentLayoutId(e){this.project.state.currentLayoutId=e,this.updateLayoutIndicator(),O(P.STATE_CHANGED)}updateLayoutIndicator(){const e=document.getElementById("currentLayoutName");e&&(e.textContent=this.project.deviceName||this.project.currentLayoutId||"Unknown")}setSnapEnabled(e){this.preferences.setSnapEnabled(e)}setShowGrid(e){this.preferences.setShowGrid(e)}setShowDebugGrid(e){this.preferences.setShowDebugGrid(e)}setShowRulers(e){this.preferences.setShowRulers(e)}setZoomLevel(e){this.editor.setZoomLevel(e)}setCustomHardware(e){this.project.state.customHardware=e,O(P.STATE_CHANGED)}addWidget(e,n=null){this._checkRenderingModeForWidget(e),this.project.addWidget(e,n),this.recordHistory(),this.selectWidget(e.id),O(P.STATE_CHANGED)}updateWidget(e,n){this.project.updateWidget(e,n);const i=this.getWidgetById(e);if(i&&i.type==="group"){const t=["locked","hidden"],s={};if(t.forEach(o=>{n[o]!==void 0&&(s[o]=n[o])}),Object.keys(s).length>0){const o=this.pages[this.currentPageIndex];o&&o.widgets&&o.widgets.filter(d=>d.parentId===e).forEach(d=>this.updateWidget(d.id,s))}}n.parentId!==void 0&&this.syncWidgetOrderWithHierarchy(),O(P.STATE_CHANGED)}updateWidgets(e,n){e.forEach(i=>this.project.updateWidget(i,n)),O(P.STATE_CHANGED)}deleteWidget(e){const n=e?[e]:[...this.editor.selectedWidgetIds],i=[...n];n.forEach(t=>{const s=this.getWidgetById(t);s&&s.type==="group"&&this.pages[this.currentPageIndex].widgets.filter(r=>r.parentId===t).forEach(r=>i.push(r.id))}),this.project.deleteWidgets([...new Set(i)]),this.editor.setSelectedWidgetIds([]),this.recordHistory(),O(P.STATE_CHANGED)}groupSelection(){const e=this.editor.selectedWidgetIds,n=this.getSelectedWidgets(),i=n.some(l=>l.type==="group"||l.parentId);if(e.length<2||i)return;let t=1/0,s=1/0,o=-1/0,r=-1/0;n.forEach(l=>{t=Math.min(t,l.x),s=Math.min(s,l.y),o=Math.max(o,l.x+(l.width||0)),r=Math.max(r,l.y+(l.height||0))});const d="group_"+Se(),c={id:d,type:"group",title:"Group",x:t,y:s,width:o-t,height:r-s,props:{},expanded:!0};this.project.addWidget(c),n.forEach(l=>{this.project.updateWidget(l.id,{parentId:d})}),this.selectWidget(d),this.syncWidgetOrderWithHierarchy(),this.recordHistory(),O(P.STATE_CHANGED)}ungroupSelection(e=null){let n=[];if(e)n=Array.isArray(e)?e:[e];else{const r=this.getSelectedWidgets(),d=new Set;r.forEach(c=>{c.type==="group"?d.add(c.id):c.parentId&&d.add(c.parentId)}),n=[...d]}const i=new Set;n.forEach(r=>{const d=this.getWidgetById(r);d&&(d.type==="group"?i.add(d.id):d.parentId&&i.add(d.parentId))});const t=[...i];if(t.length===0)return;const s=[];t.forEach(r=>{const d=this.getWidgetById(r);if(!d||d.type!=="group")return;this.pages[this.currentPageIndex].widgets.filter(h=>h.parentId===r).forEach(h=>{this.project.updateWidget(h.id,{parentId:null}),s.push(h.id)})}),this.project.deleteWidgets(t);const o=this.pages[this.currentPageIndex];o&&o.widgets&&(o.widgets=o.widgets.filter(r=>!t.includes(r.id))),s.length>0&&this.selectWidgets(s),this.syncWidgetOrderWithHierarchy(),this.recordHistory(),O(P.STATE_CHANGED)}alignSelectedWidgets(e){const n=this.getSelectedWidgets();if(n.length<2)return;let i;switch(e){case"left":i=Math.min(...n.map(o=>o.x)),n.forEach(o=>this.project.updateWidget(o.id,{x:i}));break;case"right":i=Math.max(...n.map(o=>o.x+(o.width||0))),n.forEach(o=>this.project.updateWidget(o.id,{x:i-(o.width||0)}));break;case"center":const t=n.map(o=>o.x+(o.width||0)/2);i=t.reduce((o,r)=>o+r,0)/t.length,n.forEach(o=>this.project.updateWidget(o.id,{x:i-(o.width||0)/2}));break;case"top":i=Math.min(...n.map(o=>o.y)),n.forEach(o=>this.project.updateWidget(o.id,{y:i}));break;case"bottom":i=Math.max(...n.map(o=>o.y+(o.height||0))),n.forEach(o=>this.project.updateWidget(o.id,{y:i-(o.height||0)}));break;case"middle":const s=n.map(o=>o.y+(o.height||0)/2);i=s.reduce((o,r)=>o+r,0)/s.length,n.forEach(o=>this.project.updateWidget(o.id,{y:i-(o.height||0)/2}));break}this.recordHistory(),O(P.STATE_CHANGED)}distributeSelectedWidgets(e){const n=[...this.getSelectedWidgets()];if(!(n.length<3)){if(e==="horizontal"){n.sort((l,h)=>l.x-h.x);const i=n[0],t=n[n.length-1],s=n.reduce((l,h)=>l+(h.width||0),0),d=(t.x+(t.width||0)-i.x-s)/(n.length-1);let c=i.x;for(let l=0;l<n.length;l++)this.project.updateWidget(n[l].id,{x:Math.round(c)}),c+=(n[l].width||0)+d}else{n.sort((l,h)=>l.y-h.y);const i=n[0],t=n[n.length-1],s=n.reduce((l,h)=>l+(h.height||0),0),d=(t.y+(t.height||0)-i.y-s)/(n.length-1);let c=i.y;for(let l=0;l<n.length;l++)this.project.updateWidget(n[l].id,{y:Math.round(c)}),c+=(n[l].height||0)+d}this.recordHistory(),O(P.STATE_CHANGED)}}moveWidgetToPage(e,n,i=null,t=null){const s=this.project.moveWidgetToPage(e,n,i,t);return s&&(this.syncWidgetOrderWithHierarchy(),this.recordHistory(),O(P.STATE_CHANGED)),s}clearCurrentPage(e=!1){const n=this.project.clearCurrentPage(e);return n.deleted>0&&(this.editor.setSelectedWidgetIds([]),this.recordHistory(),O(P.STATE_CHANGED)),n}copyWidget(e){const i=(e?[e]:this.editor.selectedWidgetIds).map(t=>this.getWidgetById(t)).filter(t=>!!t);i.length>0&&this.editor.copyWidgets(i)}pasteWidget(){const e=this.editor.clipboardWidgets;if(!e||e.length===0)return;const n=e.map(i=>{const t=JSON.parse(JSON.stringify(i));return t.id=Se(),t.x+=10,t.y+=10,t});n.forEach(i=>{this._checkRenderingModeForWidget(i),this.project.addWidget(i)}),this.editor.setSelectedWidgetIds(n.map(i=>i.id)),this.recordHistory(),O(P.STATE_CHANGED)}createDropShadow(e){const n=this.getWidgetById(e);if(!n)return;const i=JSON.parse(JSON.stringify(n));i.id=Se(),i.x=(i.x||0)+5,i.y=(i.y||0)+5,i.props||(i.props={});const t=this.project.getCurrentPage(),s=t?t.dark_mode:void 0;let o=!1;s==="dark"?o=!0:s==="light"?o=!1:o=!!this.settings.dark_mode;const r=o?"white":"black";if(i.props.color=r,i.props.border_color=r,i.props.background_color=r,i.props.bg_color=r,i.props.fill=!0,i.props.name&&(i.props.name=i.props.name+" Shadow"),this.project.addWidget(i),["shape_rect","rounded_rect","shape_circle","rectangle","rrect","circle"].includes(n.type)){const h=o?"black":"white";n.props||(n.props={});const g=o?"white":"black",m=n.props.color||g;n.props.border_color||(n.props.border_color=m),n.props.fill=!0,n.props.color=h,n.props.background_color=h,n.props.bg_color=h}const c=t.widgets.findIndex(h=>h.id===e),l=t.widgets.findIndex(h=>h.id===i.id);c!==-1&&l!==-1&&this.project.reorderWidget(this.project.currentPageIndex,l,c),this.recordHistory(),O(P.STATE_CHANGED)}recordHistory(){this._isRestoringHistory||this.editor.recordHistory({pages:this.project.pages,deviceName:this.project.deviceName})}undo(){const e=this.editor.undo();e&&(this._isRestoringHistory=!0,this.restoreSnapshot(e),setTimeout(()=>{this._isRestoringHistory=!1},0))}redo(){const e=this.editor.redo();e&&(this._isRestoringHistory=!0,this.restoreSnapshot(e),setTimeout(()=>{this._isRestoringHistory=!1},0))}restoreSnapshot(e){this.project.state.pages=JSON.parse(JSON.stringify(e.pages)),this.project.state.deviceName=e.deviceName,this.project.rebuildWidgetsIndex(),O(P.STATE_CHANGED)}canUndo(){return this.editor.canUndo()}canRedo(){return this.editor.canRedo()}syncWidgetOrderWithHierarchy(){const e=this.getCurrentPage();if(!e||!e.widgets)return;const n=[...e.widgets],i=n.filter(r=>!r.parentId),t=new Map;n.forEach(r=>{r.parentId&&(t.has(r.parentId)||t.set(r.parentId,[]),t.get(r.parentId).push(r))});const s=[],o=r=>{s.push(r);const d=t.get(r.id);d&&(d.sort((c,l)=>n.indexOf(c)-n.indexOf(l)),d.forEach(o))};i.forEach(o),e.widgets=s,this.project.rebuildWidgetsIndex()}syncWidgetVisibilityWithMode(){const e=this.preferences.state.renderingMode||"direct";_.log(`[AppState] Syncing widget visibility for mode: ${e}`);let n=0;this.project.pages.forEach(i=>{i.widgets.forEach(t=>{const s=this._isWidgetCompatibleWithMode(t,e);!s&&!t.hidden?(t.hidden=!0,n++):s&&t.hidden&&(t.hidden=!1,n++)})}),n>0&&(_.log(`[AppState] Updated ${n} widgets due to mode switch.`),this.project.rebuildWidgetsIndex(),O(P.STATE_CHANGED))}_isWidgetCompatibleWithMode(e,n){const i=PluginRegistry.get(e.type);if(!i)return!0;if(n==="oepl")return!!i.exportOEPL;if(n==="opendisplay")return!!i.exportOpenDisplay;if(n==="lvgl")return e.type&&e.type.startsWith("lvgl_");if(n==="direct"){const t=e.type&&(e.type.startsWith("lvgl_")||e.type.startsWith("oepl_"));return!!i.export&&!t}return!0}_checkRenderingModeForWidget(e){if(!e||!e.type)return;const n=this.preferences.state.renderingMode||"direct",i=e.type.startsWith("lvgl_"),t=e.type.startsWith("oepl_"),s=e.type.startsWith("odp_")||e.type.startsWith("opendisplay_");i&&n==="direct"?(this.updateSettings({renderingMode:"lvgl"}),_.log(`[AppState] Auto-switched to LVGL rendering mode because an LVGL widget (${e.type}) was added.`),z("Auto-switched to LVGL rendering mode","info")):t&&n!=="oepl"?(this.updateSettings({renderingMode:"oepl"}),_.log(`[AppState] Auto-switched to OEPL rendering mode because an OEPL widget (${e.type}) was added.`),z("Auto-switched to OEPL mode","info")):s&&n!=="opendisplay"&&(this.updateSettings({renderingMode:"opendisplay"}),_.log(`[AppState] Auto-switched to OpenDisplay (ODP) mode because an ODP widget (${e.type}) was added.`),z("Auto-switched to ODP mode","info"))}}const ai=new Bi;window.AppState=ai;const u=ai;window.AppState=u;window.ESPHomeDesigner=window.ESPHomeDesigner||{};window.ESPHomeDesigner.state=u;function xt(){if(!window.jsyaml)return null;if(window._esphomeYamlSchema)return window._esphomeYamlSchema;try{const a=new jsyaml.Type("!lambda",{kind:"scalar",construct:function(i){return i}}),e=new jsyaml.Type("!<!lambda>",{kind:"scalar",construct:function(i){return i}}),n=new jsyaml.Type("!secret",{kind:"scalar",construct:function(i){return`!secret ${i}`}});return window._esphomeYamlSchema=jsyaml.DEFAULT_SCHEMA.extend([a,e,n]),window._esphomeYamlSchema}catch(a){return _.error("[getESPHomeSchema] Error creating schema:",a),jsyaml.DEFAULT_SCHEMA}}const Oi=["text","rectangle","circle","icon","qrcode","progress_bar","debug_grid","line","multiline","plot","dlimg","image","rectangle_pattern","polygon","ellipse","arc","icon_sequence"];function Ri(a){const n=a.trim().match(/^-\s*type:\s*(\w+)/);if(n){const i=n[1].toLowerCase();return Oi.includes(i)}return!1}function Wi(a){_.log("[parseOEPLArrayToLayout] Parsing OEPL array with",a.length,"items");const e=[];let n=0;for(const i of a){if(!i||!i.type)continue;const t=i.type.toLowerCase();let s=null;switch(t){case"text":s={id:`oepl_text_${n}`,type:"text",x:parseInt(i.x||0,10),y:parseInt(i.y||0,10),width:parseInt(i.size||20,10)*6,height:parseInt(i.size||20,10)*1.5,title:"",entity_id:"",props:{text:i.value||i.text||"",font_size:parseInt(i.size||20,10),font_family:i.font?i.font.replace(".ttf",""):"Roboto",color:i.fill||i.color||"black"}};break;case"multiline":const o=i.delimiter||"|",d=(i.value||"").split(o).length||1;s={id:`odp_multiline_${n}`,type:"odp_multiline",x:parseInt(i.x||0,10),y:parseInt(i.y||0,10),width:parseInt(i.size||16,10)*10,height:parseInt(i.size||16,10)*d*1.5,title:"",entity_id:"",props:{text:i.value||"Line 1|Line 2",delimiter:o,font_size:parseInt(i.size||16,10),font_family:i.font?i.font.replace(".ttf",""):"Roboto",color:i.fill||i.color||"black",line_spacing:4}};break;case"rectangle":s={id:`oepl_rect_${n}`,type:"shape_rect",x:parseInt(i.x_start||i.x||0,10),y:parseInt(i.y_start||i.y||0,10),width:Math.abs(parseInt(i.x_end||100,10)-parseInt(i.x_start||i.x||0,10)),height:Math.abs(parseInt(i.y_end||50,10)-parseInt(i.y_start||i.y||0,10)),title:"",entity_id:"",props:{fill:i.fill?i.fill!=="white"&&i.fill!=="#ffffff":!1,border_width:parseInt(i.width||1,10),color:i.fill||"white",border_color:i.outline||"black",opacity:100}};break;case"circle":const c=parseInt(i.radius||25,10);s={id:`oepl_circle_${n}`,type:"shape_circle",x:parseInt(i.x||0,10)-c,y:parseInt(i.y||0,10)-c,width:c*2,height:c*2,title:"",entity_id:"",props:{fill:i.fill?i.fill!=="white"&&i.fill!=="#ffffff":!1,border_width:parseInt(i.width||1,10),color:i.fill||"black",border_color:i.outline||i.fill||"black",opacity:100}};break;case"icon":s={id:`oepl_icon_${n}`,type:"icon",x:parseInt(i.x||0,10),y:parseInt(i.y||0,10),width:parseInt(i.size||24,10),height:parseInt(i.size||24,10),title:"",entity_id:"",props:{code:i.value||"mdi:home",size:parseInt(i.size||24,10),color:i.fill||i.color||"black",fit_icon_to_frame:!0}};break;case"qrcode":const l=parseInt(i.boxsize||2,10),g=(25+parseInt(i.border||1,10)*2)*l;s={id:`oepl_qr_${n}`,type:"qr_code",x:parseInt(i.x||0,10),y:parseInt(i.y||0,10),width:g,height:g,title:"",entity_id:"",props:{value:i.data||i.value||"https://esphome.io",scale:l,ecc:"LOW",color:i.color||"black"}};break;case"progress_bar":s={id:`oepl_progress_${n}`,type:"progress_bar",x:parseInt(i.x_start||i.x||0,10),y:parseInt(i.y_start||i.y||0,10),width:Math.abs(parseInt(i.x_end||100,10)-parseInt(i.x_start||i.x||0,10)),height:Math.abs(parseInt(i.y_end||20,10)-parseInt(i.y_start||i.y||0,10)),title:"",entity_id:"",props:{show_label:!1,show_percentage:i.show_percentage===!0||i.show_percentage==="true",bar_height:Math.abs(parseInt(i.y_end||20,10)-parseInt(i.y_start||i.y||0,10)),border_width:parseInt(i.width||1,10),color:i.fill||"black",progress_value:parseInt(i.progress||0,10)}};break;case"line":s={id:`oepl_line_${n}`,type:"line",x:parseInt(i.x_start||i.x||0,10),y:parseInt(i.y_start||i.y||0,10),width:Math.abs(parseInt(i.x_end||100,10)-parseInt(i.x_start||i.x||0,10))||1,height:Math.abs(parseInt(i.y_end||0,10)-parseInt(i.y_start||i.y||0,10))||1,title:"",entity_id:"",props:{stroke_width:parseInt(i.width||1,10),color:i.fill||i.color||"black",orientation:Math.abs(parseInt(i.y_end||0,10)-parseInt(i.y_start||i.y||0,10))>Math.abs(parseInt(i.x_end||100,10)-parseInt(i.x_start||i.x||0,10))?"vertical":"horizontal"}};break;case"debug_grid":_.log("[parseOEPLArrayToLayout] Skipping debug_grid widget");continue;case"dlimg":case"image":s={id:`oepl_img_${n}`,type:"online_image",x:parseInt(i.x||0,10),y:parseInt(i.y||0,10),width:parseInt(i.xsize||i.width||100,10),height:parseInt(i.ysize||i.height||100,10),title:"",entity_id:"",props:{url:i.url||"",invert:!1,interval_s:300}};break;case"plot":s={id:`oepl_graph_${n}`,type:"graph",x:parseInt(i.x_start||i.x||0,10),y:parseInt(i.y_start||i.y||0,10),width:Math.abs(parseInt(i.x_end||200,10)-parseInt(i.x_start||i.x||0,10)),height:Math.abs(parseInt(i.y_end||100,10)-parseInt(i.y_start||i.y||0,10)),title:"",entity_id:i.sensor||"",props:{duration:i.duration||"24h",border:!0,grid:!0,color:i.color||"black"}};break;case"rectangle_pattern":s={id:`odp_rectpat_${n}`,type:"odp_rectangle_pattern",x:parseInt(i.x_start||i.x||0,10),y:parseInt(i.y_start||i.y||0,10),width:Math.abs(parseInt(i.x_end||120,10)-parseInt(i.x_start||i.x||0,10))||120,height:Math.abs(parseInt(i.y_end||80,10)-parseInt(i.y_start||i.y||0,10))||80,title:"",entity_id:"",props:{x_size:parseInt(i.x_size||30,10),y_size:parseInt(i.y_size||15,10),x_offset:parseInt(i.x_offset||5,10),y_offset:parseInt(i.y_offset||5,10),x_repeat:parseInt(i.x_repeat||3,10),y_repeat:parseInt(i.y_repeat||2,10),fill:i.fill||"white",outline:i.outline||"black",border_width:parseInt(i.width||1,10)}};break;case"polygon":if(s={id:`odp_polygon_${n}`,type:"odp_polygon",x:parseInt(i.x||0,10),y:parseInt(i.y||0,10),width:100,height:100,title:"",entity_id:"",props:{points:i.points||[[0,0],[100,0],[100,100],[0,100]],fill:i.fill||"red",outline:i.outline||"black",border_width:parseInt(i.width||1,10)}},Array.isArray(i.points)&&i.points.length){let v=1/0,I=1/0,k=-1/0,M=-1/0;i.points.forEach(([E,x])=>{v=Math.min(v,E),I=Math.min(I,x),k=Math.max(k,E),M=Math.max(M,x)}),s.x=v,s.y=I,s.width=k-v||100,s.height=M-I||100,s.props.points=i.points.map(([E,x])=>[E-v,x-I])}break;case"ellipse":s={id:`odp_ellipse_${n}`,type:"odp_ellipse",x:parseInt(i.x_start||i.x||0,10),y:parseInt(i.y_start||i.y||0,10),width:Math.abs(parseInt(i.x_end||150,10)-parseInt(i.x_start||i.x||0,10))||150,height:Math.abs(parseInt(i.y_end||80,10)-parseInt(i.y_start||i.y||0,10))||80,title:"",entity_id:"",props:{fill:i.fill||null,outline:i.outline||"black",border_width:parseInt(i.width||1,10)}};break;case"arc":const m=parseInt(i.radius||50,10);s={id:`odp_arc_${n}`,type:"odp_arc",x:parseInt(i.x||0,10)-m,y:parseInt(i.y||0,10)-m,width:m*2,height:m*2,title:"",entity_id:"",props:{radius:m,start_angle:parseInt(i.start_angle||0,10),end_angle:parseInt(i.end_angle||90,10),outline:i.outline||"black",border_width:parseInt(i.width||2,10)}};break;case"icon_sequence":const f=parseInt(i.size||24,10),y=parseInt(i.spacing||6,10),b=i.icons||["mdi:home","mdi:arrow-right","mdi:office-building"],w=i.direction==="down";s={id:`odp_iconseq_${n}`,type:"odp_icon_sequence",x:parseInt(i.x||0,10),y:parseInt(i.y||0,10),width:w?f:b.length*(f+y)-y,height:w?b.length*(f+y)-y:f,title:"",entity_id:"",props:{icons:b,size:f,direction:i.direction||"right",spacing:y,fill:i.fill||"black"}};break;default:_.warn(`[parseOEPLArrayToLayout] Unknown OEPL type: ${t}`);continue}s&&(e.push(s),n++)}return _.log(`[parseOEPLArrayToLayout] Created ${e.length} widgets from OEPL array`),{settings:{orientation:"landscape",dark_mode:!1},pages:[{id:"page_0",name:"Page 1",widgets:e}]}}function Et(a){_.log("[parseSnippetYamlOffline] Start parsing with js-yaml...");const e=a.split(/\r?\n/),n=[];let i={};try{window.jsyaml&&(i=jsyaml.load(a,{schema:xt()})||{},_.log("[parseSnippetYamlOffline] YAML parsed successfully with js-yaml"))}catch(x){_.error("[parseSnippetYamlOffline] YAML parse error:",x)}if(Ri(a)&&Array.isArray(i))return _.log("[parseSnippetYamlOffline] Detected bare OEPL array format"),Wi(i);if(i.display&&(Array.isArray(i.display)?i.display:[i.display]).forEach(S=>{S&&S.lambda&&n.push(...S.lambda.split(`
`))}),n.length===0||a.includes("lvgl:")){let x=!1,S=0,L=null;for(const G of e){const W=G.replace(/\t/g,"    "),R=W.trim();if(!x){if(W.match(/^\s*lambda:\s*\|\-/)){x=!0,L="lambda",S=0;continue}else if(W.match(/^\s*lvgl:\s*$/)){x=!0,L="lvgl",S=0;continue}else if(W.match(/^\s*"?(?:open_epaper_link\.drawcustom|payload)"?:\s*(?:\[|\|-)?/)){x=!0,L="oepl",S=0;continue}else if(W.match(/^\s*"actions":\s*\[/)){x=!0,L="odp",S=0;continue}}if(x){const A=W.match(/^(\s*)/),U=A?A[1].length:0;if(R===""){n.push("");continue}if(S===0&&R!==""&&!R.startsWith("#")&&!R.startsWith("//")&&(S=U),R.startsWith("#")||R.startsWith("//")){n.push(W);continue}if(S!==0&&U<S&&R!==""&&(W.match(/^\w+:/)||W.match(/^\s*}/)||U<S)){x=!1;continue}L==="lambda"?n.push(W.slice(S)):n.push(W)}}}_.log(`[parseSnippetYamlOffline] Collected ${n.length} info lines`);const t=new Map,s=new Map,o=new Map,r=new Map,d=new Map,c=new Map,l=new Map,h=new Map,g=(x,S,L)=>{const G=[];let W=S;for(;W<x.length;){const R=x[W];if(!R){W++;continue}const A=R.trim();if(!A||A.startsWith("#")){G.push(R),W++;continue}const U=R.match(/^(\s*)/);if((U?U[1].length:0)<L)break;G.push(R),W++}try{const R=G.join(`
`);return{value:jsyaml.load(R,{schema:xt()}),nextJ:W}}catch(R){return _.error("Error parsing YAML sub-block:",R),{value:null,nextJ:W}}},m=e;let f=null,y=!1;const b=["label","button","arc","bar","slider","chart","dropdown","roller","spinbox","switch","textarea","obj","img","qrcode","led","spinner","line","meter","tabview","tileview","checkbox","keyboard","buttonmatrix","list","icon"],w={label:"lvgl_label",button:"lvgl_button",arc:"lvgl_arc",bar:"lvgl_bar",slider:"lvgl_slider",chart:"lvgl_chart",dropdown:"lvgl_dropdown",roller:"lvgl_roller",spinbox:"lvgl_spinbox",switch:"lvgl_switch",textarea:"lvgl_textarea",obj:"lvgl_obj",img:"lvgl_img",qrcode:"lvgl_qrcode",led:"lvgl_led",spinner:"lvgl_spinner",line:"lvgl_line",meter:"lvgl_meter",tabview:"lvgl_tabview",tileview:"lvgl_tileview",checkbox:"lvgl_checkbox",keyboard:"lvgl_keyboard",buttonmatrix:"lvgl_buttonmatrix",icon:"icon"};for(let x=0;x<n.length;x++){const S=n[x],L=S.trim();if(!L)continue;let G=S.match(/if\s*\(\s*(?:id\s*\(\s*display_page\s*\)|page|currentPage)\s*==\s*(\d+)\s*\)/);G&&(f=parseInt(G[1],10),y=!1,t.has(f)||t.set(f,[]));const W=S.match(/^\s*-\s*id:\s*(\w+)/);if(W){const T=W[1],K=T.match(/^page_(\d+)$/);let H=K?parseInt(K[1],10):t.size;t.has(H)||(t.set(H,[]),o.set(H,T)),f=H,y=!1,_.log(`[parseSnippetYamlOffline] Detected LVGL Page: ${T} (mapped to idx ${H})`)}const R=S.match(/^\s*layout:\s*(\d+x\d+)/);if(R&&f!==null&&(h.set(f,R[1]),_.log(`[parseSnippetYamlOffline] Detected layout: ${R[1]} for page ${f}`)),L.startsWith("widgets:")){y=!0;continue}const A=S.match(/case\s+(\d+):\s*interval\s*=\s*(\d+);/);if(A){const T=parseInt(A[1],10),K=parseInt(A[2],10);s.set(T,K),t.has(T)||t.set(T,[])}const U=S.match(/\/\/\s*page:name\s+"(.+)"/);U&&f!==null&&o.set(f,U[1]);const J=S.match(/\/\/\s*page:dark_mode\s+"(.+)"/);J&&f!==null&&r.set(f,J[1]);const j=S.match(/\/\/\s*page:refresh_type\s+"(.+)"/);j&&f!==null&&d.set(f,j[1]);const p=S.match(/\/\/\s*page:refresh_time\s+"(.*)"/);if(p&&f!==null&&c.set(f,p[1]),!y){const T=S.match(/^\s*bg_color:\s*(.*)/);if(T&&f!==null){let H=T[1].trim().replace(/^["']|["']$/g,"");if(H.startsWith("0x")&&(H="#"+H.substring(2)),l.has(f)||l.set(f,{}),l.get(f).bg_color=H,H.startsWith("#")){const C=H.substring(1);if(C.length===6){const ee=parseInt(C.substring(0,2),16),Y=parseInt(C.substring(2,4),16),$=parseInt(C.substring(4,6),16);(ee*299+Y*587+$*114)/1e3<128&&(r.has(f)||r.set(f,"dark"))}}}const K=S.match(/^\s*bg_opa:\s*(.*)/);if(K&&f!==null){let H=K[1].trim().replace(/^["']|["']$/g,"");H.endsWith("%")&&(H=String(Math.round(parseFloat(H)*2.55))),l.has(f)||l.set(f,{}),l.get(f).bg_opa=parseInt(H,10)}}}const v={orientation:"landscape",dark_mode:!1,sleep_enabled:!1,sleep_start_hour:0,sleep_end_hour:5,manual_refresh_only:!1,deep_sleep_enabled:!1,deep_sleep_interval:600,daily_refresh_enabled:!1,daily_refresh_time:"08:00",refresh_interval:600};for(const x of m){const S=x.trim();if(!S.startsWith("#"))continue;let L;if((L=S.match(/TARGET DEVICE:\s*(.*)/i))&&(v.target_device=L[1].trim()),(L=S.match(/Name:\s*(.*)/i))&&(v.name=L[1].trim()),(L=S.match(/Resolution:\s*(\d+)x(\d+)/i))&&(v.width=parseInt(L[1],10),v.height=parseInt(L[2],10)),(L=S.match(/Shape:\s*(rect|round|circle)/i))&&(v.shape=L[1].toLowerCase()==="rect"?"rect":"round"),(L=S.match(/Inverted:\s*(true|false)/i))&&(v.inverted_colors=L[1].toLowerCase()==="true"),(L=S.match(/Orientation:\s*(landscape|portrait)/i))&&(v.orientation=L[1].toLowerCase()),(L=S.match(/Dark Mode:\s*(enabled|disabled)/i))&&(v.dark_mode=L[1].toLowerCase()==="enabled"),(L=S.match(/Refresh Interval:\s*(\d+)/i))&&(v.refresh_interval=parseInt(L[1],10)),L=S.match(/Power Strategy:\s*(.*)/i)){const G=L[1].trim().toLowerCase();v.sleep_enabled=G.includes("night"),v.manual_refresh_only=G.includes("manual"),v.deep_sleep_enabled=G.includes("ultra")||G.includes("deep"),v.daily_refresh_enabled=G.includes("daily")}(L=S.match(/Sleep Mode:\s*(enabled|disabled)/i))&&(v.sleep_enabled=L[1].toLowerCase()==="enabled"),(L=S.match(/Sleep Start Hour:\s*(\d+)/i))&&(v.sleep_start_hour=parseInt(L[1],10)),(L=S.match(/Sleep End Hour:\s*(\d+)/i))&&(v.sleep_end_hour=parseInt(L[1],10)),(L=S.match(/Manual Refresh:\s*(enabled|disabled)/i))&&(v.manual_refresh_only=L[1].toLowerCase()==="enabled"),(L=S.match(/Deep Sleep:\s*(enabled|disabled)/i))&&(v.deep_sleep_enabled=L[1].toLowerCase()==="enabled"),(L=S.match(/Deep Sleep Interval:\s*(\d+)/i))&&(v.deep_sleep_interval=parseInt(L[1],10)),(L=S.match(/Refresh Time:\s*(\d{2}:\d{2})/i))&&(v.daily_refresh_time=L[1]),(L=S.match(/Disable updates from\s*(\d+)\s*to\s*(\d+)/i))&&(v.no_refresh_start_hour=parseInt(L[1],10),v.no_refresh_end_hour=parseInt(L[2],10))}t.size===0&&t.set(0,[]);const I={settings:v,pages:Array.from(t.entries()).sort((x,S)=>x[0]-S[0]).map(([x,S])=>({id:`page_${x}`,name:o.has(x)?o.get(x):`Page ${x+1}`,refresh_s:s.has(x)?s.get(x):null,refresh_type:d.has(x)?d.get(x):"interval",refresh_time:c.has(x)?c.get(x):"",dark_mode:r.has(x)?r.get(x):"inherit",layout:h.has(x)?h.get(x):null,bg_color:l.has(x)?l.get(x).bg_color:null,bg_opa:l.has(x)?l.get(x).bg_opa:null,widgets:[]}))};f=0;function k(){const x=I.pages.find((S,L)=>L===f);return x?x.widgets:I.pages[0].widgets}function M(x){const S=x.match(/^(?:#\s*|\/\/\s*)widget:(\w+)\s+(.+)$/);if(!S)return(x.startsWith("// widget:")||x.startsWith("# widget:"))&&_.warn("[parseWidgetMarker] Regex failed for:",x),null;const L=S[1],G=S[2],W={};_.log(`[parseWidgetMarker] Found widget: ${L}`);const R=/(\w+):(?:"([^"]*)"|([^:]*?)(?=\s+\w+:|$))/g;let A;for(;(A=R.exec(G))!==null;){let U=A[2]!==void 0?A[2]:A[3];U&&(U=U.trim()),W[A[1]]=U}return{widgetType:L,props:W}}let E=!1;for(let x=0;x<n.length;x++){const S=n[x],L=S.trim();if(!L||L.startsWith("#")&&!L.match(/^#\s*widget:/))continue;let G=L.match(/if\s*\(\s*(?:id\s*\(\s*display_page\s*\)|page|currentPage)\s*==\s*(\d+)\s*\)/);if(G){f=parseInt(G[1],10);continue}const W=L.match(/^-\s*id:\s*(\w+)/);if(W){const j=W[1],p=j.match(/^page_(\d+)$/);f=p?parseInt(p[1],10):Array.from(o.entries()).find(([T,K])=>K===j)?.[0]||0,_.log(`[parseSnippetYamlOffline] Processing widgets for page: ${j} (idx ${f})`);continue}const R=k();if(E)if(L.match(/^(?:#\s*|\/\/\s*)widget:/)||L.match(/^\s*-\s*id:/)||!S.match(/^\s/))E=!1;else continue;if(L.startsWith("//")||L.startsWith("#")){const j=M(L);if(j&&j.props.id){const p=j.props,T=j.widgetType||p.type;if(!T){_.warn("[parseSnippetYamlOffline] Widget marker found but no type determined:",L);continue}let K=100,H=30;T==="template_nav_bar"?(K=200,H=50):T==="touch_area"?(K=100,H=100):["nav_next_page","nav_previous_page","nav_reload_page"].includes(T)?(K=80,H=80):(T==="battery_icon"||T==="wifi_signal"||T==="icon")&&(K=60,H=60);const C={id:p.id,type:T,x:parseInt(p.x||0,10),y:parseInt(p.y||0,10),width:parseInt(p.w||K,10),height:parseInt(p.h||H,10),title:p.title||"",entity_id:p.entity||p.ent||"",condition_entity:p.cond_ent||"",condition_operator:p.cond_op||"",condition_state:p.cond_state||"",condition_min:p.cond_min||"",condition_max:p.cond_max||"",props:{}};if(T.startsWith("lvgl_")){Object.entries(p).forEach(([$,D])=>{["id","type","x","y","w","h","width","height"].includes($)||(D==="true"?C.props[$]=!0:D==="false"?C.props[$]=!1:C.props[$]=D)}),C.props.hidden=p.hidden==="true",C.props.clickable=p.clickable!=="false",C.props.checkable=p.checkable==="true",C.props.scrollable=p.scrollable!=="false",C.props.floating=p.floating==="true",C.props.ignore_layout=p.ignore_layout==="true",C.props.scrollbar_mode=p.scrollbar_mode||"AUTO",C.props.opa=parseInt(p.opa||255,10);const ee=p.grid_cell_row_pos??p.grid_row,Y=p.grid_cell_column_pos??p.grid_col;C.props.grid_cell_row_pos=ee!=null?parseInt(ee,10):null,C.props.grid_cell_column_pos=Y!=null?parseInt(Y,10):null,C.props.grid_cell_row_span=parseInt(p.grid_cell_row_span||p.grid_row_span||1,10),C.props.grid_cell_column_span=parseInt(p.grid_cell_column_span||p.grid_col_span||1,10),C.props.grid_cell_x_align=p.grid_cell_x_align||p.grid_x_align||"STRETCH",C.props.grid_cell_y_align=p.grid_cell_y_align||p.grid_y_align||"STRETCH"}if(T==="icon")C.props={code:p.code||"F0595",size:parseInt(p.size||48,10),color:p.color||"black",fit_icon_to_frame:p.fit==="true"||p.fit==="1"};else if(T==="text"||T==="label")C.props={text:p.text||"",font_size:parseInt(p.font_size||p.size||20,10),font_family:p.font_family||p.font||"Roboto",font_weight:parseInt(p.font_weight||p.weight||400,10),italic:p.italic==="true"||p.italic===!0,bpp:parseInt(p.bpp||1,10),color:p.color||"black",text_align:p.align||p.text_align||"TOP_LEFT"};else if(T==="sensor_text")C.props={label_font_size:parseInt(p.label_font||p.label_font_size||14,10),value_font_size:parseInt(p.value_font||p.value_font_size||20,10),value_format:p.format||"label_value",color:p.color||"black",italic:p.italic==="true"||p.italic===!0||p.font_style==="italic",font_family:p.font_family||"Roboto",font_weight:parseInt(p.font_weight||400,10),prefix:p.prefix||"",postfix:p.postfix||"",unit:p.unit||"",hide_unit:p.hide_unit==="true"||p.hide_unit===!0,precision:parseInt(p.precision||-1,10),text_align:p.align||p.text_align||"TOP_LEFT",label_align:p.label_align||p.align||p.text_align||"TOP_LEFT",value_align:p.value_align||p.align||p.text_align||"TOP_LEFT",is_local_sensor:p.local==="true",is_text_sensor:p.text_sensor==="true",separator:p.separator||" ~ "},C.entity_id_2=p.entity_2||"";else if(T==="datetime")C.width=parseInt(p.w||200,10),C.height=parseInt(p.h||60,10),C.props={format:p.format||"time_date",time_font_size:parseInt(p.time_font_size||p.time_size||p.time_font||28,10),date_font_size:parseInt(p.date_font_size||p.date_size||p.date_font||16,10),color:p.color||"black",italic:p.italic==="true"||p.italic===!0||p.font_style==="italic",font_family:p.font_family||"Roboto",text_align:p.align||p.text_align||"CENTER"};else if(T==="progress_bar")C.props={show_label:p.show_label!=="false",show_percentage:p.show_pct!=="false",bar_height:parseInt(p.bar_h||p.bar_height||15,10),border_width:parseInt(p.border_w||p.border||1,10),color:p.color||"black",is_local_sensor:p.local==="true"};else if(T==="battery_icon")C.props={size:parseInt(p.size||32,10),font_size:parseInt(p.font_size||12,10),color:p.color||"black",is_local_sensor:p.local==="true",fit_icon_to_frame:p.fit==="true"||p.fit==="1"};else if(T==="wifi_signal")C.props={size:parseInt(p.size||24,10),font_size:parseInt(p.font_size||12,10),color:p.color||"black",is_local_sensor:p.local!=="false",show_dbm:p.show_dbm!=="false",fit_icon_to_frame:p.fit==="true"||p.fit==="1"};else if(T==="ondevice_temperature")C.props={size:parseInt(p.size||32,10),font_size:parseInt(p.font_size||16,10),label_font_size:parseInt(p.label_font_size||10,10),color:p.color||"black",unit:p.unit||"C",precision:parseInt(p.precision||1,10),show_label:p.show_label!=="false",is_local_sensor:p.local!=="false",fit_icon_to_frame:p.fit==="true"||p.fit==="1"};else if(T==="ondevice_humidity")C.props={size:parseInt(p.size||32,10),font_size:parseInt(p.font_size||16,10),label_font_size:parseInt(p.label_font_size||10,10),color:p.color||"black",unit:p.unit||"%",precision:parseInt(p.precision||0,10),show_label:p.show_label!=="false",is_local_sensor:p.local!=="false",fit_icon_to_frame:p.fit==="true"||p.fit==="1"};else if(T==="weather_icon")C.props={size:parseInt(p.size||48,10),color:p.color||"black"};else if(T==="qr_code")C.props={value:p.value||"https://esphome.io",scale:parseInt(p.scale||2,10),ecc:p.ecc||"LOW",color:p.color||"black"};else if(T==="image")C.props={path:(p.path||"").replace(/^"|"$/g,""),invert:p.invert==="true"||p.invert==="1",dither:p.dither||"FLOYDSTEINBERG",transparency:p.transparency||"",image_type:p.img_type||"BINARY",render_mode:p.render_mode||"Auto"};else if(T==="online_image")C.props={url:p.url||"",invert:p.invert==="true"||p.invert==="1",interval_s:parseInt(p.interval||300,10),render_mode:p.render_mode||"Auto"};else if(T==="puppet")C.props={image_url:p.url||"",invert:p.invert==="true"||p.invert==="1",image_type:p.img_type||"RGB565",transparency:p.transparency||"opaque",render_mode:p.render_mode||"Auto"};else if(T==="shape_rect")C.props={fill:p.fill==="true"||p.fill==="1",border_width:parseInt(p.border||1,10),color:p.color||"black",border_color:p.border_color||p.color||"black",opacity:parseInt(p.opacity||100,10)};else if(T==="touch_area")C.props={title:p.title||"Touch Area",color:p.color||"rgba(0, 0, 255, 0.2)",border_color:p.border_color||"#0000ff",icon:p.icon||"",icon_pressed:p.icon_pressed||"",icon_size:parseInt(p.icon_size||40,10),icon_color:p.icon_color||"black",nav_action:p.nav_action||"none"};else if(T==="rounded_rect")C.props={fill:p.fill==="true"||p.fill==="1",show_border:p.show_border!=="false"&&p.show_border!=="0",border_width:parseInt(p.border||4,10),radius:parseInt(p.radius||10,10),color:p.color||"black",border_color:p.border_color||"black",opacity:parseInt(p.opacity||100,10)};else if(T==="shape_circle")C.props={fill:p.fill==="true"||p.fill==="1",border_width:parseInt(p.border||1,10),color:p.color||"black",border_color:p.border_color||p.color||"black",opacity:parseInt(p.opacity||100,10)};else if(T==="line")C.props={stroke_width:parseInt(p.stroke||3,10),color:p.color||"black",orientation:p.orientation||"horizontal"};else if(T==="graph")C.entity_id=p.entity||"",C.props={duration:p.duration||"1h",border:p.border==="true"||p.border==="1"||p.border==null,grid:p.grid==="true"||p.grid==="1"||p.grid==null,color:p.color||"black",x_grid:p.x_grid||"",y_grid:p.y_grid||"",line_thickness:parseInt(p.line_thickness||3,10),line_type:p.line_type||"SOLID",continuous:p.continuous!=="false"&&p.continuous!=="0",min_value:p.min_value||"",max_value:p.max_value||"",min_range:p.min_range||"",max_range:p.max_range||"",is_local_sensor:p.local==="true"};else if(T==="quote_rss")C.props={feed_url:p.feed_url||"https://www.brainyquote.com/link/quotebr.rss",show_author:p.show_author!=="false",random:p.random!=="false",refresh_interval:p.refresh_interval||p.refresh||"24h",quote_font_size:parseInt(p.quote_font_size||p.quote_font||18,10),author_font_size:parseInt(p.author_font_size||p.author_font||14,10),font_family:p.font_family||p.font||"Roboto",font_weight:parseInt(p.font_weight||p.weight||400,10),color:p.color||"black",text_align:p.align||p.text_align||"TOP_LEFT",word_wrap:p.word_wrap!=="false"&&p.wrap!=="false",italic_quote:p.italic_quote!=="false"};else if(T==="weather_forecast")C.props={weather_entity:p.weather_entity||"",layout:p.layout||"horizontal",show_high_low:p.show_high_low!=="false",day_font_size:parseInt(p.day_font_size||12,10),temp_font_size:parseInt(p.temp_font_size||14,10),icon_size:parseInt(p.icon_size||32,10),font_family:p.font_family||"Roboto",color:p.color||"black"};else if(T==="template_sensor_bar")C.props={show_wifi:p.wifi!=="false",show_temperature:p.temp!=="false",show_humidity:p.hum!=="false",show_battery:p.bat!=="false",show_background:p.bg!=="false",background_color:p.bg_color||"gray",border_radius:parseInt(p.radius||8,10),icon_size:parseInt(p.icon_size||20,10),font_size:parseInt(p.font_size||14,10),color:p.color||"black"};else if(T==="template_nav_bar")C.props={show_prev:p.prev!=="false",show_home:p.home!=="false",show_next:p.next!=="false",show_background:p.bg!=="false",background_color:p.bg_color||"gray",border_radius:parseInt(p.radius||8,10),icon_size:parseInt(p.icon_size||24,10),color:p.color||"black"};else if(T==="lvgl_button")_.log("[YAML_IMPORT] Parsing lvgl_button",p.id,p),C.props={...C.props,text:p.text||"BTN",bg_color:p.bg_color||"white",color:p.color||"black",border_width:parseInt(p.border_width||p.border||2,10),radius:parseInt(p.radius||5,10),checkable:p.checkable==="true"},p.title&&(C.title=p.title);else if(T==="lvgl_arc")C.props={...C.props,min:parseInt(p.min||0,10),max:parseInt(p.max||100,10),value:parseInt(p.value||0,10),thickness:parseInt(p.thickness||10,10),color:p.color||"blue",start_angle:parseInt(p.start_angle||135,10),end_angle:parseInt(p.end_angle||45,10),mode:p.mode||"NORMAL"},p.title&&(C.title=p.title,C.props.title=p.title);else if(T==="lvgl_chart")C.props={...C.props,title:p.title||"Graph",type:p.type||"LINE",color:p.color||"black",bg_color:p.bg_color||"white",point_count:parseInt(p.point_count||10,10),x_div_lines:parseInt(p.x_div_lines||3,10),y_div_lines:parseInt(p.y_div_lines||3,10)},p.title&&(C.title=p.title);else if(T==="lvgl_img")C.props={...C.props,src:p.src||"symbol_image",rotation:parseInt(p.rotation||0,10),scale:parseInt(p.scale||256,10),pivot_x:parseInt(p.pivot_x||0,10),pivot_y:parseInt(p.pivot_y||0,10),color:p.color||"black"};else if(T==="lvgl_qrcode")C.props={...C.props,text:p.text||"https://esphome.io",scale:parseInt(p.scale||2,10),color:p.color||"black",bg_color:p.bg_color||"white"};else if(T==="lvgl_bar")C.props={...C.props,min:parseInt(p.min||0,10),max:parseInt(p.max||100,10),value:parseInt(p.value||0,10),color:p.color||"blue",bg_color:p.bg_color||"gray",start_value:parseInt(p.start_value||0,10),mode:p.mode||"NORMAL"};else if(T==="lvgl_slider")C.props={...C.props,min:parseInt(p.min||0,10),max:parseInt(p.max||100,10),value:parseInt(p.value||30,10),border_width:parseInt(p.border_width||2,10),color:p.color||"blue",bg_color:p.bg_color||"gray",mode:p.mode||"NORMAL",vertical:p.vertical==="true"||p.vertical===!0};else if(T==="lvgl_tabview")C.props={...C.props,bg_color:p.bg_color||"white",tabs:(p.tabs||"").split(",").map(ee=>ee.trim()).filter(ee=>ee)};else if(T==="lvgl_tileview")C.props={...C.props,bg_color:p.bg_color||"white",tiles:[]};else if(T==="lvgl_led")C.props={...C.props,color:p.color||"red",brightness:parseInt(p.brightness||255,10)};else if(T==="lvgl_spinner")C.props={...C.props,spin_time:parseInt(p.spin_time||1e3,10),arc_length:parseInt(p.arc_length||60,10),arc_color:p.arc_color||"blue",track_color:p.track_color||"white"};else if(T==="lvgl_buttonmatrix")C.props={...C.props,rows:[]};else if(T==="lvgl_checkbox")C.props={...C.props,text:(p.text||"Checkbox").replace(/^"|"$/g,""),checked:p.checked==="true"||p.checked===!0,color:p.color||"blue"};else if(T==="lvgl_dropdown")C.props={...C.props,options:(p.options||"").replace(/\\n/g,`
`),selected_index:parseInt(p.selected_index||0,10),color:p.color||"white",direction:p.direction||"DOWN",max_height:parseInt(p.max_height||200,10)};else if(T==="lvgl_keyboard")C.props={...C.props,mode:p.mode||"TEXT_UPPER",textarea_id:p.textarea||""};else if(T==="lvgl_roller")C.props={...C.props,options:(p.options||"").replace(/\\n/g,`
`),visible_row_count:parseInt(p.visible_row_count||3,10),color:p.color||"white",bg_color:p.bg_color||"black",selected_bg_color:p.selected_bg_color||"blue",selected_text_color:p.selected_text_color||"white",mode:p.mode||"NORMAL"};else if(T==="lvgl_spinbox")C.props={...C.props,min:parseInt(p.range_from||p.min||0,10),max:parseInt(p.range_to||p.max||100,10),digit_count:parseInt(p.digits||p.digit_count||4,10),step:parseInt(p.step||1,10),value:parseInt(p.value||0,10)};else if(T==="lvgl_switch")C.props={...C.props,checked:p.state==="true"||p.state===!0||p.checked==="true",bg_color:p.bg_color||"gray",color:p.color||"blue",knob_color:p.knob_color||"white"};else if(T==="lvgl_textarea")C.props={...C.props,placeholder:(p.placeholder_text||p.placeholder||"").replace(/^"|"$/g,""),text:(p.text||"").replace(/^"|"$/g,""),one_line:p.one_line==="true"||p.one_line===!0,max_length:parseInt(p.max_length||0,10),password_mode:p.password_mode==="true",accepted_chars:p.accepted_chars||""};else if(T==="lvgl_label")C.props={...C.props,text:(p.text||"Label").replace(/^"|"$/g,""),font_size:parseInt(p.font_size||p.size||20,10),font_family:p.font_family||"Roboto",font_weight:parseInt(p.font_weight||400,10),italic:p.italic==="true"||p.italic===!0,color:p.color||"black",bg_color:p.bg_color||"transparent",text_align:p.text_align||p.align||"CENTER"};else if(T==="lvgl_line")C.props={...C.props,orientation:p.orientation||"horizontal",points:p.points||"",line_width:parseInt(p.line_width||3,10),line_color:p.line_color||p.color||"black",line_rounded:p.line_rounded!=="false"};else if(T==="lvgl_meter")C.props={...C.props,min:parseInt(p.min||0,10),max:parseInt(p.max||100,10),value:parseInt(p.value||60,10),color:p.color||"black",indicator_color:p.indicator_color||"red",tick_count:parseInt(p.tick_count||11,10),tick_length:parseInt(p.tick_length||10,10),label_gap:parseInt(p.label_gap||10,10),scale_width:parseInt(p.scale_width||10,10),indicator_width:parseInt(p.indicator_width||4,10)};else if(T==="lvgl_obj")C.props={...C.props,color:p.color||"white",border_width:parseInt(p.border_width||1,10),border_color:p.border_color||"gray",radius:parseInt(p.radius||0,10)};else if(T.startsWith("lvgl_")){_.log("[YAML_IMPORT] Parsing generic LVGL",T,p.id,p);const ee=C.props||{};C.props={...ee};const Y=["hidden","clickable","checkable","scrollable","floating","ignore_layout","scrollbar_mode","opa","grid_cell_row_pos","grid_cell_column_pos","grid_cell_row_span","grid_cell_column_span","grid_cell_x_align","grid_cell_y_align"];Object.entries(p).forEach(([$,D])=>{if(!($==="id"||$==="type"||$==="x"||$==="y"||$==="w"||$==="h")&&!Y.includes($)){if($==="title"){C.title=D;return}D==="true"?C.props[$]=!0:D==="false"?C.props[$]=!1:Array.isArray(D)?$==="options"?C.props[$]=D.join(`
`):$==="points"?C.props[$]=D.map(B=>Array.isArray(B)?B.join(","):String(B)).join(" "):C.props[$]=D:C.props[$]=D}})}else T==="calendar"&&(_.log("[YAML_IMPORT] Parsing calendar",p.id,p),C.props={entity_id:p.entity||"sensor.esp_calendar_data",border_width:parseInt(p.border_width||2,10),show_border:p.show_border!=="false",border_color:p.border_color||"black",background_color:p.background_color||"white",text_color:p.text_color||"black",font_size_date:parseInt(p.font_size_date||100,10),font_size_day:parseInt(p.font_size_day||24,10),font_size_grid:parseInt(p.font_size_grid||14,10),font_size_event:parseInt(p.font_size_event||18,10)});R.push(C),E=!0;continue}continue}let A;if(A=L.match(/^it\.rectangle\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*COLOR_OFF)?\s*\)\s*;?/),A){R.push({id:"w_rect_"+R.length,type:"shape_rect",x:parseInt(A[1],10),y:parseInt(A[2],10),width:parseInt(A[3],10),height:parseInt(A[4],10),title:"",entity_id:"",props:{fill:!1,border_width:1,color:"black",opacity:100}});continue}if(A=L.match(/^it\.filled_rectangle\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*COLOR_OFF)?\s*\)\s*;?/),A){R.push({id:"w_frect_"+R.length,type:"shape_rect",x:parseInt(A[1],10),y:parseInt(A[2],10),width:parseInt(A[3],10),height:parseInt(A[4],10),title:"",entity_id:"",props:{fill:!0,border_width:1,color:"black",opacity:100}});continue}if(A=L.match(/^it\.circle\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*COLOR_OFF)?\s*\)\s*;?/),A){const j=parseInt(A[3],10);R.push({id:"w_circle_"+R.length,type:"shape_circle",x:parseInt(A[1],10)-j,y:parseInt(A[2],10)-j,width:j*2,height:j*2,title:"",entity_id:"",props:{fill:!1,border_width:1,color:"black",opacity:100}});continue}if(A=L.match(/^it\.filled_circle\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*COLOR_OFF)?\s*\)\s*;?/),A){const j=parseInt(A[3],10);R.push({id:"w_fcircle_"+R.length,type:"shape_circle",x:parseInt(A[1],10)-j,y:parseInt(A[2],10)-j,width:j*2,height:j*2,title:"",entity_id:"",props:{fill:!0,border_width:1,color:"black",opacity:100}});continue}if(A=L.match(/^it\.line\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)\s*;?/),A){const j=parseInt(A[1],10),p=parseInt(A[2],10),T=parseInt(A[3],10),K=parseInt(A[4],10);R.push({id:"w_line_"+R.length,type:"line",x:j,y:p,width:T-j,height:K-p,title:"",entity_id:"",props:{stroke_width:1,color:"black",orientation:Math.abs(K-p)>Math.abs(T-j)?"vertical":"horizontal"}});continue}const U=new RegExp(`^(\\s*)-?\\s*(${b.join("|")}):\\s*(.*)$`),J=S.match(U);if(J){const j=J[1].length,p=J[2],T=J[3].trim(),K=w[p]||`lvgl_${p}`,H={};T&&(H._inline=T.replace(/^["']|["']$/g,""));const C=g(n,x+1,j+2);Object.assign(H,C.value),x=C.nextJ-1;const Y={id:H.id||`lv_${p}_${R.length}`,type:K,x:parseInt(H.x||0,10),y:parseInt(H.y||0,10),width:parseInt(H.width||H.w||100,10),height:parseInt(H.height||H.h||30,10),title:H.title||H.name||"",entity_id:H.entity_id||H.entity||H.sensor||"",props:{}};if(Y.props.hidden=H.hidden==="true",Y.props.clickable=H.clickable!=="false",Y.props.scrollable=H.scrollable!=="false",H.bg_color&&(Y.props.bg_color=H.bg_color),H.bg_opa){let $=H.bg_opa;$.toString().endsWith("%")&&($=Math.round(parseFloat($)*2.55)),Y.props.opa=parseInt($,10)}H.text?Y.props.text=H.text:H._inline&&p==="label"&&(Y.props.text=H._inline),Object.entries(H).forEach(([$,D])=>{if(["id","x","y","width","height","w","h","type","bg_color","bg_opa","_inline","widgets"].includes($))return;if(($==="indicator"||$==="knob"||$==="selected")&&typeof D=="object"&&D!==null&&!Array.isArray(D)){Object.entries(D).forEach(([X,ie])=>{Y.props[`${$}_${X}`]=ie});return}let B=D;if(Array.isArray(D)?$==="options"?B=D.join(`
`):$==="points"&&(B=D.map(X=>Array.isArray(X)?X.join(","):String(X)).join(" ")):typeof D=="string"&&/^-?\d+(\.\d+)?(ms|deg|px|%)$/.test(D)&&(B=D.replace(/(ms|deg|px|%)$/,"")),Y.props[$]===void 0)if(B==="true")Y.props[$]=!0;else if(B==="false")Y.props[$]=!1;else if(!isNaN(B)&&B!==""&&$!=="text"&&$!=="id"&&$!=="name"&&typeof B!="object")Y.props[$]=parseFloat(B);else if(typeof B=="string"&&B.includes("\\u"))try{Y.props[$]=JSON.parse(`"${B}"`)}catch{Y.props[$]=B}else Y.props[$]=B}),R.push(Y),Array.isArray(H.widgets)&&H.widgets.forEach($=>{const D=Object.keys($)[0],B=$[D];if(D&&B){const X=w[D]||`lvgl_${D}`,ie={id:B.id||`lv_${D}_${R.length}`,type:X,x:Y.x+parseInt(B.x||0,10),y:Y.y+parseInt(B.y||0,10),width:parseInt(B.width||B.w||50,10),height:parseInt(B.height||B.h||20,10),props:{...B}};R.push(ie)}})}}return I}function le(a){if(!a)throw _.error("Invalid layout - null or undefined"),new Error("invalid_layout");if(a.data&&a.data.devices){const y=Object.keys(a.data.devices);if(y.length>0){const b=y[0];_.log(`[loadLayoutIntoState] Detected legacy HA storage format. unwrapping device: ${b}`),a=a.data.devices[b]}}if(!Array.isArray(a.pages))throw _.error("Invalid layout - missing pages array"),new Error("invalid_layout");const e=a.pages.map((y,b)=>({...y,id:y.id||`page_${b}`,name:y.name||`Page ${b+1}`,widgets:Array.isArray(y.widgets)?y.widgets:[]}));e.length||(_.warn("No pages, creating default empty page"),e.push({id:"page_0",name:"Imported",widgets:[]}));const n=a.device_id||a.currentLayoutId;if(n){const y=u.currentLayoutId;y!==n&&(_.log(`[loadLayoutIntoState] Updating currentLayoutId: ${y} -> ${n}`),u.setCurrentLayoutId(n))}else _.log(`[loadLayoutIntoState] No device_id in layout, keeping currentLayoutId: ${u.currentLayoutId}`);const i=a.name||a.deviceName;i&&u.setDeviceName(i);const t=a.device_model||a.deviceModel||(a.settings?a.settings.device_model||a.settings.deviceModel:null);t&&u.setDeviceModel(t);const s=a.custom_hardware||a.customHardware;s&&u.setCustomHardware(s);const o=a.protocol_hardware||a.protocolHardware;o&&u.updateProtocolHardware(o);const r=u.getSettings(),d=a.settings||{},c={orientation:"orientation",dark_mode:"darkMode",darkMode:"darkMode",sleep_enabled:"sleepEnabled",sleepEnabled:"sleepEnabled",sleep_start_hour:"sleepStartHour",sleepStartHour:"sleepStartHour",sleep_end_hour:"sleepEndHour",sleepEndHour:"sleepEndHour",manual_refresh_only:"manualRefreshOnly",manualRefreshOnly:"manualRefreshOnly",deep_sleep_enabled:"deepSleepEnabled",deepSleepEnabled:"deepSleepEnabled",deep_sleep_interval:"deepSleepInterval",deepSleepInterval:"deepSleepInterval",daily_refresh_enabled:"dailyRefreshEnabled",dailyRefreshEnabled:"dailyRefreshEnabled",daily_refresh_time:"dailyRefreshTime",dailyRefreshTime:"dailyRefreshTime",no_refresh_start_hour:"noRefreshStartHour",noRefreshStartHour:"noRefreshStartHour",no_refresh_end_hour:"noRefreshEndHour",noRefreshEndHour:"noRefreshEndHour",auto_cycle_enabled:"autoCycleEnabled",autoCycleEnabled:"autoCycleEnabled",auto_cycle_interval_s:"autoCycleIntervalS",autoCycleIntervalS:"autoCycleIntervalS",refresh_interval:"refreshInterval",refreshInterval:"refreshInterval",rendering_mode:"renderingMode",renderingMode:"renderingMode",lcd_eco_strategy:"lcdEcoStrategy",lcdEcoStrategy:"lcdEcoStrategy",extended_latin_glyphs:"extendedLatinGlyphs",extendedLatinGlyphs:"extendedLatinGlyphs",inverted_colors:"invertedColors",invertedColors:"invertedColors",width:"width",resWidth:"width",height:"height",resHeight:"height",shape:"shape",oepl_entity_id:"oeplEntityId",oeplEntityId:"oeplEntityId",oepl_dither:"oeplDither",oeplDither:"oeplDither",glyphsets:"glyphsets"},l={};Object.entries(c).forEach(([y,b])=>{a[y]!==void 0&&(l[b]=a[y])});const h={};Object.entries(d).forEach(([y,b])=>{const w=c[y]||y;h[w]=b});const g={...r,...h,...l};console.log("[loadLayoutIntoState] DEBUG renderingMode:",{fromLayout:a.renderingMode||a.rendering_mode,currentSettings:r.renderingMode,normalizedImported:h.renderingMode,rootSettings:l.renderingMode,finalNewSettings:g.renderingMode}),i&&(g.device_name=i,g.deviceName=i),t&&(g.device_model=t,g.deviceModel=t);const m=F[t];if(m&&m.features){const y=!!m.features.epaper,b=!!(m.features.lvgl||m.features.lv_display);y&&!b&&g.renderingMode==="lvgl"&&(e.some(v=>v.widgets&&v.widgets.some(I=>I.type&&I.type.startsWith("lvgl_")))||(_.log("[loadLayoutIntoState] E-Paper detected without LVGL support and NO LVGL widgets found. Repairing renderingMode: lvgl -> direct"),g.renderingMode="direct"))}u.setPages(e),u.setSettings(g);const f=u.currentPageIndex;f>=0&&f<e.length?u.setCurrentPageIndex(f):u.setCurrentPageIndex(0),_.log(`[loadLayoutIntoState] Layout loaded with ${e.length} pages. Current Layout ID: ${u.currentLayoutId}`),_.log(`[loadLayoutIntoState] Rendering mode after merge: ${g.renderingMode}`)}let ce=[],Ne=!1,Ni=!1,ke=!1;function ne(){const a={"Content-Type":"application/json"},e=Re();return e&&e.trim()!==""&&e!=="null"&&(a.Authorization=`Bearer ${e}`),a}const Ye="entity-datalist-global";let pe=null;function li(){return pe||(pe=document.getElementById(Ye),pe||(pe=document.createElement("datalist"),pe.id=Ye,document.body.appendChild(pe))),pe}function Hi(a){const e=li();e.innerHTML="",!(!a||a.length===0)&&(a.forEach(n=>{const i=document.createElement("option");i.value=n.entity_id,i.label=n.name||n.entity_id,e.appendChild(i)}),_.log(`[EntityDatalist] Updated with ${a.length} entities`))}async function ge(){if(!q())return[];if(Ne)return ce;Ne=!0;try{const a=new AbortController,e=setTimeout(()=>a.abort(),1e4),n=Q.includes("api/esphome_designer")&&!window.location.pathname.includes("esphome-designer");let i,t=!1;const s=Re();i=`${Q}/entities?domains=sensor,binary_sensor,weather,light,switch,fan,cover,climate,media_player,input_number,number,input_boolean,input_text,input_select,button,input_button,scene,script`,_.log("[EntityStates] Fetching from:",i);let o;try{o=await fetch(i,{headers:ne(),signal:a.signal})}catch(d){if(s&&Q)i=`${Q.replace("/api/esphome_designer","")}/api/states`,_.log("[EntityStates] Custom endpoint failed, trying native HA API:",i),t=!0,o=await fetch(i,{headers:ne(),signal:a.signal});else throw d}if(clearTimeout(e),!o.ok)return _.warn("[EntityStates] Failed to fetch:",o.status),ke=!0,[];let r=await o.json();if(t&&Array.isArray(r)){const d=["sensor","binary_sensor","weather","light","switch","fan","cover","climate","media_player","input_number","number","input_boolean","input_text","input_select","button","input_button","scene","script"];r=r.filter(c=>{const l=c.entity_id?.split(".")[0];return d.includes(l)}).map(c=>({entity_id:c.entity_id,name:c.attributes?.friendly_name||c.entity_id,state:c.state,unit:c.attributes?.unit_of_measurement,attributes:c.attributes||{}}))}return Array.isArray(r)?(_.log(`[EntityStates] Received ${r.length} entities`),ce=r.map(d=>{const c=d.unit?`${d.state} ${d.unit}`:d.state;return{entity_id:d.entity_id,name:d.name||d.entity_id,state:d.state,unit:d.unit,attributes:d.attributes||{},formatted:c}}),Ni=!0,ke=!1,_.log(`[EntityStates] Cached ${ce.length} entity states`),u&&(u.entityStates={},ce.forEach(d=>{u.entityStates[d.entity_id]=d}),_.log(`[EntityStates] Populated AppState.entityStates with ${Object.keys(u.entityStates).length} entries`)),Hi(ce),O(P.ENTITIES_LOADED,ce),ce):(_.warn("[EntityStates] Invalid response format"),ke=!0,[])}catch(a){return a.name==="AbortError"?_.warn("[EntityStates] Request timed out after 10 seconds"):_.warn("[EntityStates] Error fetching:",a),ke=!0,[]}finally{Ne=!1}}let St=!1;async function qs(a,e="24h"){if(!q()||!a)return[];try{const n=`${Q}/history/${encodeURIComponent(a)}?duration=${encodeURIComponent(e)}`,i=await fetch(n,{headers:ne()});if(!i.ok)return St||(_.log("[EntityHistory] History fetch unavailable (graph preview will use mock data)"),St=!0),[];const t=await i.json();return Array.isArray(t)?t:[]}catch{return[]}}async function $i(){if(!q()){_.warn("Cannot load layout from backend: No HA backend detected.");return}try{let a=null;try{const i=await fetch(`${Q}/layouts`,{headers:ne()});if(i.ok){const t=await i.json();_.log("[loadLayoutFromBackend] Available layouts:",t.layouts?.map(s=>s.id)),_.log(`[loadLayoutFromBackend] Last active layout ID from backend: ${t.last_active_layout_id}`),t.last_active_layout_id&&(t.layouts?.some(o=>o.id===t.last_active_layout_id)?(a=t.last_active_layout_id,_.log(`[loadLayoutFromBackend] Loading last active layout: ${a}`)):_.warn(`[loadLayoutFromBackend] Last active layout '${t.last_active_layout_id}' no longer exists`)),!a&&t.layouts&&t.layouts.length>0&&(a=t.layouts[0].id,_.log(`[loadLayoutFromBackend] No valid last active, using first layout: ${a}`))}}catch(i){_.warn("[loadLayoutFromBackend] Could not fetch layouts list:",i)}let e;if(a?e=await fetch(`${Q}/layouts/${a}`,{headers:ne()}):e=await fetch(`${Q}/layout`,{headers:ne()}),!e.ok)throw new Error(`Failed to load layout: ${e.status}`);const n=await e.json();!n.device_id&&a&&(n.device_id=a),_.log(`[loadLayoutFromBackend] Loaded layout '${n.device_id||a||"default"}':`,{name:n.name,device_model:n.device_model,pages:n.pages?.length,widgets:n.pages?.reduce((i,t)=>i+(t.widgets?.length||0),0)}),u&&(n.device_id||a)&&u.setCurrentLayoutId(n.device_id||a),typeof le=="function"?le(n):_.error("[loadLayoutFromBackend] loadLayoutIntoState function missing!"),O(P.LAYOUT_IMPORTED,n)}catch(a){_.error("Error loading layout from backend:",a),N(()=>Promise.resolve().then(()=>ei),void 0,import.meta.url).then(e=>e.showToast("Error loading layout from backend",5e3,"error"))}}let He=!1,$e=!1;async function Ie(){if(!q())return!1;if(He)return $e=!0,_.log("[saveLayoutToBackend] Save already in progress, queuing..."),!1;if(!u)throw new Error("AppState not available");const a=u.currentLayoutId||"reterminal_e1001",e=u.settings.device_model||u.deviceModel||"reterminal_e1001",i={...u.getPagesPayload(),device_id:a,name:u.deviceName||"Layout 1",device_model:e,deviceName:u.deviceName||"Layout 1"};He=!0,$e=!1;try{_.log(`[saveLayoutToBackend] Saving to layout '${a}':`,{device_model:e,pages:i.pages?.length,widgets:i.pages?.reduce((r,d)=>r+(d.widgets?.length||0),0)});const t=new AbortController,s=setTimeout(()=>t.abort(),1e4),o=await fetch(`${Q}/layouts/${a}`,{method:"POST",headers:ne(),body:JSON.stringify(i),signal:t.signal});if(clearTimeout(s),!o.ok){const r=await o.json().catch(()=>({}));throw new Error(r.message||r.error||`Save failed: ${o.status}`)}return _.log(`[saveLayoutToBackend] Layout '${a}' saved successfully`),!0}catch(t){if(t.name==="AbortError")return!0;if(t.message?.includes("Failed to fetch")||t.message?.includes("NetworkError")||t.message?.includes("net::ERR_")||t.message?.includes("ERR_EMPTY_RESPONSE")||t.message?.includes("Load failed"))return!1;throw _.error("Failed to save layout to backend:",t),t}finally{He=!1,$e&&setTimeout(()=>{Ie().catch(()=>{})},500)}}async function zi(a){if(!q())throw new Error("No backend");const e=await fetch(`${Q}/import_snippet`,{method:"POST",headers:ne(),body:JSON.stringify({yaml:a})});if(!e.ok){const n=await e.json().catch(()=>({}));throw new Error(n.message||n.error||`Import failed with status ${e.status}`)}return await e.json()}const Fi=["elecrow-esp32-7inch.yaml","guition-esp32-jc4827w543.yaml","guition-esp32-jc8048w535.yaml","guition-esp32-jc8048w550.yaml","guition-esp32-s3-4848s040.yaml","lilygo-tdisplays3.yaml","sunton-esp32-2432s028.yaml","sunton-esp32-2432s028R.yaml","sunton-esp32-4827s032R.yaml","sunton-esp32-8048s050.yaml","sunton-esp32-8048s070.yaml","waveshare-esp32-s3-touch-lcd-4.3.yaml","waveshare-esp32-s3-touch-lcd-7.yaml","waveshare-esp32-universal-epaper-7.5v2.yaml"];async function Gi(){if(q())try{const e=`${Q}/hardware/templates`;_.log("[HardwareDiscovery] Fetching from:",e);const n=await fetch(e,{headers:ne(),cache:"no-store"});if(!n.ok)throw new Error(`HTTP ${n.status}`);return(await n.json()).templates||[]}catch(e){_.error("Failed to fetch dynamic hardware templates from HA:",e)}_.log("[HardwareDiscovery] Attempting to load fallback local profiles...");const a=[];for(const e of Fi)try{const n=await fetch(`hardware/${e}`);if(n.ok){const i=await n.text(),t=di(i,e);t.id=e.replace(/\.yaml$/i,"").replace(/[^a-z0-9]/gi,"_").toLowerCase(),t.isPackageBased=!0,t.hardwarePackage=`hardware/${e}`,a.push(t)}}catch{}return _.log(`[HardwareDiscovery] Loaded ${a.length} local fallback profiles.`),a}async function It(a){if(!q())return _.log("[HardwareImport] Offline mode detected. Parsing locally..."),await ji(a);const e=new FormData;e.append("file",a);try{const n=`${Q}/hardware/upload`,i=ne();delete i["Content-Type"];const t=await fetch(n,{method:"POST",headers:i,body:e}),s=await t.json();if(!t.ok)throw new Error(s.message||s.error||"Upload failed");z("Hardware template uploaded successfully!","success");const{loadExternalProfiles:o}=await N(async()=>{const{loadExternalProfiles:r}=await Promise.resolve().then(()=>ci);return{loadExternalProfiles:r}},void 0,import.meta.url);return o&&await o(),s}catch(n){throw _.error("Hardware upload failed:",n),z(`Upload failed: ${n.message}`,"error"),n}}async function ji(a){return new Promise((e,n)=>{const i=new FileReader;i.onload=async t=>{const s=t.target.result;try{if(!s.includes("__LAMBDA_PLACEHOLDER__"))throw new Error("Invalid template: Missing __LAMBDA_PLACEHOLDER__");const o=di(s,a.name);_.log("[HardwareImport] Parsed offline profile:",o);const{DEVICE_PROFILES:r}=await N(async()=>{const{DEVICE_PROFILES:d}=await Promise.resolve().then(()=>ci);return{DEVICE_PROFILES:d}},void 0,import.meta.url);r&&(r[o.id]=o),z(`Imported ${o.name} (Offline Mode)`,"success"),window.app&&window.app.deviceSettings&&window.app.deviceSettings.populateDeviceSelect(),Ui(o),e(o)}catch(o){z(o.message,"error"),n(o)}},i.onerror=()=>n(new Error("File read failed")),i.readAsText(a)})}function di(a,e){const n="dynamic_offline_"+e.replace(/[^a-z0-9]/gi,"_").toLowerCase();let i=e.replace(/\.yaml$/i,""),t=800,s=480,o="rect";const r=a.match(/#\s*Name:\s*(.*)/i);r&&(i=r[1].trim());const d=a.match(/#\s*Resolution:\s*(\d+)x(\d+)/i);d&&(t=parseInt(d[1]),s=parseInt(d[2]));const c=a.match(/#\s*Shape:\s*(rect|round)/i);c&&(o=c[1].toLowerCase());const h=!!a.match(/#\s*Inverted:\s*(true|yes|1)/i);return{id:n,name:i+" (Local)",resolution:{width:t,height:s},shape:o,isPackageBased:!0,isOfflineImport:!0,content:a,features:{psram:a.includes("psram:"),lcd:!a.includes("waveshare_epaper")&&!a.includes("epaper_spi"),lvgl:a.includes("lvgl:")||!a.includes("waveshare_epaper")&&!a.includes("epaper_spi"),epaper:a.includes("waveshare_epaper")||a.includes("epaper_spi"),touch:a.includes("touchscreen:"),inverted_colors:h}}}function Ui(a){try{const e=JSON.parse(localStorage.getItem("esphome-offline-profiles")||"{}");e[a.id]=a,localStorage.setItem("esphome-offline-profiles",JSON.stringify(e)),_.log("[HardwarePersistence] Saved offline profile to localStorage:",a.id)}catch(e){_.error("Failed to save profile to localStorage:",e)}}function Vi(){try{return JSON.parse(localStorage.getItem("esphome-offline-profiles")||"{}")}catch(a){return _.warn("Could not load offline profiles from storage:",a),{}}}const De=["reterminal_e1001","reterminal_e1002","trmnl_diy_esp32s3","esp32_s3_photopainter","m5stack_paper","m5stack_coreink","trmnl","waveshare_esp32_s3_touch_lcd_7","waveshare_esp32_s3_touch_lcd_4_3"],F={reterminal_e1001:{name:"Seeedstudio reTerminal E1001 (Monochrome)",displayType:"binary",chip:"esp32-s3",board:"esp32-s3-devkitc-1",displayModel:"7.50inv2p",displayPlatform:"waveshare_epaper",resolution:{width:800,height:480},shape:"rect",psram_mode:"octal",pins:{display:{cs:"GPIO10",dc:"GPIO11",reset:{number:"GPIO12",inverted:!1},busy:{number:"GPIO13",inverted:!0}},i2c:{sda:"GPIO19",scl:"GPIO20"},spi:{clk:"GPIO7",mosi:"GPIO9"},batteryEnable:"GPIO21",batteryAdc:"GPIO1",buzzer:"GPIO45",buttons:{left:"GPIO5",right:"GPIO4",refresh:"GPIO3",home:"GPIO2"}},battery:{attenuation:"12db",multiplier:2,calibration:{min:3.27,max:4.15}},features:{psram:!0,buzzer:!0,buttons:!0,sht4x:!0,epaper:!0,inverted_colors:!0}},reterminal_e1002:{name:"Seeedstudio reTerminal E1002 (6-Color)",displayType:"color",displayModel:"Seeed-reTerminal-E1002",displayPlatform:"epaper_spi",resolution:{width:800,height:480},shape:"rect",psram_mode:"octal",pins:{display:{cs:null,dc:null,reset:null,busy:null},i2c:{sda:"GPIO19",scl:"GPIO20"},spi:{clk:"GPIO7",mosi:"GPIO9"},batteryEnable:"GPIO21",batteryAdc:"GPIO1",buzzer:"GPIO45",buttons:{left:"GPIO5",right:"GPIO4",refresh:"GPIO3",home:"GPIO2"}},battery:{attenuation:"12db",multiplier:2,calibration:{min:3.27,max:4.15}},features:{psram:!0,buzzer:!0,buttons:!0,sht4x:!0,epaper:!0}},trmnl_diy_esp32s3:{name:"Seeed Studio Trmnl DIY Kit (ESP32-S3)",displayType:"binary",displayModel:"7.50inv2p",displayPlatform:"waveshare_epaper",resolution:{width:800,height:480},shape:"rect",psram_mode:"octal",pins:{display:{cs:"GPIO44",dc:"GPIO10",reset:"GPIO38",busy:{number:"GPIO4",inverted:!0}},i2c:{sda:"GPIO17",scl:"GPIO18"},spi:{clk:"GPIO7",mosi:"GPIO9"},batteryEnable:"GPIO6",batteryAdc:"GPIO1",buzzer:null,buttons:{left:"GPIO2",refresh:"GPIO5"}},battery:{attenuation:"12db",multiplier:2,calibration:{min:3.27,max:4.15},curve:[{from:4.15,to:100},{from:3.96,to:90},{from:3.91,to:80},{from:3.85,to:70},{from:3.8,to:60},{from:3.75,to:50},{from:3.68,to:40},{from:3.58,to:30},{from:3.49,to:20},{from:3.41,to:10},{from:3.3,to:5},{from:3.27,to:0}]},features:{psram:!0,buzzer:!1,buttons:!0,sht4x:!1,epaper:!0,inverted_colors:!0}},trmnl:{name:"TRMNL (ESP32-C3)",displayType:"binary",displayModel:"7.50inv2",displayPlatform:"waveshare_epaper",resolution:{width:800,height:480},shape:"rect",pins:{display:{cs:"GPIO6",dc:"GPIO5",reset:{number:"GPIO10",inverted:!1},busy:{number:"GPIO4",inverted:!0}},i2c:{sda:"GPIO1",scl:"GPIO2"},spi:{clk:"GPIO7",mosi:"GPIO8"},batteryEnable:null,batteryAdc:"GPIO0",buzzer:null,buttons:null},battery:{attenuation:"12db",multiplier:2,calibration:{min:3.3,max:4.15}},features:{psram:!1,buzzer:!1,buttons:!1,sht4x:!1,epaper:!0,inverted_colors:!0},chip:"esp32-c3",board:"esp32-c3-devkitm-1"},esp32_s3_photopainter:{id:"esp32_s3_photopainter",name:"Waveshare PhotoPainter (6-Color)",displayType:"color",displayModel:"7.30in-f",displayPlatform:"waveshare_epaper",resolution:{width:800,height:480},shape:"rect",psram_mode:"octal",pins:{display:{cs:"GPIO9",dc:"GPIO8",reset:"GPIO12",busy:{number:"GPIO13",inverted:!0}},i2c:{sda:"GPIO47",scl:"GPIO48"},spi:{clk:"GPIO10",mosi:"GPIO11"},batteryEnable:null,batteryAdc:null,buzzer:null,buttons:{left:"GPIO0",right:"GPIO4",refresh:null}},battery:{attenuation:"0db",multiplier:1,calibration:{min:3.3,max:4.2}},features:{psram:!0,buzzer:!1,buttons:!0,sht4x:!1,axp2101:!0,manual_pmic:!0,shtc3:!0,epaper:!0},i2c_config:{scan:!1,frequency:"10kHz"}},waveshare_esp32_s3_touch_lcd_7:{name:'Waveshare Touch LCD 7 7.0" 800x480',displayType:"color",isPackageBased:!0,hardwarePackage:"hardware/waveshare-esp32-s3-touch-lcd-7.yaml",resolution:{width:800,height:480},features:{psram:!0,buzzer:!1,buttons:!1,lcd:!0,lvgl:!0,touch:!0},touch:{platform:"gt911",transformed:!0,transform:{swap_xy:!0}}},waveshare_esp32_s3_touch_lcd_4_3:{name:'Waveshare Touch LCD 4.3 4.3" 800x480',displayType:"color",isPackageBased:!0,hardwarePackage:"hardware/waveshare-esp32-s3-touch-lcd-4.3.yaml",resolution:{width:800,height:480},features:{psram:!0,buzzer:!1,buttons:!1,lcd:!0,touch:!0},touch:{platform:"gt911",transformed:!0,transform:{swap_xy:!0}}},m5stack_coreink:{name:"M5Stack M5Core Ink (200x200)",displayType:"binary",displayModel:"1.54inv2",displayPlatform:"waveshare_epaper",resolution:{width:200,height:200},shape:"rect",features:{psram:!1,buzzer:!0,buttons:!0,lcd:!1,epaper:!0,inverted_colors:!0},chip:"esp32",board:"m5stack-coreink",pins:{display:{cs:"GPIO9",dc:"GPIO15",reset:"GPIO0",busy:null},i2c:{sda:"GPIO21",scl:"GPIO22"},spi:{clk:"GPIO18",mosi:"GPIO23"},batteryEnable:{number:"GPIO12",ignore_strapping_warning:!0},batteryAdc:"GPIO35",buzzer:"GPIO2",buttons:{left:{number:"GPIO39",mode:"INPUT"},right:{number:"GPIO37",mode:"INPUT"},refresh:{number:"GPIO38",mode:"INPUT"}}},battery:{attenuation:"12db",multiplier:2,calibration:{min:3.27,max:4.15}},i2c_config:{scan:!0}},m5stack_paper:{name:"M5Paper (540x960)",displayType:"grayscale",displayModel:"M5Paper",displayPlatform:"it8951e",resolution:{width:960,height:540},shape:"rect",chip:"esp32",board:"m5stack-paper",features:{psram:!0,buzzer:!1,buttons:!0,lcd:!1,epaper:!0,touch:!0,inverted_colors:!0,sht3xd:!0},pins:{display:{cs:"GPIO15",dc:null,reset:"GPIO23",busy:"GPIO27"},i2c:{sda:"GPIO21",scl:"GPIO22"},spi:{clk:"GPIO14",mosi:"GPIO12",miso:"GPIO13"},batteryEnable:null,batteryAdc:"GPIO35",buzzer:null,buttons:{left:{number:"GPIO39",mode:"INPUT"},right:{number:"GPIO37",mode:"INPUT"},refresh:{number:"GPIO38",mode:"INPUT"}}},m5paper:{battery_power_pin:"GPIO5",main_power_pin:"GPIO2"},battery:{attenuation:"12db",multiplier:2,calibration:{min:3.27,max:4.15}},rotation_offset:180,touch:{platform:"gt911",i2c_id:"bus_a",address:93,interrupt_pin:"GPIO36",update_interval:"never",transform:{mirror_x:!1,mirror_y:!1,swap_xy:!0},calibration:{x_min:0,x_max:960,y_min:0,y_max:540}},external_components:["  - source: github://Passific/m5paper_esphome"]}};async function Be(){try{const a=await Gi();_.log(`[Devices] Loaded ${a.length} dynamic hardware templates.`),a.forEach(i=>{if(F[i.id]){const t=F[i.id];F[i.id]={...t,...i,features:{...t.features||{},...i.features||{}}}}else F[i.id]=i});const e=Vi(),n=Object.keys(e);n.length>0&&(_.log(`[Devices] Restoring ${n.length} offline profiles from localStorage.`),Object.entries(e).forEach(([i,t])=>{F[i]=t})),window.app&&window.app.deviceSettings&&typeof window.app.deviceSettings.populateDeviceSelect=="function"&&window.app.deviceSettings.populateDeviceSelect()}catch(a){_.error("Failed to load external hardware profiles:",a)}}const ci=Object.freeze(Object.defineProperty({__proto__:null,DEVICE_PROFILES:F,SUPPORTED_DEVICE_IDS:De,loadExternalProfiles:Be},Symbol.toStringTag,{value:"Module"}));function Ce(){return window.AppState&&window.AppState.deviceModel?window.AppState.deviceModel:window.currentDeviceModel||"reterminal_e1001"}function Yi(a){if(F&&F[a])return F[a].name;switch(a){case"reterminal_e1002":return"reTerminal E1002 (6-Color)";case"esp32_s3_photopainter":return"Waveshare PhotoPainter (7-Color)";case"trmnl":return"Official TRMNL (ESP32-C3)";case"reterminal_e1001":default:return"reTerminal E1001 (Monochrome)"}}function pi(){const a=Ce();return!!(F&&F[a]&&(F[a].features?.lcd||F[a].features?.oled))}function qe(){const a=window.AppState,e=a?.settings?.renderingMode||"direct";if(e==="oepl"||e==="opendisplay"){const t=(a?.project?.protocolHardware||{}).colorMode||"bw";return t==="full_color"?["black","white","red","green","blue","yellow","orange","gray","purple","cyan","magenta"]:t==="color_3"?["black","white","red","yellow","gray"]:["theme_auto","black","white","gray"]}if(pi())return["black","white","red","green","blue","yellow","orange","gray","purple","cyan","magenta"];const n=Ce();return n==="reterminal_e1002"?["theme_auto","black","white","gray","red","green","blue","yellow"]:n==="esp32_s3_photopainter"?["theme_auto","black","white","gray","red","green","blue","yellow"]:["theme_auto","black","white","gray"]}function ft(a){if(!a)return"#000000";if(a.startsWith("#"))return a;if(a.startsWith("0x"))return"#"+a.substring(2);switch(a.toLowerCase()){case"theme_auto":return window.WidgetFactory?.getEffectiveDarkMode?.()||!1?"#ffffff":"#000000";case"white":return"#ffffff";case"red":return"#ff0000";case"green":return"#00ff00";case"blue":return"#0000ff";case"yellow":return"#ffff00";case"orange":return"#ffa500";case"gray":return"#a0a0a0";case"transparent":return"transparent";case"black":default:return"#000000"}}window.getDeviceModel=Ce;window.getDeviceDisplayName=Yi;window.isRGBDevice=pi;window.getAvailableColors=qe;window.getColorStyle=ft;function hi(a){if(!a)return 3600;if(typeof a=="number")return a;const e=String(a);if(/^\d+$/.test(e))return parseInt(e,10);const n=e.match(/^(\d+)([a-z]+)$/i);if(!n)return 3600;const i=parseInt(n[1],10),t=n[2].toLowerCase();return t.startsWith("s")?i:t.startsWith("m")?i*60:t.startsWith("h")?i*3600:t.startsWith("d")?i*86400:i}function Ct(a,e,n,i){const t=[];for(let o=0;o<50;o++){const r=o/49*a,d=o/50,c=Math.sin(d*Math.PI*2),l=(Math.random()-.5)*.2;let h=.5+c*.3+l;h=Math.max(.1,Math.min(.9,h));const g=e-h*e;t.push({x:r,y:g})}return t}function Xs(a,e,n,i,t,s){if(!t||t.length===0)return Ct(a,e);const o=[],r=hi(s),c=Date.now()-r*1e3,l=t.map(w=>({time:new Date(w.last_changed||w.when||Date.now()).getTime(),value:parseFloat(w.state)})).filter(w=>!isNaN(w.value));if(l.length===0)return Ct(a,e);l.sort((w,v)=>w.time-v.time);let h=n,g=i;const m=l.map(w=>w.value),f=Math.min(...m),y=Math.max(...m);if(n===i||isNaN(n)&&isNaN(i)||n===0&&i===100&&(f>100||y<0)){h=f,g=y;const w=(g-h)*.1||1;h-=w,g+=w}const b=g-h||1;return l.forEach(w=>{const v=(w.time-c)/(r*1e3)*a;let I=(w.value-h)/b;I=Math.max(-.1,Math.min(1.1,I));const k=e-I*e;v>=-10&&v<=a+10&&o.push({x:v,y:k})}),o.length>0&&o[o.length-1].x<a-1&&o.push({x:a,y:o[o.length-1].y}),o}function Ks(a,e,n,i,t,s="rgba(0,0,0,0.1)"){const o=document.createElementNS("http://www.w3.org/2000/svg","g");o.setAttribute("stroke",s),o.setAttribute("stroke-dasharray","2,2"),o.setAttribute("stroke-width","1");const r=4,d=4;for(let c=1;c<r;c++){const l=c/r*e,h=document.createElementNS("http://www.w3.org/2000/svg","line");h.setAttribute("x1",l),h.setAttribute("y1",0),h.setAttribute("x2",l),h.setAttribute("y2",n),o.appendChild(h)}for(let c=1;c<d;c++){const l=c/d*n,h=document.createElementNS("http://www.w3.org/2000/svg","line");h.setAttribute("x1",0),h.setAttribute("y1",l),h.setAttribute("x2",e),h.setAttribute("y2",l),o.appendChild(h)}a.appendChild(o)}function Js(a,e,n,i,t,s,o,r,d,c="#666"){if(!a)return;a.querySelectorAll(`.graph-axis-label[data-widget-id="${d}"]`).forEach(I=>I.remove());const h=o-s,g=4,m=parseInt(a.style.width)||800,f=parseInt(a.style.height)||480,y=e<40,b=n+t+20>f;for(let I=0;I<=g;I++){const k=s+h*(I/g),M=n+t-I/g*t,E=document.createElement("div");E.className="graph-axis-label",E.dataset.widgetId=d,E.style.position="absolute",y?(E.style.left=`${e+4}px`,E.style.textAlign="left"):(E.style.left=`${e-4}px`,E.style.transform="translateX(-100%)",E.style.textAlign="right"),E.style.top=`${M-6}px`,E.style.fontSize="10px",E.style.color=c,E.style.opacity=y?"0.7":"1.0",E.style.pointerEvents="none",E.style.zIndex="10",E.textContent=k.toFixed(1),a.appendChild(E)}const w=hi(r),v=2;for(let I=0;I<=v;I++){const k=I/v,M=e+i*k;let E="";if(I===v)E="Now";else{const S=w*(1-k);S>=3600?E=`-${(S/3600).toFixed(1)}h`:S>=60?E=`-${(S/60).toFixed(0)}m`:E=`-${S.toFixed(0)}s`}const x=document.createElement("div");x.className="graph-axis-label",x.dataset.widgetId=d,x.style.position="absolute",x.style.left=`${M}px`,b?x.style.top=`${n+t-14}px`:x.style.top=`${n+t+4}px`,x.style.fontSize="10px",x.style.color=c,x.style.opacity=b?"0.7":"1.0",x.style.pointerEvents="none",x.style.zIndex="10",M<20?(x.style.transform="none",x.style.textAlign="left"):M>m-20?(x.style.transform="translateX(-100%)",x.style.textAlign="right"):(x.style.transform="translateX(-50%)",x.style.textAlign="center"),x.textContent=E,a.appendChild(x)}}const se={getColorConst:a=>{if(!a)return"COLOR_BLACK";const e=a.toLowerCase();if(e==="theme_auto")return"color_on";if(e==="transparent")return"color_off";if(e.startsWith("#")&&e.length===7){const n=parseInt(e.substring(1,3),16),i=parseInt(e.substring(3,5),16),t=parseInt(e.substring(5,7),16);return`Color(${n}, ${i}, ${t})`}return ut[e]||"COLOR_BLACK"},getAlignX:(a,e,n)=>a.includes("LEFT")?`${e}`:a.includes("RIGHT")?`${e} + ${n}`:`${e} + ${n}/2`,getAlignY:(a,e,n)=>a.includes("TOP")?`${e}`:a.includes("BOTTOM")?`${e} + ${n}`:`${e} + ${n}/2`,sanitize:a=>a?a.replace(/"/g,'\\"'):"",addDitherMask:(a,e,n,i,t,s,o,r=0)=>{if(!n||!e)return;const d=e.toLowerCase();let c=d==="gray"||d==="grey";if(!c&&d.startsWith("#")&&d.length===7){const l=parseInt(d.substring(1,3),16),h=parseInt(d.substring(3,5),16),g=parseInt(d.substring(5,7),16);Math.abs(l-h)<15&&Math.abs(h-g)<15&&l>40&&l<210&&(c=!0)}c&&a.push(`          apply_grey_dither_mask(${Math.round(i)}, ${Math.round(t)}, ${Math.round(s)}, ${Math.round(o)});`)},isGrayColor:a=>{if(!a)return!1;const e=a.toLowerCase();if(e==="gray"||e==="grey")return!0;if(e.startsWith("#")&&e.length===7){const n=parseInt(e.substring(1,3),16),i=parseInt(e.substring(3,5),16),t=parseInt(e.substring(5,7),16);if(Math.abs(n-i)<15&&Math.abs(i-t)<15&&n>40&&n<210)return!0}return!1},addDitherMaskForText:(a,e,n,i,t,s,o)=>!n||!se.isGrayColor(e)?!1:(a.push(`        apply_grey_dither_to_text(${Math.round(i)}, ${Math.round(t)}, ${Math.round(s)}, ${Math.round(o)});`),!0),getIconCode:a=>{if(!a||!window.iconPickerData)return null;const e=window.iconPickerData.find(n=>n.name===a);return e?e.code:null}};window.Utils=se;window.ESPHomeDesigner=window.ESPHomeDesigner||{};window.ESPHomeDesigner.utils=se;const ui=[{code:"F0004",name:"account"},{code:"F0026",name:"alert"},{code:"F0028",name:"alert-circle"},{code:"F0045",name:"arrow-down"},{code:"F004D",name:"arrow-left"},{code:"F0054",name:"arrow-right"},{code:"F005D",name:"arrow-up"},{code:"F0079",name:"battery"},{code:"F007C",name:"battery-50"},{code:"F0084",name:"battery-charging"},{code:"F009A",name:"bell"},{code:"F00AF",name:"bluetooth"},{code:"F00D8",name:"brightness-5"},{code:"F00ED",name:"calendar"},{code:"F0100",name:"camera"},{code:"F012C",name:"check"},{code:"F05E0",name:"check-circle"},{code:"F0140",name:"chevron-down"},{code:"F0141",name:"chevron-left"},{code:"F0142",name:"chevron-right"},{code:"F0143",name:"chevron-up"},{code:"F0150",name:"clock"},{code:"F0156",name:"close"},{code:"F015F",name:"cloud"},{code:"F0493",name:"cog"},{code:"F01B4",name:"delete"},{code:"F01D9",name:"dots-vertical"},{code:"F01DA",name:"download"},{code:"F01EE",name:"email"},{code:"F0208",name:"eye"},{code:"F0209",name:"eye-off"},{code:"F0210",name:"fan"},{code:"F0214",name:"file"},{code:"F021E",name:"flash"},{code:"F024B",name:"folder"},{code:"F0279",name:"format-list-bulleted"},{code:"F02D1",name:"heart"},{code:"F02DC",name:"home"},{code:"F07D0",name:"home-assistant"},{code:"F02E9",name:"image"},{code:"F02FC",name:"information"},{code:"F0322",name:"layers"},{code:"F0335",name:"lightbulb"},{code:"F06E8",name:"lightbulb-on"},{code:"F033E",name:"lock"},{code:"F033F",name:"lock-open"},{code:"F0349",name:"magnify"},{code:"F034E",name:"map-marker"},{code:"F035C",name:"menu"},{code:"F036C",name:"microphone"},{code:"F0374",name:"minus"},{code:"F075A",name:"music"},{code:"F03EB",name:"pencil"},{code:"F040A",name:"play"},{code:"F0415",name:"plus"},{code:"F0425",name:"power"},{code:"F0450",name:"refresh"},{code:"F048A",name:"send"},{code:"F0497",name:"share-variant"},{code:"F0565",name:"shield-check"},{code:"F04CE",name:"star"},{code:"F04DB",name:"stop"},{code:"F050F",name:"thermometer"},{code:"F0513",name:"thumb-up"},{code:"F051B",name:"timer-outline"},{code:"F0A79",name:"trash-can"},{code:"F0552",name:"upload"},{code:"F0571",name:"video"},{code:"F057E",name:"volume-high"},{code:"F0581",name:"volume-off"},{code:"F0585",name:"water"},{code:"F05E3",name:"water-percent"},{code:"F0590",name:"weather-cloudy"},{code:"F0591",name:"weather-fog"},{code:"F0592",name:"weather-hail"},{code:"F0593",name:"weather-lightning"},{code:"F0594",name:"weather-night"},{code:"F0595",name:"weather-partly-cloudy"},{code:"F0596",name:"weather-pouring"},{code:"F0597",name:"weather-rainy"},{code:"F0598",name:"weather-snowy"},{code:"F0599",name:"weather-sunny"},{code:"F059D",name:"weather-windy"},{code:"F05A9",name:"wifi"},{code:"F05AD",name:"window-close"}],Lt=typeof import.meta.glob=="function"?Object.assign({"../../features/battery_icon/plugin.js":()=>N(()=>import("./plugin-DqhXjARd.js"),[],import.meta.url),"../../features/calendar/plugin.js":()=>N(()=>import("./plugin-DxUK8qUa.js"),[],import.meta.url),"../../features/datetime/plugin.js":()=>N(()=>import("./plugin-JDds0jeq.js"),[],import.meta.url),"../../features/graph/plugin.js":()=>N(()=>import("./plugin-BSOhAadw.js"),[],import.meta.url),"../../features/icon/plugin.js":()=>N(()=>import("./plugin-CeI3hRs4.js"),[],import.meta.url),"../../features/image/plugin.js":()=>N(()=>import("./plugin-BK2ZgHCC.js"),[],import.meta.url),"../../features/line/plugin.js":()=>N(()=>import("./plugin-DIyqjh83.js"),[],import.meta.url),"../../features/lvgl_arc/plugin.js":()=>N(()=>import("./plugin-DwiVjdgh.js"),[],import.meta.url),"../../features/lvgl_bar/plugin.js":()=>N(()=>import("./plugin-CVWAoy6Z.js"),[],import.meta.url),"../../features/lvgl_button/plugin.js":()=>N(()=>import("./plugin-BkW9b_ha.js"),[],import.meta.url),"../../features/lvgl_buttonmatrix/plugin.js":()=>N(()=>import("./plugin-DtT_tKeS.js"),[],import.meta.url),"../../features/lvgl_chart/plugin.js":()=>N(()=>import("./plugin-BxZzlM6O.js"),[],import.meta.url),"../../features/lvgl_checkbox/plugin.js":()=>N(()=>import("./plugin-DrDep4Va.js"),[],import.meta.url),"../../features/lvgl_dropdown/plugin.js":()=>N(()=>import("./plugin-L0eEHvUV.js"),[],import.meta.url),"../../features/lvgl_img/plugin.js":()=>N(()=>import("./plugin-89YElWur.js"),[],import.meta.url),"../../features/lvgl_keyboard/plugin.js":()=>N(()=>import("./plugin-DeB-lHQz.js"),[],import.meta.url),"../../features/lvgl_label/plugin.js":()=>N(()=>import("./plugin-C-VDAh3t.js"),[],import.meta.url),"../../features/lvgl_led/plugin.js":()=>N(()=>import("./plugin-C0pzB8KN.js"),[],import.meta.url),"../../features/lvgl_line/plugin.js":()=>N(()=>import("./plugin-yMPhlhMG.js"),[],import.meta.url),"../../features/lvgl_meter/plugin.js":()=>N(()=>import("./plugin-Bu--flyG.js"),[],import.meta.url),"../../features/lvgl_obj/plugin.js":()=>N(()=>import("./plugin-C9NtUHZv.js"),[],import.meta.url),"../../features/lvgl_qrcode/plugin.js":()=>N(()=>import("./plugin-Cuck2Ekv.js"),[],import.meta.url),"../../features/lvgl_roller/plugin.js":()=>N(()=>import("./plugin-BOaP5PSU.js"),[],import.meta.url),"../../features/lvgl_slider/plugin.js":()=>N(()=>import("./plugin-DReFujad.js"),[],import.meta.url),"../../features/lvgl_spinbox/plugin.js":()=>N(()=>import("./plugin-BW1ApCZ9.js"),[],import.meta.url),"../../features/lvgl_spinner/plugin.js":()=>N(()=>import("./plugin-DtLA1P9z.js"),[],import.meta.url),"../../features/lvgl_switch/plugin.js":()=>N(()=>import("./plugin-B4S7fS5o.js"),[],import.meta.url),"../../features/lvgl_tabview/plugin.js":()=>N(()=>import("./plugin-DaGcPuSC.js"),[],import.meta.url),"../../features/lvgl_textarea/plugin.js":()=>N(()=>import("./plugin-DaifM060.js"),[],import.meta.url),"../../features/lvgl_tileview/plugin.js":()=>N(()=>import("./plugin-DGvnqI6n.js"),[],import.meta.url),"../../features/odp_arc/plugin.js":()=>N(()=>import("./plugin-BOA_icB0.js"),[],import.meta.url),"../../features/odp_ellipse/plugin.js":()=>N(()=>import("./plugin-BIpexlmf.js"),[],import.meta.url),"../../features/odp_icon_sequence/plugin.js":()=>N(()=>import("./plugin-Bs3j7HKb.js"),[],import.meta.url),"../../features/odp_multiline/plugin.js":()=>N(()=>import("./plugin-DcwzTZQ0.js"),[],import.meta.url),"../../features/odp_plot/plugin.js":()=>N(()=>import("./plugin-C-QNmijd.js"),[],import.meta.url),"../../features/odp_polygon/plugin.js":()=>N(()=>import("./plugin-3-xlCrjh.js"),[],import.meta.url),"../../features/odp_rectangle_pattern/plugin.js":()=>N(()=>import("./plugin-BJ_8rtlx.js"),[],import.meta.url),"../../features/ondevice_humidity/plugin.js":()=>N(()=>import("./plugin-yveN4_nZ.js"),[],import.meta.url),"../../features/ondevice_temperature/plugin.js":()=>N(()=>import("./plugin-B1DITGco.js"),[],import.meta.url),"../../features/online_image/plugin.js":()=>N(()=>import("./plugin-1PlAjNNR.js"),[],import.meta.url),"../../features/progress_bar/plugin.js":()=>N(()=>import("./plugin-DyzZDkz_.js"),__vite__mapDeps([0,1]),import.meta.url),"../../features/qr_code/plugin.js":()=>N(()=>import("./plugin-Cax3SqC1.js"),[],import.meta.url),"../../features/quote_rss/plugin.js":()=>N(()=>import("./plugin-CNyeAPh6.js"),[],import.meta.url),"../../features/rounded_rect/plugin.js":()=>N(()=>import("./plugin-Cqy3ySkJ.js"),[],import.meta.url),"../../features/sensor_text/plugin.js":()=>N(()=>import("./plugin-CG2xI9fV.js"),__vite__mapDeps([2,1]),import.meta.url),"../../features/shape_circle/plugin.js":()=>N(()=>import("./plugin-DxhrCiqG.js"),[],import.meta.url),"../../features/shape_rect/plugin.js":()=>N(()=>import("./plugin-EOx480Cl.js"),[],import.meta.url),"../../features/template_nav_bar/plugin.js":()=>N(()=>import("./plugin-R2HVg-OM.js"),[],import.meta.url),"../../features/template_sensor_bar/plugin.js":()=>N(()=>import("./plugin-D8ECCI4v.js"),[],import.meta.url),"../../features/text/plugin.js":()=>N(()=>import("./plugin-D7B_P9iq.js"),[],import.meta.url),"../../features/touch_area/plugin.js":()=>N(()=>import("./plugin-xrzIxdG0.js"),[],import.meta.url),"../../features/weather_forecast/plugin.js":()=>N(()=>import("./plugin-a4ugElol.js"),[],import.meta.url),"../../features/weather_icon/plugin.js":()=>N(()=>import("./plugin-BB_CtMxU.js"),[],import.meta.url),"../../features/wifi_signal/plugin.js":()=>N(()=>import("./plugin-BqDFg5MR.js"),[],import.meta.url)}):{};let qi=class{constructor(){this.plugins=new Map,this.loading=new Map,this.aliases={label:"text",rectangle:"shape_rect",rrect:"rounded_rect",circle:"shape_circle",nav_next_page:"touch_area",nav_previous_page:"touch_area",nav_reload_page:"touch_area",puppet:"online_image",multiline:"odp_multiline",rectangle_pattern:"odp_rectangle_pattern",polygon:"odp_polygon",ellipse:"odp_ellipse",icon_sequence:"odp_icon_sequence",weather_forcast:"weather_forecast"}}register(e){if(!e||!e.id){_.warn("[Registry] Invalid plugin registration attempt:",e);return}const n=e.id,i=this.plugins.get(n)||{};this.plugins.set(n,{...i,...e}),_.log(`[Registry] Registered: ${n}`)}get(e){const n=this.aliases[e]||e;return this.plugins.get(n)}getAll(){return Array.from(this.plugins.values())}async load(e){const n=this.aliases[e]||e;if(n==="group")return null;if(this.plugins.has(n))return this.plugins.get(n);if(this.loading.has(n))return this.loading.get(n);const i=(async()=>{try{const t=`../../features/${n}/plugin.js`;let s;return Lt[t]?s=await Lt[t]():(_.log(`[Registry] Using dynamic import fallback for: ${n}`),s=await import(t)),s.default?this.register(s.default):this.register({id:n,...s}),this.loading.delete(n),this.plugins.get(n)}catch(t){return _.error(`[Registry] Failed to load plugin "${n}" from ESM:`,t),this.loading.delete(n),null}})();return this.loading.set(n,i),i}onExportGlobals(e){this.getAll().forEach(n=>n.onExportGlobals&&n.onExportGlobals(e))}onExportEsphome(e){this.getAll().forEach(n=>n.onExportEsphome&&n.onExportEsphome(e))}onExportNumericSensors(e){this.getAll().forEach(n=>n.onExportNumericSensors&&n.onExportNumericSensors(e))}onExportTextSensors(e){this.getAll().forEach(n=>n.onExportTextSensors&&n.onExportTextSensors(e))}onExportBinarySensors(e){this.getAll().forEach(n=>n.onExportBinarySensors&&n.onExportBinarySensors(e))}onExportHelpers(e){this.getAll().forEach(n=>n.onExportHelpers&&n.onExportHelpers(e))}onExportComponents(e){this.getAll().forEach(n=>n.onExportComponents&&n.onExportComponents(e))}onCollectRequirements(e){this.getAll().forEach(n=>n.collectRequirements&&n.collectRequirements(e))}};const V=new qi;window.PluginRegistry=V;window.FeatureRegistry=V;_.log("[Registry] Modular system ready.");let We=class he{static getEffectiveDarkMode(){const n=u?.getCurrentPage?.()?.dark_mode;return n==="dark"?!0:n==="light"?!1:!!(u&&u.settings&&u.settings.dark_mode)}static getDefaultColor(){return he.getEffectiveDarkMode()?"white":"black"}static getDefaultBgColor(){return he.getEffectiveDarkMode()?"black":"white"}static getGridCellDefaults(){return{grid_cell_row_pos:null,grid_cell_column_pos:null,grid_cell_row_span:1,grid_cell_column_span:1,grid_cell_x_align:"STRETCH",grid_cell_y_align:"STRETCH"}}static isLvglWidget(e){return e&&e.startsWith("lvgl_")}static createWidget(e){const n=Se(),i=he.getDefaultColor(),t=he.getDefaultBgColor();let s={id:n,type:e,x:40,y:40,width:120,height:40,title:"",entity_id:"",locked:!1,props:{}};switch(e){case"nav_next_page":return s.props={title:"Next",color:"rgba(0, 128, 255, 0.2)",border_color:"#0080ff",nav_action:"next_page",icon:"F0142",icon_size:48},s.width=80,s.height=80,s;case"nav_previous_page":return s.props={title:"Previous",color:"rgba(0, 128, 255, 0.2)",border_color:"#0080ff",nav_action:"previous_page",icon:"F0141",icon_size:48},s.width=80,s.height=80,s;case"nav_reload_page":return s.props={title:"Reload",color:"rgba(0, 128, 255, 0.2)",border_color:"#0080ff",nav_action:"reload_page",icon:"F0450",icon_size:48},s.width=80,s.height=80,s}const o=V.get(e);return o&&o.defaults?(s.props={...o.defaults},(s.props.color==="black"||s.props.color==="white")&&(s.props.color="theme_auto"),(s.props.text_color==="black"||s.props.text_color==="white")&&(s.props.text_color="theme_auto"),(s.props.bg_color==="black"||s.props.bg_color==="white")&&(s.props.bg_color=t),(s.props.background_color==="black"||s.props.background_color==="white")&&(s.props.background_color=t),(s.props.border_color==="black"||s.props.border_color==="white")&&(s.props.border_color=i),o.width&&(s.width=o.width),o.height&&(s.height=o.height),o.defaults.width&&(s.width=o.defaults.width),o.defaults.height&&(s.height=o.defaults.height),o.defaults.w&&(s.width=o.defaults.w),o.defaults.h&&(s.height=o.defaults.h),s):(he.isLvglWidget(e)&&(s.props={...he.getGridCellDefaults(),...s.props}),s)}};window.WidgetFactory=We;class Xi{constructor(){_.log("Sidebar: Constructor called"),this.pageListEl=document.getElementById("pageList"),this.pagesHeader=document.getElementById("pagesHeader"),this.pagesContent=document.getElementById("pagesContent"),this.widgetPaletteEl=document.getElementById("widgetPalette"),_.log("Sidebar: widgetPaletteEl found?",!!this.widgetPaletteEl),this.widgetPaletteEl||_.error("Sidebar: widgetPalette element not found!"),this.addPageBtn=document.getElementById("addPageBtn"),this.currentPageNameEl=document.getElementById("currentPageName"),this.hoverTimeout=null,this.hoveredPageIndex=-1}init(){_.log("Sidebar: init called");const e=document.getElementById("debug-overlay");e&&(e.innerHTML+="Sidebar.init called<br>"),Z(P.STATE_CHANGED,()=>this.render()),Z(P.PAGE_CHANGED,()=>this.render()),this.pagesHeader&&this.pagesContent&&this.pagesHeader.addEventListener("click",()=>{const t=this.pagesContent.classList.toggle("hidden"),s=this.pagesHeader.querySelector(".chevron");s&&(s.style.transform=t?"rotate(-90deg)":"rotate(0deg)")}),this.addPageBtn&&this.addPageBtn.addEventListener("click",()=>this.handleAddPage()),this.widgetPaletteEl&&(this.widgetPaletteEl.addEventListener("click",t=>this.handlePaletteClick(t)),this.widgetPaletteEl.addEventListener("dragstart",t=>{const s=t.target.closest(".item[data-widget-type]");if(s){const o=s.getAttribute("data-widget-type");_.log("[Sidebar] Drag start:",o),t.dataTransfer.setData("application/widget-type",o),t.dataTransfer.effectAllowed="copy"}})),document.addEventListener("click",t=>{const s=document.getElementById("debug-overlay");s&&(s.innerHTML+="Global click: "+t.target.tagName+"<br>")});const n=document.getElementById("clearAllBtn");n&&n.addEventListener("click",()=>this.handleClearPage());const i=document.getElementById("quickSearchBtn");i&&i.addEventListener("click",t=>{t.stopPropagation(),window.QuickSearch?window.QuickSearch.open():_.warn("Sidebar: QuickSearch instance not found on window")}),this.setupMobileToggles(),this.render()}render(){if(!this.pageListEl)return;this.pageListEl.innerHTML="";const e=u.pages,n=u.currentPageIndex;if(e.forEach((i,t)=>{const s=document.createElement("div");s.className="item"+(t===n?" active":""),s.draggable=!0,s.ondragstart=l=>{l.dataTransfer.setData("text/plain",t),l.dataTransfer.effectAllowed="move",s.style.opacity="0.5"},s.ondragend=()=>{s.style.opacity="1",Array.from(this.pageListEl.children).forEach(l=>{l.style.borderTop="",l.style.borderBottom=""})},s.ondragover=l=>{l.preventDefault();const h=l.dataTransfer.types.includes("application/widget-id"),g=l.dataTransfer.types.includes("application/widget-type");if(h||g){l.dataTransfer.dropEffect=h?"move":"copy",s.style.backgroundColor="var(--primary-subtle)",u.currentPageIndex!==t&&u.setCurrentPageIndex(t);return}const m=s.getBoundingClientRect(),f=m.top+m.height/2;l.clientY<f?(s.style.borderTop="2px solid var(--primary)",s.style.borderBottom=""):(s.style.borderTop="",s.style.borderBottom="2px solid var(--primary)")},s.ondragleave=l=>{const h=l.relatedTarget;s.contains(h)||this.hoveredPageIndex===t&&(this.hoverTimeout&&(clearTimeout(this.hoverTimeout),this.hoverTimeout=null),this.hoveredPageIndex=-1),s.style.borderTop="",s.style.borderBottom="",s.style.backgroundColor=""},s.ondrop=l=>{l.preventDefault(),this.hoverTimeout&&(clearTimeout(this.hoverTimeout),this.hoverTimeout=null),this.hoveredPageIndex=-1,s.style.borderTop="",s.style.borderBottom="",s.style.backgroundColor="";const h=l.dataTransfer.getData("application/widget-id");if(_.log(`[Sidebar] Drop detected on page ${t}. Widget ID:`,h),h){const f=t;f!==u.currentPageIndex&&(u.moveWidgetToPage(h,f),_.log(`[Sidebar] Moved widget ${h} to page ${f}`));return}const g=parseInt(l.dataTransfer.getData("text/plain"),10),m=t;this.handlePageReorder(g,m,l.clientY,s)},s.onclick=()=>{u.setCurrentPageIndex(t)};const o=document.createElement("span");o.className="item-icon",o.innerHTML=`<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="3" y1="9" x2="21" y2="9"></line>
                <line x1="9" y1="21" x2="9" y2="9"></line>
            </svg>`,s.appendChild(o);const r=document.createElement("span");r.className="label",r.textContent=i.name,s.appendChild(r);const d=document.createElement("div");d.style.marginLeft="auto",d.style.display="flex",d.style.gap="2px";const c=document.createElement("button");if(c.textContent="",c.className="btn btn-secondary",c.style.padding="1px 4px",c.style.fontSize="8px",c.onclick=l=>{l.stopPropagation(),this.openPageSettings(t)},d.appendChild(c),e.length>1){const l=document.createElement("button");l.textContent="",l.className="btn btn-secondary",l.style.padding="1px 4px",l.style.fontSize="8px",l.style.color="var(--danger)",l.onclick=h=>{h.stopPropagation(),this.handlePageDelete(t,i)},d.appendChild(l)}s.appendChild(d),this.pageListEl.appendChild(s)}),this.currentPageNameEl){const i=u.getCurrentPage();this.currentPageNameEl.textContent=i?i.name:"None"}}handleAddPage(){u.addPage()}handlePageReorder(e,n,i,t){if(e===n)return;const s=t.getBoundingClientRect(),o=s.top+s.height/2;let r=n;i>=o&&r++,e<r&&r--,e!==r&&u.reorderPage(e,r)}handlePaletteClick(e){const n=document.getElementById("debug-overlay");n&&(n.innerHTML+="handlePaletteClick triggered<br>"),_.log("Sidebar: handlePaletteClick",e.target);const i=e.target.closest(".item[data-widget-type]");if(!i){_.log("Sidebar: No item found"),n&&(n.innerHTML+="No item found<br>");return}const t=i.getAttribute("data-widget-type");_.log("Sidebar: Creating widget of type",t),n&&(n.innerHTML+="Creating widget: "+t+"<br>");try{const s=We.createWidget(t);_.log("Sidebar: Widget created",s),n&&(n.innerHTML+="Widget created<br>"),u.addWidget(s),_.log("Sidebar: Widget added to state"),n&&(n.innerHTML+="Widget added to state<br>")}catch(s){_.error("Sidebar: Error creating/adding widget",s),n&&(n.innerHTML+="Error: "+s.message+"<br>")}}openPageSettings(e){if(window.app&&window.app.pageSettings)window.app.pageSettings.open(e);else{_.error("Sidebar: PageSettings instance not found on window.app");const n=u.pages[e];window.currentPageSettingsTarget=n;const i=document.getElementById("pageSettingsModal");i&&(i.classList.remove("hidden"),i.style.display="flex")}}handlePageDelete(e,n){const i=document.createElement("div");i.className="modal-backdrop",i.style.display="flex",i.innerHTML=`
            <div class="modal" style="width: 320px; height: auto; min-height: 150px; padding: var(--space-4);">
                <div class="modal-header" style="font-size: var(--fs-md); padding-bottom: var(--space-2);">
                    <div>Delete Page</div>
                </div>
                <div class="modal-body" style="padding: var(--space-2) 0;">
                    <p style="margin-bottom: var(--space-3); font-size: var(--fs-sm);">
                        Are you sure you want to delete the page <b>"${n.name}"</b>?
                        <br><br>
                        This action cannot be undone.
                    </p>
                </div>
                <div class="modal-actions" style="padding-top: var(--space-3); border-top: 1px solid var(--border-subtle);">
                    <button class="btn btn-secondary close-btn btn-xs">Cancel</button>
                    <button class="btn btn-primary confirm-btn btn-xs" style="background: var(--danger); color: white; border: none;">Delete</button>
                </div>
            </div>
        `,document.body.appendChild(i);const t=()=>i.remove(),s=()=>{t();try{typeof u.deletePage=="function"?u.deletePage(e):(console.error("AppState.deletePage is missing"),typeof z=="function"&&z("Error: AppState.deletePage not found","error"))}catch(o){console.error("[Sidebar] Error deleting page:",o),typeof z=="function"&&z("Error deleting page: "+o.message,"error")}};i.querySelectorAll(".close-btn").forEach(o=>o.onclick=t),i.querySelector(".confirm-btn").onclick=s,i.onclick=o=>{o.target===i&&t()}}handleClearPage(){const e=u||window.AppState;if(!e){console.error("[Sidebar] AppState is not defined!"),typeof z=="function"&&z("Error: Application State is not ready.","error");return}const n=document.createElement("div");n.className="modal-backdrop",n.style.display="flex",n.innerHTML=`
            <div class="modal" style="width: 320px; height: auto; min-height: 180px; padding: var(--space-4);">
                <div class="modal-header" style="font-size: var(--fs-md); padding-bottom: var(--space-2);">
                    <div>Clear Page</div>
                </div>
                <div class="modal-body" style="padding: var(--space-2) 0;">
                    <p style="margin-bottom: var(--space-3); font-size: var(--fs-sm);">Are you sure you want to clear all widgets? <b>Locked</b> widgets will stay.</p>
                </div>
                <div class="modal-actions" style="padding-top: var(--space-3); border-top: 1px solid var(--border-subtle);">
                    <button class="btn btn-secondary close-btn btn-xs">Cancel</button>
                    <button class="btn btn-primary confirm-btn btn-xs" style="background: var(--danger); color: white; border: none;">Clear All</button>
                </div>
            </div>
        `,document.body.appendChild(n);const i=()=>{n.remove()},t=()=>{i();try{console.log("[Sidebar] Executing clearCurrentPage...");const r=e.clearCurrentPage(!0);r.preserved>0&&typeof z=="function"?z(`Cleared ${r.deleted} widgets. ${r.preserved} locked widget(s) were preserved.`,"info"):r.deleted>0?z(`Cleared all ${r.deleted} widgets.`,"success"):r.preserved>0?z(`No widgets cleared. ${r.preserved} locked widget(s) preserved.`,"info"):z("Page is already empty.","info"),_.log("Cleared widgets from current page via AppState")}catch(r){console.error("[Sidebar] Error clearing page:",r),typeof z=="function"&&z("Error clearing page: "+r.message,"error")}};n.querySelectorAll(".close-btn").forEach(r=>r.onclick=i);const o=n.querySelector(".confirm-btn");o.onclick=t,n.onclick=r=>{r.target===n&&i()}}setupMobileToggles(){const e=document.getElementById("mobileWidgetsBtn"),n=document.getElementById("mobilePropsBtn"),i=document.getElementById("mobileDeviceBtn"),t=document.getElementById("mobileBackdrop"),s=document.querySelector(".sidebar"),o=document.querySelector(".right-panel"),r=()=>{s?.classList.remove("mobile-active"),o?.classList.remove("mobile-active"),t?.classList.remove("active")};e?.addEventListener("click",()=>{const c=s?.classList.contains("mobile-active");r(),c||(s?.classList.add("mobile-active"),t?.classList.add("active"))}),n?.addEventListener("click",()=>{const c=o?.classList.contains("mobile-active");r(),c||(o?.classList.add("mobile-active"),t?.classList.add("active"))}),i?.addEventListener("click",()=>{r(),window.app?.deviceSettings?.open()}),t?.addEventListener("click",r),Z(P.SELECTION_CHANGED,()=>{window.innerWidth<=768&&(s?.classList.remove("mobile-active"),!o?.classList.contains("mobile-active")&&!s?.classList.contains("mobile-active")&&t?.classList.remove("active"))});const d=this.handlePaletteClick.bind(this);this.handlePaletteClick=c=>{d(c),window.innerWidth<=768&&r()}}}function me(a){if(!a.canvas)return;const e=u.pages,n=u.getCanvasDimensions();a.canvas.querySelectorAll(".snap-guide");const i=a.canvas.querySelector(".lasso-selection");a.canvas.innerHTML="",u.settings.editor_light_mode?a.canvas.classList.add("light-mode"):a.canvas.classList.remove("light-mode");const t=u.getCurrentPage();t&&kt(t)?a.viewport&&a.viewport.classList.add("device-dark-mode"):a.viewport&&a.viewport.classList.remove("device-dark-mode"),e.forEach((r,d)=>{const c=document.createElement("div");c.className="artboard-wrapper",c.dataset.index=d,d===u.currentPageIndex&&c.classList.add("active-page");const l=document.createElement("div");l.className="artboard-header",l.appendChild(ye("mdi-cog-outline","Page Settings",()=>{window.pageSettings&&window.pageSettings.open(d)}));const h=document.createElement("span");h.className="artboard-name",h.textContent=r.name||`Page ${d+1}`,l.appendChild(h);const g=document.createElement("div");g.className="artboard-actions",d>0&&g.appendChild(ye("mdi-chevron-left","Move Left",()=>{u.reorderPage(d,d-1)})),d<e.length-1&&g.appendChild(ye("mdi-chevron-right","Move Right",()=>{u.reorderPage(d,d+1)})),g.appendChild(ye("mdi-plus","Add Page After",()=>{u.addPage(d+1)})),g.appendChild(ye("mdi-eraser","Clear Current Page",()=>{Tt({title:"Clear Page",message:`Are you sure you want to clear all widgets from <b>"${r.name||`Page ${d+1}`}"</b>?<br><br>This cannot be undone.`,confirmLabel:"Clear Page",confirmClass:"btn-danger",onConfirm:()=>{u.setCurrentPageIndex(d),u.clearCurrentPage()}})})),g.appendChild(ye("mdi-delete-outline","Delete Page",()=>{Tt({title:"Delete Page",message:`Are you sure you want to delete the page <b>"${r.name||`Page ${d+1}`}"</b>?<br><br>All widgets on this page will be lost.`,confirmLabel:"Delete Page",confirmClass:"btn-danger",onConfirm:()=>{u.deletePage(d)}})})),l.appendChild(g),c.appendChild(l);const m=u.getCanvasShape(),f=m==="round"||m==="circle",y=document.createElement("div");y.className="artboard",y.dataset.index=d;const b=n.width,w=n.height;y.style.width=`${b}px`,y.style.height=`${w}px`;const v=kt(r);if(y.classList.toggle("dark",v),y.classList.toggle("round-display",f),u.showGrid){const I=document.createElement("div");I.className="canvas-grid",y.appendChild(I)}u.showDebugGrid&&Qi(y),r.layout&&/^\d+x\d+$/.test(r.layout)&&Ki(y,r.layout,n,v);for(const I of r.widgets){const k=document.createElement("div");k.className="widget",k.style.left=I.x+"px",k.style.top=I.y+"px",k.style.width=I.width+"px",k.style.height=I.height+"px",k.dataset.id=I.id,k.dataset.pageIndex=d,u.selectedWidgetIds.includes(I.id)&&k.classList.add("active"),I.locked&&k.classList.add("locked"),I.hidden&&k.classList.add("hidden-widget");const M=(I.type||"").toLowerCase(),E=V?V.get(M):null;if(M==="group")k.classList.add("widget-group"),k.innerHTML="";else if(E&&E.render)try{const x=W=>{const R=W==="theme_auto"?v?"white":"black":W;return R?ft(R):v?"#ffffff":"#000000"},S=u.selectedWidgetIds.includes(I.id),L=u.settings.device_model||"reterminal_e1001",G=F?F[L]:null;E.render(k,I,{getColorStyle:x,selected:S,profile:G})}catch{k.textContent=`Error: ${M}`,k.style.border="2px solid red"}else k.innerText=`Missing: ${M}`,k.style.color="red",k.style.border="1px dashed red";M!=="group"&&Ji(k),y.appendChild(k)}c.appendChild(y),a.canvas.appendChild(c)});const s=document.createElement("div");s.className="add-page-placeholder",s.title="Click to add a new page",s.style.width=`${n.width}px`,s.style.height=`${n.height}px`,s.style.marginTop="32px",s.style.position="relative",s.style.zIndex="2000",s.style.pointerEvents="auto",s.innerHTML=`
        <div class="plus-icon">+</div>
        <div class="label">Add Page</div>
    `;const o=r=>{if(_.log("[Canvas] Add Page placeholder clicked"),r.stopPropagation(),r.preventDefault(),u.addPage()){const c=u.pages.length-1;u.setCurrentPageIndex(c),O(P.STATE_CHANGED)}};s.addEventListener("mousedown",r=>r.stopPropagation()),s.addEventListener("click",o),a.canvas.appendChild(s),i&&a.canvas.appendChild(i),yt(a)}function kt(a){const e=a?.dark_mode;return e==="dark"?!0:e==="light"?!1:!!u.settings.dark_mode}function Ki(a,e,n,i){const t=e.match(/^(\d+)x(\d+)$/);if(!t)return;const s=parseInt(t[1],10),o=parseInt(t[2],10),r=document.createElement("div");r.className="lvgl-grid-overlay",r.style.cssText=`
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        display: grid;
        grid-template-rows: repeat(${s}, 1fr);
        grid-template-columns: repeat(${o}, 1fr);
        pointer-events: none;
        z-index: 1;
    `;const d=i?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)",c=i?"rgba(255,255,255,0.3)":"rgba(0,0,0,0.25)";for(let l=0;l<s;l++)for(let h=0;h<o;h++){const g=document.createElement("div");g.style.cssText=`border: 1px dashed ${d}; position: relative; box-sizing: border-box;`;const m=document.createElement("span");m.textContent=`${l},${h}`,m.style.cssText=`position: absolute; top: 2px; left: 4px; font-size: 8px; color: ${c}; pointer-events: none;`,g.appendChild(m),r.appendChild(g)}a.appendChild(r)}function oe(a){const e=u.zoomLevel,n=u.settings;a.canvasContainer&&(a.canvasContainer.style.transform=`translate(${a.panX}px, ${a.panY}px) scale(${e})`,a.canvasContainer.style.transformOrigin="0 0");const i=(n.grid_opacity!==void 0?n.grid_opacity:8)/100;document.documentElement.style.setProperty("--grid-opacity",i.toString());const t=document.getElementById("zoomLevel");t&&(t.textContent=Math.round(e*100)+"%")}function Oe(a,e,n=!0){const t=a.canvas.querySelectorAll(".artboard-wrapper")[e];if(t){const s=a.viewport.getBoundingClientRect(),o=s.width,r=s.height;if(o===0||r===0){requestAnimationFrame(()=>Oe(a,e,n));return}const d=u.zoomLevel,c=t.offsetLeft+t.offsetWidth/2,l=t.offsetTop+t.offsetHeight/2;a.panX=o/2-c*d,a.panY=r/2-l*d,oe(a)}}function gi(a,e,n=!1){if(!e||!e.id)return;const i=a.canvas.querySelector(`.widget[data-id="${e.id}"]`);if(i){i.style.left=e.x+"px",i.style.top=e.y+"px",i.style.width=e.width+"px",i.style.height=e.height+"px";const t=(e.type||"").toLowerCase(),s=V?V.get(t):null;if(t==="group")i.classList.add("widget-group");else if(!n&&s&&s.render)try{const o=l=>{const h=mi()?"dark":"light";return l?ft(l):h==="dark"?"#ffffff":"#000000"},r=u.selectedWidgetIds.includes(e.id),d=u.settings.device_model||"reterminal_e1001",c=F?F[d]:null;s.render(i,e,{getColorStyle:o,selected:r,profile:c})}catch{}}}function mi(){const e=u.getCurrentPage()?.dark_mode;return e==="dark"?!0:e==="light"?!1:!!u.settings.dark_mode}function Ji(a){["tl","tc","tr","rc","br","bc","bl","lc"].forEach(n=>{const i=document.createElement("div");i.className=`widget-resize-handle handle-${n}`,i.dataset.handle=n,a.appendChild(i)})}function yt(a){const e=u.selectedWidgetIds,n=a.canvas.querySelector(`.artboard[data-index="${u.currentPageIndex}"]`);let i=a.canvas.querySelector(".context-toolbar");if(e.length===0||a.dragState||a.lassoState||!n){i&&i.remove();return}const t=u.getSelectedWidgets();if(t.length===0){i&&i.remove();return}let s=1/0,o=1/0,r=-1/0,d=-1/0;t.forEach(g=>{s=Math.min(s,g.x),o=Math.min(o,g.y),r=Math.max(r,g.x+(g.width||0)),d=Math.max(d,g.y+(g.height||0))});const c=s,l=o-45;if(i?i.parentElement!==n&&n.appendChild(i):(i=document.createElement("div"),i.className="context-toolbar",n.appendChild(i)),i.style.left=c+"px",i.style.top=l+"px",i.innerHTML="",e.length>1&&([{icon:"mdi-align-horizontal-left",title:"Align Left",action:"left"},{icon:"mdi-align-horizontal-center",title:"Align Center",action:"center"},{icon:"mdi-align-horizontal-right",title:"Align Right",action:"right"},{separator:!0},{icon:"mdi-align-vertical-top",title:"Align Top",action:"top"},{icon:"mdi-align-vertical-center",title:"Align Middle",action:"middle"},{icon:"mdi-align-vertical-bottom",title:"Align Bottom",action:"bottom"}].forEach(m=>{if(m.separator){Te(i);return}Ee(i,m.icon,m.title,()=>u.alignSelectedWidgets(m.action))}),e.length>=3&&(Te(i),Ee(i,"mdi-distribute-horizontal-center","Distribute Horizontally",()=>u.distributeSelectedWidgets("horizontal")),Ee(i,"mdi-distribute-vertical-center","Distribute Vertically",()=>u.distributeSelectedWidgets("vertical")))),t.some(g=>g.type==="group"||g.parentId)?(i.children.length>0&&Te(i),Ee(i,"mdi-ungroup","Ungroup (Ctrl+Shift+G)",()=>u.ungroupSelection())):e.length>1&&(i.children.length>0&&Te(i),Ee(i,"mdi-group","Group Selection (Ctrl+G)",()=>u.groupSelection())),i.children.length===0){i.remove();return}}function Ee(a,e,n,i){const t=document.createElement("button");t.className="btn-icon",t.title=n,t.innerHTML=`<i class="mdi ${e}"></i>`,t.onclick=s=>{s.stopPropagation(),i()},a.appendChild(t)}function Te(a){if(!a.lastElementChild||a.lastElementChild.classList.contains("separator"))return;const e=document.createElement("div");e.className="separator",a.appendChild(e)}function ye(a,e,n){const i=document.createElement("button");return i.className="artboard-btn",i.title=e,i.innerHTML=`<i class="mdi ${a}"></i>`,i.onclick=t=>{t.stopPropagation(),n()},i}function Tt({title:a,message:e,confirmLabel:n,confirmClass:i,onConfirm:t}){const s=document.createElement("div");s.className="modal-backdrop",s.style.display="flex",s.innerHTML=`
        <div class="modal" style="width: 340px; height: auto; padding: var(--space-4); border-radius: 12px; border: 1px solid var(--glass-border);">
            <div class="modal-header" style="font-size: var(--fs-md); font-weight: 600; padding-bottom: var(--space-3); border-bottom: 1px solid var(--border-subtle);">
                <div>${a}</div>
            </div>
            <div class="modal-body" style="padding: var(--space-4) 0;">
                <p style="font-size: var(--fs-sm); line-height: 1.5; color: var(--text-dim);">
                    ${e}
                </p>
            </div>
            <div class="modal-actions" style="display: flex; gap: 8px; justify-content: flex-end; padding-top: var(--space-3);">
                <button class="btn btn-secondary close-btn btn-xs" style="border-radius: 6px;">Cancel</button>
                <button class="btn ${i} confirm-btn btn-xs" style="border-radius: 6px;">${n||"Confirm"}</button>
            </div>
        </div>
    `,document.body.appendChild(s);const o=s.querySelector(".close-btn"),r=s.querySelector(".confirm-btn");o.onclick=()=>s.remove(),r.onclick=()=>{t(),s.remove()}}function Qi(a,e,n){const i=document.createElement("div");i.className="debug-grid-overlay",a.appendChild(i)}const Zi=Object.freeze(Object.defineProperty({__proto__:null,applyZoom:oe,focusPage:Oe,getEffectiveDarkMode:mi,render:me,renderContextToolbar:yt,updateWidgetDOM:gi},Symbol.toStringTag,{value:"Module"}));class es{constructor(e){this.canvasInstance=e,this.topRuler=document.getElementById("rulerTop"),this.leftRuler=document.getElementById("rulerLeft"),this.container=document.querySelector(".canvas-rulers"),this.viewport=e.viewport,this.indicators=null,this.init()}init(){!this.topRuler||!this.leftRuler||(this.topCtx=this.createRulerCanvas(this.topRuler),this.leftCtx=this.createRulerCanvas(this.leftRuler),this.update())}createRulerCanvas(e){const n=document.createElement("canvas");return e.appendChild(n),n.getContext("2d")}setIndicators(e){this.indicators=e,this.update()}update(){if(!u.showRulers){this.container&&(this.container.style.display="none"),this.viewport&&this.viewport.classList.remove("with-rulers");return}this.container&&(this.container.style.display="block"),this.viewport&&this.viewport.classList.add("with-rulers");const e=document.querySelector(".artboard-wrapper.active-page .artboard");if(!e)return;const n=this.topRuler.getBoundingClientRect(),i=this.leftRuler.getBoundingClientRect(),t=e.getBoundingClientRect(),s=u.zoomLevel;this.drawHorizontal(n,t,s),this.drawVertical(i,t,s)}drawHorizontal(e,n,i){const t=this.topCtx,s=t.canvas,o=window.devicePixelRatio||1;(s.width!==e.width*o||s.height!==e.height*o)&&(s.width=e.width*o,s.height=e.height*o,t.scale(o,o),s.style.width=e.width+"px",s.style.height=e.height+"px"),t.clearRect(0,0,e.width,e.height);const r=n.left-e.left;if(this.indicators){const l=r+this.indicators.x*i,h=(this.indicators.w||0)*i;t.fillStyle="hsla(var(--accent-h), 85%, 65%, 0.15)",t.fillRect(l,0,h,e.height),t.fillStyle="var(--accent)",t.fillRect(l,e.height-2,h,2)}t.strokeStyle="#4b5563",t.fillStyle="#9ca3af",t.font='9px "JetBrains Mono", monospace',t.lineWidth=1;const d=Math.floor(-r/i/10)*10,c=Math.ceil((e.width-r)/i/10)*10;for(let l=d;l<=c;l+=10){const h=r+l*i;if(h<0||h>e.width)continue;const g=l%100===0,m=l%50===0,f=g?12:m?8:4;t.beginPath(),t.moveTo(h,e.height),t.lineTo(h,e.height-f),t.stroke(),g&&t.fillText(l.toString(),h+2,10)}}drawVertical(e,n,i){const t=this.leftCtx,s=t.canvas,o=window.devicePixelRatio||1;(s.width!==e.width*o||s.height!==e.height*o)&&(s.width=e.width*o,s.height=e.height*o,t.scale(o,o),s.style.width=e.width+"px",s.style.height=e.height+"px"),t.clearRect(0,0,e.width,e.height);const r=n.top-e.top;if(this.indicators){const l=r+this.indicators.y*i,h=(this.indicators.h||0)*i;t.fillStyle="hsla(var(--accent-h), 85%, 65%, 0.15)",t.fillRect(0,l,e.width,h),t.fillStyle="var(--accent)",t.fillRect(e.width-2,l,2,h)}t.strokeStyle="#4b5563",t.fillStyle="#9ca3af",t.font='9px "JetBrains Mono", monospace',t.lineWidth=1;const d=Math.floor(-r/i/10)*10,c=Math.ceil((e.height-r)/i/10)*10;for(let l=d;l<=c;l+=10){const h=r+l*i;if(h<0||h>e.height)continue;const g=l%100===0,m=l%50===0,f=g?12:m?8:4;t.beginPath(),t.moveTo(e.width,h),t.lineTo(e.width-f,h),t.stroke(),g&&(t.save(),t.translate(10,h+2),t.rotate(-Math.PI/2),t.fillText(l.toString(),0,0),t.restore())}}}function de(){document.querySelectorAll(".snap-guide").forEach(e=>e.remove())}function ts(a,e,n){const i=n||a.canvas;if(!i||typeof i.appendChild!="function")return;const t=document.createElement("div");t.className="snap-guide snap-guide-vertical",t.style.left=`${Math.round(e)}px`,i.appendChild(t)}function is(a,e,n){const i=n||a.canvas;if(!i||typeof i.appendChild!="function")return;const t=document.createElement("div");t.className="snap-guide snap-guide-horizontal",t.style.top=`${Math.round(e)}px`,i.appendChild(t)}function ss(a,e){const n=u.getCurrentPage(),i=[],t=[];if(i.push(0,e.width/2,e.width),t.push(0,e.height/2,e.height),n&&Array.isArray(n.widgets))for(const s of n.widgets){if(!s||s.id===a)continue;const o=s.x,r=s.x+(s.width||0),d=s.y,c=s.y+(s.height||0),l=o+(s.width||0)/2,h=d+(s.height||0)/2;i.push(o,l,r),t.push(d,h,c)}return{vertical:i,horizontal:t}}function Pt(a,e,n,i,t){const s=t||a.canvas;if(!s)return;const o=document.createElement("div");o.className=`snap-guide distance-marker distance-marker-${i}`;let r,d,c,l,h;if(i==="h"){const m=e.x<n.x?e.x+e.w:n.x+n.w,f=e.x<n.x?n.x:e.x;if(r=m,d=Math.min(e.y+e.h/2,n.y+n.h/2),c=f-m,c<=0)return;h=Math.round(c),o.style.left=`${r}px`,o.style.top=`${d}px`,o.style.width=`${c}px`,o.style.height="1px";const y=document.createElement("div");y.className="distance-marker-h-tick-start";const b=document.createElement("div");b.className="distance-marker-h-tick-end",o.appendChild(y),o.appendChild(b)}else{const m=e.y<n.y?e.y+e.h:n.y+n.h,f=e.y<n.y?n.y:e.y;if(d=m,r=Math.min(e.x+e.w/2,n.x+n.w/2),l=f-m,l<=0)return;h=Math.round(l),o.style.left=`${r}px`,o.style.top=`${d}px`,o.style.width="1px",o.style.height=`${l}px`;const y=document.createElement("div");y.className="distance-marker-v-tick-start";const b=document.createElement("div");b.className="distance-marker-v-tick-end",o.appendChild(y),o.appendChild(b)}const g=document.createElement("div");g.className="distance-marker-label",g.textContent=h,o.appendChild(g),s.appendChild(o)}function _t(a,e,n,i,t,s,o,r=!1){if(!u.snapEnabled||t)return de(),{x:Math.round(n),y:Math.round(i)};const c=(u.getCurrentPage()?.widgets||[]).filter(E=>E.id!==e.id&&!E.hidden),l=ss(e.id,s),h=e.width||0,g=e.height||0;let m=n,f=i,y=null,b=null;const w=[{val:n,apply:E=>m=E},{val:n+h/2,apply:E=>m=E-h/2},{val:n+h,apply:E=>m=E-h}];let v=be+1;for(const E of w)for(const x of l.vertical){const S=Math.abs(E.val-x);S<=be&&S<v&&(v=S,y=x,E.apply(x))}const I=[{val:i,apply:E=>f=E},{val:i+g/2,apply:E=>f=E-g/2},{val:i+g,apply:E=>f=E-g}];let k=be+1;for(const E of I)for(const x of l.horizontal){const S=Math.abs(E.val-x);S<=be&&S<k&&(k=S,b=x,E.apply(x))}const M={x:m,y:f,w:h,h:g};return de(),y!=null&&ts(a,y,o),b!=null&&is(a,b,o),r&&c.forEach(E=>{const x={x:E.x,y:E.y,w:E.width,h:E.height};if(M.y<x.y+x.h&&M.y+M.h>x.y){const G=M.x<x.x?x.x-(M.x+M.w):M.x-(x.x+x.w);G>0&&G<150&&Pt(a,M,x,"h",o)}if(M.x<x.x+x.w&&M.x+M.w>x.x){const G=M.y<x.y?x.y-(M.y+M.h):M.y-(x.y+x.h);G>0&&G<150&&Pt(a,M,x,"v",o)}}),{x:Math.round(m),y:Math.round(f)}}function bt(a,e,n,i,t,s){const o=t.match(/^(\d+)x(\d+)$/);if(!o)return{x:a,y:e};const r=parseInt(o[1],10),d=parseInt(o[2],10),c=s.width/d,l=s.height/r,h=a+n/2,g=e+i/2,m=Math.round(h/c-.5),f=Math.round(g/l-.5),y=Math.max(0,Math.min(d-1,m)),b=Math.max(0,Math.min(r-1,f));return{x:Math.round(y*c),y:Math.round(b*l)}}function fi(a){const e=u.getCurrentPage();if(!e||!e.layout)return;const n=e.layout.match(/^(\d+)x(\d+)$/);if(!n)return;const i=u.getWidgetById(a);if(!i)return;const t=parseInt(n[1],10),s=parseInt(n[2],10),o=u.getCanvasDimensions(),r=o.width/s,d=o.height/t,c=i.x+i.width/2,l=i.y+i.height/2,h=Math.floor(c/r),g=Math.floor(l/d),m=Math.max(0,Math.min(t-1,g)),f=Math.max(0,Math.min(s-1,h)),y={...i.props,grid_cell_row_pos:m,grid_cell_column_pos:f},b=Math.max(1,Math.round(i.height/d)),w=Math.max(1,Math.round(i.width/r));y.grid_cell_row_span=b,y.grid_cell_column_span=w,u.updateWidget(a,{props:y})}function ns(a){const e=u.getWidgetById(a);if(!e)return;const n=u.getCanvasDimensions(),i=u.getCurrentPage();let t;if(i?.layout)t=bt(e.x,e.y,e.width,e.height,i.layout,n);else{const s=u.snapEnabled;u.snapEnabled=!0,t=_t({canvas:{querySelectorAll:()=>[]}},e,e.x,e.y,!1,n),u.snapEnabled=s}t&&(u.updateWidget(a,{x:t.x,y:t.y}),fi(a),u.recordHistory())}let Xe=null,Mt=!1;Object.defineProperty(window,"lastHighlightRange",{get:()=>Xe,set:function(a){Xe=a},configurable:!0});Object.defineProperty(window,"isAutoHighlight",{get:()=>Mt,set:function(a){Mt=a},configurable:!0});function Pe(a){const e=document.getElementById("snippetBox");if(!e)return;const n=e.value;if(!n)return;const i=Array.isArray(a)?a:a?[a]:[];if(i.length===0){try{e.setSelectionRange(0,0),e.scrollTop=0,Xe=null}catch{}return}let t=-1,s=-1;if(i.forEach(o=>{const r=`id:${o}`,d=n.indexOf(r);if(d!==-1){const c=n.lastIndexOf(`
`,d)+1,l=["# widget:","// widget:","// page:"],h=["esphome:","logger:","api:","ota:","wifi:","ethernet:","psram:","substitutions:","external_components:","packages:","globals:","sensor:","binary_sensor:","text_sensor:","time:","script:","font:","image:","animation:","display:","lvgl:","i2c:","spi:","uart:","output:","light:","switch:","button:","number:","select:","climate:","fan:","cover:","  ]","    ]","  }","    }"];let g=-1;l.forEach(f=>{const y=n.indexOf(f,d+r.length);y!==-1&&(g===-1||y<g)&&(g=y)}),h.forEach(f=>{const y=`
`+f,b=n.indexOf(y,d+r.length);b!==-1&&(g===-1||b<g)&&(g=b+1)});const m=g!==-1?g:n.length;(t===-1||c<t)&&(t=c),m>s&&(s=m)}}),t!==-1&&s!==-1){const o=document.activeElement?document.activeElement.tagName.toLowerCase():"",r=(o==="input"||o==="textarea")&&document.activeElement!==e,d=window.Canvas&&(window.Canvas.dragState||window.Canvas.lassoState);if(!r&&!d){window.isAutoHighlight=!0;try{e.setSelectionRange(t,s),i.length===1&&!window._undoRedoInProgress&&e.focus()}catch{}}window.lastHighlightRange={start:t,end:s},setTimeout(()=>{if(e.scrollTo){const c=n.substring(0,t).split(`
`),l=n.split(`
`).length,h=c.length,g=e.scrollHeight/l;e.scrollTop=h*g-50,e.scrollLeft=0}},10)}}function At(){const a=document.getElementById("snippetBox");if(!a)return;const e=()=>{window.isAutoHighlight&&(window.isAutoHighlight=!1)};a.addEventListener("mousedown",e),a.addEventListener("input",e),a.addEventListener("keydown",n=>{(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Tab","Home","End"].includes(n.key)||!n.ctrlKey&&!n.metaKey)&&e()}),_.log("[YAML Export] Interaction listeners attached to Snippet Box.")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",At):At();let ze=0,Fe=null;function os(a,e,n,i,t,s){Ke(a);const o=document.createElement("div");o.className="drag-ghost-container",o.style.cssText=`
        position: fixed;
        pointer-events: none;
        z-index: 99999;
        opacity: 1.0; 
        transform-origin: top left;
        transform: scale(${t});
        transition: none;
    `;const r=a.dragState?.id,d=s.find(m=>m.id===r)||s[0],c=e.find(m=>m.id===d?.id)||e[0],l=document.querySelector(`.widget[data-id="${c.id}"]`);if(!c||!l)return;const h=[],g=u.getCurrentPage();e.forEach(m=>{if(h.push(m),m.type==="group"){const f=g.widgets.filter(y=>y.parentId===m.id);h.push(...f)}}),h.forEach(m=>{const f=document.querySelector(`.widget[data-id="${m.id}"]`);if(f){const y=f.closest(".artboard"),b=document.createElement("div");b.className=(y?y.className:"artboard")+" ghost-context-sim",b.style.cssText=`
                position: absolute;
                left: ${m.x-c.x}px;
                top: ${m.y-c.y}px;
                width: ${m.width}px;
                height: ${m.height}px;
                pointer-events: none;
                background: transparent !important;
                box-shadow: none !important;
                border: none !important;
                transform: none !important;
                overflow: visible;
                display: block;
            `;const w=document.createElement("div");for(const I of f.attributes)w.setAttribute(I.name,I.value);w.classList.remove("active","dragging-source","locked"),w.classList.add("drag-ghost-widget");const v=window.getComputedStyle(f);w.style.cssText=f.style.cssText,w.style.position="absolute",w.style.top="0",w.style.left="0",w.style.margin="0",w.style.transform="none",w.style.setProperty("background",v.background,"important"),w.style.setProperty("background-color",v.backgroundColor,"important"),w.style.setProperty("border",v.border,"important"),w.style.setProperty("border-radius",v.borderRadius,"important"),w.innerHTML=f.innerHTML,b.appendChild(w),o.appendChild(b)}}),d&&(a.dragGhostOffset={x:d.clickOffsetX*t,y:d.clickOffsetY*t}),document.body.appendChild(o),a.dragGhostEl=o,rs(a,n,i),e.forEach(m=>{const f=document.querySelector(`.widget[data-id="${m.id}"]`);f&&f.classList.add("dragging-source")})}function rs(a,e,n){if(!a.dragGhostEl||!a.dragGhostOffset)return;const i=a.dragGhostOffset,t=e-i.x,s=n-i.y;a.dragGhostEl.style.left=t+"px",a.dragGhostEl.style.top=s+"px"}function as(a,e,n){a.dragGhostEl&&(a.dragGhostEl.style.left=e+"px",a.dragGhostEl.style.top=n+"px")}function Ke(a){a.dragGhostEl&&(a.dragGhostEl.remove(),a.dragGhostEl=null,a.dragGhostOffset=null),document.querySelectorAll(".widget.dragging-source").forEach(e=>{e.classList.remove("dragging-source")})}function ls(a,e){const n=u.getWidgetById(e);if(!n)return;const i=(n.type||"").toLowerCase();if(i!=="text"&&i!=="label")return;const t=a.canvas.querySelector(`.widget[data-id="${e}"]`);if(!t)return;const s=u.zoomLevel,o=t.getBoundingClientRect(),r=document.createElement("textarea");r.value=n.props.text||n.title||"",r.style.position="absolute",r.style.left=o.left+window.scrollX+"px",r.style.top=o.top+window.scrollY+"px",r.style.width=Math.max(50,o.width)+"px",r.style.height=Math.max(30,o.height)+"px",r.style.zIndex="99999";const d=n.props||{},c=(d.font_size||20)*s;r.style.fontSize=c+"px",r.style.fontFamily=(d.font_family||"Roboto")+", sans-serif",r.style.fontWeight=d.font_weight||400,r.style.fontStyle=d.italic?"italic":"normal",r.style.textAlign=(d.text_align||"LEFT").split("_").pop().toLowerCase(),r.style.color=d.color||"black",r.style.background="rgba(255, 255, 255, 0.9)",r.style.border="1px solid #1a73e8",r.style.padding="0px",r.style.resize="both",r.style.outline="none",r.style.overflow="hidden",r.style.lineHeight="1.2",document.body.appendChild(r),r.focus(),r.select();const l=()=>{if(!r.isConnected&&!r.parentElement)return;r.removeEventListener("blur",h),r.removeEventListener("keydown",g);const m=r.value;m!==(n.props.text||n.title)&&u.updateWidget(e,{props:{...n.props,text:m}}),r.remove()},h=()=>l(),g=m=>{m.key==="Enter"&&!m.shiftKey&&(m.preventDefault(),l()),m.key==="Escape"&&r.remove(),r.style.height=r.scrollHeight+"px"};r.addEventListener("blur",h),r.addEventListener("keydown",g)}function ds(a){a.canvas.addEventListener("mousedown",n=>{if(n.button!==0)return;de();const i=n.target.closest(".artboard-wrapper");if(!i||n.target.closest(".artboard-btn")||n.target.closest("button")){document.activeElement&&!n.target.closest("button")&&document.activeElement.blur(),!n.target.closest("button")&&!n.target.closest(".artboard-btn")&&(u.selectWidgets([]),me(a));return}const t=parseInt(i.dataset.index,10),s=i.querySelector(".artboard");let o=s;const r=n.target.closest(".widget");let d=r?.dataset.id;const c=u.currentPageIndex!==t,l=!!n.target.closest(".artboard-header"),h=!!n.target.closest(".artboard")&&!r;if(c){const f=[...u.selectedWidgetIds];u.setCurrentPageIndex(t,{suppressFocus:!0}),d&&u.selectWidgets(f.includes(d)?f:[d]),Oe(a,t,!0);const y=a.canvas.querySelector(`.artboard[data-index="${t}"]`);y&&(o=y)}else(l||h)&&Oe(a,t,!0);const g=o.getBoundingClientRect(),m=u.zoomLevel;if(r){const f=r.dataset.id,y=n.shiftKey||n.ctrlKey,b=Date.now();if(f===Fe&&b-ze<300){ls(a,f),ze=0,Fe=null,n.preventDefault(),n.stopPropagation();return}ze=b,Fe=f,y?u.selectWidget(f,!0):u.selectedWidgetIds.includes(f)||u.selectWidget(f,!1);const w=u.getWidgetById(f);if(!w)return;let v=w,I=f;if(w.parentId){const M=u.getWidgetById(w.parentId);M&&(v=M,I=M.id,u.selectWidget(I,y))}if(n.target.classList.contains("widget-resize-handle")){if(w.parentId||v.locked)return;a.dragState={mode:"resize",handle:n.target.dataset.handle||"br",id:I,startX:n.clientX,startY:n.clientY,startW:v.width,startH:v.height,startWidgetX:v.x,startWidgetY:v.y,artboardEl:o,dragStartPanX:a.panX,dragStartPanY:a.panY}}else{if(v.locked)return;const M=u.getSelectedWidgets(),E=M.map(x=>{const S=a.canvas.querySelector(`.widget[data-id="${x.id}"]`),L=S?S.getBoundingClientRect():null,G=g.left+x.x*m,W=g.top+x.y*m;return L&&(Math.abs(L.left-G)>2||Math.abs(L.top-W)>2)&&console.warn(`[DRAG DEBUG] Widget ${x.id} (${x.type}) position mismatch!`,{widgetData:{x:x.x,y:x.y},domRect:{left:L.left,top:L.top},expected:{left:G,top:W},delta:{x:L.left-G,y:L.top-W}}),{id:x.id,startX:x.x,startY:x.y,clickOffsetX:(n.clientX-g.left)/m-x.x,clickOffsetY:(n.clientY-g.top)/m-x.y}});a.dragState={mode:"move",id:I,widgets:E,artboardEl:o,dragStartX:n.clientX,dragStartY:n.clientY,dragStartPanX:a.panX,dragStartPanY:a.panY},os(a,M,n.clientX,n.clientY,m,E),a.rulers&&a.rulers.setIndicators({x:v.x,y:v.y,w:v.width,h:v.height})}window.addEventListener("mousemove",a._boundMouseMove),window.addEventListener("mouseup",a._boundMouseUp),n.preventDefault()}else{const f=(n.clientX-g.left)/m,y=(n.clientY-g.top)/m;a.lassoState={startX:f,startY:y,rect:null,isAdditive:n.shiftKey||n.ctrlKey,initialSelection:[...u.selectedWidgetIds],artboardEl:o},a.lassoEl=document.createElement("div"),a.lassoEl.className="lasso-selection",s.appendChild(a.lassoEl),window.addEventListener("mousemove",a._boundMouseMove),window.addEventListener("mouseup",a._boundMouseUp),n.preventDefault()}}),a.canvas.addEventListener("contextmenu",n=>{n.preventDefault();const i=n.target.closest(".widget"),t=i?i.dataset.id:null;window.RadialMenu&&window.RadialMenu.show(n.clientX,n.clientY,t)});let e=document.querySelector(".debug-cursor-tooltip");e||(e=document.createElement("div"),e.className="debug-cursor-tooltip",document.body.appendChild(e)),a.canvas.addEventListener("mousemove",n=>{if(!u.showDebugGrid){e.style.display="none";return}const i=n.target.closest(".artboard");if(!i){e.style.display="none";return}const t=i.getBoundingClientRect(),s=u.zoomLevel,o=Math.round((n.clientX-t.left)/s),r=Math.round((n.clientY-t.top)/s);e.style.display="block",e.style.left=n.clientX+"px",e.style.top=n.clientY+"px",e.innerHTML=`<span>X:</span>${o} <span>Y:</span>${r}`}),a.canvas.addEventListener("mouseleave",()=>{e.style.display="none"})}function cs(a,e){const n=u.zoomLevel,i=u.getCanvasDimensions();if(e.dragState){if(e.dragState.mode==="move"){const t=document.querySelector(`.artboard[data-index="${u.currentPageIndex}"]`);if(!t)return;const s=(a.clientX-e.dragState.dragStartX)/n+(e.dragState.dragStartPanX-e.panX)/n,o=(a.clientY-e.dragState.dragStartY)/n+(e.dragState.dragStartPanY-e.panY)/n,r=u.getWidgetById(e.dragState.id);if(!r)return;const d=e.dragState.widgets.find(I=>I.id===e.dragState.id);if(!d)return;let c=d.startX+s,l=d.startY+o;const h=u.getCurrentPage();if(h?.layout&&!a.altKey){de();const I=bt(c,l,r.width,r.height,h.layout,i);c=I.x,l=I.y}else if(u.snapEnabled&&!a.altKey){const I=_t(e,r,c,l,a.altKey,i,t,a.ctrlKey);c=I.x,l=I.y}else de();const g=t.getBoundingClientRect(),m=g.left+c*n,f=g.top+l*n;as(e,m,f);const y=c-d.startX,b=l-d.startY,w=y,v=b;for(const I of e.dragState.widgets){const k=u.getWidgetById(I.id);k&&!k.locked&&(k.x=I.startX+w,k.y=I.startY+v,k.type==="group"&&h.widgets.filter(E=>E.parentId===k.id).forEach(E=>{e.dragState.widgets.find(x=>x.id===E.id)||(E.x+=w-(e.dragState.lastDx||0),E.y+=v-(e.dragState.lastDy||0))}))}e.dragState.lastDx=w,e.dragState.lastDy=v,e.rulers&&e.rulers.setIndicators({x:c,y:l,w:r.width,h:r.height})}else if(e.dragState.mode==="resize"){const t=u.getWidgetById(e.dragState.id);if(!t)return;const s=e.dragState,o=s.handle,r=(s.dragStartPanX-e.panX)/n,d=(s.dragStartPanY-e.panY)/n,c=(a.clientX-s.startX)/n+r,l=(a.clientY-s.startY)/n+d;let h=s.startWidgetX,g=s.startWidgetY,m=s.startW,f=s.startH;o.includes("l")?(m=s.startW-c,h=s.startWidgetX+c):o.includes("r")&&(m=s.startW+c),o.includes("t")?(f=s.startH-l,g=s.startWidgetY+l):o.includes("b")&&(f=s.startH+l);const y=4;isNaN(m)&&(m=s.startW),isNaN(f)&&(f=s.startH),m<y&&(o.includes("l")&&(h=s.startWidgetX+s.startW-y),m=y),f<y&&(o.includes("t")&&(g=s.startWidgetY+s.startH-y),f=y);const b=(t.type||"").toLowerCase();if(b==="line"||b==="lvgl_line"){const w=t.props||{},v=w.orientation||"horizontal",I=parseInt(w.stroke_width||w.line_width||3,10);v==="vertical"?(m=I,f=Math.max(10,f)):(f=I,m=Math.max(10,m))}if(h=Math.max(0,Math.min(i.width-m,h)),g=Math.max(0,Math.min(i.height-f,g)),t.x=Math.round(h),t.y=Math.round(g),t.width=Math.round(m),t.height=Math.round(f),b==="icon"||b==="weather_icon"||b==="battery_icon"||b==="wifi_signal"||b==="ondevice_temperature"||b==="ondevice_humidity"){const w=t.props||{};if(w.fit_icon_to_frame){const I=Math.max(8,Math.min(t.width-8,t.height-8));w.size=Math.round(I)}else{const v=Math.max(8,Math.min(t.width,t.height));w.size=Math.round(v)}}else if(b==="shape_circle"){const w=Math.max(t.width,t.height);t.width=w,t.height=w}gi(e,t),e.rulers&&e.rulers.setIndicators({x:t.x,y:t.y,w:t.width,h:t.height})}}else if(e.lassoState){const t=e.lassoState.artboardEl;if(!t)return;const s=t.getBoundingClientRect(),o=(a.clientX-s.left)/n,r=(a.clientY-s.top)/n,d=Math.min(e.lassoState.startX,o),c=Math.min(e.lassoState.startY,r),l=Math.abs(o-e.lassoState.startX),h=Math.abs(r-e.lassoState.startY);e.lassoState.rect={x:d,y:c,w:l,h},e.lassoEl&&(e.lassoEl.style.left=d+"px",e.lassoEl.style.top=c+"px",e.lassoEl.style.width=l+"px",e.lassoEl.style.height=h+"px");const g=u.getCurrentPage();if(g){const m=new Set(e.lassoState.isAdditive?e.lassoState.initialSelection:[]);e.lassoState.currentSelection=[];const f={x1:d,y1:c,x2:d+l,y2:c+h};for(const y of g.widgets){const b={x1:y.x,y1:y.y,x2:y.x+y.width,y2:y.y+y.height},w=!(b.x2<f.x1||b.x1>f.x2||b.y2<f.y1||b.y1>f.y2),v=e.canvas.querySelector(`.widget[data-id="${y.id}"]`);v&&(w?(v.classList.add("active"),m.add(y.id)):e.lassoState.isAdditive&&e.lassoState.initialSelection.includes(y.id)?v.classList.add("active"):v.classList.remove("active"))}e.lassoState.currentSelection=Array.from(m),u.selectWidgets(e.lassoState.currentSelection)}a.preventDefault(),a.stopPropagation()}}function ps(a,e){if(e.dragState){const n=e.dragState.id;if(e.dragState.mode==="move"){const o=e.canvas.querySelector(`.widget[data-id="${n}"]`),r=o?o.style.pointerEvents:"";o&&(o.style.pointerEvents="none");const d=document.elementFromPoint(a.clientX,a.clientY);o&&(o.style.pointerEvents=r);const c=d?.closest(".artboard");let l=-1;if(c)l=parseInt(c.dataset.index,10);else{const h=d?.closest("#pageList .item");if(h){const g=document.getElementById("pageList");l=Array.from(g.querySelectorAll(".item")).indexOf(h)}}if(l!==-1&&l!==u.currentPageIndex){const h=e.dragState.widgets,g=e.canvas.querySelector(`.artboard[data-index="${l}"]`);let m=0;window.removeEventListener("mousemove",e._boundMouseMove),window.removeEventListener("mouseup",e._boundMouseUp),Ke(e),e.dragState=null,de();let f=null;const y=u.zoomLevel;g&&(f=g.getBoundingClientRect());const b=new Set(h.map(v=>v.id));if(h.filter(v=>{const I=u.getWidgetById(v.id);return!I.parentId||!b.has(I.parentId)}).forEach(v=>{let I=v.startX,k=v.startY;if(f){const M=u.getWidgetById(v.id),E=u.getCanvasDimensions();I=Math.round((a.clientX-f.left)/y-v.clickOffsetX),k=Math.round((a.clientY-f.top)/y-v.clickOffsetY);const x=M?.width||50,S=M?.height||50;I=Math.max(0,Math.min(E.width-x,I)),k=Math.max(0,Math.min(E.height-S,k))}u.moveWidgetToPage(v.id,l,I,k)&&m++}),m>0){_.log(`[Canvas] Moved ${m} widgets to page ${l}`),me(e);return}}}window.removeEventListener("mousemove",e._boundMouseMove),window.removeEventListener("mouseup",e._boundMouseUp),Ke(e);const t=u.getCanvasDimensions();(e.dragState?.widgets||[]).forEach(o=>{const r=u.getWidgetById(o.id);r&&!r.locked&&(r.x=Math.max(0,Math.min(t.width-r.width,r.x)),r.y=Math.max(0,Math.min(t.height-r.height,r.y)))}),e.dragState=null,e.rulers&&e.rulers.setIndicators(null),de(),fi(n),u.recordHistory(),O(P.STATE_CHANGED),me(e)}else if(e.lassoState){if(window.removeEventListener("mousemove",e._boundMouseMove),window.removeEventListener("mouseup",e._boundMouseUp),e.lassoEl&&(e.lassoEl.remove(),e.lassoEl=null),e.lassoState.rect){const n=e.lassoState.currentSelection||[];u.selectWidgets(n)}else e.lassoState.isAdditive||u.selectWidgets([]);e.lassoState=null,me(e),a.preventDefault(),a.stopPropagation()}}function hs(a){a.viewport&&a.viewport.addEventListener("mousedown",e=>{if(e.button===1){e.preventDefault(),e.stopPropagation(),a.panState={startX:e.clientX,startY:e.clientY,startPanX:a.panX,startPanY:a.panY},a.viewport.style.cursor="grabbing",document.body.classList.add("panning-active");const n=t=>{if(a.panState){const s=t.clientX-a.panState.startX,o=t.clientY-a.panState.startY;a.panX=a.panState.startPanX+s,a.panY=a.panState.startPanY+o,oe(a)}},i=()=>{a.panState=null,a.viewport.style.cursor="auto",document.body.classList.remove("panning-active"),window.removeEventListener("mousemove",n),window.removeEventListener("mouseup",i)};window.addEventListener("mousemove",n),window.addEventListener("mouseup",i)}})}function us(a){const e=document.getElementById("zoomInBtn"),n=document.getElementById("zoomOutBtn"),i=document.getElementById("zoomResetBtn"),t=document.getElementById("gridToggleBtn"),s=document.getElementById("debugGridToggleBtn"),o=document.getElementById("rulersToggleBtn"),r=document.getElementById("editorGridOpacity");e&&e.addEventListener("click",()=>Je(a)),n&&n.addEventListener("click",()=>Qe(a)),i&&i.addEventListener("click",()=>Ae(a)),t&&(t.classList.toggle("active",!!u.showGrid),t.addEventListener("click",()=>{const d=!u.showGrid;u.setShowGrid(d),d&&(u.setShowDebugGrid(!1),s&&s.classList.remove("active")),t.classList.toggle("active",d),O(P.STATE_CHANGED)})),s&&(s.classList.toggle("active",!!u.showDebugGrid),s.addEventListener("click",()=>{const d=!u.showDebugGrid;u.setShowDebugGrid(d),d&&(u.setShowGrid(!1),t&&t.classList.remove("active")),s.classList.toggle("active",d),O(P.STATE_CHANGED)})),o&&(o.classList.toggle("active",!!u.showRulers),o.addEventListener("click",()=>{const d=!u.showRulers;u.setShowRulers(d),o.classList.toggle("active",d),_.log(`[Canvas] Rulers toggled: ${d}`)})),r&&r.addEventListener("input",d=>{u.updateSettings({grid_opacity:parseInt(d.target.value,10)})}),a.canvasContainer&&a.canvasContainer.addEventListener("wheel",d=>{d.preventDefault(),Dt(d,a)},{passive:!1}),a.viewport&&a.viewport.addEventListener("wheel",d=>{d.preventDefault(),Dt(d,a)},{passive:!1}),document.addEventListener("keydown",d=>{d.ctrlKey&&(d.key==="+"||d.key==="=")?(d.preventDefault(),Je(a)):d.ctrlKey&&d.key==="-"?(d.preventDefault(),Qe(a)):d.ctrlKey&&d.key==="0"||d.ctrlKey&&d.key.toLowerCase()==="r"?(d.preventDefault(),Ae(a)):d.ctrlKey&&d.key.toLowerCase()==="g"&&(d.preventDefault(),d.shiftKey?u.ungroupSelection():u.groupSelection())})}function Dt(a,e){const n=u.zoomLevel;let i=0;if(a.ctrlKey)i=a.deltaY>0?-.02:.02;else if(a.deltaMode===0&&a.deltaX===0&&Math.abs(a.deltaY)>=50)i=a.deltaY>0?-.05:.05;else{e.panX-=a.deltaX,e.panY-=a.deltaY,oe(e);return}if(i===0)return;const t=Math.min(Math.max(n+i,.1),5);if(t===n)return;const s=e.viewport.getBoundingClientRect(),o=a.clientX-s.left,r=a.clientY-s.top,d=(o-e.panX)/n,c=(r-e.panY)/n;e.panX=o-d*t,e.panY=r-c*t,u.setZoomLevel(t),oe(e)}function Je(a){yi(.05,a)}function Qe(a){yi(-.05,a)}function yi(a,e){const n=u.zoomLevel,i=Math.min(Math.max(n+a,.1),5);if(i!==n){if(e&&e.viewport){const t=e.viewport.getBoundingClientRect(),s=t.width/2,o=t.height/2,r=(s-e.panX)/n,d=(o-e.panY)/n;e.panX=s-r*i,e.panY=o-d*i}u.setZoomLevel(i),e&&oe(e)}}function Ae(a){u.setZoomLevel(1),a.focusPage(0,!0)}function gs(a){a.canvas&&(a.canvas.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy";const n=e.target.closest(".artboard-wrapper");document.querySelectorAll(".artboard-wrapper.drag-over").forEach(t=>{t!==n&&t.classList.remove("drag-over")}),n&&n.classList.add("drag-over");const i=e.target.closest(".add-page-placeholder");if(i)i.classList.add("drag-over");else{const t=document.querySelector(".add-page-placeholder.drag-over");t&&t.classList.remove("drag-over")}}),a.canvas.addEventListener("dragleave",e=>{(e.relatedTarget===null||!a.canvas.contains(e.relatedTarget))&&document.querySelectorAll(".artboard-wrapper.drag-over, .add-page-placeholder.drag-over").forEach(n=>{n.classList.remove("drag-over")})}),a.canvas.addEventListener("drop",async e=>{e.preventDefault(),document.querySelectorAll(".artboard-wrapper.drag-over, .add-page-placeholder.drag-over").forEach(c=>{c.classList.remove("drag-over")});const n=e.dataTransfer.getData("application/widget-type")||e.dataTransfer.getData("text/plain");if(!n)return;const i=e.clientX,t=e.clientY,s=e.target.closest(".artboard-wrapper"),o=e.target.closest(".add-page-placeholder");let r=-1,d=null;if(s){r=parseInt(s.dataset.index,10);const c=s.querySelector(".artboard");c&&(d=c.getBoundingClientRect())}else if(o)r=u.pages.length;else{r=u.currentPageIndex;const c=a.canvas.querySelector(`.artboard[data-index="${r}"]`);c&&(d=c.getBoundingClientRect())}_.log("[Canvas] Atomic drop capture - type:",n,"page:",r);try{const c=V.load(n);if(o){if(!u.addPage())return;r=u.pages.length-1,await new Promise(y=>setTimeout(y,50));const f=a.canvas.querySelector(`.artboard[data-index="${r}"]`);f&&(d=f.getBoundingClientRect())}await c;const l=We.createWidget(n);if(!l){_.error("[Canvas] WidgetFactory.createWidget returned null for type:",n);return}const h=u.zoomLevel,g=u.getCanvasDimensions();if(d){const m=(i-d.left)/h,f=(t-d.top)/h;l.x=Math.round(m-l.width/2),l.y=Math.round(f-l.height/2)}else _.warn("[Canvas] No targetRect, using fallback position"),l.x=40,l.y=40;l.x=Math.max(0,Math.min(g.width-l.width,l.x)),l.y=Math.max(0,Math.min(g.height-l.height,l.y)),u.addWidget(l,r),u.currentPageIndex!==r&&u.setCurrentPageIndex(r),u.selectWidget(l.id,!1),_.log(`[Canvas] Successfully added ${n} at (${l.x}, ${l.y})`)}catch(c){_.error("[Canvas] error creating widget from drop:",c)}}))}function ms(a){!a.canvas||!a.canvasContainer||(a.canvas.addEventListener("touchstart",e=>{const n=e.touches;if(n.length===2){e.preventDefault(),a.pinchState={startDistance:Ze(n[0],n[1]),startZoom:u.zoomLevel,startPanX:a.panX,startPanY:a.panY,startCenterX:(n[0].clientX+n[1].clientX)/2,startCenterY:(n[0].clientY+n[1].clientY)/2},a.touchState=null;return}if(n.length===1){const i=n[0],t=i.target.closest(".widget");if(a.longPressTimer&&clearTimeout(a.longPressTimer),a.longPressTimer=setTimeout(()=>{const s=t?t.dataset.id:null;window.RadialMenu&&window.RadialMenu.show(i.clientX,i.clientY,s),a.touchState=null},600),t){e.preventDefault();const s=t.dataset.id,o=u.getWidgetById(s);if(!o)return;i.target.classList.contains("widget-resize-handle")?a.touchState={mode:"resize",id:s,startX:i.clientX,startY:i.clientY,startW:o.width,startH:o.height,el:t}:a.touchState={mode:"move",id:s,startTouchX:i.clientX,startTouchY:i.clientY,startWidgetX:o.x,startWidgetY:o.y,hasMoved:!1,el:t},window.addEventListener("touchmove",d=>Ge(d,a),{passive:!1}),window.addEventListener("touchend",d=>_e(d,a)),window.addEventListener("touchcancel",d=>_e(d,a))}else{const s=Date.now();if(s-a.lastTapTime<300){u.setZoomLevel(1),a.panX=0,a.panY=0,oe(a),a.lastTapTime=0,e.preventDefault();return}a.lastTapTime=s,e.preventDefault(),a.touchState={mode:"pan",startTouchX:i.clientX,startTouchY:i.clientY,startPanX:a.panX,startPanY:a.panY},window.addEventListener("touchmove",o=>Ge(o,a),{passive:!1}),window.addEventListener("touchend",o=>_e(o,a)),window.addEventListener("touchcancel",o=>_e(o,a))}}},{passive:!1}),a.canvasContainer.addEventListener("touchstart",e=>{if(e.touches.length===2){e.preventDefault();const n=e.touches;a.pinchState={startDistance:Ze(n[0],n[1]),startZoom:u.zoomLevel,startPanX:a.panX,startPanY:a.panY,startCenterX:(n[0].clientX+n[1].clientX)/2,startCenterY:(n[0].clientY+n[1].clientY)/2},a.touchState=null,window.addEventListener("touchmove",i=>Ge(i,a),{passive:!1}),window.addEventListener("touchend",i=>_e(i,a)),window.addEventListener("touchcancel",i=>_e(i,a))}},{passive:!1}))}function Ge(a,e){const n=a.touches;if(e.pinchState&&n.length===2){a.preventDefault();const t=Ze(n[0],n[1])/e.pinchState.startDistance,s=Math.max(.25,Math.min(4,e.pinchState.startZoom*t));u.setZoomLevel(s);const o=(n[0].clientX+n[1].clientX)/2,r=(n[0].clientY+n[1].clientY)/2,d=o-e.pinchState.startCenterX,c=r-e.pinchState.startCenterY;e.panX=e.pinchState.startPanX+d,e.panY=e.pinchState.startPanY+c,oe(e);return}if(n.length===1&&e.longPressTimer){const i=n[0],t=i.clientX-(e.touchState?.startTouchX||i.clientX),s=i.clientY-(e.touchState?.startTouchY||i.clientY);Math.hypot(t,s)>10&&(clearTimeout(e.longPressTimer),e.longPressTimer=null)}if(e.touchState&&n.length===1){a.preventDefault();const i=n[0];if(e.touchState.mode==="pan"){const t=i.clientX-e.touchState.startTouchX,s=i.clientY-e.touchState.startTouchY;e.panX=e.touchState.startPanX+t,e.panY=e.touchState.startPanY+s,oe(e)}else if(e.touchState.mode==="move"){const t=i.clientX-e.touchState.startTouchX,s=i.clientY-e.touchState.startTouchY;if(!e.touchState.hasMoved&&Math.hypot(t,s)<5)return;e.touchState.hasMoved=!0;const o=u.getWidgetById(e.touchState.id);if(!o)return;const r=u.getCanvasDimensions(),d=u.zoomLevel;let c=e.touchState.startWidgetX+t/d,l=e.touchState.startWidgetY+s/d;c=Math.max(0,Math.min(r.width-o.width,c)),l=Math.max(0,Math.min(r.height-o.height,l)),o.x=c,o.y=l,e.touchState.el&&(e.touchState.el.style.left=c+"px",e.touchState.el.style.top=l+"px")}else if(e.touchState.mode==="resize"){const t=u.getWidgetById(e.touchState.id);if(!t)return;const s=u.getCanvasDimensions(),o=u.zoomLevel;let r=e.touchState.startW+(i.clientX-e.touchState.startX)/o,d=e.touchState.startH+(i.clientY-e.touchState.startY)/o;const c=(t.type||"").toLowerCase();if(c==="line"||c==="lvgl_line"){const h=t.props||{},g=h.orientation||"horizontal",m=parseInt(h.stroke_width||h.line_width||3,10);g==="vertical"?(r=m,d=Math.max(10,d)):(d=m,r=Math.max(10,r))}const l=20;r=Math.max(l,Math.min(s.width-t.x,r)),d=Math.max(l,Math.min(s.height-t.y,d)),t.width=r,t.height=d,e.touchState.el&&(e.touchState.el.style.width=r+"px",e.touchState.el.style.height=d+"px")}}}function _e(a,e){if(e.touchState){const n=e.touchState.id,i=e.touchState.mode,t=e.touchState.hasMoved;if(n){const s=u.getWidgetById(n);if(s){if(i==="move"&&t){const o=u.getCanvasDimensions(),r=u.getCurrentPage();if(r?.layout){const d=bt(s.x,s.y,s.width,s.height,r.layout,o);s.x=d.x,s.y=d.y}else{const d=_t(e,s,s.x,s.y,!1,o);s.x=d.x,s.y=d.y}}else i==="resize"&&(s.width=Math.round(s.width),s.height=Math.round(s.height));u.selectWidget(n)}(i==="move"||i==="resize")&&t&&(fs(e,n),u.recordHistory(),O(P.STATE_CHANGED))}e.touchState=null,de(),me(e)}e.pinchState&&(e.pinchState=null),e.longPressTimer&&(clearTimeout(e.longPressTimer),e.longPressTimer=null)}function Ze(a,e){return Math.hypot(e.clientX-a.clientX,e.clientY-a.clientY)}function fs(a,e){const n=u.getCurrentPage();if(!n||!n.layout)return;const i=n.layout.match(/^(\d+)x(\d+)$/);if(!i)return;const t=u.getWidgetById(e);if(!t)return;const s=parseInt(i[1],10),o=parseInt(i[2],10),r=u.getCanvasDimensions(),d=r.width/o,c=r.height/s,l=t.x+t.width/2,h=t.y+t.height/2,g=Math.floor(l/d),m=Math.floor(h/c),f=Math.max(0,Math.min(s-1,m)),y=Math.max(0,Math.min(o-1,g)),b={...t.props,grid_cell_row_pos:f,grid_cell_column_pos:y},w=Math.max(1,Math.round(t.height/c)),v=Math.max(1,Math.round(t.width/d));b.grid_cell_row_span=w,b.grid_cell_column_span=v,u.updateWidget(e,{props:b})}class ys{constructor(){this.canvas=document.getElementById("canvas"),this.canvasContainer=document.getElementById("canvasContainer"),this.viewport=document.querySelector(".canvas-viewport"),this.dragState=null,this.panX=0,this.panY=0,this.touchState=null,this.pinchState=null,this.lastTapTime=0,this._boundMouseMove=e=>cs(e,this),this._boundMouseUp=e=>ps(e,this),this.rulers=new es(this),this.init()}init(){Z(P.STATE_CHANGED,()=>this.render()),Z(P.PAGE_CHANGED,e=>{this.render(),e.suppressFocus||this.focusPage(e.index)}),Z(P.SELECTION_CHANGED,()=>this.updateSelectionVisuals()),Z(P.SETTINGS_CHANGED,()=>{this.render(),this.applyZoom(),this.rulers.update()}),Z(P.ZOOM_CHANGED,()=>{this.applyZoom(),this.rulers.update()}),this._boundResize=()=>{u.currentPageIndex!==-1&&this.focusPage(u.currentPageIndex,!1)},window.addEventListener("resize",this._boundResize),this.setupInteractions(),this.render(),this.applyZoom(),this.updateInterval&&clearInterval(this.updateInterval),this.updateInterval=setInterval(()=>{if(this.touchState||this.pinchState||this.dragState||this.panState||this.lassoState)return;const e=u.getCurrentPage();e&&e.widgets.some(n=>n.type==="datetime")&&this.render()},1e3)}render(){me(this)}applyZoom(){oe(this),this.rulers&&this.rulers.update()}updateSelectionVisuals(){const e=u.selectedWidgetIds;this.canvas.querySelectorAll(".widget").forEach(i=>{const t=i.dataset.id;e.includes(t)?i.classList.add("active"):i.classList.remove("active")}),yt(this)}setupInteractions(){hs(this),ds(this),us(this),gs(this),ms(this)}zoomIn(){Je(this)}zoomOut(){Qe(this)}zoomReset(){Ae(this)}focusPage(e,n=!0){N(()=>Promise.resolve().then(()=>Zi),[],import.meta.url).then(i=>i.focusPage(this,e,n))}destroy(){this.updateInterval&&(clearInterval(this.updateInterval),this.updateInterval=null),this._boundResize&&window.removeEventListener("resize",this._boundResize)}}function _s(a,e,n){if(!q()){_.warn("Entity Picker: No HA backend detected.");return}const i=document.getElementById("propertiesPanel")||document.body,t=document.querySelector(".entity-picker-overlay");t&&t.remove();const s=document.createElement("div");s.className="entity-picker-overlay";const o=document.createElement("div");o.className="entity-picker-header",o.textContent="Pick Home Assistant entity";const r=document.createElement("button");r.className="btn btn-secondary",r.textContent="",r.style.padding="0 4px",r.style.fontSize="9px",r.type="button",r.addEventListener("click",()=>{s.remove()});const d=document.createElement("div");d.style.display="flex",d.style.alignItems="center",d.style.gap="4px",d.appendChild(r);const c=document.createElement("div");c.style.display="flex",c.style.justifyContent="space-between",c.style.alignItems="center",c.style.gap="4px",c.appendChild(o),c.appendChild(d);const l=document.createElement("div");l.style.display="flex",l.style.gap="4px",l.style.alignItems="center";const h=document.createElement("input");h.type="text",h.className="prop-input",h.placeholder="Search name or entity_id",h.style.flex="1";const g=document.createElement("select");g.className="prop-input",g.style.width="80px",["all","sensor","binary_sensor","light","switch","fan","cover","climate","media_player","input_number","number","input_boolean","input_text","input_select","weather","scene","script","button","input_button"].forEach(y=>{const b=document.createElement("option");b.value=y,b.textContent=y,g.appendChild(b)}),l.appendChild(h),l.appendChild(g);const m=document.createElement("div");m.className="entity-picker-list",s.appendChild(c),s.appendChild(l),s.appendChild(m),i.appendChild(s);function f(y){if(m.innerHTML="",!y||y.length===0){const b=document.createElement("div");b.style.color="var(--muted)",b.style.fontSize="var(--fs-xs)",b.textContent="No entities match.",m.appendChild(b);return}y.forEach(b=>{const w=document.createElement("div");w.className="entity-picker-row";const v=document.createElement("div");v.className="entity-picker-name",v.textContent=b.name||b.entity_id;const I=document.createElement("div");I.className="entity-picker-meta",I.textContent=`${b.entity_id}  ${b.domain||b.entity_id.split(".")[0]}`,w.appendChild(v),w.appendChild(I),w.addEventListener("click",()=>{if(n&&n(b.entity_id),e&&(e.value=b.entity_id),a&&u){if(u.updateWidget(a.id,{entity_id:b.entity_id,title:b.name||b.entity_id||""}),a.type==="graph"&&b.attributes){const k=b.attributes,M={};if(k.unit_of_measurement==="%"&&(a.props.min_value||(M.min_value="0"),a.props.max_value||(M.max_value="100")),k.min!==void 0&&!a.props.min_value&&(M.min_value=String(k.min)),k.max!==void 0&&!a.props.max_value&&(M.max_value=String(k.max)),Object.keys(M).length>0){const E={...a.props,...M};u.updateWidget(a.id,{props:E})}}if(a.type==="sensor_text"){const k={...a.props};b.attributes&&b.attributes.unit_of_measurement?k.unit=b.attributes.unit_of_measurement:b.unit&&(k.unit=b.unit);const M=b.state;if(b.entity_id.startsWith("weather.")||b.entity_id.startsWith("text_sensor."))k.is_text_sensor=!0;else if(M!=null&&M!==""){const x=parseFloat(M);isNaN(x)?k.is_text_sensor=!0:k.is_text_sensor=!1}u.updateWidget(a.id,{props:k})}}s.remove()}),m.appendChild(w)})}ge().then(y=>{if(!y||y.length===0){f([]);return}function b(){const w=(h.value||"").toLowerCase(),v=g.value,I=y.filter(k=>{const M=k.domain||k.entity_id.split(".")[0];return v!=="all"&&M!==v?!1:w?`${k.entity_id} ${k.name||""}`.toLowerCase().includes(w):!0});f(I)}h.addEventListener("input",b),g.addEventListener("change",b),b()})}let te=null,ue=null,we=null,Me=null,ae=null,ve=null;function bs(){te||(te=document.getElementById("iconPickerModal"),ue=document.getElementById("iconPickerFilter"),we=document.getElementById("iconPickerList"),Me=document.getElementById("iconPickerClose"),te||(te=document.createElement("div"),te.id="iconPickerModal",te.className="modal-backdrop hidden",te.style.zIndex="2000",te.innerHTML=`
            <div class="modal" style="max-width: 500px; height: 80vh; display: flex; flex-direction: column;">
                <div class="modal-header">
                    <div>Select Icon</div>
                    <button id="iconPickerClose" class="btn btn-secondary"></button>
                </div>
                <div class="modal-body" style="flex: 1; overflow: hidden; display: flex; flex-direction: column; padding: 15px;">
                    <input type="text" id="iconPickerFilter" class="prop-input" placeholder="Filter icons..." style="width: 100%; margin-bottom: 12px;">
                    <div id="iconPickerList" style="flex: 1; overflow-y: auto; border: 1px solid var(--border-subtle); border-radius: 4px; display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px; padding: 10px; background: var(--bg-canvas);"></div>
                </div>
            </div>
        `,document.body.appendChild(te),ue=document.getElementById("iconPickerFilter"),we=document.getElementById("iconPickerList"),Me=document.getElementById("iconPickerClose")),Me&&(Me.onclick=et),ue&&(ue.oninput=a=>{const e=a.target;ws(e.value)}),te.onclick=a=>{a.target===te&&et()})}function Bt(a,e){bs(),ae=a,ve=e,te.classList.remove("hidden"),te.style.display="flex",ue&&(ue.value="",ue.focus()),tt(ui||[])}function et(){te&&(te.classList.add("hidden"),te.style.display="none"),ae=null,ve=null}function tt(a){if(!we)return;if(we.innerHTML="",!a||a.length===0){we.innerHTML='<div style="padding: 10px; color: var(--muted); grid-column: 1 / -1; text-align: center;">No icons found.</div>';return}const e=document.createDocumentFragment();a.forEach(n=>{const i=document.createElement("div");i.className="icon-item",i.style.padding="8px",i.style.border="1px solid var(--border-subtle)",i.style.borderRadius="4px",i.style.cursor="pointer",i.style.display="flex",i.style.flexDirection="column",i.style.alignItems="center",i.style.justifyContent="center",i.style.textAlign="center",i.style.background="var(--bg)",i.title=n.name;const t=document.createElement("div");t.className="mdi",t.style.fontSize="24px",t.style.color="var(--accent)";const s=parseInt(n.code,16);t.textContent=String.fromCodePoint(s);const o=document.createElement("div");o.style.fontSize="9px",o.style.marginTop="4px",o.style.overflow="hidden",o.style.textOverflow="ellipsis",o.style.whiteSpace="nowrap",o.style.width="100%",o.style.color="var(--muted)",o.textContent=n.name,i.appendChild(t),i.appendChild(o),i.onclick=()=>vs(n),i.onmouseenter=()=>{i.style.borderColor="var(--accent)",i.style.background="rgba(110, 68, 255, 0.05)"},i.onmouseleave=()=>{i.style.borderColor="var(--border-subtle)",i.style.background="var(--bg)"},e.appendChild(i)}),we.appendChild(e)}function ws(a){const e=ui||[];if(!a){tt(e);return}const n=a.toLowerCase(),i=e.filter(t=>t.name.toLowerCase().includes(n)||t.code.toLowerCase().includes(n));tt(i)}function vs(a){ae&&(ve?(ve.value=a.code,ve.dispatchEvent(new Event("input")),ve.dispatchEvent(new Event("change"))):(ae.props||(ae.props={}),ae.props.code=a.code,u&&u.updateWidget(ae.id,ae))),et()}const xs=`# Dictionary to map calendar keys to their corresponding names
# One word calandars don't need to be added calendar.jobs would map to Jobs by default without adding it here
# calendar.hello_world should be added on the other hand
CALENDAR_NAMES = {"calendar.x": "X", "calendar.Y": "Y"}
# Day names (which are displayed in the calendar event list) can be translated here if required
DAY_NAMES = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"]
# How many entries to send to the ESPHome device
MAX_ENTRIES = 8

def convert_calendar_format(data, today):
    # Initialize a dictionary to store events grouped by date
    events_by_date = {}
    entrie_count = 0
    
    # Variable to store the end time of the closest event that will end
    closest_end_time = None
    
    # Iterate through calendar keys and events
    for calendar_key, events_list in data.items():
        for event in events_list['events']:
            if 'description' in event:
                event.pop('description')
                
            # Attempt to split the 'event[start]' into date and time parts
            parts = event['start'].split("T")
            event_date = parts[0]
            event_time = parts[1] if len(parts) > 1 else None  # event_time might not be present
            
            # Compare the event_date with today's date
            if event_date < today:
                # If the event's date is before today, update it to today's date (in case of multi day event starting before today)
                event['start'] = today if event_time is None else f"{today}T{event_time}"
                event_date = today
            
            # Add calendar name to event
            # If calendar key exists in CALENDAR_NAMES, use its value, otherwise capitalize the second part of the key
            event['calendar_name'] = CALENDAR_NAMES.get(calendar_key, calendar_key.split(".")[1].capitalize())
            
            # Parse location_name and location_address
            if 'location' in event:
                # Split the 'location' string into lines based on the newline character
                location_lines = event['location'].split('\\\\n')
                if len(location_lines) >= 2:
                    # If there are at least two lines, consider the first line as 'location_name' and the second line as 'location_address'
                    event['location_name'] = location_lines[0]
                    # event['location_address'] = location_lines[1]
                elif len(location_lines) == 1:
                    # If there's only one line, consider it as 'location_name'
                    event['location_name'] = location_lines[0]
                    
                # Remove the 'location' key from the event since it's been parsed into 'location_name' and 'location_address'
                event.pop('location')
                    
            # Add event to events_by_date dictionary
            if event_date in events_by_date:
                events_by_date[event_date].append(event)
            else:
                events_by_date[event_date] = [event]
                
    # Sort events by date
    sorted_dates = sorted(events_by_date.keys())
    
    # Initialize a list to store the final date objects
    result = []
    
    # Iterate through sorted dates
    for date in sorted_dates:
        all_day_events = []
        other_events = []
        for event in events_by_date[date]:
            if entrie_count == MAX_ENTRIES:
                break
            
            # Check if the event lasts for the whole day
            start_date = event['start']
            end_date = event['end']
            if 'T' not in event['start']:
                all_day_events.append(event)
            else:
                other_events.append(event)
                
            entrie_count = entrie_count + 1
        
        if other_events and date == today:
            closest_end_time = sorted(other_events, key=lambda item:dt_util.parse_datetime(item['end']), reverse=False)[0]["end"]
        
        if all_day_events or other_events:
            # Sort other_events by start time
            other_events.sort(key=lambda item:dt_util.parse_datetime(item['start']), reverse=False)
            
            # Construct dictionary for the date
            # is_today cast to int because a bool somehow crashes my esphome config
            day_item = {
                'date': date,
                'day': dt_util.parse_datetime(date).day,
                'is_today': int(date == dt_util.now().isoformat().split("T")[0]),
                'day_name': DAY_NAMES[dt_util.parse_datetime(date).weekday()],
                'all_day': all_day_events,
                'other': other_events
            }
            result.append(day_item)
        
    return (result, closest_end_time)

# Access the data received from the Home Assistant service call
input_data = data["calendar"]
today = data["now"]

# Convert the received data into the format expected by the epaper display
converted_data = convert_calendar_format(input_data, today)

# Pass the output back to Home Assistant
output["entries"] = {"days": converted_data[0]}
output["closest_end_time"] = converted_data[1]
`;class Es{constructor(){this.panel=document.getElementById("propertiesPanel"),this.lastRenderedWidgetId=null,this.containerStack=[],this.sectionStates={},this.init()}init(){Z(P.SELECTION_CHANGED,()=>this.render()),Z(P.STATE_CHANGED,()=>this.render());const e=document.getElementById("snapToggle");e&&(e.checked=u.snapEnabled,e.addEventListener("change",i=>{u.setSnapEnabled(i.target.checked)}),Z(P.SETTINGS_CHANGED,i=>{i.snapEnabled!==void 0&&(e.checked=i.snapEnabled)}));const n=document.getElementById("lockPositionToggle");n&&n.addEventListener("change",i=>{const t=u.selectedWidgetIds;t.length>0&&u.updateWidgets(t,{locked:i.target.checked})}),this.render()}render(){if(!this.panel||window.Canvas&&window.Canvas.lassoState)return;const e=u.selectedWidgetId;if(!(this.lastRenderedWidgetId!==e)&&this.panel&&this.panel.isConnected){const l=document.activeElement;if(l&&this.panel.contains(l)){const h=l.tagName.toLowerCase();if(l.type&&l.type.toLowerCase(),h==="input"||h==="textarea"||h==="select"||l.classList.contains("prop-input"))return}}this.lastRenderedWidgetId=e,this.containerStack=[],this.panel.innerHTML="";const i=document.getElementById("lockPositionToggle");if(i){const l=u.getSelectedWidgets(),h=l.length>0&&l.every(m=>m.locked),g=l.some(m=>m.locked);i.checked=h,i.indeterminate=g&&!h,i.disabled=l.length===0}if(u.selectedWidgetIds.length===0){this.panel.innerHTML="<div style='padding:16px;color:#aaa;text-align:center;'>Select a widget to edit properties</div>";return}if(u.selectedWidgetIds.length>1){this.panel.innerHTML=`
                <div style='padding:16px; text-align:center;'>
                    <div style="font-size: 24px; margin-bottom: 12px;"></div>
                    <div style="font-weight: 600; color: var(--text);">${u.selectedWidgetIds.length} widgets selected</div>
                    <div style="font-size: 11px; color: var(--muted); margin-top: 8px; margin-bottom: 16px;">
                        Move, group, or delete the selection. Use the Lock toggle above to lock all.
                    </div>
                    <button id="multiDeleteBtn" class="btn btn-secondary btn-xs" style="background: var(--danger); color: white; border: none; width: 100%;">
                         Delete Selected Widgets
                    </button>
                </div>
    `;const l=this.panel.querySelector("#multiDeleteBtn");l&&l.addEventListener("click",()=>{confirm(`Are you sure you want to delete ${u.selectedWidgetIds.length} widgets ? `)&&u.deleteWidget(null)});return}const t=u.getSelectedWidget();if(!t)return;const s=(t.type||"").toLowerCase();let o=s;s==="nav_next_page"?o="next page":s==="nav_previous_page"?o="previous page":s==="nav_reload_page"?o="reload page":o=s.replace(/_/g," ");const r=document.createElement("div");if(r.className="sidebar-section-label",r.style.marginTop="0",r.style.textTransform="capitalize",r.textContent=`${o} Properties`,this.panel.appendChild(r),["shape_rect","rounded_rect","shape_circle","rectangle","rrect","circle"].includes(t.type)){const l=document.createElement("button");l.className="btn btn-secondary",l.style.marginBottom="16px",l.style.width="100%",l.innerHTML='<span class="mdi mdi-box-shadow"></span> Create Drop Shadow',l.onclick=()=>u.createDropShadow(t.id),this.panel.appendChild(l)}if(this.createSection("Transform",!1),this.addCompactPropertyRow(()=>{this.addLabeledInput("Pos X","number",t.x,l=>{u.updateWidget(t.id,{x:parseInt(l,10)||0})}),this.addLabeledInput("Pos Y","number",t.y,l=>{u.updateWidget(t.id,{y:parseInt(l,10)||0})})}),this.addCompactPropertyRow(()=>{this.addLabeledInput("Width","number",t.width,l=>{u.updateWidget(t.id,{width:parseInt(l,10)||10})}),this.addLabeledInput("Height","number",t.height,l=>{u.updateWidget(t.id,{height:parseInt(l,10)||10})})}),this.endSection(),V){const l=V.get(s);l&&l.schema}const c=u.settings.renderingMode||"direct";c==="oepl"||c==="opendisplay"?this.renderProtocolProperties(t,s):this.renderLegacyProperties(t,s),this.createSection("Grid Layout",!1),this.renderGridCellProperties(t,s),this.endSection(),this.createSection("Visibility Conditions",!1),this.addVisibilityConditions(t),this.endSection()}createSection(e,n=!0){const i=this.sectionStates[e]!==void 0?this.sectionStates[e]===!1:!n,t=document.createElement("div");t.className="properties-section"+(i?" collapsed":"");const s=document.createElement("div");s.className="properties-section-header",s.innerHTML=`<span > ${e}</span> <span class="icon mdi mdi-chevron-down"></span>`,s.onclick=r=>{r.stopPropagation();const d=t.classList.toggle("collapsed");this.sectionStates[e]=!d};const o=document.createElement("div");o.className="properties-section-content",t.appendChild(s),t.appendChild(o),this.sectionStates[e]===void 0&&(this.sectionStates[e]=!i),this.getContainer().appendChild(t),this.containerStack.push(o)}endSection(){this.containerStack.length>0&&this.containerStack.pop()}getContainer(){return this.containerStack.length>0?this.containerStack[this.containerStack.length-1]:this.panel}renderGridCellProperties(e,n){const i=u.getCurrentPage(),s=(i?.layout||"absolute")!=="absolute";if(!i)return;if(!s){const h=this.getContainer(),g=document.createElement("div");g.style.padding="8px 0",g.style.fontSize="11px",g.style.color="var(--muted)",g.textContent="Page is currently in Absolute Positioning mode.",h.appendChild(g);const m=document.createElement("button");m.className="btn btn-secondary btn-xs",m.style.width="100%",m.innerHTML='<span class="mdi mdi-grid"></span> Enable Page Grid Layout',m.onclick=()=>{window.app&&window.app.pageSettings&&window.app.pageSettings.open(u.currentPageIndex)},h.appendChild(m);return}const o=We.isLvglWidget(n),r=e.props||{},d=(h,g)=>{const m={...e.props,[h]:g};u.updateWidget(e.id,{props:m})},c=(h,g,m,f)=>{const y=i.layout.match(/^(\d+)x(\d+)$/);if(!y)return null;const b=parseInt(y[1],10),w=parseInt(y[2],10),v=u.getCanvasDimensions(),I=v.width/w,k=v.height/b;return{x:Math.round(g*I),y:Math.round(h*k),width:Math.round(I*f),height:Math.round(k*m)}};if(this.addLabeledInput("Row (0-indexed)","number",r.grid_cell_row_pos??"",h=>{const g=h===""?null:parseInt(h,10);d("grid_cell_row_pos",isNaN(g)?null:g);const f=u.getWidgetById(e.id)?.props||{};if(g!=null&&f.grid_cell_column_pos!=null){const y=c(g,f.grid_cell_column_pos,f.grid_cell_row_span||1,f.grid_cell_column_span||1);y&&u.updateWidget(e.id,{x:y.x,y:y.y,width:y.width,height:y.height})}}),this.addLabeledInput("Column (0-indexed)","number",r.grid_cell_column_pos??"",h=>{const g=h===""?null:parseInt(h,10);d("grid_cell_column_pos",isNaN(g)?null:g);const f=u.getWidgetById(e.id)?.props||{};if(g!=null&&f.grid_cell_row_pos!=null){const y=c(f.grid_cell_row_pos,g,f.grid_cell_row_span||1,f.grid_cell_column_span||1);y&&u.updateWidget(e.id,{x:y.x,y:y.y,width:y.width,height:y.height})}}),this.addLabeledInput("Row Span","number",r.grid_cell_row_span||1,h=>{const g=Math.max(1,parseInt(h,10)||1);d("grid_cell_row_span",g);const f=u.getWidgetById(e.id)?.props||{};if(f.grid_cell_row_pos!=null&&f.grid_cell_column_pos!=null){const y=c(f.grid_cell_row_pos,f.grid_cell_column_pos,g,f.grid_cell_column_span||1);y&&u.updateWidget(e.id,{x:y.x,y:y.y,width:y.width,height:y.height})}}),this.addLabeledInput("Column Span","number",r.grid_cell_column_span||1,h=>{const g=Math.max(1,parseInt(h,10)||1);d("grid_cell_column_span",g);const f=u.getWidgetById(e.id)?.props||{};if(f.grid_cell_row_pos!=null&&f.grid_cell_column_pos!=null){const y=c(f.grid_cell_row_pos,f.grid_cell_column_pos,f.grid_cell_row_span||1,g);y&&u.updateWidget(e.id,{x:y.x,y:y.y,width:y.width,height:y.height})}}),o){const h=["START","END","CENTER","STRETCH"];this.addSelect("X Align",r.grid_cell_x_align||"STRETCH",h,g=>{d("grid_cell_x_align",g)}),this.addSelect("Y Align",r.grid_cell_y_align||"STRETCH",h,g=>{d("grid_cell_y_align",g)})}const l=document.createElement("button");l.className="btn btn-secondary btn-xs",l.style.marginTop="8px",l.style.width="100%",l.innerHTML='<span class="mdi mdi-cog"></span> Open Page Grid Settings',l.onclick=()=>{const h=u.currentPageIndex;window.app&&window.app.pageSettings&&window.app.pageSettings.open(h)},this.getContainer().appendChild(l)}renderProtocolProperties(e,n){const i=qe(),t=e.props||{},s=(o,r)=>{const d={...e.props,[o]:r};u.updateWidget(e.id,{props:d})};if(n==="text"||n==="label"){this.createSection("Content",!0),this.addLabeledInput("Text","textarea",t.text||"",r=>s("text",r)),this.addHint("Use Enter for line breaks. Line breaks will be preserved in YAML output."),this.endSection(),this.createSection("Appearance",!0),this.addLabeledInput("Font Size","number",t.font_size||20,r=>s("font_size",parseInt(r,10))),this.addColorSelector("Color",t.color||"black",i,r=>s("color",r));const o=["TOP_LEFT","TOP_CENTER","TOP_RIGHT","CENTER_LEFT","CENTER","CENTER_RIGHT","BOTTOM_LEFT","BOTTOM_CENTER","BOTTOM_RIGHT"];this.addSelect("Align",t.text_align||"TOP_LEFT",o,r=>s("text_align",r)),this.endSection()}else if(n==="icon")this.createSection("Icon",!0),this.addLabeledInputWithIconPicker("Icon Code","text",t.code||"F0595",o=>s("code",o),e),this.addLabeledInput("Size","number",t.size||48,o=>s("size",parseInt(o,10))),this.addColorSelector("Color",t.color||"black",i,o=>s("color",o)),this.endSection();else if(n==="sensor_text"){this.createSection("Data Source",!0),this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",r=>{u.updateWidget(e.id,{entity_id:r})},e),this.addLabeledInput("Title/Label","text",e.title||"",r=>{u.updateWidget(e.id,{title:r})}),this.endSection(),this.createSection("Format",!1),this.addSelect("Display Format",t.value_format||"label_value",[{value:"label_value",label:"Label: Value & Unit"},{value:"label_value_no_unit",label:"Label: Value Only"},{value:"label_newline_value",label:"Label [newline] Value & Unit"},{value:"label_newline_value_no_unit",label:"Label [newline] Value Only"},{value:"value_only",label:"Value & Unit"},{value:"value_only_no_unit",label:"Value Only"}],r=>s("value_format",r)),this.addLabeledInput("Precision","number",t.precision!==void 0?t.precision:2,r=>s("precision",parseInt(r,10))),this.addLabeledInput("Unit","text",t.unit||"",r=>s("unit",r)),this.addCompactPropertyRow(()=>{this.addLabeledInput("Prefix","text",t.prefix||"",r=>s("prefix",r)),this.addLabeledInput("Postfix","text",t.postfix||"",r=>s("postfix",r))}),this.endSection(),this.createSection("Appearance",!0),this.addLabeledInput("Label Size","number",t.label_font_size||14,r=>s("label_font_size",parseInt(r,10))),this.addLabeledInput("Value Size","number",t.value_font_size||20,r=>s("value_font_size",parseInt(r,10))),this.addColorSelector("Color",t.color||"black",i,r=>s("color",r));const o=["TOP_LEFT","TOP_CENTER","TOP_RIGHT","CENTER_LEFT","CENTER","CENTER_RIGHT","BOTTOM_LEFT","BOTTOM_CENTER","BOTTOM_RIGHT"];this.addSelect("Align",t.text_align||"TOP_LEFT",o,r=>s("text_align",r)),this.endSection()}else n==="qr_code"?(this.createSection("QR Content",!0),this.addLabeledInput("Value / URL","text",t.value||"",o=>s("value",o)),this.addSelect("Error Correction",t.ecc||"LOW",["LOW","MEDIUM","QUARTILE","HIGH"],o=>s("ecc",o)),this.endSection(),this.createSection("Appearance",!0),this.addColorSelector("Color",t.color||"black",i,o=>s("color",o)),this.addColorSelector("Background",t.bg_color||"white",i,o=>s("bg_color",o)),this.endSection()):n==="datetime"?(this.createSection("Format",!0),this.addSelect("Display Format",t.format||"time_date",["time_date","time_only","date_only","weekday_day_month"],o=>s("format",o)),this.endSection(),this.createSection("Appearance",!0),this.addCompactPropertyRow(()=>{this.addLabeledInput("Time Font","number",t.time_font_size||28,o=>s("time_font_size",parseInt(o,10))),this.addLabeledInput("Date Font","number",t.date_font_size||16,o=>s("date_font_size",parseInt(o,10)))}),this.addColorSelector("Color",t.color||"black",i,o=>s("color",o)),this.addSelect("Align",t.text_align||"CENTER",["LEFT","CENTER","RIGHT"],o=>s("text_align",o)),this.endSection()):n==="image"||n==="online_image"?(this.createSection("Image Source",!0),n==="image"?this.addLabeledInput("Asset Path","text",t.path||"",o=>s("path",o)):(this.addLabeledInput("Image URL","text",t.url||"",o=>s("url",o)),this.addLabeledInput("Refresh (s)","number",t.interval_s||300,o=>s("interval_s",parseInt(o,10)))),this.addCheckbox("Invert Colors",!!t.invert,o=>s("invert",o)),this.endSection()):n==="weather_icon"?(this.createSection("Weather",!0),this.addLabeledInputWithPicker("Weather Entity","text",e.entity_id||t.weather_entity||"weather.forecast_home",o=>{u.updateWidget(e.id,{entity_id:o})},e),this.endSection(),this.createSection("Appearance",!0),this.addLabeledInput("Icon Size","number",t.size||48,o=>s("size",parseInt(o,10))),this.addColorSelector("Color",t.color||"black",i,o=>s("color",o)),this.endSection()):n==="weather_forecast"?(this.createSection("Forecasting",!0),this.addLabeledInputWithPicker("Weather Entity","text",e.entity_id||t.weather_entity||"weather.forecast_home",o=>{u.updateWidget(e.id,{entity_id:o})},e),this.addLabeledInput("Days","number",t.days||5,o=>s("days",parseInt(o,10))),this.addSelect("Layout",t.layout||"horizontal",["horizontal","vertical"],o=>s("layout",o)),this.addLabeledInput("Precision","number",t.precision!==void 0?t.precision:1,o=>s("precision",parseInt(o,10))),this.endSection(),this.createSection("Appearance",!0),this.addColorSelector("Text Color",t.color||"black",i,o=>s("color",o)),this.addColorSelector("Background",t.background_color||"white",i,o=>s("background_color",o)),this.addCheckbox("Show High/Low",t.show_high_low!==!1,o=>s("show_high_low",o)),this.endSection()):n.startsWith("shape_")||n==="line"||n==="rounded_rect"?(this.createSection("Shape Style",!0),this.addColorSelector("Fill/Line Color",t.color||"black",i,o=>s("color",o)),n!=="line"?(this.addColorSelector("Background",t.bg_color||"transparent",i,o=>s("bg_color",o)),this.addLabeledInput("Border Width","number",t.border_width||0,o=>s("border_width",parseInt(o,10)))):this.addLabeledInput("Thickness","number",t.thickness||2,o=>s("thickness",parseInt(o,10))),(n==="rounded_rect"||t.radius!==void 0)&&this.addLabeledInput("Corner Radius","number",t.radius||4,o=>s("radius",parseInt(o,10))),this.endSection()):((e.entity_id!==void 0||t.weather_entity!==void 0||n.includes("sensor")||n.includes("icon"))&&(this.createSection("Data Source",!0),this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||t.weather_entity||"",r=>{t.weather_entity!==void 0?s("weather_entity",r):u.updateWidget(e.id,{entity_id:r})},e),e.title!==void 0&&this.addLabeledInput("Title/Label","text",e.title||"",r=>{u.updateWidget(e.id,{title:r})}),this.endSection()),this.createSection("Appearance",!0),this.addColorSelector("Color",t.color||"black",i,r=>s("color",r)),t.bg_color!==void 0&&this.addColorSelector("Background",t.bg_color||"transparent",i,r=>s("bg_color",r)),t.size!==void 0&&this.addLabeledInput("Size","number",t.size||24,r=>s("size",parseInt(r,10))),this.endSection())}renderLegacyProperties(e,n){const i=qe(),t=e.props||{},s=(o,r)=>{const d={...e.props,[o]:r};u.updateWidget(e.id,{props:d})};if(n==="shape_rect"||n==="shape_circle")this.createSection("Appearance",!0),this.addNumberWithSlider("Opacity (%)",t.opacity!==void 0?t.opacity:100,0,100,o=>{s("opacity",o)}),this.addCheckbox("Fill",t.fill||!1,o=>s("fill",o)),this.addLabeledInput("Border Width","number",t.border_width||1,o=>s("border_width",parseInt(o,10))),this.addColorSelector("Color",t.color||"black",i,o=>s("color",o)),this.addColorSelector("Border Color",t.border_color||"black",i,o=>s("border_color",o)),this.endSection();else if(n==="rounded_rect")this.createSection("Appearance",!0),this.addNumberWithSlider("Opacity (%)",t.opacity!==void 0?t.opacity:100,0,100,o=>{s("opacity",o)}),this.addCheckbox("Fill",t.fill||!1,o=>s("fill",o)),t.fill&&this.addCheckbox("Show Border",t.show_border||!1,o=>s("show_border",o)),this.addCompactPropertyRow(()=>{this.addLabeledInput("Border Width","number",t.border_width||4,o=>s("border_width",parseInt(o,10))),this.addLabeledInput("Corner Radius","number",t.radius||10,o=>s("radius",parseInt(o,10)))}),this.addColorSelector("Color",t.color||"black",i,o=>s("color",o)),this.addColorSelector("Border Color",t.border_color||"black",i,o=>s("border_color",o)),this.endSection();else if(n==="line"){this.createSection("Appearance",!0),this.addLabeledInput("Opacity (%)","number",t.opacity!==void 0?t.opacity:100,d=>{s("opacity",parseInt(d,10))}),this.addSegmentedControl("Orientation",[{value:"horizontal",label:"Horiz",icon:"mdi-arrow-left-right"},{value:"vertical",label:"Vert",icon:"mdi-arrow-up-down"}],t.orientation||"horizontal",d=>{const c=parseInt(t.stroke_width||3,10),l=e.width,h=e.height;d==="vertical"?u.updateWidget(e.id,{width:c,height:Math.max(l,h,20)}):u.updateWidget(e.id,{width:Math.max(l,h,20),height:c}),s("orientation",d)});const o=(t.orientation||"horizontal")==="vertical";this.addLabeledInput("Line Length (px)","number",o?e.height:e.width,d=>{const c=parseInt(d,10)||20;o?u.updateWidget(e.id,{height:c}):u.updateWidget(e.id,{width:c})}),this.addLabeledInput("Stroke Width (px)","number",t.stroke_width||3,d=>{const c=parseInt(d,10)||1;s("stroke_width",c),(t.orientation||"horizontal")==="vertical"?u.updateWidget(e.id,{width:c}):u.updateWidget(e.id,{height:c})});const r=document.createElement("button");r.textContent="Fill Canvas Length",r.className="btn btn-secondary",r.style.marginTop="8px",r.style.width="100%",r.onclick=()=>{const d=u.getCanvasDimensions();(t.orientation||"horizontal")==="vertical"?u.updateWidget(e.id,{y:0,height:d.height}):u.updateWidget(e.id,{x:0,width:d.width})},this.getContainer().appendChild(r),this.addColorSelector("Color",t.color||"black",i,d=>s("color",d)),this.endSection()}else if(n==="text"||n==="label"){this.createSection("Content",!0),this.addLabeledInput("Text","text",t.text||"",l=>s("text",l)),this.endSection(),this.createSection("Appearance",!0),this.addNumberWithSlider("Opacity (%)",t.opacity!==void 0?t.opacity:100,0,100,l=>{s("opacity",l)}),this.addLabeledInput("Font Size","number",t.font_size||20,l=>s("font_size",parseInt(l,10))),this.addColorSelector("Color",t.color||"black",i,l=>s("color",l));const o=["Roboto","Inter","Open Sans","Lato","Montserrat","Poppins","Raleway","Roboto Mono","Ubuntu","Nunito","Playfair Display","Merriweather","Work Sans","Source Sans Pro","Quicksand","Custom..."],r=t.font_family||"Roboto",d=!o.slice(0,-1).includes(r);this.addSelect("Font",d?"Custom...":r,o,l=>{l!=="Custom..."?(s("font_family",l),s("custom_font_family","")):s("font_family","Custom...")}),(d||t.font_family==="Custom...")&&(this.addLabeledInput("Custom Font Name","text",t.custom_font_family||(d?r:""),l=>{s("font_family",l||"Roboto"),s("custom_font_family",l)}),this.addHint('Browse <a href="https://fonts.google.com" target="_blank">fonts.google.com</a>')),this.addSelect("Weight",t.font_weight||400,[100,200,300,400,500,600,700,800,900],l=>s("font_weight",parseInt(l,10))),this.addCheckbox("Italic",t.italic||!1,l=>s("italic",l));const c=["TOP_LEFT","TOP_CENTER","TOP_RIGHT","CENTER_LEFT","CENTER","CENTER_RIGHT","BOTTOM_LEFT","BOTTOM_CENTER","BOTTOM_RIGHT"];this.addSelect("Align",t.text_align||"TOP_LEFT",c,l=>s("text_align",l)),this.addSelect("BPP (Anti-aliasing)",String(t.bpp||1),["1","2","4","8"],l=>s("bpp",parseInt(l,10))),this.addHint("1=no AA, 2=4 levels, 4=16 levels, 8=256 levels"),this.endSection()}else if(n==="sensor_text"){this.createSection("Data Source",!0),this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",l=>{u.updateWidget(e.id,{entity_id:l}),l&&!e.title&&window.AppState&&window.AppState.entityStates&&this.autoPopulateTitleFromEntity(e.id,l)},e),this.addCheckbox("Text Sensor (string value)",t.is_text_sensor||!1,l=>s("is_text_sensor",l)),this.addHint("Enable if entity returns text instead of numbers."),this.addCheckbox("Local / On-Device Sensor",!!t.is_local_sensor,l=>s("is_local_sensor",l)),this.addHint("Use internal battery_level/signal sensor."),this.addLabeledInputWithPicker("Secondary Entity ID","text",e.entity_id_2||"",l=>{u.updateWidget(e.id,{entity_id_2:l})},e),this.addLabeledInput("Title/Label","text",e.title||"",l=>{u.updateWidget(e.id,{title:l})}),this.endSection(),this.createSection("Format",!1),this.addSelect("Display Format",t.value_format||"label_value",[{value:"label_value",label:"Label: Value & Unit"},{value:"label_value_no_unit",label:"Label: Value Only"},{value:"label_newline_value",label:"Label [newline] Value & Unit"},{value:"label_newline_value_no_unit",label:"Label [newline] Value Only"},{value:"value_only",label:"Value & Unit"},{value:"value_only_no_unit",label:"Value Only"}],l=>s("value_format",l)),this.addLabeledInput("Precision","number",t.precision!==void 0?t.precision:2,l=>s("precision",parseInt(l,10))),this.addLabeledInputWithDataList("Prefix","text",t.prefix||"",["","$","","","CHF","kr"],l=>s("prefix",l)),this.addLabeledInputWithDataList("Postfix","text",t.postfix||"",[" kWh"," W"," V"," A"," C"," %"," ppm"," lx"],l=>s("postfix",l)),this.addLabeledInput("Unit (Manual helper)","text",t.unit||"",l=>s("unit",l)),this.addCheckbox("Hide default unit",t.hide_unit||!1,l=>s("hide_unit",l)),this.endSection(),this.createSection("Appearance",!0),this.addNumberWithSlider("Opacity (%)",t.opacity!==void 0?t.opacity:100,0,100,l=>{s("opacity",l)}),this.addCompactPropertyRow(()=>{this.addLabeledInput("Label Size","number",t.label_font_size||14,l=>s("label_font_size",parseInt(l,10))),this.addLabeledInput("Value Size","number",t.value_font_size||20,l=>s("value_font_size",parseInt(l,10)))}),this.addColorSelector("Color",t.color||"black",i,l=>s("color",l));const o=["Roboto","Inter","Open Sans","Lato","Montserrat","Poppins","Raleway","Roboto Mono","Ubuntu","Nunito","Playfair Display","Merriweather","Work Sans","Source Sans Pro","Quicksand","Custom..."],r=t.font_family||"Roboto",d=!o.slice(0,-1).includes(r);this.addSelect("Font",d?"Custom...":r,o,l=>{l!=="Custom..."?(s("font_family",l),s("custom_font_family","")):s("font_family","Custom...")}),(d||t.font_family==="Custom...")&&(this.addLabeledInput("Custom Font Name","text",t.custom_font_family||(d?r:""),l=>{s("font_family",l||"Roboto"),s("custom_font_family",l)}),this.addHint('Browse <a href="https://fonts.google.com" target="_blank">fonts.google.com</a>')),this.addSelect("Weight",t.font_weight||400,[100,200,300,400,500,600,700,800,900],l=>s("font_weight",parseInt(l,10))),this.addCheckbox("Italic",t.italic||!1,l=>s("italic",l));const c=["TOP_LEFT","TOP_CENTER","TOP_RIGHT","CENTER_LEFT","CENTER","CENTER_RIGHT","BOTTOM_LEFT","BOTTOM_CENTER","BOTTOM_RIGHT"];this.addSelect("Align",t.text_align||"TOP_LEFT",c,l=>{s("text_align",l),s("label_align",l),s("value_align",l)}),this.endSection()}else if(n==="datetime"){this.createSection("Appearance",!0),this.addLabeledInput("Opacity (%)","number",t.opacity!==void 0?t.opacity:100,l=>{s("opacity",parseInt(l,10))}),this.addSelect("Display Format",t.format||"time_date",["time_date","time_only","date_only","weekday_day_month"],l=>s("format",l)),this.addLabeledInput("Time Font Size","number",t.time_font_size||28,l=>s("time_font_size",parseInt(l,10))),this.addLabeledInput("Date Font Size","number",t.date_font_size||16,l=>s("date_font_size",parseInt(l,10))),this.addColorSelector("Color",t.color||"black",i,l=>s("color",l));const o=["Roboto","Inter","Open Sans","Lato","Montserrat","Poppins","Raleway","Roboto Mono","Ubuntu","Nunito","Playfair Display","Merriweather","Work Sans","Source Sans Pro","Quicksand","Custom..."],r=t.font_family||"Roboto",d=!o.slice(0,-1).includes(r);this.addSelect("Font",d?"Custom...":r,o,l=>{l!=="Custom..."?(s("font_family",l),s("custom_font_family","")):s("font_family","Custom...")}),(d||t.font_family==="Custom...")&&(this.addLabeledInput("Custom Font Name","text",t.custom_font_family||(d?r:""),l=>{s("font_family",l||"Roboto"),s("custom_font_family",l)}),this.addHint('Browse <a href="https://fonts.google.com" target="_blank">fonts.google.com</a>')),this.addCheckbox("Italic",t.italic||!1,l=>s("italic",l));const c=["TOP_LEFT","TOP_CENTER","TOP_RIGHT","CENTER_LEFT","CENTER","CENTER_RIGHT","BOTTOM_LEFT","BOTTOM_CENTER","BOTTOM_RIGHT"];this.addSelect("Align",t.text_align||"CENTER",c,l=>s("text_align",l)),this.endSection()}else if(n==="progress_bar")this.createSection("Data Source",!0),this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",o=>{u.updateWidget(e.id,{entity_id:o}),o&&!e.title&&window.AppState&&window.AppState.entityStates&&this.autoPopulateTitleFromEntity(e.id,o)},e),this.addCheckbox("Local / On-Device Sensor",!!t.is_local_sensor,o=>s("is_local_sensor",o)),this.addHint("Use internal battery_level/signal sensor."),this.addLabeledInput("Title/Label","text",e.title||"",o=>{u.updateWidget(e.id,{title:o})}),this.endSection(),this.createSection("Appearance",!0),this.addNumberWithSlider("Opacity (%)",t.opacity!==void 0?t.opacity:100,0,100,o=>{s("opacity",o)}),this.addCheckbox("Show Label",t.show_label!==!1,o=>s("show_label",o)),this.addCheckbox("Show Percentage",t.show_percentage!==!1,o=>s("show_percentage",o)),this.addCompactPropertyRow(()=>{this.addLabeledInput("Bar H","number",t.bar_height||15,o=>{const r=parseInt(o,10);s("bar_height",isNaN(r)?15:r)}),this.addLabeledInput("Border W","number",t.border_width||1,o=>{const r=parseInt(o,10);s("border_width",isNaN(r)?1:r)})}),this.addColorSelector("Color",t.color||"black",i,o=>s("color",o)),this.endSection();else if(n==="graph")this.createSection("Data Source",!0),this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",o=>{u.updateWidget(e.id,{entity_id:o})},e),this.addLabeledInput("Title","text",e.title||"",o=>{u.updateWidget(e.id,{title:o})}),this.addLabeledInput("Duration","text",t.duration||"1h",o=>s("duration",o)),this.endSection(),this.createSection("Historical Data",!1),this.addCheckbox("Use HA History (Attribute)",!!t.use_ha_history,o=>s("use_ha_history",o)),t.use_ha_history&&(this.addLabeledInput("HA Attribute","text",t.history_attribute||"history",o=>s("history_attribute",o)),this.addLabeledInput("Points to keep","number",t.history_points||100,o=>s("history_points",parseInt(o,10))),this.addCheckbox("Smooth Data (Moving Avg)",!!t.history_smoothing,o=>s("history_smoothing",o)),this.addHint("HA entity must have an attribute that is a JSON array of numbers.")),this.endSection(),this.createSection("Appearance",!0),this.addCheckbox("Auto-scale Y Axis",t.auto_scale!==!1,o=>s("auto_scale",o)),t.auto_scale===!1&&this.addCompactPropertyRow(()=>{this.addLabeledInput("Min Value","number",t.min_value||"0",o=>s("min_value",o)),this.addLabeledInput("Max Value","number",t.max_value||"100",o=>s("max_value",o))}),this.addColorSelector("Line Color",t.color||"black",i,o=>s("color",o)),this.addSelect("Line Type",t.line_type||"SOLID",["SOLID","DASHED","DOTTED"],o=>s("line_type",o)),this.addLabeledInput("Line Thickness","number",t.line_thickness||3,o=>s("line_thickness",parseInt(o,10))),this.addCheckbox("Show Border",t.border!==!1,o=>s("border",o)),this.addCheckbox("Show Grid",t.grid!==!1,o=>s("grid",o)),this.addLabeledInput("X Grid Interval","text",t.x_grid||"1h",o=>s("x_grid",o)),this.addLabeledInput("Y Grid Step","text",t.y_grid||"auto",o=>s("y_grid",o)),this.endSection();else if(n==="icon")this.createSection("Appearance",!0),this.addCheckbox("Fit icon to frame",t.fit_icon_to_frame||!1,o=>s("fit_icon_to_frame",o)),this.addIconPicker("Select Icon",t.code||"F07D0",o=>s("code",o),e),this.addLabeledInput("Icon Size (px)","number",t.size||40,o=>{let r=parseInt(o||"40",10);(Number.isNaN(r)||r<8)&&(r=8),r>260&&(r=260),s("size",r)}),this.addSelect("Font Reference",t.font_ref||"font_mdi_medium",["font_mdi_medium","font_mdi_large"],o=>s("font_ref",o)),this.addColorSelector("Color",t.color||"black",i,o=>s("color",o)),this.endSection();else if(n==="battery_icon")this.createSection("Data Source",!0),this.addLabeledInputWithPicker("Battery Entity ID","text",e.entity_id||"",o=>{u.updateWidget(e.id,{entity_id:o})},e),this.addCheckbox("Local / On-Device Sensor",!!t.is_local_sensor,o=>s("is_local_sensor",o)),this.endSection(),this.createSection("Appearance",!0),this.addCheckbox("Fit icon to frame",t.fit_icon_to_frame||!1,o=>s("fit_icon_to_frame",o)),this.addLabeledInput("Icon Size (px)","number",t.size||48,o=>{let r=parseInt(o||"48",10);(Number.isNaN(r)||r<16)&&(r=16),r>200&&(r=200),s("size",r)}),this.addLabeledInput("Percentage Font Size (px)","number",t.font_size||12,o=>{let r=parseInt(o||"12",10);(Number.isNaN(r)||r<8)&&(r=8),r>100&&(r=100),s("font_size",r)}),this.addColorSelector("Color",t.color||"black",i,o=>s("color",o)),this.endSection();else if(n==="wifi_signal")this.createSection("Data Source",!0),this.addLabeledInputWithPicker("WiFi Signal Entity ID","text",e.entity_id||"",o=>{u.updateWidget(e.id,{entity_id:o})},e),this.addCheckbox("Local / On-Device Sensor",t.is_local_sensor!==!1,o=>s("is_local_sensor",o)),this.endSection(),this.createSection("Appearance",!0),this.addCheckbox("Show dBm value",t.show_dbm!==!1,o=>s("show_dbm",o)),this.addCheckbox("Fit icon to frame",t.fit_icon_to_frame||!1,o=>s("fit_icon_to_frame",o)),this.addLabeledInput("Icon Size (px)","number",t.size||24,o=>{let r=parseInt(o||"24",10);(Number.isNaN(r)||r<16)&&(r=16),r>200&&(r=200),s("size",r)}),this.addLabeledInput("dBm Font Size (px)","number",t.font_size||12,o=>{let r=parseInt(o||"12",10);(Number.isNaN(r)||r<8)&&(r=8),r>100&&(r=100),s("font_size",r)}),this.addColorSelector("Color",t.color||"black",i,o=>s("color",o)),this.endSection();else if(n==="ondevice_temperature"){this.createSection("Data Source",!0),this.addLabeledInputWithPicker("Temperature Entity ID","text",e.entity_id||"",d=>{u.updateWidget(e.id,{entity_id:d})},e),this.addCheckbox("Local / On-Device Sensor",t.is_local_sensor!==!1,d=>s("is_local_sensor",d));let o=!1;const r=u.getSelectedProfile();r&&r.features&&(o=!!(r.features.sht4x||r.features.sht3x||r.features.shtc3)),t.is_local_sensor!==!1&&!o&&(this.addHint(' <span style="color:orange">This hardware profile has no onboard temperature sensor.</span><br/>Uncheck this or select an HA entity.'),e.props&&e.props.is_local_sensor===void 0&&setTimeout(()=>s("is_local_sensor",!1),0)),this.endSection(),this.createSection("Appearance",!0),this.addCheckbox("Fit icon to frame",t.fit_icon_to_frame||!1,d=>s("fit_icon_to_frame",d)),this.addCheckbox("Show Label",t.show_label!==!1,d=>s("show_label",d)),this.addLabeledInput("Icon Size (px)","number",t.size||32,d=>{let c=parseInt(d||"32",10);(Number.isNaN(c)||c<16)&&(c=16),c>200&&(c=200),s("size",c)}),this.addLabeledInput("Value Font Size (px)","number",t.font_size||16,d=>{let c=parseInt(d||"16",10);(Number.isNaN(c)||c<8)&&(c=8),c>200&&(c=200),s("font_size",c)}),this.addLabeledInput("Label Font Size (px)","number",t.label_font_size||10,d=>{let c=parseInt(d||"10",10);(Number.isNaN(c)||c<8)&&(c=8),c>100&&(c=100),s("label_font_size",c)}),this.addSelect("Unit",t.unit||"C",["C","F"],d=>s("unit",d)),this.addLabeledInput("Precision","number",t.precision??1,d=>s("precision",parseInt(d,10))),this.addColorSelector("Color",t.color||"black",i,d=>s("color",d)),this.endSection()}else if(n==="ondevice_humidity"){this.createSection("Data Source",!0),this.addLabeledInputWithPicker("Humidity Entity ID","text",e.entity_id||"",d=>{u.updateWidget(e.id,{entity_id:d})},e),this.addCheckbox("Local / On-Device Sensor",t.is_local_sensor!==!1,d=>s("is_local_sensor",d));let o=!1;const r=u.getSelectedProfile();r&&r.features&&(o=!!(r.features.sht4x||r.features.sht3x||r.features.shtc3)),t.is_local_sensor!==!1&&!o&&(this.addHint(' <span style="color:orange">This hardware profile has no onboard humidity sensor.</span><br/>Uncheck this or select an HA entity.'),e.props&&e.props.is_local_sensor===void 0&&setTimeout(()=>s("is_local_sensor",!1),0)),this.endSection(),this.createSection("Appearance",!0),this.addCheckbox("Fit icon to frame",t.fit_icon_to_frame||!1,d=>s("fit_icon_to_frame",d)),this.addCheckbox("Show Label",t.show_label!==!1,d=>s("show_label",d)),this.addLabeledInput("Icon Size (px)","number",t.size||32,d=>{let c=parseInt(d||"32",10);(Number.isNaN(c)||c<16)&&(c=16),c>200&&(c=200),s("size",c)}),this.addLabeledInput("Value Font Size (px)","number",t.font_size||16,d=>{let c=parseInt(d||"16",10);(Number.isNaN(c)||c<8)&&(c=8),c>200&&(c=200),s("font_size",c)}),this.addLabeledInput("Label Font Size (px)","number",t.label_font_size||10,d=>{let c=parseInt(d||"10",10);(Number.isNaN(c)||c<8)&&(c=8),c>100&&(c=100),s("label_font_size",c)}),this.addLabeledInput("Unit","text",t.unit||"%",d=>s("unit",d)),this.addLabeledInput("Precision","number",t.precision??0,d=>s("precision",parseInt(d,10))),this.addColorSelector("Color",t.color||"black",i,d=>s("color",d)),this.endSection()}else if(n==="weather_icon")this.createSection("Data Source",!0),this.addLabeledInputWithPicker("Weather Entity ID","text",e.entity_id||t.weather_entity||"weather.forecast_home",o=>{u.updateWidget(e.id,{entity_id:o})},e),this.endSection(),this.createSection("Appearance",!0),this.addCheckbox("Fit icon to frame",t.fit_icon_to_frame||!1,o=>s("fit_icon_to_frame",o)),this.addLabeledInput("Icon Size (px)","number",t.size||48,o=>{let r=parseInt(o||"48",10);(Number.isNaN(r)||r<8)&&(r=8),r>260&&(r=260),s("size",r)}),this.addColorSelector("Color",t.color||"black",i,o=>s("color",o)),this.endSection();else if(n==="weather_forecast"){this.createSection("Data Source",!0),this.addLabeledInputWithPicker("Weather Entity ID","text",e.entity_id||t.weather_entity||"weather.forecast_home",c=>{u.updateWidget(e.id,{entity_id:c})},e),this.endSection(),this.createSection("Appearance",!0),this.addSelect("Layout",t.layout||"horizontal",["horizontal","vertical"],c=>s("layout",c)),this.addCheckbox("Show High/Low Temp",t.show_high_low!==!1,c=>s("show_high_low",c)),this.addSelect("Temperature Unit",t.temp_unit||"C",["C","F"],c=>s("temp_unit",c)),this.addLabeledInput("Day Font Size","number",t.day_font_size||14,c=>s("day_font_size",parseInt(c,10))),this.addLabeledInput("Temp Font Size","number",t.temp_font_size||14,c=>s("temp_font_size",parseInt(c,10))),this.addLabeledInput("Icon Size","number",t.icon_size||24,c=>s("icon_size",parseInt(c,10))),this.addLabeledInput("Precision","number",t.precision!==void 0?t.precision:1,c=>s("precision",parseInt(c,10)));const o=["Roboto","Inter","Open Sans","Lato","Montserrat","Poppins","Raleway","Roboto Mono","Ubuntu","Nunito","Playfair Display","Merriweather","Work Sans","Source Sans Pro","Quicksand","Custom..."],r=t.font_family||"Roboto",d=!o.slice(0,-1).includes(r);this.addSelect("Font",d?"Custom...":r,o,c=>{c!=="Custom..."?(s("font_family",c),s("custom_font_family","")):s("font_family","Custom...")}),(d||t.font_family==="Custom...")&&(this.addLabeledInput("Custom Font Name","text",t.custom_font_family||(d?r:""),c=>{s("font_family",c||"Roboto"),s("custom_font_family",c)}),this.addHint('Browse <a href="https://fonts.google.com" target="_blank">fonts.google.com</a>')),this.addColorSelector("Color",t.color||"black",i,c=>s("color",c)),this.addCheckbox("Show Border",t.show_border!==!1,c=>s("show_border",c)),t.show_border!==!1&&(this.addLabeledInput("Border Width","number",t.border_width!==void 0?t.border_width:1,c=>s("border_width",parseInt(c,10))),this.addColorSelector("Border Color",t.border_color||"black",i,c=>s("border_color",c))),this.addColorSelector("Background Color",t.background_color||"transparent",i,c=>s("background_color",c)),this.endSection()}else if(n==="template_sensor_bar")this.createSection("Sensor Visibility",!0),this.addCheckbox("Show WiFi",t.show_wifi!==!1,o=>s("show_wifi",o)),this.addCheckbox("Show Temperature",t.show_temperature!==!1,o=>s("show_temperature",o)),this.addCheckbox("Show Humidity",t.show_humidity!==!1,o=>s("show_humidity",o)),this.addCheckbox("Show Battery",t.show_battery!==!1,o=>s("show_battery",o)),this.endSection(),this.createSection("Sensor Data Sources",!1),this.addLabeledInput("WiFi Entity","text",t.wifi_entity||"",o=>s("wifi_entity",o)),this.addLabeledInput("Temp Entity","text",t.temp_entity||"",o=>s("temp_entity",o)),this.addSelect("Temperature Unit",t.temp_unit||"C",["C","F"],o=>s("temp_unit",o)),this.addLabeledInput("Hum Entity","text",t.hum_entity||"",o=>s("hum_entity",o)),this.addLabeledInput("Battery Entity","text",t.bat_entity||"",o=>s("bat_entity",o)),this.endSection(),this.createSection("Appearance",!0),this.addCheckbox("Show Background",t.show_background!==!1,o=>s("show_background",o)),t.show_background!==!1&&(this.addColorSelector("Background Color",t.background_color||"black",i,o=>{s("background_color",o);const r=["black","gray","grey","#000000","#808080"],d=["white","#ffffff","#fff"],c=t.color||"white";r.includes(o.toLowerCase())&&r.includes(c.toLowerCase())?s("color","white"):d.includes(o.toLowerCase())&&d.includes(c.toLowerCase())&&s("color","black")}),this.addLabeledInput("Border Radius","number",t.border_radius||8,o=>s("border_radius",parseInt(o,10))),this.addLabeledInput("Border Thickness","number",t.border_thickness||0,o=>s("border_thickness",parseInt(o,10))),this.addColorSelector("Border Color",t.border_color||"white",i,o=>s("border_color",o))),this.endSection(),this.createSection("Sizes & Color",!1),this.addLabeledInput("Icon Size","number",t.icon_size||20,o=>s("icon_size",parseInt(o,10))),this.addLabeledInput("Font Size","number",t.font_size||14,o=>s("font_size",parseInt(o,10))),this.addColorSelector("Foreground Color",t.color||"white",i,o=>s("color",o)),this.endSection();else if(n==="template_nav_bar")this.createSection("Button Visibility",!0),this.addCheckbox("Show Previous",t.show_prev!==!1,o=>s("show_prev",o)),this.addCheckbox("Show Home",t.show_home!==!1,o=>s("show_home",o)),this.addCheckbox("Show Next",t.show_next!==!1,o=>s("show_next",o)),this.endSection(),this.createSection("Page Targets",!1),t.show_prev!==!1&&this.addPageSelector("Prev Button Target",t.prev_target||"relative_prev",o=>s("prev_target",o)),t.show_home!==!1&&this.addPageSelector("Home Button Target",t.home_target||"home",o=>s("home_target",o)),t.show_next!==!1&&this.addPageSelector("Next Button Target",t.next_target||"relative_next",o=>s("next_target",o)),this.endSection(),this.createSection("Appearance",!0),this.addCheckbox("Show Background",t.show_background!==!1,o=>s("show_background",o)),t.show_background!==!1&&(this.addColorSelector("Background Color",t.background_color||"black",i,o=>{s("background_color",o);const r=["black","gray","grey","#000000","#808080"],d=["white","#ffffff","#fff"],c=t.color||"white";r.includes(o.toLowerCase())&&r.includes(c.toLowerCase())?s("color","white"):d.includes(o.toLowerCase())&&d.includes(c.toLowerCase())&&s("color","black")}),this.addLabeledInput("Border Radius","number",t.border_radius||8,o=>s("border_radius",parseInt(o,10))),this.addLabeledInput("Border Thickness","number",t.border_thickness||0,o=>s("border_thickness",parseInt(o,10))),this.addColorSelector("Border Color",t.border_color||"white",i,o=>s("border_color",o))),this.endSection(),this.createSection("Sizes & Color",!1),this.addLabeledInput("Icon Size","number",t.icon_size||24,o=>s("icon_size",parseInt(o,10))),this.addColorSelector("Foreground Color",t.color||"white",i,o=>s("color",o)),this.endSection();else if(n==="touch_area"||n==="nav_next_page"||n==="nav_previous_page"||n==="nav_reload_page"){this.createSection("Action",!0),this.addSelect("Navigation Action",t.nav_action||"none",[{value:"none",label:"None (Entity Toggle)"},{value:"next_page",label:"Next Page"},{value:"previous_page",label:"Previous Page"},{value:"reload_page",label:"Reload Page"}],c=>{s("nav_action",c),(t.icon==="F0142"||t.icon==="F0141"||t.icon==="F0450"||!t.icon)&&(c==="next_page"?s("icon","F0142"):c==="previous_page"?s("icon","F0141"):c==="reload_page"&&s("icon","F0450"))}),(t.nav_action||"none")==="none"&&this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",c=>{u.updateWidget(e.id,{entity_id:c})},e),this.endSection(),this.createSection("Content",!0),this.addLabeledInput("Title","text",t.title||"",c=>s("title",c)),this.addIconPicker("Normal Icon",t.icon||"",c=>s("icon",c),e),this.addIconPicker("Pressed Icon",t.icon_pressed||"",c=>s("icon_pressed",c),e),this.addLabeledInput("Icon Size","number",t.icon_size||40,c=>s("icon_size",parseInt(c,10))),this.addColorSelector("Icon Color",t.icon_color||"black",i,c=>s("icon_color",c)),this.endSection(),this.createSection("Appearance",!0);const o=t.color||"rgba(0, 0, 255, 0.2)";let r="#0000ff",d=.2;if(o.startsWith("#"))r=o,d=1;else if(o.startsWith("rgba")){const c=o.match(/([\d\.]+)/g);if(c&&c.length>=4){const l=parseInt(c[0]),h=parseInt(c[1]),g=parseInt(c[2]);d=parseFloat(c[3]),r="#"+((1<<24)+(l<<16)+(h<<8)+g).toString(16).slice(1)}}this.addLabeledInput("Preview Color","color",r,c=>{const l=parseInt(c.slice(1,3),16),h=parseInt(c.slice(3,5),16),g=parseInt(c.slice(5,7),16);s("color",`rgba(${l}, ${h}, ${g}, ${d})`),s("border_color",c)}),this.addLabeledInput("Opacity (0.0 - 1.0)","number",d,c=>{let l=parseFloat(c);l<0&&(l=0),l>1&&(l=1);const h=parseInt(r.slice(1,3),16),g=parseInt(r.slice(3,5),16),m=parseInt(r.slice(5,7),16);s("color",`rgba(${h}, ${g}, ${m}, ${l})`)}),this.addColorSelector("Border Color",t.border_color||"#0000ff",i,c=>s("border_color",c)),this.endSection()}else if(n==="image"){this.createSection("Content",!0),this.addHint(" Static image from ESPHome:<br/><code style='background:#f0f0f0;padding:2px 4px;border-radius:2px;'>/config/esphome/images/logo.png</code><br/><span style='color:#4a9eff;'> Place images in /config/esphome/images/ folder</span>"),this.addLabeledInput("Image Path","text",t.path||"",c=>s("path",c)),this.endSection(),this.createSection("Appearance",!0),t.invert===void 0&&s("invert",Ce()==="reterminal_e1001"),this.addCheckbox("Invert colors",t.invert||!1,c=>s("invert",c)),this.addSelect("Render Mode",t.render_mode||"Auto",["Auto","Binary","Grayscale","Color (RGB565)"],c=>s("render_mode",c));const o=document.createElement("div");o.className="field",o.style.marginTop="12px";const r=e.x===0&&e.y===0&&e.width===800&&e.height===480,d=document.createElement("button");d.className="btn "+(r?"btn-primary":"btn-secondary")+" btn-full",d.textContent=r?" Full Screen (click to restore)":" Fill Screen",d.type="button",d.addEventListener("click",()=>{r?u.updateWidget(e.id,{x:50,y:50,width:200,height:150}):u.updateWidget(e.id,{x:0,y:0,width:800,height:480})}),o.appendChild(d),this.getContainer().appendChild(o),this.endSection()}else if(n==="online_image"){this.createSection("Content",!0),this.addHint(" Fetch remote images dynamically (Puppet support):<br/><code style='background:#f0f0f0;padding:2px 4px;border-radius:2px;'>https://example.com/camera/snapshot.jpg </code><br/><span style='color:#4a9eff;'> Images are downloaded at specified intervals</span>"),this.addLabeledInput("Remote URL","text",t.url||"",c=>s("url",c)),this.addLabeledInput("Update interval (seconds)","number",t.interval_s||300,c=>s("interval_s",parseInt(c,10))),this.endSection(),this.createSection("Appearance",!0),t.invert===void 0&&s("invert",Ce()==="reterminal_e1001"),this.addCheckbox("Invert colors",t.invert||!1,c=>s("invert",c)),this.addSelect("Render Mode",t.render_mode||"Auto",["Auto","Binary","Grayscale","Color (RGB565)"],c=>s("render_mode",c));const o=document.createElement("div");o.className="field",o.style.marginTop="12px";const r=e.x===0&&e.y===0&&e.width===800&&e.height===480,d=document.createElement("button");d.className="btn "+(r?"btn-primary":"btn-secondary")+" btn-full",d.textContent=r?" Full Screen (click to restore)":" Fill Screen",d.type="button",d.addEventListener("click",()=>{r?u.updateWidget(e.id,{x:50,y:50,width:200,height:150}):u.updateWidget(e.id,{x:0,y:0,width:800,height:480})}),o.appendChild(d),this.getContainer().appendChild(o),this.endSection()}else if(n==="qr_code")this.createSection("Content",!0),this.addHint(" Generate QR codes that can be scanned by phones/tablets"),this.addLabeledInput("QR Content","text",t.value||"https://esphome.io",o=>s("value",o)),this.addHint("Enter a URL, text, or any string to encode"),this.endSection(),this.createSection("Appearance",!0),this.addLabeledInput("Scale","number",t.scale||2,o=>{let r=parseInt(o||"2",10);(Number.isNaN(r)||r<1)&&(r=1),r>10&&(r=10),s("scale",r)}),this.addHint("Size multiplier (1-10). Larger = bigger QR code"),this.addSelect("Error Correction",t.ecc||"LOW",["LOW","MEDIUM","QUARTILE","HIGH"],o=>s("ecc",o)),this.addHint("Higher = more redundancy, can recover from damage"),this.addSelect("Color",t.color||"black",["black","white"],o=>s("color",o)),this.endSection();else if(n==="quote_rss"){this.createSection("Feed Settings",!0),this.addHint(" Display quotes from an RSS feed (Quote of the Day)"),this.addLabeledInput("Feed URL","text",t.feed_url||"https://www.brainyquote.com/link/quotebr.rss",h=>s("feed_url",h)),this.addHint("Enter any RSS feed URL. Default: BrainyQuote daily quotes"),this.addCheckbox("Show Author",t.show_author!==!1,h=>s("show_author",h)),this.addCheckbox("Random Quote",t.random!==!1,h=>s("random",h)),this.addHint("Pick a random quote from the feed, or use the first one");const o=["15min","30min","1h","2h","4h","8h","12h","24h"];this.addSelect("Refresh Interval",t.refresh_interval||"24h",o,h=>s("refresh_interval",h)),this.addLabeledInput("Home Assistant URL","text",t.ha_url||"http://homeassistant.local:8123",h=>s("ha_url",h)),this.addHint("Address of your Home Assistant instance (for Proxy)"),this.endSection(),this.createSection("Typography",!1),this.addLabeledInput("Quote Text Size (Line 1)","number",t.quote_font_size||18,h=>s("quote_font_size",parseInt(h,10))),this.addLabeledInput("Author Size (Line 2)","number",t.author_font_size||14,h=>s("author_font_size",parseInt(h,10)));const r=["Roboto","Inter","Open Sans","Lato","Montserrat","Poppins","Raleway","Roboto Mono","Ubuntu","Nunito","Playfair Display","Merriweather","Work Sans","Source Sans Pro","Quicksand","Custom..."],d=t.font_family||"Roboto",c=!r.slice(0,-1).includes(d);this.addSelect("Font",c?"Custom...":d,r,h=>{h!=="Custom..."?(s("font_family",h),s("custom_font_family","")):s("font_family","Custom...")}),(c||t.font_family==="Custom...")&&(this.addLabeledInput("Custom Font Name","text",t.custom_font_family||(c?d:""),h=>{s("font_family",h||"Roboto"),s("custom_font_family",h)}),this.addHint('Browse <a href="https://fonts.google.com" target="_blank">fonts.google.com</a>')),this.addSelect("Weight",t.font_weight||400,[100,200,300,400,500,600,700,800,900],h=>s("font_weight",parseInt(h,10)));const l=["TOP_LEFT","TOP_CENTER","TOP_RIGHT","CENTER_LEFT","CENTER","CENTER_RIGHT","BOTTOM_LEFT","BOTTOM_CENTER","BOTTOM_RIGHT"];this.addSelect("Align",t.text_align||"TOP_LEFT",l,h=>s("text_align",h)),this.addColorSelector("Color",t.color||"black",i,h=>s("color",h)),this.endSection(),this.createSection("Display Options",!1),this.addCheckbox("Word Wrap",t.word_wrap!==!1,h=>s("word_wrap",h)),this.addCheckbox("Auto Scale Text",t.auto_scale||!1,h=>s("auto_scale",h)),this.addHint("Automatically reduce font size if text is too long"),this.addCheckbox("Italic Quote",t.italic_quote!==!1,h=>s("italic_quote",h)),this.endSection()}else if(n==="calendar"){this.createSection("Appearance",!0),this.addColorSelector("Text Color",t.text_color||"black",i,d=>s("text_color",d)),this.addColorSelector("Border Color",t.border_color||"black",i,d=>s("border_color",d)),this.addColorSelector("Background",t.background_color||"white",i,d=>s("background_color",d)),this.addLabeledInput("Border Width","number",t.border_width||2,d=>s("border_width",parseInt(d,10))),this.addCheckbox("Show Border",t.show_border!==!1,d=>s("show_border",d)),this.endSection(),this.createSection("Font Sizes",!1),this.addLabeledInput("Big Date Size","number",t.font_size_date||100,d=>s("font_size_date",parseInt(d,10))),this.addLabeledInput("Day Name Size","number",t.font_size_day||24,d=>s("font_size_day",parseInt(d,10))),this.addLabeledInput("Grid Text Size","number",t.font_size_grid||14,d=>s("font_size_grid",parseInt(d,10))),this.addLabeledInput("Event Text Size","number",t.font_size_event||18,d=>s("font_size_event",parseInt(d,10))),this.endSection(),this.createSection("Data Source",!0),this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"sensor.esp_calendar_data",d=>{u.updateWidget(e.id,{entity_id:d})},e),this.addLabeledInput("Max Events","number",t.max_events||8,d=>s("max_events",parseInt(d,10))),this.addHint("Must be a sensor with attribute 'entries'");const o=document.createElement("button");o.className="btn btn-secondary btn-full btn-xs",o.textContent="Download Helper Script",o.style.marginTop="10px",o.addEventListener("click",()=>{const d=document.createElement("a");d.setAttribute("href","data:text/x-python;charset=utf-8,"+encodeURIComponent(xs)),d.setAttribute("download","esp_calendar_data_conversion.py"),d.style.display="none",document.body.appendChild(d),d.click(),document.body.removeChild(d)}),this.getContainer().appendChild(o),this.addHint("Place in /config/python_scripts/");const r=document.createElement("div");r.style.marginTop="5px",r.style.fontSize="10px",r.style.color="#888",r.style.textAlign="center",r.innerText="Check widget instructions for HA setup.",this.getContainer().appendChild(r),this.endSection()}else if(n==="puppet")this.createSection("Content",!0),this.addLabeledInput("File path / URL","text",t.image_url||"",o=>s("image_url",o)),this.addHint('Tip: Use mdi:icon-name for Material Design Icons. <br><b>Important:</b> Ensure `materialdesignicons - webfont.ttf` is in your ESPHome `fonts / ` folder. <a href="https://pictogrammers.com/library/mdi/" target="_blank" style="color: #52c7ea">MDI Library</a>'),this.endSection(),this.createSection("Appearance",!0),this.addSelect("Image type",t.image_type||"RGB565",["RGB565","RGB","GRAYSCALE","BINARY"],o=>s("image_type",o)),this.addHint("RGB565=2B/px, RGB=3B/px, GRAYSCALE=1B/px, BINARY=1bit/px"),this.addSelect("Transparency",t.transparency||"opaque",["opaque","chroma_key","alpha_channel"],o=>s("transparency",o)),this.addHint("opaque=no transparency, chroma_key=color key, alpha_channel=smooth blend"),this.endSection();else if(n==="lvgl_label"||n.startsWith("lvgl_")){if(this.addCommonLVGLProperties(e,t),this.createSection("Widget Settings",!0),n==="lvgl_label"){this.addLabeledInput("Text","text",t.text||"Label",l=>s("text",l)),this.addLabeledInput("Font Size","number",t.font_size||20,l=>s("font_size",parseInt(l,10))),this.addColorMixer("Text Color",t.color||"black",l=>s("color",l)),this.addColorMixer("Background Color",t.bg_color||"transparent",l=>s("bg_color",l));const o=["Roboto","Inter","Open Sans","Lato","Montserrat","Poppins","Raleway","Roboto Mono","Ubuntu","Nunito","Playfair Display","Merriweather","Work Sans","Source Sans Pro","Quicksand","Custom..."],r=t.font_family||"Roboto",d=!o.slice(0,-1).includes(r);this.addSelect("Font",d?"Custom...":r,o,l=>{l!=="Custom..."?s("font_family",l):s("font_family","Custom...")}),this.addSelect("Weight",t.font_weight||400,[100,200,300,400,500,600,700,800,900],l=>s("font_weight",parseInt(l,10))),this.addCheckbox("Italic",t.italic||!1,l=>s("italic",l));const c=["TOP_LEFT","TOP_CENTER","TOP_RIGHT","CENTER_LEFT","CENTER","CENTER_RIGHT","BOTTOM_LEFT","BOTTOM_CENTER","BOTTOM_RIGHT"];this.addSelect("Align",t.text_align||"CENTER",c,l=>s("text_align",l))}else if(n==="lvgl_line"){const o=t.orientation||"horizontal";this.addSelect("Orientation",o,["horizontal","vertical"],m=>{const f=e.width,y=e.height;u.updateWidget(e.id,{props:{...t,orientation:m},width:y,height:f})}),this.addLabeledInput("Line Width","number",t.line_width||3,m=>s("line_width",parseInt(m,10))),this.addColorMixer("Line Color",t.line_color||t.color||"black",m=>s("line_color",m)),this.addCheckbox("Rounded Ends",t.line_rounded!==!1,m=>s("line_rounded",m)),this.addLabeledInput("Opacity (0-255)","number",t.opa||255,m=>s("opa",parseInt(m,10))),this.createSection("Quick Size",!1);const r=document.createElement("div");r.style.display="flex",r.style.gap="8px",r.style.marginBottom="8px";const d=u.getCanvasDimensions(),c=d.width,l=d.height,h=document.createElement("button");h.className="btn btn-secondary",h.style.flex="1",h.textContent=" Fill Horizontal",h.addEventListener("click",()=>{const m=t.line_width||3;u.updateWidget(e.id,{x:0,y:e.y,width:c,height:m,props:{...t,orientation:"horizontal"}})});const g=document.createElement("button");g.className="btn btn-secondary",g.style.flex="1",g.textContent=" Fill Vertical",g.addEventListener("click",()=>{const m=t.line_width||3;u.updateWidget(e.id,{x:e.x,y:0,width:m,height:l,props:{...t,orientation:"vertical"}})}),r.appendChild(g),this.getContainer().appendChild(r),this.endSection()}else n==="lvgl_meter"?(this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",o=>{u.updateWidget(e.id,{entity_id:o})},e),this.createSection("Scale",!1),this.addLabeledInput("Min Value","number",t.min||0,o=>s("min",parseInt(o,10))),this.addLabeledInput("Max Value","number",t.max||100,o=>s("max",parseInt(o,10))),this.endSection(),this.createSection("Preview",!1),this.addLabeledInput("Value (Preview)","number",t.value!==void 0?t.value:60,o=>s("value",parseInt(o,10))),this.endSection(),this.createSection("Appearance",!1),this.addColorMixer("Scale Color",t.color||"black",o=>s("color",o)),this.addColorMixer("Needle Color",t.indicator_color||"red",o=>s("indicator_color",o)),this.addLabeledInput("Scale Width","number",t.scale_width||10,o=>s("scale_width",parseInt(o,10))),this.addLabeledInput("Needle Width","number",t.indicator_width||4,o=>s("indicator_width",parseInt(o,10))),this.addLabeledInput("Ticks","number",t.tick_count||11,o=>s("tick_count",parseInt(o,10))),this.addLabeledInput("Tick Length","number",t.tick_length||10,o=>s("tick_length",parseInt(o,10))),this.addLabeledInput("Label Gap","number",t.label_gap||10,o=>s("label_gap",parseInt(o,10))),this.endSection()):n==="lvgl_button"?(this.addLabeledInputWithPicker("Action Entity ID","text",e.entity_id||"",o=>{u.updateWidget(e.id,{entity_id:o})},e),this.addHint("Entity to toggle/trigger when clicked"),this.addLabeledInput("Text","text",t.text||"BTN",o=>s("text",o)),this.addColorMixer("Background Color",t.bg_color||"white",o=>s("bg_color",o)),this.addColorMixer("Text Color",t.color||"black",o=>s("color",o)),this.addLabeledInput("Border Width","number",t.border_width||2,o=>s("border_width",parseInt(o,10))),this.addLabeledInput("Corner Radius","number",t.radius||5,o=>s("radius",parseInt(o,10))),this.addCheckbox("Checkable (Toggle)",t.checkable||!1,o=>s("checkable",o))):n==="lvgl_arc"?(this.addLabeledInputWithPicker("Sensor Entity ID","text",e.entity_id||"",o=>{u.updateWidget(e.id,{entity_id:o})},e),this.addHint("Sensor to bind to arc value"),this.addLabeledInput("Title / Label","text",t.title||"",o=>{const r={...e.props,title:o};u.updateWidget(e.id,{props:r})}),this.addLabeledInput("Min Value","number",t.min||0,o=>s("min",parseInt(o,10))),this.addLabeledInput("Max Value","number",t.max||100,o=>s("max",parseInt(o,10))),this.addLabeledInput("Default/Preview Value","number",t.value||0,o=>s("value",parseInt(o,10))),this.addLabeledInput("Thickness","number",t.thickness||10,o=>s("thickness",parseInt(o,10))),this.addLabeledInput("Start Angle","number",t.start_angle||135,o=>s("start_angle",parseInt(o,10))),this.addLabeledInput("End Angle","number",t.end_angle||45,o=>s("end_angle",parseInt(o,10))),this.addSelect("Mode",t.mode||"NORMAL",["NORMAL","SYMMETRICAL","REVERSE"],o=>s("mode",o)),this.addColorMixer("Color",t.color||"blue",o=>s("color",o))):n==="lvgl_chart"?(this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",o=>{u.updateWidget(e.id,{entity_id:o})},e),this.addLabeledInput("Title","text",t.title||"",o=>s("title",o)),this.addSelect("Type",t.type||"LINE",["LINE","SCATTER","BAR"],o=>s("type",o)),this.addLabeledInput("Min Value","number",t.min||0,o=>s("min",parseInt(o,10))),this.addLabeledInput("Max Value","number",t.max||100,o=>s("max",parseInt(o,10))),this.addLabeledInput("Point Count","number",t.point_count||10,o=>s("point_count",parseInt(o,10))),this.addLabeledInput("X Div Lines","number",t.x_div_lines||3,o=>s("x_div_lines",parseInt(o,10))),this.addLabeledInput("Y Div Lines","number",t.y_div_lines||3,o=>s("y_div_lines",parseInt(o,10))),this.addColorMixer("Color",t.color||"black",o=>s("color",o))):n==="lvgl_img"?(this.addLabeledInput("Source (Image/Symbol)","text",t.src||"",o=>s("src",o)),this.addHint("e.g. symbol_ok, symbol_home, or /image.png"),this.addLabeledInput("Rotation (0.1 deg)","number",t.rotation||0,o=>s("rotation",parseInt(o,10))),this.addLabeledInput("Scale (256 = 1x)","number",t.scale||256,o=>s("scale",parseInt(o,10))),this.addColorMixer("Color (Tint)",t.color||"black",o=>s("color",o))):n==="lvgl_qrcode"?(this.createSection("Content",!0),this.addLabeledInput("Content / URL","text",t.text||"",o=>s("text",o)),this.addLabeledInput("Size (px)","number",t.size||100,o=>s("size",parseInt(o,10))),this.addColorMixer("Color",t.color||"black",o=>s("color",o)),this.addColorMixer("Background Color",t.bg_color||"white",o=>s("bg_color",o)),this.endSection()):n==="lvgl_bar"?(this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",o=>{u.updateWidget(e.id,{entity_id:o})},e),this.addLabeledInput("Min Value","number",t.min||0,o=>s("min",parseInt(o,10))),this.addLabeledInput("Max Value","number",t.max||100,o=>s("max",parseInt(o,10))),this.addLabeledInput("Preview Value","number",t.value||50,o=>s("value",parseInt(o,10))),this.addColorMixer("Bar Color",t.color||"black",o=>s("color",o)),this.addColorMixer("Background Color",t.bg_color||"gray",o=>s("bg_color",o)),this.addLabeledInput("Start Value","number",t.start_value||0,o=>s("start_value",parseInt(o,10))),this.addSelect("Mode",t.mode||"NORMAL",["NORMAL","SYMMETRICAL","REVERSE"],o=>s("mode",o)),this.addCheckbox("Range Mode",t.range_mode||!1,o=>s("range_mode",o))):n==="lvgl_slider"?(this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",o=>{u.updateWidget(e.id,{entity_id:o})},e),this.addHint("Controls this entity number/level"),this.addSegmentedControl("Orientation",[{value:"Horizontal",label:"Horiz",icon:"mdi-arrow-left-right"},{value:"Vertical",label:"Vert",icon:"mdi-arrow-up-down"}],t.vertical?"Vertical":"Horizontal",o=>{const r=o==="Vertical",d=e.width,c=e.height;u.updateWidget(e.id,{props:{...t,vertical:r},width:c,height:d})}),this.addCompactPropertyRow(()=>{this.addLabeledInput("Min","number",t.min||0,o=>s("min",parseInt(o,10))),this.addLabeledInput("Max","number",t.max||100,o=>s("max",parseInt(o,10)))}),this.addNumberWithSlider("Value",t.value||30,t.min||0,t.max||100,o=>s("value",o)),this.addColorMixer("Knob/Bar Color",t.color||"black",o=>s("color",o)),this.addColorMixer("Track Color",t.bg_color||"gray",o=>s("bg_color",o)),this.addLabeledInput("Border Width","number",t.border_width||2,o=>s("border_width",parseInt(o,10))),this.addSelect("Mode",t.mode||"NORMAL",["NORMAL","SYMMETRICAL","REVERSE"],o=>s("mode",o))):n==="lvgl_tabview"?(this.addLabeledInput("Tabs (comma separated)","text",(t.tabs||[]).join(", "),o=>{const r=o.split(",").map(d=>d.trim()).filter(d=>d);s("tabs",r)}),this.addColorMixer("Background Color",t.bg_color||"white",o=>s("bg_color",o))):n==="lvgl_tileview"?(this.addHint("Tiles are currently configured via YAML or advanced properties."),this.addColorMixer("Background Color",t.bg_color||"white",o=>s("bg_color",o))):n==="lvgl_led"?(this.addColorMixer("Color",t.color||"red",o=>s("color",o)),this.addLabeledInput("Brightness (0-255)","number",t.brightness||255,o=>s("brightness",parseInt(o,10)))):n==="lvgl_spinner"?(this.addLabeledInput("Spin Time (ms)","number",t.spin_time||1e3,o=>s("spin_time",parseInt(o,10))),this.addLabeledInput("Arc Length (deg)","number",t.arc_length||60,o=>s("arc_length",parseInt(o,10))),this.addColorMixer("Arc Color",t.arc_color||"blue",o=>s("arc_color",o)),this.addColorMixer("Track Color",t.track_color||"white",o=>s("track_color",o))):n==="lvgl_buttonmatrix"?(this.addHint("Edit rows via YAML or simple comma-separated lists per row."),t.rows):n==="lvgl_checkbox"?(this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",o=>{u.updateWidget(e.id,{entity_id:o})},e),this.addHint("Toggle input_boolean when tapped"),this.addLabeledInput("Label","text",t.text||"Checkbox",o=>s("text",o)),this.addCheckbox("Checked",t.checked||!1,o=>s("checked",o)),this.addColorMixer("Color",t.color||"blue",o=>s("color",o))):n==="lvgl_dropdown"?(this.addLabeledInput("Options (one per line)","textarea",t.options||"",o=>s("options",o)),this.addCompactPropertyRow(()=>{this.addLabeledInput("Index","number",t.selected_index||0,o=>s("selected_index",parseInt(o,10))),this.addLabeledInput("Max H","number",t.max_height||200,o=>s("max_height",parseInt(o,10)))}),this.addSegmentedControl("Direction",[{value:"DOWN",icon:"mdi-arrow-down"},{value:"UP",icon:"mdi-arrow-up"},{value:"LEFT",icon:"mdi-arrow-left"},{value:"RIGHT",icon:"mdi-arrow-right"}],t.direction||"DOWN",o=>s("direction",o)),this.addColorMixer("Color",t.color||"white",o=>s("color",o))):n==="lvgl_keyboard"?(this.addSelect("Mode",t.mode||"TEXT_UPPER",["TEXT_LOWER","TEXT_UPPER","SPECIAL","NUMBER"],o=>s("mode",o)),this.addLabeledInput("Textarea ID Link","text",t.textarea_id||"",o=>s("textarea_id",o))):n==="lvgl_roller"?(this.addLabeledInput("Options (one per line)","textarea",t.options||"",o=>s("options",o)),this.addLabeledInput("Visible Rows","number",t.visible_row_count||3,o=>s("visible_row_count",parseInt(o,10))),this.addColorMixer("Color",t.color||"white",o=>s("color",o)),this.addColorMixer("Background Color",t.bg_color||"black",o=>s("bg_color",o)),this.addColorMixer("Selected BG Color",t.selected_bg_color||"blue",o=>s("selected_bg_color",o)),this.addColorMixer("Selected Text Color",t.selected_text_color||"white",o=>s("selected_text_color",o)),this.addSelect("Mode",t.mode||"NORMAL",["NORMAL","INFINITE"],o=>s("mode",o))):n==="lvgl_spinbox"?(this.addLabeledInput("Min","number",t.min||0,o=>s("min",parseInt(o,10))),this.addLabeledInput("Max","number",t.max||100,o=>s("max",parseInt(o,10))),this.addLabeledInput("Value","number",t.value||0,o=>s("value",parseInt(o,10))),this.addLabeledInput("Digits","number",t.digit_count||4,o=>s("digit_count",parseInt(o,10))),this.addLabeledInput("Step","number",t.step||1,o=>s("step",parseInt(o,10)))):n==="lvgl_switch"?(this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",o=>{u.updateWidget(e.id,{entity_id:o})},e),this.addHint("Toggle switch/light/input_boolean when tapped"),this.addCheckbox("Checked",t.checked||!1,o=>s("checked",o)),this.addColorMixer("Indicator Color",t.color||"blue",o=>s("color",o)),this.addColorMixer("Background Color",t.bg_color||"gray",o=>s("bg_color",o)),this.addColorMixer("Knob Color",t.knob_color||"white",o=>s("knob_color",o))):n==="lvgl_textarea"?(this.addLabeledInput("Placeholder","text",t.placeholder||"",o=>s("placeholder",o)),this.addLabeledInput("Text","text",t.text||"",o=>s("text",o)),this.addCheckbox("One Line",t.one_line||!1,o=>s("one_line",o)),this.addCheckbox("Password Mode",t.password_mode||!1,o=>s("password_mode",o)),this.addLabeledInput("Accepted Chars","text",t.accepted_chars||"",o=>s("accepted_chars",o)),this.addLabeledInput("Max Length","number",t.max_length||0,o=>s("max_length",parseInt(o,10)))):n==="lvgl_obj"&&(this.addColorMixer("Color",t.color||"white",o=>s("color",o)),this.addLabeledInput("Border Width","number",t.border_width||1,o=>s("border_width",parseInt(o,10))),this.addColorMixer("Border Color",t.border_color||"gray",o=>s("border_color",o)),this.addLabeledInput("Radius","number",t.radius||0,o=>s("radius",parseInt(o,10))));this.endSection()}}addCommonLVGLProperties(e,n){const i=(o,r)=>{const d={...e.props,[o]:r};u.updateWidget(e.id,{props:d})};this.createSection("Common LVGL",!1);const t=document.createElement("div");t.style.display="grid",t.style.gridTemplateColumns="1fr 1fr",t.style.gap="4px",this.getContainer().appendChild(t);const s=(o,r,d=!1)=>{const c=document.createElement("div"),l=document.createElement("input");l.type="checkbox",l.checked=n[r]!==void 0?n[r]:d,l.addEventListener("change",()=>i(r,l.checked));const h=document.createElement("span");h.textContent=" "+o,h.style.fontSize="10px",c.appendChild(l),c.appendChild(h),t.appendChild(c)};s("Hidden","hidden",!1),s("Clickable","clickable",!0),s("Checkable","checkable",!1),s("Scrollable","scrollable",!0),s("Floating","floating",!1),s("Ignore Layout","ignore_layout",!1),this.addSelect("Scrollbar Mode",n.scrollbar_mode||"AUTO",["AUTO","ON","OFF","ACTIVE"],o=>i("scrollbar_mode",o)),this.endSection()}addNumberWithSlider(e,n,i,t,s){const o=document.createElement("div");o.className="field";const r=document.createElement("div");r.className="prop-label",r.textContent=e;const d=document.createElement("div");d.className="slider-hybrid";const c=document.createElement("input");c.type="range",c.min=i,c.max=t,c.value=n;const l=document.createElement("input");l.className="prop-input",l.type="number",l.value=n,l.min=i,l.max=t,c.addEventListener("input",()=>{l.value=c.value,s(parseInt(c.value,10))}),l.addEventListener("input",()=>{c.value=l.value,s(parseInt(l.value,10))}),d.appendChild(c),d.appendChild(l),o.appendChild(r),o.appendChild(d),this.getContainer().appendChild(o)}addSegmentedControl(e,n,i,t){const s=document.createElement("div");s.className="field";const o=document.createElement("div");o.className="prop-label",o.textContent=e;const r=document.createElement("div");r.className="segmented-control",n.forEach(d=>{const c=document.createElement("div");c.className="segment-item"+(d.value===i?" active":""),c.title=d.label||d.value,d.icon?c.innerHTML=`< i class="mdi ${d.icon}" ></i > `:c.textContent=d.label||d.value,c.onclick=()=>{r.querySelectorAll(".segment-item").forEach(l=>l.classList.remove("active")),c.classList.add("active"),t(d.value)},r.appendChild(c)}),s.appendChild(o),s.appendChild(r),this.getContainer().appendChild(s)}addCompactPropertyRow(e){const n=document.createElement("div");n.className="prop-grid-2",this.getContainer().appendChild(n),this.containerStack.push(n),e(),this.containerStack.pop()}addLabeledInput(e,n,i,t){const s=document.createElement("div");s.className="field";const o=document.createElement("div");o.className="prop-label",o.textContent=e;let r;n==="textarea"?(r=document.createElement("textarea"),r.className="prop-input",r.style.minHeight="60px",r.style.resize="vertical",r.style.fontFamily="inherit",r.value=i||""):(r=document.createElement("input"),r.className="prop-input",r.type=n,r.value=i),r.addEventListener("input",()=>{t(r.value)}),r.addEventListener("change",()=>{t(r.value)}),s.appendChild(o),s.appendChild(r),this.getContainer().appendChild(s)}addSelect(e,n,i,t){const s=document.createElement("div");s.className="field";const o=document.createElement("div");o.className="prop-label",o.textContent=e;const r=document.createElement("select");r.className="prop-input",i.forEach(d=>{const c=document.createElement("option");typeof d=="object"&&d!==null?(c.value=d.value,c.textContent=d.label,d.value===n&&(c.selected=!0)):(c.value=d,c.textContent=d,d===n&&(c.selected=!0)),r.appendChild(c)}),r.addEventListener("change",()=>t(r.value)),s.appendChild(o),s.appendChild(r),this.getContainer().appendChild(s)}addPageSelector(e,n,i){const t=u.project?.pages||[],s=[{value:"relative_prev",label:" Previous (Automatic)"},{value:"relative_next",label:"Next (Automatic) "},{value:"home",label:" Home / Dashboard"}];t.forEach((o,r)=>{s.push({value:r.toString(),label:`Page ${r+1}: ${o.name||"Untitled"}`})}),this.addSelect(e,n,s,i)}addCheckbox(e,n,i){const t=document.createElement("div");t.className="field",t.style.marginBottom="8px";const s=document.createElement("label");s.style.display="flex",s.style.alignItems="center",s.style.gap="8px",s.style.fontSize="13px",s.style.cursor="pointer";const o=document.createElement("input");o.type="checkbox",o.checked=!!n,o.style.width="16px",o.style.height="16px",o.style.margin="0",o.style.cursor="pointer",o.addEventListener("change",()=>i(o.checked));const r=document.createElement("span");r.textContent=e,s.appendChild(o),s.appendChild(r),t.appendChild(s),this.getContainer().appendChild(t)}addHint(e){const n=document.createElement("div");n.style.fontSize="11px",n.style.color="#666",n.style.marginTop="4px",n.style.marginBottom="12px",n.style.lineHeight="1.4",n.innerHTML=e,this.getContainer().appendChild(n)}addLabeledInputWithDataList(e,n,i,t,s){const o=document.createElement("div");o.className="field";const r=document.createElement("div");r.className="prop-label",r.textContent=e;const d="datalist_"+Math.random().toString(36).substr(2,9),c=document.createElement("datalist");c.id=d,t.forEach(h=>{const g=document.createElement("option");g.value=h,c.appendChild(g)});const l=document.createElement("input");l.className="prop-input",l.type=n,l.value=i,l.setAttribute("list",d),l.addEventListener("input",()=>s(l.value)),l.addEventListener("change",()=>s(l.value)),o.appendChild(r),o.appendChild(l),o.appendChild(c),this.getContainer().appendChild(o)}addSectionLabel(e){const n=document.createElement("div");n.className="sidebar-section-label",n.textContent=e,this.getContainer().appendChild(n)}autoPopulateTitleFromEntity(e,n){!n||!window.AppState||typeof ge=="function"&&ge().then(i=>{if(!i||i.length===0)return;const t=i.find(s=>s.entity_id===n);if(t&&t.name){const s=u.getSelectedWidget();s&&s.id===e&&!s.title&&u.updateWidget(e,{title:t.name})}}).catch(()=>{})}addVisibilityConditions(e){e.condition_entity=e.condition_entity||"",e.condition_operator=e.condition_operator||"==",e.condition_state=e.condition_state||"",e.condition_min=e.condition_min||"",e.condition_max=e.condition_max||"";const n=document.createElement("div");n.className="field",n.style.fontSize="9px",n.style.color="#9499a6",n.style.marginBottom="6px",n.innerHTML="Show/hide this widget based on an entity's state.",this.getContainer().appendChild(n),this.addLabeledInputWithPicker("Condition Entity","text",e.condition_entity,r=>{u.updateWidget(e.id,{condition_entity:r})},e);const i=["==","!=","<",">","<=",">="];this.addSelect("Operator",e.condition_operator,i,r=>{u.updateWidget(e.id,{condition_operator:r})});const t=["on","off","open","closed","true","false","home","not_home","locked","unlocked","active","inactive","detected","clear","occupied"];this.addLabeledInputWithDataList("Condition State","text",e.condition_state,t,r=>{u.updateWidget(e.id,{condition_state:r})}),this.addLabeledInput("Min Value (Range)","text",e.condition_min,r=>{u.updateWidget(e.id,{condition_min:r})}),this.addLabeledInput("Max Value (Range)","text",e.condition_max,r=>{u.updateWidget(e.id,{condition_max:r})});const s=document.createElement("div");s.className="field",s.style.marginTop="8px";const o=document.createElement("button");o.className="btn btn-secondary btn-full",o.textContent="Clear Condition",o.type="button",o.addEventListener("click",()=>{u.updateWidget(e.id,{condition_entity:"",condition_operator:"==",condition_state:"",condition_min:"",condition_max:""})}),s.appendChild(o),this.getContainer().appendChild(s)}addLabeledInputWithPicker(e,n,i,t,s){const o=document.createElement("div");o.className="field";const r=document.createElement("div");r.className="prop-label",r.textContent=e;const d=document.createElement("div");d.style.display="flex",d.style.gap="4px";const c=document.createElement("input");c.className="prop-input",c.type=n,c.value=i,c.style.flex="1",c.placeholder="Start typing or click  to pick...",c.autocomplete="off",c.setAttribute("list",Ye),li(),c.addEventListener("input",()=>t(c.value));const l=document.createElement("button");l.className="btn btn-secondary",l.innerHTML="",l.style.padding="4px 8px",l.style.fontSize="10px",l.style.minWidth="32px",l.type="button",l.title="Browse all entities",l.addEventListener("click",()=>{_s(s,c,h=>{c.value=h,t(h)})}),d.appendChild(c),d.appendChild(l),o.appendChild(r),o.appendChild(d),this.getContainer().appendChild(o)}addIconPicker(e,n,i,t){const s=window.iconPickerData||[],o=document.createElement("div");o.className="field";const r=document.createElement("div");r.className="prop-label",r.textContent=e,o.appendChild(r);const d=document.createElement("select");d.className="select",d.style.fontFamily="MDI, monospace, system-ui",d.style.fontSize="16px",d.style.lineHeight="1.5",d.style.width="100%",d.style.marginBottom="4px";const c=document.createElement("option");c.value="",c.textContent="-- Quick visual picker --",c.style.fontFamily="system-ui, -apple-system, BlinkMacSystemFont, sans-serif",d.appendChild(c);const l=(n||"").replace("mdi:","").toUpperCase();s.forEach(y=>{const b=document.createElement("option");b.value=y.code;const w=983040+parseInt(y.code.slice(1),16),v=String.fromCodePoint(w);b.textContent=v+"  "+y.code+(y.name?` (${y.name})`:""),b.style.fontFamily="MDI, monospace, system-ui",y.code===l&&(b.selected=!0),d.appendChild(b)}),d.addEventListener("change",()=>{d.value&&(g.value=d.value,i(d.value))}),o.appendChild(d);const h=document.createElement("div");h.style.display="flex",h.style.gap="4px";const g=document.createElement("input");g.className="prop-input",g.type="text",g.placeholder="MDI Hex (Fxxxx)",g.value=l,g.style.flex="1",g.style.fontFamily="monospace",g.addEventListener("input",()=>{const y=(g.value||"").trim().toUpperCase().replace(/^0X/,"").replace(/^MDI:/,"");/^F[0-9A-F]{4}$/i.test(y)?(i(y),Array.from(d.options).find(w=>w.value===y)?d.value=y:d.value=""):y===""&&(i(""),d.value="")}),h.appendChild(g);const m=document.createElement("button");m.className="btn btn-secondary",m.textContent="",m.style.padding="4px 8px",m.style.fontSize="14px",m.type="button",m.title="Open full icon browser",m.addEventListener("click",()=>{Bt(t,g)}),h.appendChild(m),o.appendChild(h);const f=document.createElement("div");f.className="prop-hint",f.innerHTML='Browse <a href="https://pictogrammers.com/library/mdi/icon/" target="_blank" style="color: #03a9f4; text-decoration: none;">Pictogrammers MDI</a>',o.appendChild(f),this.getContainer().appendChild(o)}addIconInput(e,n,i,t){const s=document.createElement("div");s.className="field";const o=document.createElement("div");o.className="prop-label",o.textContent=e;const r=document.createElement("div");r.style.display="flex",r.style.gap="4px";const d=document.createElement("input");d.className="prop-input",d.type="text",d.value=n,d.style.flex="1",d.addEventListener("input",()=>i(d.value));const c=document.createElement("button");c.className="btn btn-secondary",c.textContent="",c.style.padding="4px 8px",c.style.fontSize="14px",c.type="button",c.addEventListener("click",()=>{Bt(t,d)}),r.appendChild(d),r.appendChild(c),s.appendChild(o),s.appendChild(r),this.getContainer().appendChild(s)}addColorSelector(e,n,i,t){typeof isRGBDevice=="function"&&isRGBDevice()?this.addColorMixer(e,n,t):this.addSelect(e,n,i,t)}addColorMixer(e,n,i){const t=document.createElement("div");t.className="field",t.style.marginBottom="10px";const s=document.createElement("div");s.className="prop-label",s.textContent=e,t.appendChild(s);let o=0,r=0,d=0,c="#000000";const l=S=>{const L={black:"#000000",white:"#FFFFFF",red:"#FF0000",green:"#00FF00",blue:"#0000FF",yellow:"#FFFF00",gray:"#808080",grey:"#808080"};return S?L[S.toLowerCase()]?L[S.toLowerCase()]:S.startsWith("0x")?"#"+S.substring(2):S.startsWith("#")?S:"#000000":"#000000"},h=S=>{const L=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(S);return L?{r:parseInt(L[1],16),g:parseInt(L[2],16),b:parseInt(L[3],16)}:{r:0,g:0,b:0}},g=(S,L,G)=>{const W=R=>{const A=Math.max(0,Math.min(255,R)).toString(16);return A.length===1?"0"+A:A};return"#"+W(S)+W(L)+W(G)};c=l(n);const m=h(c);o=m.r,r=m.g,d=m.b;const f=document.createElement("div");f.style.background="var(--bg)",f.style.padding="8px",f.style.borderRadius="6px",f.style.border="1px solid var(--border-subtle)";const y=document.createElement("div");y.style.display="flex",y.style.alignItems="center",y.style.marginBottom="8px",y.style.gap="8px";const b=document.createElement("div");b.style.width="24px",b.style.height="24px",b.style.borderRadius="3px",b.style.backgroundColor=c,b.style.border="1px solid var(--border-subtle)";const w=document.createElement("input");w.type="text",w.value=c.toUpperCase(),w.className="prop-input",w.style.flex="1",w.style.fontFamily="monospace",y.appendChild(b),y.appendChild(w),f.appendChild(y);const v=(S,L,G)=>{const W=document.createElement("div");W.style.display="flex",W.style.alignItems="center",W.style.marginBottom="4px",W.style.fontSize="11px";const R=document.createElement("span");R.textContent=S,R.style.width="15px",R.style.fontWeight="bold",R.style.color="var(--text)";const A=document.createElement("input");A.type="range",A.min="0",A.max="255",A.value=L,A.style.flex="1",A.style.marginLeft="4px",A.style.accentColor=G;const U=document.createElement("span");return U.textContent=L,U.style.width="25px",U.style.textAlign="right",U.style.marginLeft="4px",U.style.color="var(--muted)",W.appendChild(R),W.appendChild(A),W.appendChild(U),{row:W,slider:A,valLbl:U}},I=v("R",o,"red"),k=v("G",r,"green"),M=v("B",d,"blue");f.appendChild(I.row),f.appendChild(k.row),f.appendChild(M.row),t.appendChild(f),this.getContainer().appendChild(t);const E=()=>{o=parseInt(I.slider.value),r=parseInt(k.slider.value),d=parseInt(M.slider.value),I.valLbl.textContent=o,k.valLbl.textContent=r,M.valLbl.textContent=d;const S=g(o,r,d).toUpperCase();w.value=S,b.style.backgroundColor=S,i(S)},x=()=>{let S=w.value.trim();if(S.startsWith("#")||(S="#"+S),/^#[0-9A-F]{6}$/i.test(S)){const L=h(S);o=L.r,r=L.g,d=L.b,I.slider.value=o,I.valLbl.textContent=o,k.slider.value=r,k.valLbl.textContent=r,M.slider.value=d,M.valLbl.textContent=d,b.style.backgroundColor=S,i(S)}};I.slider.addEventListener("input",E),k.slider.addEventListener("input",E),M.slider.addEventListener("input",E),w.addEventListener("input",x),w.addEventListener("change",x)}}class _i{constructor(){this.init()}init(){window.addEventListener("keydown",e=>this.handleKeyDown(e))}handleKeyDown(e){const n=u||window.AppState;if(!n){_.error("KeyboardHandler: AppState not found!");return}const i=n.selectedWidgetIds.length>0;n.selectedWidgetId;const t=window.isAutoHighlight||!1;if(e.shiftKey&&e.code==="Space"){(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")&&e.target.blur(),e.preventDefault(),window.QuickSearch&&window.QuickSearch.open();return}if((e.key==="Delete"||e.key==="Backspace")&&i){const s=window.lastHighlightRange;if(e.target.id==="snippetBox"&&s&&e.target.selectionStart===s.start&&e.target.selectionEnd===s.end){e.preventDefault(),this.deleteWidget(null);return}if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")return;e.preventDefault(),this.deleteWidget(null);return}if((e.ctrlKey||e.metaKey)&&e.key&&e.key.toLowerCase()==="c"){if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"){if(e.target.id==="snippetBox"&&t){e.preventDefault(),this.copyWidget();return}return}e.preventDefault(),this.copyWidget();return}if((e.ctrlKey||e.metaKey)&&e.key&&e.key.toLowerCase()==="v"){if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"){if(e.target.id==="snippetBox"&&t){e.preventDefault(),this.pasteWidget();return}return}e.preventDefault(),this.pasteWidget();return}if((e.ctrlKey||e.metaKey)&&e.key&&e.key.toLowerCase()==="z"&&!e.shiftKey){if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"){if(e.target.id==="snippetBox"&&t){e.preventDefault(),window._undoRedoInProgress=!0,n.undo(),setTimeout(()=>{window._undoRedoInProgress=!1},100);return}return}e.preventDefault(),window._undoRedoInProgress=!0,n.undo(),setTimeout(()=>{window._undoRedoInProgress=!1},100);return}if((e.ctrlKey||e.metaKey)&&e.key&&(e.key.toLowerCase()==="y"||e.key.toLowerCase()==="z"&&e.shiftKey)){if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"){if(e.target.id==="snippetBox"&&t){e.preventDefault(),window._undoRedoInProgress=!0,n.redo(),setTimeout(()=>{window._undoRedoInProgress=!1},100);return}return}e.preventDefault(),window._undoRedoInProgress=!0,n.redo(),setTimeout(()=>{window._undoRedoInProgress=!1},100);return}if((e.ctrlKey||e.metaKey)&&e.key&&e.key.toLowerCase()==="l"&&i){e.preventDefault();const o=n.getSelectedWidgets().every(r=>r.locked);n.updateWidgets(n.selectedWidgetIds,{locked:!o})}if((e.ctrlKey||e.metaKey)&&e.key&&e.key.toLowerCase()==="a"){const s=e.target.id==="snippetBox"&&t;if(e.target.tagName!=="INPUT"&&e.target.tagName!=="TEXTAREA"||s){e.preventDefault(),n.selectAllWidgets();return}}if(e.key&&e.key.toLowerCase()==="g"&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey&&!e.altKey&&e.target.tagName!=="INPUT"&&e.target.tagName!=="TEXTAREA"){e.preventDefault();const s=!n.showGrid;if(n.setShowGrid(s),s){n.setShowDebugGrid(!1);const r=document.getElementById("debugGridToggleBtn");r&&r.classList.remove("active")}const o=document.getElementById("gridToggleBtn");o&&o.classList.toggle("active",s),O(P.STATE_CHANGED),_.log(`[Keyboard] Grid toggled: ${s}`);return}if(e.key&&e.key.toLowerCase()==="d"&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey&&!e.altKey&&e.target.tagName!=="INPUT"&&e.target.tagName!=="TEXTAREA"){e.preventDefault();const s=!n.showDebugGrid;if(n.setShowDebugGrid(s),s){n.setShowGrid(!1);const r=document.getElementById("gridToggleBtn");r&&r.classList.remove("active")}const o=document.getElementById("debugGridToggleBtn");o&&o.classList.toggle("active",s),O(P.STATE_CHANGED),_.log(`[Keyboard] Debug mode toggled: ${s}`);return}if(e.key&&e.key.toLowerCase()==="r"&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey&&!e.altKey&&e.target.tagName!=="INPUT"&&e.target.tagName!=="TEXTAREA"){e.preventDefault();const s=!n.showRulers;n.setShowRulers(s);const o=document.getElementById("rulersToggleBtn");o&&o.classList.toggle("active",s),_.log(`[Keyboard] Rulers toggled: ${s}`);return}e.key==="Escape"&&(document.activeElement&&(document.activeElement.tagName==="INPUT"||document.activeElement.tagName==="TEXTAREA")&&document.activeElement.blur(),n.selectedWidgetIds.length>0&&(n.selectWidgets([]),O(P.STATE_CHANGED)))}static isInput(e){return e.tagName==="INPUT"||e.tagName==="TEXTAREA"}deleteWidget(e){const n=u||window.AppState;n&&n.deleteWidget(e)}copyWidget(){const e=u||window.AppState;e&&e.copyWidget()}pasteWidget(){const e=u||window.AppState;e&&e.pasteWidget()}}window.KeyboardHandler=_i;window.LAYOUT={WIDGET:{SMALL:{W:100,H:20},MEDIUM:{W:200,H:60},LARGE:{W:200,H:100}},FONT:{SIZE:{XS:12,S:14,M:16,L:20,XL:28,XXL:40},DEFAULT:{LABEL:14,VALUE:20,TITLE:28,DATE:16}},GRID:{GAP:10,MARGIN:10}};Object.freeze(window.LAYOUT);function Ss(){const a=u.getPagesPayload(),e=JSON.stringify(a,null,2),n=new Blob([e],{type:"application/json"}),i=URL.createObjectURL(n),t=document.createElement("a");t.href=i,t.download=`reterminal_layout_${Date.now()}.json`,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(i)}function Is(a){if(!a)return;const e=new FileReader;e.onload=n=>{try{const i=n.target.result,t=JSON.parse(i);le(t)}catch(i){_.error("Failed to parse layout file:",i),alert("Error parsing layout file. Please ensure it is a valid JSON file.")}},e.readAsText(a)}function Cs(a){const e=a.target.files[0];Is(e),a.target.value=""}class xe{constructor(){if(this.constructor===xe)throw new Error("BaseAdapter is abstract and cannot be instantiated directly.")}async generate(e){throw new Error("Method 'generate()' must be implemented.")}generatePage(e,n){throw new Error("Method 'generatePage()' must be implemented.")}generateWidget(e,n){throw new Error("Method 'generateWidget()' must be implemented.")}sanitize(e){return e}}window.BaseAdapter=xe;function Ls(a,e="my_display",n=0){if(!a||!a.touch)return[];const i=a.touch,t=["touchscreen:"];t.push(`  - platform: ${i.platform}`),t.push("    id: my_touchscreen"),t.push(`    display: ${e}`),i.i2c_id&&t.push(`    i2c_id: ${i.i2c_id}`),i.spi_id&&t.push(`    spi_id: ${i.spi_id}`),i.address&&t.push(`    address: ${i.address}`),i.update_interval&&t.push(`    update_interval: ${i.update_interval}`);const s=(d,c)=>{c&&(typeof c=="string"||typeof c=="number"?t.push(`    ${d}: ${c}`):(t.push(`    ${d}:`),Object.entries(c).forEach(([l,h])=>t.push(`      ${l}: ${h}`))))};s("interrupt_pin",i.interrupt_pin),s("reset_pin",i.reset_pin),s("cs_pin",i.cs_pin);const o=[],r=i.transform||{};if((i.mirror_x||r.mirror_x)&&o.push("mirror_x: true"),(i.mirror_y||r.mirror_y)&&o.push("mirror_y: true"),(i.swap_xy||r.swap_xy)&&o.push("swap_xy: true"),o.length>0&&(t.push("    transform:"),o.forEach(d=>t.push(`      ${d}`))),i.calibration){t.push("    calibration:");const d=i.calibration;Object.entries(d).forEach(([c,l])=>t.push(`      ${c}: ${l}`))}return t.push(""),t}function Ot(a){const e=[];if(!a||!a.backlight)return e;const n=a.backlight;return(n.platform==="ledc"||n.platform==="gpio"||n.platform==="switch")&&(n.platform==="switch"?(e.push("switch:"),e.push("  - platform: gpio"),e.push("    id: lcdbacklight"),e.push("    name: lcdbacklight"),typeof n.pin=="object"?(e.push("    pin:"),Object.entries(n.pin).forEach(([i,t])=>{typeof t=="object"?(e.push(`      ${i}:`),Object.entries(t).forEach(([s,o])=>e.push(`        ${s}: ${o}`))):e.push(`      ${i}: ${t}`)})):e.push(`    pin: ${n.pin}`),e.push("    restore_mode: ALWAYS_ON"),e.push("")):(e.push("output:"),e.push(`  - platform: ${n.platform}`),e.push("    id: gpio_backlight_pwm"),e.push(`    pin: ${n.pin}`),n.frequency&&e.push(`    frequency: ${n.frequency}`),e.push(""))),e.push("light:"),e.push("  - platform: monochromatic"),e.push("    name: Display Backlight"),e.push("    id: display_backlight"),e.push("    restore_mode: ALWAYS_ON"),n.platform==="switch"?(e.push("    output: fake_backlight_output"),e.push("    default_transition_length: 0s"),e.push(""),e.push("output:"),e.push("  - platform: template"),e.push("    id: fake_backlight_output"),e.push("    type: float"),e.push("    write_action:"),e.push("      - if:"),e.push("          condition:"),e.push("            lambda: 'return state > 0.0;'"),e.push("          then:"),e.push("            - switch.turn_on: lcdbacklight"),e.push("          else:"),e.push("            - switch.turn_off: lcdbacklight")):e.push("    output: gpio_backlight_pwm"),e.push(""),e}function Rt(a){const e=[];return a.external_components&&Array.isArray(a.external_components)&&a.external_components.length>0&&(e.push("external_components:"),e.push(...a.external_components),e.push("")),a.extra_components&&Array.isArray(a.extra_components)&&(e.push(...a.extra_components),e.push("")),a.extra_components_raw&&(e.push(a.extra_components_raw),e.push("")),e}function Wt(a){const e=[];return a&&a.pins&&a.pins.i2c&&(e.push("i2c:"),e.push("  - sda: "+a.pins.i2c.sda),e.push("    scl: "+a.pins.i2c.scl),e.push("    scan: "+(a.i2c_config?.scan!==!1)),e.push("    id: bus_a"),a.i2c_config?.frequency&&e.push("    frequency: "+a.i2c_config.frequency),e.push("")),e}function Nt(a){const e=[];if(a&&a.pins&&a.pins.spi){e.push("spi:");const n=a.pins.spi;n.id?e.push(`  - id: ${n.id}`):e.push("  - id: spi_bus"),e.push(`    clk_pin: ${n.clk}`),n.mosi&&e.push(`    mosi_pin: ${n.mosi}`),n.miso&&e.push(`    miso_pin: ${n.miso}`),n.type==="quad"&&(e.push("    interface: triple"),n.data_pins&&e.push(`    data_pins: [${n.data_pins.join(", ")}]`)),e.push(""),a.extra_spi&&(e.push(...a.extra_spi),e.push(""))}return e}function Ht(a,e={},n=!1){const i=[];if(!a)return i;const t=e.orientation||"landscape",s=a.resolution||{width:800,height:480},o=s.height>s.width,r=t==="portrait";let d=0;if(o?d=r?0:90:d=r?90:0,a.rotation_offset&&(d=(d+a.rotation_offset)%360),a.display_config){if(i.push("display:"),i.push(...a.display_config),n)for(let l=0;l<i.length;l++)i[l].includes("auto_clear_enabled: true")&&(i[l]=i[l].replace("auto_clear_enabled: true","auto_clear_enabled: false"));i.push("")}else{const l=!!(a.features&&(a.features.lcd||a.features.oled));i.push("display:"),i.push(`  - platform: ${a.displayPlatform}`),i.push(`    id: ${l?"my_display":"epaper_display"}`),n&&i.push("    auto_clear_enabled: false");const h=a.pins&&a.pins.display?a.pins.display:null;if(h){const f=(y,b)=>{b&&(typeof b=="object"?(i.push(`    ${y}:`),i.push(`      number: ${b.number}`),b.inverted!==void 0&&i.push(`      inverted: ${b.inverted}`)):i.push(`    ${y}: ${b}`))};f("cs_pin",h.cs),f("dc_pin",h.dc),f("reset_pin",h.reset),f("busy_pin",h.busy)}if(a.displayPlatform==="waveshare_epaper"&&a.displayModel&&i.push(`    model: "${a.displayModel}"`),i.push(`    rotation: ${d}`),a.displayModel==="M5Paper"||a.displayPlatform==="it8951e")i.push("    reversed: false"),i.push("    reset_duration: 200ms");else if(a.displayModel&&a.displayPlatform!=="waveshare_epaper"){let f=`    model: "${a.displayModel}"`;a.displayModel==="Seeed-reTerminal-E1002"&&(f+=" #Please update your ESPHome version to 2025.11.1 above"),i.push(f)}const g=e.refreshInterval||1;i.push(`    update_interval: ${l?g+"s":"never"}`);const m=["1.54in","1.54inv2","2.13in","2.13in-ttgo","2.13in-ttgo-b1","2.13in-ttgo-b73","2.13in-ttgo-b74","2.13in-ttgo-dke","2.13inv2","2.13inv3","2.90in","2.90in-dke","2.90inv2","2.90inv2-r2","7.50inv2p","gdew029t5","gdey029t94","gdey042t81","gdey0583t81"];a.displayModel&&m.includes(a.displayModel)&&i.push("    full_update_every: 30"),i.push("")}const c=a.display_config?"my_display":"epaper_display";return i.push(...Ls(a,c,d)),i}function $t(a,e=[],n="my_display",i=[]){const t=[];if(!a)return t;const s=a.pins||{},o=s.batteryAdc,r=a.features&&a.features.sht4x,d=a.features&&a.features.shtc3,c=e.length>0;if(!o&&!r&&!d&&!c)return t;if(t.push("sensor:"),o&&(t.push("  - platform: adc"),t.push(`    pin: ${s.batteryAdc}`),t.push('    name: "Battery Voltage"'),t.push('    unit_of_measurement: "V"'),t.push("    device_class: voltage"),t.push("    state_class: measurement"),t.push("    id: battery_voltage"),t.push("    update_interval: 60s"),t.push("    attenuation: "+a.battery.attenuation),t.push("    filters:"),t.push("      - multiply: "+a.battery.multiplier)),r&&(t.push("  - platform: sht4x"),t.push("    id: sht4x_sensor"),t.push("    temperature:"),t.push('      name: "Temperature"'),t.push("      id: sht4x_temperature"),t.push("    humidity:"),t.push('      name: "Humidity"'),t.push("      id: sht4x_humidity"),t.push("    address: 0x44"),t.push("    update_interval: 60s")),(a.features.sht3xd||a.displayModel==="M5Paper"||a.name&&a.name.includes("M5Paper"))&&(t.push("  - platform: sht3xd"),t.push("    address: 0x44"),t.push("    temperature:"),t.push('      name: "Temperature"'),t.push("      id: sht3x_temperature"),t.push("    humidity:"),t.push('      name: "Humidity"'),t.push("      id: sht3x_humidity"),t.push("    update_interval: 60s")),d&&(t.push("  - platform: shtcx"),t.push("    id: shtc3_sensor"),t.push("    i2c_id: bus_a"),t.push("    address: 0x70"),t.push("    temperature:"),t.push('      name: "Temperature"'),t.push("      id: shtc3_temperature"),t.push("    humidity:"),t.push('      name: "Humidity"'),t.push("      id: shtc3_humidity"),t.push("    update_interval: 60s")),e.length>0&&t.push(...e),o)if(t.push(""),t.push("  - platform: template"),t.push('    name: "Battery Level"'),t.push("    id: battery_level"),t.push('    unit_of_measurement: "%"'),t.push('    icon: "mdi:battery"'),t.push("    device_class: battery"),t.push("    state_class: measurement"),a.battery.curve)t.push("    lambda: 'return id(battery_voltage).state;'"),t.push("    update_interval: 60s"),t.push("    filters:"),t.push("      - calibrate_linear:"),a.battery.curve.forEach(l=>{t.push(`          - ${l.from} -> ${l.to}`)}),t.push("      - clamp:"),t.push("          min_value: 0"),t.push("          max_value: 100");else{const l=a.battery.calibration?a.battery.calibration.min:3.27,h=a.battery.calibration?a.battery.calibration.max:4.15;t.push("    lambda: |-"),t.push(`      if (id(battery_voltage).state > ${h}) return 100;`),t.push(`      if (id(battery_voltage).state < ${l}) return 0;`),t.push(`      return (id(battery_voltage).state - ${l}) / (${h} - ${l}) * 100.0;`)}return t.push(""),t}function zt(a,e,n="my_display",i=[]){const t=[],s=a&&a.features&&a.features.buttons,o=i.length>0;if(!s&&!o)return t;if(t.push("binary_sensor:"),s){const r=a.name&&a.name.includes("CoreInk"),d=a.pins.buttons||{};if(d.left&&(t.push("  - platform: gpio"),t.push("    pin:"),typeof d.left=="object"?(t.push(`      number: ${d.left.number}`),t.push(`      mode: ${d.left.mode||"INPUT_PULLUP"}`),t.push(`      inverted: ${d.left.inverted!==void 0?d.left.inverted:!0}`)):(t.push(`      number: ${d.left}`),t.push("      mode: INPUT_PULLUP"),t.push("      inverted: true")),t.push('    name: "Left Button"'),t.push("    id: button_left"),t.push("    on_press:"),t.push("      then:"),r?(t.push("        - script.execute:"),t.push("            id: change_page_to"),t.push(`            target_page: !lambda 'return id(display_page) > 0 ? id(display_page) - 1 : ${e-1};'`)):(t.push("        - script.execute:"),t.push("            id: change_page_to"),t.push(`            target_page: !lambda 'return id(display_page) > 0 ? id(display_page) - 1 : ${e-1};'`))),d.right&&(t.push("  - platform: gpio"),t.push("    pin:"),typeof d.right=="object"?(t.push(`      number: ${d.right.number}`),t.push(`      mode: ${d.right.mode||"INPUT_PULLUP"}`),t.push(`      inverted: ${d.right.inverted!==void 0?d.right.inverted:!0}`)):(t.push(`      number: ${d.right}`),t.push("      mode: INPUT_PULLUP"),t.push("      inverted: true")),t.push('    name: "Right Button"'),t.push("    id: button_right"),t.push("    on_press:"),t.push("      then:"),r?(t.push("        - script.execute:"),t.push("            id: change_page_to"),t.push(`            target_page: !lambda 'return id(display_page) < ${e-1} ? id(display_page) + 1 : 0;'`)):(t.push("        - script.execute:"),t.push("            id: change_page_to"),t.push(`            target_page: !lambda 'return id(display_page) < ${e-1} ? id(display_page) + 1 : 0;'`))),d.refresh){t.push("  - platform: gpio"),t.push("    pin:"),typeof d.refresh=="object"?(t.push(`      number: ${d.refresh.number}`),t.push(`      mode: ${d.refresh.mode||"INPUT_PULLUP"}`),t.push(`      inverted: ${d.refresh.inverted!==void 0?d.refresh.inverted:!0}`)):(t.push(`      number: ${d.refresh}`),t.push("      mode: INPUT_PULLUP"),t.push("      inverted: true"));const c=r?"Enter Button":"Refresh Button",l=r?"button_enter":"button_refresh";t.push(`    name: "${c}"`),t.push(`    id: ${l}`),t.push("    on_press:"),t.push("      then:"),t.push(`        - component.update: ${n}`)}d.home&&(t.push("  - platform: gpio"),t.push("    pin:"),typeof d.home=="object"?(t.push(`      number: ${d.home.number}`),t.push(`      mode: ${d.home.mode||"INPUT_PULLUP"}`),t.push(`      inverted: ${d.home.inverted!==void 0?d.home.inverted:!0}`)):(t.push(`      number: ${d.home}`),t.push("      mode: INPUT_PULLUP"),t.push("      inverted: true")),t.push('    name: "Home Button"'),t.push("    id: button_home"),t.push("    on_press:"),t.push("      then:"),t.push("        - script.execute:"),t.push("            id: change_page_to"),t.push("            target_page: 0"),t.push("        - script.execute: manage_run_and_sleep"))}return o&&(t.push("  # Touch Area Binary Sensors"),i.forEach(r=>{const d=(r.type||"").toLowerCase(),c=r.props||{};if(d==="template_nav_bar"){const l=c.show_prev!==!1,h=c.show_home!==!1,g=c.show_next!==!1;let m=0;if(l&&m++,h&&m++,g&&m++,m>0){const f=Math.floor(r.width/m);let y=0;const b=(w,v)=>{const I=r.x+y*f,k=I+f,M=r.y,E=r.y+r.height;t.push("  - platform: touchscreen"),t.push(`    id: nav_${w}_${r.id}`),t.push("    touchscreen_id: my_touchscreen"),t.push(`    x_min: ${I}`),t.push(`    x_max: ${k}`),t.push(`    y_min: ${M}`),t.push(`    y_max: ${E}`),t.push("    on_press:");const x=r._pageIndex!==void 0?r._pageIndex:0;t.push("      - if:"),t.push("          condition:"),t.push(`            lambda: 'return id(display_page) == ${x};'`),t.push("          then:"),w==="prev"?(t.push("            - script.execute:"),t.push("                id: change_page_to"),t.push("                target_page: !lambda 'return id(display_page) - 1;'")):w==="home"?t.push("            - script.execute: manage_run_and_sleep"):w==="next"&&(t.push("            - script.execute:"),t.push("                id: change_page_to"),t.push("                target_page: !lambda 'return id(display_page) + 1;'")),y++};l&&b("prev"),h&&b("home"),g&&b("next")}}else{const l=(r.entity_id||`touch_area_${r.id}`).replace(/[^a-zA-Z0-9_]/g,"_"),h=parseInt(String(c.icon_size||40),10),g=Math.max(r.width,h),m=Math.max(r.height,h);let f=r.x-Math.floor((g-r.width)/2),y=f+g,b=r.y-Math.floor((m-r.height)/2),w=b+m;f=Math.max(0,f),b=Math.max(0,b);const v=c.nav_action||"none",I=r._pageIndex!==void 0?r._pageIndex:0;t.push("  - platform: touchscreen"),t.push(`    id: ${l}`),t.push("    touchscreen_id: my_touchscreen"),t.push(`    x_min: ${f}`),t.push(`    x_max: ${y}`),t.push(`    y_min: ${b}`),t.push(`    y_max: ${w}`),(v!=="none"||r.entity_id)&&(t.push("    on_press:"),t.push("      - if:"),t.push("          condition:"),t.push(`            lambda: 'return id(display_page) == ${I};'`),t.push("          then:"),v==="next_page"?(t.push("            - script.execute:"),t.push("                id: change_page_to"),t.push("                target_page: !lambda 'return id(display_page) + 1;'")):v==="previous_page"?(t.push("            - script.execute:"),t.push("                id: change_page_to"),t.push("                target_page: !lambda 'return id(display_page) - 1;'")):v==="reload_page"?t.push("            - script.execute: manage_run_and_sleep"):r.entity_id&&(t.push("            - homeassistant.service:"),t.push("                service: homeassistant.toggle"),t.push("                data:"),t.push(`                  entity_id: ${r.entity_id}`)))}})),t.push(""),t}function Ft(a,e,n="my_display"){const i=[];i.push("button:"),i.push("  - platform: template"),i.push('    name: "Next Page"'),i.push("    on_press:"),i.push("      then:"),i.push("        - script.execute:"),i.push("            id: change_page_to"),i.push("            target_page: !lambda 'return id(display_page) + 1;'"),i.push("  - platform: template"),i.push('    name: "Previous Page"'),i.push("    on_press:"),i.push("      then:"),i.push("        - script.execute:"),i.push("            id: change_page_to"),i.push("            target_page: !lambda 'return id(display_page) - 1;'"),i.push("  - platform: template"),i.push('    name: "Refresh Display"'),i.push("    on_press:"),i.push("      then:"),i.push(`        - component.update: ${n}`);for(let t=0;t<e;t++)i.push("  - platform: template"),i.push(`    name: "Go to Page ${t+1}"`),i.push("    on_press:"),i.push("      then:"),i.push("        - script.execute:"),i.push("            id: change_page_to"),i.push(`            target_page: ${t}`);return a.features&&a.features.buzzer&&(i.push("  # Buzzer Sounds"),i.push("  - platform: template"),i.push('    name: "Play Beep Short"'),i.push('    icon: "mdi:bell-ring"'),i.push("    on_press:"),i.push('      - rtttl.play: "beep:d=32,o=5,b=200:16e6"'),i.push(""),i.push("  - platform: template"),i.push('    name: "Play Beep OK"'),i.push('    icon: "mdi:check-circle-outline"'),i.push("    on_press:"),i.push('      - rtttl.play: "ok:d=16,o=5,b=200:e6"'),i.push(""),i.push("  - platform: template"),i.push('    name: "Play Beep Error"'),i.push('    icon: "mdi:alert-circle-outline"'),i.push("    on_press:"),i.push('      - rtttl.play: "error:d=16,o=5,b=200:c6"'),i.push(""),i.push("  - platform: template"),i.push('    name: "Play Star Wars"'),i.push('    icon: "mdi:music-note"'),i.push("    on_press:"),i.push('      - rtttl.play: "StarWars:d=4,o=5,b=45:32p,32f,32f,32f,8a#.,8f.6,32d#,32d,32c,8a#.6,4f.6,32d#,32d,32c,8a#.6,4f.6,32d#,32d,32d#,8c6"')),i.push(""),i}function Gt(a){if(!(a.features&&a.features.psram||a.features&&a.features.features&&a.features.features.psram))return[];const n=["psram:"];return a.psram_mode&&(n.push(`  mode: ${a.psram_mode}`),n.push("  speed: 80MHz")),n.push(""),n}function jt(a){return!a.features||!a.features.axp2101||a.features.manual_pmic?[]:["axp2101:","  i2c_id: bus_a","  address: 0x34","  irq_pin: GPIO21","  battery_voltage:",'    name: "Battery Voltage"',"    id: battery_voltage","  battery_level:",'    name: "Battery Level"',"    id: battery_level","  on_setup:","    - axp2101.set_ldo_voltage:","        id: bldo1","        voltage: 3300mv","    - switch.turn_on: bldo1  # EPD_VCC (Screen Power)","    - axp2101.set_ldo_voltage:","        id: aldo1","        voltage: 3300mv","    - switch.turn_on: aldo1  # Peripherals","    - axp2101.set_ldo_voltage:","        id: aldo3","        voltage: 3300mv","    - switch.turn_on: aldo3  # Backlight/Logic",""]}function Ut(a){const e=[],n=a.m5paper?.main_power_pin||a.pins?.main_power_pin||a.m5paper?.battery_power_pin||a.pins?.battery_power_pin;return!a||!a.pins||!a.pins.batteryEnable&&!a.pins.buzzer&&!n||(e.push("output:"),a.pins.batteryEnable&&(e.push("  - platform: gpio"),typeof a.pins.batteryEnable=="object"?(e.push("    pin:"),e.push(`      number: ${a.pins.batteryEnable.number}`),a.pins.batteryEnable.ignore_strapping_warning&&e.push("      ignore_strapping_warning: true"),a.pins.batteryEnable.inverted!==void 0&&e.push(`      inverted: ${a.pins.batteryEnable.inverted}`)):e.push(`    pin: ${a.pins.batteryEnable}`),e.push("    id: bsp_battery_enable")),(a.m5paper?.main_power_pin||a.pins?.main_power_pin)&&(a.pins.batteryEnable&&e.push(""),e.push("  - platform: gpio"),e.push(`    pin: ${a.m5paper?.main_power_pin||a.pins.main_power_pin}`),e.push("    id: main_power")),(a.m5paper?.battery_power_pin||a.pins?.battery_power_pin)&&((a.pins.batteryEnable||a.m5paper?.main_power_pin)&&e.push(""),e.push("  - platform: gpio"),e.push(`    pin: ${a.m5paper?.battery_power_pin||a.pins.battery_power_pin}`),e.push("    id: battery_power")),a.pins.buzzer&&(a.pins.batteryEnable&&e.push(""),e.push("  - platform: ledc"),e.push(`    pin: ${a.pins.buzzer}`),e.push("    id: buzzer_output")),e.push("")),e}function Vt(a){return!a.features||!a.features.buzzer?[]:["rtttl:","  id: reterminal_buzzer","  output: buzzer_output",""]}function Yt(a){if(!a||!a.audio)return[];const e=[];return a.audio.i2s_audio&&(e.push("i2s_audio:"),e.push(`  i2s_lrclk_pin: ${a.audio.i2s_audio.i2s_lrclk_pin}`),e.push(`  i2s_bclk_pin: ${a.audio.i2s_audio.i2s_bclk_pin}`),a.audio.i2s_audio.i2s_mclk_pin&&e.push(`  i2s_mclk_pin: ${a.audio.i2s_audio.i2s_mclk_pin}`),e.push("")),a.audio.speaker&&(e.push("speaker:"),e.push(`  - platform: ${a.audio.speaker.platform}`),e.push("    id: my_speaker"),a.audio.speaker.dac_type&&e.push(`    dac_type: ${a.audio.speaker.dac_type}`),a.audio.speaker.i2s_dout_pin&&e.push(`    i2s_dout_pin: ${a.audio.speaker.i2s_dout_pin}`),a.audio.speaker.mode&&e.push(`    mode: ${a.audio.speaker.mode}`),e.push("")),e}function qt(a){return!a||a==="transparent"?'"0x000000"':a.startsWith("#")?'"0x'+a.substring(1).toUpperCase()+'"':`"${a}"`}function ks(a){return a?{left:"top_left",center:"center",right:"top_right"}[a.toLowerCase()]||a.toLowerCase():"top_left"}function Ts(a,e,n,i){return`font_${(a||"Roboto").toLowerCase().replace(/\s+/g,"_")}_${n||400}_${e||20}${i?"_italic":""}`}function Ps(a){return a==null?"cover":typeof a=="number"?a>=255?"cover":a<=0?"transp":Math.round(a/255*100)+"%":a}function je(a,e,n=null){const i=[],t=n||(F?F[e]||{}:{});i.push("# ============================================================================"),i.push("# LVGL Configuration"),i.push("# ============================================================================"),i.push(""),i.push("lvgl:"),i.push("  id: my_lvgl"),i.push("  log_level: WARN"),i.push('  bg_color: "0xFFFFFF"'),i.push("  displays:");const s=t.features?.lcd?"my_display":"epaper_display";return i.push(`    - ${s}`),t.touch&&(i.push("  touchscreens:"),i.push("    - my_touchscreen")),i.push(""),i.push("  pages:"),a.forEach((o,r)=>{i.push(`    - id: page_${r}`),o.layout&&/^\d+x\d+$/.test(o.layout)&&i.push(`      layout: ${o.layout}`),i.push("      widgets:");const d=o.widgets||[];if(d.length===0){i.push("        []");return}d.filter(c=>!c.hidden&&c.type!=="group").forEach(c=>{i.push(`        ${st(c)}`);const l=Ms(c,t);if(l){const h=Object.keys(l)[0],g=l[h];i.push(`        - ${h}:`),it(g,i,12)}})}),i}function it(a,e,n){const i=" ".repeat(n);Object.entries(a).forEach(([t,s])=>{if(!(s==null||s===""))if(Array.isArray(s))s.length===0?e.push(`${i}${t}: []`):(e.push(`${i}${t}:`),s.forEach(o=>{typeof o=="object"?(e.push(`${i}  -`),it(o,e,n+4)):e.push(`${i}  - ${Xt(o)}`)}));else if(typeof s=="object")e.push(`${i}${t}:`),it(s,e,n+2);else if(typeof s=="string"&&s.includes(`
`)){const o=s.split(`
`);if(s.trim().startsWith("!lambda")){e.push(`${i}${t}: ${o[0].trim()}`);const d=o.slice(1).reduce((l,h)=>{if(!h.trim())return l;const g=h.match(/^ */);return Math.min(l,g?g[0].length:0)},1/0),c=d===1/0?0:d;for(let l=1;l<o.length;l++){const h=o[l].trim()===""?"":o[l].substring(c);e.push(`${i}  ${h}`)}}else e.push(`${i}${t}: |-`),o.forEach(r=>{e.push(`${i}  ${r}`)})}else e.push(`${i}${t}: ${Xt(s)}`)})}function Xt(a){if(a==null)return"";if(typeof a!="string")return String(a);const e=a.trim();return a.startsWith('"')&&a.endsWith('"')||a.startsWith("'")&&a.endsWith("'")||e.startsWith("!lambda")||e.startsWith("!secret")?a:/^[*&!|>%@,\-{}[\]?#:]/.test(e)||/^(true|false|null|yes|no)$/i.test(e)||e.includes(": ")||e.includes(" #")?JSON.stringify(a):a}function st(a){const e=[`# widget:${a.type}`];e.push(`id:${a.id}`),e.push(`type:${a.type}`),e.push(`x:${Math.round(a.x)}`),e.push(`y:${Math.round(a.y)}`);const n=a.w!==void 0?a.w:a.width!==void 0?a.width:0,i=a.h!==void 0?a.h:a.height!==void 0?a.height:0;return e.push(`w:${Math.round(n)}`),e.push(`h:${Math.round(i)}`),a.entity_id&&e.push(`entity:${a.entity_id}`),a.props&&Object.entries(a.props).forEach(([t,s])=>{if(!(s==null||s==="")&&!(t==="id"||t==="type"||t==="x"||t==="y"||t==="w"||t==="h"||t==="entity_id"))if(typeof s=="object")try{e.push(`${t}:${JSON.stringify(s)}`)}catch(o){_.warn(`[serializeWidget] Failed to serialize prop ${t}`,o)}else e.push(`${t}:${JSON.stringify(s)}`)}),e.join(" ").replace(/[\r\n]+/g," ")}function Ms(a,e){const n=a.props||{};e?.touch||e?.features&&e.features.touch;const i=Math.round(a.x||0),t=Math.round(a.y||0),s=Math.round(a.w||a.width||100),o=Math.round(a.h||a.height||100),r={id:a.id,x:i,y:t,width:s,height:o,hidden:n.hidden||void 0,clickable:n.clickable===!1?!1:void 0,checkable:n.checkable||void 0,scrollable:n.scrollable===!1?!1:void 0,floating:n.floating||void 0,ignore_layout:n.ignore_layout||void 0,scrollbar_mode:n.scrollbar_mode!=="AUTO"?n.scrollbar_mode:void 0},d=window.PluginRegistry;if(d){const c=d.get(a.type);if(c&&typeof c.exportLVGL=="function"){const l=()=>({type:"obj",attrs:{...r}}),h=c.exportLVGL(a,{profile:e,common:r,convertColor:qt,convertAlign:ks,getLVGLFont:Ts,formatOpacity:Ps,getObjectDescriptor:l});return h&&h.type&&h.attrs?{[h.type]:h.attrs}:h}}return a.type&&(a.type.startsWith("lvgl_")||a.type.startsWith("shape_")||a.type==="rounded_rect"||a.type==="line"||a.type==="text"||a.type==="progress_bar"||a.type==="qr_code")?(_.warn(`[transpileToLVGL] Widget type ${a.type} has no exportLVGL function. Falling back to generic obj.`),{obj:{...r,bg_color:qt(n.bg_color||n.color||"white")}}):null}class As{constructor(){this.reset(),this.EXTENDED_GLYPHS=[...Array.from({length:95},(e,n)=>`\\U000000${(n+32).toString(16).toUpperCase().padStart(2,"0")}`),...Array.from({length:96},(e,n)=>`\\U000000${(n+160).toString(16).toUpperCase().padStart(2,"0")}`),"\\U000003BC","\\U000003A9","\\U000020AC","\\U00002122"]}reset(){this.definedFontIds=new Set,this.fontLines=[],this.iconCodesBySize=new Map}addFont(e,n,i,t=!1){const s=e.replace(/\s+/g,"_").toLowerCase(),o=parseInt(n)||400,r=t?"_italic":"",d=String(i).replace(".","_"),c=`font_${s}_${o}_${d}${r}`;if(this.definedFontIds.has(c))return c;if(this.definedFontIds.add(c),e!=="Material Design Icons"){const l={id:c,file:{type:"gfonts",family:e,weight:o,italic:t},size:i,glyphs:[...this.EXTENDED_GLYPHS]};this.fontLines.push(l)}return c}trackIcon(e,n){if(!e)return;const i=parseInt(n,10);this.iconCodesBySize.has(i)||this.iconCodesBySize.set(i,new Set);let t=e;/^F[0-9A-F]{4}$/i.test(e)?t=e.toUpperCase():t=window.Utils?window.Utils.getIconCode(e):null,t&&this.iconCodesBySize.get(i).add(t)}getLines(e=[],n=!1){this.definedFontIds.size===0&&this.addFont("Roboto",400,20);const i=["font:"];this.fontLines.forEach(t=>{if(i.push("  - file:"),i.push(`      type: ${t.file.type}`),i.push(`      family: "${t.file.family}"`),i.push(`      weight: ${t.file.weight}`),i.push(`      italic: ${t.file.italic?"true":"false"}`),i.push(`    id: ${t.id}`),i.push(`    size: ${Math.round(t.size)}`),e&&e.length>0){const s=e.join(", ");i.push(`    glyphsets: [${s}]`),i.push("    ignore_missing_glyphs: true")}if(n||!e||e.length===0){const s=t.glyphs.map(o=>`"${o}"`).join(", ");i.push(`    glyphs: [${s}]`)}});for(const[t,s]of this.iconCodesBySize.entries()){const o=`font_material_design_icons_400_${t}`;i.push('  - file: "fonts/materialdesignicons-webfont.ttf"'),i.push(`    id: ${o}`),i.push(`    size: ${t}`);const r=Array.from(s).sort().map(d=>`"\\U000${d}"`).join(", ");i.push(`    glyphs: [${r}]`)}return i.length>1?i:[]}}class Ds{generateInstructionHeader(e,n){const i=[];i.push("# ============================================================================"),i.push("# ESPHome YAML - Generated by ESPHome Designer"),i.push("# ============================================================================"),i.push(`# TARGET DEVICE: ${e.name||"Unknown"}`);const t=e.features||{},s=e.displayPlatform||(t.lcd?e.id==="reterminal_e1001"?"reterminal_e1001":"LCD":t.epaper?"waveshare_epaper":"Unknown");i.push(`#         - Display Platform: ${s}`),i.push(`#         - PSRAM: ${t.psram?"Yes":"No"}`),i.push(`#         - Touchscreen: ${t.touch?e.touch?.platform||"Yes":"No"}`);let o="esp-idf (Recommended)";t.psram&&(e.chip?.includes("s3")||e.id?.includes("s3"))&&(o="ESP-IDF (Required for stable PSRAM/LVGL)"),i.push(`#         - Framework: ${o}`),i.push("# ============================================================================"),i.push("#"),i.push("# SETUP INSTRUCTIONS:"),i.push("#"),i.push("# STEP 1: Copy the Material Design Icons font file"),i.push("#         - From this repo: resources/fonts/materialdesignicons-webfont.ttf"),i.push("#         - To ESPHome: /config/esphome/fonts/materialdesignicons-webfont.ttf"),i.push("#"),i.push("# STEP 2: Create a new device in ESPHome"),i.push('#         - Click "New Device"'),i.push("#         - Select: ESP32-S3 (or appropriate for your board)"),i.push("#         - Framework: ESP-IDF (Essential for S3 stability)"),i.push("#"),i.push("# STEP 3: MERGE this snippet into your YAML"),i.push("#         - Paste this snippet at the end of your configuration."),i.push("#         - System sections (esphome, esp32, wifi, logger) are commented"),i.push("#           out to avoid conflicts with your existing base setup."),i.push("#"),i.push("# CAPTIVE PORTAL:"),i.push("#         - If WiFi connection fails, the device will create a hotspot."),i.push("#         - Search for its name in your WiFi settings."),i.push("#         - Connect and go to http://192.168.4.1 to configure WiFi."),i.push("#"),i.push("# TIP: For reTerminal / S3 devices, if you cannot see logs via USB,"),i.push("#      add this to your base 'logger:' section:"),i.push("#      hardware_uart: USB_CDC"),i.push("#"),i.push("# ============================================================================"),i.push(""),i.push("# ===================================="),i.push("# Device Settings"),i.push("# ===================================="),i.push(`# Orientation: ${n.orientation||"landscape"}`),i.push(`# Dark Mode: ${n.darkMode?"enabled":"disabled"}`),i.push(`# Refresh Interval: ${n.refreshInterval||600}`);const r=!!(e.features&&(e.features.lcd||e.features.oled));let d;if(r){const c=n.lcdEcoStrategy||"backlight_off";d={always_on:"Always On",backlight_off:"Backlight Off Schedule",halt_updates:"Halt Updates",deep_sleep:"Deep Sleep"}[c]||c}else d=n.deepSleepEnabled?"Ultra Eco (Deep Sleep)":n.sleepEnabled?"Eco (Light Sleep)":"Always On";return i.push(`# Power Strategy: ${d}`),i.push(`# Deep Sleep Interval: ${n.deepSleepInterval||600}`),i.push("# ===================================="),i.push(""),i}generateSystemSections(e,n){const i=[],t=e.chip||"esp32-s3",s=e.board||"esp32-s3-devkitc-1",o=!!(e.features&&(e.features.epaper||e.features.epd)),r=e.board==="m5stack-coreink"||e.name&&e.name.toLowerCase().includes("coreink");return i.push("# esphome:"),i.push("#   name: your-device-name"),i.push("#   comment: 'Snippet generated by ESPHome Designer'"),n.plugin_includes&&n.plugin_includes.length>0&&(i.push("#   includes:"),n.plugin_includes.forEach(d=>{i.push(`#     - ${d}`)})),i.push("#   on_boot:"),i.push("#     priority: 300"),i.push("#     then:"),r||(e.id==="esp32_s3_photopainter"&&(i.push("#       - lambda: |-"),i.push("#           auto write_reg = [](uint8_t reg, uint8_t val) {"),i.push("#             uint8_t data[2] = {reg, val};"),i.push("#             id(bus_a)->write(0x34, data, 2);"),i.push("#           };"),i.push("#           write_reg(0x94, 0x1C); // ALDO3 3.3V"),i.push("#           write_reg(0x95, 0x1C); // ALDO4 3.3V"),i.push("#           write_reg(0x90, 0x1F); // Enable rails"),i.push('#           ESP_LOGI("power", "AXP2101 Configured");'),i.push("#       - delay: 200ms"),i.push("#       - component.update: epaper_display")),e.battery&&e.pins&&e.pins.batteryEnable&&i.push("#       - output.turn_on: bsp_battery_enable"),(e.m5paper?.main_power_pin||e.pins?.main_power_pin)&&i.push("#       - output.turn_on: main_power"),(e.m5paper?.battery_power_pin||e.pins?.battery_power_pin)&&i.push("#       - output.turn_on: battery_power"),i.push("#       - delay: 2s")),r?(i.push("#       # 1. HARDWARE POWER LOCK (ESP-IDF Version)"),i.push("#       - lambda: |-"),i.push("#           gpio_set_direction(GPIO_NUM_12, GPIO_MODE_OUTPUT);"),i.push("#           gpio_set_level(GPIO_NUM_12, 1);"),i.push("#           gpio_hold_en(GPIO_NUM_12);"),i.push("#           gpio_deep_sleep_hold_en();"),i.push("#"),i.push("#       # 2. Start the Main Logic Loop"),i.push("#       - script.execute: manage_run_and_sleep"),i.push("#"),i.push("#       # 3. Initial Screen Update"),i.push("#       - component.update: epaper_display")):o&&n.deepSleepEnabled?i.push("#       - script.execute: deep_sleep_cycle"):i.push("#       - script.execute: manage_run_and_sleep"),n.autoCycleEnabled&&i.push("#       - script.execute: auto_cycle_timer"),i.push("#"),i.push("# esp32:"),i.push(`#   board: ${s}`),i.push("#   framework:"),i.push("#     type: esp-idf"),t.includes("s3")&&(i.push("#     sdkconfig_options:"),i.push("#       CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240: y"),i.push("#       CONFIG_ESP32S3_DATA_CACHE_64KB: y")),i.push("#"),i.push("# logger:"),t.includes("s3")&&i.push("#   hardware_uart: USB_CDC # Enable for USB debugging on S3"),i.push("#   level: DEBUG"),i.push("#"),i.push("# api:"),i.push("# ota:"),i.push("# wifi:"),i.push("#   # ... your wifi config here"),o&&n.deepSleepEnabled&&(i.push(""),i.push("deep_sleep:"),i.push("  id: deep_sleep_control"),i.push("  run_duration: 30s # Stay awake 30s on boot for OTA"),i.push(`  sleep_duration: ${n.deepSleepInterval||600}s`)),i.push(""),i}generateScriptSection(e,n,i){const t=[],s=i.features?.lcd?"my_display":"epaper_display",o=e.autoCycleEnabled&&n.length>1,r=!!(i.features&&(i.features.lcd||i.features.oled)),d=!!(i.features&&(i.features.epaper||i.features.epd)),c=!!(i.features&&i.features.oled),l=r?500:3e3,h=i.backlight&&i.backlight.pin?i.backlight.pin:i.pins?.backlight||null,g=e.lcdEcoStrategy||"backlight_off",m=r&&g==="backlight_off"&&h,f=d&&e.deepSleepEnabled;t.push("script:"),t.push("  - id: change_page_to"),t.push("    parameters:"),t.push("      target_page: int"),t.push("    then:"),t.push("      - lambda: |-"),t.push(`          int pages_count = ${n.length};`),t.push("          int target = target_page;"),t.push("          while (target < 0) target += pages_count;"),t.push("          target %= pages_count;"),t.push(""),t.push(`          // Debounce: Ignore page changes within ${l}ms of last change`),t.push(`          // (adjusted for ${r?"LCD":"e-paper"} display update time)`),t.push("          uint32_t now = millis();"),t.push(`          if (now - id(last_page_switch_time) < ${l}) {`),t.push('            ESP_LOGD("display", "Page change ignored (debounce), last switch was %d ms ago", now - id(last_page_switch_time));'),t.push("            return;"),t.push("          }"),t.push(""),t.push("          if (id(display_page) != target) {"),t.push("            // Set debounce time BEFORE display update (update takes ~1.6s)"),t.push("            id(last_page_switch_time) = now;"),t.push("            id(display_page) = target;"),t.push(`            id(${s}).update();`),t.push('            ESP_LOGI("display", "Switched to page %d", target);'),t.push("            // Restart refresh logic"),t.push("            if (id(manage_run_and_sleep).is_running()) id(manage_run_and_sleep).stop();"),t.push("            id(manage_run_and_sleep).execute();"),m&&(t.push("            // LCD Strategy: Wake up backlight on interaction/page change"),t.push("            id(backlight_pwm).set_level(0.8); // Restore brightness")),t.push("          }"),f&&(t.push(""),t.push("  - id: deep_sleep_cycle"),t.push("    then:"),t.push('      - logger.log: "Waiting for sync before Deep Sleep..."'),t.push("      - wait_until:"),t.push("          condition:"),t.push("            lambda: 'return id(ha_time).now().is_valid() && api_is_connected();'"),t.push("          timeout: 60s"),t.push("      - delay: 5s"),t.push(`      - component.update: ${s}`),t.push("      - delay: 5s # Ensure refresh starts before sleep"),t.push('      - logger.log: "Entering Deep Sleep now..."'),t.push("      - deep_sleep.enter: deep_sleep_control")),t.push(""),t.push("  - id: manage_run_and_sleep","    mode: restart","    then:"),(i.m5paper?.main_power_pin||i.pins?.main_power_pin)&&t.push("      - output.turn_on: main_power"),(i.m5paper?.battery_power_pin||i.pins?.battery_power_pin)&&t.push("      - output.turn_on: battery_power"),t.push('      - logger.log: "Waiting for sync..."'),t.push("      - wait_until:"),t.push("          condition:"),t.push("            lambda: 'return id(ha_time).now().is_valid() && api_is_connected();'"),t.push("          timeout: 60s"),t.push("      - delay: 5s"),t.push("      - lambda: |-"),t.push("          int p = id(display_page);"),t.push("          int interval = id(page_refresh_default_s);"),t.push("          bool is_sleep_time = false;");const y=parseInt(e.sleepStartHour)||0,b=parseInt(e.sleepEndHour)||0,w=!!e.sleepEnabled;if(t.push("          auto time = id(ha_time).now();"),t.push("          if (time.is_valid()) {"),t.push("             int hour = time.hour;"),t.push(`             int start = ${y};`),t.push(`             int end = ${b};`),t.push("             if (start < end) {"),t.push("                 if (hour >= start && hour < end) is_sleep_time = true;"),t.push("             } else {"),t.push("                 if (hour >= start || hour < end) is_sleep_time = true;"),t.push("             } "),t.push("          }"),r?m?(t.push("          #ifdef USE_BACKLIGHT"),t.push("          if (is_sleep_time) {"),t.push("              auto call = id(backlight_pwm).make_call();"),t.push("              call.set_brightness(0.0);"),t.push("              call.perform();"),t.push("              interval = 3600; // Check back in an hour"),t.push("          } else {"),t.push("              auto call = id(backlight_pwm).make_call();"),t.push("              call.set_brightness(0.8);"),t.push("              call.perform();"),t.push("          }"),t.push("          #endif")):c&&w&&(t.push("          if (is_sleep_time) {"),t.push("              // OLED specific: Blank screen or similar would go here"),t.push("              interval = 3600;"),t.push("          }")):w&&!f&&(t.push("          if (is_sleep_time) {"),t.push("              interval = 3600; // Sleep for an hour (skip updates)"),t.push("          }")),t.push("          if (!is_sleep_time) {"),n.forEach((v,I)=>{const k=parseInt(v.refresh_s);!isNaN(k)&&k>0&&t.push(`            if (p == ${I}) interval = ${k};`)}),t.push("          }"),t.push("          id(page_refresh_current_s) = interval;"),t.push(`      - component.update: ${s}`),t.push("      - delay: !lambda 'return id(page_refresh_current_s) * 1000;'"),t.push("      - script.execute: manage_run_and_sleep"),o){const v=e.autoCycleIntervalS||30;t.push("  - id: auto_cycle_timer","    mode: restart","    then:"),t.push(`      - delay: ${v}s`),t.push("      - script.execute:"),t.push("          id: change_page_to"),t.push("          target_page: !lambda 'return id(display_page) + 1;'"),t.push("      - script.execute: auto_cycle_timer")}return t}}class bi extends xe{constructor(){super(),this.fonts=new As,this.yaml=new Ds,this.reset()}reset(){this.fonts&&this.fonts.reset(),this.usedPlugins=new Set}async generate(e){if(!e)return console.error("ESPHomeAdapter: Missing layout"),"";this.reset();const n=e.pages||[],i=e.deviceModel||(u?u.deviceModel:null)||window.currentDeviceModel||"reterminal_e1001",t=F||{},s=window.DEVICE_PROFILES||{};let r={...t,...s}[i]||{};if(i==="custom"&&e.customHardware){const E=e.customHardware;r={id:"custom",name:"Custom Device",chip:E.chip||"esp32-s3",displayPlatform:E.displayDriver||"generic_st7789",resolution:{width:E.resWidth||800,height:E.resHeight||480},shape:E.shape||"rect",pins:{i2c:E.pins?.sda?{sda:E.pins.sda,scl:E.pins.scl}:null,spi:E.pins?.clk?{clk:E.pins.clk,mosi:E.pins.mosi}:null,display:{cs:E.pins?.cs,dc:E.pins?.dc,reset:E.pins?.rst,busy:E.pins?.busy}},features:{psram:!!E.psram,lcd:E.tech==="lcd",epaper:E.tech==="epaper",touch:E.touchTech&&E.touchTech!=="none"},backlight:E.pins?.backlight?{platform:"gpio",pin:E.pins.backlight}:null,touch:E.touchTech&&E.touchTech!=="none"?{platform:E.touchTech,sda:E.pins?.sda,scl:E.pins?.scl,interrupt_pin:E.pins?.touch_int,reset_pin:E.pins?.touch_rst}:null}}let d=!!(r.features&&(r.features.lvgl||r.features.lv_display));const c=e.renderingMode||(u?u.settings?.renderingMode:null);if(c==="direct"?(d=!1,_.log("[ESPHomeAdapter] Rendering mode set to 'direct', skipping LVGL generation")):c==="lvgl"&&(d=!0,_.log("[ESPHomeAdapter] Rendering mode set to 'lvgl', forcing LVGL generation")),!d)for(const E of n){if(E.widgets){for(const x of E.widgets.filter(S=>!S.hidden))if(x.type.startsWith("lvgl_")){d=!0;break}}if(d)break}const l=[];l.push(...this.yaml.generateInstructionHeader(r,e)),l.push(...this.yaml.generateSystemSections(r,e)),l.push("");const h=r.features?.lcd?"my_display":"epaper_display";this.preProcessWidgetsPromise=this.preProcessWidgets(n),await this.preProcessWidgetsPromise;let g=null;r.isPackageBased&&(r.isOfflineImport&&r.content?g=r.content:r.hardwarePackage&&(g=await this.fetchHardwarePackage(r.hardwarePackage)));const m=[];n.forEach((E,x)=>{E.widgets&&E.widgets.forEach(S=>{S.hidden||(S._pageIndex=x,m.push(S))})});const f=new Set,y=new Set,b=new Set,w=new Map,v={widgets:m,profile:r,displayId:h,adapter:this,isLvgl:d,seenEntityIds:f,seenSensorIds:y,seenTextEntityIds:b,pendingTriggers:w};if(V){const E=[],x=[];V.onExportEsphome({...v,lines:x}),E.push("- id: display_page","  type: int","  restore_value: true","  initial_value: '0'");const S=!!(r.features&&(r.features.epaper||r.features.epd)),L=!!(r.features&&r.features.lcd)||!S,G=e.refreshInterval||(L?60:e.deepSleepInterval||600);E.push("- id: page_refresh_default_s","  type: int","  restore_value: true",`  initial_value: '${G}'`),E.push("- id: page_refresh_current_s","  type: int","  restore_value: false","  initial_value: '60'"),E.push("- id: last_page_switch_time","  type: uint32_t","  restore_value: false","  initial_value: '0'"),V.onExportGlobals({...v,lines:E}),x.length>0&&(e.plugin_includes=x),r.isPackageBased||(l.length=0,l.push(...this.yaml.generateInstructionHeader(r,e)),l.push(...this.yaml.generateSystemSections(r,e)),l.push("")),E.length>0&&(l.push("globals:"),l.push(...E.map(D=>"  "+D))),!(g&&g.includes("psram:"))&&r.features?.psram&&Gt&&l.push(...Gt(r)),r.isPackageBased?l.some(B=>String(B).split(`
`).some(X=>X.trim()==="time:"))||(l.push("time:","  - platform: homeassistant","    id: ha_time"),y.add("ha_time")):(l.push("http_request:","  verify_ssl: false","  timeout: 20s","  buffer_size_rx: 4096"),Wt&&l.push(...Wt(r)),Nt&&l.push(...Nt(r)),Rt&&l.push(...Rt(r)),jt&&l.push(...jt(r)),Ut&&l.push(...Ut(r)),Ot&&l.push(...Ot(r)),Vt&&l.push(...Vt(r)),Yt&&l.push(...Yt(r)),l.some(B=>String(B).split(`
`).some(X=>X.trim()==="time:"))||(l.push("time:","  - platform: homeassistant","    id: ha_time"),y.add("ha_time"))),r.features&&(r.pins?.batteryAdc&&(y.add("battery_voltage"),y.add("battery_level")),r.features.sht4x&&(y.add("sht4x_sensor"),y.add("sht4x_temperature"),y.add("sht4x_humidity")),(r.features.sht3x||r.features.sht3xd)&&(y.add("sht3x_sensor"),y.add("sht3x_temperature"),y.add("sht3x_humidity")),r.features.shtc3&&(y.add("shtc3_sensor"),y.add("shtc3_temperature"),y.add("shtc3_humidity"))),$t&&l.push(...$t(r,[],h,m));const R=[];V.onExportNumericSensors({...v,lines:R,mainLines:l});const A=this.processPendingTriggers(R,w,d,"on_value");A.length>0&&(l.some(D=>D==="sensor:")||l.push("sensor:"),l.push(...A.flatMap(D=>D.split(`
`).map(B=>"  "+B))));const U=n.flatMap(D=>(D.widgets||[]).filter(B=>!B.hidden)),J=[];if(U.forEach(D=>{let B=(D.entity_id||"").trim();const X=D.props||{};if(!B||X.is_local_sensor||(["progress_bar","sensor_text","graph","battery_icon","wifi_signal","ondevice_temperature","ondevice_humidity"].includes(D.type)&&!B.includes(".")&&(B=`sensor.${B}`),D.type==="sensor_text"&&X.is_text_sensor))return;const wt=B.includes(".")&&!B.startsWith("weather.")&&!B.startsWith("text_sensor.")&&!B.startsWith("binary_sensor."),xi=["switch.","light.","fan.","input_boolean.","cover.","lock."].some(re=>B.startsWith(re));if(wt&&!xi&&!f.has(B)){let re=B.replace(/[^a-zA-Z0-9_]/g,"_");re.length>63&&(re=re.substring(0,63)),y.has(re)||(f.add(B),y.add(re),J.push("- platform: homeassistant"),J.push(`  id: ${re}`),J.push(`  entity_id: ${B}`),J.push("  internal: true"))}}),J.length>0){l.some(B=>B==="sensor:")||l.push("sensor:");const D=this.processPendingTriggers(J,w,d,"on_value");l.push(...D.flatMap(B=>B.split(`
`).map(X=>"  "+X)))}const j=[];V.onExportTextSensors({...v,lines:j});const p=this.processPendingTriggers(j,w,d,"on_value");p.length>0&&(l.push("text_sensor:"),l.push(...p.flatMap(D=>D.split(`
`).map(B=>"  "+B))));const T=[];if(!r.isPackageBased&&zt){const D=zt(r,n.length,h,[]);D.length>0&&D[0].trim()==="binary_sensor:"?T.push(...D.slice(1).map(B=>B.startsWith("  ")?B.slice(2):B)):T.push(...D)}V.onExportBinarySensors({...v,lines:T});const K=this.processPendingTriggers(T,w,d,"on_state");K.length>0&&(l.push("binary_sensor:"),l.push(...K.flatMap(D=>D.split(`
`).map(B=>"  "+B))));const H=n.flatMap(D=>(D.widgets||[]).filter(B=>!B.hidden)),C=["binary_sensor.","switch.","light.","input_boolean.","fan.","cover.","vacuum.","lock."],ee=[];if(H.forEach(D=>{const B=(D.condition_entity||"").trim(),X=(D.entity_id||"").trim();[B,X].forEach(ie=>{if(!ie)return;if(C.some(fe=>ie.startsWith(fe))&&!f.has(ie)){const fe=ie.replace(/[^a-zA-Z0-9_]/g,"_");y.has(fe)||(f.add(ie),y.add(fe),ee.push("- platform: homeassistant"),ee.push(`  id: ${fe}`),ee.push(`  entity_id: ${ie}`),ee.push("  internal: true"))}})}),ee.length>0){l.some(B=>B==="binary_sensor:")||l.push("binary_sensor:");const D=this.processPendingTriggers(ee,w,d,"on_state");l.push(...D.flatMap(B=>B.split(`
`).map(X=>"  "+X)))}if(!r.isPackageBased&&Ft){const D=Ft(r,n.length,h);D.length>0&&l.push(...D)}const Y=V.getAll(),$=["image","online_image","graph","qr_code"];Y.sort((D,B)=>{const X=$.indexOf(D.id),ie=$.indexOf(B.id);return X!==-1&&ie!==-1?X-ie:X!==-1?-1:ie!==-1?1:D.id.localeCompare(B.id)}),Y.forEach(D=>D.onExportComponents&&D.onExportComponents({...v,lines:l}))}const I=this.generateDisplayLambda(n,e,r,v);l.push(...this.fonts.getLines(e.glyphsets,e.extendedLatinGlyphs));const k=this.yaml.generateScriptSection(e,n,r);if(k.length>0&&l.push(...k),d&&je){const E=je(n,i,r);E&&E.length>0&&l.push(...E)}const M=d&&je;if(r.isPackageBased){if(g){const E=/^(\s*)# __LAMBDA_PLACEHOLDER__/m,x=g.match(E);if(x){const W=x[1],R="# __LAMBDA_PLACEHOLDER__",A=new RegExp(`lambda:\\s*\\|-\\s*[\\r\\n]+\\s*${R.replace("#","\\#")}`).test(g);if(M)g=g.replace(E,"");else{const U=(A?"":W+`lambda: |-
`)+I.map(J=>J.trim()?W+"  "+J:"").join(`
`);g=g.replace(E,U)}}g=this.applyPackageOverrides(g,r,e.orientation,M);const S=this.sanitizePackageContent(g),L=[];let G=!1;for(const W of l){const R=W.trim();R.endsWith(":")&&!W.startsWith(" ")&&(G=R==="display:"),G||L.push(W)}return this.mergeYamlSections(S,L.join(`
`))}}else{const E=Ht?Ht(r,e,d):[];l.push(...E);for(let x=0;x<l.length;x++)if(l[x].trim()==="display:"){let S=x+1;for(;S<l.length&&(l[S].startsWith("  ")||l[S].trim()==="");)S++;M||l.splice(S,0,"    lambda: |-",...I.map(L=>L.trim()?"      "+L:""));break}}return l.map(E=>E.trimEnd()).join(`
`)}async preProcessWidgets(e){for(const n of e)if(n.widgets)for(const i of n.widgets.filter(t=>!t.hidden&&t.type!=="group")){const t=i.type,s=V?await V.load(t):null;s&&(this.usedPlugins.add(s),typeof s.collectRequirements=="function"&&s.collectRequirements(i,{trackIcon:(o,r)=>this.fonts.trackIcon(o,r),addFont:(o,r,d,c)=>this.fonts.addFont(o,r,d,c)}))}}generateDisplayLambda(e,n,i,t){const s=[],o=i.features?.inverted_colors||n.invertedColors,r=!!(i.features&&(i.features.epaper||i.features.epd));return o?(s.push("const auto COLOR_WHITE = Color(0, 0, 0); // Inverted for e-ink"),s.push("const auto COLOR_BLACK = Color(255, 255, 255); // Inverted for e-ink")):(s.push("const auto COLOR_WHITE = Color(255, 255, 255);"),s.push("const auto COLOR_BLACK = Color(0, 0, 0);")),i.id==="esp32_s3_photopainter"||i.name&&i.name.includes("PhotoPainter")?(s.push("const auto COLOR_RED = Color(0, 0, 255);"),s.push("const auto COLOR_GREEN = Color(255, 128, 0);"),s.push("const auto COLOR_BLUE = Color(255, 255, 0);"),s.push("const auto COLOR_YELLOW = Color(0, 255, 0);"),s.push("const auto COLOR_ORANGE = Color(0, 0, 255); // Fallback to Red")):(s.push("const auto COLOR_RED = Color(255, 0, 0);"),s.push("const auto COLOR_GREEN = Color(0, 255, 0);"),s.push("const auto COLOR_BLUE = Color(0, 0, 255);"),s.push("const auto COLOR_YELLOW = Color(255, 255, 0);"),s.push("const auto COLOR_ORANGE = Color(255, 165, 0);")),s.push("auto color_off = COLOR_WHITE;"),s.push("auto color_on = COLOR_BLACK;"),s.push(""),s.push("// Helper to print text with word-wrap at widget boundary"),s.push("auto print_wrapped_text = [&](int x, int y, int max_w, int line_h, esphome::font::Font *font, Color color, TextAlign align, const char* text) {"),s.push("  if (!text || max_w <= 0) return;"),s.push("  int cx = x;"),s.push("  int cy = y;"),s.push("  std::string line;"),s.push("  std::string word;"),s.push("  const char* p = text;"),s.push("  while (*p) {"),s.push("    if (*p == ' ' || *p == '\\n') {"),s.push("      if (!word.empty()) {"),s.push("        int ww, wh, wbl;"),s.push("        font->measure(word.c_str(), &ww, &wbl, &wh);"),s.push("        int lw = 0;"),s.push('        if (!line.empty()) { font->measure(line.c_str(), &lw, &wbl, &wh); lw += font->measure(" ", &ww, &wbl, &wh), ww; }'),s.push("        font->measure(word.c_str(), &ww, &wbl, &wh);"),s.push("        if (lw + ww > max_w && !line.empty()) {"),s.push("          it.print(cx, cy, font, color, align, line.c_str());"),s.push("          cy += line_h;"),s.push("          line = word;"),s.push("        } else {"),s.push('          if (!line.empty()) line += " ";'),s.push("          line += word;"),s.push("        }"),s.push("        word.clear();"),s.push("      }"),s.push("      if (*p == '\\n' && !line.empty()) {"),s.push("        it.print(cx, cy, font, color, align, line.c_str());"),s.push("        cy += line_h;"),s.push("        line.clear();"),s.push("      }"),s.push("    } else {"),s.push("      word += *p;"),s.push("    }"),s.push("    p++;"),s.push("  }"),s.push("  if (!word.empty()) {"),s.push("    int ww, wh, wbl;"),s.push("    font->measure(word.c_str(), &ww, &wbl, &wh);"),s.push("    int lw = 0;"),s.push("    if (!line.empty()) { font->measure(line.c_str(), &lw, &wbl, &wh); }"),s.push("    if (lw + ww > max_w && !line.empty()) {"),s.push("      it.print(cx, cy, font, color, align, line.c_str());"),s.push("      cy += line_h;"),s.push("      line = word;"),s.push("    } else {"),s.push('      if (!line.empty()) line += " ";'),s.push("      line += word;"),s.push("    }"),s.push("  }"),s.push("  if (!line.empty()) {"),s.push("    it.print(cx, cy, font, color, align, line.c_str());"),s.push("  }"),s.push("};"),s.push(""),r&&(s.push("// Helper to apply a simple grey dither mask for e-paper (checkerboard)"),s.push("auto apply_grey_dither_mask = [&](int x_start, int y_start, int w, int h) {"),s.push("  for (int y = y_start; y < y_start + h; y++) {"),s.push("    for (int x = x_start; x < x_start + w; x++) {"),s.push("      if ((x + y) % 2 == 0) it.draw_pixel_at(x, y, COLOR_WHITE);"),s.push("      else it.draw_pixel_at(x, y, COLOR_BLACK);"),s.push("    }"),s.push("  }"),s.push("};"),s.push(""),s.push("// Helper to apply grey dither to text (subtractive - erases every other black pixel)"),s.push("auto apply_grey_dither_to_text = [&](int x_start, int y_start, int w, int h) {"),s.push("  for (int y = y_start; y < y_start + h; y++) {"),s.push("    for (int x = x_start; x < x_start + w; x++) {"),s.push("      if ((x + y) % 2 == 0) it.draw_pixel_at(x, y, COLOR_WHITE);"),s.push("    }"),s.push("  }"),s.push("};")),window.PluginRegistry&&window.PluginRegistry.onExportHelpers({lines:s,widgets:e.flatMap(d=>d.widgets||[])}),s.push("int currentPage = id(display_page);"),e.forEach((d,c)=>{s.push(`if (currentPage == ${c}) {`),s.push(`  // page:name "${d.name||"Page "+(c+1)}"`),s.push(`  // page:dark_mode "${d.dark_mode||"inherit"}"`),s.push(`  // page:refresh_type "${d.refresh_type||"interval"}"`),s.push(`  // page:refresh_time "${d.refresh_time||""}"`);const l=d.dark_mode==="dark"||d.dark_mode==="inherit"&&n.darkMode;s.push("  // Clear screen for this page"),s.push(`  it.fill(${l?"COLOR_BLACK":"COLOR_WHITE"});`),s.push(`  color_off = ${l?"COLOR_BLACK":"COLOR_WHITE"};`),s.push(`  color_on = ${l?"COLOR_WHITE":"COLOR_BLACK"};`),d.widgets&&d.widgets.filter(h=>!h.hidden&&h.type!=="group").forEach(h=>{const g=this.generateWidget(h,{...t,layout:n,adapter:this,isEpaper:r,isDark:l});if(g.length>0){const m=g.reduce((y,b)=>{if(!b.trim())return y;const w=b.match(/^ */);return Math.min(y,w?w[0].length:0)},1/0),f=m===1/0?0:m;s.push(...g.map(y=>y.trim()?"  "+y.substring(f):""))}}),s.push("}")}),s}generateWidget(e,n){if(e.type==="group")return[];const i=[],t=V?V.get(e.type):null,s=e.type&&e.type.startsWith("lvgl_");if(t&&typeof t.export=="function"){const o={...n,lines:i,addFont:(d,c,l,h)=>this.fonts.addFont(d,c,l,h),getColorConst:d=>se?se.getColorConst(d):`"${d}"`,getAlignX:(d,c,l)=>se?se.getAlignX(d,c,l):c,getAlignY:(d,c,l)=>se?se.getAlignY(d,c,l):c,addDitherMask:(d,c,l,h,g,m,f,y)=>se?se.addDitherMask(d,c,l,h,g,m,f,y||0):null,sanitize:d=>this.sanitize(d),getCondProps:d=>this.getCondProps(d),getConditionCheck:d=>this.getConditionCheck(d),Utils:se,COLORS:lt,ALIGNMENT:dt,TEXT_Y_OFFSET:0,RECT_Y_OFFSET:0},r=t.export(e,o);r&&Array.isArray(r)?i.push(...r):r&&typeof r=="string"&&i.push(r)}else if(s)if(st){const o=st(e);i.push(o?o.replace(/[\r\n]+/g," "):"")}else{const o=`// widget:${e.type} id:${e.id} x:${e.x} y:${e.y} w:${e.width} h:${e.height}`;i.push(o.replace(/[\r\n]+/g," "))}else i.push(`// widget:${e.type} id:${e.id} status:unsupported`),i.push(`        // Unsupported widget type: ${e.type}`);return i}processPendingTriggers(e,n,i,t="on_value"){if(!i||!n||n.size===0)return e;const s=[];let o=null;for(let r=0;r<e.length;r++){const d=e[r],c=d.trim();s.push(d);const l=d.match(/^\s*(entity_id|id):\s*"?([^"]+)"?/);if(l){const h=l[2].trim();if(n.has(h)){let m=!1;const f=(d.match(/^\s*/)||[""])[0].length;for(let y=r+1;y<e.length;y++){const b=e[y],w=b.trim();if(!w)continue;if((b.match(/^\s*/)||[""])[0].length<=f&&w.startsWith("-"))break;if(w===`${t}:`){m=!0;break}}if(m)o={triggers:n.get(h),active:!0};else{const y=" ".repeat(f);s.push(`${y}${t}:`),s.push(`${y}  then:`);for(const b of n.get(h))b.split(`
`).forEach(v=>{s.push(`${y}    ${v}`)})}}}if(o&&o.active){if(c===`${t}:`)o.foundKey=!0;else if(o.foundKey){if(c==="then:"){const h=" ".repeat((d.match(/^\s*/)||[""])[0].length+2);for(const g of o.triggers)g.split(`
`).forEach(f=>{s.push(`${h}${f}`)});o=null}else if(c.startsWith("-")){const h=" ".repeat((d.match(/^\s*/)||[""])[0].length);for(const g of o.triggers)g.split(`
`).forEach(f=>{s.push(`${h}${f}`)});o=null}}}}return s}async fetchHardwarePackage(e){let n=e;window.location.pathname.includes("/esphome-designer/editor")&&!e.startsWith("http")&&!e.startsWith("/")&&(n="/esphome-designer/editor/static/"+e);try{const i=await fetch(n,{cache:"no-store"});if(!i.ok)throw new Error(`HTTP ${i.status}`);return await i.text()}catch(i){return _.error("Failed to fetch hardware package:",i),`# ERROR LOADING PROFILE: ${i.message}`}}sanitizePackageContent(e){if(!e)return"";const n=["esphome:","esp32:","psram:","wifi:","api:","ota:","logger:","web_server:","captive_portal:","platformio_options:","preferences:","substitutions:","deep_sleep:"],i=e.split(`
`),t=[];let s=!1;for(let o of i){const r=o.trim();if(r.length===0){t.push(o);continue}(o.match(/^\s*/)||[""])[0].length===0&&r.endsWith(":")?(s=n.some(c=>r.startsWith(c)),s?t.push("# "+o+" # (Auto-commented)"):t.push(o)):s?t.push("# "+o):t.push(o)}return t.join(`
`)}applyPackageOverrides(e,n,i,t=!1){if(t&&(e=e.replace(/auto_clear_enabled:\s*true/g,"auto_clear_enabled: false")),n.name?.toLowerCase().includes("waveshare touch lcd 7")){let s=0;i==="portrait"?s=90:i==="landscape"?s=0:i==="portrait_inverted"?s=270:i==="landscape_inverted"&&(s=180),e=e.replace(/(display:[\s\S]*?rotation:\s*)\d+/g,`$1${s}`);const o=n.name.replace(/["\\]/g,"").split(" ")[0]||"ESPHome-Device";e=e.replace(/"Waveshare-7-Inch"/g,`"${o}-Hotspot"`);const r=e.match(/^(\s*)id:\s*my_touchscreen/m);if(r){const d=r[1];let c="";s===0?c=`transform:
${d}  swap_xy: false
${d}  mirror_x: false
${d}  mirror_y: false`:s===90?c=`transform:
${d}  swap_xy: true
${d}  mirror_x: false
${d}  mirror_y: true`:s===180?c=`transform:
${d}  swap_xy: false
${d}  mirror_x: true
${d}  mirror_y: true`:s===270&&(c=`transform:
${d}  swap_xy: true
${d}  mirror_x: true
${d}  mirror_y: false`),c&&(new RegExp(`^${d}transform:[\\s\\S]*?^(?=\\S|\\s{${d.length},${d.length}}\\S)`,"m"),e=e.replace(/^(\s*)id:\s*my_touchscreen.*$/m,`$1id: my_touchscreen
$1${c}`))}}return e}mergeYamlSections(e,n){if(!n||n.trim()==="")return e;if(!e||e.trim()==="")return n;const i=["sensor:","binary_sensor:","text_sensor:","font:","image:","output:","light:","switch:","button:","script:","globals:","i2c:","spi:","external_components:","time:","interval:"],t=c=>{const l=new Map,h=c.split(`
`);let g=null,m=[],f=[];for(const y of h){const b=y.trim(),w=b.endsWith(":")&&!y.startsWith(" ")&&!y.startsWith("	");w&&i.includes(b)?(g&&l.set(g,m),g=b,m=[]):w&&!i.includes(b)?(g&&(l.set(g,m),g=null,m=[]),f.push(y)):g?m.push(y):f.push(y)}return g&&l.set(g,m),{sections:l,nonSectionLines:f}},s=t(e),o=t(n),r=new Map(s.sections);for(const[c,l]of o.sections)if(r.has(c)){const h=r.get(c);r.set(c,[...h,...l])}else r.set(c,l);const d=[];d.push(...s.nonSectionLines);for(const[c,l]of r)d.length>0&&d[d.length-1].trim()!==""&&d.push(""),d.push(c),d.push(...l);for(const c of o.nonSectionLines){const l=c.trim();l===""||l.startsWith("#")||l.endsWith(":")&&!c.startsWith(" ")&&s.nonSectionLines.some(g=>g.trim()===l)||d.push(c)}return d.map(c=>c.trimEnd()).join(`
`)}getCondProps(e){const n=(e.condition_entity||"").trim();if(!n)return"";const i=e.condition_operator||"==";let t=` cond_ent:"${n}" cond_op:"${i}"`;return i==="range"?(e.condition_min!==void 0&&e.condition_min!==null&&(t+=` cond_min:"${e.condition_min}"`),e.condition_max!==void 0&&e.condition_max!==null&&(t+=` cond_max:"${e.condition_max}"`)):e.condition_state!==void 0&&e.condition_state!==null&&(t+=` cond_state:"${e.condition_state}"`),t}getConditionCheck(e){const n=(e.condition_entity||"").trim();if(!n)return"";const i=e.condition_operator||"==",t=(e.condition_state||"").trim(),s=t.toLowerCase(),o=e.condition_min,r=e.condition_max,d=n.replace(/[^a-zA-Z0-9_]/g,"_"),l=["binary_sensor.","switch.","light.","input_boolean.","fan.","cover.","vacuum.","lock."].some(y=>n.startsWith(y));let g=n.startsWith("text_sensor.");if(!g&&!l&&i!=="range"){const y=parseFloat(t),b=["on","off","true","false","open","closed","locked","unlocked","home","not_home","occupied","clear","active","inactive","detected","idle"];t&&isNaN(y)&&!b.includes(s)&&(g=!0)}let m=`id(${d}).state`;g&&n.startsWith("text_sensor.");let f="";if(i==="=="||i==="!="||i===">"||i==="<"||i===">="||i==="<=")if(g)f=`${m} ${i} "${t}"`;else if(l){const b=["on","true","1","open","locked","home","occupied","active","detected"].includes(s);i==="=="?f=b?m:`!${m}`:i==="!="?f=b?`!${m}`:m:f=`(int)${m} ${i} ${b?1:0}`}else{let y=parseFloat(t);isNaN(y)&&(["on","true","open","locked","home","occupied","active","detected"].includes(s)?y=1:["off","false","closed","unlocked","not_home","clear","inactive","idle"].includes(s)&&(y=0)),f=`${m} ${i} ${isNaN(y)?0:y}`}else if(i==="range"){const y=parseFloat(o),b=parseFloat(r);f=`${m} >= ${isNaN(y)?0:y} && ${m} <= ${isNaN(b)?100:b}`}return f?`if (${f}) {`:""}sanitize(e){return e?e.replace(/"/g,'\\"'):""}}window.ESPHomeAdapter=bi;class wi extends xe{constructor(){super()}async generate(e){if(!e)return console.error("OEPLAdapter: Missing layout"),"[]";const n=e.pages||[],i=e.currentPageIndex||0,t=n[i];if(!t||!t.widgets)return"[]";const s=[];t.widgets.forEach(m=>{if(m.hidden||m.type==="group")return;const f=this.generateWidget(m,{layout:e,page:t});f&&(Array.isArray(f)?f:[f]).forEach(b=>{s.push(b)})});const r=(e.orientation||"landscape")==="portrait"?90:0,d=e.protocolHardware||{},c=(d.colorMode==="bw"||d.colorMode==="grayscale",e.darkMode?"black":"white"),g={service:"open_epaper_link.drawcustom",target:{entity_id:(e.settings||{}).oeplEntityId||"open_epaper_link.0000000000000000"},data:{background:c,rotate:r,dither:2,ttl:60,payload:s}};return JSON.stringify(g,null,2)}generateWidget(e,n){const i=V?V.get(e.type):null;if(i&&typeof i.exportOEPL=="function")try{return i.exportOEPL(e,n)}catch(t){return _.error(`Error in exportOEPL for ${e.type}:`,t),null}else return this._warnedTypes||(this._warnedTypes=new Set),this._warnedTypes.has(e.type)||(_.warn(`Widget type "${e.type}" does not support OEPL export yet.`),this._warnedTypes.add(e.type)),null}}window.OEPLAdapter=wi;class vi extends xe{constructor(){super()}async generate(e){if(!e)return _.error("OpenDisplayAdapter: Missing layout"),"{}";const n=e.pages||[],i=e.currentPageIndex||0,t=n[i];if(!t||!t.widgets)return"{}";const s=[],o=e.protocolHardware||{},r=e.orientation==="portrait"?Math.min(o.width||800,o.height||480):Math.max(o.width||800,o.height||480),d=e.orientation==="portrait"?Math.max(o.width||800,o.height||480):Math.min(o.width||800,o.height||480),c=e.darkMode?"black":"white";return s.push({type:"draw_rect",x:0,y:0,w:r,h:d,fill:c}),t.widgets.forEach(h=>{if(h.hidden||h.type==="group")return;const g=this.generateWidget(h,{layout:e,page:t});g&&(Array.isArray(g)?g:[g]).forEach(f=>{s.push(f)})}),JSON.stringify({version:1,actions:s},null,2)}generateWidget(e,n){const i=V?V.get(e.type):null;if(i&&typeof i.exportOpenDisplay=="function")try{return i.exportOpenDisplay(e,n)}catch(t){return _.error(`Error in exportOpenDisplay for ${e.type}:`,t),null}else return this._warnedTypes||(this._warnedTypes=new Set),this._warnedTypes.has(e.type)||(_.warn(`Widget type "${e.type}" does not support OpenDisplay export yet.`),this._warnedTypes.add(e.type)),null}}window.OpenDisplayAdapter=vi;function Bs(a){const{name:e,chip:n,resWidth:i,resHeight:t,shape:s,psram:o,displayDriver:r,pins:d,touchTech:c}=a,l=[];if(l.push("# ============================================================================"),l.push(`# TARGET DEVICE: ${e}`),l.push(`# Name: ${e}`),l.push(`# Resolution: ${i}x${t}`),l.push(`# Shape: ${s}`),l.push("#"),l.push(`#         - Display Platform: ${r||"Unknown"}`),l.push(`#         - Touchscreen: ${c||"None"}`),l.push(`#         - PSRAM: ${o?"Yes":"No"}`),l.push("# ============================================================================"),l.push("#"),l.push("# SETUP INSTRUCTIONS:"),l.push("#"),l.push("# STEP 1: Copy the Material Design Icons font file"),l.push("#         - From this repo: font_ttf/font_ttf/materialdesignicons-webfont.ttf"),l.push("#         - To ESPHome: /config/esphome/fonts/materialdesignicons-webfont.ttf"),l.push("#         (Create the fonts folder if it doesn't exist)"),l.push("#"),l.push("# STEP 2: Create a new device in ESPHome"),l.push('#         - Click "New Device"'),l.push("#         - Name: your-device-name"),n==="ESP32 (Standard)"?(l.push("#         - Select: ESP32"),l.push("#         - Board: esp32dev (or specific board)"),l.push("#         - Framework: esp-idf (Recommended) or arduino")):(l.push("#         - Select: ESP32-S3"),l.push("#         - Board: esp32-s3-devkitc-1"),l.push("#         - Framework: esp-idf (Recommended) or arduino")),l.push("#"),l.push("# ============================================================================"),l.push(""),l.push("# Infrastructure (Comment out if pasting into existing config)"),l.push("# esphome: # (Auto-commented)"),l.push(`#   name: ${e.toLowerCase().replace(/[^a-z0-9]/g,"-")}`),l.push("#"),l.push("# esp32: # (Auto-commented)"),l.push(`#   board: ${Os(n)}`),l.push("#   framework:"),l.push("#     type: esp-idf"),o&&n.includes("s3")&&(l.push("#     # For stability on S3 devices with high-res displays/LVGL:"),l.push("#     advanced:"),l.push("#       execute_from_psram: true")),l.push(""),o&&(l.push("# psram: # (Auto-commented)"),n.includes("s3")&&(l.push("#   # Quad or Octal depending on your board"),l.push("#   mode: quad"),l.push("#   speed: 80MHz")),l.push("")),d.clk&&d.mosi&&(l.push("spi:"),l.push(`  clk_pin: ${d.clk}`),l.push(`  mosi_pin: ${d.mosi}`),d.miso&&l.push(`  miso_pin: ${d.miso}`),l.push("")),d.sda&&d.scl&&(l.push("i2c:"),l.push(`  sda: ${d.sda}`),l.push(`  scl: ${d.scl}`),l.push("  scan: true"),l.push("")),l.push("display:"),l.push(`  - platform: ${r}`),d.cs&&l.push(`    cs_pin: ${d.cs}`),d.dc&&l.push(`    dc_pin: ${d.dc}`),d.rst&&l.push(`    reset_pin: ${d.rst}`),d.busy&&l.push(`    busy_pin: ${d.busy}`),r==="st7789v"&&(l.push("    model: Custom"),l.push("    id: my_display"),l.push(`    width: ${i}`),l.push(`    height: ${t}`),l.push("    offset_height: 0"),l.push("    offset_width: 0")),l.push("    lambda: |-"),l.push("      # __LAMBDA_PLACEHOLDER__"),l.push(""),d.backlight){const h=a.backlightMinPower??.07,g=a.backlightInitial??.8,m=!!a.antiburn;l.push("output:"),l.push("  - platform: ledc"),l.push(`    pin: ${d.backlight}`),l.push("    id: backlight_brightness_output"),l.push(`    min_power: "${h}"`),l.push("    zero_means_zero: true"),l.push(""),l.push("light:"),l.push("  - platform: monochromatic"),l.push("    output: backlight_brightness_output"),l.push("    id: lcdbacklight_brightness"),l.push("    name: LCD Backlight"),l.push("    icon: mdi:wall-sconce-flat-outline"),l.push("    restore_mode: ALWAYS_ON"),l.push("    initial_state:"),l.push(`      brightness: "${g}"`),m&&(l.push("    on_turn_off:"),l.push("      - script.execute: start_antiburn"),l.push("    on_turn_on:"),l.push("      - script.execute: stop_antiburn")),l.push(""),m&&(l.push("script:"),l.push("  - id: start_antiburn"),l.push("    then:"),l.push("      - delay: 5min"),l.push("      - logger.log: Starting automatic antiburn."),l.push("      - switch.turn_on: switch_antiburn"),l.push("  - id: stop_antiburn"),l.push("    then:"),l.push("      - script.stop: start_antiburn"),l.push("      - switch.turn_off: switch_antiburn"),l.push(""),l.push("switch:"),l.push("  - platform: template"),l.push("    name: Antiburn"),l.push("    id: switch_antiburn"),l.push("    icon: mdi:television-shimmer"),l.push("    optimistic: true"),l.push("    entity_category: config"),l.push("    turn_on_action:"),l.push('      - logger.log: "Starting Antiburn"'),l.push("      - if:"),l.push("          condition: lvgl.is_paused"),l.push("          then:"),l.push("            - lvgl.resume:"),l.push("            - lvgl.widget.redraw:"),l.push("      - lvgl.pause:"),l.push("          show_snow: true"),l.push("    turn_off_action:"),l.push('      - logger.log: "Stopping Antiburn"'),l.push("      - if:"),l.push("          condition: lvgl.is_paused"),l.push("          then:"),l.push("            - lvgl.resume:"),l.push("            - lvgl.widget.redraw:"),l.push(""))}return c!=="none"&&(l.push("touchscreen:"),l.push(`  - platform: ${c}`),d.touch_int&&l.push(`    interrupt_pin: ${d.touch_int}`),d.touch_rst&&l.push(`    reset_pin: ${d.touch_rst}`),l.push("")),l.join(`
`)}function Os(a){switch(a){case"esp32-s3":return"esp32-s3-devkitc-1";case"esp32-c3":return"esp32-c3-devkitm-1";case"esp32-c6":return"esp32-c6-devkitc-1";case"esp32":return"esp32dev";default:return"esp32-s3-devkitc-1"}}class Rs{constructor(){_.log("[DeviceSettings] Constructor called - Instance ID check"),this.modal=document.getElementById("deviceSettingsModal"),this.closeBtn=document.getElementById("deviceSettingsClose"),this.saveBtn=document.getElementById("deviceSettingsSave"),this.nameInput=document.getElementById("deviceName"),this.modelInput=document.getElementById("deviceModel"),this.orientationInput=document.getElementById("deviceOrientation"),this.darkModeInput=document.getElementById("deviceDarkMode"),this.extendedLatinGlyphsInput=document.getElementById("deviceExtendedLatinGlyphs"),this.invertedColorsInput=document.getElementById("deviceInvertedColors"),this.modeStandard=document.getElementById("mode-standard"),this.modeSleep=document.getElementById("setting-sleep-enabled"),this.modeManual=document.getElementById("setting-manual-refresh"),this.modeDeepSleep=document.getElementById("setting-deep-sleep-enabled"),this.modeDaily=document.getElementById("setting-daily-refresh-enabled"),this.sleepStart=document.getElementById("setting-sleep-start"),this.sleepEnd=document.getElementById("setting-sleep-end"),this.sleepRow=document.getElementById("sleep-times-row"),this.dailyRefreshTime=document.getElementById("setting-daily-refresh-time"),this.dailyRefreshRow=document.getElementById("daily-refresh-row"),this.deepSleepInterval=document.getElementById("setting-deep-sleep-interval"),this.deepSleepRow=document.getElementById("deep-sleep-interval-row"),this.refreshIntervalInput=document.getElementById("setting-refresh-interval"),this.refreshIntervalRow=document.getElementById("global-refresh-row"),this.noRefreshStart=document.getElementById("setting-no-refresh-start"),this.noRefreshEnd=document.getElementById("setting-no-refresh-end"),this.autoCycleEnabled=document.getElementById("setting-auto-cycle"),this.autoCycleInterval=document.getElementById("setting-auto-cycle-interval"),this.autoCycleRow=document.getElementById("field-auto-cycle-interval"),this.customHardwareSection=document.getElementById("customHardwareSection"),this.customFieldsContainer=this.customHardwareSection,this.customChip=document.getElementById("customChip"),this.customTech=document.getElementById("customTech"),this.customRes=document.getElementById("customRes"),this.customShape=document.getElementById("customShape"),this.customPsram=document.getElementById("customPsram"),this.customDisplayDriver=document.getElementById("customDisplayDriver"),this.customTouchTech=document.getElementById("customTouchTech"),this.touchPinsGrid=document.getElementById("touchPinsGrid"),this.customProfileNameInput=document.getElementById("customProfileName"),this.strategyEpaperGroup=document.getElementById("strategy-epaper-group"),this.strategyLcdGroup=document.getElementById("strategy-lcd-group"),this.renderingModeInput=document.getElementById("renderingMode"),this.renderingModeField=document.getElementById("renderingModeField"),this.oeplSettingsSection=document.getElementById("oeplSettingsSection"),this.oeplEntityIdInput=document.getElementById("oeplEntityId"),this.oeplDitherInput=document.getElementById("oeplDither"),this.protocolHardwareSection=document.getElementById("protocolHardwareSection"),this.protocolResPreset=document.getElementById("protocolResPreset"),this.protocolWidth=document.getElementById("protocolWidth"),this.protocolHeight=document.getElementById("protocolHeight"),this.protocolColorMode=document.getElementById("protocolColorMode"),this.deviceModelField=document.getElementById("deviceModelField"),this.powerStrategySection=document.getElementById("powerStrategySection"),this.deviceExtendedLatinGlyphsField=document.getElementById("deviceExtendedLatinGlyphsField"),this.deviceInvertedColorsField=document.getElementById("deviceInvertedColorsField")}init(){this.closeBtn&&this.closeBtn.addEventListener("click",()=>this.close());const e=document.getElementById("reloadHardwareBtn");e&&e.addEventListener("click",async t=>{t.preventDefault(),await this.reloadHardwareProfiles()}),document.querySelectorAll(".clear-pin-btn").forEach(t=>{t.addEventListener("click",s=>{s.preventDefault();const o=t.getAttribute("data-target"),r=document.getElementById(o);r&&(r.value="",r.dispatchEvent(new Event("input",{bubbles:!0})))})});const n=document.getElementById("importHardwareBtn"),i=document.getElementById("hardwareFileInput");n&&i&&(n.addEventListener("click",t=>{t.preventDefault(),i.click()}),i.addEventListener("change",async t=>{if(t.target.files.length>0){const s=t.target.files[0];try{await It(s)}catch{}i.value=""}})),this.populateDeviceSelect(),this.saveBtn&&this.saveBtn.addEventListener("click",()=>this.close()),this.setupAutoSaveListeners(),this.setupCustomHardwareListeners(),this.setupProtocolHardwareListeners()}setupCustomHardwareListeners(){this.modelInput&&(this.modelInput.addEventListener("change",()=>{this.updateCustomSectionVisibility()}),this.customTech&&this.customTech.addEventListener("change",()=>{this.updateStrategyGroupVisibility()}),this.customChip&&this.customChip.addEventListener("change",()=>{this.updatePinDatalist()}),this.customTouchTech&&this.customTouchTech.addEventListener("change",()=>{this.touchPinsGrid&&(this.touchPinsGrid.style.display=this.customTouchTech.value==="none"?"none":"grid")}),this.customShape&&this.customShape.addEventListener("change",()=>{if(this.customShape.value==="round"&&this.customRes){const e=(this.customRes.value||"800x480").split("x"),n=parseInt(e[0])||480,i=parseInt(e[1])||480,t=Math.min(n,i);this.customRes.value=`${t}x${t}`,_.log(`[DeviceSettings] Auto-set square resolution for round display: ${t}x${t}`),this.customRes.dispatchEvent(new Event("change"))}}),document.body.addEventListener("click",async e=>{if(e.target&&e.target.id==="saveCustomProfileBtn"){if(e.preventDefault(),e.stopImmediatePropagation(),this._isSavingProfile)return;this._isSavingProfile=!0,_.log("[DeviceSettings] saveCustomProfileBtn clicked (Delegate+Debounce)");try{typeof this.handleSaveCustomProfile=="function"?await this.handleSaveCustomProfile():(_.error("[DeviceSettings] handleSaveCustomProfile missing"),alert("Error: Save function missing on DeviceSettings instance"))}catch(n){console.error(n),alert("Error saving profile: "+n.message)}finally{setTimeout(()=>{this._isSavingProfile=!1},1e3)}}}),this.setupCustomHardwareAutoSave())}setupProtocolHardwareListeners(){const e=()=>{const n=parseInt(this.protocolWidth.value)||400,i=parseInt(this.protocolHeight.value)||300,t=this.protocolColorMode.value||"bw";u.updateProtocolHardware({width:n,height:i,colorMode:t})};this.protocolResPreset&&this.protocolResPreset.addEventListener("change",()=>{const n=this.protocolResPreset.value;if(n!=="custom"){const[i,t]=n.split("x").map(Number);this.protocolWidth.value=i,this.protocolHeight.value=t,e()}}),this.protocolWidth&&this.protocolWidth.addEventListener("input",e),this.protocolHeight&&this.protocolHeight.addEventListener("input",e),this.protocolColorMode&&this.protocolColorMode.addEventListener("change",e)}setupCustomHardwareAutoSave(){const e=[this.customChip,this.customTech,this.customRes,this.customShape,this.customPsram,this.customDisplayDriver,this.customTouchTech,"pin_cs","pin_dc","pin_rst","pin_busy","pin_clk","pin_mosi","pin_backlight","pin_sda","pin_scl","pin_touch_int","pin_touch_rst"],n=()=>{if(this.modelInput.value==="custom"){const i=this.getCustomHardwareConfig();u.setCustomHardware(i)}};e.forEach(i=>{const t=typeof i=="string"?document.getElementById(i):i;if(!t)return;const s=t.type==="checkbox"||t.tagName==="SELECT"?"change":"input";t.addEventListener(s,n)})}getCustomHardwareConfig(){const e=(this.customRes?.value||"800x480").split("x"),n=i=>{const t=document.getElementById(i);return t?t.value:""};return{chip:this.customChip?.value||"esp32-s3",tech:this.customTech?.value||"lcd",resWidth:parseInt(e[0])||800,resHeight:parseInt(e[1])||480,shape:this.customShape?.value||"rect",psram:this.customPsram?.checked??!0,displayDriver:this.customDisplayDriver?.value||"st7789v",touchTech:this.customTouchTech?.value||"none",backlightMinPower:parseFloat(n("customBacklightMinPower"))||.07,backlightInitial:parseFloat(n("customBacklightInitial"))||.8,antiburn:!!document.getElementById("customAntiburn")?.checked,pins:{cs:n("pin_cs"),dc:n("pin_dc"),rst:n("pin_rst"),busy:n("pin_busy"),clk:n("pin_clk"),mosi:n("pin_mosi"),backlight:n("pin_backlight"),sda:n("pin_sda"),scl:n("pin_scl"),touch_int:n("pin_touch_int"),touch_rst:n("pin_touch_rst")}}}updateCustomSectionVisibility(){this.customHardwareSection&&(this.customHardwareSection.style.display=this.modelInput.value==="custom"?"block":"none")}updatePinDatalist(){const n=(this.customChip?.value||"esp32-s3")==="esp32"?"gpio-pins-esp32":"gpio-pins-esp32s3";["pin_cs","pin_dc","pin_rst","pin_busy","pin_clk","pin_mosi","pin_backlight","pin_sda","pin_scl","pin_touch_int","pin_touch_rst"].forEach(t=>{const s=document.getElementById(t);s&&s.setAttribute("list",n)}),_.log(`[DeviceSettings] Updated pin datalists to: ${n}`)}async handleSaveCustomProfile(){_.log("[DeviceSettings] handleSaveCustomProfile called");try{const e=this.customProfileNameInput?this.customProfileNameInput.value.trim():"";if(!e){z("Please enter a name for your custom profile first.","warning"),this.customProfileNameInput&&this.customProfileNameInput.focus();return}const n=(this.customRes?.value||"800x480").split("x"),i=h=>{const g=document.getElementById(h);return g?g.value:""},t={name:e,chip:this.customChip?.value||"esp32-s3",tech:this.customTech?.value||"lcd",resWidth:parseInt(n[0])||800,resHeight:parseInt(n[1])||480,shape:this.customShape?.value||"rect",psram:this.customPsram?.checked??!0,displayDriver:this.customDisplayDriver?.value||"st7789v",touchTech:this.customTouchTech?.value||"none",pins:{cs:i("pin_cs"),dc:i("pin_dc"),rst:i("pin_rst"),busy:i("pin_busy"),clk:i("pin_clk"),mosi:i("pin_mosi"),backlight:i("pin_backlight"),sda:i("pin_sda"),scl:i("pin_scl"),touch_int:i("pin_touch_int"),touch_rst:i("pin_touch_rst")}},s=Bs(t),o=new Blob([s],{type:"text/yaml"}),r=`${e.toLowerCase().replace(/\s+/g,"_")}.yaml`,d=new File([o],r);z("Generating hardware recipe...","info"),await It(d);let c=0;const l=()=>{const g=Object.values(window.DEVICE_PROFILES||F||{}).find(m=>m.name===e||m.name===e+" (Local)"||m.name&&m.name.includes(e));if(g){const m=Object.keys(window.DEVICE_PROFILES||F||{}).find(f=>(window.DEVICE_PROFILES||F)[f]===g);m&&(this.modelInput.value=m,this.modelInput.dispatchEvent(new Event("change")),z(`Profile "${e}" created and loaded!`,"success"))}else c<10?(c++,_.log(`[DeviceSettings] New profile not found yet (attempt ${c}), retrying...`),setTimeout(l,500)):(_.error("[DeviceSettings] Failed to find the newly created profile in the list."),z("Profile created, but could not be auto-selected. Please find it in the list.","warning"))};setTimeout(l,1e3)}catch(e){_.error("Failed to save custom profile:",e),z("Failed to create profile: "+e.message,"error")}}async reloadHardwareProfiles(){const e=document.getElementById("reloadHardwareBtn"),n=e?e.textContent:"";try{e&&(e.disabled=!0,e.textContent=" Loading..."),z("Reloading hardware profiles...","info"),_.log("[DeviceSettings] Force reloading hardware profiles..."),await Be(),this.populateDeviceSelect(),z("Hardware profiles reloaded successfully!","success"),_.log("[DeviceSettings] Hardware profiles reloaded, dropdown refreshed")}catch(i){_.error("[DeviceSettings] Failed to reload hardware profiles:",i),z("Failed to reload profiles: "+i.message,"error")}finally{e&&(e.disabled=!1,e.textContent=n)}}open(){if(_.log("DeviceSettings.open() called"),!this.modal){_.error("DeviceSettings modal element not found!");return}_.log("Opening Device Settings modal..."),this.nameInput&&(this.nameInput.value=u.settings.device_name||"My E-Ink Display"),this.modelInput&&(this.modelInput.value=u.settings.device_model||"reterminal_e1001"),this.renderingModeInput&&(this.renderingModeInput.value=u.settings.renderingMode||"direct"),this.orientationInput&&(this.orientationInput.value=u.settings.orientation||"landscape"),this.darkModeInput&&(this.darkModeInput.checked=!!u.settings.darkMode),this.extendedLatinGlyphsInput&&(this.extendedLatinGlyphsInput.checked=!!u.settings.extendedLatinGlyphs),this.invertedColorsInput&&(this.invertedColorsInput.checked=!!u.settings.invertedColors);const e=u.settings,n=!!e.sleepEnabled,i=!!e.manualRefreshOnly,t=!!e.deepSleepEnabled,s=!!e.dailyRefreshEnabled,o=!n&&!i&&!t&&!s;this.modeStandard&&(this.modeStandard.checked=o),this.modeSleep&&(this.modeSleep.checked=n),this.modeManual&&(this.modeManual.checked=i),this.modeDeepSleep&&(this.modeDeepSleep.checked=t),this.modeDaily&&(this.modeDaily.checked=s),this.sleepStart&&(this.sleepStart.value=e.sleepStartHour??0),this.sleepEnd&&(this.sleepEnd.value=e.sleepEndHour??5),this.dailyRefreshTime&&(this.dailyRefreshTime.value=e.dailyRefreshTime||"08:00"),this.deepSleepInterval&&(this.deepSleepInterval.value=e.deepSleepInterval??600),this.refreshIntervalInput&&(this.refreshIntervalInput.value=e.refreshInterval??600),this.noRefreshStart&&(this.noRefreshStart.value=e.noRefreshStartHour??""),this.noRefreshEnd&&(this.noRefreshEnd.value=e.noRefreshEndHour??""),this.autoCycleEnabled&&(this.autoCycleEnabled.checked=!!e.autoCycleEnabled),this.autoCycleInterval&&(this.autoCycleInterval.value=e.autoCycleIntervalS??30),this.oeplEntityIdInput&&(this.oeplEntityIdInput.value=e.oeplEntityId||""),this.oeplDitherInput&&(this.oeplDitherInput.value=e.oeplDither??2),this.updateVisibility(),this.updateStrategyGroupVisibility(),this.populateCustomFields(),this.populateProtocolFields(),this.updateCustomSectionVisibility(),this.modal.classList.remove("hidden"),this.modal.style.display="flex",_.log("Device Settings modal should be visible now.")}close(){this.modal&&(this.modal.classList.add("hidden"),this.modal.style.display="none")}populateCustomFields(){const e=u.project&&u.project.state&&u.project.state.customHardware||{};if(!e||Object.keys(e).length===0)return;this.customChip&&(this.customChip.value=e.chip||"esp32-s3"),this.customTech&&(this.customTech.value=e.tech||"lcd"),this.customRes&&(this.customRes.value=`${e.resWidth||800}x${e.resHeight||480}`),this.customShape&&(this.customShape.value=e.shape||"rect"),this.customPsram&&(this.customPsram.checked=!!e.psram),this.customDisplayDriver&&(this.customDisplayDriver.value=e.displayDriver||"generic_st7789"),this.customTouchTech&&(this.customTouchTech.value=e.touchTech||"none",this.touchPinsGrid&&(this.touchPinsGrid.style.display=e.touchTech&&e.touchTech!=="none"?"grid":"none"));const n=e.pins||{},i=(t,s)=>{const o=document.getElementById(t);o&&(o.value=s||"")};i("pin_cs",n.cs),i("pin_dc",n.dc),i("pin_rst",n.rst),i("pin_busy",n.busy),i("pin_clk",n.clk),i("pin_mosi",n.mosi),i("pin_backlight",n.backlight),i("pin_sda",n.sda),i("pin_scl",n.scl),i("pin_touch_int",n.touch_int),i("pin_touch_rst",n.touch_rst)}populateProtocolFields(){const e=u.project&&u.project.protocolHardware||{width:400,height:300,colorMode:"bw"};if(this.protocolWidth&&(this.protocolWidth.value=e.width),this.protocolHeight&&(this.protocolHeight.value=e.height),this.protocolColorMode&&(this.protocolColorMode.value=e.colorMode),this.protocolResPreset){const n=`${e.width}x${e.height}`;Array.from(this.protocolResPreset.options).map(t=>t.value).includes(n)?this.protocolResPreset.value=n:this.protocolResPreset.value="custom"}}populateDeviceSelect(){if(this.modelInput&&F){const e=this.modelInput.value;_.log("[DeviceSettings] Populating dropdown with",Object.keys(F).length,"profiles"),this.modelInput.innerHTML="";const n=De||[];Object.entries(F).forEach(([t,s])=>{_.log(`  - Adding: ${t} (${s.name})`);const o=document.createElement("option");o.value=t;let r=s.name;n.includes(t)||(r+=" (untested)"),o.textContent=r,this.modelInput.appendChild(o)});const i=document.createElement("option");i.value="custom",i.textContent="Custom Profile...",i.style.fontWeight="bold",i.style.color="var(--accent)",this.modelInput.appendChild(i),e&&(F[e]||e==="custom")?this.modelInput.value=e:this.modelInput.value||(this.modelInput.value="reterminal_e1001"),this.updateCustomSectionVisibility()}}updateVisibility(){const e=this.modeSleep&&this.modeSleep.checked,n=this.modeDaily&&this.modeDaily.checked,i=this.modeDeepSleep&&this.modeDeepSleep.checked,t=this.modeManual&&this.modeManual.checked;this.sleepRow&&(this.sleepRow.style.display=e?"flex":"none"),this.dailyRefreshRow&&(this.dailyRefreshRow.style.display=n?"flex":"none"),this.deepSleepRow&&(this.deepSleepRow.style.display=i?"block":"none");const s=!n&&!t;this.refreshIntervalRow&&(this.refreshIntervalRow.style.display=s?"block":"none"),this.autoCycleRow&&(this.autoCycleRow.style.display=this.autoCycleEnabled&&this.autoCycleEnabled.checked?"flex":"none");const o=this.renderingModeInput?this.renderingModeInput.value:u.settings.renderingMode||"direct",r=o==="oepl"||o==="opendisplay",d=o==="lvgl"||o==="direct";if(this.protocolHardwareSection&&(this.protocolHardwareSection.style.display=r?"block":"none"),this.deviceModelField&&(this.deviceModelField.style.display=r?"none":"block"),this.customHardwareSection&&r&&(this.customHardwareSection.style.display="none"),this.powerStrategySection&&(this.powerStrategySection.style.display=d?"block":"none"),this.deviceExtendedLatinGlyphsField&&(this.deviceExtendedLatinGlyphsField.style.display=d?"block":"none"),this.deviceInvertedColorsField){const c=this.modelInput?this.modelInput.value:null,l=window.DEVICE_PROFILES||F||{},h=c?l[c]:null,g=!!(h&&h.features&&h.features.epaper);this.deviceInvertedColorsField.style.display=d&&g?"block":"none"}}persistToBackend(){this.saveDebounceTimer&&clearTimeout(this.saveDebounceTimer),this.saveDebounceTimer=setTimeout(async()=>{if(q()&&typeof saveLayoutToBackend=="function")try{await saveLayoutToBackend(),_.log("[DeviceSettings] All settings persisted to backend")}catch(e){_.warn("[DeviceSettings] Failed to auto-save settings:",e)}else try{const e=u.getPagesPayload();e.deviceName=u.deviceName,e.deviceModel=u.deviceModel,localStorage.setItem("esphome-designer-layout",JSON.stringify(e)),_.log("[DeviceSettings] Settings persisted to localStorage (offline mode)")}catch(e){_.warn("[DeviceSettings] Failed to save to localStorage:",e)}},1e3)}setupAutoSaveListeners(){const e=(s,o)=>{u.updateSettings({[s]:o}),_.log(`Auto-saved ${s}:`,o),this.persistToBackend()};let n=null;this.nameInput&&this.nameInput.addEventListener("input",()=>{const s=this.nameInput.value.trim();u.setDeviceName(s),O(P.STATE_CHANGED),n&&clearTimeout(n),n=setTimeout(async()=>{if(typeof saveLayoutToBackend=="function")try{await saveLayoutToBackend(),_.log("[DeviceSettings] Device name saved to backend")}catch(o){_.warn("[DeviceSettings] Failed to save device name:",o)}},500)}),this.modelInput&&this.modelInput.addEventListener("change",async()=>{const s=this.modelInput.value;window.currentDeviceModel=s,u.setDeviceModel(s),e("device_model",s),this.updateStrategyGroupVisibility(),_.log("Device model changed to:",s)}),this.orientationInput&&this.orientationInput.addEventListener("change",()=>{e("orientation",this.orientationInput.value)}),this.darkModeInput&&this.darkModeInput.addEventListener("change",()=>{e("darkMode",this.darkModeInput.checked)}),this.extendedLatinGlyphsInput&&this.extendedLatinGlyphsInput.addEventListener("change",()=>{e("extendedLatinGlyphs",this.extendedLatinGlyphsInput.checked)}),this.invertedColorsInput&&this.invertedColorsInput.addEventListener("change",()=>{e("invertedColors",this.invertedColorsInput.checked)}),this.renderingModeInput&&this.renderingModeInput.addEventListener("change",()=>{e("renderingMode",this.renderingModeInput.value),this.updateVisibility(),this.updateStrategyGroupVisibility(),_.log("Rendering mode changed to:",this.renderingModeInput.value)}),this.oeplEntityIdInput&&this.oeplEntityIdInput.addEventListener("input",()=>{e("oeplEntityId",this.oeplEntityIdInput.value.trim())}),this.oeplDitherInput&&this.oeplDitherInput.addEventListener("change",()=>{e("oeplDither",parseInt(this.oeplDitherInput.value))}),[this.modeStandard,this.modeSleep,this.modeManual,this.modeDeepSleep,this.modeDaily].forEach(s=>{s&&s.addEventListener("change",()=>{s.checked&&(e("sleepEnabled",!!(this.modeSleep&&this.modeSleep.checked)),e("manualRefreshOnly",!!(this.modeManual&&this.modeManual.checked)),e("deepSleepEnabled",!!(this.modeDeepSleep&&this.modeDeepSleep.checked)),e("dailyRefreshEnabled",!!(this.modeDaily&&this.modeDaily.checked)),this.updateVisibility())})}),this.sleepStart&&this.sleepStart.addEventListener("change",()=>{e("sleepStartHour",parseInt(this.sleepStart.value)||0)}),this.sleepEnd&&this.sleepEnd.addEventListener("change",()=>{e("sleepEndHour",parseInt(this.sleepEnd.value)||0)}),this.dailyRefreshTime&&this.dailyRefreshTime.addEventListener("change",()=>{e("dailyRefreshTime",this.dailyRefreshTime.value)}),this.deepSleepInterval&&this.deepSleepInterval.addEventListener("input",()=>{const s=parseInt(this.deepSleepInterval.value)||600;e("deepSleepInterval",s),this.refreshIntervalInput&&(this.refreshIntervalInput.value=s,u.updateSettings({refreshInterval:s}))}),this.refreshIntervalInput&&this.refreshIntervalInput.addEventListener("input",()=>{const s=parseInt(this.refreshIntervalInput.value)||600;e("refreshInterval",s),this.deepSleepInterval&&this.modeDeepSleep&&this.modeDeepSleep.checked&&(this.deepSleepInterval.value=s,u.updateSettings({deepSleepInterval:s}))}),this.noRefreshStart&&this.noRefreshStart.addEventListener("change",()=>{const s=this.noRefreshStart.value===""?null:parseInt(this.noRefreshStart.value);e("noRefreshStartHour",s)}),this.noRefreshEnd&&this.noRefreshEnd.addEventListener("change",()=>{const s=this.noRefreshEnd.value===""?null:parseInt(this.noRefreshEnd.value);e("noRefreshEndHour",s)}),this.autoCycleEnabled&&this.autoCycleEnabled.addEventListener("change",()=>{e("autoCycleEnabled",this.autoCycleEnabled.checked),this.updateVisibility()}),this.autoCycleInterval&&this.autoCycleInterval.addEventListener("input",()=>{const s=Math.max(5,parseInt(this.autoCycleInterval.value)||30);e("autoCycleIntervalS",s)}),document.querySelectorAll('input[name="lcdEcoStrategy"]').forEach(s=>{s.addEventListener("change",()=>{s.checked&&(e("lcdEcoStrategy",s.value),this.sleepRow&&(this.sleepRow.style.display=s.value==="backlight_off"?"flex":"none"))})})}updateStrategyGroupVisibility(){const e=this.modelInput?this.modelInput.value:"reterminal_e1001";let n=!1;if(e==="custom")n=(u.project&&u.project.state&&u.project.state.customHardware||{}).tech==="lcd";else{const t=(window.DEVICE_PROFILES||F||{})[e];n=!!(t&&t.features&&(t.features.lcd||t.features.oled)),t&&t.features&&(t.features.lvgl||t.features.lv_display)}if(this.strategyEpaperGroup&&(this.strategyEpaperGroup.style.display=n?"none":"flex"),this.strategyLcdGroup&&(this.strategyLcdGroup.style.display=n?"flex":"none",n)){const i=u.settings.lcdEcoStrategy||"backlight_off",t=document.querySelector(`input[name="lcdEcoStrategy"][value="${i}"]`);t&&(t.checked=!0)}if(this.renderingModeField&&(this.renderingModeField.style.display="block",this.renderingModeInput&&(this.renderingModeInput.value=u.settings.renderingMode||"direct")),this.oeplSettingsSection){const i=this.renderingModeInput&&this.renderingModeInput.value==="oepl"||u.settings.renderingMode==="oepl";this.oeplSettingsSection.style.display=i?"block":"none"}}openSaveProfileModal(){return new Promise(e=>{if(!this.saveProfileModal){_.error("Save Profile Modal not found in DOM"),e(null);return}this.saveProfileResolve=e,this.saveProfileNameInput.value="My Custom Device",this.saveProfileModal.classList.remove("hidden"),this.saveProfileModal.style.display="flex",this.saveProfileNameInput.focus(),this.saveProfileNameInput.select();const n=()=>{this.saveProfileModal.classList.add("hidden"),this.saveProfileModal.style.display="none",this.saveProfileResolve&&(this.saveProfileResolve(null),this.saveProfileResolve=null),s()},i=()=>{const o=this.saveProfileNameInput.value.trim();if(!o){z("Please enter a profile name","warning"),this.saveProfileNameInput.focus();return}this.saveProfileModal.classList.add("hidden"),this.saveProfileModal.style.display="none",this.saveProfileResolve&&(this.saveProfileResolve(o),this.saveProfileResolve=null),s()},t=o=>{o.key==="Enter"&&i(),o.key==="Escape"&&n()},s=()=>{this.saveProfileCloseBtn.removeEventListener("click",n),this.saveProfileConfirmBtn.removeEventListener("click",i),this.saveProfileNameInput.removeEventListener("keyup",t)};this.saveProfileCloseBtn.addEventListener("click",n),this.saveProfileConfirmBtn.addEventListener("click",i),this.saveProfileNameInput.addEventListener("keyup",t)})}}class Ws{constructor(){this.modal=document.getElementById("editorSettingsModal"),this.closeBtn=document.getElementById("editorSettingsClose"),this.doneBtn=document.getElementById("editorSettingsDone"),this.snapToGrid=document.getElementById("editorSnapToGrid"),this.showGrid=document.getElementById("editorShowGrid"),this.lightMode=document.getElementById("editorLightMode"),this.refreshEntitiesBtn=document.getElementById("editorRefreshEntities"),this.entityCountLabel=document.getElementById("editorEntityCount"),this.gridOpacity=document.getElementById("editorGridOpacity"),this.haManualUrl=document.getElementById("haManualUrl"),this.haLlatToken=document.getElementById("haLlatToken"),this.testHaBtn=document.getElementById("editorTestHaBtn"),this.haTestResult=document.getElementById("haTestResult"),this.aiProvider=document.getElementById("aiProvider"),this.aiApiKeyGemini=document.getElementById("aiApiKeyGemini"),this.aiApiKeyOpenai=document.getElementById("aiApiKeyOpenai"),this.aiApiKeyOpenrouter=document.getElementById("aiApiKeyOpenrouter"),this.aiModelFilter=document.getElementById("aiModelFilter"),this.aiModelSelect=document.getElementById("aiModelSelect"),this.aiRefreshModelsBtn=document.getElementById("aiRefreshModelsBtn"),this.aiTestResult=document.getElementById("aiTestResult"),this.aiKeyRows={gemini:document.getElementById("aiKeyGeminiRow"),openai:document.getElementById("aiKeyOpenaiRow"),openrouter:document.getElementById("aiKeyOpenrouterRow")}}init(){this.modal&&(this.closeBtn&&this.closeBtn.addEventListener("click",()=>this.close()),this.doneBtn&&this.doneBtn.addEventListener("click",()=>this.close()),this.setupListeners())}open(){if(!this.modal)return;const e=u.settings;this.snapToGrid&&(this.snapToGrid.checked=u.snapEnabled!==!1),this.showGrid&&(this.showGrid.checked=u.showGrid!==!1),this.lightMode&&(this.lightMode.checked=!!e.editor_light_mode),this.aiProvider&&(this.aiProvider.value=e.ai_provider||"gemini"),this.aiApiKeyGemini&&(this.aiApiKeyGemini.value=e.ai_api_key_gemini||""),this.aiApiKeyOpenai&&(this.aiApiKeyOpenai.value=e.ai_api_key_openai||""),this.aiApiKeyOpenrouter&&(this.aiApiKeyOpenrouter.value=e.ai_api_key_openrouter||""),this.aiModelFilter&&(this.aiModelFilter.value=e.ai_model_filter||""),this.updateAIKeyVisibility(),this.refreshModelSelect(),this.gridOpacity&&(this.gridOpacity.value=e.grid_opacity!==void 0?e.grid_opacity:20);const n=e.glyphsets||["GF_Latin_Kernel"];document.querySelectorAll(".glyphset-checkbox").forEach(t=>{t.checked=n.includes(t.value)}),this.haManualUrl&&(this.haManualUrl.value=at()||""),this.haLlatToken&&(this.haLlatToken.value=Re()||""),this.haTestResult&&(this.haTestResult.textContent=""),this.aiTestResult&&(this.aiTestResult.textContent="");const i=document.getElementById("haOriginPlaceholder");i&&(i.textContent=window.location.origin),this.updateEntityCount(),this.modal.classList.remove("hidden"),this.modal.style.display="flex"}close(){this.modal&&(this.modal.classList.add("hidden"),this.modal.style.display="none")}updateEntityCount(){if(this.entityCountLabel&&window.entityStatesCache){const e=Object.keys(window.entityStatesCache).length;this.entityCountLabel.textContent=`${e} entities cached`}}setupListeners(){this.snapToGrid&&this.snapToGrid.addEventListener("change",()=>{u.setSnapEnabled(this.snapToGrid.checked)}),this.showGrid&&this.showGrid.addEventListener("change",()=>{u.setShowGrid(this.showGrid.checked);const i=document.querySelector(".canvas-grid");i&&(i.style.display=this.showGrid.checked?"block":"none")}),this.lightMode&&this.lightMode.addEventListener("change",()=>{const i=this.lightMode.checked;u.updateSettings({editor_light_mode:i}),this.applyEditorTheme(i),O(P.STATE_CHANGED)}),this.gridOpacity&&this.gridOpacity.addEventListener("input",()=>{const i=parseInt(this.gridOpacity.value,10);u.updateSettings({grid_opacity:i})}),this.refreshEntitiesBtn&&this.refreshEntitiesBtn.addEventListener("click",async()=>{this.refreshEntitiesBtn.disabled=!0,this.refreshEntitiesBtn.textContent="Refreshing...",ge?await ge():window.fetchEntityStates&&await window.fetchEntityStates(),this.updateEntityCount(),this.refreshEntitiesBtn.disabled=!1,this.refreshEntitiesBtn.textContent=" Refresh Entity List"}),this.haManualUrl&&this.haManualUrl.addEventListener("change",()=>{Qt(this.haManualUrl.value.trim()),Ve()}),this.haLlatToken&&this.haLlatToken.addEventListener("change",()=>{Zt(this.haLlatToken.value.trim())}),this.testHaBtn&&this.testHaBtn.addEventListener("click",async()=>{this.testHaBtn.disabled=!0,this.haTestResult.textContent="Testing...",this.haTestResult.style.color="var(--muted)";try{Ve();const i=await ge();i&&i.length>0?(this.haTestResult.textContent=" Success!",this.haTestResult.style.color="var(--success)",this.updateEntityCount()):(this.haTestResult.innerHTML=" Failed.<br>Did you add <strong>cors_allowed_origins</strong> to HA and <strong>restart</strong> it?",this.haTestResult.style.color="var(--danger)")}catch{this.haTestResult.innerHTML=" Connection Error.<br>Check browser console.",this.haTestResult.style.color="var(--danger)"}finally{this.testHaBtn.disabled=!1}}),this.aiProvider&&this.aiProvider.addEventListener("change",()=>{u.updateSettings({ai_provider:this.aiProvider.value}),this.updateAIKeyVisibility(),this.refreshModelSelect()});const e=(i,t)=>{const s=document.getElementById(i);s&&s.addEventListener("input",()=>u.updateSettings({[t]:s.value.trim()}))};e("aiApiKeyGemini","ai_api_key_gemini"),e("aiApiKeyOpenai","ai_api_key_openai"),e("aiApiKeyOpenrouter","ai_api_key_openrouter"),this.aiModelFilter&&this.aiModelFilter.addEventListener("input",()=>{u.updateSettings({ai_model_filter:this.aiModelFilter.value}),this.filterModels()}),this.aiModelSelect&&this.aiModelSelect.addEventListener("change",()=>{const i=u.settings.ai_provider;u.updateSettings({[`ai_model_${i}`]:this.aiModelSelect.value})}),this.aiRefreshModelsBtn&&this.aiRefreshModelsBtn.addEventListener("click",async()=>{const i=u.settings.ai_provider||"gemini";let t=u.settings[`ai_api_key_${i}`];const s=`aiApiKey${i.charAt(0).toUpperCase()+i.slice(1)}`,o=document.getElementById(s);if(o&&(t=o.value.trim(),u.updateSettings({[`ai_api_key_${i}`]:t})),!t){z("Please enter an API key first",3e3,"error");return}this.aiRefreshModelsBtn.disabled=!0,this.aiRefreshModelsBtn.textContent="...",this.aiTestResult&&(this.aiTestResult.textContent="Testing...",this.aiTestResult.style.color="var(--muted)");try{const r=await window.aiService.fetchModels(i,t);window.aiService.cache.models[i]=r,this.refreshModelSelect(),this.aiTestResult&&(this.aiTestResult.textContent=` Success! Found ${r.length} models.`,this.aiTestResult.style.color="var(--success)")}catch{this.aiTestResult&&(this.aiTestResult.textContent=" Failed. Check key/console.",this.aiTestResult.style.color="var(--danger)")}finally{this.aiRefreshModelsBtn.disabled=!1,this.aiRefreshModelsBtn.textContent="Test & Load Models"}}),document.querySelectorAll(".glyphset-checkbox").forEach(i=>{i.addEventListener("change",()=>{const t=Array.from(document.querySelectorAll(".glyphset-checkbox:checked")).map(s=>s.value);u.updateSettings({glyphsets:t})})}),this.modal.querySelectorAll(".settings-category-header").forEach(i=>{i.addEventListener("click",()=>{const t=i.closest(".settings-category");t.classList.contains("expanded")?t.classList.remove("expanded"):t.classList.add("expanded")})})}updateAIKeyVisibility(){const e=u.settings.ai_provider||"gemini";Object.keys(this.aiKeyRows).forEach(n=>{this.aiKeyRows[n]&&(this.aiKeyRows[n].style.display=n===e?"block":"none")})}async refreshModelSelect(){if(!this.aiModelSelect)return;const e=u.settings.ai_provider||"gemini";if(!window.aiService||!window.aiService.cache)return;let n=window.aiService.cache.models[e];n||(n=[],window.aiService.cache.models[e]=n),this.filterModels()}filterModels(){if(!this.aiModelSelect)return;const e=u.settings.ai_provider||"gemini",n=(u.settings.ai_model_filter||"").toLowerCase();if(!window.aiService||!window.aiService.cache)return;const t=(window.aiService.cache.models[e]||[]).filter(o=>o.name.toLowerCase().includes(n)||o.id.toLowerCase().includes(n));this.aiModelSelect.innerHTML="",t.forEach(o=>{const r=document.createElement("option");r.value=o.id,r.textContent=o.name,this.aiModelSelect.appendChild(r)});const s=u.settings[`ai_model_${e}`];s&&(this.aiModelSelect.value=s)}applyEditorTheme(e){e?document.documentElement.setAttribute("data-theme","light"):document.documentElement.removeAttribute("data-theme");try{localStorage.setItem("reterminal-editor-theme",e?"light":"dark")}catch(n){_.log("Could not save theme preference:",n)}}}class Ns{constructor(){this.modal=document.getElementById("aiPromptModal"),this.closeBtn=document.getElementById("aiPromptClose"),this.submitBtn=document.getElementById("aiPromptSubmit"),this.applyBtn=document.getElementById("aiPromptApply"),this.input=document.getElementById("aiPromptInput"),this.status=document.getElementById("aiPromptStatus"),this.diffPanel=document.getElementById("aiPreviewDiff"),this.diffContent=document.getElementById("aiDiffContent"),this.generatedWidgets=null}init(){this.modal&&(this.closeBtn.onclick=()=>this.close(),this.submitBtn.onclick=()=>this.handleSubmit(),this.applyBtn.onclick=()=>this.handleApply(),window.addEventListener("click",e=>{e.target===this.modal&&this.close()}))}open(){if(!this.modal)return;this.modal.classList.remove("hidden"),this.modal.style.display="flex",this.input.focus();const e=window.AppState.settings.ai_provider||"gemini",n=window.AppState.settings[`ai_api_key_${e}`],i=document.getElementById("aiConfigWarning");i&&(i.style.display=n?"none":"block"),this.status.textContent="",this.status.style.color="",this.diffPanel.style.display="none",this.applyBtn.style.display="none",this.generatedWidgets=null}close(){this.modal&&(this.modal.classList.add("hidden"),this.modal.style.display="none")}async handleSubmit(){const e=this.input.value.trim();if(e){this.setLoading(!0),this.status.textContent="AI is thinking...",this.status.style.color="var(--accent)",this.diffPanel.style.display="none",this.applyBtn.style.display="none";try{const n=window.AppState.getCurrentPage(),i=u.deviceModel,t=F?.[i];let s="monochrome";t&&(t.features?.lcd?s="color_lcd":t.name?.includes("6-Color")||t.name?.includes("Color")?s="color_epaper":s="monochrome");const o={canvas:window.AppState.getCanvasDimensions(),current_page:n.id,widgets:n.widgets,selected_widget_id:window.AppState.selectedWidgetId,display_type:s},r=await window.aiService.processPrompt(e,o);if(r&&Array.isArray(r))this.generatedWidgets=r,this.showDiffPreview(n.widgets,r),this.status.textContent="Successfully generated changes!",this.status.style.color="var(--success)",this.applyBtn.style.display="inline-block";else throw new Error("Invalid response format from AI")}catch(n){_.error(n),this.status.textContent="Error: "+n.message,this.status.style.color="var(--danger)"}finally{this.setLoading(!1)}}}handleApply(){if(this.generatedWidgets)try{const e=window.AppState.getCurrentPage();e.widgets=this.generatedWidgets,window.AppState.project.rebuildWidgetsIndex(),O(P.STATE_CHANGED),z("AI changes applied!","success"),this.close()}catch(e){_.error(e),z("Failed to apply changes: "+e.message,"error")}}showDiffPreview(e,n){this.diffPanel.style.display="block";let i=`Widgets: ${e.length}  ${n.length}

`;const t=e.map(c=>c.id),s=n.map(c=>c.id),o=n.filter(c=>!t.includes(c.id)),r=e.filter(c=>!s.includes(c.id)),d=n.filter(c=>{const l=e.find(h=>h.id===c.id);return l&&JSON.stringify(l)!==JSON.stringify(c)});o.length>0&&(i+=`[ADDED]
${o.map(c=>`+ ${c.type} (${c.id})`).join(`
`)}

`),r.length>0&&(i+=`[REMOVED]
${r.map(c=>`- ${c.type} (${c.id})`).join(`
`)}

`),d.length>0&&(i+=`[MODIFIED]
${d.map(c=>`~ ${c.type} (${c.id})`).join(`
`)}`),o.length===0&&r.length===0&&d.length===0&&(i+="(No changes detected)"),this.diffContent.textContent=i}setLoading(e){this.submitBtn.disabled=e,this.submitBtn.textContent=e?"Processing...":"Generate",this.input.disabled=e}}window.llmPrompt=new Ns;class Hs{constructor(){this.modal=document.getElementById("pageSettingsModal"),this.closeBtn=document.getElementById("pageSettingsClose"),this.saveBtn=document.getElementById("pageSettingsSave"),this.nameInput=document.getElementById("pageSettingsName"),this.refreshInput=document.getElementById("pageSettingsRefresh"),this.refreshModeInput=document.getElementById("pageSettingsRefreshMode"),this.refreshTimeInput=document.getElementById("pageSettingsRefreshTime"),this.fieldInterval=document.getElementById("field-refresh-interval"),this.fieldTime=document.getElementById("field-refresh-time"),this.darkModeInput=document.getElementById("pageSettingsDarkMode"),this.layoutModeInput=document.getElementById("pageSettingsLayoutMode"),this.gridSizeInput=document.getElementById("pageSettingsGridSize"),this.fieldGridSize=document.getElementById("field-grid-size"),this.pageIndex=-1}init(){this.modal&&(this.closeBtn&&this.closeBtn.addEventListener("click",()=>this.close()),this.saveBtn&&this.saveBtn.addEventListener("click",()=>this.save()),this.refreshModeInput&&this.refreshModeInput.addEventListener("change",()=>this.updateVisibility()),this.layoutModeInput&&this.layoutModeInput.addEventListener("change",()=>this.updateGridVisibility()))}updateVisibility(){if(!this.refreshModeInput)return;const e=this.refreshModeInput.value;this.fieldInterval&&(this.fieldInterval.style.display=e==="interval"?"block":"none"),this.fieldTime&&(this.fieldTime.style.display=e==="daily"?"block":"none")}updateGridVisibility(){if(!this.layoutModeInput||!this.fieldGridSize)return;const e=this.layoutModeInput.value;this.fieldGridSize.style.display=e==="grid"?"block":"none"}open(e){if(!this.modal)return;this.pageIndex=e;const n=u.pages[e];if(!n)return;this.nameInput&&(this.nameInput.value=n.name||"");const i=n.refresh_type||"interval";this.refreshModeInput&&(this.refreshModeInput.value=i),this.refreshInput&&(this.refreshInput.value=n.refresh_s||""),this.refreshTimeInput&&(this.refreshTimeInput.value=n.refresh_time||"08:00"),this.darkModeInput&&(this.darkModeInput.value=n.dark_mode||"inherit"),this.layoutModeInput&&(this.layoutModeInput.value=n.layout?"grid":"absolute"),this.gridSizeInput&&(this.gridSizeInput.value=n.layout||"4x4"),this.updateVisibility(),this.updateGridVisibility(),this.modal.classList.remove("hidden"),this.modal.style.display="flex"}close(){this.modal&&(this.modal.classList.add("hidden"),this.modal.style.display="none")}save(){if(this.pageIndex===-1)return;const e=u.pages[this.pageIndex];if(!e)return;const n=this.nameInput?this.nameInput.value:e.name,i=this.refreshModeInput?this.refreshModeInput.value:"interval",t=this.refreshInput?parseInt(this.refreshInput.value,10):NaN,s=this.refreshTimeInput?this.refreshTimeInput.value:"08:00",o=this.darkModeInput?this.darkModeInput.value:"inherit",r=this.layoutModeInput?this.layoutModeInput.value:"absolute",d=this.gridSizeInput?this.gridSizeInput.value.trim():"";e.name=n,e.refresh_type=i,i==="interval"?(!isNaN(t)&&t>=0?e.refresh_s=t:delete e.refresh_s,delete e.refresh_time):(e.refresh_time=s,delete e.refresh_s),e.dark_mode=o,r==="grid"&&/^\d+x\d+$/.test(d)?e.layout=d:e.layout=null,u.setPages(u.pages),q()&&typeof Ie=="function"&&Ie().then(()=>_.log("[PageSettings] Pages persisted to backend")).catch(c=>_.warn("[PageSettings] Failed to save pages to backend:",c)),this.close()}}class $s{constructor(){this.modal=null,this.currentLayoutId="reterminal_e1001",this.layouts=[]}init(){this.createModal(),this.bindButton(),_.log("[LayoutManager] Initialized")}bindButton(){const e=document.getElementById("manageLayoutsBtn");e&&e.addEventListener("click",()=>this.open())}createModal(){if(document.getElementById("layoutManagerModal")){this.modal=document.getElementById("layoutManagerModal");return}const e=document.createElement("div");e.id="layoutManagerModal",e.className="modal-backdrop hidden",e.innerHTML=`
            <div class="modal" style="max-width: 600px;">
                <div class="modal-header">
                    <div> Manage Layouts</div>
                    <button id="layoutManagerClose" class="btn btn-secondary"></button>
                </div>
                <div class="modal-body">
                    <div class="layout-manager-current" style="margin-bottom: 12px; padding: 8px; background: var(--bg-subtle); border-radius: 4px;">
                        <span class="prop-label" style="font-size: 11px; color: var(--muted);">Current Layout:</span>
                        <span id="layoutManagerCurrentName" style="font-weight: 500; margin-left: 8px;">Loading...</span>
                    </div>
                    
                    <div class="layout-manager-list-container" style="max-height: 300px; overflow-y: auto; margin-bottom: 12px;">
                        <table class="layout-manager-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 1px solid var(--border);">
                                    <th style="text-align: left; padding: 8px 4px; font-size: 11px;">Name</th>
                                    <th style="text-align: left; padding: 8px 4px; font-size: 11px;">Device</th>
                                    <th style="text-align: left; padding: 8px 4px; font-size: 11px;">Pages</th>
                                    <th style="text-align: right; padding: 8px 4px; font-size: 11px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="layoutManagerTableBody">
                                <tr><td colspan="4" style="text-align: center; color: var(--muted); padding: 16px;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="layout-manager-actions" style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button id="layoutManagerNew" class="btn btn-primary" style="flex: 1;">+ New Layout</button>
                        <button id="layoutManagerImport" class="btn btn-secondary" style="flex: 1;"> Import from File</button>
                        <input type="file" id="layoutManagerFileInput" accept=".json" style="display: none;">
                    </div>
                    
                    <div id="layoutManagerStatus" class="layout-manager-status" style="margin-top: 8px; font-size: 11px; min-height: 20px;"></div>
                </div>
            </div>
        `,document.body.appendChild(e),this.modal=e,document.getElementById("layoutManagerClose").addEventListener("click",()=>this.close()),document.getElementById("layoutManagerNew").addEventListener("click",()=>this.showNewLayoutDialog()),document.getElementById("layoutManagerImport").addEventListener("click",()=>{document.getElementById("layoutManagerFileInput").click()}),document.getElementById("layoutManagerFileInput").addEventListener("change",n=>this.handleFileImport(n)),e.addEventListener("click",n=>{n.target===e&&this.close()})}async open(){this.modal||this.createModal(),this.modal.classList.remove("hidden"),await this.loadLayouts()}close(){this.modal&&this.modal.classList.add("hidden")}setStatus(e,n="info"){const i=document.getElementById("layoutManagerStatus");if(i){const t={success:"var(--success, #22c55e)",error:"var(--danger, #ef4444)",info:"var(--muted, #888)"};i.textContent=e,i.style.color=t[n]||t.info,e&&setTimeout(()=>{i.textContent=""},5e3)}}async loadLayouts(){if(typeof q!="function"||!q()){this.setStatus("Not connected to Home Assistant","error");return}try{const e=await fetch(`${Q}/layouts`);if(!e.ok)throw new Error(`Failed to load layouts: ${e.status}`);const n=await e.json();this.layouts=n.layouts||[],n.last_active_layout_id&&this.layouts.some(i=>i.id===n.last_active_layout_id)&&(!window.AppState?.currentLayoutId||window.AppState.currentLayoutId==="reterminal_e1001")&&this.layouts.find(t=>t.id===n.last_active_layout_id)&&n.last_active_layout_id!==window.AppState?.currentLayoutId&&(_.log(`[LayoutManager] Syncing to last active layout: ${n.last_active_layout_id}`),this.currentLayoutId=n.last_active_layout_id,window.AppState&&typeof window.AppState.setCurrentLayoutId=="function"&&window.AppState.setCurrentLayoutId(n.last_active_layout_id)),this.renderLayoutList()}catch(e){_.error("[LayoutManager] Error loading layouts:",e),this.setStatus("Failed to load layouts","error")}}renderLayoutList(){const e=document.getElementById("layoutManagerTableBody"),n=document.getElementById("layoutManagerCurrentName");if(!e)return;window.AppState&&window.AppState.currentLayoutId&&(this.currentLayoutId=window.AppState.currentLayoutId);const i=this.layouts.find(t=>t.id===this.currentLayoutId);if(n&&(n.textContent=i?i.name:this.currentLayoutId),this.layouts.length===0){e.innerHTML='<tr><td colspan="4" style="text-align: center; color: var(--muted); padding: 16px;">No layouts found</td></tr>';return}e.innerHTML=this.layouts.map(t=>{const s=t.id===this.currentLayoutId,o=this.layouts.filter(r=>r.name===t.name).length>1;return`
                <tr style="border-bottom: 1px solid var(--border-subtle); ${s?"background: var(--accent-soft);":""}">
                    <td style="padding: 8px 4px;">
                        <span style="font-weight: 500;">${this.escapeHtml(t.name)}</span>
                        ${s?'<span style="background: var(--accent); color: white; font-size: 9px; padding: 2px 4px; border-radius: 2px; margin-left: 4px;">current</span>':""}
                        ${o?'<br><span style="font-size: 9px; color: var(--muted);">'+this.escapeHtml(t.id)+"</span>":""}
                    </td>
                    <td style="padding: 8px 4px; font-size: 11px; color: var(--muted);">${this.getDeviceDisplayName(t.device_model||t.device_type)}</td>
                    <td style="padding: 8px 4px; font-size: 11px; color: var(--muted);">${t.page_count} pages</td>
                    <td style="padding: 8px 4px; text-align: right;">
                        <div style="display: flex; gap: 4px; justify-content: flex-end;">
                            ${s?"":`<button class="btn btn-sm btn-primary" style="font-size: 10px; padding: 4px 8px;" onclick="window.layoutManager.loadLayout('${t.id}')">Load</button>`}
                            <button class="btn btn-sm btn-secondary" style="font-size: 10px; padding: 4px 8px;" onclick="window.layoutManager.exportLayout('${t.id}')"></button>
                            ${!s&&this.layouts.length>1?`<button class="btn btn-sm btn-secondary" style="font-size: 10px; padding: 4px 8px; color: var(--danger);" onclick="window.layoutManager.deleteLayout('${t.id}', '${this.escapeHtml(t.name)}')"></button>`:""}
                        </div>
                    </td>
                </tr>
            `}).join("")}escapeHtml(e){const n=document.createElement("div");return n.textContent=e||"",n.innerHTML}getDeviceDisplayName(e){if(F&&F[e]){let t=F[e].name;return(De||[]).includes(e)||(t+=" (untested)"),t}return{reterminal_e1001:"E1001 (Mono)",reterminal_e1002:"E1002 (Color)",trmnl:"TRMNL",esp32_s3_photopainter:"PhotoPainter (7-Color)"}[e]||e||"Unknown"}async loadLayout(e){if(!(typeof q!="function"||!q()))try{this.setStatus("Loading layout...","info");const n=await fetch(`${Q}/layouts/${e}`);if(!n.ok)throw new Error(`Failed to load layout: ${n.status}`);const i=await n.json();i.device_id||(i.device_id=e),this.currentLayoutId=e,window.AppState&&typeof window.AppState.setCurrentLayoutId=="function"&&(window.AppState.setCurrentLayoutId(e),_.log(`[LayoutManager] Set currentLayoutId to: ${e}`));const t=document.getElementById("canvas");if(t){const s=t.querySelector(".canvas-grid");t.innerHTML="",s&&t.appendChild(s),_.log("[LayoutManager] Cleared canvas before loading layout")}document.querySelectorAll(".graph-axis-label").forEach(s=>s.remove()),typeof le=="function"&&le(i),window.AppState&&window.AppState.currentLayoutId!==e&&(window.AppState.setCurrentLayoutId(e),_.log(`[LayoutManager] Re-set currentLayoutId to: ${e} (was changed by loadLayoutIntoState)`)),typeof O=="function"&&typeof P<"u"&&O(P.LAYOUT_IMPORTED,i),this.setStatus(`Loaded: ${i.name||e}`,"success"),this.renderLayoutList(),setTimeout(()=>this.close(),500)}catch(n){_.error("[LayoutManager] Error loading layout:",n),this.setStatus("Failed to load layout","error")}}async exportLayout(e){if(!(typeof q!="function"||!q()))try{const n=`${Q}/export?id=${e}`,i=document.createElement("a");i.href=n,i.download=`${e}_layout.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),this.setStatus("Export started...","success")}catch(n){_.error("[LayoutManager] Error exporting layout:",n),this.setStatus("Failed to export layout","error")}}async deleteLayout(e,n){if(!(typeof q!="function"||!q()||!confirm(`Are you sure you want to delete "${n}"?

This cannot be undone.`))){this.setStatus("Deleting layout...","info");try{const t=await fetch(`${Q}/layouts/${e}`,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify({action:"delete"})});if(!t.ok){const s=await t.json().catch(()=>({}));if(s.error==="cannot_delete_last_layout"){this.setStatus("Cannot delete the last layout","error");return}throw new Error(s.error||`Delete failed: ${t.status}`)}this.setStatus(`Deleted: ${n}`,"success"),await this.loadLayouts()}catch(t){_.warn("[LayoutManager] Network error during delete, verifying if operation completed..."),await new Promise(o=>setTimeout(o,1500)),await this.loadLayouts(),this.layouts.some(o=>o.id===e)?(_.error("[LayoutManager] Error deleting layout:",t),this.setStatus("Failed to delete layout","error")):(_.log("[LayoutManager] Layout was successfully deleted (verified after refresh)"),this.setStatus(`Deleted: ${n}`,"success"))}}}showNewLayoutDialog(){if(!document.getElementById("newLayoutModal")){const s=document.createElement("div");s.id="newLayoutModal",s.className="modal-backdrop hidden",s.innerHTML=`
                <div class="modal" style="max-width: 400px;">
                    <div class="modal-header">
                        <div>Create New Layout</div>
                        <button id="newLayoutClose" class="btn btn-secondary"></button>
                    </div>
                    <div class="modal-body">
                        <div class="field" style="margin-bottom: 12px;">
                            <div class="prop-label">Layout Name</div>
                            <input id="newLayoutName" class="prop-input" type="text" placeholder="e.g. Living Room Display" />
                        </div>
                        <div class="field">
                            <div class="prop-label">Device Type</div>
                            <select id="newLayoutDeviceType" class="prop-input">
                                ${this.generateDeviceOptions()}
                            </select>
                            <p class="hint" style="color: var(--muted); font-size: 11px; margin-top: 4px;">Select the device that will display this layout.</p>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button id="newLayoutCancel" class="btn btn-secondary">Cancel</button>
                        <button id="newLayoutConfirm" class="btn btn-primary">Create Layout</button>
                    </div>
                </div>
            `,document.body.appendChild(s),document.getElementById("newLayoutClose").addEventListener("click",()=>{s.classList.add("hidden")}),document.getElementById("newLayoutCancel").addEventListener("click",()=>{s.classList.add("hidden")}),document.getElementById("newLayoutConfirm").addEventListener("click",()=>{this.handleCreateLayoutConfirm()}),document.getElementById("newLayoutName").addEventListener("keydown",o=>{o.key==="Enter"?(o.preventDefault(),this.handleCreateLayoutConfirm()):o.key==="Escape"&&s.classList.add("hidden"),o.stopPropagation()}),s.addEventListener("click",o=>{if(o.target===s){const r=document.getElementById("newLayoutName");document.activeElement!==r&&s.classList.add("hidden")}})}const e=document.getElementById("newLayoutName"),i=`Layout ${this.layouts.length+1}`;e.value=i,u.deviceModel||u.settings&&u.settings.device_model;const t=F?Object.keys(F)[0]:"reterminal_e1001";document.getElementById("newLayoutDeviceType").value=t,document.getElementById("newLayoutModal").classList.remove("hidden"),setTimeout(()=>e.focus(),100)}handleCreateLayoutConfirm(){const e=document.getElementById("newLayoutName").value.trim(),n=document.getElementById("newLayoutDeviceType").value;if(!e){alert("Please enter a layout name.");return}document.getElementById("newLayoutModal").classList.add("hidden"),this.createLayout(e,n)}generateDeviceOptions(){if(F){const e=De||[];return Object.entries(F).map(([n,i])=>{let t=i.name;return e.includes(n)||(t+=" (untested)"),`<option value="${n}">${t}</option>`}).join("")}return'<option value="reterminal_e1001">reTerminal E1001</option>'}async createLayout(e,n="reterminal_e1001"){if(typeof q!="function"||!q())return;let i=e.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_]/g,"");i||(i="layout");const t=i+"_"+Date.now();this.setStatus("Creating layout...","info");let s=!1;try{const o=await fetch(`${Q}/layouts`,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify({id:t,name:e,device_type:n,device_model:n})});if(!o.ok){const r=await o.json().catch(()=>({}));throw new Error(r.error||`Create failed: ${o.status}`)}s=!0}catch(o){if(_.warn("[LayoutManager] Network error during create, verifying if operation completed..."),await new Promise(d=>setTimeout(d,1500)),await this.loadLayouts(),this.layouts.some(d=>d.id===t))_.log("[LayoutManager] Layout was successfully created (verified after refresh)"),s=!0;else{_.error("[LayoutManager] Error creating layout:",o),this.setStatus("Failed to create layout","error");return}}if(s){this.setStatus(`Created: ${e}`,"success"),await this.loadLayouts();const o=F[n],r=o&&o.features&&o.features.epaper,d=o&&o.features&&o.features.lvgl,c=r&&!d?"direct":"lvgl";_.log(`[LayoutManager] New layout ${t} detected device type. isEpaper=${r}, hasLvgl=${d}. Setting initial renderingMode to: ${c}`),window.AppState&&(window.AppState.setPages([{id:"page_0",name:"Page 1",widgets:[]}]),window.AppState.setCurrentPageIndex(0),window.AppState.updateSettings({renderingMode:c,device_model:n}),_.log("[LayoutManager] Cleared state and set initial settings before loading new layout")),await this.loadLayout(t),window.AppState&&(window.AppState.setDeviceModel(n),window.AppState.settings&&(window.AppState.settings.device_model=n),window.currentDeviceModel=n,typeof O=="function"&&typeof P<"u"&&O(P.STATE_CHANGED),_.log(`[LayoutManager] Created layout '${t}' with device_model: ${n}, pages: ${window.AppState.pages?.length}, widgets: ${window.AppState.getCurrentPage()?.widgets?.length||0}`))}}async handleFileImport(e){const n=e.target.files[0];if(n){try{const i=await n.text(),t=JSON.parse(i);if(!t.pages&&!t.device_id){this.setStatus("Invalid layout file","error");return}await this.importLayout(t)}catch(i){_.error("[LayoutManager] Error importing file:",i),this.setStatus("Failed to import file: "+i.message,"error")}e.target.value=""}}async importLayout(e,n=!1){if(!(typeof q!="function"||!q()))try{const i=`${Q}/import${n?"?overwrite=true":""}`,t=await fetch(i,{method:"POST",headers:ne(),body:JSON.stringify(e)}),s=await t.json();if(!t.ok){if(s.error==="layout_exists"){if(confirm(`A layout with ID "${s.existing_id}" already exists.

Do you want to overwrite it?`)){await this.importLayout(e,!0);return}return}throw new Error(s.error||`Import failed: ${t.status}`)}this.setStatus(`Imported: ${s.name||s.id}`,"success"),await this.loadLayouts()}catch(i){_.error("[LayoutManager] Error importing layout:",i),this.setStatus("Failed to import layout","error")}}}window.layoutManager=new $s;function nt(){const a=document.getElementById("resizer-left"),e=document.getElementById("resizer-right"),n=document.querySelector(".sidebar"),i=document.querySelector(".right-panel");if(document.querySelector(".app-content"),!a||!e||!n||!i){_.warn("[Splitters] Layout elements not found, retrying..."),setTimeout(nt,500);return}_.log("[Splitters] Initializing draggable panels...");function t(r,d,c){let l,h;r.addEventListener("mousedown",function(g){c==="vertical"?(l=g.clientX,h=d.offsetWidth,document.body.style.cursor="col-resize"):(l=g.clientY,h=d.offsetHeight,document.body.style.cursor="row-resize"),r.classList.add("dragging"),document.body.style.userSelect="none";function m(y){let b;if(c==="vertical"){b=y.clientX-l,r.id==="resizer-right"&&(b=-b);const w=h+b,v=parseInt(getComputedStyle(d).minWidth)||100,I=parseInt(getComputedStyle(d).maxWidth)||800;w>=v&&w<=I&&(d.style.width=w+"px")}else{b=l-y.clientY;const w=h+b,v=parseInt(getComputedStyle(d).minHeight)||50,I=parseInt(getComputedStyle(d).maxHeight)||800;w>=v&&w<=I&&(d.style.height=w+"px")}window.dispatchEvent&&window.dispatchEvent(new Event("resize"))}function f(){r.classList.remove("dragging"),document.body.style.cursor="default",document.body.style.userSelect="",window.removeEventListener("mousemove",m),window.removeEventListener("mouseup",f)}window.addEventListener("mousemove",m),window.addEventListener("mouseup",f)})}const s=document.getElementById("resizer-bottom"),o=document.querySelector(".code-panel");t(a,n,"vertical"),t(e,i,"vertical"),s&&o&&t(s,o,"horizontal")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",nt):nt();function Kt(){_.log("[ModalWiring] Initializing modal buttons...");const a=document.getElementById("deviceSettingsBtn"),e=document.getElementById("deviceSettingsModal"),n=document.getElementById("deviceSettingsClose"),i=document.getElementById("deviceSettingsSave"),t=document.getElementById("deviceName"),s=document.getElementById("deviceModel"),o=document.getElementById("deviceOrientation"),r=document.getElementById("deviceDarkMode"),d=document.getElementById("mode-standard"),c=document.getElementById("setting-sleep-enabled"),l=document.getElementById("setting-manual-refresh"),h=document.getElementById("setting-deep-sleep-enabled"),g=document.getElementById("sleep-times-row"),m=document.getElementById("deep-sleep-interval-row"),f=document.getElementById("setting-sleep-start"),y=document.getElementById("setting-sleep-end"),b=document.getElementById("setting-deep-sleep-interval");function w(){_.log("[ModalWiring] Opening device settings");const A=window.AppState?u.settings:{},U=window.AppState?u.settings.device_name:"reTerminal E1001";t&&(t.value=U||"reTerminal E1001"),s&&(s.value=window.currentDeviceModel||"reterminal_e1001"),o&&(o.value=A.orientation||"landscape"),r&&(r.checked=!!A.dark_mode);const J=!!A.sleep_enabled,j=!!A.manual_refresh_only,p=!!A.deep_sleep_enabled,T=!J&&!j&&!p;d&&(d.checked=T),c&&(c.checked=J),l&&(l.checked=j),h&&(h.checked=p),f&&(f.value=A.sleep_start_hour??0),y&&(y.value=A.sleep_end_hour??5),b&&(b.value=A.deep_sleep_interval??600),g&&(g.style.display=J?"flex":"none"),m&&(m.style.display=p?"flex":"none"),e.classList.remove("hidden"),e.style.display="flex"}function v(){e.style.display="none",e.classList.add("hidden")}a&&a.addEventListener("click",w),n&&n.addEventListener("click",v),i&&i.addEventListener("click",v),c&&c.addEventListener("change",()=>{g&&(g.style.display=c.checked?"flex":"none")}),h&&h.addEventListener("change",()=>{m&&(m.style.display=h.checked?"flex":"none")});const I=document.getElementById("editorSettingsBtn"),k=document.getElementById("editorSettingsModal"),M=document.getElementById("editorSettingsClose"),E=document.getElementById("editorSettingsDone");function x(){_.log("[ModalWiring] Opening editor settings"),k.classList.remove("hidden"),k.style.display="flex"}function S(){k.classList.add("hidden"),k.style.display="none"}I&&I.addEventListener("click",x),M&&M.addEventListener("click",S),E&&E.addEventListener("click",S);const L=document.getElementById("pageSettingsClose"),G=document.getElementById("pageSettingsSave"),W=document.getElementById("pageSettingsModal");function R(){W&&(W.classList.add("hidden"),W.style.display="none"),window.currentPageSettingsTarget=null}L&&L.addEventListener("click",R),G&&G.addEventListener("click",R),_.log("[ModalWiring] Modal buttons initialized")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Kt):Kt();class zs{constructor(){this.isOpen=!1,this.selectedIndex=0,this.filteredWidgets=[],this.allWidgets=[],this.modal=null,this.input=null,this.resultsContainer=null,this.init()}init(){this.createModal(),this.bindEvents()}discoverWidgets(){this.allWidgets=[];const e=document.querySelectorAll(".widget-category .item[data-widget-type]");if(e.length===0){_.warn("[QuickSearch] No widgets found in palette");return}e.forEach(n=>{const i=n.getAttribute("data-widget-type"),t=n.querySelector(".label"),s=t?t.textContent.trim():i,o=n.closest(".widget-category"),r=o?o.querySelector(".category-name"):null,d=r?r.textContent.trim():"Widgets";this.allWidgets.push({type:i,label:s,category:d,searchText:`${s} ${i} ${d}`.toLowerCase()})}),_.log(`[QuickSearch] Discovered ${this.allWidgets.length} widgets`)}createModal(){this.modal=document.createElement("div"),this.modal.id="quick-search-modal",this.modal.className="quick-search-modal hidden",this.modal.innerHTML=`
            <div class="quick-search-backdrop"></div>
            <div class="quick-search-container">
                <div class="quick-search-header">
                    <span class="quick-search-icon"></span>
                    <input type="text" class="quick-search-input" placeholder="Search widgets..." autocomplete="off" />
                </div>
                <div class="quick-search-results"></div>
                <div class="quick-search-hint">
                    <span> Navigate</span>
                    <span> Add Widget</span>
                    <span>Esc Close</span>
                </div>
            </div>
        `,document.body.appendChild(this.modal),this.input=this.modal.querySelector(".quick-search-input"),this.resultsContainer=this.modal.querySelector(".quick-search-results")}bindEvents(){this.modal.querySelector(".quick-search-backdrop").addEventListener("click",()=>this.close()),this.input.addEventListener("input",()=>this.handleSearch()),this.input.addEventListener("keydown",e=>this.handleKeyDown(e))}open(){this.discoverWidgets(),this.isOpen=!0,this.modal.classList.remove("hidden"),this.input.value="",this.selectedIndex=0,this.handleSearch(),setTimeout(()=>this.input.focus(),50)}close(){this.isOpen=!1,this.modal.classList.add("hidden"),this.input.blur()}handleSearch(){const e=this.input.value.toLowerCase().trim();e===""?this.filteredWidgets=[...this.allWidgets]:this.filteredWidgets=this.allWidgets.filter(n=>n.searchText.includes(e)),this.selectedIndex=0,this.renderResults()}renderResults(){if(this.filteredWidgets.length===0){this.resultsContainer.innerHTML=`
                <div class="quick-search-empty">No widgets found</div>
            `;return}this.resultsContainer.innerHTML=this.filteredWidgets.map((n,i)=>`
            <div class="quick-search-item ${i===this.selectedIndex?"selected":""}" 
                 data-index="${i}" data-type="${n.type}">
                <span class="quick-search-item-label">${n.label}</span>
                <span class="quick-search-item-category">${n.category}</span>
            </div>
        `).join(""),this.resultsContainer.querySelectorAll(".quick-search-item").forEach(n=>{n.addEventListener("click",()=>{const i=parseInt(n.getAttribute("data-index"),10);this.selectedIndex=i,this.addSelectedWidget()})});const e=this.resultsContainer.querySelector(".quick-search-item.selected");e&&e.scrollIntoView({block:"nearest"})}handleKeyDown(e){switch(e.key){case"ArrowDown":e.preventDefault(),this.selectedIndex=Math.min(this.selectedIndex+1,this.filteredWidgets.length-1),this.renderResults();break;case"ArrowUp":e.preventDefault(),this.selectedIndex=Math.max(this.selectedIndex-1,0),this.renderResults();break;case"Enter":e.preventDefault(),this.addSelectedWidget();break;case"Escape":e.preventDefault(),this.close();break}}addSelectedWidget(){if(this.filteredWidgets.length===0)return;const e=this.filteredWidgets[this.selectedIndex];if(e)try{const n=WidgetFactory.createWidget(e.type);AppState.addWidget(n),_.log(`[QuickSearch] Added widget: ${e.label}`),this.close()}catch(n){_.error("[QuickSearch] Error adding widget:",n),AppState.notify("Failed to add widget: "+n.message,"error")}}}class Fs{constructor(){this.active=!1,this.element=null,this.targetWidgetId=null,this.position={x:0,y:0},this.init()}init(){this.element||(this.element=document.createElement("div"),this.element.className="radial-menu",this.element.innerHTML=`
                <div class="radial-menu-center"></div>
                <div class="radial-menu-items"></div>
            `,document.body.appendChild(this.element),window.addEventListener("mousedown",e=>{this.active&&!this.element.contains(e.target)&&this.hide()},!0),window.addEventListener("keydown",e=>{e.key==="Escape"&&this.active&&this.hide()}))}show(e,n,i=null){this.targetWidgetId=i,this.position={x:e,y:n},this.active=!0,this.element.style.left=`${e}px`,this.element.style.top=`${n}px`,this.renderItems(),requestAnimationFrame(()=>{this.element.classList.add("active")})}hide(){this.active=!1,this.element.classList.remove("active"),this.targetWidgetId=null}renderItems(){const e=this.element.querySelector(".radial-menu-items");e.innerHTML="";const n=this.getAvailableActions(),i=2*Math.PI/n.length,t=70;n.forEach((s,o)=>{const r=o*i-Math.PI/2,d=Math.cos(r)*t,c=Math.sin(r)*t,l=document.createElement("div");l.className=`radial-menu-item ${s.className||""}`,l.style.setProperty("--x",`${d}px`),l.style.setProperty("--y",`${c}px`),l.title=s.label,l.innerHTML=`<i class="mdi ${s.icon}"></i>`,l.addEventListener("click",h=>{h.stopPropagation(),s.callback(),this.hide()}),e.appendChild(l)})}getAvailableActions(){const e=u,n=this.targetWidgetId?e.getWidgetById(this.targetWidgetId):null,i=[];if(n){i.push({label:"Copy",icon:"mdi-content-copy",callback:()=>{e.selectWidget(this.targetWidgetId,!1),e.copyWidget()}});const t=e.selectedWidgetIds,s=t.some(d=>{const c=e.getWidgetById(d);return c&&(c.type==="group"||c.parentId)});t.length>1&&!s&&i.push({label:"Group",icon:"mdi-group",callback:()=>e.groupSelection()}),(n.type==="group"||n.parentId)&&i.push({label:"Ungroup",icon:"mdi-ungroup",callback:()=>e.ungroupSelection(this.targetWidgetId)}),i.push({label:"Duplicate",icon:"mdi-content-duplicate",callback:()=>{e.copyWidget(),e.pasteWidget()}}),i.push({label:n.locked?"Unlock":"Lock",icon:n.locked?"mdi-lock-open-outline":"mdi-lock-outline",callback:()=>{e.updateWidget(this.targetWidgetId,{locked:!n.locked})}}),i.push({label:"Snap",icon:"mdi-magnet",callback:()=>{ns(this.targetWidgetId)}}),i.push({label:"Delete",icon:"mdi-delete-outline",className:"danger",callback:()=>{e.deleteWidget(this.targetWidgetId)}});const o=e.getCurrentPage(),r=o?.widgets.findIndex(d=>d.id===this.targetWidgetId);r!==-1&&(i.push({label:"Bring to Front",icon:"mdi-arrange-bring-to-front",callback:()=>{e.reorderWidget(e.currentPageIndex,r,o.widgets.length-1)}}),i.push({label:"Send to Back",icon:"mdi-arrange-send-to-back",callback:()=>{e.reorderWidget(e.currentPageIndex,r,0)}}))}else i.push({label:"Paste",icon:"mdi-content-paste",callback:()=>{e.pasteWidget()}});return i}}window.RadialMenu=new Fs;class Gs{constructor(){this.patterns=[{name:"comment",regex:/(#.*)/g},{name:"key",regex:/^(\s*)([^:\n]+)(:)/gm},{name:"string",regex:/("[^"]*"|'[^']*')/g},{name:"value",regex:/\b(true|false|null|[0-9]+(\.[0-9]+)?)\b/g},{name:"keyword",regex:/\b(lambda|script|on_.*|if|then|else|wait_until|delay)\b/g},{name:"tag",regex:/(![a-z_]+)/g}]}highlight(e){if(!e)return"";let n=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");const i=/^(\s*(?:-\s+)?)([^:\n]+)(:)|(#.*)|("[^"]*"|'[^']*')|(![a-z_]+)|\b(lambda|script|on_[a-z_]+|if|then|else|wait_until|delay)\b|\b(true|false|null|[0-9]+(?:\.[0-9]+)?)\b|(\|[-+]?|>[-+]?)/gm;return n.replace(i,(t,s,o,r,d,c,l,h,g,m)=>s!==void 0?`${s}<span class="hl-key">${o}</span><span class="hl-punc">${r}</span>`:d!==void 0?`<span class="hl-comment">${d}</span>`:c!==void 0?`<span class="hl-string">${c}</span>`:l!==void 0?`<span class="hl-tag">${l}</span>`:m!==void 0?`<span class="hl-punc">${m}</span>`:h!==void 0?`<span class="hl-keyword">${h}</span>`:g!==void 0?`<span class="hl-value">${g}</span>`:t)}}class js{constructor(e){this.adapter=e,this.highlighter=new Gs,this.suppressSnippetUpdate=!1,this.snippetDebounceTimer=null,this.lastGeneratedYaml="",this.isHighlighted=localStorage.getItem("esphome_designer_yaml_highlight")!=="false",this.init()}init(){this.bindEvents(),this.setupAutoUpdate(),this.setupScrollSync(),this.updateSnippetBox()}bindEvents(){const e=document.getElementById("fullscreenSnippetBtn");e&&e.addEventListener("click",()=>{this.openSnippetModal()});const n=document.getElementById("snippetFullscreenClose");n&&n.addEventListener("click",()=>{const h=document.getElementById("snippetFullscreenModal");h&&h.classList.add("hidden")});const i=document.getElementById("importSnippetConfirm");i&&i.addEventListener("click",async()=>{await this.handleImportSnippet()});const t=document.getElementById("updateLayoutBtn");t&&t.addEventListener("click",async()=>{await this.handleUpdateLayoutFromSnippetBox()});const s=document.getElementById("copySnippetBtn");s&&s.addEventListener("click",async()=>{this.copySnippetToClipboard(s)});const o=document.getElementById("copyOEPLServiceBtn");o&&o.addEventListener("click",()=>{this.copyOEPLServiceToClipboard(o)});const r=document.getElementById("toggleYamlBtn"),d=document.querySelector(".code-panel");r&&d&&(localStorage.getItem("esphome_designer_yaml_collapsed")==="true"&&d.classList.add("collapsed"),r.addEventListener("click",()=>{const g=d.classList.toggle("collapsed");localStorage.setItem("esphome_designer_yaml_collapsed",g),window.dispatchEvent(new Event("resize"))}));const c=document.getElementById("toggleHighlightBtn");document.querySelector(".snippet-container"),c&&(document.querySelectorAll(".snippet-container").forEach(h=>{h.classList.toggle("highlighted",this.isHighlighted)}),document.querySelectorAll('[id*="ToggleHighlightBtn"]').forEach(h=>{h.classList.toggle("active",this.isHighlighted)}),c.addEventListener("click",()=>{this.isHighlighted=!this.isHighlighted,localStorage.setItem("esphome_designer_yaml_highlight",this.isHighlighted),document.querySelectorAll(".snippet-container").forEach(h=>{h.classList.toggle("highlighted",this.isHighlighted)}),document.querySelectorAll('[id*="ToggleHighlightBtn"]').forEach(h=>{h.classList.toggle("active",this.isHighlighted)}),this.isHighlighted&&this.updateHighlightLayer()}));const l=document.getElementById("snippetBox");l&&l.addEventListener("input",()=>{this.isHighlighted&&this.updateHighlightLayer()})}setupScrollSync(){const e=document.getElementById("snippetBox"),n=document.getElementById("highlightLayer");e&&n&&e.addEventListener("scroll",()=>{n.scrollTop=e.scrollTop,n.scrollLeft=e.scrollLeft})}setupAutoUpdate(){Z(P.STATE_CHANGED,()=>{this.suppressSnippetUpdate||this.updateSnippetBox()}),Z(P.SELECTION_CHANGED,e=>{const n=e&&e.widgetIds?e.widgetIds:[];typeof Pe=="function"&&Pe(n)})}updateHighlightLayer(){if(!this.isHighlighted)return;const e=document.getElementById("snippetBox"),n=document.getElementById("highlightLayer");e&&n&&(n.innerHTML=this.highlighter.highlight(e.value));const i=document.getElementById("snippetFullscreenHighlight"),t=document.getElementById("snippetFullscreenContent");if(i&&t){const s=t.querySelector("textarea");s&&(i.innerHTML=this.highlighter.highlight(s.value))}}updateSnippetBox(){const e=document.getElementById("snippetBox");e&&(this.snippetDebounceTimer&&clearTimeout(this.snippetDebounceTimer),this.snippetDebounceTimer=setTimeout(()=>{if(!this.suppressSnippetUpdate)try{const n=this.adapter&&this.adapter.constructor.name,i=n==="OEPLAdapter",t=n==="OpenDisplayAdapter",s=document.getElementById("oeplNotice");s&&s.classList.toggle("hidden",!i);const o=document.getElementById("odpNotice");o&&o.classList.toggle("hidden",!t);const r=document.querySelector(".code-panel-title");if(r){const h=r.querySelector("button");r.innerHTML="",h&&r.appendChild(h);let g=" ESPHome YAML";i&&(g=" OpenEpaperLink JSON"),t&&(g=" OpenDisplay JSON (ODP)"),r.appendChild(document.createTextNode(g))}const d=document.getElementById("copyOEPLServiceBtn");d&&(d.style.display=i?"inline-block":"none");const c=document.getElementById("updateLayoutBtn");c&&(c.style.display="inline-block");const l=window.AppState?window.AppState.getPagesPayload():{pages:[]};window.currentDeviceModel&&window.currentDeviceModel!==l.deviceModel&&(_.log(`[SnippetManager] Overriding stale deviceModel '${l.deviceModel}' with '${window.currentDeviceModel}'`),l.deviceModel=window.currentDeviceModel,l.device_model=window.currentDeviceModel,l.settings&&(l.settings.device_model=window.currentDeviceModel)),this.adapter.generate(l).then(h=>{this.lastGeneratedYaml=h,e.value=h,this.isHighlighted&&this.updateHighlightLayer();const g=window.AppState?window.AppState.selectedWidgetIds:[];typeof Pe=="function"&&Pe(g)}).catch(h=>{_.error("Error generating snippet via adapter:",h),e.value="# Error generating YAML (adapter): "+h.message,this.isHighlighted&&this.updateHighlightLayer()})}catch(n){_.error("Error generating snippet:",n),e.value="# Error generating YAML: "+n.message,this.isHighlighted&&this.updateHighlightLayer()}},50))}openSnippetModal(){const e=document.getElementById("snippetFullscreenModal"),n=document.getElementById("snippetFullscreenContainer"),i=document.getElementById("snippetFullscreenContent"),t=document.getElementById("snippetFullscreenHighlight"),s=document.getElementById("snippetBox"),o=document.getElementById("toggleFullscreenHighlightBtn");if(!e||!n||!i||!t||!s)return;n.classList.toggle("highlighted",this.isHighlighted),o&&o.classList.toggle("active",this.isHighlighted),o&&!o.hasListener&&(o.addEventListener("click",()=>{this.isHighlighted=!this.isHighlighted,localStorage.setItem("esphome_designer_yaml_highlight",this.isHighlighted);const d=document.querySelector(".snippet-container"),c=document.getElementById("toggleHighlightBtn");d&&d.classList.toggle("highlighted",this.isHighlighted),c&&c.classList.toggle("active",this.isHighlighted),n.classList.toggle("highlighted",this.isHighlighted),o.classList.toggle("active",this.isHighlighted),this.isHighlighted&&(t.innerHTML=this.highlighter.highlight(r.value),this.updateHighlightLayer())}),o.hasListener=!0);let r=i.querySelector("textarea");if(!r){i.innerHTML="",r=document.createElement("textarea"),r.className="snippet-box",r.style.width="100%",r.style.height="100%",r.style.background="transparent",r.spellcheck=!1,i.appendChild(r),r.addEventListener("scroll",()=>{t.scrollTop=r.scrollTop,t.scrollLeft=r.scrollLeft}),r.addEventListener("input",()=>{this.isHighlighted&&(t.innerHTML=this.highlighter.highlight(r.value))});let d=e.querySelector(".modal-actions");if(d&&!d.querySelector("#fullscreenUpdateBtn")){const c=document.createElement("button");c.id="fullscreenUpdateBtn",c.className="btn btn-primary",c.textContent="Update Layout from YAML",c.onclick=()=>{s.value=r.value,this.handleUpdateLayoutFromSnippetBox(),e.classList.add("hidden")},d.insertBefore(c,d.firstChild)}}r.value=s.value||"",this.isHighlighted&&(t.innerHTML=this.highlighter.highlight(r.value),setTimeout(()=>{t.scrollTop=r.scrollTop,t.scrollLeft=r.scrollLeft},50)),e.style.display="",e.classList.remove("hidden")}async handleImportSnippet(){const e=document.getElementById("importSnippetTextarea"),n=document.getElementById("importSnippetError");if(!e)return;const i=e.value;if(i.trim())try{n&&(n.textContent="");let t;try{t=Et(i),_.log("[handleImportSnippet] Successfully used offline parser.")}catch(o){if(_.warn("[handleImportSnippet] Offline parser failed, falling back to backend:",o),q())t=await zi(i);else throw o}le(t);const s=document.getElementById("importSnippetModal");s&&(s.classList.add("hidden"),s.style.display="none"),z("Layout imported successfully","success")}catch(t){_.error("Import failed:",t),n&&(n.textContent=`Error: ${t.message}`)}}async handleUpdateLayoutFromSnippetBox(){const e=document.getElementById("snippetBox");if(!e)return;const n=e.value;if(n.trim()){if(this.lastGeneratedYaml&&n.trim()===this.lastGeneratedYaml.trim()){_.log("[handleUpdateLayoutFromSnippetBox] Skipping update: Snippet matches last generated state.");return}try{const i=window.AppState?.currentLayoutId||"reterminal_e1001",t=window.AppState?.deviceName||"Layout 1",s=window.AppState?.deviceModel||window.AppState?.settings?.device_model||"reterminal_e1001";_.log(`[handleUpdateLayoutFromSnippetBox] Preserving context - ID: ${i}, Name: ${t}`);let o=Et(n);o.device_id=i,o.name=t,o.device_model=s,o.settings||(o.settings={}),o.settings.device_model=s,o.settings.device_name=t;const r=window.AppState?.settings?.dark_mode||!1;o.settings.dark_mode=r,this.suppressSnippetUpdate=!0,this.snippetDebounceTimer&&(clearTimeout(this.snippetDebounceTimer),this.snippetDebounceTimer=null),le(o),setTimeout(()=>{this.suppressSnippetUpdate=!1},1500),z("Layout updated from YAML","success"),(n.includes("lambda:")||n.includes("script:"))&&setTimeout(()=>{z("Note: Custom C++ (lambda/script) may not fully preview.","warning",4e3)},800)}catch(i){_.error("Update layout failed:",i),z(`Update failed: ${i.message}`,"error"),this.suppressSnippetUpdate=!1}}}async copySnippetToClipboard(e){const n=document.getElementById("snippetBox");if(!n)return;const i=n.value||"",t=e.textContent,s=()=>{e.textContent="Copied!",e.style.minWidth=e.offsetWidth+"px",setTimeout(()=>{e.textContent=t,e.style.minWidth=""},2e3)};try{if(navigator.clipboard&&window.isSecureContext)await navigator.clipboard.writeText(i),z("Snippet copied to clipboard","success"),s();else{const o=document.createElement("textarea");o.value=i,o.style.position="fixed",o.style.left="-999999px",o.style.top="-999999px",document.body.appendChild(o),o.focus(),o.select();try{document.execCommand("copy"),z("Snippet copied to clipboard","success"),s()}catch{z("Unable to copy. Try selecting and copying manually.","error")}document.body.removeChild(o)}}catch(o){_.error("Copy failed:",o),z("Unable to copy snippet","error")}}async copyOEPLServiceToClipboard(e){const n=document.getElementById("snippetBox");if(!n)return;let i=n.value||"",t="";try{const s=JSON.parse(i),o=u.settings.oeplEntityId||"open_epaper_link.0000000000000000";s.target.entity_id=o,s.data.dither=u.settings.oeplDither??2,t=`service: ${s.service}
`,t+=`target:
  entity_id: ${s.target.entity_id}
`,t+=`data:
`,t+=`  background: ${s.data.background}
`,t+=`  rotate: ${s.data.rotate}
`,t+=`  dither: ${s.data.dither}
`,t+=`  ttl: ${s.data.ttl}
`,t+=`  payload: >
`;const r=JSON.stringify(s.data.payload);t+=`    ${r}`;const d=e.textContent;if(navigator.clipboard)await navigator.clipboard.writeText(t),z("HA Service call copied!","success");else{const c=document.createElement("textarea");c.value=t,document.body.appendChild(c),c.select(),document.execCommand("copy"),document.body.removeChild(c),z("HA Service call copied!","success")}e.textContent="Copied!",setTimeout(()=>{e.textContent=d},2e3)}catch(s){_.error("Failed to format/copy OEPL service:",s),z("Failed to format service call","error")}}}class Us{constructor(){this.cache={models:{}}}getSettings(){return window.AppState.settings}async fetchModels(e,n){if(!n)return[];try{if(e==="openrouter")return(await(await fetch("https://openrouter.ai/api/v1/models",{headers:{Authorization:`Bearer ${n}`}})).json()).data.map(s=>({id:s.id,name:s.name,context:s.context_length}));if(e==="openai")return(await(await fetch("https://api.openai.com/v1/models",{headers:{Authorization:`Bearer ${n}`}})).json()).data.filter(s=>s.id.startsWith("gpt-")).map(s=>({id:s.id,name:s.id}));if(e==="gemini"){try{const t=await(await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${n}`)).json();if(t.models&&Array.isArray(t.models))return t.models.filter(s=>s.supportedGenerationMethods.includes("generateContent")).map(s=>({id:s.name.replace("models/",""),name:s.displayName||s.name.replace("models/",""),description:s.description}))}catch(i){throw _.warn("Dynamic Gemini model fetch failed:",i),new Error("Failed to fetch Gemini models. Check your API key.")}return[]}}catch(i){throw _.error(`Error fetching models for ${e}:`,i),i}return[]}async processPrompt(e,n){const i=this.getSettings(),t=i.ai_provider||"gemini",s=i[`ai_api_key_${t}`];let o=i[`ai_model_${t}`];if(!o&&t==="gemini"){_.log("No model selected, attempting to auto-detect...");try{const l=await this.fetchModels(t,s);if(l.length>0)o=(l.find(g=>g.id.includes("flash"))||l.find(g=>g.id.includes("1.5-pro"))||l.find(g=>g.id.includes("gemini-pro"))||l[0]).id,_.log(`Auto-detected model: ${o}`),window.AppState.updateSettings({[`ai_model_${t}`]:o});else throw new Error("No models found for this API Key.")}catch(l){_.error("Auto-detection failed:",l),o="gemini-1.5-flash"}}if(!s)throw new Error(`Missing API Key for ${t}`);if(!o)throw new Error(`No model selected for ${t}`);const r=this.getSystemPrompt(),d={...n,widgets:n.widgets.map(l=>this.minifyWidget(l))},c=`
Current Layout Context:
${JSON.stringify(d,null,2)}

User Request:
${e}

Respond ONLY with valid JSON containing the updated "widgets" array for the current page. Do not include any explanation.
`.trim();try{let l="";t==="gemini"?l=await this.callGemini(s,o,r,c):t==="openai"?l=await this.callOpenAI(s,o,r,c):t==="openrouter"&&(l=await this.callOpenRouter(s,o,r,c));let h=l.trim();if(h.includes("```")){const b=h.match(/```(?:json)?\s*([\s\S]*?)\s*```/);b&&b[1]&&(h=b[1].trim())}const g=h.indexOf("["),m=h.indexOf("{");let f=-1,y=-1;g!==-1&&(m===-1||g<m)?(f=g,y=h.lastIndexOf("]")):m!==-1&&(f=m,y=h.lastIndexOf("}")),f!==-1&&y!==-1&&y>f&&(h=h.substring(f,y+1));try{const b=JSON.parse(h);return Array.isArray(b)?b:b.widgets||b}catch(b){_.warn("Fast JSON parse failed, trying repair...",b);try{const w=this.repairJson(h),v=JSON.parse(w);return Array.isArray(v)?v:v.widgets||v}catch(w){throw _.error("JSON repair failed:",w),new Error("AI returned malformed JSON (possibly truncated). Try a shorter prompt or a more powerful model.")}}}catch(l){throw _.error("AI processing failed:",l),l}}async callGemini(e,n,i,t){const s=`https://generativelanguage.googleapis.com/v1beta/models/${n}:generateContent?key=${e}`,o={contents:[{role:"user",parts:[{text:i+`

`+t}]}],generationConfig:{temperature:.1,topP:.95,topK:40,maxOutputTokens:8192,responseMimeType:"application/json"}},r=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),d=await r.json();if(r.status===429)throw new Error(" Rate Limit Exceeded: You are sending requests too quickly for the free tier. Please wait a minute and try again.");if(d.error)throw new Error(d.error.message);return d.candidates[0].content.parts[0].text}async callOpenAI(e,n,i,t){const o=n&&n.toLowerCase().includes("gpt-5")?{type:"json_schema",json_schema:{name:"widget_layout",strict:!0,schema:{type:"object",properties:{widgets:{type:"array",items:{type:"object"}}},required:["widgets"],additionalProperties:!1}}}:{type:"json_object"},d=await(await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:n,messages:[{role:"system",content:i},{role:"user",content:t}],temperature:.1,max_tokens:8192,response_format:o})})).json();if(d.error)throw new Error(d.error.message);return d.choices[0].message.content}async callOpenRouter(e,n,i,t){const o=await(await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:n,messages:[{role:"system",content:i},{role:"user",content:t}],temperature:.1,max_tokens:4096})})).json();if(o.error)throw new Error(o.error.message);return o.choices[0].message.content}getSystemPrompt(){return`
You are an expert UI designer and developer for ESPHome devices. 
Your task is to modify or create a widget list based on user instructions.

WIDGET TYPES & PROPS:
- text: { x, y, width, height, text, font_size, font_family, font_weight (400 or 700), color, align }
- sensor_text: { x, y, width, height, entity, prefix, suffix, font_size, color }
- datetime: { x, y, width, height, format, time_font_size, date_font_size, color }
- weather_forecast: { x, y, width, height, entity, layout ("horizontal"/"vertical"), icon_size, temp_font_size, day_font_size }
- weather_icon: { x, y, width, height, entity, size, color }
- icon: { x, y, width, height, icon, icon_size, color }
- battery_icon: { x, y, width, height, entity, color }
- progress_bar: { x, y, width, height, color, bar_height }
- graph: { x, y, width, height, entity, color, duration }
- shape_rect / rounded_rect / shape_circle: { x, y, width, height, color, fill (bool), border_width, opacity }
- lvgl_*: Advanced widgets (lvgl_button, lvgl_switch, lvgl_slider, lvgl_arc, etc).

STRICT OPERATIONAL RULES:
1. CONTENT ACCURACY: If the user says "reads 'X'", the 'text' property MUST BE "X". NEVER use generic placeholders like "Text".
2. TYPOGRAPHY: "Bold" = font_weight: 700. "Normal/Regular" = font_weight: 400. "Large" = font_size: 28+.
3. VISUAL HIERARCHY: Use 'shape_rect' or 'rounded_rect' to create headers, footers, or background cards for groups of widgets. Use small thin shapes as dividers.
4. UNIQUE IDS: Every new widget MUST have a unique ID like "w_" + timestamp or a short descriptive string. Never leave ID as null or undefined.
5. CANVAS BOUNDS: Stay within ${JSON.stringify(window.AppState.getCanvasDimensions())}.
6. COLOR USAGE: Check "display_type" in context:
   - "monochrome": Use ONLY "black" or "white". No grays, no colors.
   - "color_epaper": Use limited palette: black, white, red, green, blue, yellow, orange. No gradients.
   - "color_lcd": Full RGB colors allowed. Use hex codes like "#FF5722" or CSS names.
7. LVGL WIDGETS: If "display_type" is "monochrome" or "color_epaper", do NOT use lvgl_* widgets unless the user explicitly requests LVGL. Use standard widgets (text, shape_rect, icon, etc.) instead. LVGL is designed for LCDs with fast refresh.

FEW-SHOT EXAMPLE:
User: "Add a large bold title that reads 'Home Status' at the top with a separator line."
Response: [
  {"id": "w_title", "type": "text", "x": 20, "y": 10, "width": 760, "height": 50, "text": "Home Status", "font_size": 32, "font_weight": 700, "align": "CENTER"},
  {"id": "w_sep", "type": "shape_rect", "x": 20, "y": 65, "width": 760, "height": 2, "color": "black", "fill": true}
]

8. DROP SHADOWS: For LCD displays ("color_lcd"), add subtle drop shadows to shapes and cards.
   HOW TO: Create a DUPLICATE of the widget to be shadowed.
           - ID: [original_id]_shadow
           - X/Y: original.x + 4, original.y + 4
           - Color: "black" (or "white" if background is dark)
           - Z-Order: Place the shadow widget BEFORE the main widget in the list so it renders behind.
           - Opacity: If supported by the widget type ('shape_rect'), set opacity to 0.4. If not, use a gray color like "#333333".

DESIGN GOAL: Create "Beautiful" layouts. Use whitespace, professional alignment, and decorative shapes to make the UI look premium.
`.trim()}repairJson(e){let n=[],i=!1,t=!1;for(let o=0;o<e.length;o++){const r=e[o];if(t){t=!1;continue}if(r==="\\"){t=!0;continue}if(r==='"'){i=!i;continue}i||(r==="["||r==="{"?n.push(r==="["?"]":"}"):(r==="]"||r==="}")&&n.length>0&&n[n.length-1]===r&&n.pop())}let s=e;for(i&&(s+='"'),s=s.trim().replace(/,\s*$/,"");n.length>0;)s+=n.pop();return s}minifyWidget(e){const{id:n,type:i,x:t,y:s,width:o,height:r,...d}=e;return{id:n,type:i,x:t,y:s,width:o,height:r,...d}}}const Jt=[{id:"core",name:"Core Widgets",expanded:!0,widgets:[{type:"label",label:"Floating text",tag:"Text",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><text x="4" y="17" font-size="14" font-weight="bold" fill="currentColor">Aa</text></svg>'},{type:"sensor_text",label:"Sensor text",tag:"Entity",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><circle cx="8" cy="12" r="3" fill="none" stroke="currentColor" stroke-width="2" /><path d="M11 12h9M14 9l3 3-3 3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'},{type:"datetime",label:"Date & Time",tag:"Time",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2" /><path d="M12 7v5l3 3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'},{type:"icon",label:"MDI icon",tag:"Icon",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M12 2L9 9H2l6 4.5L5.5 22 12 17l6.5 5-2.5-8.5L22 9h-7z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round" /></svg>'},{type:"weather_icon",label:"Weather icon",tag:"Icon",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><circle cx="12" cy="10" r="4" fill="none" stroke="currentColor" stroke-width="2" /><path d="M12 2v2M12 16v2M4 10H2M22 10h-2M5.6 4.6l1.4 1.4M17 6l1.4-1.4M5.6 15.4l1.4-1.4M17 14l1.4 1.4" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'},{type:"image",label:"Image",tag:"Media",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="3" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><circle cx="8.5" cy="8.5" r="1.5" fill="currentColor" /><path d="M21 15l-5-5L11 15l-3-3-5 5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'},{type:"online_image",label:"Puppet image",tag:"Remote",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="5" width="14" height="14" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><circle cx="8" cy="10" r="1.5" fill="currentColor" /><path d="M17 12l-4-4-4 4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" /><circle cx="19" cy="6" r="3" fill="none" stroke="currentColor" stroke-width="2" /><path d="M19 5v2M19 9v.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'}]},{id:"shapes",name:"Shapes",expanded:!0,widgets:[{type:"shape_rect",label:"Rectangle",tag:"Shape",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="14" rx="2" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"rounded_rect",label:"Rounded Rect",tag:"Shape",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="14" rx="6" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"shape_circle",label:"Circle",tag:"Shape",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"line",label:"Line",tag:"Shape",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><line x1="4" y1="12" x2="20" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'}]},{id:"opendisplay",name:"OpenDisplay / OEPL",expanded:!1,icon:'<svg class="category-svg" viewBox="0 0 24 24" width="16" height="16"><rect x="3" y="4" width="18" height="14" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><line x1="3" y1="9" x2="21" y2="9" stroke="currentColor" stroke-width="1" /><circle cx="6" cy="6.5" r="1" fill="currentColor" /><circle cx="9" cy="6.5" r="1" fill="currentColor" /></svg>',widgets:[{type:"odp_multiline",label:"Multiline Text",tag:"ODP",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><line x1="4" y1="7" x2="20" y2="7" stroke="currentColor" stroke-width="2" stroke-linecap="round" /><line x1="4" y1="12" x2="18" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" /><line x1="4" y1="17" x2="14" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'},{type:"odp_rectangle_pattern",label:"Rectangle Pattern",tag:"ODP",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="4" width="6" height="6" fill="none" stroke="currentColor" stroke-width="1.5" /><rect x="11" y="4" width="6" height="6" fill="none" stroke="currentColor" stroke-width="1.5" /><rect x="3" y="12" width="6" height="6" fill="none" stroke="currentColor" stroke-width="1.5" /><rect x="11" y="12" width="6" height="6" fill="none" stroke="currentColor" stroke-width="1.5" /></svg>'},{type:"odp_polygon",label:"Polygon",tag:"ODP",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><polygon points="12,3 21,10 18,20 6,20 3,10" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"odp_ellipse",label:"Ellipse",tag:"ODP",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><ellipse cx="12" cy="12" rx="9" ry="6" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"odp_arc",label:"Arc",tag:"ODP",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M6 18 A 9 9 0 0 1 18 18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'},{type:"odp_icon_sequence",label:"Icon Sequence",tag:"ODP",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><circle cx="5" cy="12" r="3" fill="currentColor" /><circle cx="12" cy="12" r="3" fill="currentColor" /><circle cx="19" cy="12" r="3" fill="currentColor" /></svg>'},{type:"odp_plot",label:"Sensor Plot",tag:"ODP",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M3 3v18h18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" /><path d="M6 15l4-6 4 3 6-7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'}]},{id:"advanced",name:"Advanced",expanded:!0,widgets:[{type:"graph",label:"Graph / Chart",tag:"Data",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M3 3v18h18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" /><path d="M7 14l4-4 4 4 5-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'},{type:"progress_bar",label:"Progress bar",tag:"Entity",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="9" width="20" height="6" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><rect x="3" y="10" width="12" height="4" rx="1" fill="currentColor" /></svg>'},{type:"qr_code",label:"QR Code",tag:"Tools",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" fill="currentColor" /><rect x="14" y="3" width="7" height="7" fill="currentColor" /><rect x="3" y="14" width="7" height="7" fill="currentColor" /><rect x="14" y="14" width="3" height="3" fill="currentColor" /></svg>'},{type:"calendar",label:"Calendar",tag:"Events",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><path d="M16 2v4M8 2v4M3 10h18" stroke="currentColor" stroke-width="2" /></svg>'},{type:"weather_forecast",label:"Weather Forecast",tag:"Forecast",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><circle cx="12" cy="10" r="4" fill="none" stroke="currentColor" stroke-width="2" /><path d="M12 2v2M12 16v2M4 10H2M22 10h-2M5.6 4.6l1.4 1.4M17 6l1.4-1.4M5.6 15.4l1.4-1.4M17 14l1.4 1.4" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'},{type:"quote_rss",label:"Quote / RSS",tag:"Info",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M6 17h3l2-4V7H5v6h3M13 17h3l2-4V7h-6v6h3" fill="none" stroke="currentColor" stroke-width="2" /></svg>'}]},{id:"inputs",name:"Inputs",expanded:!1,icon:'<svg class="category-svg" viewBox="0 0 24 24" width="16" height="16"><path d="M9 11.24V7.5C9 6.12 10.12 5 11.5 5S14 6.12 14 7.5v3.74c1.21-.81 2-2.18 2-3.74C16 5.01 13.99 3 11.5 3S7 5.01 7 7.5c0 1.56.79 2.93 2 3.74zM16.06 17H15v-1l-1-1h-6l-1 1v1H5.94c-.58 0-1.06-.48-1.06-1.06V7.5c0-3.59 2.91-6.5 6.5-6.5s6.5 2.91 6.5 6.5v8.44c0 .58-.48 1.06-1.06 1.06z" fill="none" stroke="currentColor" stroke-width="2" /><circle cx="12" cy="13" r="1.5" fill="currentColor" /></svg>',widgets:[{type:"touch_area",label:"Touch Area",tag:"Input",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="5" y="5" width="14" height="14" rx="2" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="2,2" /><circle cx="12" cy="12" r="3" fill="currentColor" /></svg>'},{type:"nav_next_page",label:"Next Page",tag:"Nav",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M10 6l6 6-6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'},{type:"nav_previous_page",label:"Prev Page",tag:"Nav",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M14 6l-6 6 6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'},{type:"nav_reload_page",label:"Reload Page",tag:"Nav",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M23 4v6h-6M1 20v-6h6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'},{type:"template_nav_bar",label:"Navigation Bar",tag:"Template",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><path d="M7 12l-3-3 3-3M17 12l3-3-3-3M12 9v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'}]},{id:"ondevice",name:"On Device Sensors",expanded:!0,widgets:[{type:"battery_icon",label:"Battery",tag:"Sensor",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="7" width="18" height="10" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><rect x="4" y="9" width="8" height="6" fill="currentColor" /><path d="M20 10h2v4h-2" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"wifi_signal",label:"WiFi Signal",tag:"Sensor",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M12 3C7.5 3 3.8 5.4 2 9l2 2c1.3-2.5 4-4.2 8-4.2s6.7 1.7 8 4.2l2-2c-1.8-3.6-5.5-6-10-6z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" /><path d="M12 9c-2.7 0-5.1 1.4-6.5 3.5L7 14c1-1.4 2.8-2.3 5-2.3s4 .9 5 2.3l1.5-1.5C17.1 10.4 14.7 9 12 9z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" /><circle cx="12" cy="18" r="2" fill="currentColor" /></svg>'},{type:"ondevice_temperature",label:"Temperature",tag:"SHT4x",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M12 2a2 2 0 00-2 2v10.1a4 4 0 104 0V4a2 2 0 00-2-2z" fill="none" stroke="currentColor" stroke-width="2" /><circle cx="12" cy="18" r="2" fill="currentColor" /></svg>'},{type:"ondevice_humidity",label:"Humidity",tag:"SHT4x",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M12 2.69l5.66 5.66a8 8 0 11-11.31 0z" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"template_sensor_bar",label:"On-Board Sensor Bar",tag:"New",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><path d="M5 12h2M10 12h2M15 12h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'}]},{id:"lvgl",name:"LVGL Components",expanded:!1,icon:'<svg class="category-svg" viewBox="0 0 24 24" width="16" height="16"><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5l-2.5 1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round" /></svg>',widgets:[{type:"lvgl_obj",label:"Base Object",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"lvgl_label",label:"Label",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><text x="4" y="17" font-size="14" font-weight="bold" fill="currentColor">Aa</text></svg>'},{type:"lvgl_line",label:"LVGL Line",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><line x1="4" y1="12" x2="20" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'},{type:"lvgl_button",label:"Button",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="4" y="8" width="16" height="8" rx="2" fill="currentColor" fill-opacity="0.2" stroke="currentColor" stroke-width="2" /><text x="12" y="16.5" font-size="8" text-anchor="middle" fill="currentColor">BTN</text></svg>'},{type:"lvgl_switch",label:"Switch",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="4" y="8" width="16" height="8" rx="4" fill="none" stroke="currentColor" stroke-width="2" /><circle cx="16" cy="12" r="3" fill="currentColor" /></svg>'},{type:"lvgl_checkbox",label:"Checkbox",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><polyline points="9 12 11 14 15 10" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"lvgl_slider",label:"Slider",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><line x1="4" y1="12" x2="20" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" /><circle cx="12" cy="12" r="3" fill="currentColor" /></svg>'},{type:"lvgl_bar",label:"Bar",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="9" width="20" height="6" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><rect x="3" y="10" width="12" height="4" rx="1" fill="currentColor" /></svg>'},{type:"lvgl_arc",label:"Arc",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M4 18 A 10 10 0 1 1 20 18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'},{type:"lvgl_meter",label:"Meter",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M4 18 A 10 10 0 1 1 20 18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" /><line x1="12" y1="18" x2="16" y2="10" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'},{type:"lvgl_spinner",label:"Spinner",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"lvgl_led",label:"LED",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="6" fill="currentColor" /><circle cx="12" cy="12" r="8" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"lvgl_chart",label:"Chart",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M3 3v18h18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" /><path d="M7 14l4-4 4 4 5-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'},{type:"lvgl_img",label:"Image",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="3" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><circle cx="8.5" cy="8.5" r="1.5" fill="currentColor" /><path d="M21 15l-5-5L11 15l-3-3-5 5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'},{type:"lvgl_qrcode",label:"QR Code",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" fill="currentColor" /><rect x="14" y="3" width="7" height="7" fill="currentColor" /><rect x="3" y="14" width="7" height="7" fill="currentColor" /><rect x="14" y="14" width="3" height="3" fill="currentColor" /></svg>'},{type:"lvgl_dropdown",label:"Dropdown",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="8" width="20" height="8" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><polyline points="16 11 18 13 20 11" fill="currentColor" /></svg>'},{type:"lvgl_roller",label:"Roller",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="6" y="2" width="12" height="20" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><line x1="6" y1="10" x2="18" y2="10" stroke="currentColor" stroke-width="1" /><line x1="6" y1="14" x2="18" y2="14" stroke="currentColor" stroke-width="1" /></svg>'},{type:"lvgl_spinbox",label:"Spinbox",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="4" y="8" width="16" height="8" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><path d="M6 12l2-2 2 2" fill="none" stroke="currentColor" stroke-width="1" /><path d="M14 12l2 2 2-2" fill="none" stroke="currentColor" stroke-width="1" /></svg>'},{type:"lvgl_textarea",label:"Textarea",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" fill="none" stroke="currentColor" stroke-width="2" /><line x1="6" y1="8" x2="14" y2="8" stroke="currentColor" stroke-width="2" /></svg>'},{type:"lvgl_keyboard",label:"Keyboard",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><line x1="6" y1="10" x2="8" y2="10" stroke="currentColor" stroke-width="2" /><line x1="10" y1="10" x2="12" y2="10" stroke="currentColor" stroke-width="2" /></svg>'},{type:"lvgl_buttonmatrix",label:"Btn Matrix",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="7" width="9" height="4" fill="none" stroke="currentColor" stroke-width="1" /><rect x="13" y="7" width="9" height="4" fill="none" stroke="currentColor" stroke-width="1" /><rect x="2" y="13" width="9" height="4" fill="none" stroke="currentColor" stroke-width="1" /><rect x="13" y="13" width="9" height="4" fill="none" stroke="currentColor" stroke-width="1" /></svg>'},{type:"lvgl_tabview",label:"Tabview",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><line x1="2" y1="8" x2="22" y2="8" stroke="currentColor" stroke-width="1" /></svg>'},{type:"lvgl_tileview",label:"Tileview",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="2" width="9" height="9" fill="none" stroke="currentColor" stroke-width="2" /><rect x="13" y="2" width="9" height="9" fill="none" stroke="currentColor" stroke-width="2" /><rect x="2" y="13" width="9" height="9" fill="none" stroke="currentColor" stroke-width="2" /><rect x="13" y="13" width="9" height="9" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"template_nav_bar",label:"Nav Bar (Template)",tag:"Nav",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><path d="M7 12l-3-3 3-3M17 12l3-3-3-3M12 9v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'}]}];async function ot(a){const e=document.getElementById(a);if(!e)return;const n=window.AppState?.settings?.renderingMode||"direct";_.log(`[Palette] Rendering palette for mode: ${n}`),e.innerHTML='<div class="palette-loading" style="padding: 20px; color: #999; text-align: center; font-size: 13px;">Loading widgets...</div>';const i=[];Jt.forEach(t=>{t.widgets.forEach(s=>{i.includes(s.type)||i.push(s.type)})}),_.log(`[Palette] Pre-loading ${i.length} widget plugins...`);try{await Promise.all(i.map(t=>V.load(t)))}catch(t){_.error("[Palette] Failed to load some plugins:",t)}e.innerHTML="",Jt.forEach(t=>{let s=t.expanded;n==="lvgl"?s=t.id==="lvgl":(n==="oepl"||n==="opendisplay")&&(s=t.id==="opendisplay"||t.id==="core"||t.id==="shapes");const o=document.createElement("div");o.className=`widget-category ${s?"expanded":""}`,o.dataset.category=t.id;const r=document.createElement("div");r.className="widget-category-header";let d='<span class="category-icon"></span>';t.icon&&(d+=t.icon),r.innerHTML=`
            ${d}
            <span class="category-name">${t.name}</span>
            ${t.widgets.length>0&&!s?`<span class="category-count">${t.widgets.length}</span>`:""}
        `,r.addEventListener("click",()=>{o.classList.toggle("expanded")});const c=document.createElement("div");c.className="widget-category-items",t.widgets.forEach(l=>{const h=document.createElement("div"),g=V.get(l.type);let m=!0,f="";if(g?.supportedModes)m=g.supportedModes.includes(n),f=`Not supported in ${n} mode`;else if(n==="oepl"||n==="opendisplay"){const w=n==="oepl"?!!g?.exportOEPL:!!g?.exportOpenDisplay,v=t.id==="ondevice"||t.id==="lvgl",I=l.type==="calendar"||l.type==="weather_forecast"||l.type==="graph"||l.type==="quote_rss";m=w&&!v&&!I,f=`Not supported in ${n==="oepl"?"OpenEpaperLink":"OpenDisplay"} mode`}else if(n==="lvgl"){const w=l.type.startsWith("lvgl_"),v=t.id==="inputs";m=w||v,f="Only native LVGL widgets and input controls supported in LVGL mode"}else if(n==="direct"){const w=l.type.startsWith("lvgl_")||l.type.startsWith("oepl_");m=!!g?.export&&!w,f="Not supported in Direct rendering mode"}h.className="item"+(m?"":" incompatible"),h.draggable=m,h.dataset.widgetType=l.type;const y=l.label||g?.name;let b="";l.tag&&(b=`<span class="tag">${l.tag}</span>`),h.innerHTML=`
                ${l.icon}
                <span class="label">${y}</span>
                ${b}
            `,h.title=m?`Add ${y} to canvas`:f,m?h.addEventListener("dragstart",w=>{w.dataTransfer.setData("application/widget-type",l.type),w.dataTransfer.setData("text/plain",l.type),w.dataTransfer.effectAllowed="copy"}):h.addEventListener("click",w=>{w.stopPropagation(),N(()=>Promise.resolve().then(()=>ei),void 0,import.meta.url).then(v=>{v.showToast(f,"warning")})}),c.appendChild(h)}),o.appendChild(r),o.appendChild(c),e.appendChild(o)})}Z(P.SETTINGS_CHANGED,a=>{a&&a.renderingMode!==void 0&&(_.log(`[Palette] Settings changed, refreshing palette for mode: ${a.renderingMode}`),ot("widgetPalette"))});class Vs{constructor(){this.listContainer=null,this.header=null,this.panel=null,this.draggedIndex=null,this.render=this.render.bind(this),this.highlightSelected=this.highlightSelected.bind(this)}init(){if(this.listContainer=document.getElementById("hierarchyList"),this.header=document.getElementById("hierarchyHeader"),this.panel=document.getElementById("hierarchyPanel"),!this.listContainer||!this.header||!this.panel){_.error("[HierarchyView] Required DOM elements not found");return}this.controlsContainer=document.createElement("div"),this.controlsContainer.id="hierarchyControls",this.controlsContainer.className="hierarchy-controls",this.controlsContainer.style.padding="8px 8px",this.controlsContainer.style.borderTop="1px solid var(--border-subtle)",this.panel.appendChild(this.controlsContainer),this.bindEvents(),this.render(),this.renderHeaderActions(),_.log("[HierarchyView] Initialized")}renderHeaderActions(){if(!this.header)return;let e=this.header.querySelector(".hierarchy-header-toggles");if(!e){e=document.createElement("div"),e.className="hierarchy-header-toggles";const n=this.header.querySelector(".chevron");this.header.insertBefore(e,n);const i=this.createHeaderToggle("mdi-lock-outline","Toggle All Locks",()=>{const s=u.getCurrentPage()?.widgets||[],o=s.every(r=>r.locked);s.forEach(r=>u.updateWidget(r.id,{locked:!o}))}),t=this.createHeaderToggle("mdi-eye-outline","Toggle All Visibility",()=>{const s=u.getCurrentPage()?.widgets||[],o=s.every(r=>r.hidden);s.forEach(r=>u.updateWidget(r.id,{hidden:!o}))});e.appendChild(i),e.appendChild(t)}}createHeaderToggle(e,n,i){const t=document.createElement("div");return t.className="h-toggle",t.title=n,t.innerHTML=`<i class="mdi ${e}"></i>`,t.onclick=s=>{s.stopPropagation(),i()},t}bindEvents(){this.header.addEventListener("click",()=>this.toggleCollapse()),Z(P.STATE_CHANGED,this.render),Z(P.PAGE_CHANGED,this.render),Z(P.SELECTION_CHANGED,this.highlightSelected)}toggleCollapse(){const e=this.panel.classList.toggle("hidden"),n=this.header.querySelector(".chevron");n&&(n.style.transform=e?"rotate(-90deg)":"rotate(0deg)")}highlightSelected(){const e=u.selectedWidgetIds||[];this.listContainer.querySelectorAll(".hierarchy-item").forEach(i=>{e.includes(i.dataset.id)?i.classList.add("selected"):i.classList.remove("selected")}),this.renderControls()}render(){const e=u.getCurrentPage();if(!e)return;if(this.listContainer.innerHTML="",!e.widgets||e.widgets.length===0){this.listContainer.innerHTML='<div style="font-size: 10px; color: var(--muted); text-align: center; padding: 12px;">No widgets on this page</div>',this.controlsContainer.style.display="none";return}const n=e.widgets.filter(s=>!s.parentId).reverse(),i=new Map;e.widgets.forEach(s=>{s.parentId&&(i.has(s.parentId)||i.set(s.parentId,[]),i.get(s.parentId).push(s))});const t=(s,o=0)=>{const r=e.widgets.indexOf(s),d=this.createItem(s,r,o);this.listContainer.appendChild(d);const c=i.get(s.id);c&&s.expanded!==!1&&[...c].reverse().forEach(l=>t(l,o+1))};n.forEach(s=>t(s)),this.highlightSelected(),this.renderControls()}createItem(e,n,i=0){const t=document.createElement("div");t.className=`hierarchy-item ${e.hidden?"hidden-widget":""}`,i>0&&t.classList.add("child-item"),(u.selectedWidgetIds||[]).includes(e.id)&&t.classList.add("selected"),t.dataset.id=e.id,t.dataset.index=n,t.draggable=!e.locked,e.locked&&t.classList.add("locked"),t.style.paddingLeft=12+i*20+"px";const o=this.getWidgetIcon(e.type),r=this.getWidgetLabel(e),d=e.type==="group";return t.innerHTML=`
            <div class="hierarchy-item-drag-handle" style="${e.locked?"display:none":""}">
                <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="9" cy="5" r="1"></circle><circle cx="9" cy="12" r="1"></circle><circle cx="9" cy="19" r="1"></circle>
                    <circle cx="15" cy="5" r="1"></circle><circle cx="15" cy="12" r="1"></circle><circle cx="15" cy="19" r="1"></circle>
                </svg>
            </div>
            ${d?`
            <div class="hierarchy-group-toggle ${e.expanded!==!1?"expanded":""}">
                <i class="mdi mdi-chevron-down"></i>
            </div>
            `:'<div style="width: 16px;"></div>'}
            <div class="hierarchy-item-icon">${o}</div>
            <div class="hierarchy-item-label">${r}</div>
            <div class="hierarchy-item-actions">
                <div class="hierarchy-item-action toggle-lock" title="${e.locked?"Unlock":"Lock"}">
                     <i class="mdi ${e.locked?"mdi-lock-outline":"mdi-lock-open-outline"}"></i>
                </div>
                <div class="hierarchy-item-action toggle-visibility" title="Toggle Visibility">
                    <i class="mdi ${e.hidden?"mdi-eye-off-outline":"mdi-eye-outline"}"></i>
                </div>
                <div class="hierarchy-item-action delete-widget danger" title="Delete Widget">
                    <i class="mdi mdi-delete-outline"></i>
                </div>
            </div>
        `,d&&t.querySelector(".hierarchy-group-toggle").addEventListener("click",l=>{u.updateWidget(e.id,{expanded:e.expanded===!1}),l.stopPropagation()}),t.querySelector(".hierarchy-item-label").addEventListener("click",l=>{if(u.selectedWidgetIds.includes(e.id)){const h=prompt("Rename:",r);h!==null&&h!==""&&h!==r&&u.updateWidget(e.id,{title:h}),l.stopPropagation();return}}),t.addEventListener("click",l=>{const h=l.ctrlKey||l.shiftKey;u.selectWidget(e.id,h),l.stopPropagation()}),t.querySelector(".toggle-lock").addEventListener("click",l=>{u.updateWidget(e.id,{locked:!e.locked}),l.stopPropagation()}),t.querySelector(".toggle-visibility").addEventListener("click",l=>{u.updateWidget(e.id,{hidden:!e.hidden}),l.stopPropagation()}),t.querySelector(".delete-widget").addEventListener("click",l=>{confirm(`Delete widget "${r}"?`)&&u.deleteWidget(e.id),l.stopPropagation()}),t.addEventListener("dragstart",l=>{this.draggedIndex=n,t.classList.add("dragging"),l.dataTransfer.setData("application/widget-id",e.id),l.dataTransfer.effectAllowed="move"}),t.addEventListener("dragend",()=>{t.classList.remove("dragging"),this.draggedIndex=null,this.listContainer.querySelectorAll(".hierarchy-item").forEach(h=>h.classList.remove("drag-over"))}),t.addEventListener("dragover",l=>{l.preventDefault(),l.dataTransfer.dropEffect="move",t.classList.add("drag-over")}),t.addEventListener("dragleave",()=>{t.classList.remove("drag-over")}),t.addEventListener("drop",l=>{l.preventDefault();const h=l.dataTransfer.getData("application/widget-id"),g=t.dataset.id;if(h===g)return;const m=u.getWidgetById(g);if(!m)return;m.type==="group"?u.updateWidget(h,{parentId:g,expanded:!0}):u.updateWidget(h,{parentId:m.parentId||null});const f=parseInt(t.dataset.index);this.draggedIndex!==null&&u.reorderWidget(u.currentPageIndex,this.draggedIndex,f)}),t}renderControls(){const e=u.getSelectedWidgets();if(e.length===0){this.controlsContainer.style.display="none";return}this.controlsContainer.style.display="block",this.controlsContainer.innerHTML="";const n=d=>{const c=document.createElement("div");c.style.fontSize="10px",c.style.color="var(--muted)",c.style.marginBottom="6px",c.style.fontWeight="600",c.style.marginTop="8px",c.textContent=d,this.controlsContainer.appendChild(c)},i=()=>{const d=document.createElement("div");return d.style.display="flex",d.style.gap="4px",this.controlsContainer.appendChild(d),d};n("GROUPING");const t=i(),s=e.some(d=>d.type==="group"||d.parentId),o=document.createElement("button");o.className="btn btn-secondary",o.innerHTML='<i class="mdi mdi-group" style="margin-right:4px"></i>Group',o.style.flex="1",o.style.fontSize="10px",o.disabled=e.length<2||s,o.onclick=()=>u.groupSelection(),t.appendChild(o);const r=document.createElement("button");if(r.className="btn btn-secondary",r.innerHTML='<i class="mdi mdi-ungroup" style="margin-right:4px"></i>Ungroup',r.style.flex="1",r.style.fontSize="10px",r.disabled=!s,r.onclick=()=>u.ungroupSelection(),t.appendChild(r),e.length===1){const d=e[0];n("LAYER ORDER");const c=i();[{label:"Front",icon:"mdi-arrange-bring-to-front",action:()=>this.moveToFront(d)},{label:"Back",icon:"mdi-arrange-send-to-back",action:()=>this.moveToBack(d)},{label:"Up",icon:"mdi-arrow-up",action:()=>this.moveUp(d)},{label:"Down",icon:"mdi-arrow-down",action:()=>this.moveDown(d)}].forEach(h=>{const g=document.createElement("button");g.className="btn btn-secondary",g.innerHTML=`<i class="mdi ${h.icon}"></i>`,g.title=h.label,g.style.flex="1",g.style.fontSize="12px",g.style.padding="4px",g.onclick=()=>h.action(),c.appendChild(g)})}}moveToFront(e){const n=u.getCurrentPage(),i=n.widgets.findIndex(t=>t.id===e.id);i>-1&&i<n.widgets.length-1&&(n.widgets.splice(i,1),n.widgets.push(e),u.setPages(u.pages))}moveToBack(e){const n=u.getCurrentPage(),i=n.widgets.findIndex(t=>t.id===e.id);i>0&&(n.widgets.splice(i,1),n.widgets.unshift(e),u.setPages(u.pages))}moveUp(e){const n=u.getCurrentPage(),i=n.widgets.findIndex(t=>t.id===e.id);i>-1&&i<n.widgets.length-1&&([n.widgets[i],n.widgets[i+1]]=[n.widgets[i+1],n.widgets[i]],u.setPages(u.pages))}moveDown(e){const n=u.getCurrentPage(),i=n.widgets.findIndex(t=>t.id===e.id);i>0&&([n.widgets[i],n.widgets[i-1]]=[n.widgets[i-1],n.widgets[i]],u.setPages(u.pages))}getWidgetLabel(e){let n=e.props?.name||e.props?.title||e.props?.text||e.title;if(!n||n===""){const i=V.get(e.type);n=i?i.name:e.type}if(n===e.type||V.get(e.type)&&n===V.get(e.type).name){const i=e.id.split("_").pop();n=`${n} (${i})`}return n}getWidgetIcon(e){return`<i class="mdi ${{text:"mdi-format-text",sensor_text:"mdi-numeric",icon:"mdi-emoticon-outline",image:"mdi-image",qr_code:"mdi-qrcode",line:"mdi-vector-line",lvgl_line:"mdi-vector-line",rect:"mdi-square-outline",shape_rect:"mdi-square-outline",arc:"mdi-circle-outline",shape_circle:"mdi-circle-outline",bar:"mdi-chart-gantt",button:"mdi-gesture-tap-button",checkbox:"mdi-checkbox-marked-outline",calendar:"mdi-calendar",weather_forecast:"mdi-weather-partly-cloudy",datetime:"mdi-clock-outline",graph:"mdi-chart-timeline-variant",touch_area:"mdi-fingerprint",group:"mdi-folder-outline"}[e]||"mdi-widgets-outline"}"></i>`}}window.aiService=new Us;class Ys{constructor(){try{_.log("[App] Constructor started"),this.sidebar=new Xi,_.log("[App] Sidebar created"),this.canvas=new ys,_.log("[App] Canvas created"),this.propertiesPanel=new Es,_.log("[App] PropertiesPanel created"),this.hierarchyView=new Vs,_.log("[App] HierarchyView created"),this.deviceSettings=new Rs,_.log("[App] DeviceSettings created"),this.editorSettings=new Ws,_.log("[App] EditorSettings created"),this.pageSettings=new Hs,_.log("[App] PageSettings created"),this.keyboardHandler=new _i,_.log("[App] KeyboardHandler created"),this.llmPrompt=window.llmPrompt,_.log("[App] LLMPrompt linked"),this.quickSearch=new zs,window.QuickSearch=this.quickSearch,_.log("[App] QuickSearch initialized"),this.adapter=this.createAdapter(),_.log("[App] Adapter initialized:",this.adapter.constructor.name),this.snippetManager=new js(this.adapter),_.log("[App] SnippetManager initialized"),window.layoutManager&&(this.layoutManager=window.layoutManager,_.log("[App] LayoutManager linked")),this.init()}catch(e){_.error("[App] Critical Error in Constructor:",e)}}async init(){_.log("[App] Initializing ESPHome Designer Designer..."),_.log("[App] AppState:",window.AppState),this.isInitializing=!0,await ot("widgetPalette"),this.sidebar.init(),this.propertiesPanel.init(),this.hierarchyView.init(),this.deviceSettings.init(),this.editorSettings.init(),this.quickSearch.discoverWidgets(),await Be();try{localStorage.getItem("reterminal-editor-theme")==="light"?(u.updateSettings({editor_light_mode:!0}),this.editorSettings.applyEditorTheme(!0)):this.editorSettings.applyEditorTheme(!1)}catch(e){_.log("Could not load theme preference:",e)}this.pageSettings.init(),this.llmPrompt&&this.llmPrompt.init(),this.layoutManager&&this.layoutManager.init(),this.setupAutoSave(),this.bindGlobalButtons();try{q()?(_.log("HA Backend detected attempt. Loading hardware then layout..."),await Be(),await $i(),await ge()):(_.log("Running in standalone/offline mode."),this.loadFromLocalStorage())}catch(e){_.error("[App] Failed to load from backend, falling back to local storage:",e),this.loadFromLocalStorage()}window.AppState&&typeof window.AppState.updateLayoutIndicator=="function"&&window.AppState.updateLayoutIndicator(),setTimeout(()=>{this.canvas&&(_.log("[App] Forcing initial canvas centering..."),this.canvas.focusPage(u.currentPageIndex,!1))},100),_.log("Initialization complete."),this.isInitializing=!1}bindGlobalButtons(){const e=document.getElementById("saveLayoutBtn");e&&e.addEventListener("click",()=>{q()?Ie().then(()=>z("Layout saved to Home Assistant","success")).catch(r=>z(`Save failed: ${r.message}`,"error")):Ss()});const n=document.getElementById("loadLayoutBtn");n&&n.addEventListener("change",Cs);const i=document.getElementById("importProjectBtn");i&&n&&i.addEventListener("click",()=>{n.click()});const t=document.getElementById("deviceSettingsBtn");t?(_.log("Device Settings button found, binding click listener."),t.addEventListener("click",()=>{_.log("Device Settings button clicked."),this.deviceSettings?this.deviceSettings.open():_.error("DeviceSettings instance not found on App.")})):_.error("Device Settings button NOT found in DOM.");const s=document.getElementById("editorSettingsBtn");s&&s.addEventListener("click",()=>{this.editorSettings.open()});const o=document.getElementById("aiPromptBtn");o&&o.addEventListener("click",()=>{this.llmPrompt?this.llmPrompt.open():_.error("LLMPrompt instance not found.")})}loadFromLocalStorage(){try{const e=u.loadFromLocalStorage();e?(_.log("[App] Found saved layout in localStorage, loading..."),le(e)):_.log("[App] No saved layout in localStorage, starting fresh.")}catch(e){_.error("[App] Error loading from local storage:",e)}}setupAutoSave(){let e=null;const n=2e3;N(async()=>{const{on:i,EVENTS:t}=await Promise.resolve().then(()=>Ti);return{on:i,EVENTS:t}},void 0,import.meta.url).then(({on:i,EVENTS:t})=>{i(t.STATE_CHANGED,()=>{const s=u.settings.renderingMode;if(this.adapter&&this.adapter.mode!==s&&this.refreshAdapter(),this.isInitializing){_.log("[AutoSave] Skipping during initialization...");return}e&&clearTimeout(e),e=setTimeout(()=>{q()?(_.log("[AutoSave] Triggering background save to HA..."),Ie().catch(()=>{})):(_.log("[AutoSave] Saving to local storage..."),u.saveToLocalStorage())},n)}),i(t.STATE_CHANGED,()=>{this.isInitializing||ot("widgetPalette")})})}createAdapter(){const e=u.settings.renderingMode||"direct";let n;return e==="oepl"?n=new wi:e==="opendisplay"?n=new vi:n=new bi,n.mode=e,n}refreshAdapter(){_.log("[App] Refreshing adapter due to mode change..."),this.adapter=this.createAdapter(),this.snippetManager&&(this.snippetManager.adapter=this.adapter),emit(EVENTS.STATE_CHANGED)}}document.addEventListener("DOMContentLoaded",()=>{const a=new Ys;window.app=a,window.openDeviceSettings=()=>a.deviceSettings?.open(),window.openEditorSettingsModal=e=>a.editorSettings?.open(e),window.pageSettings=a.pageSettings,window.ESPHomeDesigner=window.ESPHomeDesigner||{},window.ESPHomeDesigner.app=a,window.ESPHomeDesigner.ui={sidebar:a.sidebar,canvas:a.canvas,properties:a.propertiesPanel}});export{P as E,Js as a,Ks as d,O as e,qs as f,Xs as g,ui as i};
