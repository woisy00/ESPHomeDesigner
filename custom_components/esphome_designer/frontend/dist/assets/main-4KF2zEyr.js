(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const n of t)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function i(t){const n={};return t.integrity&&(n.integrity=t.integrity),t.referrerPolicy&&(n.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?n.credentials="include":t.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(t){if(t.ep)return;t.ep=!0;const n=i(t);fetch(t.href,n)}})();function we(){return"w_"+Date.now().toString(36)+Math.random().toString(36).substr(2,5)}typeof crypto<"u"&&!crypto.randomUUID?crypto.randomUUID=function(){return("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,l=>(l^crypto.getRandomValues(new Uint8Array(1))[0]&15>>l/4).toString(16))}:typeof crypto>"u"&&(window.crypto={randomUUID:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,l=>{const e=Math.random()*16|0;return(l==="x"?e:e&3|8).toString(16)}),getRandomValues:l=>l.map(()=>Math.floor(Math.random()*256))});function ci(l,e){let i;return function(...t){const n=()=>{clearTimeout(i),l(...t)};clearTimeout(i),i=setTimeout(n,e)}}function nt(l){return JSON.parse(JSON.stringify(l))}window.generateId=we;window.debounce=ci;window.deepClone=nt;const pi=localStorage.getItem("esphome-designer-debug")==="true",_={log:(...l)=>pi&&console.log("[ESPHomeDesigner]",...l),warn:(...l)=>console.warn("[ESPHomeDesigner]",...l),error:(...l)=>console.error("[ESPHomeDesigner]",...l)};function ft(){let l=yt();if(l)return l=l.trim(),l.endsWith("/")&&(l=l.slice(0,-1)),l&&!l.includes("/api/")&&(l+="/api/esphome_designer"),l;try{const e=window.location;return e.protocol==="file:"?null:e.hostname==="homeassistant"||e.hostname==="hassio"||e.pathname.includes("/api/")||e.pathname.includes("/local/")||e.pathname.includes("/hacsfiles/")||e.pathname.includes("/esphome-designer")?`${e.origin}/api/esphome_designer`:null}catch{return null}}function yt(){try{return localStorage.getItem("ha_manual_url")}catch{return null}}function zt(l){try{if(l){let e=l.trim();e.endsWith("/")&&(e=e.slice(0,-1)),e.includes("/api/")||(e+="/api/esphome_designer"),localStorage.setItem("ha_manual_url",e)}else localStorage.removeItem("ha_manual_url")}catch(e){_.error("Failed to save HA URL:",e)}}function _t(){try{return localStorage.getItem("ha_llat_token")}catch{return null}}function Gt(l){try{l?localStorage.setItem("ha_llat_token",l):localStorage.removeItem("ha_llat_token")}catch(e){_.error("Failed to save HA Token:",e)}}let Z=ft();function ot(){Z=ft()}function q(){return!!Z}window.detectHaBackendBaseUrl=ft;window.getHaManualUrl=yt;window.setHaManualUrl=zt;window.getHaToken=_t;window.setHaToken=Gt;window.HA_API_BASE=Z;window.refreshHaBaseUrl=ot;window.hasHaBackend=q;function hi(l){const e=document.getElementById("importSnippetError");e&&(e.textContent=l||"")}function G(l,e="info",i=3e3){let o=document.getElementById("toast-container");o||(o=document.createElement("div"),o.id="toast-container",o.style.position="fixed",o.style.bottom="20px",o.style.right="20px",o.style.zIndex="9999",document.body.appendChild(o));const t=document.createElement("div");t.className="toast",e==="error"?t.style.background="rgba(255, 0, 0, 0.8)":e==="success"?t.style.background="rgba(0, 128, 0, 0.8)":t.style.background="rgba(0,0,0,0.8)",t.textContent=l,t.style.color="white",t.style.padding="10px 20px",t.style.borderRadius="4px",t.style.marginTop="10px",t.style.opacity="0",t.style.transition="opacity 0.3s",o.appendChild(t),requestAnimationFrame(()=>{t.style.opacity="1"}),setTimeout(()=>{t.style.opacity="0",setTimeout(()=>{t.remove()},300)},i)}const ui=Object.freeze(Object.defineProperty({__proto__:null,setImportError:hi,showToast:G},Symbol.toStringTag,{value:"Module"})),gi="modulepreload",mi=function(l,e){return new URL(l,e).href},Tt={},W=function(e,i,o){let t=Promise.resolve();if(i&&i.length>0){const s=document.getElementsByTagName("link"),r=document.querySelector("meta[property=csp-nonce]"),d=r?.nonce||r?.getAttribute("nonce");t=Promise.allSettled(i.map(c=>{if(c=mi(c,o),c in Tt)return;Tt[c]=!0;const a=c.endsWith(".css"),u=a?'[rel="stylesheet"]':"";if(!!o)for(let f=s.length-1;f>=0;f--){const v=s[f];if(v.href===c&&(!a||v.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${c}"]${u}`))return;const g=document.createElement("link");if(g.rel=a?"stylesheet":gi,a||(g.as="script"),g.crossOrigin="",g.href=c,d&&g.setAttribute("nonce",d),document.head.appendChild(g),a)return new Promise((f,v)=>{g.addEventListener("load",f),g.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${c}`)))})}))}function n(s){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=s,window.dispatchEvent(r),!r.defaultPrevented)throw s}return t.then(s=>{for(const r of s||[])r.status==="rejected"&&n(r.reason);return e().catch(n)})},Ie=new EventTarget,A={STATE_CHANGED:"state-changed",SELECTION_CHANGED:"selection-changed",PAGE_CHANGED:"page-changed",HISTORY_CHANGED:"history-changed",SETTINGS_CHANGED:"settings-changed",LAYOUT_IMPORTED:"layout-imported",ENTITIES_LOADED:"entities-loaded",ZOOM_CHANGED:"zoom-changed"};function D(l,e={}){Ie.dispatchEvent(new CustomEvent(l,{detail:e}))}function Q(l,e){Ie.addEventListener(l,i=>e(i.detail))}function jt(l,e){Ie.removeEventListener(l,e)}window.EventBus=Ie;window.EVENTS=A;window.emit=D;window.on=Q;window.off=jt;const fi=Object.freeze(Object.defineProperty({__proto__:null,EVENTS:A,EventBus:Ie,emit:D,off:jt,on:Q},Symbol.toStringTag,{value:"Module"})),qe={WHITE:"#FFFFFF",BLACK:"#000000",GRAY:"#808080",GREY:"#808080",RED:"#FF0000",GREEN:"#00FF00",BLUE:"#0000FF",YELLOW:"#FFFF00",ORANGE:"#FFA500"},Ut={GRID_SIZE:10,SNAP_THRESHOLD:10,SIDEBAR_WIDTH:300,PROPERTIES_WIDTH:350},Xe={TOP_LEFT:"TOP_LEFT",TOP_CENTER:"TOP_CENTER",TOP_RIGHT:"TOP_RIGHT",CENTER_LEFT:"CENTER_LEFT",CENTER:"CENTER",CENTER_RIGHT:"CENTER_RIGHT",BOTTOM_LEFT:"BOTTOM_LEFT",BOTTOM_CENTER:"BOTTOM_CENTER",BOTTOM_RIGHT:"BOTTOM_RIGHT"},bt={LANDSCAPE:"landscape",PORTRAIT:"portrait"},vt={snapEnabled:!0,showGrid:!0,showRulers:!1,gridOpacity:8,editor_light_mode:!1,aiProvider:"gemini",aiModelGemini:"gemini-1.5-flash",aiModelOpenAI:"gpt-4o",aiModelOpenRouter:"",aiModelFilter:"",extendedLatinGlyphs:!1,autoCycleEnabled:!1,autoCycleIntervalS:30,refreshInterval:600,manualRefreshOnly:!1,darkMode:!1,invertedColors:!1,lcdEcoStrategy:"backlight_off",sleepEnabled:!1,sleepStartHour:0,sleepEndHour:5,deepSleepEnabled:!1,deepSleepInterval:600,dailyRefreshEnabled:!1,dailyRefreshTime:"08:00",noRefreshStartHour:null,noRefreshEndHour:null,renderingMode:"lvgl"},Yt={X:40,Y:40,WIDTH:200,HEIGHT:60},wt=50,Vt={RSS:300,ENTITIES:60},qt=5e3,xt={white:"COLOR_WHITE",black:"COLOR_BLACK",gray:"Color(160, 160, 160)",grey:"Color(160, 160, 160)",red:"COLOR_RED",green:"COLOR_GREEN",blue:"COLOR_BLUE",yellow:"COLOR_YELLOW",orange:"COLOR_ORANGE"},Et=800,St=480,me=10,Xt=10;window.ESPHomeDesigner=window.ESPHomeDesigner||{version:"0.9.0",constants:{COLORS:qe,UI_DEFAULTS:Ut,ALIGNMENT:Xe,ORIENTATIONS:bt,DEFAULT_PREFERENCES:vt,WIDGET_DEFAULTS:Yt,HISTORY_LIMIT:wt,CACHE_TTL:Vt,ENTITY_LIMIT:qt,ESPHOME_COLOR_MAPPING:xt,DEFAULT_CANVAS_WIDTH:Et,DEFAULT_CANVAS_HEIGHT:St,SNAP_DISTANCE:me,GRID_SIZE:Xt}};window.COLORS=qe;window.UI_DEFAULTS=Ut;window.ALIGNMENT=Xe;window.ORIENTATIONS=bt;window.DEFAULT_PREFERENCES=vt;window.WIDGET_DEFAULTS=Yt;window.HISTORY_LIMIT=wt;window.CACHE_TTL=Vt;window.ENTITY_LIMIT=qt;window.ESPHOME_COLOR_MAPPING=xt;window.DEFAULT_CANVAS_WIDTH=Et;window.DEFAULT_CANVAS_HEIGHT=St;window.SNAP_DISTANCE=me;window.GRID_SIZE=Xt;class yi{constructor(){this.state={pages:[],currentPageIndex:0,deviceName:"Layout 1",deviceModel:"reterminal_e1001",currentLayoutId:"reterminal_e1001",customHardware:{},widgetsById:new Map},this.reset()}reset(){this.state.pages=[{id:"page_0",name:"Overview",layout:null,widgets:[]}],this.state.currentPageIndex=0,this.rebuildWidgetsIndex()}get pages(){return this.state.pages}get currentPageIndex(){return this.state.currentPageIndex}get deviceName(){return this.state.deviceName}get deviceModel(){return this.state.deviceModel}get currentLayoutId(){return this.state.currentLayoutId}getCurrentPage(){return this.state.pages[this.state.currentPageIndex]||this.state.pages[0]}getWidgetById(e){return this.state.widgetsById.get(e)}rebuildWidgetsIndex(){this.state.widgetsById.clear();for(const e of this.state.pages)for(const i of e.widgets)this.state.widgetsById.set(i.id,i)}setPages(e){this.state.pages=e,this.rebuildWidgetsIndex(),D(A.STATE_CHANGED)}setCurrentPageIndex(e,i={}){e>=0&&e<this.state.pages.length&&(this.state.currentPageIndex=e,D(A.PAGE_CHANGED,{index:e,...i}))}reorderPage(e,i){if(e<0||e>=this.state.pages.length||i<0||i>=this.state.pages.length)return;const[o]=this.state.pages.splice(e,1);this.state.pages.splice(i,0,o),this.state.currentPageIndex===e?this.state.currentPageIndex=i:e<this.state.currentPageIndex&&i>=this.state.currentPageIndex?this.state.currentPageIndex--:e>this.state.currentPageIndex&&i<=this.state.currentPageIndex&&this.state.currentPageIndex++,D(A.STATE_CHANGED),D(A.PAGE_CHANGED,{index:this.state.currentPageIndex})}addPage(e=null){const i=this.state.pages.length,o={id:`page_${Date.now()}_${i}`,name:`Page ${i+1}`,widgets:[]},t=e!==null?e:this.state.pages.length;return this.state.pages.splice(t,0,o),e!==null&&e<=this.state.currentPageIndex?this.state.currentPageIndex++:e===null&&(this.state.currentPageIndex=this.state.pages.length-1),this.rebuildWidgetsIndex(),D(A.STATE_CHANGED),D(A.PAGE_CHANGED,{index:this.state.currentPageIndex}),o}deletePage(e){e<0||e>=this.state.pages.length||(this.state.pages.splice(e,1),this.state.currentPageIndex>=this.state.pages.length&&(this.state.currentPageIndex=Math.max(0,this.state.pages.length-1)),this.rebuildWidgetsIndex(),D(A.STATE_CHANGED),D(A.PAGE_CHANGED,{index:this.state.currentPageIndex}))}addWidget(e,i=null){const o=i!==null?i:this.state.currentPageIndex;(this.state.pages[o]||this.getCurrentPage()).widgets.push(e),this.state.widgetsById.set(e.id,e),D(A.STATE_CHANGED)}updateWidget(e,i){const o=this.getWidgetById(e);o&&(Object.assign(o,i),D(A.STATE_CHANGED))}deleteWidgets(e){const i=this.getCurrentPage();let o=!1;for(const t of e){const n=i.widgets.findIndex(s=>s.id===t);n!==-1&&(i.widgets.splice(n,1),this.state.widgetsById.delete(t),o=!0)}o&&D(A.STATE_CHANGED)}moveWidgetToPage(e,i,o=null,t=null){if(i<0||i>=this.state.pages.length)return!1;const n=this.state.pages[i],s=new Set,r=[];let d=e,c=this.state.widgetsById.get(e);if(c&&c.parentId){let m=c;for(;m.parentId;){const g=this.state.widgetsById.get(m.parentId);if(g)m=g;else break}d=m.id}const a=m=>{if(s.has(m))return;let g=null,f=null;for(const b of this.state.pages)if(g=b.widgets.find(E=>E.id===m),g){f=b;break}if(!g||!f||f===n)return;s.add(m),r.push({widget:g,sourcePage:f}),f.widgets.filter(b=>b.parentId===m).forEach(b=>a(b.id))};if(a(d),r.length===0)return!1;r.forEach((m,g)=>{const{widget:f,sourcePage:v}=m,b=v.widgets.indexOf(f);if(b!==-1&&v.widgets.splice(b,1),g===0&&f.parentId&&!s.has(f.parentId)&&(f.parentId=null),g===0){let E=0,y=0;if(o!==null&&t!==null&&(E=o-f.x,y=t-f.y,f.x=o,f.y=t),E!==0||y!==0)for(let S=1;S<r.length;S++){const T=r[S].widget;T.x+=E,T.y+=y}}n.widgets.push(f)});const u=this.getCanvasDimensions();for(const m of s){const g=this.state.widgetsById.get(m);if(!g||g.parentId&&s.has(g.parentId))continue;const f=g.x,v=g.y;g.x=Math.max(0,Math.min(u.width-(g.width||50),g.x)),g.y=Math.max(0,Math.min(u.height-(g.height||50),g.y));const b=g.x-f,E=g.y-v;if(b!==0||E!==0)for(const y of s){const S=this.state.widgetsById.get(y);S&&S.parentId===g.id&&(S.x+=b,S.y+=E)}}return this.rebuildWidgetsIndex(),D(A.STATE_CHANGED),!0}reorderWidget(e,i,o){const t=this.state.pages[e];if(!t)return;const n=t.widgets;if(i<0||i>=n.length||o<0||o>=n.length)return;const[s]=n.splice(i,1);n.splice(o,0,s),D(A.STATE_CHANGED)}clearCurrentPage(e=!1){const i=this.getCurrentPage();if(!i)return{deleted:0,preserved:0};const o=[],t=[];return i.widgets.forEach(n=>{e&&n.locked?t.push(n):o.push(n)}),i.widgets=t,o.forEach(n=>this.state.widgetsById.delete(n.id)),o.length>0&&D(A.STATE_CHANGED),{deleted:o.length,preserved:t.length}}setDeviceSettings(e,i){e&&(this.state.deviceName=e),i&&(this.state.deviceModel=i,window.currentDeviceModel=i),D(A.SETTINGS_CHANGED)}getCanvasDimensions(e){const i=this.state.deviceModel||"reterminal_e1001",o=F&&F[i]?F[i]:null;let t=Et,n=St;if(o)o.resolution&&(t=o.resolution.width,n=o.resolution.height);else if(i==="custom"&&this.state.customHardware){const s=this.state.customHardware;s.resWidth&&s.resHeight&&(t=s.resWidth,n=s.resHeight)}return e===bt.PORTRAIT?{width:Math.min(t,n),height:Math.max(t,n)}:{width:Math.max(t,n),height:Math.min(t,n)}}getPagesPayload(){return{pages:this.state.pages,deviceName:this.state.deviceName,deviceModel:this.state.deviceModel,currentLayoutId:this.state.currentLayoutId,customHardware:this.state.customHardware}}getCanvasShape(){const e=F[this.state.deviceModel];return e&&e.shape?e.shape:this.state.customHardware&&this.state.customHardware.shape?this.state.customHardware.shape:"rect"}}class _i{constructor(){this.state={selectedWidgetIds:[],clipboardWidgets:[],zoomLevel:1,panX:0,panY:0},this.historyStack=[],this.historyIndex=-1}get selectedWidgetIds(){return this.state.selectedWidgetIds}get clipboardWidgets(){return this.state.clipboardWidgets}get zoomLevel(){return this.state.zoomLevel}setZoomLevel(e){this.state.zoomLevel=Math.max(.05,Math.min(5,e)),D(A.ZOOM_CHANGED,{zoomLevel:this.state.zoomLevel})}setSelectedWidgetIds(e){this.state.selectedWidgetIds=e||[],D(A.SELECTION_CHANGED,{widgetIds:this.state.selectedWidgetIds})}selectWidget(e,i=!1){if(i){const o=this.state.selectedWidgetIds.indexOf(e);o===-1?e&&this.state.selectedWidgetIds.push(e):this.state.selectedWidgetIds.splice(o,1)}else this.state.selectedWidgetIds=e?[e]:[];D(A.SELECTION_CHANGED,{widgetIds:this.state.selectedWidgetIds})}copyWidgets(e){this.state.clipboardWidgets=e.map(i=>nt(i)),_.log("[EditorStore] Widgets copied to clipboard:",this.state.clipboardWidgets.length)}recordHistory(e){const i=nt(e);if(this.historyIndex>=0){const o=this.historyStack[this.historyIndex];if(JSON.stringify(o)===JSON.stringify(i))return}this.historyIndex<this.historyStack.length-1&&(this.historyStack=this.historyStack.slice(0,this.historyIndex+1)),this.historyStack.push(i),this.historyIndex++,this.historyStack.length>wt&&(this.historyStack.shift(),this.historyIndex--),D(A.HISTORY_CHANGED,{canUndo:this.canUndo(),canRedo:this.canRedo()})}undo(){return this.canUndo()?(this.historyIndex--,this.historyStack[this.historyIndex]):null}redo(){return this.canRedo()?(this.historyIndex++,this.historyStack[this.historyIndex]):null}canUndo(){return this.historyIndex>0}canRedo(){return this.historyIndex<this.historyStack.length-1}}class bi{constructor(){this.state={...vt}}get snapEnabled(){return this.state.snapEnabled}get showGrid(){return this.state.showGrid}get showRulers(){return this.state.showRulers}get gridOpacity(){return this.state.gridOpacity}get editor_light_mode(){return this.state.editor_light_mode}update(e){this.state={...this.state,...e},D(A.SETTINGS_CHANGED,this.state),_.log("[PreferencesStore] Settings updated")}setSnapEnabled(e){this.state.snapEnabled=e,D(A.SETTINGS_CHANGED,{snapEnabled:e})}setShowGrid(e){this.state.showGrid=e,D(A.SETTINGS_CHANGED,{showGrid:e})}setShowRulers(e){this.state.showRulers=e,D(A.SETTINGS_CHANGED,{showRulers:e})}}class vi{constructor(){this.keys={ai_api_key_gemini:"",ai_api_key_openai:"",ai_api_key_openrouter:""},this.loadFromLocalStorage()}get(e){return this.keys[e]}set(e,i){e in this.keys&&(this.keys[e]=i,this.saveToLocalStorage())}saveToLocalStorage(){try{const e={};Object.keys(this.keys).forEach(i=>{i.startsWith("ai_api_key_")&&(e[i]=this.keys[i])}),localStorage.setItem("esphome-designer-ai-keys",JSON.stringify(e))}catch(e){_.warn("[SecretsStore] Failed to save AI keys to localStorage:",e)}}loadFromLocalStorage(){try{const e=localStorage.getItem("esphome-designer-ai-keys");if(e){const i=JSON.parse(e);this.keys={...this.keys,...i},_.log("[SecretsStore] AI keys loaded from local storage")}}catch(e){_.warn("[SecretsStore] Failed to load AI keys from localStorage:",e)}}}class wi{constructor(){this.project=new yi,this.editor=new _i,this.preferences=new bi,this.secrets=new vi,this._isRestoringHistory=!1,this.recordHistory()}reset(){this.project.reset(),this.editor.state.selectedWidgetIds=[],this.recordHistory()}get pages(){return this.project.pages}get currentPageIndex(){return this.project.currentPageIndex}get selectedWidgetId(){return this.editor.selectedWidgetIds[0]||null}get selectedWidgetIds(){return this.editor.selectedWidgetIds}get settings(){return{...this.preferences.state,device_name:this.project.deviceName,device_model:this.project.deviceModel,...this.secrets.keys}}get deviceName(){return this.project.deviceName}get deviceModel(){return this.project.deviceModel}get currentLayoutId(){return this.project.currentLayoutId}get snapEnabled(){return this.preferences.snapEnabled}get showGrid(){return this.preferences.showGrid}get showRulers(){return this.preferences.showRulers}get zoomLevel(){return this.editor.zoomLevel}getCurrentPage(){return this.project.getCurrentPage()}getWidgetById(e){return this.project.getWidgetById(e)}getSelectedWidget(){return this.project.getWidgetById(this.editor.selectedWidgetIds[0])}getSelectedWidgets(){return this.editor.selectedWidgetIds.map(e=>this.getWidgetById(e)).filter(e=>!!e)}getSelectedProfile(){return F[this.project.deviceModel]||null}getCanvasDimensions(){return this.project.getCanvasDimensions(this.preferences.state.orientation)}getCanvasShape(){return this.project.getCanvasShape()}getPagesPayload(){return{...this.project.getPagesPayload(),...this.settings}}getSettings(){return this.settings}setSettings(e){this.updateSettings(e)}saveToLocalStorage(){q()||localStorage.setItem("esphome-designer-layout",JSON.stringify(this.getPagesPayload()))}loadFromLocalStorage(){try{const e=localStorage.getItem("esphome-designer-layout");return e?JSON.parse(e):null}catch{return null}}setPages(e){this.project.setPages(e),this.recordHistory(),D(A.STATE_CHANGED)}reorderWidget(e,i,o){this.project.reorderWidget(e,i,o),this.syncWidgetOrderWithHierarchy(),this.recordHistory(),D(A.STATE_CHANGED)}setCurrentPageIndex(e,i={}){this.project.setCurrentPageIndex(e,i),this.editor.setSelectedWidgetIds([]),D(A.STATE_CHANGED)}reorderPage(e,i){this.project.reorderPage(e,i),this.recordHistory()}addPage(e=null){const i=this.project.addPage(e);return this.recordHistory(),i}deletePage(e){this.project.deletePage(e),this.recordHistory()}selectWidget(e,i){if(!e){this.editor.selectWidget(null,i);return}const o=this.getWidgetById(e),t=o?.parentId||(o?.type==="group"?o.id:null);if(t){const r=this.pages[this.currentPageIndex].widgets.filter(d=>d.parentId===t||d.id===t).map(d=>d.id);if(i)if(r.some(c=>this.editor.selectedWidgetIds.includes(c))){const c=this.editor.selectedWidgetIds.filter(a=>!r.includes(a));this.editor.setSelectedWidgetIds(c)}else this.editor.setSelectedWidgetIds([...new Set([...this.editor.selectedWidgetIds,...r])]);else this.editor.setSelectedWidgetIds(r)}else this.editor.selectWidget(e,i)}selectWidgets(e){this.editor.setSelectedWidgetIds(e)}selectAllWidgets(){const e=this.getCurrentPage();if(!e||!e.widgets)return;const i=e.widgets.map(o=>o.id);this.selectWidgets(i)}updateSettings(e){const i={},o={};Object.keys(e).forEach(t=>{t.startsWith("ai_api_key_")?i[t]=e[t]:o[t]=e[t]}),Object.keys(i).length&&Object.entries(i).forEach(([t,n])=>this.secrets.set(t,n)),this.preferences.update(o),e.device_name&&(this.project.state.deviceName=e.device_name),e.device_model&&(this.project.state.deviceModel=e.device_model),D(A.STATE_CHANGED)}setDeviceName(e){this.project.state.deviceName=e,this.updateLayoutIndicator()}setDeviceModel(e){this.project.state.deviceModel=e,this.updateLayoutIndicator()}setCurrentLayoutId(e){this.project.state.currentLayoutId=e,this.updateLayoutIndicator()}updateLayoutIndicator(){const e=document.getElementById("currentLayoutName");e&&(e.textContent=this.project.deviceName||this.project.currentLayoutId||"Unknown")}setSnapEnabled(e){this.preferences.setSnapEnabled(e)}setShowGrid(e){this.preferences.setShowGrid(e)}setShowRulers(e){this.preferences.setShowRulers(e)}setZoomLevel(e){this.editor.setZoomLevel(e)}setCustomHardware(e){this.project.state.customHardware=e,D(A.STATE_CHANGED)}addWidget(e,i=null){this._checkRenderingModeForWidget(e),this.project.addWidget(e,i),this.recordHistory(),this.selectWidget(e.id),D(A.STATE_CHANGED)}updateWidget(e,i){this.project.updateWidget(e,i);const o=this.getWidgetById(e);if(o&&o.type==="group"){const t=["locked","hidden"],n={};if(t.forEach(s=>{i[s]!==void 0&&(n[s]=i[s])}),Object.keys(n).length>0){const s=this.pages[this.currentPageIndex];s&&s.widgets&&s.widgets.filter(d=>d.parentId===e).forEach(d=>this.updateWidget(d.id,n))}}i.parentId!==void 0&&this.syncWidgetOrderWithHierarchy(),D(A.STATE_CHANGED)}updateWidgets(e,i){e.forEach(o=>this.project.updateWidget(o,i)),D(A.STATE_CHANGED)}deleteWidget(e){const i=e?[e]:[...this.editor.selectedWidgetIds],o=[...i];i.forEach(t=>{const n=this.getWidgetById(t);n&&n.type==="group"&&this.pages[this.currentPageIndex].widgets.filter(r=>r.parentId===t).forEach(r=>o.push(r.id))}),this.project.deleteWidgets([...new Set(o)]),this.editor.setSelectedWidgetIds([]),this.recordHistory(),D(A.STATE_CHANGED)}groupSelection(){const e=this.editor.selectedWidgetIds,i=this.getSelectedWidgets(),o=i.some(a=>a.type==="group"||a.parentId);if(e.length<2||o)return;let t=1/0,n=1/0,s=-1/0,r=-1/0;i.forEach(a=>{t=Math.min(t,a.x),n=Math.min(n,a.y),s=Math.max(s,a.x+(a.width||0)),r=Math.max(r,a.y+(a.height||0))});const d="group_"+we(),c={id:d,type:"group",title:"Group",x:t,y:n,width:s-t,height:r-n,props:{},expanded:!0};this.project.addWidget(c),i.forEach(a=>{this.project.updateWidget(a.id,{parentId:d})}),this.selectWidget(d),this.syncWidgetOrderWithHierarchy(),this.recordHistory(),D(A.STATE_CHANGED)}ungroupSelection(e=null){let i=[];if(e)i=Array.isArray(e)?e:[e];else{const r=this.getSelectedWidgets(),d=new Set;r.forEach(c=>{c.type==="group"?d.add(c.id):c.parentId&&d.add(c.parentId)}),i=[...d]}const o=new Set;i.forEach(r=>{const d=this.getWidgetById(r);d&&(d.type==="group"?o.add(d.id):d.parentId&&o.add(d.parentId))});const t=[...o];if(t.length===0)return;const n=[];t.forEach(r=>{const d=this.getWidgetById(r);if(!d||d.type!=="group")return;this.pages[this.currentPageIndex].widgets.filter(u=>u.parentId===r).forEach(u=>{this.project.updateWidget(u.id,{parentId:null}),n.push(u.id)})}),this.project.deleteWidgets(t);const s=this.pages[this.currentPageIndex];s&&s.widgets&&(s.widgets=s.widgets.filter(r=>!t.includes(r.id))),n.length>0&&this.selectWidgets(n),this.syncWidgetOrderWithHierarchy(),this.recordHistory(),D(A.STATE_CHANGED)}alignSelectedWidgets(e){const i=this.getSelectedWidgets();if(i.length<2)return;let o;switch(e){case"left":o=Math.min(...i.map(s=>s.x)),i.forEach(s=>this.project.updateWidget(s.id,{x:o}));break;case"right":o=Math.max(...i.map(s=>s.x+(s.width||0))),i.forEach(s=>this.project.updateWidget(s.id,{x:o-(s.width||0)}));break;case"center":const t=i.map(s=>s.x+(s.width||0)/2);o=t.reduce((s,r)=>s+r,0)/t.length,i.forEach(s=>this.project.updateWidget(s.id,{x:o-(s.width||0)/2}));break;case"top":o=Math.min(...i.map(s=>s.y)),i.forEach(s=>this.project.updateWidget(s.id,{y:o}));break;case"bottom":o=Math.max(...i.map(s=>s.y+(s.height||0))),i.forEach(s=>this.project.updateWidget(s.id,{y:o-(s.height||0)}));break;case"middle":const n=i.map(s=>s.y+(s.height||0)/2);o=n.reduce((s,r)=>s+r,0)/n.length,i.forEach(s=>this.project.updateWidget(s.id,{y:o-(s.height||0)/2}));break}this.recordHistory(),D(A.STATE_CHANGED)}distributeSelectedWidgets(e){const i=[...this.getSelectedWidgets()];if(!(i.length<3)){if(e==="horizontal"){i.sort((a,u)=>a.x-u.x);const o=i[0],t=i[i.length-1],n=i.reduce((a,u)=>a+(u.width||0),0),d=(t.x+(t.width||0)-o.x-n)/(i.length-1);let c=o.x;for(let a=0;a<i.length;a++)this.project.updateWidget(i[a].id,{x:Math.round(c)}),c+=(i[a].width||0)+d}else{i.sort((a,u)=>a.y-u.y);const o=i[0],t=i[i.length-1],n=i.reduce((a,u)=>a+(u.height||0),0),d=(t.y+(t.height||0)-o.y-n)/(i.length-1);let c=o.y;for(let a=0;a<i.length;a++)this.project.updateWidget(i[a].id,{y:Math.round(c)}),c+=(i[a].height||0)+d}this.recordHistory(),D(A.STATE_CHANGED)}}moveWidgetToPage(e,i,o=null,t=null){const n=this.project.moveWidgetToPage(e,i,o,t);return n&&(this.syncWidgetOrderWithHierarchy(),this.recordHistory(),D(A.STATE_CHANGED)),n}clearCurrentPage(e=!1){const i=this.project.clearCurrentPage(e);return i.deleted>0&&(this.editor.setSelectedWidgetIds([]),this.recordHistory(),D(A.STATE_CHANGED)),i}copyWidget(e){const o=(e?[e]:this.editor.selectedWidgetIds).map(t=>this.getWidgetById(t)).filter(t=>!!t);o.length>0&&this.editor.copyWidgets(o)}pasteWidget(){const e=this.editor.clipboardWidgets;if(!e||e.length===0)return;const i=e.map(o=>{const t=JSON.parse(JSON.stringify(o));return t.id=we(),t.x+=10,t.y+=10,t});i.forEach(o=>{this._checkRenderingModeForWidget(o),this.project.addWidget(o)}),this.editor.setSelectedWidgetIds(i.map(o=>o.id)),this.recordHistory(),D(A.STATE_CHANGED)}createDropShadow(e){const i=this.getWidgetById(e);if(!i)return;const o=JSON.parse(JSON.stringify(i));o.id=we(),o.x=(o.x||0)+5,o.y=(o.y||0)+5,o.props||(o.props={});const t=this.project.getCurrentPage(),n=t?t.dark_mode:void 0;let s=!1;n==="dark"?s=!0:n==="light"?s=!1:s=!!this.settings.dark_mode;const r=s?"white":"black";if(o.props.color=r,o.props.border_color=r,o.props.background_color=r,o.props.bg_color=r,o.props.fill=!0,o.props.name&&(o.props.name=o.props.name+" Shadow"),this.project.addWidget(o),["shape_rect","rounded_rect","shape_circle","rectangle","rrect","circle"].includes(i.type)){const u=s?"black":"white";i.props||(i.props={});const m=s?"white":"black",g=i.props.color||m;i.props.border_color||(i.props.border_color=g),i.props.fill=!0,i.props.color=u,i.props.background_color=u,i.props.bg_color=u}const c=t.widgets.findIndex(u=>u.id===e),a=t.widgets.findIndex(u=>u.id===o.id);c!==-1&&a!==-1&&this.project.reorderWidget(this.project.currentPageIndex,a,c),this.recordHistory(),D(A.STATE_CHANGED)}recordHistory(){this._isRestoringHistory||this.editor.recordHistory({pages:this.project.pages,deviceName:this.project.deviceName})}undo(){const e=this.editor.undo();e&&(this._isRestoringHistory=!0,this.restoreSnapshot(e),setTimeout(()=>{this._isRestoringHistory=!1},0))}redo(){const e=this.editor.redo();e&&(this._isRestoringHistory=!0,this.restoreSnapshot(e),setTimeout(()=>{this._isRestoringHistory=!1},0))}restoreSnapshot(e){this.project.state.pages=JSON.parse(JSON.stringify(e.pages)),this.project.state.deviceName=e.deviceName,this.project.rebuildWidgetsIndex(),D(A.STATE_CHANGED)}canUndo(){return this.editor.canUndo()}canRedo(){return this.editor.canRedo()}syncWidgetOrderWithHierarchy(){const e=this.getCurrentPage();if(!e||!e.widgets)return;const i=[...e.widgets],o=i.filter(r=>!r.parentId),t=new Map;i.forEach(r=>{r.parentId&&(t.has(r.parentId)||t.set(r.parentId,[]),t.get(r.parentId).push(r))});const n=[],s=r=>{n.push(r);const d=t.get(r.id);d&&(d.sort((c,a)=>i.indexOf(c)-i.indexOf(a)),d.forEach(s))};o.forEach(s),e.widgets=n,this.project.rebuildWidgetsIndex()}_checkRenderingModeForWidget(e){if(!e||!e.type)return;e.type.startsWith("lvgl_")&&this.preferences.state.renderingMode==="direct"&&(this.updateSettings({renderingMode:"lvgl"}),_.log(`[AppState] Auto-switched to LVGL rendering mode because an LVGL widget (${e.type}) was added.`),G("Auto-switched to LVGL rendering mode","info"))}}const Kt=new wi;window.AppState=Kt;const h=Kt;window.AppState=h;window.ESPHomeDesigner=window.ESPHomeDesigner||{};window.ESPHomeDesigner.state=h;function Pt(l){_.log("[parseSnippetYamlOffline] Start parsing with js-yaml...");const e=l.split(/\r?\n/),i=[];let o={};try{window.jsyaml&&(o=jsyaml.load(l)||{},_.log("[parseSnippetYamlOffline] YAML parsed successfully with js-yaml"))}catch(k){_.error("[parseSnippetYamlOffline] YAML parse error:",k)}if(o.display&&(Array.isArray(o.display)?o.display:[o.display]).forEach(I=>{I&&I.lambda&&i.push(...I.lambda.split(`
`))}),i.length===0){let k=!1,I=0;for(const L of e){const H=L.replace(/\t/g,"    ");if(!k&&H.match(/^\s*lambda:\s*\|\-/)){k=!0;continue}if(k){const N=H.match(/^(\s+)/);if(N){const $=N[1].length;if(I===0&&(I=$),$<I){k=!1;continue}i.push(H.slice(I))}else H.trim()===""?i.push(""):H.match(/^\w+:/)&&(k=!1)}}}_.log(`[parseSnippetYamlOffline] Collected ${i.length} info lines`);const t=new Map,n=new Map,s=new Map,r=new Map,d=new Map,c=new Map,a=new Map,u=new Map,m=(k,I,L)=>{const H=[];let N=I;for(;N<k.length;){const $=k[N];if(!$){N++;continue}const M=$.trim();if(!M||M.startsWith("#")){H.push($),N++;continue}const X=$.match(/^(\s*)/);if((X?X[1].length:0)<L)break;H.push($),N++}try{const $=H.join(`
`);return{value:jsyaml.load($),nextJ:N}}catch($){return _.error("Error parsing YAML sub-block:",$),{value:null,nextJ:N}}},g=e;let f=null,v=!1;const b=["label","button","arc","bar","slider","chart","dropdown","roller","spinbox","switch","textarea","obj","img","qrcode","led","spinner","line","meter","tabview","tileview","checkbox","keyboard","buttonmatrix","list","icon"],E={label:"lvgl_label",button:"lvgl_button",arc:"lvgl_arc",bar:"lvgl_bar",slider:"lvgl_slider",chart:"lvgl_chart",dropdown:"lvgl_dropdown",roller:"lvgl_roller",spinbox:"lvgl_spinbox",switch:"lvgl_switch",textarea:"lvgl_textarea",obj:"lvgl_obj",img:"lvgl_img",qrcode:"lvgl_qrcode",led:"lvgl_led",spinner:"lvgl_spinner",line:"lvgl_line",meter:"lvgl_meter",tabview:"lvgl_tabview",tileview:"lvgl_tileview",checkbox:"lvgl_checkbox",keyboard:"lvgl_keyboard",buttonmatrix:"lvgl_buttonmatrix",icon:"icon"};for(let k=0;k<i.length;k++){const I=i[k],L=I.trim();if(!L)continue;let H=I.match(/if\s*\(\s*(?:id\s*\(\s*display_page\s*\)|page|currentPage)\s*==\s*(\d+)\s*\)/);H&&(f=parseInt(H[1],10),v=!1,t.has(f)||t.set(f,[]));const N=I.match(/^\s*-\s*id:\s*(\w+)/);if(N){const w=N[1],C=w.match(/^page_(\d+)$/);let P=C?parseInt(C[1],10):t.size;t.has(P)||(t.set(P,[]),s.set(P,w)),f=P,v=!1,_.log(`[parseSnippetYamlOffline] Detected LVGL Page: ${w} (mapped to idx ${P})`)}const $=I.match(/^\s*layout:\s*(\d+x\d+)/);if($&&f!==null&&(u.set(f,$[1]),_.log(`[parseSnippetYamlOffline] Detected layout: ${$[1]} for page ${f}`)),L.startsWith("widgets:")){v=!0;continue}const M=I.match(/case\s+(\d+):\s*interval\s*=\s*(\d+);/);if(M){const w=parseInt(M[1],10),C=parseInt(M[2],10);n.set(w,C),t.has(w)||t.set(w,[])}const X=I.match(/\/\/\s*page:name\s+"(.+)"/);X&&f!==null&&s.set(f,X[1]);const K=I.match(/\/\/\s*page:dark_mode\s+"(.+)"/);K&&f!==null&&r.set(f,K[1]);const j=I.match(/\/\/\s*page:refresh_type\s+"(.+)"/);j&&f!==null&&d.set(f,j[1]);const p=I.match(/\/\/\s*page:refresh_time\s+"(.*)"/);if(p&&f!==null&&c.set(f,p[1]),!v){const w=I.match(/^\s*bg_color:\s*(.*)/);if(w&&f!==null){let P=w[1].trim().replace(/^["']|["']$/g,"");if(P.startsWith("0x")&&(P="#"+P.substring(2)),a.has(f)||a.set(f,{}),a.get(f).bg_color=P,P.startsWith("#")){const x=P.substring(1);if(x.length===6){const ee=parseInt(x.substring(0,2),16),U=parseInt(x.substring(2,4),16),O=parseInt(x.substring(4,6),16);(ee*299+U*587+O*114)/1e3<128&&(r.has(f)||r.set(f,"dark"))}}}const C=I.match(/^\s*bg_opa:\s*(.*)/);if(C&&f!==null){let P=C[1].trim().replace(/^["']|["']$/g,"");P.endsWith("%")&&(P=String(Math.round(parseFloat(P)*2.55))),a.has(f)||a.set(f,{}),a.get(f).bg_opa=parseInt(P,10)}}}const y={orientation:"landscape",dark_mode:!1,sleep_enabled:!1,sleep_start_hour:0,sleep_end_hour:5,manual_refresh_only:!1,deep_sleep_enabled:!1,deep_sleep_interval:600,daily_refresh_enabled:!1,daily_refresh_time:"08:00",refresh_interval:600};for(const k of g){const I=k.trim();if(!I.startsWith("#"))continue;let L;if((L=I.match(/TARGET DEVICE:\s*(.*)/i))&&(y.target_device=L[1].trim()),(L=I.match(/Name:\s*(.*)/i))&&(y.name=L[1].trim()),(L=I.match(/Resolution:\s*(\d+)x(\d+)/i))&&(y.width=parseInt(L[1],10),y.height=parseInt(L[2],10)),(L=I.match(/Shape:\s*(rect|round|circle)/i))&&(y.shape=L[1].toLowerCase()==="rect"?"rect":"round"),(L=I.match(/Inverted:\s*(true|false)/i))&&(y.inverted_colors=L[1].toLowerCase()==="true"),(L=I.match(/Orientation:\s*(landscape|portrait)/i))&&(y.orientation=L[1].toLowerCase()),(L=I.match(/Dark Mode:\s*(enabled|disabled)/i))&&(y.dark_mode=L[1].toLowerCase()==="enabled"),(L=I.match(/Refresh Interval:\s*(\d+)/i))&&(y.refresh_interval=parseInt(L[1],10)),L=I.match(/Power Strategy:\s*(.*)/i)){const H=L[1].trim().toLowerCase();y.sleep_enabled=H.includes("night"),y.manual_refresh_only=H.includes("manual"),y.deep_sleep_enabled=H.includes("ultra")||H.includes("deep"),y.daily_refresh_enabled=H.includes("daily")}(L=I.match(/Sleep Mode:\s*(enabled|disabled)/i))&&(y.sleep_enabled=L[1].toLowerCase()==="enabled"),(L=I.match(/Sleep Start Hour:\s*(\d+)/i))&&(y.sleep_start_hour=parseInt(L[1],10)),(L=I.match(/Sleep End Hour:\s*(\d+)/i))&&(y.sleep_end_hour=parseInt(L[1],10)),(L=I.match(/Manual Refresh:\s*(enabled|disabled)/i))&&(y.manual_refresh_only=L[1].toLowerCase()==="enabled"),(L=I.match(/Deep Sleep:\s*(enabled|disabled)/i))&&(y.deep_sleep_enabled=L[1].toLowerCase()==="enabled"),(L=I.match(/Deep Sleep Interval:\s*(\d+)/i))&&(y.deep_sleep_interval=parseInt(L[1],10)),(L=I.match(/Refresh Time:\s*(\d{2}:\d{2})/i))&&(y.daily_refresh_time=L[1]),(L=I.match(/Disable updates from\s*(\d+)\s*to\s*(\d+)/i))&&(y.no_refresh_start_hour=parseInt(L[1],10),y.no_refresh_end_hour=parseInt(L[2],10))}t.size===0&&t.set(0,[]);const S={settings:y,pages:Array.from(t.entries()).sort((k,I)=>k[0]-I[0]).map(([k,I])=>({id:`page_${k}`,name:s.has(k)?s.get(k):`Page ${k+1}`,refresh_s:n.has(k)?n.get(k):null,refresh_type:d.has(k)?d.get(k):"interval",refresh_time:c.has(k)?c.get(k):"",dark_mode:r.has(k)?r.get(k):"inherit",layout:u.has(k)?u.get(k):null,bg_color:a.has(k)?a.get(k).bg_color:null,bg_opa:a.has(k)?a.get(k).bg_opa:null,widgets:[]}))};f=0;function T(){const k=S.pages.find((I,L)=>L===f);return k?k.widgets:S.pages[0].widgets}function R(k){const I=k.match(/^(?:#\s*|\/\/\s*)widget:(\w+)\s+(.+)$/);if(!I)return(k.startsWith("// widget:")||k.startsWith("# widget:"))&&_.warn("[parseWidgetMarker] Regex failed for:",k),null;const L=I[1],H=I[2],N={};_.log(`[parseWidgetMarker] Found widget: ${L}`);const $=/(\w+):(?:"([^"]*)"|([^:]*?)(?=\s+\w+:|$))/g;let M;for(;(M=$.exec(H))!==null;){let X=M[2]!==void 0?M[2]:M[3];X&&(X=X.trim()),N[M[1]]=X}return{widgetType:L,props:N}}let B=!1;for(let k=0;k<i.length;k++){const I=i[k],L=I.trim();if(!L||L.startsWith("#")&&!L.match(/^#\s*widget:/))continue;let H=L.match(/if\s*\(\s*(?:id\s*\(\s*display_page\s*\)|page|currentPage)\s*==\s*(\d+)\s*\)/);if(H){f=parseInt(H[1],10);continue}const N=L.match(/^-\s*id:\s*(\w+)/);if(N){const j=N[1],p=j.match(/^page_(\d+)$/);f=p?parseInt(p[1],10):Array.from(s.entries()).find(([w,C])=>C===j)?.[0]||0,_.log(`[parseSnippetYamlOffline] Processing widgets for page: ${j} (idx ${f})`);continue}const $=T();if(B)if(L.match(/^(?:#\s*|\/\/\s*)widget:/)||L.match(/^\s*-\s*id:/)||!I.match(/^\s/))B=!1;else continue;if(L.startsWith("//")||L.startsWith("#")){const j=R(L);if(j&&j.props.id){const p=j.props,w=j.widgetType||p.type;if(!w){_.warn("[parseSnippetYamlOffline] Widget marker found but no type determined:",L);continue}let C=100,P=30;w==="template_nav_bar"?(C=200,P=50):w==="touch_area"?(C=100,P=100):["nav_next_page","nav_previous_page","nav_reload_page"].includes(w)?(C=80,P=80):(w==="battery_icon"||w==="wifi_signal"||w==="icon")&&(C=60,P=60);const x={id:p.id,type:w,x:parseInt(p.x||0,10),y:parseInt(p.y||0,10),width:parseInt(p.w||C,10),height:parseInt(p.h||P,10),title:p.title||"",entity_id:p.entity||p.ent||"",condition_entity:p.cond_ent||"",condition_operator:p.cond_op||"",condition_state:p.cond_state||"",condition_min:p.cond_min||"",condition_max:p.cond_max||"",props:{}};if(w.startsWith("lvgl_")){Object.entries(p).forEach(([O,z])=>{["id","type","x","y","w","h","width","height"].includes(O)||(z==="true"?x.props[O]=!0:z==="false"?x.props[O]=!1:x.props[O]=z)}),x.props.hidden=p.hidden==="true",x.props.clickable=p.clickable!=="false",x.props.checkable=p.checkable==="true",x.props.scrollable=p.scrollable!=="false",x.props.floating=p.floating==="true",x.props.ignore_layout=p.ignore_layout==="true",x.props.scrollbar_mode=p.scrollbar_mode||"AUTO",x.props.opa=parseInt(p.opa||255,10);const ee=p.grid_cell_row_pos??p.grid_row,U=p.grid_cell_column_pos??p.grid_col;x.props.grid_cell_row_pos=ee!=null?parseInt(ee,10):null,x.props.grid_cell_column_pos=U!=null?parseInt(U,10):null,x.props.grid_cell_row_span=parseInt(p.grid_cell_row_span||p.grid_row_span||1,10),x.props.grid_cell_column_span=parseInt(p.grid_cell_column_span||p.grid_col_span||1,10),x.props.grid_cell_x_align=p.grid_cell_x_align||p.grid_x_align||"STRETCH",x.props.grid_cell_y_align=p.grid_cell_y_align||p.grid_y_align||"STRETCH"}if(w==="icon")x.props={code:p.code||"F0595",size:parseInt(p.size||48,10),color:p.color||"black",fit_icon_to_frame:p.fit==="true"||p.fit==="1"};else if(w==="text"||w==="label")x.props={text:p.text||"",font_size:parseInt(p.font_size||p.size||20,10),font_family:p.font_family||p.font||"Roboto",font_weight:parseInt(p.font_weight||p.weight||400,10),italic:p.italic==="true"||p.italic===!0,bpp:parseInt(p.bpp||1,10),color:p.color||"black",text_align:p.align||p.text_align||"TOP_LEFT"};else if(w==="sensor_text")x.props={label_font_size:parseInt(p.label_font||p.label_font_size||14,10),value_font_size:parseInt(p.value_font||p.value_font_size||20,10),value_format:p.format||"label_value",color:p.color||"black",italic:p.italic==="true"||p.italic===!0||p.font_style==="italic",font_family:p.font_family||"Roboto",font_weight:parseInt(p.font_weight||400,10),prefix:p.prefix||"",postfix:p.postfix||"",unit:p.unit||"",hide_unit:p.hide_unit==="true"||p.hide_unit===!0,precision:parseInt(p.precision||-1,10),text_align:p.align||p.text_align||"TOP_LEFT",label_align:p.label_align||p.align||p.text_align||"TOP_LEFT",value_align:p.value_align||p.align||p.text_align||"TOP_LEFT",is_local_sensor:p.local==="true",is_text_sensor:p.text_sensor==="true",separator:p.separator||" ~ "},x.entity_id_2=p.entity_2||"";else if(w==="datetime")x.width=parseInt(p.w||200,10),x.height=parseInt(p.h||60,10),x.props={format:p.format||"time_date",time_font_size:parseInt(p.time_font_size||p.time_size||p.time_font||28,10),date_font_size:parseInt(p.date_font_size||p.date_size||p.date_font||16,10),color:p.color||"black",italic:p.italic==="true"||p.italic===!0||p.font_style==="italic",font_family:p.font_family||"Roboto",text_align:p.align||p.text_align||"CENTER"};else if(w==="progress_bar")x.props={show_label:p.show_label!=="false",show_percentage:p.show_pct!=="false",bar_height:parseInt(p.bar_h||p.bar_height||15,10),border_width:parseInt(p.border_w||p.border||1,10),color:p.color||"black",is_local_sensor:p.local==="true"};else if(w==="battery_icon")x.props={size:parseInt(p.size||32,10),font_size:parseInt(p.font_size||12,10),color:p.color||"black",is_local_sensor:p.local==="true",fit_icon_to_frame:p.fit==="true"||p.fit==="1"};else if(w==="wifi_signal")x.props={size:parseInt(p.size||24,10),font_size:parseInt(p.font_size||12,10),color:p.color||"black",is_local_sensor:p.local!=="false",show_dbm:p.show_dbm!=="false",fit_icon_to_frame:p.fit==="true"||p.fit==="1"};else if(w==="ondevice_temperature")x.props={size:parseInt(p.size||32,10),font_size:parseInt(p.font_size||16,10),label_font_size:parseInt(p.label_font_size||10,10),color:p.color||"black",unit:p.unit||"Â°C",precision:parseInt(p.precision||1,10),show_label:p.show_label!=="false",is_local_sensor:p.local!=="false",fit_icon_to_frame:p.fit==="true"||p.fit==="1"};else if(w==="ondevice_humidity")x.props={size:parseInt(p.size||32,10),font_size:parseInt(p.font_size||16,10),label_font_size:parseInt(p.label_font_size||10,10),color:p.color||"black",unit:p.unit||"%",precision:parseInt(p.precision||0,10),show_label:p.show_label!=="false",is_local_sensor:p.local!=="false",fit_icon_to_frame:p.fit==="true"||p.fit==="1"};else if(w==="weather_icon")x.props={size:parseInt(p.size||48,10),color:p.color||"black"};else if(w==="qr_code")x.props={value:p.value||"https://esphome.io",scale:parseInt(p.scale||2,10),ecc:p.ecc||"LOW",color:p.color||"black"};else if(w==="image")x.props={path:(p.path||"").replace(/^"|"$/g,""),invert:p.invert==="true"||p.invert==="1",dither:p.dither||"FLOYDSTEINBERG",transparency:p.transparency||"",image_type:p.img_type||"BINARY",render_mode:p.render_mode||"Auto"};else if(w==="online_image")x.props={url:p.url||"",invert:p.invert==="true"||p.invert==="1",interval_s:parseInt(p.interval||300,10),render_mode:p.render_mode||"Auto"};else if(w==="puppet")x.props={image_url:p.url||"",invert:p.invert==="true"||p.invert==="1",image_type:p.img_type||"RGB565",transparency:p.transparency||"opaque",render_mode:p.render_mode||"Auto"};else if(w==="shape_rect")x.props={fill:p.fill==="true"||p.fill==="1",border_width:parseInt(p.border||1,10),color:p.color||"black",border_color:p.border_color||p.color||"black",opacity:parseInt(p.opacity||100,10)};else if(w==="touch_area")x.props={title:p.title||"Touch Area",color:p.color||"rgba(0, 0, 255, 0.2)",border_color:p.border_color||"#0000ff",icon:p.icon||"",icon_pressed:p.icon_pressed||"",icon_size:parseInt(p.icon_size||40,10),icon_color:p.icon_color||"black",nav_action:p.nav_action||"none"};else if(w==="rounded_rect")x.props={fill:p.fill==="true"||p.fill==="1",show_border:p.show_border!=="false"&&p.show_border!=="0",border_width:parseInt(p.border||4,10),radius:parseInt(p.radius||10,10),color:p.color||"black",border_color:p.border_color||"black",opacity:parseInt(p.opacity||100,10)};else if(w==="shape_circle")x.props={fill:p.fill==="true"||p.fill==="1",border_width:parseInt(p.border||1,10),color:p.color||"black",border_color:p.border_color||p.color||"black",opacity:parseInt(p.opacity||100,10)};else if(w==="line")x.props={stroke_width:parseInt(p.stroke||3,10),color:p.color||"black",orientation:p.orientation||"horizontal"};else if(w==="graph")x.entity_id=p.entity||"",x.props={duration:p.duration||"1h",border:p.border==="true"||p.border==="1"||p.border==null,grid:p.grid==="true"||p.grid==="1"||p.grid==null,color:p.color||"black",x_grid:p.x_grid||"",y_grid:p.y_grid||"",line_thickness:parseInt(p.line_thickness||3,10),line_type:p.line_type||"SOLID",continuous:p.continuous!=="false"&&p.continuous!=="0",min_value:p.min_value||"",max_value:p.max_value||"",min_range:p.min_range||"",max_range:p.max_range||"",is_local_sensor:p.local==="true"};else if(w==="quote_rss")x.props={feed_url:p.feed_url||"https://www.brainyquote.com/link/quotebr.rss",show_author:p.show_author!=="false",random:p.random!=="false",refresh_interval:p.refresh_interval||p.refresh||"24h",quote_font_size:parseInt(p.quote_font_size||p.quote_font||18,10),author_font_size:parseInt(p.author_font_size||p.author_font||14,10),font_family:p.font_family||p.font||"Roboto",font_weight:parseInt(p.font_weight||p.weight||400,10),color:p.color||"black",text_align:p.align||p.text_align||"TOP_LEFT",word_wrap:p.word_wrap!=="false"&&p.wrap!=="false",italic_quote:p.italic_quote!=="false"};else if(w==="weather_forecast")x.props={weather_entity:p.weather_entity||"",layout:p.layout||"horizontal",show_high_low:p.show_high_low!=="false",day_font_size:parseInt(p.day_font_size||12,10),temp_font_size:parseInt(p.temp_font_size||14,10),icon_size:parseInt(p.icon_size||32,10),font_family:p.font_family||"Roboto",color:p.color||"black"};else if(w==="template_sensor_bar")x.props={show_wifi:p.wifi!=="false",show_temperature:p.temp!=="false",show_humidity:p.hum!=="false",show_battery:p.bat!=="false",show_background:p.bg!=="false",background_color:p.bg_color||"gray",border_radius:parseInt(p.radius||8,10),icon_size:parseInt(p.icon_size||20,10),font_size:parseInt(p.font_size||14,10),color:p.color||"black"};else if(w==="template_nav_bar")x.props={show_prev:p.prev!=="false",show_home:p.home!=="false",show_next:p.next!=="false",show_background:p.bg!=="false",background_color:p.bg_color||"gray",border_radius:parseInt(p.radius||8,10),icon_size:parseInt(p.icon_size||24,10),color:p.color||"black"};else if(w==="lvgl_button")_.log("[YAML_IMPORT] Parsing lvgl_button",p.id,p),x.props={...x.props,text:p.text||"BTN",bg_color:p.bg_color||"white",color:p.color||"black",border_width:parseInt(p.border_width||p.border||2,10),radius:parseInt(p.radius||5,10),checkable:p.checkable==="true"},p.title&&(x.title=p.title);else if(w==="lvgl_arc")x.props={...x.props,min:parseInt(p.min||0,10),max:parseInt(p.max||100,10),value:parseInt(p.value||0,10),thickness:parseInt(p.thickness||10,10),color:p.color||"blue",start_angle:parseInt(p.start_angle||135,10),end_angle:parseInt(p.end_angle||45,10),mode:p.mode||"NORMAL"},p.title&&(x.title=p.title,x.props.title=p.title);else if(w==="lvgl_chart")x.props={...x.props,title:p.title||"Graph",type:p.type||"LINE",color:p.color||"black",bg_color:p.bg_color||"white",point_count:parseInt(p.point_count||10,10),x_div_lines:parseInt(p.x_div_lines||3,10),y_div_lines:parseInt(p.y_div_lines||3,10)},p.title&&(x.title=p.title);else if(w==="lvgl_img")x.props={...x.props,src:p.src||"symbol_image",rotation:parseInt(p.rotation||0,10),scale:parseInt(p.scale||256,10),pivot_x:parseInt(p.pivot_x||0,10),pivot_y:parseInt(p.pivot_y||0,10),color:p.color||"black"};else if(w==="lvgl_qrcode")x.props={...x.props,text:p.text||"https://esphome.io",scale:parseInt(p.scale||2,10),color:p.color||"black",bg_color:p.bg_color||"white"};else if(w==="lvgl_bar")x.props={...x.props,min:parseInt(p.min||0,10),max:parseInt(p.max||100,10),value:parseInt(p.value||0,10),color:p.color||"blue",bg_color:p.bg_color||"gray",start_value:parseInt(p.start_value||0,10),mode:p.mode||"NORMAL"};else if(w==="lvgl_slider")x.props={...x.props,min:parseInt(p.min||0,10),max:parseInt(p.max||100,10),value:parseInt(p.value||30,10),border_width:parseInt(p.border_width||2,10),color:p.color||"blue",bg_color:p.bg_color||"gray",mode:p.mode||"NORMAL",vertical:p.vertical==="true"||p.vertical===!0};else if(w==="lvgl_tabview")x.props={...x.props,bg_color:p.bg_color||"white",tabs:(p.tabs||"").split(",").map(ee=>ee.trim()).filter(ee=>ee)};else if(w==="lvgl_tileview")x.props={...x.props,bg_color:p.bg_color||"white",tiles:[]};else if(w==="lvgl_led")x.props={...x.props,color:p.color||"red",brightness:parseInt(p.brightness||255,10)};else if(w==="lvgl_spinner")x.props={...x.props,spin_time:parseInt(p.spin_time||1e3,10),arc_length:parseInt(p.arc_length||60,10),arc_color:p.arc_color||"blue",track_color:p.track_color||"white"};else if(w==="lvgl_buttonmatrix")x.props={...x.props,rows:[]};else if(w==="lvgl_checkbox")x.props={...x.props,text:(p.text||"Checkbox").replace(/^"|"$/g,""),checked:p.checked==="true"||p.checked===!0,color:p.color||"blue"};else if(w==="lvgl_dropdown")x.props={...x.props,options:(p.options||"").replace(/\\n/g,`
`),selected_index:parseInt(p.selected_index||0,10),color:p.color||"white",direction:p.direction||"DOWN",max_height:parseInt(p.max_height||200,10)};else if(w==="lvgl_keyboard")x.props={...x.props,mode:p.mode||"TEXT_UPPER",textarea_id:p.textarea||""};else if(w==="lvgl_roller")x.props={...x.props,options:(p.options||"").replace(/\\n/g,`
`),visible_row_count:parseInt(p.visible_row_count||3,10),color:p.color||"white",bg_color:p.bg_color||"black",selected_bg_color:p.selected_bg_color||"blue",selected_text_color:p.selected_text_color||"white",mode:p.mode||"NORMAL"};else if(w==="lvgl_spinbox")x.props={...x.props,min:parseInt(p.range_from||p.min||0,10),max:parseInt(p.range_to||p.max||100,10),digit_count:parseInt(p.digits||p.digit_count||4,10),step:parseInt(p.step||1,10),value:parseInt(p.value||0,10)};else if(w==="lvgl_switch")x.props={...x.props,checked:p.state==="true"||p.state===!0||p.checked==="true",bg_color:p.bg_color||"gray",color:p.color||"blue",knob_color:p.knob_color||"white"};else if(w==="lvgl_textarea")x.props={...x.props,placeholder:(p.placeholder_text||p.placeholder||"").replace(/^"|"$/g,""),text:(p.text||"").replace(/^"|"$/g,""),one_line:p.one_line==="true"||p.one_line===!0,max_length:parseInt(p.max_length||0,10),password_mode:p.password_mode==="true",accepted_chars:p.accepted_chars||""};else if(w==="lvgl_label")x.props={...x.props,text:(p.text||"Label").replace(/^"|"$/g,""),font_size:parseInt(p.font_size||p.size||20,10),font_family:p.font_family||"Roboto",font_weight:parseInt(p.font_weight||400,10),italic:p.italic==="true"||p.italic===!0,color:p.color||"black",bg_color:p.bg_color||"transparent",text_align:p.text_align||p.align||"CENTER"};else if(w==="lvgl_line")x.props={...x.props,orientation:p.orientation||"horizontal",points:p.points||"",line_width:parseInt(p.line_width||3,10),line_color:p.line_color||p.color||"black",line_rounded:p.line_rounded!=="false"};else if(w==="lvgl_meter")x.props={...x.props,min:parseInt(p.min||0,10),max:parseInt(p.max||100,10),value:parseInt(p.value||60,10),color:p.color||"black",indicator_color:p.indicator_color||"red",tick_count:parseInt(p.tick_count||11,10),tick_length:parseInt(p.tick_length||10,10),label_gap:parseInt(p.label_gap||10,10),scale_width:parseInt(p.scale_width||10,10),indicator_width:parseInt(p.indicator_width||4,10)};else if(w==="lvgl_obj")x.props={...x.props,color:p.color||"white",border_width:parseInt(p.border_width||1,10),border_color:p.border_color||"gray",radius:parseInt(p.radius||0,10)};else if(w.startsWith("lvgl_")){_.log("[YAML_IMPORT] Parsing generic LVGL",w,p.id,p);const ee=x.props||{};x.props={...ee};const U=["hidden","clickable","checkable","scrollable","floating","ignore_layout","scrollbar_mode","opa","grid_cell_row_pos","grid_cell_column_pos","grid_cell_row_span","grid_cell_column_span","grid_cell_x_align","grid_cell_y_align"];Object.entries(p).forEach(([O,z])=>{if(!(O==="id"||O==="type"||O==="x"||O==="y"||O==="w"||O==="h")&&!U.includes(O)){if(O==="title"){x.title=z;return}z==="true"?x.props[O]=!0:z==="false"?x.props[O]=!1:Array.isArray(z)?O==="options"?x.props[O]=z.join(`
`):O==="points"?x.props[O]=z.map(V=>Array.isArray(V)?V.join(","):String(V)).join(" "):x.props[O]=z:x.props[O]=z}})}else w==="calendar"&&(_.log("[YAML_IMPORT] Parsing calendar",p.id,p),x.props={entity_id:p.entity||"sensor.esp_calendar_data",border_width:parseInt(p.border_width||2,10),show_border:p.show_border!=="false",border_color:p.border_color||"black",background_color:p.background_color||"white",text_color:p.text_color||"black",font_size_date:parseInt(p.font_size_date||100,10),font_size_day:parseInt(p.font_size_day||24,10),font_size_grid:parseInt(p.font_size_grid||14,10),font_size_event:parseInt(p.font_size_event||18,10)});$.push(x),B=!0;continue}continue}let M;if(M=L.match(/^it\.rectangle\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*COLOR_OFF)?\s*\)\s*;?/),M){$.push({id:"w_rect_"+$.length,type:"shape_rect",x:parseInt(M[1],10),y:parseInt(M[2],10),width:parseInt(M[3],10),height:parseInt(M[4],10),title:"",entity_id:"",props:{fill:!1,border_width:1,color:"black",opacity:100}});continue}if(M=L.match(/^it\.filled_rectangle\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*COLOR_OFF)?\s*\)\s*;?/),M){$.push({id:"w_frect_"+$.length,type:"shape_rect",x:parseInt(M[1],10),y:parseInt(M[2],10),width:parseInt(M[3],10),height:parseInt(M[4],10),title:"",entity_id:"",props:{fill:!0,border_width:1,color:"black",opacity:100}});continue}if(M=L.match(/^it\.circle\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*COLOR_OFF)?\s*\)\s*;?/),M){const j=parseInt(M[3],10);$.push({id:"w_circle_"+$.length,type:"shape_circle",x:parseInt(M[1],10)-j,y:parseInt(M[2],10)-j,width:j*2,height:j*2,title:"",entity_id:"",props:{fill:!1,border_width:1,color:"black",opacity:100}});continue}if(M=L.match(/^it\.filled_circle\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*COLOR_OFF)?\s*\)\s*;?/),M){const j=parseInt(M[3],10);$.push({id:"w_fcircle_"+$.length,type:"shape_circle",x:parseInt(M[1],10)-j,y:parseInt(M[2],10)-j,width:j*2,height:j*2,title:"",entity_id:"",props:{fill:!0,border_width:1,color:"black",opacity:100}});continue}if(M=L.match(/^it\.line\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)\s*;?/),M){const j=parseInt(M[1],10),p=parseInt(M[2],10),w=parseInt(M[3],10),C=parseInt(M[4],10);$.push({id:"w_line_"+$.length,type:"line",x:j,y:p,width:w-j,height:C-p,title:"",entity_id:"",props:{stroke_width:1,color:"black",orientation:Math.abs(C-p)>Math.abs(w-j)?"vertical":"horizontal"}});continue}const X=new RegExp(`^(\\s*)-?\\s*(${b.join("|")}):\\s*(.*)$`),K=I.match(X);if(K){const j=K[1].length,p=K[2],w=K[3].trim(),C=E[p]||`lvgl_${p}`,P={};w&&(P._inline=w.replace(/^["']|["']$/g,""));const x=m(i,k+1,j+2);Object.assign(P,x.value),k=x.nextJ-1;const U={id:P.id||`lv_${p}_${$.length}`,type:C,x:parseInt(P.x||0,10),y:parseInt(P.y||0,10),width:parseInt(P.width||P.w||100,10),height:parseInt(P.height||P.h||30,10),title:P.title||P.name||"",entity_id:P.entity_id||P.entity||P.sensor||"",props:{}};if(U.props.hidden=P.hidden==="true",U.props.clickable=P.clickable!=="false",U.props.scrollable=P.scrollable!=="false",P.bg_color&&(U.props.bg_color=P.bg_color),P.bg_opa){let O=P.bg_opa;O.toString().endsWith("%")&&(O=Math.round(parseFloat(O)*2.55)),U.props.opa=parseInt(O,10)}P.text?U.props.text=P.text:P._inline&&p==="label"&&(U.props.text=P._inline),Object.entries(P).forEach(([O,z])=>{if(["id","x","y","width","height","w","h","type","bg_color","bg_opa","_inline","widgets"].includes(O))return;if((O==="indicator"||O==="knob"||O==="selected")&&typeof z=="object"&&z!==null&&!Array.isArray(z)){Object.entries(z).forEach(([ne,Je])=>{U.props[`${O}_${ne}`]=Je});return}let V=z;if(Array.isArray(z)?O==="options"?V=z.join(`
`):O==="points"&&(V=z.map(ne=>Array.isArray(ne)?ne.join(","):String(ne)).join(" ")):typeof z=="string"&&/^-?\d+(\.\d+)?(ms|deg|px|%)$/.test(z)&&(V=z.replace(/(ms|deg|px|%)$/,"")),U.props[O]===void 0)if(V==="true")U.props[O]=!0;else if(V==="false")U.props[O]=!1;else if(!isNaN(V)&&V!==""&&O!=="text"&&O!=="id"&&O!=="name"&&typeof V!="object")U.props[O]=parseFloat(V);else if(typeof V=="string"&&V.includes("\\u"))try{U.props[O]=JSON.parse(`"${V}"`)}catch{U.props[O]=V}else U.props[O]=V}),$.push(U),Array.isArray(P.widgets)&&P.widgets.forEach(O=>{const z=Object.keys(O)[0],V=O[z];if(z&&V){const ne=E[z]||`lvgl_${z}`,Je={id:V.id||`lv_${z}_${$.length}`,type:ne,x:U.x+parseInt(V.x||0,10),y:U.y+parseInt(V.y||0,10),width:parseInt(V.width||V.w||50,10),height:parseInt(V.height||V.h||20,10),props:{...V}};$.push(Je)}})}}return S}function re(l){if(!l)throw _.error("Invalid layout - null or undefined"),new Error("invalid_layout");if(l.data&&l.data.devices){const u=Object.keys(l.data.devices);if(u.length>0){const m=u[0];_.log(`[loadLayoutIntoState] Detected legacy HA storage format. unwrapping device: ${m}`),l=l.data.devices[m]}}if(!Array.isArray(l.pages))throw _.error("Invalid layout - missing pages array"),new Error("invalid_layout");const e=l.pages.map((u,m)=>({...u,id:u.id||`page_${m}`,name:u.name||`Page ${m+1}`,widgets:Array.isArray(u.widgets)?u.widgets:[]}));e.length||(_.warn("No pages, creating default empty page"),e.push({id:"page_0",name:"Imported",widgets:[]}));const i=l.device_id||l.currentLayoutId;if(i){const u=h.currentLayoutId;u!==i&&(_.log(`[loadLayoutIntoState] Updating currentLayoutId: ${u} -> ${i}`),h.setCurrentLayoutId(i))}else _.log(`[loadLayoutIntoState] No device_id in layout, keeping currentLayoutId: ${h.currentLayoutId}`);const o=l.name||l.deviceName;o&&h.setDeviceName(o);const t=l.device_model||l.deviceModel||l.settings?.device_model;t&&h.setDeviceModel(t),l.customHardware&&h.setCustomHardware(l.customHardware);const n=h.getSettings(),s=l.settings||{},r={};["orientation","dark_mode","sleep_enabled","sleep_start_hour","sleep_end_hour","manual_refresh_only","deep_sleep_enabled","deep_sleep_interval","daily_refresh_enabled","daily_refresh_time","no_refresh_start_hour","no_refresh_end_hour","auto_cycle_enabled","auto_cycle_interval_s","refresh_interval","auto_cycle_enabled","auto_cycle_interval_s","refresh_interval","width","height","shape","inverted_colors","renderingMode","lcdEcoStrategy","extendedLatinGlyphs"].forEach(u=>{l[u]!==void 0&&(r[u]=l[u])});const c={...n,...s,...r};o&&(c.device_name=o),t&&(c.device_model=t),c.sleep_enabled===void 0&&(c.sleep_enabled=!1),c.sleep_start_hour===void 0&&(c.sleep_start_hour=0),c.sleep_end_hour===void 0&&(c.sleep_end_hour=5),c.manual_refresh_only===void 0&&(c.manual_refresh_only=!1),c.deep_sleep_enabled===void 0&&(c.deep_sleep_enabled=!1),c.deep_sleep_interval===void 0&&(c.deep_sleep_interval=600),c.daily_refresh_enabled===void 0&&(c.daily_refresh_enabled=!1),c.daily_refresh_time===void 0&&(c.daily_refresh_time="08:00"),c.refresh_interval===void 0&&(c.refresh_interval=600),h.setPages(e),h.setSettings(c);const a=h.currentPageIndex;a>=0&&a<e.length?h.setCurrentPageIndex(a):h.setCurrentPageIndex(0),_.log(`[loadLayoutIntoState] Layout loaded with ${e.length} pages. Current Layout ID: ${h.currentLayoutId}`),_.log("[loadLayoutIntoState] Power settings after merge:",{daily_refresh_enabled:c.daily_refresh_enabled,daily_refresh_time:c.daily_refresh_time,deep_sleep_enabled:c.deep_sleep_enabled,sleep_enabled:c.sleep_enabled})}let le=[],Ze=!1,xi=!1,Le=!1;function ie(){const l={"Content-Type":"application/json"},e=_t();return e&&(l.Authorization=`Bearer ${e}`),l}const rt="entity-datalist-global";let de=null;function Jt(){return de||(de=document.getElementById(rt),de||(de=document.createElement("datalist"),de.id=rt,document.body.appendChild(de))),de}function Ei(l){const e=Jt();e.innerHTML="",!(!l||l.length===0)&&(l.forEach(i=>{const o=document.createElement("option");o.value=i.entity_id,o.label=i.name||i.entity_id,e.appendChild(o)}),_.log(`[EntityDatalist] Updated with ${l.length} entities`))}async function he(){if(!q())return[];if(Ze)return le;Ze=!0;try{const l=new AbortController,e=setTimeout(()=>l.abort(),2e3);_.log("[EntityStates] Fetching from:",`${Z}/entities`);const i=await fetch(`${Z}/entities?domains=sensor,binary_sensor,weather,light,switch,fan,cover,climate,media_player,input_number,number,input_boolean,input_text,input_select,button,input_button,scene,script`,{headers:ie(),signal:l.signal});if(clearTimeout(e),!i.ok)return _.warn("[EntityStates] Failed to fetch:",i.status),Le=!0,[];const o=await i.json();return Array.isArray(o)?(_.log(`[EntityStates] Received ${o.length} entities`),le=o.map(t=>{const n=t.unit?`${t.state} ${t.unit}`:t.state;return{entity_id:t.entity_id,name:t.name||t.entity_id,state:t.state,unit:t.unit,attributes:t.attributes||{},formatted:n}}),xi=!0,Le=!1,_.log(`[EntityStates] Cached ${le.length} entity states`),h&&(h.entityStates={},le.forEach(t=>{h.entityStates[t.entity_id]=t}),_.log(`[EntityStates] Populated AppState.entityStates with ${Object.keys(h.entityStates).length} entries`)),Ei(le),D(A.ENTITIES_LOADED,le),le):(_.warn("[EntityStates] Invalid response format"),Le=!0,[])}catch(l){return _.warn("[EntityStates] Error fetching:",l),Le=!0,[]}finally{Ze=!1}}async function Si(){if(!q()){_.warn("Cannot load layout from backend: No HA backend detected.");return}try{let l=null;try{const o=await fetch(`${Z}/layouts`,{headers:ie()});if(o.ok){const t=await o.json();_.log("[loadLayoutFromBackend] Available layouts:",t.layouts?.map(n=>n.id)),_.log(`[loadLayoutFromBackend] Last active layout ID from backend: ${t.last_active_layout_id}`),t.last_active_layout_id&&(t.layouts?.some(s=>s.id===t.last_active_layout_id)?(l=t.last_active_layout_id,_.log(`[loadLayoutFromBackend] Loading last active layout: ${l}`)):_.warn(`[loadLayoutFromBackend] Last active layout '${t.last_active_layout_id}' no longer exists`)),!l&&t.layouts&&t.layouts.length>0&&(l=t.layouts[0].id,_.log(`[loadLayoutFromBackend] No valid last active, using first layout: ${l}`))}}catch(o){_.warn("[loadLayoutFromBackend] Could not fetch layouts list:",o)}let e;if(l?e=await fetch(`${Z}/layouts/${l}`,{headers:ie()}):e=await fetch(`${Z}/layout`,{headers:ie()}),!e.ok)throw new Error(`Failed to load layout: ${e.status}`);const i=await e.json();!i.device_id&&l&&(i.device_id=l),_.log(`[loadLayoutFromBackend] Loaded layout '${i.device_id||l||"default"}':`,{name:i.name,device_model:i.device_model,pages:i.pages?.length,widgets:i.pages?.reduce((o,t)=>o+(t.widgets?.length||0),0)}),h&&(i.device_id||l)&&h.setCurrentLayoutId(i.device_id||l),typeof re=="function"?re(i):_.error("[loadLayoutFromBackend] loadLayoutIntoState function missing!"),D(A.LAYOUT_IMPORTED,i)}catch(l){_.error("Error loading layout from backend:",l),W(()=>Promise.resolve().then(()=>ui),void 0,import.meta.url).then(e=>e.showToast("Error loading layout from backend",5e3,"error"))}}let Qe=!1,et=!1;async function xe(){if(!q())return!1;if(Qe)return et=!0,_.log("[saveLayoutToBackend] Save already in progress, queuing..."),!1;if(!h)throw new Error("AppState not available");const l=h.currentLayoutId||"reterminal_e1001",e=h.settings.device_model||h.deviceModel||"reterminal_e1001",o={...h.getPagesPayload(),device_id:l,name:h.deviceName||"Layout 1",device_model:e,deviceName:h.deviceName||"Layout 1"};Qe=!0,et=!1;try{_.log(`[saveLayoutToBackend] Saving to layout '${l}':`,{device_model:e,pages:o.pages?.length,widgets:o.pages?.reduce((r,d)=>r+(d.widgets?.length||0),0)});const t=new AbortController,n=setTimeout(()=>t.abort(),1e4),s=await fetch(`${Z}/layouts/${l}`,{method:"POST",headers:ie(),body:JSON.stringify(o),signal:t.signal});if(clearTimeout(n),!s.ok){const r=await s.json().catch(()=>({}));throw new Error(r.message||r.error||`Save failed: ${s.status}`)}return _.log(`[saveLayoutToBackend] Layout '${l}' saved successfully`),!0}catch(t){if(t.name==="AbortError")return!0;if(t.message?.includes("Failed to fetch")||t.message?.includes("NetworkError")||t.message?.includes("net::ERR_")||t.message?.includes("ERR_EMPTY_RESPONSE")||t.message?.includes("Load failed"))return!1;throw _.error("Failed to save layout to backend:",t),t}finally{Qe=!1,et&&setTimeout(()=>{xe().catch(()=>{})},500)}}async function Ii(l){if(!q())throw new Error("No backend");const e=await fetch(`${Z}/import_snippet`,{method:"POST",headers:ie(),body:JSON.stringify({yaml:l})});if(!e.ok){const i=await e.json().catch(()=>({}));throw new Error(i.message||i.error||`Import failed with status ${e.status}`)}return await e.json()}const Ci=["elecrow-esp32-7inch.yaml","guition-esp32-jc4827w543.yaml","guition-esp32-jc8048w535.yaml","guition-esp32-jc8048w550.yaml","guition-esp32-s3-4848s040.yaml","lilygo-tdisplays3.yaml","sunton-esp32-2432s028.yaml","sunton-esp32-2432s028R.yaml","sunton-esp32-4827s032R.yaml","sunton-esp32-8048s050.yaml","sunton-esp32-8048s070.yaml","waveshare-esp32-s3-touch-lcd-4.3.yaml","waveshare-esp32-s3-touch-lcd-7.yaml","waveshare-esp32-universal-epaper-7.5v2.yaml"];async function Li(){if(q())try{const e=`${Z}/hardware/templates`;_.log("[HardwareDiscovery] Fetching from:",e);const i=await fetch(e,{headers:ie(),cache:"no-store"});if(!i.ok)throw new Error(`HTTP ${i.status}`);return(await i.json()).templates||[]}catch(e){_.error("Failed to fetch dynamic hardware templates from HA:",e)}_.log("[HardwareDiscovery] Attempting to load fallback local profiles...");const l=[];for(const e of Ci)try{const i=await fetch(`hardware/${e}`);if(i.ok){const o=await i.text(),t=Zt(o,e);t.id=e.replace(/\.yaml$/i,"").replace(/[^a-z0-9]/gi,"_").toLowerCase(),t.isPackageBased=!0,t.hardwarePackage=`hardware/${e}`,l.push(t)}}catch{}return _.log(`[HardwareDiscovery] Loaded ${l.length} local fallback profiles.`),l}async function Mt(l){if(!q())return _.log("[HardwareImport] Offline mode detected. Parsing locally..."),await ki(l);const e=new FormData;e.append("file",l);try{const i=`${Z}/hardware/upload`,o=ie();delete o["Content-Type"];const t=await fetch(i,{method:"POST",headers:o,body:e}),n=await t.json();if(!t.ok)throw new Error(n.message||n.error||"Upload failed");G("Hardware template uploaded successfully!","success");const{loadExternalProfiles:s}=await W(async()=>{const{loadExternalProfiles:r}=await Promise.resolve().then(()=>Qt);return{loadExternalProfiles:r}},void 0,import.meta.url);return s&&await s(),n}catch(i){throw _.error("Hardware upload failed:",i),G(`Upload failed: ${i.message}`,"error"),i}}async function ki(l){return new Promise((e,i)=>{const o=new FileReader;o.onload=async t=>{const n=t.target.result;try{if(!n.includes("__LAMBDA_PLACEHOLDER__"))throw new Error("Invalid template: Missing __LAMBDA_PLACEHOLDER__");const s=Zt(n,l.name);_.log("[HardwareImport] Parsed offline profile:",s);const{DEVICE_PROFILES:r}=await W(async()=>{const{DEVICE_PROFILES:d}=await Promise.resolve().then(()=>Qt);return{DEVICE_PROFILES:d}},void 0,import.meta.url);r&&(r[s.id]=s),G(`Imported ${s.name} (Offline Mode)`,"success"),window.app&&window.app.deviceSettings&&window.app.deviceSettings.populateDeviceSelect(),Ti(s),e(s)}catch(s){G(s.message,"error"),i(s)}},o.onerror=()=>i(new Error("File read failed")),o.readAsText(l)})}function Zt(l,e){const i="dynamic_offline_"+e.replace(/[^a-z0-9]/gi,"_").toLowerCase();let o=e.replace(/\.yaml$/i,""),t=800,n=480,s="rect";const r=l.match(/#\s*Name:\s*(.*)/i);r&&(o=r[1].trim());const d=l.match(/#\s*Resolution:\s*(\d+)x(\d+)/i);d&&(t=parseInt(d[1]),n=parseInt(d[2]));const c=l.match(/#\s*Shape:\s*(rect|round)/i);c&&(s=c[1].toLowerCase());const u=!!l.match(/#\s*Inverted:\s*(true|yes|1)/i);return{id:i,name:o+" (Local)",resolution:{width:t,height:n},shape:s,isPackageBased:!0,isOfflineImport:!0,content:l,features:{psram:l.includes("psram:"),lcd:!l.includes("waveshare_epaper")&&!l.includes("epaper_spi"),lvgl:l.includes("lvgl:")||!l.includes("waveshare_epaper"),epaper:l.includes("waveshare_epaper")||l.includes("epaper_spi"),touch:l.includes("touchscreen:"),inverted_colors:u}}}function Ti(l){try{const e=JSON.parse(localStorage.getItem("esphome-offline-profiles")||"{}");e[l.id]=l,localStorage.setItem("esphome-offline-profiles",JSON.stringify(e)),_.log("[HardwarePersistence] Saved offline profile to localStorage:",l.id)}catch(e){_.error("Failed to save profile to localStorage:",e)}}function Pi(){try{return JSON.parse(localStorage.getItem("esphome-offline-profiles")||"{}")}catch(l){return _.warn("Could not load offline profiles from storage:",l),{}}}const Be=["reterminal_e1001","reterminal_e1002","trmnl_diy_esp32s3","esp32_s3_photopainter","m5stack_paper","m5stack_coreink","trmnl","waveshare_esp32_s3_touch_lcd_7","waveshare_esp32_s3_touch_lcd_4_3"],F={reterminal_e1001:{name:"Seeedstudio reTerminal E1001 (Monochrome)",displayType:"binary",chip:"esp32-s3",board:"esp32-s3-devkitc-1",displayModel:"7.50inv2p",displayPlatform:"waveshare_epaper",resolution:{width:800,height:480},shape:"rect",psram_mode:"octal",pins:{display:{cs:"GPIO10",dc:"GPIO11",reset:{number:"GPIO12",inverted:!1},busy:{number:"GPIO13",inverted:!0}},i2c:{sda:"GPIO19",scl:"GPIO20"},spi:{clk:"GPIO7",mosi:"GPIO9"},batteryEnable:"GPIO21",batteryAdc:"GPIO1",buzzer:"GPIO45",buttons:{left:"GPIO5",right:"GPIO4",refresh:"GPIO3"}},battery:{attenuation:"12db",multiplier:2,calibration:{min:3.27,max:4.15}},features:{psram:!0,buzzer:!0,buttons:!0,sht4x:!0,epaper:!0,inverted_colors:!0}},reterminal_e1002:{name:"Seeedstudio reTerminal E1002 (6-Color)",displayType:"color",displayModel:"Seeed-reTerminal-E1002",displayPlatform:"epaper_spi",resolution:{width:800,height:480},shape:"rect",psram_mode:"octal",pins:{display:{cs:null,dc:null,reset:null,busy:null},i2c:{sda:"GPIO19",scl:"GPIO20"},spi:{clk:"GPIO7",mosi:"GPIO9"},batteryEnable:"GPIO21",batteryAdc:"GPIO1",buzzer:"GPIO45",buttons:{left:"GPIO5",right:"GPIO4",refresh:"GPIO3"}},battery:{attenuation:"12db",multiplier:2,calibration:{min:3.27,max:4.15}},features:{psram:!0,buzzer:!0,buttons:!0,sht4x:!0,epaper:!0}},trmnl_diy_esp32s3:{name:"Seeed Studio Trmnl DIY Kit (ESP32-S3)",displayType:"binary",displayModel:"7.50inv2p",displayPlatform:"waveshare_epaper",resolution:{width:800,height:480},shape:"rect",psram_mode:"octal",pins:{display:{cs:"GPIO44",dc:"GPIO10",reset:"GPIO38",busy:{number:"GPIO4",inverted:!0}},i2c:{sda:"GPIO17",scl:"GPIO18"},spi:{clk:"GPIO7",mosi:"GPIO9"},batteryEnable:"GPIO6",batteryAdc:"GPIO1",buzzer:null,buttons:{left:"GPIO2",refresh:"GPIO5"}},battery:{attenuation:"12db",multiplier:2,calibration:{min:3.27,max:4.15},curve:[{from:4.15,to:100},{from:3.96,to:90},{from:3.91,to:80},{from:3.85,to:70},{from:3.8,to:60},{from:3.75,to:50},{from:3.68,to:40},{from:3.58,to:30},{from:3.49,to:20},{from:3.41,to:10},{from:3.3,to:5},{from:3.27,to:0}]},features:{psram:!0,buzzer:!1,buttons:!0,sht4x:!1,epaper:!0,inverted_colors:!0}},trmnl:{name:"TRMNL (ESP32-C3)",displayType:"binary",displayModel:"7.50inv2",displayPlatform:"waveshare_epaper",resolution:{width:800,height:480},shape:"rect",pins:{display:{cs:"GPIO6",dc:"GPIO5",reset:{number:"GPIO10",inverted:!1},busy:{number:"GPIO4",inverted:!0}},i2c:{sda:"GPIO1",scl:"GPIO2"},spi:{clk:"GPIO7",mosi:"GPIO8"},batteryEnable:null,batteryAdc:"GPIO0",buzzer:null,buttons:null},battery:{attenuation:"12db",multiplier:2,calibration:{min:3.3,max:4.15}},features:{psram:!1,buzzer:!1,buttons:!1,sht4x:!1,epaper:!0,inverted_colors:!0}},esp32_s3_photopainter:{name:"Waveshare PhotoPainter (6-Color)",displayType:"color",displayModel:"7.30in-f",displayPlatform:"waveshare_epaper",resolution:{width:800,height:480},shape:"rect",psram_mode:"octal",pins:{display:{cs:"GPIO9",dc:"GPIO8",reset:"GPIO12",busy:{number:"GPIO13",inverted:!0}},i2c:{sda:"GPIO47",scl:"GPIO48"},spi:{clk:"GPIO10",mosi:"GPIO11"},batteryEnable:null,batteryAdc:null,buzzer:null,buttons:{left:"GPIO0",right:"GPIO4",refresh:null}},battery:{attenuation:"0db",multiplier:1,calibration:{min:3.3,max:4.2}},features:{psram:!0,buzzer:!1,buttons:!0,sht4x:!1,axp2101:!0,manual_pmic:!0,shtc3:!0,epaper:!0},i2c_config:{scan:!1,frequency:"10kHz"}},waveshare_esp32_s3_touch_lcd_7:{name:'Waveshare Touch LCD 7 7.0" 800x480',displayType:"color",isPackageBased:!0,hardwarePackage:"hardware/waveshare-esp32-s3-touch-lcd-7.yaml",resolution:{width:800,height:480},features:{psram:!0,buzzer:!1,buttons:!1,lcd:!0,lvgl:!0,touch:!0}},waveshare_esp32_s3_touch_lcd_4_3:{name:'Waveshare Touch LCD 4.3 4.3" 800x480',displayType:"color",isPackageBased:!0,hardwarePackage:"hardware/waveshare-esp32-s3-touch-lcd-4.3.yaml",resolution:{width:800,height:480},features:{psram:!0,buzzer:!1,buttons:!1,lcd:!0,touch:!0}},m5stack_coreink:{name:"M5Stack M5Core Ink (200x200)",displayType:"binary",displayModel:"1.54inv2",displayPlatform:"waveshare_epaper",resolution:{width:200,height:200},shape:"rect",features:{psram:!1,buzzer:!0,buttons:!0,lcd:!1,epaper:!0,inverted_colors:!0},pins:{display:{cs:"GPIO9",dc:"GPIO15",reset:"GPIO0",busy:null},i2c:{sda:"GPIO21",scl:"GPIO22"},spi:{clk:"GPIO18",mosi:"GPIO23"},batteryEnable:{number:"GPIO12",ignore_strapping_warning:!0},batteryAdc:"GPIO35",buzzer:"GPIO2",buttons:{left:{number:"GPIO39",mode:"INPUT"},right:{number:"GPIO37",mode:"INPUT"},refresh:{number:"GPIO38",mode:"INPUT"}}},battery:{attenuation:"12db",multiplier:2,calibration:{min:3.27,max:4.15}},i2c_config:{scan:!0}},m5stack_paper:{name:"M5Paper (540x960)",displayType:"grayscale",displayModel:"M5Paper",displayPlatform:"it8951e",resolution:{width:960,height:540},shape:"rect",features:{psram:!0,buzzer:!1,buttons:!0,lcd:!1,epaper:!0,touch:!0,inverted_colors:!0,sht3xd:!0},pins:{display:{cs:"GPIO15",dc:null,reset:"GPIO23",busy:"GPIO27"},i2c:{sda:"GPIO21",scl:"GPIO22"},spi:{clk:"GPIO14",mosi:"GPIO12",miso:"GPIO13"},batteryEnable:null,batteryAdc:"GPIO35",buzzer:null,buttons:{left:{number:"GPIO39",mode:"INPUT"},right:{number:"GPIO37",mode:"INPUT"},refresh:{number:"GPIO38",mode:"INPUT"}}},m5paper:{battery_power_pin:"GPIO5",main_power_pin:"GPIO2"},battery:{attenuation:"12db",multiplier:2,calibration:{min:3.27,max:4.15}},rotation_offset:180,touch:{platform:"gt911",i2c_id:"bus_a",address:93,interrupt_pin:"GPIO36",update_interval:"never",transform:{mirror_x:!1,mirror_y:!1,swap_xy:!0},calibration:{x_min:0,x_max:960,y_min:0,y_max:540}},external_components:["  - source: github://Passific/m5paper_esphome"]}};async function at(){try{const l=await Li();_.log(`[Devices] Loaded ${l.length} dynamic hardware templates.`),l.forEach(o=>{if(F[o.id]){const t=F[o.id];F[o.id]={...t,...o,features:{...t.features||{},...o.features||{}}}}else F[o.id]=o});const e=Pi(),i=Object.keys(e);i.length>0&&(_.log(`[Devices] Restoring ${i.length} offline profiles from localStorage.`),Object.entries(e).forEach(([o,t])=>{F[o]=t})),window.app&&window.app.deviceSettings&&typeof window.app.deviceSettings.populateDeviceSelect=="function"&&window.app.deviceSettings.populateDeviceSelect()}catch(l){_.error("Failed to load external hardware profiles:",l)}}const Qt=Object.freeze(Object.defineProperty({__proto__:null,DEVICE_PROFILES:F,SUPPORTED_DEVICE_IDS:Be,loadExternalProfiles:at},Symbol.toStringTag,{value:"Module"}));function Ee(){return window.currentDeviceModel||"reterminal_e1001"}function Mi(l){if(F&&F[l])return F[l].name;switch(l){case"reterminal_e1002":return"reTerminal E1002 (6-Color)";case"esp32_s3_photopainter":return"Waveshare PhotoPainter (7-Color)";case"trmnl":return"Official TRMNL (ESP32-C3)";case"reterminal_e1001":default:return"reTerminal E1001 (Monochrome)"}}function ei(){const l=Ee();return!!(F&&F[l]&&(F[l].features?.lcd||F[l].features?.oled))}function ti(){if(ei())return["black","white","red","green","blue","yellow","orange","gray","purple","cyan","magenta"];const l=Ee();return l==="reterminal_e1002"?["black","white","gray","red","green","blue","yellow"]:l==="esp32_s3_photopainter"?["black","white","gray","red","green","blue","yellow","orange"]:["black","white","gray"]}function It(l){if(!l)return"#000000";if(l.startsWith("#"))return l;if(l.startsWith("0x"))return"#"+l.substring(2);switch(l.toLowerCase()){case"white":return"#ffffff";case"red":return"#ff0000";case"green":return"#00ff00";case"blue":return"#0000ff";case"yellow":return"#ffff00";case"orange":return"#ffa500";case"gray":return"#a0a0a0";case"black":default:return"#000000"}}window.getDeviceModel=Ee;window.getDeviceDisplayName=Mi;window.isRGBDevice=ei;window.getAvailableColors=ti;window.getColorStyle=It;function Ai(l){if(!l)return 3600;const e=l.match(/^(\d+)([a-z]+)$/i);if(!e)return 3600;const i=parseInt(e[1],10),o=e[2].toLowerCase();return o.startsWith("s")?i:o.startsWith("m")?i*60:o.startsWith("h")?i*3600:o.startsWith("d")?i*86400:i}function Cs(l,e,i,o){const t=[];for(let s=0;s<50;s++){const r=s/49*l,d=s/50,c=Math.sin(d*Math.PI*2),a=(Math.random()-.5)*.2;let u=.5+c*.3+a;u=Math.max(.1,Math.min(.9,u));const m=e-u*e;t.push({x:r,y:m})}return t}function Ls(l,e,i,o,t){const n=document.createElementNS("http://www.w3.org/2000/svg","g");n.setAttribute("stroke","rgba(0,0,0,0.1)"),n.setAttribute("stroke-dasharray","2,2"),n.setAttribute("stroke-width","1");const s=4,r=4;for(let d=1;d<s;d++){const c=d/s*e,a=document.createElementNS("http://www.w3.org/2000/svg","line");a.setAttribute("x1",c),a.setAttribute("y1",0),a.setAttribute("x2",c),a.setAttribute("y2",i),n.appendChild(a)}for(let d=1;d<r;d++){const c=d/r*i,a=document.createElementNS("http://www.w3.org/2000/svg","line");a.setAttribute("x1",0),a.setAttribute("y1",c),a.setAttribute("x2",e),a.setAttribute("y2",c),n.appendChild(a)}l.appendChild(n)}function ks(l,e,i,o,t,n,s,r){l.querySelectorAll(".graph-axis-label").forEach(f=>f.remove());const c=s-n,a=4,u=typeof CANVAS_WIDTH<"u"?CANVAS_WIDTH:typeof window.CANVAS_WIDTH<"u"?window.CANVAS_WIDTH:800;for(let f=0;f<=a;f++){const v=n+c*(f/a),b=i+t-f/a*t,E=document.createElement("div");E.className="graph-axis-label",E.style.position="absolute",E.style.right=`${u-e+4}px`,E.style.top=`${b-6}px`,E.style.fontSize="10px",E.style.color="#666",E.style.textAlign="right",E.textContent=v.toFixed(1),l.appendChild(E)}const m=Ai(r),g=2;for(let f=0;f<=g;f++){const v=f/g,b=e+o*v;let E="";if(f===g)E="Now";else{const S=m*(1-v);S>=3600?E=`-${(S/3600).toFixed(1)}h`:S>=60?E=`-${(S/60).toFixed(0)}m`:E=`-${S.toFixed(0)}s`}const y=document.createElement("div");y.className="graph-axis-label",y.style.position="absolute",y.style.left=`${b}px`,y.style.top=`${i+t+4}px`,y.style.fontSize="10px",y.style.color="#666",y.style.transform="translateX(-50%)",y.textContent=E,l.appendChild(y)}}const J={getColorConst:l=>{if(!l)return"COLOR_BLACK";const e=l.toLowerCase();if(e.startsWith("#")&&e.length===7){const i=parseInt(e.substring(1,3),16),o=parseInt(e.substring(3,5),16),t=parseInt(e.substring(5,7),16);return`Color(${i}, ${o}, ${t})`}return xt[e]||"COLOR_BLACK"},getAlignX:(l,e,i)=>l.includes("LEFT")?`${e}`:l.includes("RIGHT")?`${e} + ${i}`:`${e} + ${i}/2`,getAlignY:(l,e,i)=>l.includes("TOP")?`${e}`:l.includes("BOTTOM")?`${e} + ${i}`:`${e} + ${i}/2`,sanitize:l=>l?l.replace(/"/g,'\\"'):"",addDitherMask:(l,e,i,o,t,n,s)=>{if(!i||!e)return;const r=e.toLowerCase();let d=r==="gray"||r==="grey";if(!d&&r.startsWith("#")&&r.length===7){const c=parseInt(r.substring(1,3),16),a=parseInt(r.substring(3,5),16),u=parseInt(r.substring(5,7),16);Math.abs(c-a)<15&&Math.abs(a-u)<15&&c>40&&c<210&&(d=!0)}d&&l.push(`          apply_grey_dither_mask(${Math.round(o)}, ${Math.round(t)}, ${Math.round(n)}, ${Math.round(s)});`)},getIconCode:l=>{if(!l||!window.iconPickerData)return null;const e=window.iconPickerData.find(i=>i.name===l);return e?e.code:null}};window.Utils=J;window.ESPHomeDesigner=window.ESPHomeDesigner||{};window.ESPHomeDesigner.utils=J;const ii=[{code:"F0004",name:"account"},{code:"F0026",name:"alert"},{code:"F0028",name:"alert-circle"},{code:"F0045",name:"arrow-down"},{code:"F004D",name:"arrow-left"},{code:"F0054",name:"arrow-right"},{code:"F005D",name:"arrow-up"},{code:"F0079",name:"battery"},{code:"F007C",name:"battery-50"},{code:"F0084",name:"battery-charging"},{code:"F009A",name:"bell"},{code:"F00AF",name:"bluetooth"},{code:"F00D8",name:"brightness-5"},{code:"F00ED",name:"calendar"},{code:"F0100",name:"camera"},{code:"F012C",name:"check"},{code:"F05E0",name:"check-circle"},{code:"F0140",name:"chevron-down"},{code:"F0141",name:"chevron-left"},{code:"F0142",name:"chevron-right"},{code:"F0143",name:"chevron-up"},{code:"F0150",name:"clock"},{code:"F0156",name:"close"},{code:"F015F",name:"cloud"},{code:"F0493",name:"cog"},{code:"F01B4",name:"delete"},{code:"F01D9",name:"dots-vertical"},{code:"F01DA",name:"download"},{code:"F01EE",name:"email"},{code:"F0208",name:"eye"},{code:"F0209",name:"eye-off"},{code:"F0210",name:"fan"},{code:"F0214",name:"file"},{code:"F021E",name:"flash"},{code:"F024B",name:"folder"},{code:"F0279",name:"format-list-bulleted"},{code:"F02D1",name:"heart"},{code:"F02DC",name:"home"},{code:"F07D0",name:"home-assistant"},{code:"F02E9",name:"image"},{code:"F02FC",name:"information"},{code:"F0322",name:"layers"},{code:"F0335",name:"lightbulb"},{code:"F06E8",name:"lightbulb-on"},{code:"F033E",name:"lock"},{code:"F033F",name:"lock-open"},{code:"F0349",name:"magnify"},{code:"F034E",name:"map-marker"},{code:"F035C",name:"menu"},{code:"F036C",name:"microphone"},{code:"F0374",name:"minus"},{code:"F075A",name:"music"},{code:"F03EB",name:"pencil"},{code:"F040A",name:"play"},{code:"F0415",name:"plus"},{code:"F0425",name:"power"},{code:"F0450",name:"refresh"},{code:"F048A",name:"send"},{code:"F0497",name:"share-variant"},{code:"F0565",name:"shield-check"},{code:"F04CE",name:"star"},{code:"F04DB",name:"stop"},{code:"F050F",name:"thermometer"},{code:"F0513",name:"thumb-up"},{code:"F051B",name:"timer-outline"},{code:"F0A79",name:"trash-can"},{code:"F0552",name:"upload"},{code:"F0571",name:"video"},{code:"F057E",name:"volume-high"},{code:"F0581",name:"volume-off"},{code:"F0585",name:"water"},{code:"F05E3",name:"water-percent"},{code:"F0590",name:"weather-cloudy"},{code:"F0591",name:"weather-fog"},{code:"F0592",name:"weather-hail"},{code:"F0593",name:"weather-lightning"},{code:"F0594",name:"weather-night"},{code:"F0595",name:"weather-partly-cloudy"},{code:"F0596",name:"weather-pouring"},{code:"F0597",name:"weather-rainy"},{code:"F0598",name:"weather-snowy"},{code:"F0599",name:"weather-sunny"},{code:"F059D",name:"weather-windy"},{code:"F05A9",name:"wifi"},{code:"F05AD",name:"window-close"}],At=typeof import.meta.glob=="function"?Object.assign({"../../features/battery_icon/plugin.js":()=>W(()=>import("./plugin-rEMyVgPL.js"),[],import.meta.url),"../../features/calendar/plugin.js":()=>W(()=>import("./plugin-CFTzl0hk.js"),[],import.meta.url),"../../features/datetime/plugin.js":()=>W(()=>import("./plugin-DkT1tikh.js"),[],import.meta.url),"../../features/graph/plugin.js":()=>W(()=>import("./plugin-aQvXYgQx.js"),[],import.meta.url),"../../features/icon/plugin.js":()=>W(()=>import("./plugin-Dv-fTJDx.js"),[],import.meta.url),"../../features/image/plugin.js":()=>W(()=>import("./plugin-VqWs_Rue.js"),[],import.meta.url),"../../features/line/plugin.js":()=>W(()=>import("./plugin-CwLUHNuJ.js"),[],import.meta.url),"../../features/lvgl_arc/plugin.js":()=>W(()=>import("./plugin-Bw9DcinN.js"),[],import.meta.url),"../../features/lvgl_bar/plugin.js":()=>W(()=>import("./plugin-BG3gdbwz.js"),[],import.meta.url),"../../features/lvgl_button/plugin.js":()=>W(()=>import("./plugin-CzgYl4EP.js"),[],import.meta.url),"../../features/lvgl_buttonmatrix/plugin.js":()=>W(()=>import("./plugin-DJJBIUVn.js"),[],import.meta.url),"../../features/lvgl_chart/plugin.js":()=>W(()=>import("./plugin-iyCSpUUB.js"),[],import.meta.url),"../../features/lvgl_checkbox/plugin.js":()=>W(()=>import("./plugin-BLLmkpKs.js"),[],import.meta.url),"../../features/lvgl_dropdown/plugin.js":()=>W(()=>import("./plugin-BASqPqZZ.js"),[],import.meta.url),"../../features/lvgl_img/plugin.js":()=>W(()=>import("./plugin-DqrH335l.js"),[],import.meta.url),"../../features/lvgl_keyboard/plugin.js":()=>W(()=>import("./plugin-DeB-lHQz.js"),[],import.meta.url),"../../features/lvgl_label/plugin.js":()=>W(()=>import("./plugin-CJ0E3HXg.js"),[],import.meta.url),"../../features/lvgl_led/plugin.js":()=>W(()=>import("./plugin-DhQy58ex.js"),[],import.meta.url),"../../features/lvgl_line/plugin.js":()=>W(()=>import("./plugin-Drklb84p.js"),[],import.meta.url),"../../features/lvgl_meter/plugin.js":()=>W(()=>import("./plugin-Bqb-RH9S.js"),[],import.meta.url),"../../features/lvgl_obj/plugin.js":()=>W(()=>import("./plugin-gHDuovlQ.js"),[],import.meta.url),"../../features/lvgl_qrcode/plugin.js":()=>W(()=>import("./plugin-TE63bYc8.js"),[],import.meta.url),"../../features/lvgl_roller/plugin.js":()=>W(()=>import("./plugin-CIeOk1Kb.js"),[],import.meta.url),"../../features/lvgl_slider/plugin.js":()=>W(()=>import("./plugin-CyxHxpFX.js"),[],import.meta.url),"../../features/lvgl_spinbox/plugin.js":()=>W(()=>import("./plugin-DNQHeoO9.js"),[],import.meta.url),"../../features/lvgl_spinner/plugin.js":()=>W(()=>import("./plugin-Ck_yh4qJ.js"),[],import.meta.url),"../../features/lvgl_switch/plugin.js":()=>W(()=>import("./plugin-StAG2_PG.js"),[],import.meta.url),"../../features/lvgl_tabview/plugin.js":()=>W(()=>import("./plugin-BToZq9GB.js"),[],import.meta.url),"../../features/lvgl_textarea/plugin.js":()=>W(()=>import("./plugin-BE3ZZhsJ.js"),[],import.meta.url),"../../features/lvgl_tileview/plugin.js":()=>W(()=>import("./plugin-eSvwYPfG.js"),[],import.meta.url),"../../features/ondevice_humidity/plugin.js":()=>W(()=>import("./plugin-CSPbBM1p.js"),[],import.meta.url),"../../features/ondevice_temperature/plugin.js":()=>W(()=>import("./plugin-DquRsumb.js"),[],import.meta.url),"../../features/online_image/plugin.js":()=>W(()=>import("./plugin-2FgNltOz.js"),[],import.meta.url),"../../features/progress_bar/plugin.js":()=>W(()=>import("./plugin-CmdjpQqI.js"),[],import.meta.url),"../../features/qr_code/plugin.js":()=>W(()=>import("./plugin-5FN-PdZb.js"),[],import.meta.url),"../../features/quote_rss/plugin.js":()=>W(()=>import("./plugin-C3NjRtPF.js"),[],import.meta.url),"../../features/rounded_rect/plugin.js":()=>W(()=>import("./plugin-CXjisUUd.js"),[],import.meta.url),"../../features/sensor_text/plugin.js":()=>W(()=>import("./plugin-lMb8BtEN.js"),[],import.meta.url),"../../features/shape_circle/plugin.js":()=>W(()=>import("./plugin-CLbthBmI.js"),[],import.meta.url),"../../features/shape_rect/plugin.js":()=>W(()=>import("./plugin-4iAO-NGx.js"),[],import.meta.url),"../../features/template_nav_bar/plugin.js":()=>W(()=>import("./plugin-D4I0d7Og.js"),[],import.meta.url),"../../features/template_sensor_bar/plugin.js":()=>W(()=>import("./plugin-oKz5Prsr.js"),[],import.meta.url),"../../features/text/plugin.js":()=>W(()=>import("./plugin-C3w-r4pE.js"),[],import.meta.url),"../../features/touch_area/plugin.js":()=>W(()=>import("./plugin-BokcJ6ld.js"),[],import.meta.url),"../../features/weather_forecast/plugin.js":()=>W(()=>import("./plugin-rAtam8oF.js"),[],import.meta.url),"../../features/weather_icon/plugin.js":()=>W(()=>import("./plugin-DzCKvyP9.js"),[],import.meta.url),"../../features/wifi_signal/plugin.js":()=>W(()=>import("./plugin-DHWC4f15.js"),[],import.meta.url)}):{};class Bi{constructor(){this.plugins=new Map,this.loading=new Map,this.aliases={label:"text",rectangle:"shape_rect",rrect:"rounded_rect",circle:"shape_circle",nav_next_page:"touch_area",nav_previous_page:"touch_area",nav_reload_page:"touch_area",puppet:"online_image"}}register(e){if(!e||!e.id){_.warn("[Registry] Invalid plugin registration attempt:",e);return}const i=e.id,o=this.plugins.get(i)||{};this.plugins.set(i,{...o,...e}),_.log(`[Registry] Registered: ${i}`)}get(e){const i=this.aliases[e]||e;return this.plugins.get(i)}getAll(){return Array.from(this.plugins.values())}async load(e){const i=this.aliases[e]||e;if(i==="group")return null;if(this.plugins.has(i))return this.plugins.get(i);if(this.loading.has(i))return this.loading.get(i);const o=(async()=>{try{const t=`../../features/${i}/plugin.js`;let n;return At[t]?n=await At[t]():(_.log(`[Registry] Using dynamic import fallback for: ${i}`),n=await import(t)),n.default?this.register(n.default):this.register({id:i,...n}),this.loading.delete(i),this.plugins.get(i)}catch(t){return _.error(`[Registry] Failed to load plugin "${i}" from ESM:`,t),this.loading.delete(i),null}})();return this.loading.set(i,o),o}onExportGlobals(e){this.getAll().forEach(i=>i.onExportGlobals&&i.onExportGlobals(e))}onExportNumericSensors(e){this.getAll().forEach(i=>i.onExportNumericSensors&&i.onExportNumericSensors(e))}onExportTextSensors(e){this.getAll().forEach(i=>i.onExportTextSensors&&i.onExportTextSensors(e))}onExportBinarySensors(e){this.getAll().forEach(i=>i.onExportBinarySensors&&i.onExportBinarySensors(e))}onExportHelpers(e){this.getAll().forEach(i=>i.onExportHelpers&&i.onExportHelpers(e))}onExportComponents(e){this.getAll().forEach(i=>i.onExportComponents&&i.onExportComponents(e))}onCollectRequirements(e){this.getAll().forEach(i=>i.collectRequirements&&i.collectRequirements(e))}}const Y=new Bi;window.PluginRegistry=Y;window.FeatureRegistry=Y;_.log("[Registry] Modular system ready.");let Ke=class ce{static getEffectiveDarkMode(){const i=h?.getCurrentPage?.()?.dark_mode;return i==="dark"?!0:i==="light"?!1:!!(h&&h.settings&&h.settings.dark_mode)}static getDefaultColor(){return ce.getEffectiveDarkMode()?"white":"black"}static getDefaultBgColor(){return ce.getEffectiveDarkMode()?"black":"white"}static getGridCellDefaults(){return{grid_cell_row_pos:null,grid_cell_column_pos:null,grid_cell_row_span:1,grid_cell_column_span:1,grid_cell_x_align:"STRETCH",grid_cell_y_align:"STRETCH"}}static isLvglWidget(e){return e&&e.startsWith("lvgl_")}static createWidget(e){const i=we(),o=ce.getDefaultColor(),t=ce.getDefaultBgColor();let n={id:i,type:e,x:40,y:40,width:120,height:40,title:"",entity_id:"",locked:!1,props:{}};switch(e){case"nav_next_page":return n.props={title:"Next",color:"rgba(0, 128, 255, 0.2)",border_color:"#0080ff",nav_action:"next_page",icon:"F0142",icon_size:48},n.width=80,n.height=80,n;case"nav_previous_page":return n.props={title:"Previous",color:"rgba(0, 128, 255, 0.2)",border_color:"#0080ff",nav_action:"previous_page",icon:"F0141",icon_size:48},n.width=80,n.height=80,n;case"nav_reload_page":return n.props={title:"Reload",color:"rgba(0, 128, 255, 0.2)",border_color:"#0080ff",nav_action:"reload_page",icon:"F0450",icon_size:48},n.width=80,n.height=80,n}const s=Y.get(e);return s&&s.defaults?(n.props={...s.defaults},(n.props.color==="black"||n.props.color==="white")&&(n.props.color=o),(n.props.bg_color==="black"||n.props.bg_color==="white")&&(n.props.bg_color=t),(n.props.background_color==="black"||n.props.background_color==="white")&&(n.props.background_color=t),(n.props.border_color==="black"||n.props.border_color==="white")&&(n.props.border_color=o),s.width&&(n.width=s.width),s.height&&(n.height=s.height),s.defaults.width&&(n.width=s.defaults.width),s.defaults.height&&(n.height=s.defaults.height),s.defaults.w&&(n.width=s.defaults.w),s.defaults.h&&(n.height=s.defaults.h),n):(ce.isLvglWidget(e)&&(n.props={...ce.getGridCellDefaults(),...n.props}),n)}};window.WidgetFactory=Ke;class Ri{constructor(){_.log("Sidebar: Constructor called"),this.pageListEl=document.getElementById("pageList"),this.pagesHeader=document.getElementById("pagesHeader"),this.pagesContent=document.getElementById("pagesContent"),this.widgetPaletteEl=document.getElementById("widgetPalette"),_.log("Sidebar: widgetPaletteEl found?",!!this.widgetPaletteEl),this.widgetPaletteEl||_.error("Sidebar: widgetPalette element not found!"),this.addPageBtn=document.getElementById("addPageBtn"),this.currentPageNameEl=document.getElementById("currentPageName"),this.hoverTimeout=null,this.hoveredPageIndex=-1}init(){_.log("Sidebar: init called");const e=document.getElementById("debug-overlay");e&&(e.innerHTML+="Sidebar.init called<br>"),Q(A.STATE_CHANGED,()=>this.render()),Q(A.PAGE_CHANGED,()=>this.render()),this.pagesHeader&&this.pagesContent&&this.pagesHeader.addEventListener("click",()=>{const t=this.pagesContent.classList.toggle("hidden"),n=this.pagesHeader.querySelector(".chevron");n&&(n.style.transform=t?"rotate(-90deg)":"rotate(0deg)")}),this.addPageBtn&&this.addPageBtn.addEventListener("click",()=>this.handleAddPage()),this.widgetPaletteEl&&(this.widgetPaletteEl.addEventListener("click",t=>this.handlePaletteClick(t)),this.widgetPaletteEl.addEventListener("dragstart",t=>{const n=t.target.closest(".item[data-widget-type]");if(n){const s=n.getAttribute("data-widget-type");_.log("[Sidebar] Drag start:",s),t.dataTransfer.setData("application/widget-type",s),t.dataTransfer.effectAllowed="copy"}})),document.addEventListener("click",t=>{const n=document.getElementById("debug-overlay");n&&(n.innerHTML+="Global click: "+t.target.tagName+"<br>")});const i=document.getElementById("clearAllBtn");i&&i.addEventListener("click",()=>this.handleClearPage());const o=document.getElementById("quickSearchBtn");o&&o.addEventListener("click",t=>{t.stopPropagation(),window.QuickSearch?window.QuickSearch.open():_.warn("Sidebar: QuickSearch instance not found on window")}),this.setupMobileToggles(),this.render()}render(){if(!this.pageListEl)return;this.pageListEl.innerHTML="";const e=h.pages,i=h.currentPageIndex;if(e.forEach((o,t)=>{const n=document.createElement("div");n.className="item"+(t===i?" active":""),n.draggable=!0,n.ondragstart=a=>{a.dataTransfer.setData("text/plain",t),a.dataTransfer.effectAllowed="move",n.style.opacity="0.5"},n.ondragend=()=>{n.style.opacity="1",Array.from(this.pageListEl.children).forEach(a=>{a.style.borderTop="",a.style.borderBottom=""})},n.ondragover=a=>{a.preventDefault();const u=a.dataTransfer.types.includes("application/widget-id"),m=a.dataTransfer.types.includes("application/widget-type");if(u||m){a.dataTransfer.dropEffect=u?"move":"copy",n.style.backgroundColor="var(--primary-subtle)",h.currentPageIndex!==t&&h.setCurrentPageIndex(t);return}const g=n.getBoundingClientRect(),f=g.top+g.height/2;a.clientY<f?(n.style.borderTop="2px solid var(--primary)",n.style.borderBottom=""):(n.style.borderTop="",n.style.borderBottom="2px solid var(--primary)")},n.ondragleave=a=>{const u=a.relatedTarget;n.contains(u)||this.hoveredPageIndex===t&&(this.hoverTimeout&&(clearTimeout(this.hoverTimeout),this.hoverTimeout=null),this.hoveredPageIndex=-1),n.style.borderTop="",n.style.borderBottom="",n.style.backgroundColor=""},n.ondrop=a=>{a.preventDefault(),this.hoverTimeout&&(clearTimeout(this.hoverTimeout),this.hoverTimeout=null),this.hoveredPageIndex=-1,n.style.borderTop="",n.style.borderBottom="",n.style.backgroundColor="";const u=a.dataTransfer.getData("application/widget-id");if(_.log(`[Sidebar] Drop detected on page ${t}. Widget ID:`,u),u){const f=t;f!==h.currentPageIndex&&(h.moveWidgetToPage(u,f),_.log(`[Sidebar] Moved widget ${u} to page ${f}`));return}const m=parseInt(a.dataTransfer.getData("text/plain"),10),g=t;this.handlePageReorder(m,g,a.clientY,n)},n.onclick=()=>{h.setCurrentPageIndex(t)};const s=document.createElement("span");s.className="item-icon",s.innerHTML=`<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="3" y1="9" x2="21" y2="9"></line>
                <line x1="9" y1="21" x2="9" y2="9"></line>
            </svg>`,n.appendChild(s);const r=document.createElement("span");r.className="label",r.textContent=o.name,n.appendChild(r);const d=document.createElement("div");d.style.marginLeft="auto",d.style.display="flex",d.style.gap="2px";const c=document.createElement("button");if(c.textContent="â",c.className="btn btn-secondary",c.style.padding="1px 4px",c.style.fontSize="8px",c.onclick=a=>{a.stopPropagation(),this.openPageSettings(t)},d.appendChild(c),e.length>1){const a=document.createElement("button");a.textContent="â",a.className="btn btn-secondary",a.style.padding="1px 4px",a.style.fontSize="8px",a.style.color="var(--danger)",a.onclick=u=>{u.stopPropagation(),this.handlePageDelete(t,o)},d.appendChild(a)}n.appendChild(d),this.pageListEl.appendChild(n)}),this.currentPageNameEl){const o=h.getCurrentPage();this.currentPageNameEl.textContent=o?o.name:"None"}}handleAddPage(){h.addPage()}handlePageReorder(e,i,o,t){if(e===i)return;const n=t.getBoundingClientRect(),s=n.top+n.height/2;let r=i;o>=s&&r++,e<r&&r--,e!==r&&h.reorderPage(e,r)}handlePaletteClick(e){const i=document.getElementById("debug-overlay");i&&(i.innerHTML+="handlePaletteClick triggered<br>"),_.log("Sidebar: handlePaletteClick",e.target);const o=e.target.closest(".item[data-widget-type]");if(!o){_.log("Sidebar: No item found"),i&&(i.innerHTML+="No item found<br>");return}const t=o.getAttribute("data-widget-type");_.log("Sidebar: Creating widget of type",t),i&&(i.innerHTML+="Creating widget: "+t+"<br>");try{const n=Ke.createWidget(t);_.log("Sidebar: Widget created",n),i&&(i.innerHTML+="Widget created<br>"),h.addWidget(n),_.log("Sidebar: Widget added to state"),i&&(i.innerHTML+="Widget added to state<br>")}catch(n){_.error("Sidebar: Error creating/adding widget",n),i&&(i.innerHTML+="Error: "+n.message+"<br>")}}openPageSettings(e){if(window.app&&window.app.pageSettings)window.app.pageSettings.open(e);else{_.error("Sidebar: PageSettings instance not found on window.app");const i=h.pages[e];window.currentPageSettingsTarget=i;const o=document.getElementById("pageSettingsModal");o&&(o.classList.remove("hidden"),o.style.display="flex")}}handlePageDelete(e,i){const o=document.createElement("div");o.className="modal-backdrop",o.style.display="flex",o.innerHTML=`
            <div class="modal" style="width: 320px; height: auto; min-height: 150px; padding: var(--space-4);">
                <div class="modal-header" style="font-size: var(--fs-md); padding-bottom: var(--space-2);">
                    <div>Delete Page</div>
                </div>
                <div class="modal-body" style="padding: var(--space-2) 0;">
                    <p style="margin-bottom: var(--space-3); font-size: var(--fs-sm);">
                        Are you sure you want to delete the page <b>"${i.name}"</b>?
                        <br><br>
                        This action cannot be undone.
                    </p>
                </div>
                <div class="modal-actions" style="padding-top: var(--space-3); border-top: 1px solid var(--border-subtle);">
                    <button class="btn btn-secondary close-btn btn-xs">Cancel</button>
                    <button class="btn btn-primary confirm-btn btn-xs" style="background: var(--danger); color: white; border: none;">Delete</button>
                </div>
            </div>
        `,document.body.appendChild(o);const t=()=>o.remove(),n=()=>{t();try{typeof h.deletePage=="function"?h.deletePage(e):(console.error("AppState.deletePage is missing"),typeof G=="function"&&G("Error: AppState.deletePage not found","error"))}catch(s){console.error("[Sidebar] Error deleting page:",s),typeof G=="function"&&G("Error deleting page: "+s.message,"error")}};o.querySelectorAll(".close-btn").forEach(s=>s.onclick=t),o.querySelector(".confirm-btn").onclick=n,o.onclick=s=>{s.target===o&&t()}}handleClearPage(){const e=h||window.AppState;if(!e){console.error("[Sidebar] AppState is not defined!"),typeof G=="function"&&G("Error: Application State is not ready.","error");return}const i=document.createElement("div");i.className="modal-backdrop",i.style.display="flex",i.innerHTML=`
            <div class="modal" style="width: 320px; height: auto; min-height: 180px; padding: var(--space-4);">
                <div class="modal-header" style="font-size: var(--fs-md); padding-bottom: var(--space-2);">
                    <div>Clear Page</div>
                </div>
                <div class="modal-body" style="padding: var(--space-2) 0;">
                    <p style="margin-bottom: var(--space-3); font-size: var(--fs-sm);">Are you sure you want to clear all widgets? <b>Locked</b> widgets will stay.</p>
                </div>
                <div class="modal-actions" style="padding-top: var(--space-3); border-top: 1px solid var(--border-subtle);">
                    <button class="btn btn-secondary close-btn btn-xs">Cancel</button>
                    <button class="btn btn-primary confirm-btn btn-xs" style="background: var(--danger); color: white; border: none;">Clear All</button>
                </div>
            </div>
        `,document.body.appendChild(i);const o=()=>{i.remove()},t=()=>{o();try{console.log("[Sidebar] Executing clearCurrentPage...");const r=e.clearCurrentPage(!0);r.preserved>0&&typeof G=="function"?G(`Cleared ${r.deleted} widgets. ${r.preserved} locked widget(s) were preserved.`,"info"):r.deleted>0?G(`Cleared all ${r.deleted} widgets.`,"success"):r.preserved>0?G(`No widgets cleared. ${r.preserved} locked widget(s) preserved.`,"info"):G("Page is already empty.","info"),_.log("Cleared widgets from current page via AppState")}catch(r){console.error("[Sidebar] Error clearing page:",r),typeof G=="function"&&G("Error clearing page: "+r.message,"error")}};i.querySelectorAll(".close-btn").forEach(r=>r.onclick=o);const s=i.querySelector(".confirm-btn");s.onclick=t,i.onclick=r=>{r.target===i&&o()}}setupMobileToggles(){const e=document.getElementById("mobileWidgetsBtn"),i=document.getElementById("mobilePropsBtn"),o=document.getElementById("mobileDeviceBtn"),t=document.getElementById("mobileBackdrop"),n=document.querySelector(".sidebar"),s=document.querySelector(".right-panel"),r=()=>{n?.classList.remove("mobile-active"),s?.classList.remove("mobile-active"),t?.classList.remove("active")};e?.addEventListener("click",()=>{const c=n?.classList.contains("mobile-active");r(),c||(n?.classList.add("mobile-active"),t?.classList.add("active"))}),i?.addEventListener("click",()=>{const c=s?.classList.contains("mobile-active");r(),c||(s?.classList.add("mobile-active"),t?.classList.add("active"))}),o?.addEventListener("click",()=>{r(),window.app?.deviceSettings?.open()}),t?.addEventListener("click",r),Q(A.SELECTION_CHANGED,()=>{window.innerWidth<=768&&(n?.classList.remove("mobile-active"),!s?.classList.contains("mobile-active")&&!n?.classList.contains("mobile-active")&&t?.classList.remove("active"))});const d=this.handlePaletteClick.bind(this);this.handlePaletteClick=c=>{d(c),window.innerWidth<=768&&r()}}}function _e(l){if(!l.canvas)return;const e=h.pages,i=h.getCanvasDimensions();l.canvas.querySelectorAll(".snap-guide");const o=l.canvas.querySelector(".lasso-selection");l.canvas.innerHTML="",h.settings.editor_light_mode?l.canvas.classList.add("light-mode"):l.canvas.classList.remove("light-mode");const t=h.getCurrentPage();t&&Bt(t)?l.viewport&&l.viewport.classList.add("device-dark-mode"):l.viewport&&l.viewport.classList.remove("device-dark-mode"),e.forEach((s,r)=>{const d=document.createElement("div");d.className="artboard-wrapper",d.dataset.index=r,r===h.currentPageIndex&&d.classList.add("active-page");const c=document.createElement("div");c.className="artboard-header",c.appendChild(ue("mdi-cog-outline","Page Settings",()=>{window.pageSettings&&window.pageSettings.open(r)}));const a=document.createElement("span");a.className="artboard-name",a.textContent=s.name||`Page ${r+1}`,c.appendChild(a);const u=document.createElement("div");u.className="artboard-actions",r>0&&u.appendChild(ue("mdi-chevron-left","Move Left",()=>{h.reorderPage(r,r-1)})),r<e.length-1&&u.appendChild(ue("mdi-chevron-right","Move Right",()=>{h.reorderPage(r,r+1)})),u.appendChild(ue("mdi-plus","Add Page After",()=>{h.addPage(r+1)})),u.appendChild(ue("mdi-eraser","Clear Current Page",()=>{Rt({title:"Clear Page",message:`Are you sure you want to clear all widgets from <b>"${s.name||`Page ${r+1}`}"</b>?<br><br>This cannot be undone.`,confirmLabel:"Clear Page",confirmClass:"btn-danger",onConfirm:()=>{h.setCurrentPageIndex(r),h.clearCurrentPage()}})})),u.appendChild(ue("mdi-delete-outline","Delete Page",()=>{Rt({title:"Delete Page",message:`Are you sure you want to delete the page <b>"${s.name||`Page ${r+1}`}"</b>?<br><br>All widgets on this page will be lost.`,confirmLabel:"Delete Page",confirmClass:"btn-danger",onConfirm:()=>{h.deletePage(r)}})})),c.appendChild(u),d.appendChild(c);const m=h.getCanvasShape(),g=m==="round"||m==="circle",f=document.createElement("div");f.className="artboard",f.dataset.index=r;const v=i.width,b=i.height;f.style.width=`${v}px`,f.style.height=`${b}px`;const E=Bt(s);if(f.classList.toggle("dark",E),f.classList.toggle("round-display",g),h.showGrid){const y=document.createElement("div");y.className="canvas-grid",f.appendChild(y)}s.layout&&/^\d+x\d+$/.test(s.layout)&&Di(f,s.layout,i,E);for(const y of s.widgets){const S=document.createElement("div");S.className="widget",S.style.left=y.x+"px",S.style.top=y.y+"px",S.style.width=y.width+"px",S.style.height=y.height+"px",S.dataset.id=y.id,S.dataset.pageIndex=r,h.selectedWidgetIds.includes(y.id)&&S.classList.add("active"),y.locked&&S.classList.add("locked"),y.hidden&&S.classList.add("hidden-widget");const T=(y.type||"").toLowerCase(),R=Y?Y.get(T):null;if(T==="group")S.classList.add("widget-group"),S.innerHTML="";else if(R&&R.render)try{const B=H=>H?It(H):E?"#ffffff":"#000000",k=h.selectedWidgetIds.includes(y.id),I=h.settings.device_model||"reterminal_e1001",L=F?F[I]:null;R.render(S,y,{getColorStyle:B,selected:k,profile:L})}catch{S.textContent=`Error: ${T}`,S.style.border="2px solid red"}else S.innerText=`Missing: ${T}`,S.style.color="red",S.style.border="1px dashed red";T!=="group"&&Oi(S),f.appendChild(S)}d.appendChild(f),l.canvas.appendChild(d)});const n=document.createElement("div");n.className="add-page-placeholder",n.title="Click to add a new page",n.style.width=`${i.width}px`,n.style.height=`${i.height}px`,n.style.marginTop="32px",n.innerHTML=`
        <div class="plus-icon">+</div>
        <div class="label">Add Page</div>
    `,n.onclick=s=>{if(s.stopPropagation(),h.addPage()){const d=h.pages.length-1;h.setCurrentPageIndex(d),D(A.STATE_CHANGED)}},l.canvas.appendChild(n),o&&l.canvas.appendChild(o),Ct(l)}function Bt(l){const e=l?.dark_mode;return e==="dark"?!0:e==="light"?!1:!!h.settings.dark_mode}function Di(l,e,i,o){const t=e.match(/^(\d+)x(\d+)$/);if(!t)return;const n=parseInt(t[1],10),s=parseInt(t[2],10),r=document.createElement("div");r.className="lvgl-grid-overlay",r.style.cssText=`
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        display: grid;
        grid-template-rows: repeat(${n}, 1fr);
        grid-template-columns: repeat(${s}, 1fr);
        pointer-events: none;
        z-index: 1;
    `;const d=o?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)",c=o?"rgba(255,255,255,0.3)":"rgba(0,0,0,0.25)";for(let a=0;a<n;a++)for(let u=0;u<s;u++){const m=document.createElement("div");m.style.cssText=`border: 1px dashed ${d}; position: relative; box-sizing: border-box;`;const g=document.createElement("span");g.textContent=`${a},${u}`,g.style.cssText=`position: absolute; top: 2px; left: 4px; font-size: 8px; color: ${c}; pointer-events: none;`,m.appendChild(g),r.appendChild(m)}l.appendChild(r)}function se(l){const e=h.zoomLevel,i=h.settings;l.canvasContainer&&(l.canvasContainer.style.transform=`translate(${l.panX}px, ${l.panY}px) scale(${e})`,l.canvasContainer.style.transformOrigin="0 0");const o=(i.grid_opacity!==void 0?i.grid_opacity:8)/100;document.documentElement.style.setProperty("--grid-opacity",o.toString());const t=document.getElementById("zoomLevel");t&&(t.textContent=Math.round(e*100)+"%")}function Re(l,e,i=!0){const t=l.canvas.querySelectorAll(".artboard-wrapper")[e];if(t){const n=l.viewport.getBoundingClientRect(),s=n.width,r=n.height;if(s===0||r===0){requestAnimationFrame(()=>Re(l,e,i));return}const d=h.zoomLevel,c=t.offsetLeft+t.offsetWidth/2,a=t.offsetTop+t.offsetHeight/2;l.panX=s/2-c*d,l.panY=r/2-a*d,se(l)}}function Me(l,e,i=!1){if(!e||!e.id)return;const o=l.canvas.querySelector(`.widget[data-id="${e.id}"]`);if(o){o.style.left=e.x+"px",o.style.top=e.y+"px",o.style.width=e.width+"px",o.style.height=e.height+"px";const t=(e.type||"").toLowerCase(),n=Y?Y.get(t):null;if(t==="group")o.classList.add("widget-group");else if(!i&&n&&n.render)try{const s=a=>{const u=si()?"dark":"light";return a?It(a):u==="dark"?"#ffffff":"#000000"},r=h.selectedWidgetIds.includes(e.id),d=h.settings.device_model||"reterminal_e1001",c=F?F[d]:null;n.render(o,e,{getColorStyle:s,selected:r,profile:c})}catch{}}}function si(){const e=h.getCurrentPage()?.dark_mode;return e==="dark"?!0:e==="light"?!1:!!h.settings.dark_mode}function Oi(l){["tl","tc","tr","rc","br","bc","bl","lc"].forEach(i=>{const o=document.createElement("div");o.className=`widget-resize-handle handle-${i}`,o.dataset.handle=i,l.appendChild(o)})}function Ct(l){const e=h.selectedWidgetIds,i=l.canvas.querySelector(`.artboard[data-index="${h.currentPageIndex}"]`);let o=l.canvas.querySelector(".context-toolbar");if(e.length===0||l.dragState||l.lassoState||!i){o&&o.remove();return}const t=h.getSelectedWidgets();if(t.length===0){o&&o.remove();return}let n=1/0,s=1/0,r=-1/0,d=-1/0;t.forEach(m=>{n=Math.min(n,m.x),s=Math.min(s,m.y),r=Math.max(r,m.x+(m.width||0)),d=Math.max(d,m.y+(m.height||0))});const c=n,a=s-45;if(o?o.parentElement!==i&&i.appendChild(o):(o=document.createElement("div"),o.className="context-toolbar",i.appendChild(o)),o.style.left=c+"px",o.style.top=a+"px",o.innerHTML="",e.length>1&&([{icon:"mdi-align-horizontal-left",title:"Align Left",action:"left"},{icon:"mdi-align-horizontal-center",title:"Align Center",action:"center"},{icon:"mdi-align-horizontal-right",title:"Align Right",action:"right"},{separator:!0},{icon:"mdi-align-vertical-top",title:"Align Top",action:"top"},{icon:"mdi-align-vertical-center",title:"Align Middle",action:"middle"},{icon:"mdi-align-vertical-bottom",title:"Align Bottom",action:"bottom"}].forEach(g=>{if(g.separator){ke(o);return}ve(o,g.icon,g.title,()=>h.alignSelectedWidgets(g.action))}),e.length>=3&&(ke(o),ve(o,"mdi-distribute-horizontal-center","Distribute Horizontally",()=>h.distributeSelectedWidgets("horizontal")),ve(o,"mdi-distribute-vertical-center","Distribute Vertically",()=>h.distributeSelectedWidgets("vertical")))),t.some(m=>m.type==="group"||m.parentId)?(o.children.length>0&&ke(o),ve(o,"mdi-ungroup","Ungroup (Ctrl+Shift+G)",()=>h.ungroupSelection())):e.length>1&&(o.children.length>0&&ke(o),ve(o,"mdi-group","Group Selection (Ctrl+G)",()=>h.groupSelection())),o.children.length===0){o.remove();return}}function ve(l,e,i,o){const t=document.createElement("button");t.className="btn-icon",t.title=i,t.innerHTML=`<i class="mdi ${e}"></i>`,t.onclick=n=>{n.stopPropagation(),o()},l.appendChild(t)}function ke(l){if(!l.lastElementChild||l.lastElementChild.classList.contains("separator"))return;const e=document.createElement("div");e.className="separator",l.appendChild(e)}function ue(l,e,i){const o=document.createElement("button");return o.className="artboard-btn",o.title=e,o.innerHTML=`<i class="mdi ${l}"></i>`,o.onclick=t=>{t.stopPropagation(),i()},o}function Rt({title:l,message:e,confirmLabel:i,confirmClass:o,onConfirm:t}){const n=document.createElement("div");n.className="modal-backdrop",n.style.display="flex",n.innerHTML=`
        <div class="modal" style="width: 340px; height: auto; padding: var(--space-4); border-radius: 12px; border: 1px solid var(--glass-border);">
            <div class="modal-header" style="font-size: var(--fs-md); font-weight: 600; padding-bottom: var(--space-3); border-bottom: 1px solid var(--border-subtle);">
                <div>${l}</div>
            </div>
            <div class="modal-body" style="padding: var(--space-4) 0;">
                <p style="font-size: var(--fs-sm); line-height: 1.5; color: var(--text-dim);">
                    ${e}
                </p>
            </div>
            <div class="modal-actions" style="display: flex; gap: 8px; justify-content: flex-end; padding-top: var(--space-3);">
                <button class="btn btn-secondary close-btn btn-xs" style="border-radius: 6px;">Cancel</button>
                <button class="btn ${o} confirm-btn btn-xs" style="border-radius: 6px;">${i||"Confirm"}</button>
            </div>
        </div>
    `,document.body.appendChild(n);const s=n.querySelector(".close-btn"),r=n.querySelector(".confirm-btn");s.onclick=()=>n.remove(),r.onclick=()=>{t(),n.remove()}}const Wi=Object.freeze(Object.defineProperty({__proto__:null,applyZoom:se,focusPage:Re,getEffectiveDarkMode:si,render:_e,renderContextToolbar:Ct,updateWidgetDOM:Me},Symbol.toStringTag,{value:"Module"}));class Ni{constructor(e){this.canvasInstance=e,this.topRuler=document.getElementById("rulerTop"),this.leftRuler=document.getElementById("rulerLeft"),this.container=document.querySelector(".canvas-rulers"),this.viewport=e.viewport,this.indicators=null,this.init()}init(){!this.topRuler||!this.leftRuler||(this.topCtx=this.createRulerCanvas(this.topRuler),this.leftCtx=this.createRulerCanvas(this.leftRuler),this.update())}createRulerCanvas(e){const i=document.createElement("canvas");return e.appendChild(i),i.getContext("2d")}setIndicators(e){this.indicators=e,this.update()}update(){if(!h.showRulers){this.container&&(this.container.style.display="none"),this.viewport&&this.viewport.classList.remove("with-rulers");return}this.container&&(this.container.style.display="block"),this.viewport&&this.viewport.classList.add("with-rulers");const e=document.querySelector(".artboard-wrapper.active-page .artboard");if(!e)return;const i=this.topRuler.getBoundingClientRect(),o=this.leftRuler.getBoundingClientRect(),t=e.getBoundingClientRect(),n=h.zoomLevel;this.drawHorizontal(i,t,n),this.drawVertical(o,t,n)}drawHorizontal(e,i,o){const t=this.topCtx,n=t.canvas,s=window.devicePixelRatio||1;(n.width!==e.width*s||n.height!==e.height*s)&&(n.width=e.width*s,n.height=e.height*s,t.scale(s,s),n.style.width=e.width+"px",n.style.height=e.height+"px"),t.clearRect(0,0,e.width,e.height);const r=i.left-e.left;if(this.indicators){const a=r+this.indicators.x*o,u=(this.indicators.w||0)*o;t.fillStyle="hsla(var(--accent-h), 85%, 65%, 0.15)",t.fillRect(a,0,u,e.height),t.fillStyle="var(--accent)",t.fillRect(a,e.height-2,u,2)}t.strokeStyle="#4b5563",t.fillStyle="#9ca3af",t.font='9px "JetBrains Mono", monospace',t.lineWidth=1;const d=Math.floor(-r/o/10)*10,c=Math.ceil((e.width-r)/o/10)*10;for(let a=d;a<=c;a+=10){const u=r+a*o;if(u<0||u>e.width)continue;const m=a%100===0,g=a%50===0,f=m?12:g?8:4;t.beginPath(),t.moveTo(u,e.height),t.lineTo(u,e.height-f),t.stroke(),m&&t.fillText(a.toString(),u+2,10)}}drawVertical(e,i,o){const t=this.leftCtx,n=t.canvas,s=window.devicePixelRatio||1;(n.width!==e.width*s||n.height!==e.height*s)&&(n.width=e.width*s,n.height=e.height*s,t.scale(s,s),n.style.width=e.width+"px",n.style.height=e.height+"px"),t.clearRect(0,0,e.width,e.height);const r=i.top-e.top;if(this.indicators){const a=r+this.indicators.y*o,u=(this.indicators.h||0)*o;t.fillStyle="hsla(var(--accent-h), 85%, 65%, 0.15)",t.fillRect(0,a,e.width,u),t.fillStyle="var(--accent)",t.fillRect(e.width-2,a,2,u)}t.strokeStyle="#4b5563",t.fillStyle="#9ca3af",t.font='9px "JetBrains Mono", monospace',t.lineWidth=1;const d=Math.floor(-r/o/10)*10,c=Math.ceil((e.height-r)/o/10)*10;for(let a=d;a<=c;a+=10){const u=r+a*o;if(u<0||u>e.height)continue;const m=a%100===0,g=a%50===0,f=m?12:g?8:4;t.beginPath(),t.moveTo(e.width,u),t.lineTo(e.width-f,u),t.stroke(),m&&(t.save(),t.translate(10,u+2),t.rotate(-Math.PI/2),t.fillText(a.toString(),0,0),t.restore())}}}function ae(){document.querySelectorAll(".snap-guide").forEach(e=>e.remove())}function $i(l,e,i){const o=i||l.canvas;if(!o||typeof o.appendChild!="function")return;const t=document.createElement("div");t.className="snap-guide snap-guide-vertical",t.style.left=`${Math.round(e)}px`,o.appendChild(t)}function Hi(l,e,i){const o=i||l.canvas;if(!o||typeof o.appendChild!="function")return;const t=document.createElement("div");t.className="snap-guide snap-guide-horizontal",t.style.top=`${Math.round(e)}px`,o.appendChild(t)}function Fi(l,e){const i=h.getCurrentPage(),o=[],t=[];if(o.push(0,e.width/2,e.width),t.push(0,e.height/2,e.height),i&&Array.isArray(i.widgets))for(const n of i.widgets){if(!n||n.id===l)continue;const s=n.x,r=n.x+(n.width||0),d=n.y,c=n.y+(n.height||0),a=s+(n.width||0)/2,u=d+(n.height||0)/2;o.push(s,a,r),t.push(d,u,c)}return{vertical:o,horizontal:t}}function Dt(l,e,i,o,t){const n=t||l.canvas;if(!n)return;const s=document.createElement("div");s.className=`snap-guide distance-marker distance-marker-${o}`;let r,d,c,a,u;if(o==="h"){const g=e.x<i.x?e.x+e.w:i.x+i.w,f=e.x<i.x?i.x:e.x;if(r=g,d=Math.min(e.y+e.h/2,i.y+i.h/2),c=f-g,c<=0)return;u=Math.round(c),s.style.left=`${r}px`,s.style.top=`${d}px`,s.style.width=`${c}px`,s.style.height="1px";const v=document.createElement("div");v.className="distance-marker-h-tick-start";const b=document.createElement("div");b.className="distance-marker-h-tick-end",s.appendChild(v),s.appendChild(b)}else{const g=e.y<i.y?e.y+e.h:i.y+i.h,f=e.y<i.y?i.y:e.y;if(d=g,r=Math.min(e.x+e.w/2,i.x+i.w/2),a=f-g,a<=0)return;u=Math.round(a),s.style.left=`${r}px`,s.style.top=`${d}px`,s.style.width="1px",s.style.height=`${a}px`;const v=document.createElement("div");v.className="distance-marker-v-tick-start";const b=document.createElement("div");b.className="distance-marker-v-tick-end",s.appendChild(v),s.appendChild(b)}const m=document.createElement("div");m.className="distance-marker-label",m.textContent=u,s.appendChild(m),n.appendChild(s)}function Lt(l,e,i,o,t,n,s,r=!1){if(!h.snapEnabled||t)return ae(),{x:Math.round(i),y:Math.round(o)};const c=(h.getCurrentPage()?.widgets||[]).filter(B=>B.id!==e.id&&!B.hidden),a=Fi(e.id,n),u=e.width||0,m=e.height||0;let g=i,f=o,v=null,b=null;const E=[{val:i,apply:B=>g=B},{val:i+u/2,apply:B=>g=B-u/2},{val:i+u,apply:B=>g=B-u}];let y=me+1;for(const B of E)for(const k of a.vertical){const I=Math.abs(B.val-k);I<=me&&I<y&&(y=I,v=k,B.apply(k))}const S=[{val:o,apply:B=>f=B},{val:o+m/2,apply:B=>f=B-m/2},{val:o+m,apply:B=>f=B-m}];let T=me+1;for(const B of S)for(const k of a.horizontal){const I=Math.abs(B.val-k);I<=me&&I<T&&(T=I,b=k,B.apply(k))}const R={x:g,y:f,w:u,h:m};return ae(),v!=null&&$i(l,v,s),b!=null&&Hi(l,b,s),r&&c.forEach(B=>{const k={x:B.x,y:B.y,w:B.width,h:B.height};if(R.y<k.y+k.h&&R.y+R.h>k.y){const H=R.x<k.x?k.x-(R.x+R.w):R.x-(k.x+k.w);H>0&&H<150&&Dt(l,R,k,"h",s)}if(R.x<k.x+k.w&&R.x+R.w>k.x){const H=R.y<k.y?k.y-(R.y+R.h):R.y-(k.y+k.h);H>0&&H<150&&Dt(l,R,k,"v",s)}}),{x:Math.round(g),y:Math.round(f)}}function kt(l,e,i,o,t,n){const s=t.match(/^(\d+)x(\d+)$/);if(!s)return{x:l,y:e};const r=parseInt(s[1],10),d=parseInt(s[2],10),c=n.width/d,a=n.height/r,u=l+i/2,m=e+o/2,g=Math.round(u/c-.5),f=Math.round(m/a-.5),v=Math.max(0,Math.min(d-1,g)),b=Math.max(0,Math.min(r-1,f));return{x:Math.round(v*c),y:Math.round(b*a)}}function ni(l){const e=h.getCurrentPage();if(!e||!e.layout)return;const i=e.layout.match(/^(\d+)x(\d+)$/);if(!i)return;const o=h.getWidgetById(l);if(!o)return;const t=parseInt(i[1],10),n=parseInt(i[2],10),s=h.getCanvasDimensions(),r=s.width/n,d=s.height/t,c=o.x+o.width/2,a=o.y+o.height/2,u=Math.floor(c/r),m=Math.floor(a/d),g=Math.max(0,Math.min(t-1,m)),f=Math.max(0,Math.min(n-1,u)),v={...o.props,grid_cell_row_pos:g,grid_cell_column_pos:f},b=Math.max(1,Math.round(o.height/d)),E=Math.max(1,Math.round(o.width/r));v.grid_cell_row_span=b,v.grid_cell_column_span=E,h.updateWidget(l,{props:v})}function zi(l){const e=h.getWidgetById(l);if(!e)return;const i=h.getCanvasDimensions(),o=h.getCurrentPage();let t;if(o?.layout)t=kt(e.x,e.y,e.width,e.height,o.layout,i);else{const n=h.snapEnabled;h.snapEnabled=!0,t=Lt({canvas:{querySelectorAll:()=>[]}},e,e.x,e.y,!1,i),h.snapEnabled=n}t&&(h.updateWidget(l,{x:t.x,y:t.y}),ni(l),h.recordHistory())}let lt=null,Ot=!1;Object.defineProperty(window,"lastHighlightRange",{get:()=>lt,set:function(l){lt=l},configurable:!0});Object.defineProperty(window,"isAutoHighlight",{get:()=>Ot,set:function(l){Ot=l},configurable:!0});function Te(l){const e=document.getElementById("snippetBox");if(!e)return;const i=e.value;if(!i)return;const o=Array.isArray(l)?l:l?[l]:[];if(o.length===0){try{e.setSelectionRange(0,0),e.scrollTop=0,lt=null}catch{}return}let t=-1,n=-1;if(o.forEach(s=>{const r=`id:${s}`,d=i.indexOf(r);if(d!==-1){const c=i.lastIndexOf(`
`,d)+1,a=["# widget:","// widget:","// page:"],u=["esphome:","logger:","api:","ota:","wifi:","ethernet:","psram:","substitutions:","external_components:","packages:","globals:","sensor:","binary_sensor:","text_sensor:","time:","script:","font:","image:","animation:","display:","lvgl:","i2c:","spi:","uart:","output:","light:","switch:","button:","number:","select:","climate:","fan:","cover:"];let m=-1;a.forEach(f=>{const v=i.indexOf(f,d+r.length);v!==-1&&(m===-1||v<m)&&(m=v)}),u.forEach(f=>{const v=`
`+f,b=i.indexOf(v,d+r.length);b!==-1&&(m===-1||b<m)&&(m=b+1)});const g=m!==-1?m:i.length;(t===-1||c<t)&&(t=c),g>n&&(n=g)}}),t!==-1&&n!==-1){const s=document.activeElement?document.activeElement.tagName.toLowerCase():"",r=(s==="input"||s==="textarea")&&document.activeElement!==e,d=window.Canvas&&(window.Canvas.dragState||window.Canvas.lassoState);if(!r&&!d){window.isAutoHighlight=!0;try{e.setSelectionRange(t,n),o.length===1&&!window._undoRedoInProgress&&e.focus()}catch{}}window.lastHighlightRange={start:t,end:n},setTimeout(()=>{if(e.scrollTo){const c=i.substring(0,t).split(`
`),a=i.split(`
`).length,u=c.length,m=e.scrollHeight/a;e.scrollTop=u*m-50,e.scrollLeft=0}},10)}}function Wt(){const l=document.getElementById("snippetBox");if(!l)return;const e=()=>{window.isAutoHighlight&&(window.isAutoHighlight=!1)};l.addEventListener("mousedown",e),l.addEventListener("input",e),l.addEventListener("keydown",i=>{(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Tab","Home","End"].includes(i.key)||!i.ctrlKey&&!i.metaKey)&&e()}),_.log("[YAML Export] Interaction listeners attached to Snippet Box.")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Wt):Wt();let tt=0,it=null;function Gi(l,e){const i=h.getWidgetById(e);if(!i)return;const o=(i.type||"").toLowerCase();if(o!=="text"&&o!=="label")return;const t=l.canvas.querySelector(`.widget[data-id="${e}"]`);if(!t)return;const n=h.zoomLevel,s=t.getBoundingClientRect(),r=document.createElement("textarea");r.value=i.props.text||i.title||"",r.style.position="absolute",r.style.left=s.left+window.scrollX+"px",r.style.top=s.top+window.scrollY+"px",r.style.width=Math.max(50,s.width)+"px",r.style.height=Math.max(30,s.height)+"px",r.style.zIndex="99999";const d=i.props||{},c=(d.font_size||20)*n;r.style.fontSize=c+"px",r.style.fontFamily=(d.font_family||"Roboto")+", sans-serif",r.style.fontWeight=d.font_weight||400,r.style.fontStyle=d.italic?"italic":"normal",r.style.textAlign=(d.text_align||"LEFT").split("_").pop().toLowerCase(),r.style.color=d.color||"black",r.style.background="rgba(255, 255, 255, 0.9)",r.style.border="1px solid #1a73e8",r.style.padding="0px",r.style.resize="both",r.style.outline="none",r.style.overflow="hidden",r.style.lineHeight="1.2",document.body.appendChild(r),r.focus(),r.select();const a=()=>{if(!r.isConnected&&!r.parentElement)return;r.removeEventListener("blur",u),r.removeEventListener("keydown",m);const g=r.value;g!==(i.props.text||i.title)&&h.updateWidget(e,{props:{...i.props,text:g}}),r.remove()},u=()=>a(),m=g=>{g.key==="Enter"&&!g.shiftKey&&(g.preventDefault(),a()),g.key==="Escape"&&r.remove(),r.style.height=r.scrollHeight+"px"};r.addEventListener("blur",u),r.addEventListener("keydown",m)}function ji(l){l.canvas.addEventListener("mousedown",e=>{if(e.button!==0)return;ae();const i=e.target.closest(".artboard-wrapper");if(!i||e.target.closest(".artboard-btn")||e.target.closest("button")){document.activeElement&&!e.target.closest("button")&&document.activeElement.blur();return}const o=parseInt(i.dataset.index,10),t=i.querySelector(".artboard");let n=t;const s=e.target.closest(".widget");let r=s?.dataset.id;const d=h.currentPageIndex!==o,c=!!e.target.closest(".artboard-header"),a=!!e.target.closest(".artboard")&&!s;if(d){const g=[...h.selectedWidgetIds];h.setCurrentPageIndex(o,{suppressFocus:!0}),r&&h.selectWidgets(g.includes(r)?g:[r]),Re(l,o,!0);const f=l.canvas.querySelector(`.artboard[data-index="${o}"]`);f&&(n=f)}else(c||a)&&Re(l,o,!0);const u=n.getBoundingClientRect(),m=h.zoomLevel;if(s){const g=s.dataset.id,f=e.shiftKey||e.ctrlKey,v=Date.now();if(g===it&&v-tt<300){Gi(l,g),tt=0,it=null,e.preventDefault(),e.stopPropagation();return}tt=v,it=g,f?h.selectWidget(g,!0):h.selectedWidgetIds.includes(g)||h.selectWidget(g,!1);const b=h.getWidgetById(g);if(!b)return;let E=b,y=g;if(b.parentId){const T=h.getWidgetById(b.parentId);T&&(E=T,y=T.id,h.selectWidget(y,f))}if(e.target.classList.contains("widget-resize-handle")){if(b.parentId||E.locked)return;l.dragState={mode:"resize",handle:e.target.dataset.handle||"br",id:y,startX:e.clientX,startY:e.clientY,startW:E.width,startH:E.height,startWidgetX:E.x,startWidgetY:E.y,artboardEl:n,dragStartPanX:l.panX,dragStartPanY:l.panY}}else{if(E.locked)return;const R=h.getSelectedWidgets().map(B=>({id:B.id,startX:B.x,startY:B.y,clickOffsetX:(e.clientX-u.left)/m-B.x,clickOffsetY:(e.clientY-u.top)/m-B.y}));l.dragState={mode:"move",id:y,widgets:R,artboardEl:n,dragStartX:e.clientX,dragStartY:e.clientY,dragStartPanX:l.panX,dragStartPanY:l.panY},l.rulers&&l.rulers.setIndicators({x:E.x,y:E.y,w:E.width,h:E.height})}window.addEventListener("mousemove",l._boundMouseMove),window.addEventListener("mouseup",l._boundMouseUp),e.preventDefault()}else{const g=(e.clientX-u.left)/m,f=(e.clientY-u.top)/m;l.lassoState={startX:g,startY:f,rect:null,isAdditive:e.shiftKey||e.ctrlKey,initialSelection:[...h.selectedWidgetIds],artboardEl:n},l.lassoEl=document.createElement("div"),l.lassoEl.className="lasso-selection",t.appendChild(l.lassoEl),window.addEventListener("mousemove",l._boundMouseMove),window.addEventListener("mouseup",l._boundMouseUp),e.preventDefault()}}),l.canvas.addEventListener("contextmenu",e=>{e.preventDefault();const i=e.target.closest(".widget"),o=i?i.dataset.id:null;window.RadialMenu&&window.RadialMenu.show(e.clientX,e.clientY,o)})}function Ui(l,e){const i=h.zoomLevel,o=h.getCanvasDimensions();if(e.dragState){if(e.dragState.mode==="move"){const t=document.querySelector(`.artboard[data-index="${h.currentPageIndex}"]`);if(!t)return;const n=(l.clientX-e.dragState.dragStartX)/i+(e.dragState.dragStartPanX-e.panX)/i,s=(l.clientY-e.dragState.dragStartY)/i+(e.dragState.dragStartPanY-e.panY)/i,r=h.getWidgetById(e.dragState.id);if(!r)return;const d=e.dragState.widgets.find(b=>b.id===e.dragState.id);if(!d)return;let c=d.startX+n,a=d.startY+s;const u=h.getCurrentPage();if(u?.layout&&!l.altKey){ae();const b=kt(c,a,r.width,r.height,u.layout,o);c=b.x,a=b.y}else if(h.snapEnabled&&!l.altKey){const b=Lt(e,r,c,a,l.altKey,o,t,l.ctrlKey);c=b.x,a=b.y}else ae();c=Math.max(0,Math.min(o.width-r.width,c)),a=Math.max(0,Math.min(o.height-r.height,a));const m=c-d.startX,g=a-d.startY,f=m,v=g;for(const b of e.dragState.widgets){const E=h.getWidgetById(b.id);E&&!E.locked&&(E.x=b.startX+f,E.y=b.startY+v,Me(e,E,!0),E.type==="group"&&u.widgets.filter(S=>S.parentId===E.id).forEach(S=>{e.dragState.widgets.find(T=>T.id===S.id)||(S.x+=f-(e.dragState.lastDx||0),S.y+=v-(e.dragState.lastDy||0),Me(e,S,!0))}))}e.dragState.lastDx=f,e.dragState.lastDy=v,e.rulers&&e.rulers.setIndicators({x:c,y:a,w:r.width,h:r.height})}else if(e.dragState.mode==="resize"){const t=h.getWidgetById(e.dragState.id);if(!t)return;const n=e.dragState,s=n.handle,r=(n.dragStartPanX-e.panX)/i,d=(n.dragStartPanY-e.panY)/i,c=(l.clientX-n.startX)/i+r,a=(l.clientY-n.startY)/i+d;let u=n.startWidgetX,m=n.startWidgetY,g=n.startW,f=n.startH;s.includes("l")?(g=n.startW-c,u=n.startWidgetX+c):s.includes("r")&&(g=n.startW+c),s.includes("t")?(f=n.startH-a,m=n.startWidgetY+a):s.includes("b")&&(f=n.startH+a);const v=4;isNaN(g)&&(g=n.startW),isNaN(f)&&(f=n.startH),g<v&&(s.includes("l")&&(u=n.startWidgetX+n.startW-v),g=v),f<v&&(s.includes("t")&&(m=n.startWidgetY+n.startH-v),f=v);const b=(t.type||"").toLowerCase();if(b==="line"||b==="lvgl_line"){const E=t.props||{},y=E.orientation||"horizontal",S=parseInt(E.stroke_width||E.line_width||3,10);y==="vertical"?(g=S,f=Math.max(10,f)):(f=S,g=Math.max(10,g))}if(u=Math.max(0,Math.min(o.width-g,u)),m=Math.max(0,Math.min(o.height-f,m)),t.x=Math.round(u),t.y=Math.round(m),t.width=Math.round(g),t.height=Math.round(f),b==="icon"||b==="weather_icon"||b==="battery_icon"||b==="wifi_signal"||b==="ondevice_temperature"||b==="ondevice_humidity"){const E=t.props||{};if(E.fit_icon_to_frame){const S=Math.max(8,Math.min(t.width-8,t.height-8));E.size=Math.round(S)}else{const y=Math.max(8,Math.min(t.width,t.height));E.size=Math.round(y)}}else if(b==="shape_circle"){const E=Math.max(t.width,t.height);t.width=E,t.height=E}Me(e,t),e.rulers&&e.rulers.setIndicators({x:t.x,y:t.y,w:t.width,h:t.height})}}else if(e.lassoState){const t=e.lassoState.artboardEl;if(!t)return;const n=t.getBoundingClientRect(),s=(l.clientX-n.left)/i,r=(l.clientY-n.top)/i,d=Math.min(e.lassoState.startX,s),c=Math.min(e.lassoState.startY,r),a=Math.abs(s-e.lassoState.startX),u=Math.abs(r-e.lassoState.startY);e.lassoState.rect={x:d,y:c,w:a,h:u},e.lassoEl&&(e.lassoEl.style.left=d+"px",e.lassoEl.style.top=c+"px",e.lassoEl.style.width=a+"px",e.lassoEl.style.height=u+"px");const m=h.getCurrentPage();if(m){const g=new Set(e.lassoState.isAdditive?e.lassoState.initialSelection:[]);e.lassoState.currentSelection=[];const f={x1:d,y1:c,x2:d+a,y2:c+u};for(const v of m.widgets){const b={x1:v.x,y1:v.y,x2:v.x+v.width,y2:v.y+v.height},E=!(b.x2<f.x1||b.x1>f.x2||b.y2<f.y1||b.y1>f.y2),y=e.canvas.querySelector(`.widget[data-id="${v.id}"]`);y&&(E?(y.classList.add("active"),g.add(v.id)):e.lassoState.isAdditive&&e.lassoState.initialSelection.includes(v.id)?y.classList.add("active"):y.classList.remove("active"))}e.lassoState.currentSelection=Array.from(g),h.selectWidgets(e.lassoState.currentSelection)}l.preventDefault(),l.stopPropagation()}}function Yi(l,e){if(e.dragState){const i=e.dragState.id;if(e.dragState.mode==="move"){const t=e.canvas.querySelector(`.widget[data-id="${i}"]`),n=t?t.style.pointerEvents:"";t&&(t.style.pointerEvents="none");const s=document.elementFromPoint(l.clientX,l.clientY);t&&(t.style.pointerEvents=n);const r=s?.closest(".artboard");let d=-1;if(r)d=parseInt(r.dataset.index,10);else{const c=s?.closest("#pageList .item");if(c){const a=document.getElementById("pageList");d=Array.from(a.querySelectorAll(".item")).indexOf(c)}}if(d!==-1&&d!==h.currentPageIndex){const c=e.dragState.widgets,a=e.canvas.querySelector(`.artboard[data-index="${d}"]`);let u=0;window.removeEventListener("mousemove",e._boundMouseMove),window.removeEventListener("mouseup",e._boundMouseUp),e.dragState=null,ae();let m=null;const g=h.zoomLevel;a&&(m=a.getBoundingClientRect());const f=new Set(c.map(b=>b.id));if(c.filter(b=>{const E=h.getWidgetById(b.id);return!E.parentId||!f.has(E.parentId)}).forEach(b=>{let E=b.startX,y=b.startY;if(m){const S=h.getWidgetById(b.id),T=h.getCanvasDimensions();E=Math.round((l.clientX-m.left)/g-b.clickOffsetX),y=Math.round((l.clientY-m.top)/g-b.clickOffsetY);const R=S?.width||50,B=S?.height||50;E=Math.max(0,Math.min(T.width-R,E)),y=Math.max(0,Math.min(T.height-B,y))}h.moveWidgetToPage(b.id,d,E,y)&&u++}),u>0){_.log(`[Canvas] Moved ${u} widgets to page ${d}`),_e(e);return}}}window.removeEventListener("mousemove",e._boundMouseMove),window.removeEventListener("mouseup",e._boundMouseUp),e.dragState=null,e.rulers&&e.rulers.setIndicators(null),ae(),ni(i),h.recordHistory(),D(A.STATE_CHANGED),_e(e)}else if(e.lassoState){if(window.removeEventListener("mousemove",e._boundMouseMove),window.removeEventListener("mouseup",e._boundMouseUp),e.lassoEl&&(e.lassoEl.remove(),e.lassoEl=null),e.lassoState.rect){const i=e.lassoState.currentSelection||[];h.selectWidgets(i)}else e.lassoState.isAdditive||h.selectWidgets([]);e.lassoState=null,_e(e),l.preventDefault(),l.stopPropagation()}}function Vi(l){l.viewport&&l.viewport.addEventListener("mousedown",e=>{if(e.button===1){e.preventDefault(),e.stopPropagation(),l.panState={startX:e.clientX,startY:e.clientY,startPanX:l.panX,startPanY:l.panY},l.viewport.style.cursor="grabbing",document.body.classList.add("panning-active");const i=t=>{if(l.panState){const n=t.clientX-l.panState.startX,s=t.clientY-l.panState.startY;l.panX=l.panState.startPanX+n,l.panY=l.panState.startPanY+s,se(l)}},o=()=>{l.panState=null,l.viewport.style.cursor="auto",document.body.classList.remove("panning-active"),window.removeEventListener("mousemove",i),window.removeEventListener("mouseup",o)};window.addEventListener("mousemove",i),window.addEventListener("mouseup",o)}})}function qi(l){const e=document.getElementById("zoomInBtn"),i=document.getElementById("zoomOutBtn"),o=document.getElementById("zoomResetBtn"),t=document.getElementById("gridToggleBtn"),n=document.getElementById("rulersToggleBtn"),s=document.getElementById("editorGridOpacity");e&&e.addEventListener("click",()=>dt(l)),i&&i.addEventListener("click",()=>ct(l)),o&&o.addEventListener("click",()=>Ae(l)),t&&(t.classList.toggle("active",!!h.showGrid),t.addEventListener("click",()=>{const r=!h.showGrid;h.setShowGrid(r),t.classList.toggle("active",r),_.log(`[Canvas] Grid toggled: ${r}`)})),n&&(n.classList.toggle("active",!!h.showRulers),n.addEventListener("click",()=>{const r=!h.showRulers;h.setShowRulers(r),n.classList.toggle("active",r),_.log(`[Canvas] Rulers toggled: ${r}`)})),s&&s.addEventListener("input",r=>{h.updateSettings({grid_opacity:parseInt(r.target.value,10)})}),l.canvasContainer&&l.canvasContainer.addEventListener("wheel",r=>{r.preventDefault(),Nt(r,l)},{passive:!1}),l.viewport&&l.viewport.addEventListener("wheel",r=>{r.preventDefault(),Nt(r,l)},{passive:!1}),document.addEventListener("keydown",r=>{r.ctrlKey&&(r.key==="+"||r.key==="=")?(r.preventDefault(),dt(l)):r.ctrlKey&&r.key==="-"?(r.preventDefault(),ct(l)):r.ctrlKey&&r.key==="0"||r.ctrlKey&&r.key.toLowerCase()==="r"?(r.preventDefault(),Ae(l)):r.ctrlKey&&r.key.toLowerCase()==="g"&&(r.preventDefault(),r.shiftKey?h.ungroupSelection():h.groupSelection())})}function Nt(l,e){const i=h.zoomLevel;let o=0;if(l.ctrlKey)o=l.deltaY>0?-.02:.02;else if(l.deltaMode===0&&l.deltaX===0&&Math.abs(l.deltaY)>=50)o=l.deltaY>0?-.05:.05;else{e.panX-=l.deltaX,e.panY-=l.deltaY,se(e);return}if(o===0)return;const t=Math.min(Math.max(i+o,.1),5);if(t===i)return;const n=e.viewport.getBoundingClientRect(),s=l.clientX-n.left,r=l.clientY-n.top,d=(s-e.panX)/i,c=(r-e.panY)/i;e.panX=s-d*t,e.panY=r-c*t,h.setZoomLevel(t),se(e)}function dt(l){oi(.05,l)}function ct(l){oi(-.05,l)}function oi(l,e){const i=h.zoomLevel,o=Math.min(Math.max(i+l,.1),5);if(o!==i){if(e&&e.viewport){const t=e.viewport.getBoundingClientRect(),n=t.width/2,s=t.height/2,r=(n-e.panX)/i,d=(s-e.panY)/i;e.panX=n-r*o,e.panY=s-d*o}h.setZoomLevel(o),e&&se(e)}}function Ae(l){h.setZoomLevel(1),l.focusPage(0,!0)}function Xi(l){l.canvas&&(l.canvas.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy"}),l.canvas.addEventListener("drop",async e=>{e.preventDefault();const i=e.dataTransfer.getData("application/widget-type");_.log("[Canvas] Drop detected type:",i);const o=e.target.closest(".artboard");if(!o){_.warn("[Canvas] Drop outside of any artboard");return}const t=parseInt(o.dataset.index,10),n=o.getBoundingClientRect(),s=h.zoomLevel;if(h.currentPageIndex!==t&&h.setCurrentPageIndex(t),i){const r=(e.clientX-n.left)/s,d=(e.clientY-n.top)/s;try{await Y.load(i);const c=Ke.createWidget(i);c.x=Math.round(r-c.width/2),c.y=Math.round(d-c.height/2),h.addWidget(c,t)}catch(c){_.error("[Canvas] error creating widget from drop:",c)}}}))}function Ki(l){!l.canvas||!l.canvasContainer||(l.canvas.addEventListener("touchstart",e=>{const i=e.touches;if(i.length===2){e.preventDefault(),l.pinchState={startDistance:pt(i[0],i[1]),startZoom:h.zoomLevel,startPanX:l.panX,startPanY:l.panY,startCenterX:(i[0].clientX+i[1].clientX)/2,startCenterY:(i[0].clientY+i[1].clientY)/2},l.touchState=null;return}if(i.length===1){const o=i[0],t=o.target.closest(".widget");if(l.longPressTimer&&clearTimeout(l.longPressTimer),l.longPressTimer=setTimeout(()=>{const n=t?t.dataset.id:null;window.RadialMenu&&window.RadialMenu.show(o.clientX,o.clientY,n),l.touchState=null},600),t){e.preventDefault();const n=t.dataset.id,s=h.getWidgetById(n);if(!s)return;o.target.classList.contains("widget-resize-handle")?l.touchState={mode:"resize",id:n,startX:o.clientX,startY:o.clientY,startW:s.width,startH:s.height,el:t}:l.touchState={mode:"move",id:n,startTouchX:o.clientX,startTouchY:o.clientY,startWidgetX:s.x,startWidgetY:s.y,hasMoved:!1,el:t},window.addEventListener("touchmove",d=>st(d,l),{passive:!1}),window.addEventListener("touchend",d=>ge(d,l)),window.addEventListener("touchcancel",d=>ge(d,l))}else{const n=Date.now();if(n-l.lastTapTime<300){h.setZoomLevel(1),l.panX=0,l.panY=0,se(l),l.lastTapTime=0,e.preventDefault();return}l.lastTapTime=n,e.preventDefault(),l.touchState={mode:"pan",startTouchX:o.clientX,startTouchY:o.clientY,startPanX:l.panX,startPanY:l.panY},window.addEventListener("touchmove",s=>st(s,l),{passive:!1}),window.addEventListener("touchend",s=>ge(s,l)),window.addEventListener("touchcancel",s=>ge(s,l))}}},{passive:!1}),l.canvasContainer.addEventListener("touchstart",e=>{if(e.touches.length===2){e.preventDefault();const i=e.touches;l.pinchState={startDistance:pt(i[0],i[1]),startZoom:h.zoomLevel,startPanX:l.panX,startPanY:l.panY,startCenterX:(i[0].clientX+i[1].clientX)/2,startCenterY:(i[0].clientY+i[1].clientY)/2},l.touchState=null,window.addEventListener("touchmove",o=>st(o,l),{passive:!1}),window.addEventListener("touchend",o=>ge(o,l)),window.addEventListener("touchcancel",o=>ge(o,l))}},{passive:!1}))}function st(l,e){const i=l.touches;if(e.pinchState&&i.length===2){l.preventDefault();const t=pt(i[0],i[1])/e.pinchState.startDistance,n=Math.max(.25,Math.min(4,e.pinchState.startZoom*t));h.setZoomLevel(n);const s=(i[0].clientX+i[1].clientX)/2,r=(i[0].clientY+i[1].clientY)/2,d=s-e.pinchState.startCenterX,c=r-e.pinchState.startCenterY;e.panX=e.pinchState.startPanX+d,e.panY=e.pinchState.startPanY+c,se(e);return}if(i.length===1&&e.longPressTimer){const o=i[0],t=o.clientX-(e.touchState?.startTouchX||o.clientX),n=o.clientY-(e.touchState?.startTouchY||o.clientY);Math.hypot(t,n)>10&&(clearTimeout(e.longPressTimer),e.longPressTimer=null)}if(e.touchState&&i.length===1){l.preventDefault();const o=i[0];if(e.touchState.mode==="pan"){const t=o.clientX-e.touchState.startTouchX,n=o.clientY-e.touchState.startTouchY;e.panX=e.touchState.startPanX+t,e.panY=e.touchState.startPanY+n,se(e)}else if(e.touchState.mode==="move"){const t=o.clientX-e.touchState.startTouchX,n=o.clientY-e.touchState.startTouchY;if(!e.touchState.hasMoved&&Math.hypot(t,n)<5)return;e.touchState.hasMoved=!0;const s=h.getWidgetById(e.touchState.id);if(!s)return;const r=h.getCanvasDimensions(),d=h.zoomLevel;let c=e.touchState.startWidgetX+t/d,a=e.touchState.startWidgetY+n/d;c=Math.max(0,Math.min(r.width-s.width,c)),a=Math.max(0,Math.min(r.height-s.height,a)),s.x=c,s.y=a,e.touchState.el&&(e.touchState.el.style.left=c+"px",e.touchState.el.style.top=a+"px")}else if(e.touchState.mode==="resize"){const t=h.getWidgetById(e.touchState.id);if(!t)return;const n=h.getCanvasDimensions(),s=h.zoomLevel;let r=e.touchState.startW+(o.clientX-e.touchState.startX)/s,d=e.touchState.startH+(o.clientY-e.touchState.startY)/s;const c=(t.type||"").toLowerCase();if(c==="line"||c==="lvgl_line"){const u=t.props||{},m=u.orientation||"horizontal",g=parseInt(u.stroke_width||u.line_width||3,10);m==="vertical"?(r=g,d=Math.max(10,d)):(d=g,r=Math.max(10,r))}const a=20;r=Math.max(a,Math.min(n.width-t.x,r)),d=Math.max(a,Math.min(n.height-t.y,d)),t.width=r,t.height=d,e.touchState.el&&(e.touchState.el.style.width=r+"px",e.touchState.el.style.height=d+"px")}}}function ge(l,e){if(e.touchState){const i=e.touchState.id,o=e.touchState.mode,t=e.touchState.hasMoved;if(i){const n=h.getWidgetById(i);if(n){if(o==="move"&&t){const s=h.getCanvasDimensions(),r=h.getCurrentPage();if(r?.layout){const d=kt(n.x,n.y,n.width,n.height,r.layout,s);n.x=d.x,n.y=d.y}else{const d=Lt(e,n,n.x,n.y,!1,s);n.x=d.x,n.y=d.y}}else o==="resize"&&(n.width=Math.round(n.width),n.height=Math.round(n.height));h.selectWidget(i)}(o==="move"||o==="resize")&&t&&(Ji(e,i),h.recordHistory(),D(A.STATE_CHANGED))}e.touchState=null,ae(),_e(e)}e.pinchState&&(e.pinchState=null),e.longPressTimer&&(clearTimeout(e.longPressTimer),e.longPressTimer=null)}function pt(l,e){return Math.hypot(e.clientX-l.clientX,e.clientY-l.clientY)}function Ji(l,e){const i=h.getCurrentPage();if(!i||!i.layout)return;const o=i.layout.match(/^(\d+)x(\d+)$/);if(!o)return;const t=h.getWidgetById(e);if(!t)return;const n=parseInt(o[1],10),s=parseInt(o[2],10),r=h.getCanvasDimensions(),d=r.width/s,c=r.height/n,a=t.x+t.width/2,u=t.y+t.height/2,m=Math.floor(a/d),g=Math.floor(u/c),f=Math.max(0,Math.min(n-1,g)),v=Math.max(0,Math.min(s-1,m)),b={...t.props,grid_cell_row_pos:f,grid_cell_column_pos:v},E=Math.max(1,Math.round(t.height/c)),y=Math.max(1,Math.round(t.width/d));b.grid_cell_row_span=E,b.grid_cell_column_span=y,h.updateWidget(e,{props:b})}class Zi{constructor(){this.canvas=document.getElementById("canvas"),this.canvasContainer=document.getElementById("canvasContainer"),this.viewport=document.querySelector(".canvas-viewport"),this.dragState=null,this.panX=0,this.panY=0,this.touchState=null,this.pinchState=null,this.lastTapTime=0,this._boundMouseMove=e=>Ui(e,this),this._boundMouseUp=e=>Yi(e,this),this.rulers=new Ni(this),this.init()}init(){Q(A.STATE_CHANGED,()=>this.render()),Q(A.PAGE_CHANGED,e=>{this.render(),e.suppressFocus||this.focusPage(e.index)}),Q(A.SELECTION_CHANGED,()=>this.updateSelectionVisuals()),Q(A.SETTINGS_CHANGED,()=>{this.render(),this.applyZoom(),this.rulers.update()}),Q(A.ZOOM_CHANGED,()=>{this.applyZoom(),this.rulers.update()}),this._boundResize=()=>{h.currentPageIndex!==-1&&this.focusPage(h.currentPageIndex,!1)},window.addEventListener("resize",this._boundResize),this.setupInteractions(),this.render(),this.applyZoom(),this.updateInterval&&clearInterval(this.updateInterval),this.updateInterval=setInterval(()=>{if(this.touchState||this.pinchState||this.dragState||this.panState||this.lassoState)return;const e=h.getCurrentPage();e&&e.widgets.some(i=>i.type==="datetime")&&this.render()},1e3)}render(){_e(this)}applyZoom(){se(this),this.rulers&&this.rulers.update()}updateSelectionVisuals(){const e=h.selectedWidgetIds;this.canvas.querySelectorAll(".widget").forEach(o=>{const t=o.dataset.id;e.includes(t)?o.classList.add("active"):o.classList.remove("active")}),Ct(this)}setupInteractions(){Vi(this),ji(this),qi(this),Xi(this),Ki(this)}zoomIn(){dt(this)}zoomOut(){ct(this)}zoomReset(){Ae(this)}focusPage(e,i=!0){W(()=>Promise.resolve().then(()=>Wi),[],import.meta.url).then(o=>o.focusPage(this,e,i))}destroy(){this.updateInterval&&(clearInterval(this.updateInterval),this.updateInterval=null),this._boundResize&&window.removeEventListener("resize",this._boundResize)}}function Qi(l,e,i){if(!q()){_.warn("Entity Picker: No HA backend detected.");return}const o=document.getElementById("propertiesPanel")||document.body,t=document.querySelector(".entity-picker-overlay");t&&t.remove();const n=document.createElement("div");n.className="entity-picker-overlay";const s=document.createElement("div");s.className="entity-picker-header",s.textContent="Pick Home Assistant entity";const r=document.createElement("button");r.className="btn btn-secondary",r.textContent="Ã",r.style.padding="0 4px",r.style.fontSize="9px",r.type="button",r.addEventListener("click",()=>{n.remove()});const d=document.createElement("div");d.style.display="flex",d.style.alignItems="center",d.style.gap="4px",d.appendChild(r);const c=document.createElement("div");c.style.display="flex",c.style.justifyContent="space-between",c.style.alignItems="center",c.style.gap="4px",c.appendChild(s),c.appendChild(d);const a=document.createElement("div");a.style.display="flex",a.style.gap="4px",a.style.alignItems="center";const u=document.createElement("input");u.type="text",u.className="prop-input",u.placeholder="Search name or entity_id",u.style.flex="1";const m=document.createElement("select");m.className="prop-input",m.style.width="80px",["all","sensor","binary_sensor","light","switch","fan","cover","climate","media_player","input_number","number","input_boolean","input_text","input_select","weather","scene","script","button","input_button"].forEach(v=>{const b=document.createElement("option");b.value=v,b.textContent=v,m.appendChild(b)}),a.appendChild(u),a.appendChild(m);const g=document.createElement("div");g.className="entity-picker-list",n.appendChild(c),n.appendChild(a),n.appendChild(g),o.appendChild(n);function f(v){if(g.innerHTML="",!v||v.length===0){const b=document.createElement("div");b.style.color="var(--muted)",b.style.fontSize="var(--fs-xs)",b.textContent="No entities match.",g.appendChild(b);return}v.forEach(b=>{const E=document.createElement("div");E.className="entity-picker-row";const y=document.createElement("div");y.className="entity-picker-name",y.textContent=b.name||b.entity_id;const S=document.createElement("div");S.className="entity-picker-meta",S.textContent=`${b.entity_id} Â· ${b.domain||b.entity_id.split(".")[0]}`,E.appendChild(y),E.appendChild(S),E.addEventListener("click",()=>{if(i&&i(b.entity_id),e&&(e.value=b.entity_id),l&&h){if(h.updateWidget(l.id,{entity_id:b.entity_id,title:b.name||b.entity_id||""}),l.type==="graph"&&b.attributes){const T=b.attributes,R={};if(T.unit_of_measurement==="%"&&(l.props.min_value||(R.min_value="0"),l.props.max_value||(R.max_value="100")),T.min!==void 0&&!l.props.min_value&&(R.min_value=String(T.min)),T.max!==void 0&&!l.props.max_value&&(R.max_value=String(T.max)),Object.keys(R).length>0){const B={...l.props,...R};h.updateWidget(l.id,{props:B})}}if(l.type==="sensor_text"){const T={...l.props};b.attributes&&b.attributes.unit_of_measurement?T.unit=b.attributes.unit_of_measurement:b.unit&&(T.unit=b.unit);const R=b.state;if(b.entity_id.startsWith("weather.")||b.entity_id.startsWith("text_sensor."))T.is_text_sensor=!0;else if(R!=null&&R!==""){const k=parseFloat(R);isNaN(k)?T.is_text_sensor=!0:T.is_text_sensor=!1}h.updateWidget(l.id,{props:T})}}n.remove()}),g.appendChild(E)})}he().then(v=>{if(!v||v.length===0){f([]);return}function b(){const E=(u.value||"").toLowerCase(),y=m.value,S=v.filter(T=>{const R=T.domain||T.entity_id.split(".")[0];return y!=="all"&&R!==y?!1:E?`${T.entity_id} ${T.name||""}`.toLowerCase().includes(E):!0});f(S)}u.addEventListener("input",b),m.addEventListener("change",b),b()})}let te=null,pe=null,fe=null,Pe=null,oe=null,ye=null;function es(){te||(te=document.getElementById("iconPickerModal"),pe=document.getElementById("iconPickerFilter"),fe=document.getElementById("iconPickerList"),Pe=document.getElementById("iconPickerClose"),te||(te=document.createElement("div"),te.id="iconPickerModal",te.className="modal-backdrop hidden",te.style.zIndex="2000",te.innerHTML=`
            <div class="modal" style="max-width: 500px; height: 80vh; display: flex; flex-direction: column;">
                <div class="modal-header">
                    <div>Select Icon</div>
                    <button id="iconPickerClose" class="btn btn-secondary">Ã</button>
                </div>
                <div class="modal-body" style="flex: 1; overflow: hidden; display: flex; flex-direction: column; padding: 15px;">
                    <input type="text" id="iconPickerFilter" class="prop-input" placeholder="Filter icons..." style="width: 100%; margin-bottom: 12px;">
                    <div id="iconPickerList" style="flex: 1; overflow-y: auto; border: 1px solid var(--border-subtle); border-radius: 4px; display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px; padding: 10px; background: var(--bg-canvas);"></div>
                </div>
            </div>
        `,document.body.appendChild(te),pe=document.getElementById("iconPickerFilter"),fe=document.getElementById("iconPickerList"),Pe=document.getElementById("iconPickerClose")),Pe&&(Pe.onclick=ht),pe&&(pe.oninput=l=>{const e=l.target;ts(e.value)}),te.onclick=l=>{l.target===te&&ht()})}function $t(l,e){es(),oe=l,ye=e,te.classList.remove("hidden"),te.style.display="flex",pe&&(pe.value="",pe.focus()),ut(ii||[])}function ht(){te&&(te.classList.add("hidden"),te.style.display="none"),oe=null,ye=null}function ut(l){if(!fe)return;if(fe.innerHTML="",!l||l.length===0){fe.innerHTML='<div style="padding: 10px; color: var(--muted); grid-column: 1 / -1; text-align: center;">No icons found.</div>';return}const e=document.createDocumentFragment();l.forEach(i=>{const o=document.createElement("div");o.className="icon-item",o.style.padding="8px",o.style.border="1px solid var(--border-subtle)",o.style.borderRadius="4px",o.style.cursor="pointer",o.style.display="flex",o.style.flexDirection="column",o.style.alignItems="center",o.style.justifyContent="center",o.style.textAlign="center",o.style.background="var(--bg)",o.title=i.name;const t=document.createElement("div");t.className="mdi",t.style.fontSize="24px",t.style.color="var(--accent)";const n=parseInt(i.code,16);t.textContent=String.fromCodePoint(n);const s=document.createElement("div");s.style.fontSize="9px",s.style.marginTop="4px",s.style.overflow="hidden",s.style.textOverflow="ellipsis",s.style.whiteSpace="nowrap",s.style.width="100%",s.style.color="var(--muted)",s.textContent=i.name,o.appendChild(t),o.appendChild(s),o.onclick=()=>is(i),o.onmouseenter=()=>{o.style.borderColor="var(--accent)",o.style.background="rgba(110, 68, 255, 0.05)"},o.onmouseleave=()=>{o.style.borderColor="var(--border-subtle)",o.style.background="var(--bg)"},e.appendChild(o)}),fe.appendChild(e)}function ts(l){const e=ii||[];if(!l){ut(e);return}const i=l.toLowerCase(),o=e.filter(t=>t.name.toLowerCase().includes(i)||t.code.toLowerCase().includes(i));ut(o)}function is(l){oe&&(ye?(ye.value=l.code,ye.dispatchEvent(new Event("input")),ye.dispatchEvent(new Event("change"))):(oe.props||(oe.props={}),oe.props.code=l.code,h&&h.updateWidget(oe.id,oe))),ht()}const ss=`# Dictionary to map calendar keys to their corresponding names
# One word calandars don't need to be added calendar.jobs would map to Jobs by default without adding it here
# calendar.hello_world should be added on the other hand
CALENDAR_NAMES = {"calendar.x": "X", "calendar.Y": "Y"}
# Day names (which are displayed in the calendar event list) can be translated here if required
DAY_NAMES = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"]
# How many entries to send to the ESPHome device
MAX_ENTRIES = 8

def convert_calendar_format(data, today):
    # Initialize a dictionary to store events grouped by date
    events_by_date = {}
    entrie_count = 0
    
    # Variable to store the end time of the closest event that will end
    closest_end_time = None
    
    # Iterate through calendar keys and events
    for calendar_key, events_list in data.items():
        for event in events_list['events']:
            if 'description' in event:
                event.pop('description')
                
            # Attempt to split the 'event[start]' into date and time parts
            parts = event['start'].split("T")
            event_date = parts[0]
            event_time = parts[1] if len(parts) > 1 else None  # event_time might not be present
            
            # Compare the event_date with today's date
            if event_date < today:
                # If the event's date is before today, update it to today's date (in case of multi day event starting before today)
                event['start'] = today if event_time is None else f"{today}T{event_time}"
                event_date = today
            
            # Add calendar name to event
            # If calendar key exists in CALENDAR_NAMES, use its value, otherwise capitalize the second part of the key
            event['calendar_name'] = CALENDAR_NAMES.get(calendar_key, calendar_key.split(".")[1].capitalize())
            
            # Parse location_name and location_address
            if 'location' in event:
                # Split the 'location' string into lines based on the newline character
                location_lines = event['location'].split('\\\\n')
                if len(location_lines) >= 2:
                    # If there are at least two lines, consider the first line as 'location_name' and the second line as 'location_address'
                    event['location_name'] = location_lines[0]
                    # event['location_address'] = location_lines[1]
                elif len(location_lines) == 1:
                    # If there's only one line, consider it as 'location_name'
                    event['location_name'] = location_lines[0]
                    
                # Remove the 'location' key from the event since it's been parsed into 'location_name' and 'location_address'
                event.pop('location')
                    
            # Add event to events_by_date dictionary
            if event_date in events_by_date:
                events_by_date[event_date].append(event)
            else:
                events_by_date[event_date] = [event]
                
    # Sort events by date
    sorted_dates = sorted(events_by_date.keys())
    
    # Initialize a list to store the final date objects
    result = []
    
    # Iterate through sorted dates
    for date in sorted_dates:
        all_day_events = []
        other_events = []
        for event in events_by_date[date]:
            if entrie_count == MAX_ENTRIES:
                break
            
            # Check if the event lasts for the whole day
            start_date = event['start']
            end_date = event['end']
            if 'T' not in event['start']:
                all_day_events.append(event)
            else:
                other_events.append(event)
                
            entrie_count = entrie_count + 1
        
        if other_events and date == today:
            closest_end_time = sorted(other_events, key=lambda item:dt_util.parse_datetime(item['end']), reverse=False)[0]["end"]
        
        if all_day_events or other_events:
            # Sort other_events by start time
            other_events.sort(key=lambda item:dt_util.parse_datetime(item['start']), reverse=False)
            
            # Construct dictionary for the date
            # is_today cast to int because a bool somehow crashes my esphome config
            day_item = {
                'date': date,
                'day': dt_util.parse_datetime(date).day,
                'is_today': int(date == dt_util.now().isoformat().split("T")[0]),
                'day_name': DAY_NAMES[dt_util.parse_datetime(date).weekday()],
                'all_day': all_day_events,
                'other': other_events
            }
            result.append(day_item)
        
    return (result, closest_end_time)

# Access the data received from the Home Assistant service call
input_data = data["calendar"]
today = data["now"]

# Convert the received data into the format expected by the epaper display
converted_data = convert_calendar_format(input_data, today)

# Pass the output back to Home Assistant
output["entries"] = {"days": converted_data[0]}
output["closest_end_time"] = converted_data[1]
`;class ns{constructor(){this.panel=document.getElementById("propertiesPanel"),this.lastRenderedWidgetId=null,this.containerStack=[],this.sectionStates={},this.init()}init(){Q(A.SELECTION_CHANGED,()=>this.render()),Q(A.STATE_CHANGED,()=>this.render());const e=document.getElementById("snapToggle");e&&(e.checked=h.snapEnabled,e.addEventListener("change",o=>{h.setSnapEnabled(o.target.checked)}),Q(A.SETTINGS_CHANGED,o=>{o.snapEnabled!==void 0&&(e.checked=o.snapEnabled)}));const i=document.getElementById("lockPositionToggle");i&&i.addEventListener("change",o=>{const t=h.selectedWidgetIds;t.length>0&&h.updateWidgets(t,{locked:o.target.checked})}),this.render()}render(){if(!this.panel||window.Canvas&&window.Canvas.lassoState)return;const e=h.selectedWidgetId;if(!(this.lastRenderedWidgetId!==e)&&this.panel&&this.panel.isConnected){const c=document.activeElement;if(c&&this.panel.contains(c)){const a=c.tagName.toLowerCase();if(c.type&&c.type.toLowerCase(),a==="input"||a==="textarea"||a==="select")return}}this.lastRenderedWidgetId=e,this.containerStack=[],this.panel.innerHTML="";const o=document.getElementById("lockPositionToggle");if(o){const c=h.getSelectedWidgets(),a=c.length>0&&c.every(m=>m.locked),u=c.some(m=>m.locked);o.checked=a,o.indeterminate=u&&!a,o.disabled=c.length===0}if(h.selectedWidgetIds.length===0){this.panel.innerHTML="<div style='padding:16px;color:#aaa;text-align:center;'>Select a widget to edit properties</div>";return}if(h.selectedWidgetIds.length>1){this.panel.innerHTML=`
                <div style='padding:16px; text-align:center;'>
                    <div style="font-size: 24px; margin-bottom: 12px;">ð</div>
                    <div style="font-weight: 600; color: var(--text);">${h.selectedWidgetIds.length} widgets selected</div>
                    <div style="font-size: 11px; color: var(--muted); margin-top: 8px; margin-bottom: 16px;">
                        Move, group, or delete the selection. Use the Lock toggle above to lock all.
                    </div>
                    <button id="multiDeleteBtn" class="btn btn-secondary btn-xs" style="background: var(--danger); color: white; border: none; width: 100%;">
                        ð Delete Selected Widgets
                    </button>
                </div>
    `;const c=this.panel.querySelector("#multiDeleteBtn");c&&c.addEventListener("click",()=>{confirm(`Are you sure you want to delete ${h.selectedWidgetIds.length} widgets ? `)&&h.deleteWidget(null)});return}const t=h.getSelectedWidget();if(!t)return;const n=(t.type||"").toLowerCase();let s=n;n==="nav_next_page"?s="next page":n==="nav_previous_page"?s="previous page":n==="nav_reload_page"?s="reload page":s=n.replace(/_/g," ");const r=document.createElement("div");if(r.className="sidebar-section-label",r.style.marginTop="0",r.style.textTransform="capitalize",r.textContent=`${s} Properties`,this.panel.appendChild(r),["shape_rect","rounded_rect","shape_circle","rectangle","rrect","circle"].includes(t.type)){const c=document.createElement("button");c.className="btn btn-secondary",c.style.marginBottom="16px",c.style.width="100%",c.innerHTML='<span class="mdi mdi-box-shadow"></span> Create Drop Shadow',c.onclick=()=>h.createDropShadow(t.id),this.panel.appendChild(c)}if(this.createSection("Transform",!1),this.addCompactPropertyRow(()=>{this.addLabeledInput("Pos X","number",t.x,c=>{h.updateWidget(t.id,{x:parseInt(c,10)||0})}),this.addLabeledInput("Pos Y","number",t.y,c=>{h.updateWidget(t.id,{y:parseInt(c,10)||0})})}),this.addCompactPropertyRow(()=>{this.addLabeledInput("Width","number",t.width,c=>{h.updateWidget(t.id,{width:parseInt(c,10)||10})}),this.addLabeledInput("Height","number",t.height,c=>{h.updateWidget(t.id,{height:parseInt(c,10)||10})})}),this.endSection(),Y){const c=Y.get(n);c&&c.schema}this.renderLegacyProperties(t,n),this.createSection("Grid Layout",!1),this.renderGridCellProperties(t,n),this.endSection(),this.createSection("Visibility Conditions",!1),this.addVisibilityConditions(t),this.endSection()}createSection(e,i=!0){const o=this.sectionStates[e]!==void 0?this.sectionStates[e]===!1:!i,t=document.createElement("div");t.className="properties-section"+(o?" collapsed":"");const n=document.createElement("div");n.className="properties-section-header",n.innerHTML=`<span > ${e}</span> <span class="icon mdi mdi-chevron-down"></span>`,n.onclick=r=>{r.stopPropagation();const d=t.classList.toggle("collapsed");this.sectionStates[e]=!d};const s=document.createElement("div");s.className="properties-section-content",t.appendChild(n),t.appendChild(s),this.sectionStates[e]===void 0&&(this.sectionStates[e]=!o),this.getContainer().appendChild(t),this.containerStack.push(s)}endSection(){this.containerStack.length>0&&this.containerStack.pop()}getContainer(){return this.containerStack.length>0?this.containerStack[this.containerStack.length-1]:this.panel}renderGridCellProperties(e,i){const o=h.getCurrentPage(),n=(o?.layout||"absolute")!=="absolute";if(!o)return;if(!n){const u=this.getContainer(),m=document.createElement("div");m.style.padding="8px 0",m.style.fontSize="11px",m.style.color="var(--muted)",m.textContent="Page is currently in Absolute Positioning mode.",u.appendChild(m);const g=document.createElement("button");g.className="btn btn-secondary btn-xs",g.style.width="100%",g.innerHTML='<span class="mdi mdi-grid"></span> Enable Page Grid Layout',g.onclick=()=>{window.app&&window.app.pageSettings&&window.app.pageSettings.open(h.currentPageIndex)},u.appendChild(g);return}const s=Ke.isLvglWidget(i),r=e.props||{},d=(u,m)=>{const g={...e.props,[u]:m};h.updateWidget(e.id,{props:g})},c=(u,m,g,f)=>{const v=o.layout.match(/^(\d+)x(\d+)$/);if(!v)return null;const b=parseInt(v[1],10),E=parseInt(v[2],10),y=h.getCanvasDimensions(),S=y.width/E,T=y.height/b;return{x:Math.round(m*S),y:Math.round(u*T),width:Math.round(S*f),height:Math.round(T*g)}};if(this.addLabeledInput("Row (0-indexed)","number",r.grid_cell_row_pos??"",u=>{const m=u===""?null:parseInt(u,10);d("grid_cell_row_pos",isNaN(m)?null:m);const f=h.getWidgetById(e.id)?.props||{};if(m!=null&&f.grid_cell_column_pos!=null){const v=c(m,f.grid_cell_column_pos,f.grid_cell_row_span||1,f.grid_cell_column_span||1);v&&h.updateWidget(e.id,{x:v.x,y:v.y,width:v.width,height:v.height})}}),this.addLabeledInput("Column (0-indexed)","number",r.grid_cell_column_pos??"",u=>{const m=u===""?null:parseInt(u,10);d("grid_cell_column_pos",isNaN(m)?null:m);const f=h.getWidgetById(e.id)?.props||{};if(m!=null&&f.grid_cell_row_pos!=null){const v=c(f.grid_cell_row_pos,m,f.grid_cell_row_span||1,f.grid_cell_column_span||1);v&&h.updateWidget(e.id,{x:v.x,y:v.y,width:v.width,height:v.height})}}),this.addLabeledInput("Row Span","number",r.grid_cell_row_span||1,u=>{const m=Math.max(1,parseInt(u,10)||1);d("grid_cell_row_span",m);const f=h.getWidgetById(e.id)?.props||{};if(f.grid_cell_row_pos!=null&&f.grid_cell_column_pos!=null){const v=c(f.grid_cell_row_pos,f.grid_cell_column_pos,m,f.grid_cell_column_span||1);v&&h.updateWidget(e.id,{x:v.x,y:v.y,width:v.width,height:v.height})}}),this.addLabeledInput("Column Span","number",r.grid_cell_column_span||1,u=>{const m=Math.max(1,parseInt(u,10)||1);d("grid_cell_column_span",m);const f=h.getWidgetById(e.id)?.props||{};if(f.grid_cell_row_pos!=null&&f.grid_cell_column_pos!=null){const v=c(f.grid_cell_row_pos,f.grid_cell_column_pos,f.grid_cell_row_span||1,m);v&&h.updateWidget(e.id,{x:v.x,y:v.y,width:v.width,height:v.height})}}),s){const u=["START","END","CENTER","STRETCH"];this.addSelect("X Align",r.grid_cell_x_align||"STRETCH",u,m=>{d("grid_cell_x_align",m)}),this.addSelect("Y Align",r.grid_cell_y_align||"STRETCH",u,m=>{d("grid_cell_y_align",m)})}const a=document.createElement("button");a.className="btn btn-secondary btn-xs",a.style.marginTop="8px",a.style.width="100%",a.innerHTML='<span class="mdi mdi-cog"></span> Open Page Grid Settings',a.onclick=()=>{const u=h.currentPageIndex;window.app&&window.app.pageSettings&&window.app.pageSettings.open(u)},this.getContainer().appendChild(a)}renderLegacyProperties(e,i){const o=ti(),t=e.props||{},n=(s,r)=>{const d={...e.props,[s]:r};h.updateWidget(e.id,{props:d})};if(i==="shape_rect"||i==="shape_circle")this.createSection("Appearance",!1),this.addNumberWithSlider("Opacity (%)",t.opacity!==void 0?t.opacity:100,0,100,s=>{n("opacity",s)}),this.addCheckbox("Fill",t.fill||!1,s=>n("fill",s)),this.addLabeledInput("Border Width","number",t.border_width||1,s=>n("border_width",parseInt(s,10))),this.addColorSelector("Color",t.color||"black",o,s=>n("color",s)),this.addColorSelector("Border Color",t.border_color||"black",o,s=>n("border_color",s)),this.endSection();else if(i==="rounded_rect")this.createSection("Appearance",!1),this.addNumberWithSlider("Opacity (%)",t.opacity!==void 0?t.opacity:100,0,100,s=>{n("opacity",s)}),this.addCheckbox("Fill",t.fill||!1,s=>n("fill",s)),t.fill&&this.addCheckbox("Show Border",t.show_border||!1,s=>n("show_border",s)),this.addCompactPropertyRow(()=>{this.addLabeledInput("Border Width","number",t.border_width||4,s=>n("border_width",parseInt(s,10))),this.addLabeledInput("Corner Radius","number",t.radius||10,s=>n("radius",parseInt(s,10)))}),this.addColorSelector("Color",t.color||"black",o,s=>n("color",s)),this.addColorSelector("Border Color",t.border_color||"black",o,s=>n("border_color",s)),this.endSection();else if(i==="line"){this.createSection("Appearance",!1),this.addLabeledInput("Opacity (%)","number",t.opacity!==void 0?t.opacity:100,d=>{n("opacity",parseInt(d,10))}),this.addSegmentedControl("Orientation",[{value:"horizontal",label:"Horiz",icon:"mdi-arrow-left-right"},{value:"vertical",label:"Vert",icon:"mdi-arrow-up-down"}],t.orientation||"horizontal",d=>{const c=parseInt(t.stroke_width||3,10),a=e.width,u=e.height;d==="vertical"?h.updateWidget(e.id,{width:c,height:Math.max(a,u,20)}):h.updateWidget(e.id,{width:Math.max(a,u,20),height:c}),n("orientation",d)});const s=(t.orientation||"horizontal")==="vertical";this.addLabeledInput("Line Length (px)","number",s?e.height:e.width,d=>{const c=parseInt(d,10)||20;s?h.updateWidget(e.id,{height:c}):h.updateWidget(e.id,{width:c})}),this.addLabeledInput("Stroke Width (px)","number",t.stroke_width||3,d=>{const c=parseInt(d,10)||1;n("stroke_width",c),(t.orientation||"horizontal")==="vertical"?h.updateWidget(e.id,{width:c}):h.updateWidget(e.id,{height:c})});const r=document.createElement("button");r.textContent="Fill Canvas Length",r.className="btn btn-secondary",r.style.marginTop="8px",r.style.width="100%",r.onclick=()=>{const d=h.getCanvasDimensions();(t.orientation||"horizontal")==="vertical"?h.updateWidget(e.id,{y:0,height:d.height}):h.updateWidget(e.id,{x:0,width:d.width})},this.getContainer().appendChild(r),this.addColorSelector("Color",t.color||"black",o,d=>n("color",d)),this.endSection()}else if(i==="text"||i==="label"){this.createSection("Content",!1),this.addLabeledInput("Text","text",t.text||"",a=>n("text",a)),this.endSection(),this.createSection("Appearance",!1),this.addNumberWithSlider("Opacity (%)",t.opacity!==void 0?t.opacity:100,0,100,a=>{n("opacity",a)}),this.addLabeledInput("Font Size","number",t.font_size||20,a=>n("font_size",parseInt(a,10))),this.addColorSelector("Color",t.color||"black",o,a=>n("color",a));const s=["Roboto","Inter","Open Sans","Lato","Montserrat","Poppins","Raleway","Roboto Mono","Ubuntu","Nunito","Playfair Display","Merriweather","Work Sans","Source Sans Pro","Quicksand","Custom..."],r=t.font_family||"Roboto",d=!s.slice(0,-1).includes(r);this.addSelect("Font",d?"Custom...":r,s,a=>{a!=="Custom..."?(n("font_family",a),n("custom_font_family","")):n("font_family","Custom...")}),(d||t.font_family==="Custom...")&&(this.addLabeledInput("Custom Font Name","text",t.custom_font_family||(d?r:""),a=>{n("font_family",a||"Roboto"),n("custom_font_family",a)}),this.addHint('Browse <a href="https://fonts.google.com" target="_blank">fonts.google.com</a>')),this.addSelect("Weight",t.font_weight||400,[100,200,300,400,500,600,700,800,900],a=>n("font_weight",parseInt(a,10))),this.addCheckbox("Italic",t.italic||!1,a=>n("italic",a));const c=["TOP_LEFT","TOP_CENTER","TOP_RIGHT","CENTER_LEFT","CENTER","CENTER_RIGHT","BOTTOM_LEFT","BOTTOM_CENTER","BOTTOM_RIGHT"];this.addSelect("Align",t.text_align||"TOP_LEFT",c,a=>n("text_align",a)),this.addSelect("BPP (Anti-aliasing)",String(t.bpp||1),["1","2","4","8"],a=>n("bpp",parseInt(a,10))),this.addHint("1=no AA, 2=4 levels, 4=16 levels, 8=256 levels"),this.endSection()}else if(i==="sensor_text"){this.createSection("Data Source",!1),this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",a=>{h.updateWidget(e.id,{entity_id:a}),a&&!e.title&&window.AppState&&window.AppState.entityStates&&this.autoPopulateTitleFromEntity(e.id,a)},e),this.addCheckbox("Text Sensor (string value)",t.is_text_sensor||!1,a=>n("is_text_sensor",a)),this.addHint("Enable if entity returns text instead of numbers."),this.addCheckbox("Local / On-Device Sensor",!!t.is_local_sensor,a=>n("is_local_sensor",a)),this.addHint("Use internal battery_level/signal sensor."),this.addLabeledInputWithPicker("Secondary Entity ID","text",e.entity_id_2||"",a=>{h.updateWidget(e.id,{entity_id_2:a})},e),this.addLabeledInput("Title/Label","text",e.title||"",a=>{h.updateWidget(e.id,{title:a})}),this.endSection(),this.createSection("Format",!1),this.addSelect("Display Format",t.value_format||"label_value",[{value:"label_value",label:"Label: Value & Unit"},{value:"label_value_no_unit",label:"Label: Value Only"},{value:"label_newline_value",label:"Label [newline] Value & Unit"},{value:"label_newline_value_no_unit",label:"Label [newline] Value Only"},{value:"value_only",label:"Value & Unit"},{value:"value_only_no_unit",label:"Value Only"}],a=>n("value_format",a)),this.addLabeledInput("Precision","number",t.precision!==void 0?t.precision:2,a=>n("precision",parseInt(a,10))),this.addLabeledInputWithDataList("Prefix","text",t.prefix||"",["â¬","$","Â£","Â¥","CHF","kr"],a=>n("prefix",a)),this.addLabeledInputWithDataList("Postfix","text",t.postfix||"",[" kWh"," W"," V"," A"," Â°C"," %"," ppm"," lx"],a=>n("postfix",a)),this.addLabeledInput("Unit (Manual helper)","text",t.unit||"",a=>n("unit",a)),this.addCheckbox("Hide default unit",t.hide_unit||!1,a=>n("hide_unit",a)),this.endSection(),this.createSection("Appearance",!1),this.addNumberWithSlider("Opacity (%)",t.opacity!==void 0?t.opacity:100,0,100,a=>{n("opacity",a)}),this.addCompactPropertyRow(()=>{this.addLabeledInput("Label Size","number",t.label_font_size||14,a=>n("label_font_size",parseInt(a,10))),this.addLabeledInput("Value Size","number",t.value_font_size||20,a=>n("value_font_size",parseInt(a,10)))}),this.addColorSelector("Color",t.color||"black",o,a=>n("color",a));const s=["Roboto","Inter","Open Sans","Lato","Montserrat","Poppins","Raleway","Roboto Mono","Ubuntu","Nunito","Playfair Display","Merriweather","Work Sans","Source Sans Pro","Quicksand","Custom..."],r=t.font_family||"Roboto",d=!s.slice(0,-1).includes(r);this.addSelect("Font",d?"Custom...":r,s,a=>{a!=="Custom..."?(n("font_family",a),n("custom_font_family","")):n("font_family","Custom...")}),(d||t.font_family==="Custom...")&&(this.addLabeledInput("Custom Font Name","text",t.custom_font_family||(d?r:""),a=>{n("font_family",a||"Roboto"),n("custom_font_family",a)}),this.addHint('Browse <a href="https://fonts.google.com" target="_blank">fonts.google.com</a>')),this.addSelect("Weight",t.font_weight||400,[100,200,300,400,500,600,700,800,900],a=>n("font_weight",parseInt(a,10))),this.addCheckbox("Italic",t.italic||!1,a=>n("italic",a));const c=["TOP_LEFT","TOP_CENTER","TOP_RIGHT","CENTER_LEFT","CENTER","CENTER_RIGHT","BOTTOM_LEFT","BOTTOM_CENTER","BOTTOM_RIGHT"];this.addSelect("Align",t.text_align||"TOP_LEFT",c,a=>{n("text_align",a),n("label_align",a),n("value_align",a)}),this.endSection()}else if(i==="datetime"){this.createSection("Appearance",!1),this.addLabeledInput("Opacity (%)","number",t.opacity!==void 0?t.opacity:100,a=>{n("opacity",parseInt(a,10))}),this.addSelect("Display Format",t.format||"time_date",["time_date","time_only","date_only","weekday_day_month"],a=>n("format",a)),this.addLabeledInput("Time Font Size","number",t.time_font_size||28,a=>n("time_font_size",parseInt(a,10))),this.addLabeledInput("Date Font Size","number",t.date_font_size||16,a=>n("date_font_size",parseInt(a,10))),this.addColorSelector("Color",t.color||"black",o,a=>n("color",a));const s=["Roboto","Inter","Open Sans","Lato","Montserrat","Poppins","Raleway","Roboto Mono","Ubuntu","Nunito","Playfair Display","Merriweather","Work Sans","Source Sans Pro","Quicksand","Custom..."],r=t.font_family||"Roboto",d=!s.slice(0,-1).includes(r);this.addSelect("Font",d?"Custom...":r,s,a=>{a!=="Custom..."?(n("font_family",a),n("custom_font_family","")):n("font_family","Custom...")}),(d||t.font_family==="Custom...")&&(this.addLabeledInput("Custom Font Name","text",t.custom_font_family||(d?r:""),a=>{n("font_family",a||"Roboto"),n("custom_font_family",a)}),this.addHint('Browse <a href="https://fonts.google.com" target="_blank">fonts.google.com</a>')),this.addCheckbox("Italic",t.italic||!1,a=>n("italic",a));const c=["TOP_LEFT","TOP_CENTER","TOP_RIGHT","CENTER_LEFT","CENTER","CENTER_RIGHT","BOTTOM_LEFT","BOTTOM_CENTER","BOTTOM_RIGHT"];this.addSelect("Align",t.text_align||"CENTER",c,a=>n("text_align",a)),this.endSection()}else if(i==="progress_bar")this.createSection("Data Source",!1),this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",s=>{h.updateWidget(e.id,{entity_id:s}),s&&!e.title&&window.AppState&&window.AppState.entityStates&&this.autoPopulateTitleFromEntity(e.id,s)},e),this.addCheckbox("Local / On-Device Sensor",!!t.is_local_sensor,s=>n("is_local_sensor",s)),this.addHint("Use internal battery_level/signal sensor."),this.addLabeledInput("Title/Label","text",e.title||"",s=>{h.updateWidget(e.id,{title:s})}),this.endSection(),this.createSection("Appearance",!1),this.addNumberWithSlider("Opacity (%)",t.opacity!==void 0?t.opacity:100,0,100,s=>{n("opacity",s)}),this.addCheckbox("Show Label",t.show_label!==!1,s=>n("show_label",s)),this.addCheckbox("Show Percentage",t.show_percentage!==!1,s=>n("show_percentage",s)),this.addCompactPropertyRow(()=>{this.addLabeledInput("Bar H","number",t.bar_height||15,s=>{const r=parseInt(s,10);n("bar_height",isNaN(r)?15:r)}),this.addLabeledInput("Border W","number",t.border_width||1,s=>{const r=parseInt(s,10);n("border_width",isNaN(r)?1:r)})}),this.addColorSelector("Color",t.color||"black",o,s=>n("color",s)),this.endSection();else if(i==="graph")this.createSection("Data Source",!1),this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",s=>{h.updateWidget(e.id,{entity_id:s})},e),this.addLabeledInput("Title","text",e.title||"",s=>{h.updateWidget(e.id,{title:s})}),this.addLabeledInput("Duration","text",t.duration||"1h",s=>n("duration",s)),this.endSection(),this.createSection("Appearance",!1),this.addColorSelector("Line Color",t.color||"black",o,s=>n("color",s)),this.addSelect("Line Type",t.line_type||"SOLID",["SOLID","DASHED","DOTTED"],s=>n("line_type",s)),this.addLabeledInput("Line Thickness","number",t.line_thickness||3,s=>n("line_thickness",parseInt(s,10))),this.addCheckbox("Show Border",t.border!==!1,s=>n("border",s)),this.addCheckbox("Show Grid",t.grid!==!1,s=>n("grid",s)),this.addLabeledInput("X Grid Interval","text",t.x_grid||"1h",s=>n("x_grid",s)),this.addLabeledInput("Y Grid Step","text",t.y_grid||"auto",s=>n("y_grid",s)),this.addCompactPropertyRow(()=>{this.addLabeledInput("Min Value","number",t.min_value||"",s=>n("min_value",s)),this.addLabeledInput("Max Value","number",t.max_value||"",s=>n("max_value",s))}),this.endSection();else if(i==="icon")this.createSection("Appearance",!1),this.addCheckbox("Fit icon to frame",t.fit_icon_to_frame||!1,s=>n("fit_icon_to_frame",s)),this.addIconPicker("Select Icon",t.code||"F07D0",s=>n("code",s),e),this.addLabeledInput("Icon Size (px)","number",t.size||40,s=>{let r=parseInt(s||"40",10);(Number.isNaN(r)||r<8)&&(r=8),r>260&&(r=260),n("size",r)}),this.addSelect("Font Reference",t.font_ref||"font_mdi_medium",["font_mdi_medium","font_mdi_large"],s=>n("font_ref",s)),this.addColorSelector("Color",t.color||"black",o,s=>n("color",s)),this.endSection();else if(i==="battery_icon")this.createSection("Data Source",!1),this.addLabeledInputWithPicker("Battery Entity ID","text",e.entity_id||"",s=>{h.updateWidget(e.id,{entity_id:s})},e),this.addCheckbox("Local / On-Device Sensor",!!t.is_local_sensor,s=>n("is_local_sensor",s)),this.endSection(),this.createSection("Appearance",!1),this.addCheckbox("Fit icon to frame",t.fit_icon_to_frame||!1,s=>n("fit_icon_to_frame",s)),this.addLabeledInput("Icon Size (px)","number",t.size||48,s=>{let r=parseInt(s||"48",10);(Number.isNaN(r)||r<16)&&(r=16),r>200&&(r=200),n("size",r)}),this.addLabeledInput("Percentage Font Size (px)","number",t.font_size||12,s=>{let r=parseInt(s||"12",10);(Number.isNaN(r)||r<8)&&(r=8),r>100&&(r=100),n("font_size",r)}),this.addColorSelector("Color",t.color||"black",o,s=>n("color",s)),this.endSection();else if(i==="wifi_signal")this.createSection("Data Source",!1),this.addLabeledInputWithPicker("WiFi Signal Entity ID","text",e.entity_id||"",s=>{h.updateWidget(e.id,{entity_id:s})},e),this.addCheckbox("Local / On-Device Sensor",t.is_local_sensor!==!1,s=>n("is_local_sensor",s)),this.endSection(),this.createSection("Appearance",!1),this.addCheckbox("Show dBm value",t.show_dbm!==!1,s=>n("show_dbm",s)),this.addCheckbox("Fit icon to frame",t.fit_icon_to_frame||!1,s=>n("fit_icon_to_frame",s)),this.addLabeledInput("Icon Size (px)","number",t.size||24,s=>{let r=parseInt(s||"24",10);(Number.isNaN(r)||r<16)&&(r=16),r>200&&(r=200),n("size",r)}),this.addLabeledInput("dBm Font Size (px)","number",t.font_size||12,s=>{let r=parseInt(s||"12",10);(Number.isNaN(r)||r<8)&&(r=8),r>100&&(r=100),n("font_size",r)}),this.addColorSelector("Color",t.color||"black",o,s=>n("color",s)),this.endSection();else if(i==="ondevice_temperature"){this.createSection("Data Source",!1),this.addLabeledInputWithPicker("Temperature Entity ID","text",e.entity_id||"",d=>{h.updateWidget(e.id,{entity_id:d})},e),this.addCheckbox("Local / On-Device Sensor",t.is_local_sensor!==!1,d=>n("is_local_sensor",d));let s=!1;const r=h.getSelectedProfile();r&&r.features&&(s=!!(r.features.sht4x||r.features.sht3x||r.features.shtc3)),t.is_local_sensor!==!1&&!s&&(this.addHint('â ï¸ <span style="color:orange">This hardware profile has no onboard temperature sensor.</span><br/>Uncheck this or select an HA entity.'),e.props&&e.props.is_local_sensor===void 0&&setTimeout(()=>n("is_local_sensor",!1),0)),this.endSection(),this.createSection("Appearance",!1),this.addCheckbox("Fit icon to frame",t.fit_icon_to_frame||!1,d=>n("fit_icon_to_frame",d)),this.addCheckbox("Show Label",t.show_label!==!1,d=>n("show_label",d)),this.addLabeledInput("Icon Size (px)","number",t.size||32,d=>{let c=parseInt(d||"32",10);(Number.isNaN(c)||c<16)&&(c=16),c>200&&(c=200),n("size",c)}),this.addLabeledInput("Value Font Size (px)","number",t.font_size||16,d=>{let c=parseInt(d||"16",10);(Number.isNaN(c)||c<8)&&(c=8),c>200&&(c=200),n("font_size",c)}),this.addLabeledInput("Label Font Size (px)","number",t.label_font_size||10,d=>{let c=parseInt(d||"10",10);(Number.isNaN(c)||c<8)&&(c=8),c>100&&(c=100),n("label_font_size",c)}),this.addSelect("Unit",t.unit||"Â°C",["Â°C","Â°F"],d=>n("unit",d)),this.addLabeledInput("Precision","number",t.precision??1,d=>n("precision",parseInt(d,10))),this.addColorSelector("Color",t.color||"black",o,d=>n("color",d)),this.endSection()}else if(i==="ondevice_humidity"){this.createSection("Data Source",!1),this.addLabeledInputWithPicker("Humidity Entity ID","text",e.entity_id||"",d=>{h.updateWidget(e.id,{entity_id:d})},e),this.addCheckbox("Local / On-Device Sensor",t.is_local_sensor!==!1,d=>n("is_local_sensor",d));let s=!1;const r=h.getSelectedProfile();r&&r.features&&(s=!!(r.features.sht4x||r.features.sht3x||r.features.shtc3)),t.is_local_sensor!==!1&&!s&&(this.addHint('â ï¸ <span style="color:orange">This hardware profile has no onboard humidity sensor.</span><br/>Uncheck this or select an HA entity.'),e.props&&e.props.is_local_sensor===void 0&&setTimeout(()=>n("is_local_sensor",!1),0)),this.endSection(),this.createSection("Appearance",!1),this.addCheckbox("Fit icon to frame",t.fit_icon_to_frame||!1,d=>n("fit_icon_to_frame",d)),this.addCheckbox("Show Label",t.show_label!==!1,d=>n("show_label",d)),this.addLabeledInput("Icon Size (px)","number",t.size||32,d=>{let c=parseInt(d||"32",10);(Number.isNaN(c)||c<16)&&(c=16),c>200&&(c=200),n("size",c)}),this.addLabeledInput("Value Font Size (px)","number",t.font_size||16,d=>{let c=parseInt(d||"16",10);(Number.isNaN(c)||c<8)&&(c=8),c>200&&(c=200),n("font_size",c)}),this.addLabeledInput("Label Font Size (px)","number",t.label_font_size||10,d=>{let c=parseInt(d||"10",10);(Number.isNaN(c)||c<8)&&(c=8),c>100&&(c=100),n("label_font_size",c)}),this.addLabeledInput("Unit","text",t.unit||"%",d=>n("unit",d)),this.addLabeledInput("Precision","number",t.precision??0,d=>n("precision",parseInt(d,10))),this.addColorSelector("Color",t.color||"black",o,d=>n("color",d)),this.endSection()}else if(i==="weather_icon")this.createSection("Data Source",!1),this.addLabeledInputWithPicker("Weather Entity ID","text",e.entity_id||t.weather_entity||"weather.forecast_home",s=>{h.updateWidget(e.id,{entity_id:s})},e),this.endSection(),this.createSection("Appearance",!1),this.addCheckbox("Fit icon to frame",t.fit_icon_to_frame||!1,s=>n("fit_icon_to_frame",s)),this.addLabeledInput("Icon Size (px)","number",t.size||48,s=>{let r=parseInt(s||"48",10);(Number.isNaN(r)||r<8)&&(r=8),r>260&&(r=260),n("size",r)}),this.addColorSelector("Color",t.color||"black",o,s=>n("color",s)),this.endSection();else if(i==="weather_forecast"){this.createSection("Data Source",!1),this.addLabeledInputWithPicker("Weather Entity ID","text",e.entity_id||t.weather_entity||"weather.forecast_home",c=>{h.updateWidget(e.id,{entity_id:c})},e),this.endSection(),this.createSection("Appearance",!1),this.addSelect("Layout",t.layout||"horizontal",["horizontal","vertical"],c=>n("layout",c)),this.addCheckbox("Show High/Low Temp",t.show_high_low!==!1,c=>n("show_high_low",c)),this.addSelect("Temperature Unit",t.temp_unit||"C",["C","F"],c=>n("temp_unit",c)),this.addLabeledInput("Day Font Size","number",t.day_font_size||14,c=>n("day_font_size",parseInt(c,10))),this.addLabeledInput("Temp Font Size","number",t.temp_font_size||14,c=>n("temp_font_size",parseInt(c,10))),this.addLabeledInput("Icon Size","number",t.icon_size||24,c=>n("icon_size",parseInt(c,10)));const s=["Roboto","Inter","Open Sans","Lato","Montserrat","Poppins","Raleway","Roboto Mono","Ubuntu","Nunito","Playfair Display","Merriweather","Work Sans","Source Sans Pro","Quicksand","Custom..."],r=t.font_family||"Roboto",d=!s.slice(0,-1).includes(r);this.addSelect("Font",d?"Custom...":r,s,c=>{c!=="Custom..."?(n("font_family",c),n("custom_font_family","")):n("font_family","Custom...")}),(d||t.font_family==="Custom...")&&(this.addLabeledInput("Custom Font Name","text",t.custom_font_family||(d?r:""),c=>{n("font_family",c||"Roboto"),n("custom_font_family",c)}),this.addHint('Browse <a href="https://fonts.google.com" target="_blank">fonts.google.com</a>')),this.addColorSelector("Color",t.color||"black",o,c=>n("color",c)),this.addCheckbox("Show Border",t.show_border!==!1,c=>n("show_border",c)),t.show_border!==!1&&(this.addLabeledInput("Border Width","number",t.border_width!==void 0?t.border_width:1,c=>n("border_width",parseInt(c,10))),this.addColorSelector("Border Color",t.border_color||"black",o,c=>n("border_color",c))),this.addColorSelector("Background Color",t.background_color||"transparent",o,c=>n("background_color",c)),this.endSection()}else if(i==="template_sensor_bar")this.createSection("Sensor Visibility",!0),this.addCheckbox("Show WiFi",t.show_wifi!==!1,s=>n("show_wifi",s)),this.addCheckbox("Show Temperature",t.show_temperature!==!1,s=>n("show_temperature",s)),this.addCheckbox("Show Humidity",t.show_humidity!==!1,s=>n("show_humidity",s)),this.addCheckbox("Show Battery",t.show_battery!==!1,s=>n("show_battery",s)),this.endSection(),this.createSection("Sensor Data Sources",!1),this.addLabeledInput("WiFi Entity","text",t.wifi_entity||"",s=>n("wifi_entity",s)),this.addLabeledInput("Temp Entity","text",t.temp_entity||"",s=>n("temp_entity",s)),this.addSelect("Temperature Unit",t.temp_unit||"Â°C",["Â°C","Â°F"],s=>n("temp_unit",s)),this.addLabeledInput("Hum Entity","text",t.hum_entity||"",s=>n("hum_entity",s)),this.addLabeledInput("Battery Entity","text",t.bat_entity||"",s=>n("bat_entity",s)),this.endSection(),this.createSection("Appearance",!1),this.addCheckbox("Show Background",t.show_background!==!1,s=>n("show_background",s)),t.show_background!==!1&&(this.addColorSelector("Background Color",t.background_color||"black",o,s=>{n("background_color",s);const r=["black","gray","grey","#000000","#808080"],d=["white","#ffffff","#fff"],c=t.color||"white";r.includes(s.toLowerCase())&&r.includes(c.toLowerCase())?n("color","white"):d.includes(s.toLowerCase())&&d.includes(c.toLowerCase())&&n("color","black")}),this.addLabeledInput("Border Radius","number",t.border_radius||8,s=>n("border_radius",parseInt(s,10))),this.addLabeledInput("Border Thickness","number",t.border_thickness||0,s=>n("border_thickness",parseInt(s,10))),this.addColorSelector("Border Color",t.border_color||"white",o,s=>n("border_color",s))),this.endSection(),this.createSection("Sizes & Color",!1),this.addLabeledInput("Icon Size","number",t.icon_size||20,s=>n("icon_size",parseInt(s,10))),this.addLabeledInput("Font Size","number",t.font_size||14,s=>n("font_size",parseInt(s,10))),this.addColorSelector("Foreground Color",t.color||"white",o,s=>n("color",s)),this.endSection();else if(i==="template_nav_bar")this.createSection("Button Visibility",!0),this.addCheckbox("Show Previous",t.show_prev!==!1,s=>n("show_prev",s)),this.addCheckbox("Show Home",t.show_home!==!1,s=>n("show_home",s)),this.addCheckbox("Show Next",t.show_next!==!1,s=>n("show_next",s)),this.endSection(),this.createSection("Appearance",!1),this.addCheckbox("Show Background",t.show_background!==!1,s=>n("show_background",s)),t.show_background!==!1&&(this.addColorSelector("Background Color",t.background_color||"black",o,s=>{n("background_color",s);const r=["black","gray","grey","#000000","#808080"],d=["white","#ffffff","#fff"],c=t.color||"white";r.includes(s.toLowerCase())&&r.includes(c.toLowerCase())?n("color","white"):d.includes(s.toLowerCase())&&d.includes(c.toLowerCase())&&n("color","black")}),this.addLabeledInput("Border Radius","number",t.border_radius||8,s=>n("border_radius",parseInt(s,10))),this.addLabeledInput("Border Thickness","number",t.border_thickness||0,s=>n("border_thickness",parseInt(s,10))),this.addColorSelector("Border Color",t.border_color||"white",o,s=>n("border_color",s))),this.endSection(),this.createSection("Sizes & Color",!1),this.addLabeledInput("Icon Size","number",t.icon_size||24,s=>n("icon_size",parseInt(s,10))),this.addColorSelector("Foreground Color",t.color||"white",o,s=>n("color",s)),this.endSection();else if(i==="touch_area"||i==="nav_next_page"||i==="nav_previous_page"||i==="nav_reload_page"){this.createSection("Action",!0),this.addSelect("Navigation Action",t.nav_action||"none",[{value:"none",label:"None (Entity Toggle)"},{value:"next_page",label:"Next Page"},{value:"previous_page",label:"Previous Page"},{value:"reload_page",label:"Reload Page"}],c=>{n("nav_action",c),(t.icon==="F0142"||t.icon==="F0141"||t.icon==="F0450"||!t.icon)&&(c==="next_page"?n("icon","F0142"):c==="previous_page"?n("icon","F0141"):c==="reload_page"&&n("icon","F0450"))}),(t.nav_action||"none")==="none"&&this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",c=>{h.updateWidget(e.id,{entity_id:c})},e),this.endSection(),this.createSection("Content",!1),this.addLabeledInput("Title","text",t.title||"",c=>n("title",c)),this.addIconPicker("Normal Icon",t.icon||"",c=>n("icon",c),e),this.addIconPicker("Pressed Icon",t.icon_pressed||"",c=>n("icon_pressed",c),e),this.addLabeledInput("Icon Size","number",t.icon_size||40,c=>n("icon_size",parseInt(c,10))),this.addColorSelector("Icon Color",t.icon_color||"black",o,c=>n("icon_color",c)),this.endSection(),this.createSection("Appearance",!1);const s=t.color||"rgba(0, 0, 255, 0.2)";let r="#0000ff",d=.2;if(s.startsWith("#"))r=s,d=1;else if(s.startsWith("rgba")){const c=s.match(/([\d\.]+)/g);if(c&&c.length>=4){const a=parseInt(c[0]),u=parseInt(c[1]),m=parseInt(c[2]);d=parseFloat(c[3]),r="#"+((1<<24)+(a<<16)+(u<<8)+m).toString(16).slice(1)}}this.addLabeledInput("Preview Color","color",r,c=>{const a=parseInt(c.slice(1,3),16),u=parseInt(c.slice(3,5),16),m=parseInt(c.slice(5,7),16);n("color",`rgba(${a}, ${u}, ${m}, ${d})`),n("border_color",c)}),this.addLabeledInput("Opacity (0.0 - 1.0)","number",d,c=>{let a=parseFloat(c);a<0&&(a=0),a>1&&(a=1);const u=parseInt(r.slice(1,3),16),m=parseInt(r.slice(3,5),16),g=parseInt(r.slice(5,7),16);n("color",`rgba(${u}, ${m}, ${g}, ${a})`)}),this.addColorSelector("Border Color",t.border_color||"#0000ff",o,c=>n("border_color",c)),this.endSection()}else if(i==="image"){this.createSection("Content",!0),this.addHint("ð¼ï¸ Static image from ESPHome:<br/><code style='background:#f0f0f0;padding:2px 4px;border-radius:2px;'>/config/esphome/images/logo.png</code><br/><span style='color:#4a9eff;'>â¹ï¸ Place images in /config/esphome/images/ folder</span>"),this.addLabeledInput("Image Path","text",t.path||"",c=>n("path",c)),this.endSection(),this.createSection("Appearance",!1),t.invert===void 0&&n("invert",Ee()==="reterminal_e1001"),this.addCheckbox("Invert colors",t.invert||!1,c=>n("invert",c)),this.addSelect("Render Mode",t.render_mode||"Auto",["Auto","Binary","Grayscale","Color (RGB565)"],c=>n("render_mode",c));const s=document.createElement("div");s.className="field",s.style.marginTop="12px";const r=e.x===0&&e.y===0&&e.width===800&&e.height===480,d=document.createElement("button");d.className="btn "+(r?"btn-primary":"btn-secondary")+" btn-full",d.textContent=r?"â Full Screen (click to restore)":"â¶ Fill Screen",d.type="button",d.addEventListener("click",()=>{r?h.updateWidget(e.id,{x:50,y:50,width:200,height:150}):h.updateWidget(e.id,{x:0,y:0,width:800,height:480})}),s.appendChild(d),this.getContainer().appendChild(s),this.endSection()}else if(i==="online_image"){this.createSection("Content",!0),this.addHint("ð¡ Fetch remote images dynamically (Puppet support):<br/><code style='background:#f0f0f0;padding:2px 4px;border-radius:2px;'>https://example.com/camera/snapshot.jpg </code><br/><span style='color:#4a9eff;'>â¹ï¸ Images are downloaded at specified intervals</span>"),this.addLabeledInput("Remote URL","text",t.url||"",c=>n("url",c)),this.addLabeledInput("Update interval (seconds)","number",t.interval_s||300,c=>n("interval_s",parseInt(c,10))),this.endSection(),this.createSection("Appearance",!1),t.invert===void 0&&n("invert",Ee()==="reterminal_e1001"),this.addCheckbox("Invert colors",t.invert||!1,c=>n("invert",c)),this.addSelect("Render Mode",t.render_mode||"Auto",["Auto","Binary","Grayscale","Color (RGB565)"],c=>n("render_mode",c));const s=document.createElement("div");s.className="field",s.style.marginTop="12px";const r=e.x===0&&e.y===0&&e.width===800&&e.height===480,d=document.createElement("button");d.className="btn "+(r?"btn-primary":"btn-secondary")+" btn-full",d.textContent=r?"â Full Screen (click to restore)":"â¶ Fill Screen",d.type="button",d.addEventListener("click",()=>{r?h.updateWidget(e.id,{x:50,y:50,width:200,height:150}):h.updateWidget(e.id,{x:0,y:0,width:800,height:480})}),s.appendChild(d),this.getContainer().appendChild(s),this.endSection()}else if(i==="qr_code")this.createSection("Content",!0),this.addHint("ð± Generate QR codes that can be scanned by phones/tablets"),this.addLabeledInput("QR Content","text",t.value||"https://esphome.io",s=>n("value",s)),this.addHint("Enter a URL, text, or any string to encode"),this.endSection(),this.createSection("Appearance",!1),this.addLabeledInput("Scale","number",t.scale||2,s=>{let r=parseInt(s||"2",10);(Number.isNaN(r)||r<1)&&(r=1),r>10&&(r=10),n("scale",r)}),this.addHint("Size multiplier (1-10). Larger = bigger QR code"),this.addSelect("Error Correction",t.ecc||"LOW",["LOW","MEDIUM","QUARTILE","HIGH"],s=>n("ecc",s)),this.addHint("Higher = more redundancy, can recover from damage"),this.addSelect("Color",t.color||"black",["black","white"],s=>n("color",s)),this.endSection();else if(i==="quote_rss"){this.createSection("Feed Settings",!0),this.addHint("ð° Display quotes from an RSS feed (Quote of the Day)"),this.addLabeledInput("Feed URL","text",t.feed_url||"https://www.brainyquote.com/link/quotebr.rss",u=>n("feed_url",u)),this.addHint("Enter any RSS feed URL. Default: BrainyQuote daily quotes"),this.addCheckbox("Show Author",t.show_author!==!1,u=>n("show_author",u)),this.addCheckbox("Random Quote",t.random!==!1,u=>n("random",u)),this.addHint("Pick a random quote from the feed, or use the first one");const s=["15min","30min","1h","2h","4h","8h","12h","24h"];this.addSelect("Refresh Interval",t.refresh_interval||"24h",s,u=>n("refresh_interval",u)),this.addLabeledInput("Home Assistant URL","text",t.ha_url||"http://homeassistant.local:8123",u=>n("ha_url",u)),this.addHint("Address of your Home Assistant instance (for Proxy)"),this.endSection(),this.createSection("Typography",!1),this.addLabeledInput("Quote Text Size (Line 1)","number",t.quote_font_size||18,u=>n("quote_font_size",parseInt(u,10))),this.addLabeledInput("Author Size (Line 2)","number",t.author_font_size||14,u=>n("author_font_size",parseInt(u,10)));const r=["Roboto","Inter","Open Sans","Lato","Montserrat","Poppins","Raleway","Roboto Mono","Ubuntu","Nunito","Playfair Display","Merriweather","Work Sans","Source Sans Pro","Quicksand","Custom..."],d=t.font_family||"Roboto",c=!r.slice(0,-1).includes(d);this.addSelect("Font",c?"Custom...":d,r,u=>{u!=="Custom..."?(n("font_family",u),n("custom_font_family","")):n("font_family","Custom...")}),(c||t.font_family==="Custom...")&&(this.addLabeledInput("Custom Font Name","text",t.custom_font_family||(c?d:""),u=>{n("font_family",u||"Roboto"),n("custom_font_family",u)}),this.addHint('Browse <a href="https://fonts.google.com" target="_blank">fonts.google.com</a>')),this.addSelect("Weight",t.font_weight||400,[100,200,300,400,500,600,700,800,900],u=>n("font_weight",parseInt(u,10)));const a=["TOP_LEFT","TOP_CENTER","TOP_RIGHT","CENTER_LEFT","CENTER","CENTER_RIGHT","BOTTOM_LEFT","BOTTOM_CENTER","BOTTOM_RIGHT"];this.addSelect("Align",t.text_align||"TOP_LEFT",a,u=>n("text_align",u)),this.addColorSelector("Color",t.color||"black",o,u=>n("color",u)),this.endSection(),this.createSection("Display Options",!1),this.addCheckbox("Word Wrap",t.word_wrap!==!1,u=>n("word_wrap",u)),this.addCheckbox("Auto Scale Text",t.auto_scale||!1,u=>n("auto_scale",u)),this.addHint("Automatically reduce font size if text is too long"),this.addCheckbox("Italic Quote",t.italic_quote!==!1,u=>n("italic_quote",u)),this.endSection()}else if(i==="calendar"){this.createSection("Appearance",!1),this.addColorSelector("Text Color",t.text_color||"black",o,d=>n("text_color",d)),this.addColorSelector("Border Color",t.border_color||"black",o,d=>n("border_color",d)),this.addColorSelector("Background",t.background_color||"white",o,d=>n("background_color",d)),this.addLabeledInput("Border Width","number",t.border_width||2,d=>n("border_width",parseInt(d,10))),this.addCheckbox("Show Border",t.show_border!==!1,d=>n("show_border",d)),this.endSection(),this.createSection("Font Sizes",!1),this.addLabeledInput("Big Date Size","number",t.font_size_date||100,d=>n("font_size_date",parseInt(d,10))),this.addLabeledInput("Day Name Size","number",t.font_size_day||24,d=>n("font_size_day",parseInt(d,10))),this.addLabeledInput("Grid Text Size","number",t.font_size_grid||14,d=>n("font_size_grid",parseInt(d,10))),this.addLabeledInput("Event Text Size","number",t.font_size_event||18,d=>n("font_size_event",parseInt(d,10))),this.endSection(),this.createSection("Data Source",!1),this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"sensor.esp_calendar_data",d=>{h.updateWidget(e.id,{entity_id:d})},e),this.addLabeledInput("Max Events","number",t.max_events||8,d=>n("max_events",parseInt(d,10))),this.addHint("Must be a sensor with attribute 'entries'");const s=document.createElement("button");s.className="btn btn-secondary btn-full btn-xs",s.textContent="Download Helper Script",s.style.marginTop="10px",s.addEventListener("click",()=>{const d=document.createElement("a");d.setAttribute("href","data:text/x-python;charset=utf-8,"+encodeURIComponent(ss)),d.setAttribute("download","esp_calendar_data_conversion.py"),d.style.display="none",document.body.appendChild(d),d.click(),document.body.removeChild(d)}),this.getContainer().appendChild(s),this.addHint("Place in /config/python_scripts/");const r=document.createElement("div");r.style.marginTop="5px",r.style.fontSize="10px",r.style.color="#888",r.style.textAlign="center",r.innerText="Check widget instructions for HA setup.",this.getContainer().appendChild(r),this.endSection()}else if(i==="puppet")this.createSection("Content",!0),this.addLabeledInput("File path / URL","text",t.image_url||"",s=>n("image_url",s)),this.addHint('Tip: Use mdi:icon-name for Material Design Icons. <br><b>Important:</b> Ensure `materialdesignicons - webfont.ttf` is in your ESPHome `fonts / ` folder. <a href="https://pictogrammers.com/library/mdi/" target="_blank" style="color: #52c7ea">MDI Library</a>'),this.endSection(),this.createSection("Appearance",!1),this.addSelect("Image type",t.image_type||"RGB565",["RGB565","RGB","GRAYSCALE","BINARY"],s=>n("image_type",s)),this.addHint("RGB565=2B/px, RGB=3B/px, GRAYSCALE=1B/px, BINARY=1bit/px"),this.addSelect("Transparency",t.transparency||"opaque",["opaque","chroma_key","alpha_channel"],s=>n("transparency",s)),this.addHint("opaque=no transparency, chroma_key=color key, alpha_channel=smooth blend"),this.endSection();else if(i==="lvgl_label"||i.startsWith("lvgl_")){if(this.addCommonLVGLProperties(e,t),this.createSection("Widget Settings",!0),i==="lvgl_label"){this.addLabeledInput("Text","text",t.text||"Label",a=>n("text",a)),this.addLabeledInput("Font Size","number",t.font_size||20,a=>n("font_size",parseInt(a,10))),this.addColorMixer("Text Color",t.color||"black",a=>n("color",a)),this.addColorMixer("Background Color",t.bg_color||"transparent",a=>n("bg_color",a));const s=["Roboto","Inter","Open Sans","Lato","Montserrat","Poppins","Raleway","Roboto Mono","Ubuntu","Nunito","Playfair Display","Merriweather","Work Sans","Source Sans Pro","Quicksand","Custom..."],r=t.font_family||"Roboto",d=!s.slice(0,-1).includes(r);this.addSelect("Font",d?"Custom...":r,s,a=>{a!=="Custom..."?n("font_family",a):n("font_family","Custom...")}),this.addSelect("Weight",t.font_weight||400,[100,200,300,400,500,600,700,800,900],a=>n("font_weight",parseInt(a,10))),this.addCheckbox("Italic",t.italic||!1,a=>n("italic",a));const c=["TOP_LEFT","TOP_CENTER","TOP_RIGHT","CENTER_LEFT","CENTER","CENTER_RIGHT","BOTTOM_LEFT","BOTTOM_CENTER","BOTTOM_RIGHT"];this.addSelect("Align",t.text_align||"CENTER",c,a=>n("text_align",a))}else if(i==="lvgl_line"){const s=t.orientation||"horizontal";this.addSelect("Orientation",s,["horizontal","vertical"],g=>{const f=e.width,v=e.height;h.updateWidget(e.id,{props:{...t,orientation:g},width:v,height:f})}),this.addLabeledInput("Line Width","number",t.line_width||3,g=>n("line_width",parseInt(g,10))),this.addColorMixer("Line Color",t.line_color||t.color||"black",g=>n("line_color",g)),this.addCheckbox("Rounded Ends",t.line_rounded!==!1,g=>n("line_rounded",g)),this.addLabeledInput("Opacity (0-255)","number",t.opa||255,g=>n("opa",parseInt(g,10))),this.createSection("Quick Size",!1);const r=document.createElement("div");r.style.display="flex",r.style.gap="8px",r.style.marginBottom="8px";const d=h.getCanvasDimensions(),c=d.width,a=d.height,u=document.createElement("button");u.className="btn btn-secondary",u.style.flex="1",u.textContent="â Fill Horizontal",u.addEventListener("click",()=>{const g=t.line_width||3;h.updateWidget(e.id,{x:0,y:e.y,width:c,height:g,props:{...t,orientation:"horizontal"}})});const m=document.createElement("button");m.className="btn btn-secondary",m.style.flex="1",m.textContent="â Fill Vertical",m.addEventListener("click",()=>{const g=t.line_width||3;h.updateWidget(e.id,{x:e.x,y:0,width:g,height:a,props:{...t,orientation:"vertical"}})}),r.appendChild(m),this.getContainer().appendChild(r),this.endSection()}else i==="lvgl_meter"?(this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",s=>{h.updateWidget(e.id,{entity_id:s})},e),this.createSection("Scale",!1),this.addLabeledInput("Min Value","number",t.min||0,s=>n("min",parseInt(s,10))),this.addLabeledInput("Max Value","number",t.max||100,s=>n("max",parseInt(s,10))),this.endSection(),this.createSection("Preview",!1),this.addLabeledInput("Value (Preview)","number",t.value!==void 0?t.value:60,s=>n("value",parseInt(s,10))),this.endSection(),this.createSection("Appearance",!1),this.addColorMixer("Scale Color",t.color||"black",s=>n("color",s)),this.addColorMixer("Needle Color",t.indicator_color||"red",s=>n("indicator_color",s)),this.addLabeledInput("Scale Width","number",t.scale_width||10,s=>n("scale_width",parseInt(s,10))),this.addLabeledInput("Needle Width","number",t.indicator_width||4,s=>n("indicator_width",parseInt(s,10))),this.addLabeledInput("Ticks","number",t.tick_count||11,s=>n("tick_count",parseInt(s,10))),this.addLabeledInput("Tick Length","number",t.tick_length||10,s=>n("tick_length",parseInt(s,10))),this.addLabeledInput("Label Gap","number",t.label_gap||10,s=>n("label_gap",parseInt(s,10))),this.endSection()):i==="lvgl_button"?(this.addLabeledInputWithPicker("Action Entity ID","text",e.entity_id||"",s=>{h.updateWidget(e.id,{entity_id:s})},e),this.addHint("Entity to toggle/trigger when clicked"),this.addLabeledInput("Text","text",t.text||"BTN",s=>n("text",s)),this.addColorMixer("Background Color",t.bg_color||"white",s=>n("bg_color",s)),this.addColorMixer("Text Color",t.color||"black",s=>n("color",s)),this.addLabeledInput("Border Width","number",t.border_width||2,s=>n("border_width",parseInt(s,10))),this.addLabeledInput("Corner Radius","number",t.radius||5,s=>n("radius",parseInt(s,10))),this.addCheckbox("Checkable (Toggle)",t.checkable||!1,s=>n("checkable",s))):i==="lvgl_arc"?(this.addLabeledInputWithPicker("Sensor Entity ID","text",e.entity_id||"",s=>{h.updateWidget(e.id,{entity_id:s})},e),this.addHint("Sensor to bind to arc value"),this.addLabeledInput("Title / Label","text",t.title||"",s=>{const r={...e.props,title:s};h.updateWidget(e.id,{props:r})}),this.addLabeledInput("Min Value","number",t.min||0,s=>n("min",parseInt(s,10))),this.addLabeledInput("Max Value","number",t.max||100,s=>n("max",parseInt(s,10))),this.addLabeledInput("Default/Preview Value","number",t.value||0,s=>n("value",parseInt(s,10))),this.addLabeledInput("Thickness","number",t.thickness||10,s=>n("thickness",parseInt(s,10))),this.addLabeledInput("Start Angle","number",t.start_angle||135,s=>n("start_angle",parseInt(s,10))),this.addLabeledInput("End Angle","number",t.end_angle||45,s=>n("end_angle",parseInt(s,10))),this.addSelect("Mode",t.mode||"NORMAL",["NORMAL","SYMMETRICAL","REVERSE"],s=>n("mode",s)),this.addColorMixer("Color",t.color||"blue",s=>n("color",s))):i==="lvgl_chart"?(this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",s=>{h.updateWidget(e.id,{entity_id:s})},e),this.addLabeledInput("Title","text",t.title||"",s=>n("title",s)),this.addSelect("Type",t.type||"LINE",["LINE","SCATTER","BAR"],s=>n("type",s)),this.addLabeledInput("Min Value","number",t.min||0,s=>n("min",parseInt(s,10))),this.addLabeledInput("Max Value","number",t.max||100,s=>n("max",parseInt(s,10))),this.addLabeledInput("Point Count","number",t.point_count||10,s=>n("point_count",parseInt(s,10))),this.addLabeledInput("X Div Lines","number",t.x_div_lines||3,s=>n("x_div_lines",parseInt(s,10))),this.addLabeledInput("Y Div Lines","number",t.y_div_lines||3,s=>n("y_div_lines",parseInt(s,10))),this.addColorMixer("Color",t.color||"black",s=>n("color",s))):i==="lvgl_img"?(this.addLabeledInput("Source (Image/Symbol)","text",t.src||"",s=>n("src",s)),this.addHint("e.g. symbol_ok, symbol_home, or /image.png"),this.addLabeledInput("Rotation (0.1 deg)","number",t.rotation||0,s=>n("rotation",parseInt(s,10))),this.addLabeledInput("Scale (256 = 1x)","number",t.scale||256,s=>n("scale",parseInt(s,10))),this.addColorMixer("Color (Tint)",t.color||"black",s=>n("color",s))):i==="lvgl_qrcode"?(this.createSection("Content",!0),this.addLabeledInput("Content / URL","text",t.text||"",s=>n("text",s)),this.addLabeledInput("Size (px)","number",t.size||100,s=>n("size",parseInt(s,10))),this.addColorMixer("Color",t.color||"black",s=>n("color",s)),this.addColorMixer("Background Color",t.bg_color||"white",s=>n("bg_color",s)),this.endSection()):i==="lvgl_bar"?(this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",s=>{h.updateWidget(e.id,{entity_id:s})},e),this.addLabeledInput("Min Value","number",t.min||0,s=>n("min",parseInt(s,10))),this.addLabeledInput("Max Value","number",t.max||100,s=>n("max",parseInt(s,10))),this.addLabeledInput("Preview Value","number",t.value||50,s=>n("value",parseInt(s,10))),this.addColorMixer("Bar Color",t.color||"black",s=>n("color",s)),this.addColorMixer("Background Color",t.bg_color||"gray",s=>n("bg_color",s)),this.addLabeledInput("Start Value","number",t.start_value||0,s=>n("start_value",parseInt(s,10))),this.addSelect("Mode",t.mode||"NORMAL",["NORMAL","SYMMETRICAL","REVERSE"],s=>n("mode",s)),this.addCheckbox("Range Mode",t.range_mode||!1,s=>n("range_mode",s))):i==="lvgl_slider"?(this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",s=>{h.updateWidget(e.id,{entity_id:s})},e),this.addHint("Controls this entity number/level"),this.addSegmentedControl("Orientation",[{value:"Horizontal",label:"Horiz",icon:"mdi-arrow-left-right"},{value:"Vertical",label:"Vert",icon:"mdi-arrow-up-down"}],t.vertical?"Vertical":"Horizontal",s=>{const r=s==="Vertical",d=e.width,c=e.height;h.updateWidget(e.id,{props:{...t,vertical:r},width:c,height:d})}),this.addCompactPropertyRow(()=>{this.addLabeledInput("Min","number",t.min||0,s=>n("min",parseInt(s,10))),this.addLabeledInput("Max","number",t.max||100,s=>n("max",parseInt(s,10)))}),this.addNumberWithSlider("Value",t.value||30,t.min||0,t.max||100,s=>n("value",s)),this.addColorMixer("Knob/Bar Color",t.color||"black",s=>n("color",s)),this.addColorMixer("Track Color",t.bg_color||"gray",s=>n("bg_color",s)),this.addLabeledInput("Border Width","number",t.border_width||2,s=>n("border_width",parseInt(s,10))),this.addSelect("Mode",t.mode||"NORMAL",["NORMAL","SYMMETRICAL","REVERSE"],s=>n("mode",s))):i==="lvgl_tabview"?(this.addLabeledInput("Tabs (comma separated)","text",(t.tabs||[]).join(", "),s=>{const r=s.split(",").map(d=>d.trim()).filter(d=>d);n("tabs",r)}),this.addColorMixer("Background Color",t.bg_color||"white",s=>n("bg_color",s))):i==="lvgl_tileview"?(this.addHint("Tiles are currently configured via YAML or advanced properties."),this.addColorMixer("Background Color",t.bg_color||"white",s=>n("bg_color",s))):i==="lvgl_led"?(this.addColorMixer("Color",t.color||"red",s=>n("color",s)),this.addLabeledInput("Brightness (0-255)","number",t.brightness||255,s=>n("brightness",parseInt(s,10)))):i==="lvgl_spinner"?(this.addLabeledInput("Spin Time (ms)","number",t.spin_time||1e3,s=>n("spin_time",parseInt(s,10))),this.addLabeledInput("Arc Length (deg)","number",t.arc_length||60,s=>n("arc_length",parseInt(s,10))),this.addColorMixer("Arc Color",t.arc_color||"blue",s=>n("arc_color",s)),this.addColorMixer("Track Color",t.track_color||"white",s=>n("track_color",s))):i==="lvgl_buttonmatrix"?(this.addHint("Edit rows via YAML or simple comma-separated lists per row."),t.rows):i==="lvgl_checkbox"?(this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",s=>{h.updateWidget(e.id,{entity_id:s})},e),this.addHint("Toggle input_boolean when tapped"),this.addLabeledInput("Label","text",t.text||"Checkbox",s=>n("text",s)),this.addCheckbox("Checked",t.checked||!1,s=>n("checked",s)),this.addColorMixer("Color",t.color||"blue",s=>n("color",s))):i==="lvgl_dropdown"?(this.addLabeledInput("Options (one per line)","textarea",t.options||"",s=>n("options",s)),this.addCompactPropertyRow(()=>{this.addLabeledInput("Index","number",t.selected_index||0,s=>n("selected_index",parseInt(s,10))),this.addLabeledInput("Max H","number",t.max_height||200,s=>n("max_height",parseInt(s,10)))}),this.addSegmentedControl("Direction",[{value:"DOWN",icon:"mdi-arrow-down"},{value:"UP",icon:"mdi-arrow-up"},{value:"LEFT",icon:"mdi-arrow-left"},{value:"RIGHT",icon:"mdi-arrow-right"}],t.direction||"DOWN",s=>n("direction",s)),this.addColorMixer("Color",t.color||"white",s=>n("color",s))):i==="lvgl_keyboard"?(this.addSelect("Mode",t.mode||"TEXT_UPPER",["TEXT_LOWER","TEXT_UPPER","SPECIAL","NUMBER"],s=>n("mode",s)),this.addLabeledInput("Textarea ID Link","text",t.textarea_id||"",s=>n("textarea_id",s))):i==="lvgl_roller"?(this.addLabeledInput("Options (one per line)","textarea",t.options||"",s=>n("options",s)),this.addLabeledInput("Visible Rows","number",t.visible_row_count||3,s=>n("visible_row_count",parseInt(s,10))),this.addColorMixer("Color",t.color||"white",s=>n("color",s)),this.addColorMixer("Background Color",t.bg_color||"black",s=>n("bg_color",s)),this.addColorMixer("Selected BG Color",t.selected_bg_color||"blue",s=>n("selected_bg_color",s)),this.addColorMixer("Selected Text Color",t.selected_text_color||"white",s=>n("selected_text_color",s)),this.addSelect("Mode",t.mode||"NORMAL",["NORMAL","INFINITE"],s=>n("mode",s))):i==="lvgl_spinbox"?(this.addLabeledInput("Min","number",t.min||0,s=>n("min",parseInt(s,10))),this.addLabeledInput("Max","number",t.max||100,s=>n("max",parseInt(s,10))),this.addLabeledInput("Value","number",t.value||0,s=>n("value",parseInt(s,10))),this.addLabeledInput("Digits","number",t.digit_count||4,s=>n("digit_count",parseInt(s,10))),this.addLabeledInput("Step","number",t.step||1,s=>n("step",parseInt(s,10)))):i==="lvgl_switch"?(this.addLabeledInputWithPicker("Entity ID","text",e.entity_id||"",s=>{h.updateWidget(e.id,{entity_id:s})},e),this.addHint("Toggle switch/light/input_boolean when tapped"),this.addCheckbox("Checked",t.checked||!1,s=>n("checked",s)),this.addColorMixer("Indicator Color",t.color||"blue",s=>n("color",s)),this.addColorMixer("Background Color",t.bg_color||"gray",s=>n("bg_color",s)),this.addColorMixer("Knob Color",t.knob_color||"white",s=>n("knob_color",s))):i==="lvgl_textarea"?(this.addLabeledInput("Placeholder","text",t.placeholder||"",s=>n("placeholder",s)),this.addLabeledInput("Text","text",t.text||"",s=>n("text",s)),this.addCheckbox("One Line",t.one_line||!1,s=>n("one_line",s)),this.addCheckbox("Password Mode",t.password_mode||!1,s=>n("password_mode",s)),this.addLabeledInput("Accepted Chars","text",t.accepted_chars||"",s=>n("accepted_chars",s)),this.addLabeledInput("Max Length","number",t.max_length||0,s=>n("max_length",parseInt(s,10)))):i==="lvgl_obj"&&(this.addColorMixer("Color",t.color||"white",s=>n("color",s)),this.addLabeledInput("Border Width","number",t.border_width||1,s=>n("border_width",parseInt(s,10))),this.addColorMixer("Border Color",t.border_color||"gray",s=>n("border_color",s)),this.addLabeledInput("Radius","number",t.radius||0,s=>n("radius",parseInt(s,10))));this.endSection()}}addCommonLVGLProperties(e,i){const o=(s,r)=>{const d={...e.props,[s]:r};h.updateWidget(e.id,{props:d})};this.createSection("Common LVGL",!1);const t=document.createElement("div");t.style.display="grid",t.style.gridTemplateColumns="1fr 1fr",t.style.gap="4px",this.getContainer().appendChild(t);const n=(s,r,d=!1)=>{const c=document.createElement("div"),a=document.createElement("input");a.type="checkbox",a.checked=i[r]!==void 0?i[r]:d,a.addEventListener("change",()=>o(r,a.checked));const u=document.createElement("span");u.textContent=" "+s,u.style.fontSize="10px",c.appendChild(a),c.appendChild(u),t.appendChild(c)};n("Hidden","hidden",!1),n("Clickable","clickable",!0),n("Checkable","checkable",!1),n("Scrollable","scrollable",!0),n("Floating","floating",!1),n("Ignore Layout","ignore_layout",!1),this.addSelect("Scrollbar Mode",i.scrollbar_mode||"AUTO",["AUTO","ON","OFF","ACTIVE"],s=>o("scrollbar_mode",s)),this.endSection()}addNumberWithSlider(e,i,o,t,n){const s=document.createElement("div");s.className="field";const r=document.createElement("div");r.className="prop-label",r.textContent=e;const d=document.createElement("div");d.className="slider-hybrid";const c=document.createElement("input");c.type="range",c.min=o,c.max=t,c.value=i;const a=document.createElement("input");a.className="prop-input",a.type="number",a.value=i,a.min=o,a.max=t,c.addEventListener("input",()=>{a.value=c.value,n(parseInt(c.value,10))}),a.addEventListener("input",()=>{c.value=a.value,n(parseInt(a.value,10))}),d.appendChild(c),d.appendChild(a),s.appendChild(r),s.appendChild(d),this.getContainer().appendChild(s)}addSegmentedControl(e,i,o,t){const n=document.createElement("div");n.className="field";const s=document.createElement("div");s.className="prop-label",s.textContent=e;const r=document.createElement("div");r.className="segmented-control",i.forEach(d=>{const c=document.createElement("div");c.className="segment-item"+(d.value===o?" active":""),c.title=d.label||d.value,d.icon?c.innerHTML=`< i class="mdi ${d.icon}" ></i > `:c.textContent=d.label||d.value,c.onclick=()=>{r.querySelectorAll(".segment-item").forEach(a=>a.classList.remove("active")),c.classList.add("active"),t(d.value)},r.appendChild(c)}),n.appendChild(s),n.appendChild(r),this.getContainer().appendChild(n)}addCompactPropertyRow(e){const i=document.createElement("div");i.className="prop-grid-2",this.getContainer().appendChild(i),this.containerStack.push(i),e(),this.containerStack.pop()}addLabeledInput(e,i,o,t){const n=document.createElement("div");n.className="field";const s=document.createElement("div");s.className="prop-label",s.textContent=e;const r=document.createElement("input");r.className="prop-input",r.type=i,r.value=o,r.addEventListener("input",()=>{t(r.value)}),r.addEventListener("change",()=>{t(r.value)}),n.appendChild(s),n.appendChild(r),this.getContainer().appendChild(n)}addSelect(e,i,o,t){const n=document.createElement("div");n.className="field";const s=document.createElement("div");s.className="prop-label",s.textContent=e;const r=document.createElement("select");r.className="prop-input",o.forEach(d=>{const c=document.createElement("option");typeof d=="object"&&d!==null?(c.value=d.value,c.textContent=d.label,d.value===i&&(c.selected=!0)):(c.value=d,c.textContent=d,d===i&&(c.selected=!0)),r.appendChild(c)}),r.addEventListener("change",()=>t(r.value)),n.appendChild(s),n.appendChild(r),this.getContainer().appendChild(n)}addCheckbox(e,i,o){const t=document.createElement("div");t.className="field",t.style.marginBottom="8px";const n=document.createElement("label");n.style.display="flex",n.style.alignItems="center",n.style.gap="8px",n.style.fontSize="13px",n.style.cursor="pointer";const s=document.createElement("input");s.type="checkbox",s.checked=!!i,s.style.width="16px",s.style.height="16px",s.style.margin="0",s.style.cursor="pointer",s.addEventListener("change",()=>o(s.checked));const r=document.createElement("span");r.textContent=e,n.appendChild(s),n.appendChild(r),t.appendChild(n),this.getContainer().appendChild(t)}addHint(e){const i=document.createElement("div");i.style.fontSize="11px",i.style.color="#666",i.style.marginTop="4px",i.style.marginBottom="12px",i.style.lineHeight="1.4",i.innerHTML=e,this.getContainer().appendChild(i)}addLabeledInputWithDataList(e,i,o,t,n){const s=document.createElement("div");s.className="field";const r=document.createElement("div");r.className="prop-label",r.textContent=e;const d="datalist_"+Math.random().toString(36).substr(2,9),c=document.createElement("datalist");c.id=d,t.forEach(u=>{const m=document.createElement("option");m.value=u,c.appendChild(m)});const a=document.createElement("input");a.className="prop-input",a.type=i,a.value=o,a.setAttribute("list",d),a.addEventListener("input",()=>n(a.value)),a.addEventListener("change",()=>n(a.value)),s.appendChild(r),s.appendChild(a),s.appendChild(c),this.getContainer().appendChild(s)}addSectionLabel(e){const i=document.createElement("div");i.className="sidebar-section-label",i.textContent=e,this.getContainer().appendChild(i)}autoPopulateTitleFromEntity(e,i){!i||!window.AppState||typeof he=="function"&&he().then(o=>{if(!o||o.length===0)return;const t=o.find(n=>n.entity_id===i);if(t&&t.name){const n=h.getSelectedWidget();n&&n.id===e&&!n.title&&h.updateWidget(e,{title:t.name})}}).catch(()=>{})}addVisibilityConditions(e){e.condition_entity=e.condition_entity||"",e.condition_operator=e.condition_operator||"==",e.condition_state=e.condition_state||"",e.condition_min=e.condition_min||"",e.condition_max=e.condition_max||"";const i=document.createElement("div");i.className="field",i.style.fontSize="9px",i.style.color="#9499a6",i.style.marginBottom="6px",i.innerHTML="Show/hide this widget based on an entity's state.",this.getContainer().appendChild(i),this.addLabeledInputWithPicker("Condition Entity","text",e.condition_entity,r=>{h.updateWidget(e.id,{condition_entity:r})},e);const o=["==","!=","<",">","<=",">="];this.addSelect("Operator",e.condition_operator,o,r=>{h.updateWidget(e.id,{condition_operator:r})});const t=["on","off","open","closed","true","false","home","not_home","locked","unlocked","active","inactive","detected","clear","occupied"];this.addLabeledInputWithDataList("Condition State","text",e.condition_state,t,r=>{h.updateWidget(e.id,{condition_state:r})}),this.addLabeledInput("Min Value (Range)","text",e.condition_min,r=>{h.updateWidget(e.id,{condition_min:r})}),this.addLabeledInput("Max Value (Range)","text",e.condition_max,r=>{h.updateWidget(e.id,{condition_max:r})});const n=document.createElement("div");n.className="field",n.style.marginTop="8px";const s=document.createElement("button");s.className="btn btn-secondary btn-full",s.textContent="Clear Condition",s.type="button",s.addEventListener("click",()=>{h.updateWidget(e.id,{condition_entity:"",condition_operator:"==",condition_state:"",condition_min:"",condition_max:""})}),n.appendChild(s),this.getContainer().appendChild(n)}addLabeledInputWithPicker(e,i,o,t,n){const s=document.createElement("div");s.className="field";const r=document.createElement("div");r.className="prop-label",r.textContent=e;const d=document.createElement("div");d.style.display="flex",d.style.gap="4px";const c=document.createElement("input");c.className="prop-input",c.type=i,c.value=o,c.style.flex="1",c.placeholder="Start typing or click â¼ to pick...",c.autocomplete="off",c.setAttribute("list",rt),Jt(),c.addEventListener("input",()=>t(c.value));const a=document.createElement("button");a.className="btn btn-secondary",a.innerHTML="â¼",a.style.padding="4px 8px",a.style.fontSize="10px",a.style.minWidth="32px",a.type="button",a.title="Browse all entities",a.addEventListener("click",()=>{Qi(n,c,u=>{c.value=u,t(u)})}),d.appendChild(c),d.appendChild(a),s.appendChild(r),s.appendChild(d),this.getContainer().appendChild(s)}addIconPicker(e,i,o,t){const n=window.iconPickerData||[],s=document.createElement("div");s.className="field";const r=document.createElement("div");r.className="prop-label",r.textContent=e,s.appendChild(r);const d=document.createElement("select");d.className="select",d.style.fontFamily="MDI, monospace, system-ui",d.style.fontSize="16px",d.style.lineHeight="1.5",d.style.width="100%",d.style.marginBottom="4px";const c=document.createElement("option");c.value="",c.textContent="-- Quick visual picker --",c.style.fontFamily="system-ui, -apple-system, BlinkMacSystemFont, sans-serif",d.appendChild(c);const a=(i||"").replace("mdi:","").toUpperCase();n.forEach(v=>{const b=document.createElement("option");b.value=v.code;const E=983040+parseInt(v.code.slice(1),16),y=String.fromCodePoint(E);b.textContent=y+"  "+v.code+(v.name?` (${v.name})`:""),b.style.fontFamily="MDI, monospace, system-ui",v.code===a&&(b.selected=!0),d.appendChild(b)}),d.addEventListener("change",()=>{d.value&&(m.value=d.value,o(d.value))}),s.appendChild(d);const u=document.createElement("div");u.style.display="flex",u.style.gap="4px";const m=document.createElement("input");m.className="prop-input",m.type="text",m.placeholder="MDI Hex (Fxxxx)",m.value=a,m.style.flex="1",m.style.fontFamily="monospace",m.addEventListener("input",()=>{const v=(m.value||"").trim().toUpperCase().replace(/^0X/,"").replace(/^MDI:/,"");/^F[0-9A-F]{4}$/i.test(v)?(o(v),Array.from(d.options).find(E=>E.value===v)?d.value=v:d.value=""):v===""&&(o(""),d.value="")}),u.appendChild(m);const g=document.createElement("button");g.className="btn btn-secondary",g.textContent="â",g.style.padding="4px 8px",g.style.fontSize="14px",g.type="button",g.title="Open full icon browser",g.addEventListener("click",()=>{$t(t,m)}),u.appendChild(g),s.appendChild(u);const f=document.createElement("div");f.className="prop-hint",f.innerHTML='Browse <a href="https://pictogrammers.com/library/mdi/icon/" target="_blank" style="color: #03a9f4; text-decoration: none;">Pictogrammers MDI</a>',s.appendChild(f),this.getContainer().appendChild(s)}addIconInput(e,i,o,t){const n=document.createElement("div");n.className="field";const s=document.createElement("div");s.className="prop-label",s.textContent=e;const r=document.createElement("div");r.style.display="flex",r.style.gap="4px";const d=document.createElement("input");d.className="prop-input",d.type="text",d.value=i,d.style.flex="1",d.addEventListener("input",()=>o(d.value));const c=document.createElement("button");c.className="btn btn-secondary",c.textContent="â",c.style.padding="4px 8px",c.style.fontSize="14px",c.type="button",c.addEventListener("click",()=>{$t(t,d)}),r.appendChild(d),r.appendChild(c),n.appendChild(s),n.appendChild(r),this.getContainer().appendChild(n)}addColorSelector(e,i,o,t){typeof isRGBDevice=="function"&&isRGBDevice()?this.addColorMixer(e,i,t):this.addSelect(e,i,o,t)}addColorMixer(e,i,o){const t=document.createElement("div");t.className="field",t.style.marginBottom="10px";const n=document.createElement("div");n.className="prop-label",n.textContent=e,t.appendChild(n);let s=0,r=0,d=0,c="#000000";const a=I=>{const L={black:"#000000",white:"#FFFFFF",red:"#FF0000",green:"#00FF00",blue:"#0000FF",yellow:"#FFFF00",gray:"#808080",grey:"#808080"};return I?L[I.toLowerCase()]?L[I.toLowerCase()]:I.startsWith("0x")?"#"+I.substring(2):I.startsWith("#")?I:"#000000":"#000000"},u=I=>{const L=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(I);return L?{r:parseInt(L[1],16),g:parseInt(L[2],16),b:parseInt(L[3],16)}:{r:0,g:0,b:0}},m=(I,L,H)=>{const N=$=>{const M=Math.max(0,Math.min(255,$)).toString(16);return M.length===1?"0"+M:M};return"#"+N(I)+N(L)+N(H)};c=a(i);const g=u(c);s=g.r,r=g.g,d=g.b;const f=document.createElement("div");f.style.background="var(--bg)",f.style.padding="8px",f.style.borderRadius="6px",f.style.border="1px solid var(--border-subtle)";const v=document.createElement("div");v.style.display="flex",v.style.alignItems="center",v.style.marginBottom="8px",v.style.gap="8px";const b=document.createElement("div");b.style.width="24px",b.style.height="24px",b.style.borderRadius="3px",b.style.backgroundColor=c,b.style.border="1px solid var(--border-subtle)";const E=document.createElement("input");E.type="text",E.value=c.toUpperCase(),E.className="prop-input",E.style.flex="1",E.style.fontFamily="monospace",v.appendChild(b),v.appendChild(E),f.appendChild(v);const y=(I,L,H)=>{const N=document.createElement("div");N.style.display="flex",N.style.alignItems="center",N.style.marginBottom="4px",N.style.fontSize="11px";const $=document.createElement("span");$.textContent=I,$.style.width="15px",$.style.fontWeight="bold",$.style.color="var(--text)";const M=document.createElement("input");M.type="range",M.min="0",M.max="255",M.value=L,M.style.flex="1",M.style.marginLeft="4px",M.style.accentColor=H;const X=document.createElement("span");return X.textContent=L,X.style.width="25px",X.style.textAlign="right",X.style.marginLeft="4px",X.style.color="var(--muted)",N.appendChild($),N.appendChild(M),N.appendChild(X),{row:N,slider:M,valLbl:X}},S=y("R",s,"red"),T=y("G",r,"green"),R=y("B",d,"blue");f.appendChild(S.row),f.appendChild(T.row),f.appendChild(R.row),t.appendChild(f),this.getContainer().appendChild(t);const B=()=>{s=parseInt(S.slider.value),r=parseInt(T.slider.value),d=parseInt(R.slider.value),S.valLbl.textContent=s,T.valLbl.textContent=r,R.valLbl.textContent=d;const I=m(s,r,d).toUpperCase();E.value=I,b.style.backgroundColor=I,o(I)},k=()=>{let I=E.value.trim();if(I.startsWith("#")||(I="#"+I),/^#[0-9A-F]{6}$/i.test(I)){const L=u(I);s=L.r,r=L.g,d=L.b,S.slider.value=s,S.valLbl.textContent=s,T.slider.value=r,T.valLbl.textContent=r,R.slider.value=d,R.valLbl.textContent=d,b.style.backgroundColor=I,o(I)}};S.slider.addEventListener("input",B),T.slider.addEventListener("input",B),R.slider.addEventListener("input",B),E.addEventListener("input",k),E.addEventListener("change",k)}}class ri{constructor(){this.init()}init(){window.addEventListener("keydown",e=>this.handleKeyDown(e))}handleKeyDown(e){const i=h||window.AppState;if(!i){_.error("KeyboardHandler: AppState not found!");return}const o=i.selectedWidgetIds.length>0;i.selectedWidgetId;const t=window.isAutoHighlight||!1;if(e.shiftKey&&e.code==="Space"){(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")&&e.target.blur(),e.preventDefault(),window.QuickSearch&&window.QuickSearch.open();return}if((e.key==="Delete"||e.key==="Backspace")&&o){const n=window.lastHighlightRange;if(e.target.id==="snippetBox"&&n&&e.target.selectionStart===n.start&&e.target.selectionEnd===n.end){e.preventDefault(),this.deleteWidget(null);return}if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")return;e.preventDefault(),this.deleteWidget(null);return}if((e.ctrlKey||e.metaKey)&&e.key&&e.key.toLowerCase()==="c"){if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"){if(e.target.id==="snippetBox"&&t){e.preventDefault(),this.copyWidget();return}return}e.preventDefault(),this.copyWidget();return}if((e.ctrlKey||e.metaKey)&&e.key&&e.key.toLowerCase()==="v"){if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"){if(e.target.id==="snippetBox"&&t){e.preventDefault(),this.pasteWidget();return}return}e.preventDefault(),this.pasteWidget();return}if((e.ctrlKey||e.metaKey)&&e.key&&e.key.toLowerCase()==="z"&&!e.shiftKey){if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"){if(e.target.id==="snippetBox"&&t){e.preventDefault(),window._undoRedoInProgress=!0,i.undo(),setTimeout(()=>{window._undoRedoInProgress=!1},100);return}return}e.preventDefault(),window._undoRedoInProgress=!0,i.undo(),setTimeout(()=>{window._undoRedoInProgress=!1},100);return}if((e.ctrlKey||e.metaKey)&&e.key&&(e.key.toLowerCase()==="y"||e.key.toLowerCase()==="z"&&e.shiftKey)){if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"){if(e.target.id==="snippetBox"&&t){e.preventDefault(),window._undoRedoInProgress=!0,i.redo(),setTimeout(()=>{window._undoRedoInProgress=!1},100);return}return}e.preventDefault(),window._undoRedoInProgress=!0,i.redo(),setTimeout(()=>{window._undoRedoInProgress=!1},100);return}if((e.ctrlKey||e.metaKey)&&e.key&&e.key.toLowerCase()==="l"&&o){e.preventDefault();const s=i.getSelectedWidgets().every(r=>r.locked);i.updateWidgets(i.selectedWidgetIds,{locked:!s})}if((e.ctrlKey||e.metaKey)&&e.key&&e.key.toLowerCase()==="a"){const n=e.target.id==="snippetBox"&&t;if(e.target.tagName!=="INPUT"&&e.target.tagName!=="TEXTAREA"||n){e.preventDefault(),i.selectAllWidgets();return}}if(e.key&&e.key.toLowerCase()==="g"&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey&&!e.altKey&&e.target.tagName!=="INPUT"&&e.target.tagName!=="TEXTAREA"){e.preventDefault();const n=!i.showGrid;i.setShowGrid(n);const s=document.getElementById("gridToggleBtn");s&&s.classList.toggle("active",n),_.log(`[Keyboard] Grid toggled: ${n}`);return}if(e.key&&e.key.toLowerCase()==="r"&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey&&!e.altKey&&e.target.tagName!=="INPUT"&&e.target.tagName!=="TEXTAREA"){e.preventDefault();const n=!i.showRulers;i.setShowRulers(n);const s=document.getElementById("rulersToggleBtn");s&&s.classList.toggle("active",n),_.log(`[Keyboard] Rulers toggled: ${n}`);return}}static isInput(e){return e.tagName==="INPUT"||e.tagName==="TEXTAREA"}deleteWidget(e){const i=h||window.AppState;i&&i.deleteWidget(e)}copyWidget(){const e=h||window.AppState;e&&e.copyWidget()}pasteWidget(){const e=h||window.AppState;e&&e.pasteWidget()}}window.KeyboardHandler=ri;window.LAYOUT={WIDGET:{SMALL:{W:100,H:20},MEDIUM:{W:200,H:60},LARGE:{W:200,H:100}},FONT:{SIZE:{XS:12,S:14,M:16,L:20,XL:28,XXL:40},DEFAULT:{LABEL:14,VALUE:20,TITLE:28,DATE:16}},GRID:{GAP:10,MARGIN:10}};Object.freeze(window.LAYOUT);function os(){const l=h.getPagesPayload(),e=JSON.stringify(l,null,2),i=new Blob([e],{type:"application/json"}),o=URL.createObjectURL(i),t=document.createElement("a");t.href=o,t.download=`reterminal_layout_${Date.now()}.json`,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(o)}function rs(l){if(!l)return;const e=new FileReader;e.onload=i=>{try{const o=i.target.result,t=JSON.parse(o);re(t)}catch(o){_.error("Failed to parse layout file:",o),alert("Error parsing layout file. Please ensure it is a valid JSON file.")}},e.readAsText(l)}function as(l){const e=l.target.files[0];rs(e),l.target.value=""}class Ce{constructor(){if(this.constructor===Ce)throw new Error("BaseAdapter is abstract and cannot be instantiated directly.")}async generate(e){throw new Error("Method 'generate()' must be implemented.")}generatePage(e,i){throw new Error("Method 'generatePage()' must be implemented.")}generateWidget(e,i){throw new Error("Method 'generateWidget()' must be implemented.")}sanitize(e){return e}}window.BaseAdapter=Ce;function ls(l,e="my_display",i=0){if(!l||!l.touch)return[];const o=l.touch,t=["touchscreen:"];t.push(`  - platform: ${o.platform}`),t.push("    id: my_touchscreen"),t.push(`    display: ${e}`),o.i2c_id&&t.push(`    i2c_id: ${o.i2c_id}`),o.spi_id&&t.push(`    spi_id: ${o.spi_id}`),o.address&&t.push(`    address: ${o.address}`),o.update_interval&&t.push(`    update_interval: ${o.update_interval}`);const n=(d,c)=>{c&&(typeof c=="string"||typeof c=="number"?t.push(`    ${d}: ${c}`):(t.push(`    ${d}:`),Object.entries(c).forEach(([a,u])=>t.push(`      ${a}: ${u}`))))};n("interrupt_pin",o.interrupt_pin),n("reset_pin",o.reset_pin),n("cs_pin",o.cs_pin);const s=[],r=o.transform||{};if((o.mirror_x||r.mirror_x)&&s.push("mirror_x: true"),(o.mirror_y||r.mirror_y)&&s.push("mirror_y: true"),(o.swap_xy||r.swap_xy)&&s.push("swap_xy: true"),s.length>0&&(t.push("    transform:"),s.forEach(d=>t.push(`      ${d}`))),o.calibration){t.push("    calibration:");const d=o.calibration;Object.entries(d).forEach(([c,a])=>t.push(`      ${c}: ${a}`))}return t.push(""),t}function De(l){const e=[];if(!l||!l.backlight)return e;const i=l.backlight;return(i.platform==="ledc"||i.platform==="gpio"||i.platform==="switch")&&(i.platform==="switch"?(e.push("switch:"),e.push("  - platform: gpio"),e.push("    id: lcdbacklight"),e.push("    name: lcdbacklight"),typeof i.pin=="object"?(e.push("    pin:"),Object.entries(i.pin).forEach(([o,t])=>{typeof t=="object"?(e.push(`      ${o}:`),Object.entries(t).forEach(([n,s])=>e.push(`        ${n}: ${s}`))):e.push(`      ${o}: ${t}`)})):e.push(`    pin: ${i.pin}`),e.push("    restore_mode: ALWAYS_ON"),e.push("")):(e.push("output:"),e.push(`  - platform: ${i.platform}`),e.push("    id: gpio_backlight_pwm"),e.push(`    pin: ${i.pin}`),i.frequency&&e.push(`    frequency: ${i.frequency}`),e.push(""))),e.push("light:"),e.push("  - platform: monochromatic"),e.push("    name: Display Backlight"),e.push("    id: display_backlight"),e.push("    restore_mode: ALWAYS_ON"),i.platform==="switch"?(e.push("    output: fake_backlight_output"),e.push("    default_transition_length: 0s"),e.push(""),e.push("output:"),e.push("  - platform: template"),e.push("    id: fake_backlight_output"),e.push("    type: float"),e.push("    write_action:"),e.push("      - if:"),e.push("          condition:"),e.push("            lambda: 'return state > 0.0;'"),e.push("          then:"),e.push("            - switch.turn_on: lcdbacklight"),e.push("          else:"),e.push("            - switch.turn_off: lcdbacklight")):e.push("    output: gpio_backlight_pwm"),e.push(""),e}function Oe(l){const e=[];return l.external_components&&Array.isArray(l.external_components)&&l.external_components.length>0&&(e.push("external_components:"),e.push(...l.external_components),e.push("")),l.extra_components&&Array.isArray(l.extra_components)&&(e.push(...l.extra_components),e.push("")),l.extra_components_raw&&(e.push(l.extra_components_raw),e.push("")),e}function We(l){const e=[];return l&&l.pins&&l.pins.i2c&&(e.push("i2c:"),e.push("  - sda: "+l.pins.i2c.sda),e.push("    scl: "+l.pins.i2c.scl),e.push("    scan: "+(l.i2c_config?.scan!==!1)),e.push("    id: bus_a"),l.i2c_config?.frequency&&e.push("    frequency: "+l.i2c_config.frequency),e.push("")),e}function Ne(l){const e=[];if(l&&l.pins&&l.pins.spi){e.push("spi:");const i=l.pins.spi;i.id?e.push(`  - id: ${i.id}`):e.push("  - id: spi_bus"),e.push(`    clk_pin: ${i.clk}`),i.mosi&&e.push(`    mosi_pin: ${i.mosi}`),i.miso&&e.push(`    miso_pin: ${i.miso}`),i.type==="quad"&&(e.push("    interface: triple"),i.data_pins&&e.push(`    data_pins: [${i.data_pins.join(", ")}]`)),e.push(""),l.extra_spi&&(e.push(...l.extra_spi),e.push(""))}return e}function $e(l,e="landscape"){const i=[];if(!l)return i;const o=l.resolution||{width:800,height:480},t=o.height>o.width,n=e==="portrait";let s=0;if(t?s=n?0:90:s=n?90:0,l.rotation_offset&&(s=(s+l.rotation_offset)%360),l.display_config)i.push("display:"),i.push(...l.display_config),i.push("");else{i.push("display:"),i.push(`  - platform: ${l.displayPlatform}`),i.push("    id: epaper_display");const d=l.pins&&l.pins.display?l.pins.display:null;if(d){const a=(u,m)=>{m&&(typeof m=="object"?(i.push(`    ${u}:`),i.push(`      number: ${m.number}`),m.inverted!==void 0&&i.push(`      inverted: ${m.inverted}`)):i.push(`    ${u}: ${m}`))};a("cs_pin",d.cs),a("dc_pin",d.dc),a("reset_pin",d.reset),a("busy_pin",d.busy)}if(i.push(`    rotation: ${s}`),l.displayModel==="M5Paper"||l.displayPlatform==="it8951e")i.push("    reversed: false"),i.push("    reset_duration: 100ms");else if(l.displayModel){let a=`    model: "${l.displayModel}"`;l.displayModel==="Seeed-reTerminal-E1002"&&(a+=" #Please update your ESPHome version to 2025.11.1 above"),i.push(a)}i.push("    update_interval: never");const c=["1.54in","1.54inv2","2.13in","2.13in-ttgo","2.13in-ttgo-b1","2.13in-ttgo-b73","2.13in-ttgo-b74","2.13in-ttgo-dke","2.13inv2","2.13inv3","2.90in","2.90in-dke","2.90inv2","2.90inv2-r2","7.50inv2","7.50inv2p","gdew029t5","gdey029t94","gdey042t81","gdey0583t81"];l.displayModel&&c.includes(l.displayModel)&&i.push("    full_update_every: 30"),i.push("")}const r=l.display_config?"my_display":"epaper_display";return i.push(...ls(l,r,s)),i}function He(l,e=[],i="my_display",o=[]){const t=[];if(!l)return t;const n=l.pins||{},s=n.batteryAdc,r=l.features&&l.features.sht4x,d=l.features&&l.features.shtc3,c=e.length>0;if(!s&&!r&&!d&&!c)return t;if(t.push("sensor:"),s&&(t.push("  - platform: adc"),t.push(`    pin: ${n.batteryAdc}`),t.push('    name: "Battery Voltage"'),t.push('    unit_of_measurement: "V"'),t.push("    device_class: voltage"),t.push("    state_class: measurement"),t.push("    id: battery_voltage"),t.push("    update_interval: 60s"),t.push("    attenuation: "+l.battery.attenuation),t.push("    filters:"),t.push("      - multiply: "+l.battery.multiplier)),r&&(t.push("  - platform: sht4x"),t.push("    id: sht4x_sensor"),t.push("    temperature:"),t.push('      name: "Temperature"'),t.push("      id: sht4x_temperature"),t.push("    humidity:"),t.push('      name: "Humidity"'),t.push("      id: sht4x_humidity"),t.push("    address: 0x44"),t.push("    update_interval: 60s")),(l.features.sht3xd||l.displayModel==="M5Paper"||l.name&&l.name.includes("M5Paper"))&&(t.push("  - platform: sht3xd"),t.push("    address: 0x44"),t.push("    temperature:"),t.push('      name: "Temperature"'),t.push("      id: sht3x_temperature"),t.push("    humidity:"),t.push('      name: "Humidity"'),t.push("      id: sht3x_humidity"),t.push("    update_interval: 60s")),d&&(t.push("  - platform: shtcx"),t.push("    id: shtc3_sensor"),t.push("    i2c_id: bus_a"),t.push("    address: 0x70"),t.push("    temperature:"),t.push('      name: "Temperature"'),t.push("      id: shtc3_temperature"),t.push("    humidity:"),t.push('      name: "Humidity"'),t.push("      id: shtc3_humidity"),t.push("    update_interval: 60s")),e.length>0&&t.push(...e),s)if(t.push(""),t.push("  - platform: template"),t.push('    name: "Battery Level"'),t.push("    id: battery_level"),t.push('    unit_of_measurement: "%"'),t.push('    icon: "mdi:battery"'),t.push("    device_class: battery"),t.push("    state_class: measurement"),l.battery.curve)t.push("    lambda: 'return id(battery_voltage).state;'"),t.push("    update_interval: 60s"),t.push("    filters:"),t.push("      - calibrate_linear:"),l.battery.curve.forEach(a=>{t.push(`          - ${a.from} -> ${a.to}`)}),t.push("      - clamp:"),t.push("          min_value: 0"),t.push("          max_value: 100");else{const a=l.battery.calibration?l.battery.calibration.min:3.27,u=l.battery.calibration?l.battery.calibration.max:4.15;t.push("    lambda: |-"),t.push(`      if (id(battery_voltage).state > ${u}) return 100;`),t.push(`      if (id(battery_voltage).state < ${a}) return 0;`),t.push(`      return (id(battery_voltage).state - ${a}) / (${u} - ${a}) * 100.0;`)}return t.push(""),t}function Fe(l,e,i="my_display",o=[]){const t=[],n=l&&l.features&&l.features.buttons,s=o.length>0;if(!n&&!s)return t;if(t.push("binary_sensor:"),n){const r=l.name&&l.name.includes("CoreInk"),d=l.pins.buttons||{};if(d.left&&(t.push("  - platform: gpio"),t.push("    pin:"),typeof d.left=="object"?(t.push(`      number: ${d.left.number}`),t.push(`      mode: ${d.left.mode||"INPUT_PULLUP"}`),t.push(`      inverted: ${d.left.inverted!==void 0?d.left.inverted:!0}`)):(t.push(`      number: ${d.left}`),t.push("      mode: INPUT_PULLUP"),t.push("      inverted: true")),t.push('    name: "Left Button"'),t.push("    id: button_left"),t.push("    on_press:"),t.push("      then:"),r?(t.push("        - script.execute:"),t.push("            id: change_page_to"),t.push(`            target_page: !lambda 'return id(display_page) > 0 ? id(display_page) - 1 : ${e-1};'`),t.push("        - script.stop: activity_timer"),t.push("        - script.execute: activity_timer")):(t.push("        - script.execute:"),t.push("            id: change_page_to"),t.push(`            target_page: !lambda 'return id(display_page) > 0 ? id(display_page) - 1 : ${e-1};'`))),d.right&&(t.push("  - platform: gpio"),t.push("    pin:"),typeof d.right=="object"?(t.push(`      number: ${d.right.number}`),t.push(`      mode: ${d.right.mode||"INPUT_PULLUP"}`),t.push(`      inverted: ${d.right.inverted!==void 0?d.right.inverted:!0}`)):(t.push(`      number: ${d.right}`),t.push("      mode: INPUT_PULLUP"),t.push("      inverted: true")),t.push('    name: "Right Button"'),t.push("    id: button_right"),t.push("    on_press:"),t.push("      then:"),r?(t.push("        - script.execute:"),t.push("            id: change_page_to"),t.push(`            target_page: !lambda 'return id(display_page) < ${e-1} ? id(display_page) + 1 : 0;'`),t.push("        - script.stop: activity_timer"),t.push("        - script.execute: activity_timer")):(t.push("        - script.execute:"),t.push("            id: change_page_to"),t.push(`            target_page: !lambda 'return id(display_page) < ${e-1} ? id(display_page) + 1 : 0;'`))),d.refresh){t.push("  - platform: gpio"),t.push("    pin:"),typeof d.refresh=="object"?(t.push(`      number: ${d.refresh.number}`),t.push(`      mode: ${d.refresh.mode||"INPUT_PULLUP"}`),t.push(`      inverted: ${d.refresh.inverted!==void 0?d.refresh.inverted:!0}`)):(t.push(`      number: ${d.refresh}`),t.push("      mode: INPUT_PULLUP"),t.push("      inverted: true"));const c=r?"Enter Button":"Refresh Button",a=r?"button_enter":"button_refresh";t.push(`    name: "${c}"`),t.push(`    id: ${a}`),t.push("    on_press:"),t.push("      then:"),t.push(`        - component.update: ${i}`),r&&(t.push("        - script.stop: activity_timer"),t.push("        - script.execute: activity_timer"))}}return s&&(t.push("  # Touch Area Binary Sensors"),o.forEach(r=>{const d=(r.type||"").toLowerCase(),c=r.props||{};if(d==="template_nav_bar"){const a=c.show_prev!==!1,u=c.show_home!==!1,m=c.show_next!==!1;let g=0;if(a&&g++,u&&g++,m&&g++,g>0){const f=Math.floor(r.width/g);let v=0;const b=(E,y)=>{const S=r.x+v*f,T=S+f,R=r.y,B=r.y+r.height;t.push("  - platform: touchscreen"),t.push(`    id: nav_${E}_${r.id}`),t.push("    touchscreen_id: my_touchscreen"),t.push(`    x_min: ${S}`),t.push(`    x_max: ${T}`),t.push(`    y_min: ${R}`),t.push(`    y_max: ${B}`),t.push("    on_press:");const k=r._pageIndex!==void 0?r._pageIndex:0;t.push("      - if:"),t.push("          condition:"),t.push(`            lambda: 'return id(display_page) == ${k};'`),t.push("          then:"),E==="prev"?(t.push("            - script.execute:"),t.push("                id: change_page_to"),t.push("                target_page: !lambda 'return id(display_page) - 1;'")):E==="home"?t.push("            - script.execute: manage_run_and_sleep"):E==="next"&&(t.push("            - script.execute:"),t.push("                id: change_page_to"),t.push("                target_page: !lambda 'return id(display_page) + 1;'")),v++};a&&b("prev"),u&&b("home"),m&&b("next")}}else{const a=(r.entity_id||`touch_area_${r.id}`).replace(/[^a-zA-Z0-9_]/g,"_"),u=parseInt(String(c.icon_size||40),10),m=Math.max(r.width,u),g=Math.max(r.height,u);let f=r.x-Math.floor((m-r.width)/2),v=f+m,b=r.y-Math.floor((g-r.height)/2),E=b+g;f=Math.max(0,f),b=Math.max(0,b);const y=c.nav_action||"none",S=r._pageIndex!==void 0?r._pageIndex:0;t.push("  - platform: touchscreen"),t.push(`    id: ${a}`),t.push("    touchscreen_id: my_touchscreen"),t.push(`    x_min: ${f}`),t.push(`    x_max: ${v}`),t.push(`    y_min: ${b}`),t.push(`    y_max: ${E}`),(y!=="none"||r.entity_id)&&(t.push("    on_press:"),t.push("      - if:"),t.push("          condition:"),t.push(`            lambda: 'return id(display_page) == ${S};'`),t.push("          then:"),y==="next_page"?(t.push("            - script.execute:"),t.push("                id: change_page_to"),t.push("                target_page: !lambda 'return id(display_page) + 1;'")):y==="previous_page"?(t.push("            - script.execute:"),t.push("                id: change_page_to"),t.push("                target_page: !lambda 'return id(display_page) - 1;'")):y==="reload_page"?t.push("            - script.execute: manage_run_and_sleep"):r.entity_id&&(t.push("            - homeassistant.service:"),t.push("                service: homeassistant.toggle"),t.push("                data:"),t.push(`                  entity_id: ${r.entity_id}`)))}})),t.push(""),t}function ze(l,e,i="my_display"){const o=[];o.push("button:"),o.push("  - platform: template"),o.push('    name: "Next Page"'),o.push("    on_press:"),o.push("      then:"),o.push("        - script.execute:"),o.push("            id: change_page_to"),o.push("            target_page: !lambda 'return id(display_page) + 1;'"),o.push("  - platform: template"),o.push('    name: "Previous Page"'),o.push("    on_press:"),o.push("      then:"),o.push("        - script.execute:"),o.push("            id: change_page_to"),o.push("            target_page: !lambda 'return id(display_page) - 1;'"),o.push("  - platform: template"),o.push('    name: "Refresh Display"'),o.push("    on_press:"),o.push("      then:"),o.push(`        - component.update: ${i}`);for(let t=0;t<e;t++)o.push("  - platform: template"),o.push(`    name: "Go to Page ${t+1}"`),o.push("    on_press:"),o.push("      then:"),o.push("        - script.execute:"),o.push("            id: change_page_to"),o.push(`            target_page: ${t}`);return l.features&&l.features.buzzer&&(o.push("  # Buzzer Sounds"),o.push("  - platform: template"),o.push('    name: "Play Beep Short"'),o.push('    icon: "mdi:bell-ring"'),o.push("    on_press:"),o.push('      - rtttl.play: "beep:d=32,o=5,b=200:16e6"'),o.push(""),o.push("  - platform: template"),o.push('    name: "Play Beep OK"'),o.push('    icon: "mdi:check-circle-outline"'),o.push("    on_press:"),o.push('      - rtttl.play: "ok:d=16,o=5,b=200:e6"'),o.push(""),o.push("  - platform: template"),o.push('    name: "Play Beep Error"'),o.push('    icon: "mdi:alert-circle-outline"'),o.push("    on_press:"),o.push('      - rtttl.play: "error:d=16,o=5,b=200:c6"'),o.push(""),o.push("  - platform: template"),o.push('    name: "Play Star Wars"'),o.push('    icon: "mdi:music-note"'),o.push("    on_press:"),o.push('      - rtttl.play: "StarWars:d=4,o=5,b=45:32p,32f,32f,32f,8a#.,8f.6,32d#,32d,32c,8a#.6,4f.6,32d#,32d,32c,8a#.6,4f.6,32d#,32d,32d#,8c6"')),o.push(""),o}function Ge(l){return l.features&&l.features.psram||l.features&&l.features.features&&l.features.features.psram?l.psram_mode?["psram:",`  mode: ${l.psram_mode}`,"  speed: 80MHz",""]:["psram:",""]:[]}function je(l){return!l.features||!l.features.axp2101||l.features.manual_pmic?[]:["axp2101:","  i2c_id: bus_a","  address: 0x34","  irq_pin: GPIO21","  battery_voltage:",'    name: "Battery Voltage"',"    id: battery_voltage","  battery_level:",'    name: "Battery Level"',"    id: battery_level","  on_setup:","    - axp2101.set_ldo_voltage:","        id: bldo1","        voltage: 3300mv","    - switch.turn_on: bldo1  # EPD_VCC (Screen Power)","    - axp2101.set_ldo_voltage:","        id: aldo1","        voltage: 3300mv","    - switch.turn_on: aldo1  # Peripherals","    - axp2101.set_ldo_voltage:","        id: aldo3","        voltage: 3300mv","    - switch.turn_on: aldo3  # Backlight/Logic",""]}function Ue(l){const e=[];return!l||!l.pins||!l.pins.batteryEnable&&!l.pins.buzzer||(e.push("output:"),l.pins.batteryEnable&&(e.push("  - platform: gpio"),typeof l.pins.batteryEnable=="object"?(e.push("    pin:"),e.push(`      number: ${l.pins.batteryEnable.number}`),l.pins.batteryEnable.ignore_strapping_warning&&e.push("      ignore_strapping_warning: true"),l.pins.batteryEnable.inverted!==void 0&&e.push(`      inverted: ${l.pins.batteryEnable.inverted}`)):e.push(`    pin: ${l.pins.batteryEnable}`),e.push("    id: bsp_battery_enable")),l.pins.buzzer&&(l.pins.batteryEnable&&e.push(""),e.push("  - platform: ledc"),e.push(`    pin: ${l.pins.buzzer}`),e.push("    id: buzzer_output")),e.push("")),e}function Ye(l){return!l.features||!l.features.buzzer?[]:["rtttl:","  id: reterminal_buzzer","  output: buzzer_output",""]}function Ve(l){if(!l||!l.audio)return[];const e=[];return l.audio.i2s_audio&&(e.push("i2s_audio:"),e.push(`  i2s_lrclk_pin: ${l.audio.i2s_audio.i2s_lrclk_pin}`),e.push(`  i2s_bclk_pin: ${l.audio.i2s_audio.i2s_bclk_pin}`),l.audio.i2s_audio.i2s_mclk_pin&&e.push(`  i2s_mclk_pin: ${l.audio.i2s_audio.i2s_mclk_pin}`),e.push("")),l.audio.speaker&&(e.push("speaker:"),e.push(`  - platform: ${l.audio.speaker.platform}`),e.push("    id: my_speaker"),l.audio.speaker.dac_type&&e.push(`    dac_type: ${l.audio.speaker.dac_type}`),l.audio.speaker.i2s_dout_pin&&e.push(`    i2s_dout_pin: ${l.audio.speaker.i2s_dout_pin}`),l.audio.speaker.mode&&e.push(`    mode: ${l.audio.speaker.mode}`),e.push("")),e}function be(l,e){const i=[],o=F?F[e]||{}:{};i.push("# ============================================================================"),i.push("# LVGL Configuration"),i.push("# ============================================================================"),i.push(""),i.push("lvgl:"),i.push("  id: my_lvgl"),i.push("  log_level: WARN"),i.push('  bg_color: "0xFFFFFF"'),i.push("  displays:");const t=o.features?.lcd?"my_display":"epaper_display";return i.push(`    - ${t}`),o.touch&&(i.push("  touchscreens:"),i.push("    - my_touchscreen")),i.push(""),i.push("  pages:"),l.forEach((n,s)=>{i.push(`    - id: page_${s}`),n.layout&&/^\d+x\d+$/.test(n.layout)&&i.push(`      layout: ${n.layout}`),i.push("      widgets:");const r=n.widgets||[];if(r.length===0){i.push("        []");return}r.filter(d=>d.type!=="group").forEach(d=>{i.push(`        ${Se(d)}`);const c=ds(d,o);if(c){const a=Object.keys(c)[0],u=c[a];i.push(`        - ${a}:`),gt(u,i,12)}})}),i}function gt(l,e,i){const o=" ".repeat(i);Object.entries(l).forEach(([t,n])=>{if(!(n==null||n===""))if(Array.isArray(n))n.length===0?e.push(`${o}${t}: []`):(e.push(`${o}${t}:`),n.forEach(s=>{typeof s=="object"?(e.push(`${o}  -`),gt(s,e,i+4)):e.push(`${o}  - ${s}`)}));else if(typeof n=="object")e.push(`${o}${t}:`),gt(n,e,i+2);else if(typeof n=="string"&&n.includes(`
`)){const s=n.split(`
`);e.push(`${o}${t}: ${s[0]}`);for(let r=1;r<s.length;r++)e.push(`${o}${s[r]}`)}else e.push(`${o}${t}: ${n}`)})}function Se(l){const e=[`# widget:${l.type}`];e.push(`id:${l.id}`),e.push(`type:${l.type}`),e.push(`x:${Math.round(l.x)}`),e.push(`y:${Math.round(l.y)}`);const i=l.w!==void 0?l.w:l.width!==void 0?l.width:0,o=l.h!==void 0?l.h:l.height!==void 0?l.height:0;return e.push(`w:${Math.round(i)}`),e.push(`h:${Math.round(o)}`),l.entity_id&&e.push(`entity:${l.entity_id}`),l.props&&Object.entries(l.props).forEach(([t,n])=>{if(!(n==null||n==="")&&!(t==="id"||t==="type"||t==="x"||t==="y"||t==="w"||t==="h"||t==="entity_id"))if(typeof n=="object")try{e.push(`${t}:${JSON.stringify(n)}`)}catch(s){_.warn(`[serializeWidget] Failed to serialize prop ${t}`,s)}else e.push(`${t}:${n}`)}),e.join(" ")}function ds(l,e){const i=l.props||{};e?.touch||e?.features&&e.features.touch;const o=Math.round(l.x||0),t=Math.round(l.y||0),n=Math.round(l.w||l.width||100),s=Math.round(l.h||l.height||100),r={id:l.id,x:o,y:t,width:n,height:s,hidden:i.hidden||void 0,clickable:i.clickable===!1?!1:void 0,checkable:i.checkable||void 0,scrollable:i.scrollable===!1?!1:void 0,floating:i.floating||void 0,ignore_layout:i.ignore_layout||void 0,scrollbar_mode:i.scrollbar_mode!=="AUTO"?i.scrollbar_mode:void 0},d=window.PluginRegistry;if(d){const g=d.get(l.type);if(g&&typeof g.exportLVGL=="function")return g.exportLVGL(l,{profile:e,common:r,convertColor:c,convertAlign:a,getLVGLFont:u,formatOpacity:m})}if(l.type&&(l.type.startsWith("lvgl_")||l.type.startsWith("shape_")||l.type==="rounded_rect"||l.type==="line"||l.type==="text"||l.type==="progress_bar"||l.type==="qr_code"))return _.warn(`[transpileToLVGL] Widget type ${l.type} has no exportLVGL function. Falling back to generic obj.`),{obj:{...r,bg_color:c(i.bg_color||i.color||"white")}};return null;function c(g){return!g||g==="transparent"?'"0x000000"':g.startsWith("#")?'"0x'+g.substring(1).toUpperCase()+'"':`"${g}"`}function a(g){return g?{left:"TOP_LEFT",center:"CENTER",right:"TOP_RIGHT"}[g.toLowerCase()]||g:"TOP_LEFT"}function u(g,f,v,b){return`font_${(g||"Roboto").toLowerCase().replace(/\s+/g,"_")}_${v||400}_${f||20}${b?"_italic":""}`}function m(g){return g==null?"COVER":typeof g=="number"?g>=255?"COVER":g<=0?"TRANSP":Math.round(g/255*100)+"%":g}}class ai{constructor(){this.reset(),this.EXTENDED_GLYPHS=[...Array.from({length:95},(e,i)=>`\\U000000${(i+32).toString(16).padStart(2,"0")}`),"\\U000000B0","\\U000000B1","\\U000000B2","\\U000000B3","\\U000000B5","\\U000000A3","\\U000000A5","\\U000000A9","\\U000000AE","\\U000000D7","\\U000000F7","\\U000003BC","\\U000003A9","\\U000020AC","\\U00002122"]}reset(){this.definedFontIds=new Set,this.fontLines=[],this.iconCodesBySize=new Map}addFont(e,i,o,t=!1){const n=e.replace(/\s+/g,"_").toLowerCase(),s=parseInt(i)||400,d=`font_${n}_${s}_${o}${t?"_italic":""}`;if(this.definedFontIds.has(d))return d;if(this.definedFontIds.add(d),e!=="Material Design Icons"){const c={id:d,file:{type:"gfonts",family:e,weight:s,italic:t},size:o,glyphs:[...this.EXTENDED_GLYPHS]};this.fontLines.push(c)}return d}trackIcon(e,i){if(!e)return;const o=parseInt(i,10);this.iconCodesBySize.has(o)||this.iconCodesBySize.set(o,new Set);let t=e;/^F[0-9A-F]{4}$/i.test(e)?t=e.toUpperCase():t=window.Utils?window.Utils.getIconCode(e):null,t&&this.iconCodesBySize.get(o).add(t)}getLines(){this.definedFontIds.size===0&&this.addFont("Roboto",400,20);const e=["font:"];this.fontLines.forEach(i=>{e.push("  - file:"),e.push(`      type: ${i.file.type}`),e.push(`      family: "${i.file.family}"`),e.push(`      weight: ${i.file.weight}`),i.file.italic&&e.push("      italic: true"),e.push(`    id: ${i.id}`),e.push(`    size: ${i.size}`);const o=i.glyphs.map(t=>`"${t}"`).join(", ");e.push(`    glyphs: [${o}]`)});for(const[i,o]of this.iconCodesBySize.entries()){const t=`font_material_design_icons_400_${i}`;e.push('  - file: "fonts/materialdesignicons-webfont.ttf"'),e.push(`    id: ${t}`),e.push(`    size: ${i}`);const n=Array.from(o).sort().map(s=>`"\\U000${s}"`).join(", ");e.push(`    glyphs: [${n}]`)}return e.length>1?e:[]}}class li{generateInstructionHeader(e,i){const o=[];o.push("# ============================================================================"),o.push("# ESPHome YAML - Generated by ESPHome Designer"),o.push("# ============================================================================"),o.push(`# TARGET DEVICE: ${e.name||"Unknown"}`);const t=window.AppState?window.AppState.getCanvasDimensions():{width:800,height:480};o.push(`# Resolution: ${t.width}x${t.height}`),o.push(`# Shape: ${window.AppState?window.AppState.getCanvasShape():"rect"}`),o.push("#");const n=e.features||{},s=e.displayPlatform||(n.lcd?e.id==="reterminal_e1001"?"reterminal_e1001":"LCD":n.epaper?"waveshare_epaper":"Unknown");o.push(`#         - Display Platform: ${s}`),o.push(`#         - PSRAM: ${n.psram?"Yes":"No"}`),o.push(`#         - Battery: ${e.battery?"Yes":"No"}`),o.push(`#         - Buttons: ${n.buttons?"Yes":"No"}`),o.push(`#         - Buzzer: ${n.buzzer?"Yes":"No"}`),n.audio&&o.push("#         - Audio: Yes"),o.push("# ============================================================================"),o.push("#"),o.push("# SETUP INSTRUCTIONS:"),o.push("#"),o.push("# STEP 1: Copy the Material Design Icons font file"),o.push("#         - From this repo: font_ttf/font_ttf/materialdesignicons-webfont.ttf"),o.push("#         - To ESPHome: /config/esphome/fonts/materialdesignicons-webfont.ttf"),o.push("#         (Create the fonts folder if it doesn't exist)"),o.push("#"),o.push("# STEP 2: Create a new device in ESPHome"),o.push('#         - Click "New Device"'),o.push("#         - Name: your-device-name"),o.push("#         - Select: ESP32-S3 (or appropriate for your board)"),o.push("#         - Board: esp32-s3-devkitc-1"),o.push("#         - Framework: esp-idf"),o.push("#           (TIP: For ESPHome 2025.12+, set version: 5.4.2 to avoid build errors)"),o.push("#"),o.push("# ============================================================================"),o.push(""),o.push("# ============================================================================"),o.push("# STEP 3: Add the on_boot sequence"),o.push("# Paste the following into your 'esphome:' section."),o.push("# (TIP: If compiling fails with 'OOM', add 'compile_process_limit: 1' to 'esphome:')"),o.push("# ============================================================================"),o.push("# esphome:"),o.push("#   on_boot:"),o.push("#     priority: 600"),o.push("#     then:"),i.pages&&i.pages.length>0&&(o.push("#       - lambda: |-"),o.push(`#           if (id(display_page) >= ${i.pages.length}) {`),o.push('#             ESP_LOGW("display", "Restored page index %d is out of bounds (max %d). Resetting to 0.", id(display_page), '+(i.pages.length-1)+");"),o.push("#             id(display_page) = 0;"),o.push("#           }")),e.battery&&e.pins&&e.pins.batteryEnable&&o.push("#       - output.turn_on: bsp_battery_enable"),o.push("#       - delay: 2s  # Wait for Home Assistant API connection"),o.push("#       - script.execute: manage_run_and_sleep"),i.autoCycleEnabled&&o.push("#       - script.execute: auto_cycle_timer"),o.push("#"),o.push(""),o.push("# ===================================="),o.push("# Device Settings"),o.push("# ===================================="),o.push(`# Orientation: ${i.orientation||"landscape"}`),o.push(`# Dark Mode: ${i.darkMode?"enabled":"disabled"}`),o.push(`# Refresh Interval: ${i.refreshInterval||600}`);const r=!!(e.features&&(e.features.lcd||e.features.oled));let d;if(r){const c=i.lcdEcoStrategy||"backlight_off";d={always_on:"Always On",backlight_off:"Backlight Off Schedule",halt_updates:"Halt Updates",deep_sleep:"Deep Sleep"}[c]||c}else d=i.deepSleepEnabled?"Ultra Eco (Deep Sleep)":i.sleepEnabled?"Eco (Light Sleep)":"Always On";return o.push(`# Power Strategy: ${d}`),o.push(`# Deep Sleep Interval: ${i.deepSleepInterval||600}`),o.push("# ===================================="),o.push(""),o}generateScriptSection(e,i,o){const t=[],n=o.features?.lcd?"my_display":"epaper_display",s=e.autoCycleEnabled&&i.length>1,r=!!(o.features&&(o.features.lcd||o.features.oled)),d=r?500:3e3;if(t.push("script:"),t.push("  - id: change_page_to"),t.push("    parameters:"),t.push("      target_page: int"),t.push("    then:"),t.push("      - lambda: |-"),t.push(`          int pages_count = ${i.length};`),t.push("          int target = target_page;"),t.push("          while (target < 0) target += pages_count;"),t.push("          target %= pages_count;"),t.push(""),t.push(`          // Debounce: Ignore page changes within ${d}ms of last change`),t.push(`          // (adjusted for ${r?"LCD":"e-paper"} display update time)`),t.push("          uint32_t now = millis();"),t.push(`          if (now - id(last_page_switch_time) < ${d}) {`),t.push('            ESP_LOGD("display", "Page change ignored (debounce), last switch was %d ms ago", now - id(last_page_switch_time));'),t.push("            return;"),t.push("          }"),t.push(""),t.push("          if (id(display_page) != target) {"),t.push("            // Set debounce time BEFORE display update (update takes ~1.6s)"),t.push("            id(last_page_switch_time) = now;"),t.push("            id(display_page) = target;"),t.push(`            id(${n}).update();`),t.push('            ESP_LOGI("display", "Switched to page %d", target);'),t.push("            // Restart refresh logic"),t.push("            if (id(manage_run_and_sleep).is_running()) id(manage_run_and_sleep).stop();"),t.push("            id(manage_run_and_sleep).execute();"),t.push("          }"),t.push("  - id: manage_run_and_sleep","    mode: restart","    then:"),t.push('      - logger.log: "Waiting for sync..."'),t.push("      - wait_until:"),t.push("          condition:"),t.push("            lambda: 'return id(ha_time).now().is_valid() && api_is_connected();'"),t.push("          timeout: 60s"),t.push("      - delay: 5s"),t.push("      - lambda: 'id(page_refresh_current_s) = id(page_refresh_default_s);'"),t.push(`      - component.update: ${n}`),t.push("      - delay: !lambda 'return id(page_refresh_current_s) * 1000;'"),t.push("      - script.execute: manage_run_and_sleep"),s){const c=e.autoCycleIntervalS||30;t.push("  - id: auto_cycle_timer","    mode: restart","    then:"),t.push(`      - delay: ${c}s`),t.push("      - script.execute:"),t.push("          id: change_page_to"),t.push("          target_page: !lambda 'return id(display_page) + 1;'"),t.push("      - script.execute: auto_cycle_timer")}return t}}let cs=class extends Ce{constructor(){super(),this.fonts=new ai,this.yaml=new li,this.reset()}reset(){this.fonts&&this.fonts.reset(),this.usedPlugins=new Set}async generate(e){if(!e)return console.error("ESPHomeAdapter: Missing layout"),"";this.reset();const i=e.pages||[],o=e.deviceModel||(h?h.deviceModel:null)||window.currentDeviceModel||"reterminal_e1001",t=F||{},n=window.DEVICE_PROFILES||{};let r={...t,...n}[o]||{};if(o==="custom"&&e.customHardware){const y=e.customHardware;r={id:"custom",name:"Custom Device",chip:y.chip||"esp32-s3",displayPlatform:y.displayDriver||"generic_st7789",resolution:{width:y.resWidth||800,height:y.resHeight||480},shape:y.shape||"rect",pins:{i2c:y.pins?.sda?{sda:y.pins.sda,scl:y.pins.scl}:null,spi:y.pins?.clk?{clk:y.pins.clk,mosi:y.pins.mosi}:null,display:{cs:y.pins?.cs,dc:y.pins?.dc,reset:y.pins?.rst,busy:y.pins?.busy}},features:{psram:!!y.psram,lcd:y.tech==="lcd",epaper:y.tech==="epaper",touch:y.touchTech&&y.touchTech!=="none"},backlight:y.pins?.backlight?{platform:"gpio",pin:y.pins.backlight}:null,touch:y.touchTech&&y.touchTech!=="none"?{platform:y.touchTech,sda:y.pins?.sda,scl:y.pins?.scl,interrupt_pin:y.pins?.touch_int,reset_pin:y.pins?.touch_rst}:null}}let d=!!(r.features&&(r.features.lvgl||r.features.lv_display));const c=e.renderingMode||(h?h.settings?.renderingMode:null);if(c==="direct"?(d=!1,_.log("[ESPHomeAdapter] Rendering mode set to 'direct', skipping LVGL generation")):c==="lvgl"&&(d=!0,_.log("[ESPHomeAdapter] Rendering mode set to 'lvgl', forcing LVGL generation")),!d)for(const y of i){if(y.widgets){for(const S of y.widgets.filter(T=>!T.hidden))if(S.type.startsWith("lvgl_")){d=!0;break}}if(d)break}const a=[];r.isPackageBased||(a.push(...this.yaml.generateInstructionHeader(r,e)),a.push(""));const u=r.features?.lcd?"my_display":"epaper_display";this.fonts.addFont("Roboto",400,20),this.preProcessWidgetsPromise=this.preProcessWidgets(i),await this.preProcessWidgetsPromise;let m=null;r.isPackageBased&&(r.isOfflineImport&&r.content?m=r.content:r.hardwarePackage&&(m=await this.fetchHardwarePackage(r.hardwarePackage)));const g=[];i.forEach((y,S)=>{y.widgets&&y.widgets.forEach(T=>{T.hidden||(T._pageIndex=S,g.push(T))})});const f={widgets:g,profile:r,displayId:u,adapter:this,isLvgl:d};if(Y){const y=[];y.push("- id: display_page","  type: int","  restore_value: true","  initial_value: '0'");const S=!!(r.features&&r.features.epaper),T=!!(r.features&&r.features.lcd)||!S,R=e.refreshInterval||(T?60:e.deepSleepInterval||600);y.push("- id: page_refresh_default_s","  type: int","  restore_value: true",`  initial_value: '${R}'`),y.push("- id: page_refresh_current_s","  type: int","  restore_value: false","  initial_value: '60'"),y.push("- id: last_page_switch_time","  type: uint32_t","  restore_value: false","  initial_value: '0'"),Y.onExportGlobals({...f,lines:y}),y.length>0&&(a.push("globals:"),a.push(...y.map(w=>"  "+w))),!r.isPackageBased&&Ge&&a.push(...Ge(r)),r.isPackageBased?a.some(C=>String(C).split(`
`).some(P=>P.trim()==="time:"))||a.push("time:","  - platform: homeassistant","    id: ha_time"):(a.push("http_request:","  verify_ssl: false","  timeout: 20s"),We&&a.push(...We(r)),Ne&&a.push(...Ne(r)),Oe&&a.push(...Oe(r)),je&&a.push(...je(r)),Ue&&a.push(...Ue(r)),De&&a.push(...De(r)),Ye&&a.push(...Ye(r)),Ve&&a.push(...Ve(r)),a.some(C=>String(C).split(`
`).some(P=>P.trim()==="time:"))||a.push("time:","  - platform: homeassistant","    id: ha_time")),He&&a.push(...He(r,[],u,g));const B=[];Y.onExportNumericSensors({...f,lines:B,mainLines:a}),B.length>0&&(a.some(w=>w==="sensor:")||a.push("sensor:"),a.push(...B.flatMap(w=>w.split(`
`).map(C=>"  "+C))));const k=i.flatMap(w=>w.widgets||[]),I=new Set,L=[];B.forEach(w=>{if(w.includes("entity_id:")){const C=w.match(/entity_id:\s*(.+)/);C&&I.add(C[1].trim())}}),k.forEach(w=>{let C=(w.entity_id||"").trim();const P=w.props||{};if(!C||P.is_local_sensor)return;["progress_bar","sensor_text","graph","battery_icon","wifi_signal","ondevice_temperature","ondevice_humidity"].includes(w.type)&&!C.includes(".")&&(C=`sensor.${C}`);const ee=C.includes(".")&&!C.startsWith("weather.")&&!C.startsWith("text_sensor.")&&!C.startsWith("binary_sensor."),O=["switch.","light.","fan.","input_boolean.","cover.","lock."].some(z=>C.startsWith(z));if(ee&&!O&&!I.has(C)){I.add(C);const z=C.replace(/[^a-zA-Z0-9_]/g,"_");L.push("- platform: homeassistant"),L.push(`  id: ${z}`),L.push(`  entity_id: ${C}`),L.push("  internal: true")}}),L.length>0&&(a.some(w=>w==="sensor:")||a.push("sensor:"),a.push(...L.flatMap(w=>w.split(`
`).map(C=>"  "+C))));const H=[];Y.onExportTextSensors({...f,lines:H}),H.length>0&&(a.push("text_sensor:"),a.push(...H.flatMap(w=>w.split(`
`).map(C=>"  "+C))));const N=[];if(!r.isPackageBased&&Fe){const w=Fe(r,i.length,u,[]);w.length>0&&w[0].trim()==="binary_sensor:"?N.push(...w.slice(1).map(C=>C.startsWith("  ")?C.slice(2):C)):N.push(...w)}Y.onExportBinarySensors({...f,lines:N}),N.length>0&&(a.push("binary_sensor:"),a.push(...N.flatMap(w=>w.split(`
`).map(C=>"  "+C))));const $=i.flatMap(w=>w.widgets||[]),M=new Set,X=["binary_sensor.","switch.","light.","input_boolean.","fan.","cover.","vacuum.","lock."],K=[];if(N.forEach(w=>{if(w.includes("entity_id:")){const C=w.match(/entity_id:\s*(.+)/);C&&M.add(C[1].trim())}}),$.forEach(w=>{const C=(w.condition_entity||"").trim(),P=(w.entity_id||"").trim();[C,P].forEach(x=>{if(!x)return;if(X.some(U=>x.startsWith(U))&&!M.has(x)){M.add(x);const U=x.replace(/[^a-zA-Z0-9_]/g,"_");K.push("- platform: homeassistant"),K.push(`  id: ${U}`),K.push(`  entity_id: ${x}`),K.push("  internal: true")}})}),K.length>0&&(a.some(w=>w==="binary_sensor:")||a.push("binary_sensor:"),a.push(...K.flatMap(w=>w.split(`
`).map(C=>"  "+C)))),!r.isPackageBased&&ze){const w=ze(r,i.length,u);w.length>0&&a.push(...w)}const j=Y.getAll(),p=["image","online_image","graph","qr_code"];j.sort((w,C)=>{const P=p.indexOf(w.id),x=p.indexOf(C.id);return P!==-1&&x!==-1?P-x:P!==-1?-1:x!==-1?1:w.id.localeCompare(C.id)}),j.forEach(w=>w.onExportComponents&&w.onExportComponents({...f,lines:a}))}const v=this.generateDisplayLambda(i,e,r);a.push(...this.fonts.getLines());const b=this.yaml.generateScriptSection(e,i,r);if(b.length>0&&a.push(...b),d&&be){const y=be(i,o);y&&y.length>0&&a.push(...y)}const E=d&&be;if(r.isPackageBased){if(m){const y=/^(\s*)# __LAMBDA_PLACEHOLDER__/m,S=m.match(y);if(S){const T=S[1],R="# __LAMBDA_PLACEHOLDER__",B=new RegExp(`lambda:\\s*\\|-\\s*[\\r\\n]+\\s*${R.replace("#","\\#")}`).test(m);if(E)m=m.replace(y,"");else{const k=(B?"":T+`lambda: |-
`)+v.map(I=>T+"  "+I).join(`
`);m=m.replace(y,k)}}return m=this.applyPackageOverrides(m,r,e.orientation),this.sanitizePackageContent(m)+`

`+a.join(`
`)}}else{const y=$e?$e(r,e.orientation):[];a.push(...y);for(let S=0;S<a.length;S++)if(a[S].trim()==="display:"){let T=S+1;for(;T<a.length&&(a[T].startsWith("  ")||a[T].trim()==="");)T++;E||a.splice(T,0,"    lambda: |-",...v.map(R=>"      "+R));break}}return a.join(`
`)}async preProcessWidgets(e){for(const i of e)if(i.widgets)for(const o of i.widgets.filter(t=>!t.hidden&&t.type!=="group")){const t=o.type,n=Y?await Y.load(t):null;n&&(this.usedPlugins.add(n),typeof n.collectRequirements=="function"&&n.collectRequirements(o,{trackIcon:(s,r)=>this.fonts.trackIcon(s,r),addFont:(s,r,d,c)=>this.fonts.addFont(s,r,d,c)}))}}generateDisplayLambda(e,i,o){const t=[],n=o.features?.inverted_colors||i.invertedColors,s=!!(o.features&&o.features.epaper);return n?(t.push("const auto COLOR_WHITE = Color(0, 0, 0); // Inverted for e-ink"),t.push("const auto COLOR_BLACK = Color(255, 255, 255); // Inverted for e-ink")):(t.push("const auto COLOR_WHITE = Color(255, 255, 255);"),t.push("const auto COLOR_BLACK = Color(0, 0, 0);")),t.push("const auto COLOR_RED = Color(255, 0, 0);"),t.push("const auto COLOR_GREEN = Color(0, 255, 0);"),t.push("const auto COLOR_BLUE = Color(0, 0, 255);"),t.push("const auto COLOR_YELLOW = Color(255, 255, 0);"),t.push("const auto COLOR_ORANGE = Color(255, 165, 0);"),t.push("auto color_off = COLOR_WHITE;"),t.push("auto color_on = COLOR_BLACK;"),t.push(""),t.push("// Helper to apply a simple grey dither mask for e-paper (checkerboard)"),t.push("auto apply_grey_dither_mask = [&](int x_start, int y_start, int w, int h) {"),t.push("  for (int y = y_start; y < y_start + h; y++) {"),t.push("    for (int x = x_start; x < x_start + w; x++) {"),t.push("      if ((x + y) % 2 == 0) it.draw_pixel_at(x, y, COLOR_WHITE);"),t.push("      else it.draw_pixel_at(x, y, COLOR_BLACK);"),t.push("    }"),t.push("  }"),t.push("};"),window.PluginRegistry&&window.PluginRegistry.onExportHelpers({lines:t,widgets:e.flatMap(r=>r.widgets||[])}),t.push("int currentPage = id(display_page);"),e.forEach((r,d)=>{t.push(`if (currentPage == ${d}) {`),t.push(`  // page:name "${r.name||"Page "+(d+1)}"`),t.push(`  // page:dark_mode "${r.dark_mode||"inherit"}"`),t.push(`  // page:refresh_type "${r.refresh_type||"interval"}"`),t.push(`  // page:refresh_time "${r.refresh_time||""}"`),t.push("  // Clear screen for this page"),t.push("  it.fill(COLOR_WHITE);"),t.push("  color_off = COLOR_WHITE;"),t.push("  color_on = COLOR_BLACK;"),r.widgets&&r.widgets.filter(c=>!c.hidden&&c.type!=="group").forEach(c=>{const a=this.generateWidget(c,{profile:o,layout:i,adapter:this,isEpaper:s});if(a.length>0){const u=a.reduce((g,f)=>{if(!f.trim())return g;const v=f.match(/^ */);return Math.min(g,v?v[0].length:0)},1/0),m=u===1/0?0:u;t.push(...a.map(g=>g.trim()?"  "+g.substring(m):""))}}),t.push("}")}),t}generateWidget(e,i){if(e.type==="group")return[];const o=[],t=Y?Y.get(e.type):null,n=e.type&&e.type.startsWith("lvgl_");if(t&&typeof t.export=="function"){const s={...i,lines:o,addFont:(d,c,a,u)=>this.fonts.addFont(d,c,a,u),getColorConst:d=>J?J.getColorConst(d):`"${d}"`,getAlignX:(d,c,a)=>J?J.getAlignX(d,c,a):c,getAlignY:(d,c,a)=>J?J.getAlignY(d,c,a):c,addDitherMask:(d,c,a,u,m,g,f)=>J?J.addDitherMask(d,c,a,u,m,g,f):null,sanitize:d=>this.sanitize(d),getCondProps:d=>this.getCondProps(d),getConditionCheck:d=>this.getConditionCheck(d),Utils:J,COLORS:qe,ALIGNMENT:Xe,TEXT_Y_OFFSET:0,RECT_Y_OFFSET:0},r=t.export(e,s);r&&Array.isArray(r)?o.push(...r):r&&typeof r=="string"&&o.push(r)}else n?Se?o.push(Se(e)):o.push(`// widget:${e.type} id:${e.id} x:${e.x} y:${e.y} w:${e.width} h:${e.height}`):(o.push(`// widget:${e.type} id:${e.id} status:unsupported`),o.push(`        // Unsupported widget type: ${e.type}`));return o}async fetchHardwarePackage(e){let i=e;window.location.pathname.includes("/esphome-designer")&&!e.startsWith("http")&&!e.startsWith("/")&&(i="/esphome-designer/static/"+e);try{const o=await fetch(i,{cache:"no-store"});if(!o.ok)throw new Error(`HTTP ${o.status}`);return await o.text()}catch(o){return _.error("Failed to fetch hardware package:",o),`# ERROR LOADING PROFILE: ${o.message}`}}sanitizePackageContent(e){if(!e)return"";const i=["esphome:","esp32:","wifi:","api:","ota:","logger:","web_server:","captive_portal:","platformio_options:","preferences:","substitutions:"],o=e.split(`
`),t=[];let n=!1;for(let s of o){const r=s.trim();if(r.length===0){t.push(s);continue}(s.match(/^\s*/)||[""])[0].length===0&&r.endsWith(":")?(n=i.some(c=>r.startsWith(c)),n?t.push("# "+s+" # (Auto-commented)"):t.push(s)):n?t.push("# "+s):t.push(s)}return t.join(`
`)}applyPackageOverrides(e,i,o){if(i.name?.includes("Waveshare Touch LCD 7")){let t=0;o==="portrait"?t=90:o==="landscape"?t=0:o==="portrait_inverted"?t=270:o==="landscape_inverted"&&(t=180),e=e.replace(/rotation:\s*\d+/g,`rotation: ${t}`);const n=e.match(/^(\s*)id:\s*my_touchscreen/m);if(n){const s=n[1];let r="";t===0?r=`transform:
${s}  swap_xy: false
${s}  mirror_x: false
${s}  mirror_y: false`:t===90?r=`transform:
${s}  swap_xy: true
${s}  mirror_x: false
${s}  mirror_y: true`:t===180?r=`transform:
${s}  swap_xy: false
${s}  mirror_x: true
${s}  mirror_y: true`:t===270&&(r=`transform:
${s}  swap_xy: true
${s}  mirror_x: true
${s}  mirror_y: false`),r&&(e=e.replace(/(id:\s*my_touchscreen[^\n\r]*[\r\n]+)/,`$1${s}${r}
`))}}return e}getCondProps(e){const i=(e.condition_entity||"").trim();if(!i)return"";const o=e.condition_operator||"==";let t=` cond_ent:"${i}" cond_op:"${o}"`;return o==="range"?(e.condition_min!==void 0&&e.condition_min!==null&&(t+=` cond_min:"${e.condition_min}"`),e.condition_max!==void 0&&e.condition_max!==null&&(t+=` cond_max:"${e.condition_max}"`)):e.condition_state!==void 0&&e.condition_state!==null&&(t+=` cond_state:"${e.condition_state}"`),t}getConditionCheck(e){const i=(e.condition_entity||"").trim();if(!i)return"";const o=e.condition_operator||"==",t=(e.condition_state||"").trim(),n=t.toLowerCase(),s=e.condition_min,r=e.condition_max,d=i.replace(/[^a-zA-Z0-9_]/g,"_"),a=["binary_sensor.","switch.","light.","input_boolean.","fan.","cover.","vacuum.","lock."].some(v=>i.startsWith(v));let m=i.startsWith("text_sensor.");if(!m&&!a&&o!=="range"){const v=parseFloat(t),b=["on","off","true","false","open","closed","locked","unlocked","home","not_home","occupied","clear","active","inactive","detected","idle"];t&&isNaN(v)&&!b.includes(n)&&(m=!0)}let g=`id(${d}).state`;m&&i.startsWith("text_sensor.");let f="";if(o==="=="||o==="!="||o===">"||o==="<"||o===">="||o==="<=")if(m)f=`${g} ${o} "${t}"`;else if(a){const b=["on","true","1","open","locked","home","occupied","active","detected"].includes(n);o==="=="?f=b?g:`!${g}`:o==="!="?f=b?`!${g}`:g:f=`(int)${g} ${o} ${b?1:0}`}else{let v=parseFloat(t);isNaN(v)&&(["on","true","open","locked","home","occupied","active","detected"].includes(n)?v=1:["off","false","closed","unlocked","not_home","clear","inactive","idle"].includes(n)&&(v=0)),f=`${g} ${o} ${isNaN(v)?0:v}`}else if(o==="range"){const v=parseFloat(s),b=parseFloat(r);f=`${g} >= ${isNaN(v)?0:v} && ${g} <= ${isNaN(b)?100:b}`}return f?`if (${f}) {`:""}sanitize(e){return e?e.replace(/"/g,'\\"'):""}};window.ESPHomeAdapter=cs;function ps(l){const{name:e,chip:i,resWidth:o,resHeight:t,shape:n,psram:s,displayDriver:r,pins:d,touchTech:c}=l,a=[];if(a.push("# ============================================================================"),a.push(`# TARGET DEVICE: ${e}`),a.push(`# Name: ${e}`),a.push(`# Resolution: ${o}x${t}`),a.push(`# Shape: ${n}`),a.push("#"),a.push(`#         - Display Platform: ${r||"Unknown"}`),a.push(`#         - Touchscreen: ${c||"None"}`),a.push(`#         - PSRAM: ${s?"Yes":"No"}`),a.push("# ============================================================================"),a.push("#"),a.push("# SETUP INSTRUCTIONS:"),a.push("#"),a.push("# STEP 1: Copy the Material Design Icons font file"),a.push("#         - From this repo: font_ttf/font_ttf/materialdesignicons-webfont.ttf"),a.push("#         - To ESPHome: /config/esphome/fonts/materialdesignicons-webfont.ttf"),a.push("#         (Create the fonts folder if it doesn't exist)"),a.push("#"),a.push("# STEP 2: Create a new device in ESPHome"),a.push('#         - Click "New Device"'),a.push("#         - Name: your-device-name"),i==="ESP32 (Standard)"?(a.push("#         - Select: ESP32"),a.push("#         - Board: esp32dev (or specific board)"),a.push("#         - Framework: esp-idf (Recommended) or arduino")):(a.push("#         - Select: ESP32-S3"),a.push("#         - Board: esp32-s3-devkitc-1"),a.push("#         - Framework: esp-idf (Recommended) or arduino")),a.push("#"),a.push("# ============================================================================"),a.push(""),a.push("#Infrastructure (Comment out if pasting into existing config)"),a.push("# esphome:"),a.push(`#   name: ${e.toLowerCase().replace(/[^a-z0-9]/g,"-")}`),a.push("#"),a.push("# esp32:"),a.push(`#   board: ${hs(i)}`),a.push("#   framework:"),a.push("#     type: esp-idf"),a.push(""),s&&(a.push("# psram:"),a.push("#")),d.clk&&d.mosi&&(a.push("spi:"),a.push(`  clk_pin: ${d.clk}`),a.push(`  mosi_pin: ${d.mosi}`),d.miso&&a.push(`  miso_pin: ${d.miso}`),a.push("")),d.sda&&d.scl&&(a.push("i2c:"),a.push(`  sda: ${d.sda}`),a.push(`  scl: ${d.scl}`),a.push("  scan: true"),a.push("")),a.push("display:"),a.push(`  - platform: ${r}`),d.cs&&a.push(`    cs_pin: ${d.cs}`),d.dc&&a.push(`    dc_pin: ${d.dc}`),d.rst&&a.push(`    reset_pin: ${d.rst}`),d.busy&&a.push(`    busy_pin: ${d.busy}`),r==="st7789v"&&(a.push("    model: Custom"),a.push("    id: my_display"),a.push(`    width: ${o}`),a.push(`    height: ${t}`),a.push("    offset_height: 0"),a.push("    offset_width: 0")),a.push("    lambda: |-"),a.push("      # __LAMBDA_PLACEHOLDER__"),a.push(""),d.backlight){const u=l.backlightMinPower??.07,m=l.backlightInitial??.8,g=!!l.antiburn;a.push("output:"),a.push("  - platform: ledc"),a.push(`    pin: ${d.backlight}`),a.push("    id: backlight_brightness_output"),a.push(`    min_power: "${u}"`),a.push("    zero_means_zero: true"),a.push(""),a.push("light:"),a.push("  - platform: monochromatic"),a.push("    output: backlight_brightness_output"),a.push("    id: lcdbacklight_brightness"),a.push("    name: LCD Backlight"),a.push("    icon: mdi:wall-sconce-flat-outline"),a.push("    restore_mode: ALWAYS_ON"),a.push("    initial_state:"),a.push(`      brightness: "${m}"`),g&&(a.push("    on_turn_off:"),a.push("      - script.execute: start_antiburn"),a.push("    on_turn_on:"),a.push("      - script.execute: stop_antiburn")),a.push(""),g&&(a.push("script:"),a.push("  - id: start_antiburn"),a.push("    then:"),a.push("      - delay: 5min"),a.push("      - logger.log: Starting automatic antiburn."),a.push("      - switch.turn_on: switch_antiburn"),a.push("  - id: stop_antiburn"),a.push("    then:"),a.push("      - script.stop: start_antiburn"),a.push("      - switch.turn_off: switch_antiburn"),a.push(""),a.push("switch:"),a.push("  - platform: template"),a.push("    name: Antiburn"),a.push("    id: switch_antiburn"),a.push("    icon: mdi:television-shimmer"),a.push("    optimistic: true"),a.push("    entity_category: config"),a.push("    turn_on_action:"),a.push('      - logger.log: "Starting Antiburn"'),a.push("      - if:"),a.push("          condition: lvgl.is_paused"),a.push("          then:"),a.push("            - lvgl.resume:"),a.push("            - lvgl.widget.redraw:"),a.push("      - lvgl.pause:"),a.push("          show_snow: true"),a.push("    turn_off_action:"),a.push('      - logger.log: "Stopping Antiburn"'),a.push("      - if:"),a.push("          condition: lvgl.is_paused"),a.push("          then:"),a.push("            - lvgl.resume:"),a.push("            - lvgl.widget.redraw:"),a.push(""))}return c!=="none"&&(a.push("touchscreen:"),a.push(`  - platform: ${c}`),d.touch_int&&a.push(`    interrupt_pin: ${d.touch_int}`),d.touch_rst&&a.push(`    reset_pin: ${d.touch_rst}`),a.push("")),a.join(`
`)}function hs(l){switch(l){case"esp32-s3":return"esp32-s3-devkitc-1";case"esp32-c3":return"esp32-c3-devkitm-1";case"esp32-c6":return"esp32-c6-devkitc-1";case"esp32":return"esp32dev";default:return"esp32-s3-devkitc-1"}}class us{constructor(){_.log("[DeviceSettings] Constructor called - Instance ID check"),this.modal=document.getElementById("deviceSettingsModal"),this.closeBtn=document.getElementById("deviceSettingsClose"),this.saveBtn=document.getElementById("deviceSettingsSave"),this.nameInput=document.getElementById("deviceName"),this.modelInput=document.getElementById("deviceModel"),this.orientationInput=document.getElementById("deviceOrientation"),this.darkModeInput=document.getElementById("deviceDarkMode"),this.extendedLatinGlyphsInput=document.getElementById("deviceExtendedLatinGlyphs"),this.invertedColorsInput=document.getElementById("deviceInvertedColors"),this.modeStandard=document.getElementById("mode-standard"),this.modeSleep=document.getElementById("setting-sleep-enabled"),this.modeManual=document.getElementById("setting-manual-refresh"),this.modeDeepSleep=document.getElementById("setting-deep-sleep-enabled"),this.modeDaily=document.getElementById("setting-daily-refresh-enabled"),this.sleepStart=document.getElementById("setting-sleep-start"),this.sleepEnd=document.getElementById("setting-sleep-end"),this.sleepRow=document.getElementById("sleep-times-row"),this.dailyRefreshTime=document.getElementById("setting-daily-refresh-time"),this.dailyRefreshRow=document.getElementById("daily-refresh-row"),this.deepSleepInterval=document.getElementById("setting-deep-sleep-interval"),this.deepSleepRow=document.getElementById("deep-sleep-interval-row"),this.refreshIntervalInput=document.getElementById("setting-refresh-interval"),this.refreshIntervalRow=document.getElementById("global-refresh-row"),this.noRefreshStart=document.getElementById("setting-no-refresh-start"),this.noRefreshEnd=document.getElementById("setting-no-refresh-end"),this.autoCycleEnabled=document.getElementById("setting-auto-cycle"),this.autoCycleInterval=document.getElementById("setting-auto-cycle-interval"),this.autoCycleRow=document.getElementById("field-auto-cycle-interval"),this.customHardwareSection=document.getElementById("customHardwareSection"),this.customFieldsContainer=this.customHardwareSection,this.customChip=document.getElementById("customChip"),this.customTech=document.getElementById("customTech"),this.customRes=document.getElementById("customRes"),this.customShape=document.getElementById("customShape"),this.customPsram=document.getElementById("customPsram"),this.customDisplayDriver=document.getElementById("customDisplayDriver"),this.customTouchTech=document.getElementById("customTouchTech"),this.touchPinsGrid=document.getElementById("touchPinsGrid"),this.customProfileNameInput=document.getElementById("customProfileName"),this.strategyEpaperGroup=document.getElementById("strategy-epaper-group"),this.strategyLcdGroup=document.getElementById("strategy-lcd-group"),this.renderingModeInput=document.getElementById("renderingMode"),this.renderingModeField=document.getElementById("renderingModeField")}init(){this.closeBtn&&this.closeBtn.addEventListener("click",()=>this.close());const e=document.getElementById("importHardwareBtn"),i=document.getElementById("hardwareFileInput");e&&i&&(e.addEventListener("click",o=>{o.preventDefault(),i.click()}),i.addEventListener("change",async o=>{if(o.target.files.length>0){const t=o.target.files[0];try{await Mt(t)}catch{}i.value=""}})),this.populateDeviceSelect(),this.saveBtn&&this.saveBtn.addEventListener("click",()=>this.close()),this.setupAutoSaveListeners(),this.setupCustomHardwareListeners()}setupCustomHardwareListeners(){this.modelInput&&(this.modelInput.addEventListener("change",()=>{this.updateCustomSectionVisibility()}),this.customTech&&this.customTech.addEventListener("change",()=>{this.updateStrategyGroupVisibility()}),this.customTouchTech&&this.customTouchTech.addEventListener("change",()=>{this.touchPinsGrid&&(this.touchPinsGrid.style.display=this.customTouchTech.value==="none"?"none":"grid")}),this.customShape&&this.customShape.addEventListener("change",()=>{if(this.customShape.value==="round"&&this.customRes){const e=(this.customRes.value||"800x480").split("x"),i=parseInt(e[0])||480,o=parseInt(e[1])||480,t=Math.min(i,o);this.customRes.value=`${t}x${t}`,_.log(`[DeviceSettings] Auto-set square resolution for round display: ${t}x${t}`),this.customRes.dispatchEvent(new Event("change"))}}),document.body.addEventListener("click",async e=>{if(e.target&&e.target.id==="saveCustomProfileBtn"){if(e.preventDefault(),e.stopImmediatePropagation(),this._isSavingProfile)return;this._isSavingProfile=!0,_.log("[DeviceSettings] saveCustomProfileBtn clicked (Delegate+Debounce)");try{typeof this.handleSaveCustomProfile=="function"?await this.handleSaveCustomProfile():(_.error("[DeviceSettings] handleSaveCustomProfile missing"),alert("Error: Save function missing on DeviceSettings instance"))}catch(i){console.error(i),alert("Error saving profile: "+i.message)}finally{setTimeout(()=>{this._isSavingProfile=!1},1e3)}}}),this.setupCustomHardwareAutoSave())}setupCustomHardwareAutoSave(){const e=[this.customChip,this.customTech,this.customRes,this.customShape,this.customPsram,this.customDisplayDriver,this.customTouchTech,"pin_cs","pin_dc","pin_rst","pin_busy","pin_clk","pin_mosi","pin_backlight","pin_sda","pin_scl","pin_touch_int","pin_touch_rst"],i=()=>{if(this.modelInput.value==="custom"){const o=this.getCustomHardwareConfig();h.setCustomHardware(o)}};e.forEach(o=>{const t=typeof o=="string"?document.getElementById(o):o;if(!t)return;const n=t.type==="checkbox"||t.tagName==="SELECT"?"change":"input";t.addEventListener(n,i)})}getCustomHardwareConfig(){const e=(this.customRes.value||"800x480").split("x"),i=o=>{const t=document.getElementById(o);return t?t.value:""};return{chip:this.customChip.value,tech:this.customTech.value,resWidth:parseInt(e[0])||800,resHeight:parseInt(e[1])||480,shape:this.customShape.value,psram:this.customPsram.checked,displayDriver:this.customDisplayDriver.value,touchTech:this.customTouchTech.value,backlightMinPower:parseFloat(i("customBacklightMinPower"))||.07,backlightInitial:parseFloat(i("customBacklightInitial"))||.8,antiburn:!!document.getElementById("customAntiburn")?.checked,pins:{cs:i("pin_cs"),dc:i("pin_dc"),rst:i("pin_rst"),busy:i("pin_busy"),clk:i("pin_clk"),mosi:i("pin_mosi"),backlight:i("pin_backlight"),sda:i("pin_sda"),scl:i("pin_scl"),touch_int:i("pin_touch_int"),touch_rst:i("pin_touch_rst")}}}updateCustomSectionVisibility(){this.customHardwareSection&&(this.customHardwareSection.style.display=this.modelInput.value==="custom"?"block":"none")}async handleSaveCustomProfile(){_.log("[DeviceSettings] handleSaveCustomProfile called");try{const e=this.customProfileNameInput?this.customProfileNameInput.value.trim():"";if(!e){G("Please enter a name for your custom profile first.","warning"),this.customProfileNameInput&&this.customProfileNameInput.focus();return}const i=(this.customRes.value||"800x480").split("x"),o=u=>{const m=document.getElementById(u);return m?m.value:""},t={name:e,chip:this.customChip.value,tech:this.customTech.value,resWidth:parseInt(i[0])||800,resHeight:parseInt(i[1])||480,shape:this.customShape.value,psram:this.customPsram.checked,displayDriver:this.customDisplayDriver.value,touchTech:this.customTouchTech.value,pins:{cs:o("pin_cs"),dc:o("pin_dc"),rst:o("pin_rst"),busy:o("pin_busy"),clk:o("pin_clk"),mosi:o("pin_mosi"),backlight:o("pin_backlight"),sda:o("pin_sda"),scl:o("pin_scl"),touch_int:o("pin_touch_int"),touch_rst:o("pin_touch_rst")}},n=ps(t),s=new Blob([n],{type:"text/yaml"}),r=`${e.toLowerCase().replace(/\s+/g,"_")}.yaml`,d=new File([s],r);G("Generating hardware recipe...","info"),await Mt(d);let c=0;const a=()=>{const m=Object.values(window.DEVICE_PROFILES||F||{}).find(g=>g.name===e||g.name===e+" (Local)"||g.name&&g.name.includes(e));if(m){const g=Object.keys(window.DEVICE_PROFILES||F||{}).find(f=>(window.DEVICE_PROFILES||F)[f]===m);g&&(this.modelInput.value=g,this.modelInput.dispatchEvent(new Event("change")),G(`Profile "${e}" created and loaded!`,"success"))}else c<10?(c++,_.log(`[DeviceSettings] New profile not found yet (attempt ${c}), retrying...`),setTimeout(a,500)):(_.error("[DeviceSettings] Failed to find the newly created profile in the list."),G("Profile created, but could not be auto-selected. Please find it in the list.","warning"))};setTimeout(a,1e3)}catch(e){_.error("Failed to save custom profile:",e),G("Failed to create profile: "+e.message,"error")}}open(){if(_.log("DeviceSettings.open() called"),!this.modal){_.error("DeviceSettings modal element not found!");return}_.log("Opening Device Settings modal..."),this.nameInput&&(this.nameInput.value=h.settings.device_name||"My E-Ink Display"),this.modelInput&&(this.modelInput.value=h.settings.device_model||"reterminal_e1001"),this.orientationInput&&(this.orientationInput.value=h.settings.orientation||"landscape"),this.darkModeInput&&(this.darkModeInput.checked=!!h.settings.darkMode),this.extendedLatinGlyphsInput&&(this.extendedLatinGlyphsInput.checked=!!h.settings.extendedLatinGlyphs),this.invertedColorsInput&&(this.invertedColorsInput.checked=!!h.settings.invertedColors);const e=h.settings,i=!!e.sleepEnabled,o=!!e.manualRefreshOnly,t=!!e.deepSleepEnabled,n=!!e.dailyRefreshEnabled,s=!i&&!o&&!t&&!n;this.modeStandard&&(this.modeStandard.checked=s),this.modeSleep&&(this.modeSleep.checked=i),this.modeManual&&(this.modeManual.checked=o),this.modeDeepSleep&&(this.modeDeepSleep.checked=t),this.modeDaily&&(this.modeDaily.checked=n),this.sleepStart&&(this.sleepStart.value=e.sleepStartHour??0),this.sleepEnd&&(this.sleepEnd.value=e.sleepEndHour??5),this.dailyRefreshTime&&(this.dailyRefreshTime.value=e.dailyRefreshTime||"08:00"),this.deepSleepInterval&&(this.deepSleepInterval.value=e.deepSleepInterval??600),this.refreshIntervalInput&&(this.refreshIntervalInput.value=e.refreshInterval??600),this.noRefreshStart&&(this.noRefreshStart.value=e.noRefreshStartHour??""),this.noRefreshEnd&&(this.noRefreshEnd.value=e.noRefreshEndHour??""),this.autoCycleEnabled&&(this.autoCycleEnabled.checked=!!e.autoCycleEnabled),this.autoCycleInterval&&(this.autoCycleInterval.value=e.autoCycleIntervalS??30),this.updateVisibility(),this.updateStrategyGroupVisibility(),this.populateCustomFields(),this.updateCustomSectionVisibility(),this.modal.classList.remove("hidden"),this.modal.style.display="flex",_.log("Device Settings modal should be visible now.")}close(){this.modal&&(this.modal.classList.add("hidden"),this.modal.style.display="none")}populateCustomFields(){const e=h.project&&h.project.state&&h.project.state.customHardware||{};if(!e||Object.keys(e).length===0)return;this.customChip&&(this.customChip.value=e.chip||"esp32-s3"),this.customTech&&(this.customTech.value=e.tech||"lcd"),this.customRes&&(this.customRes.value=`${e.resWidth||800}x${e.resHeight||480}`),this.customShape&&(this.customShape.value=e.shape||"rect"),this.customPsram&&(this.customPsram.checked=!!e.psram),this.customDisplayDriver&&(this.customDisplayDriver.value=e.displayDriver||"generic_st7789"),this.customTouchTech&&(this.customTouchTech.value=e.touchTech||"none",this.touchPinsGrid&&(this.touchPinsGrid.style.display=e.touchTech&&e.touchTech!=="none"?"grid":"none"));const i=e.pins||{},o=(t,n)=>{const s=document.getElementById(t);s&&(s.value=n||"")};o("pin_cs",i.cs),o("pin_dc",i.dc),o("pin_rst",i.rst),o("pin_busy",i.busy),o("pin_clk",i.clk),o("pin_mosi",i.mosi),o("pin_backlight",i.backlight),o("pin_sda",i.sda),o("pin_scl",i.scl),o("pin_touch_int",i.touch_int),o("pin_touch_rst",i.touch_rst)}populateDeviceSelect(){if(this.modelInput&&F){const e=this.modelInput.value;_.log("[DeviceSettings] Populating dropdown with",Object.keys(F).length,"profiles"),this.modelInput.innerHTML="";const i=Be||[];Object.entries(F).forEach(([t,n])=>{_.log(`  - Adding: ${t} (${n.name})`);const s=document.createElement("option");s.value=t;let r=n.name;i.includes(t)||(r+=" (untested)"),s.textContent=r,this.modelInput.appendChild(s)});const o=document.createElement("option");o.value="custom",o.textContent="Custom Profile...",o.style.fontWeight="bold",o.style.color="var(--accent)",this.modelInput.appendChild(o),e&&(F[e]||e==="custom")?this.modelInput.value=e:this.modelInput.value||(this.modelInput.value="reterminal_e1001"),this.updateCustomSectionVisibility()}}updateVisibility(){const e=this.modeSleep&&this.modeSleep.checked,i=this.modeDaily&&this.modeDaily.checked,o=this.modeDeepSleep&&this.modeDeepSleep.checked,t=this.modeManual&&this.modeManual.checked;this.sleepRow&&(this.sleepRow.style.display=e?"flex":"none"),this.dailyRefreshRow&&(this.dailyRefreshRow.style.display=i?"flex":"none"),this.deepSleepRow&&(this.deepSleepRow.style.display=o?"block":"none");const n=!i&&!t;this.refreshIntervalRow&&(this.refreshIntervalRow.style.display=n?"block":"none"),this.autoCycleRow&&(this.autoCycleRow.style.display=this.autoCycleEnabled&&this.autoCycleEnabled.checked?"flex":"none")}persistToBackend(){this.saveDebounceTimer&&clearTimeout(this.saveDebounceTimer),this.saveDebounceTimer=setTimeout(async()=>{if(q()&&typeof saveLayoutToBackend=="function")try{await saveLayoutToBackend(),_.log("[DeviceSettings] All settings persisted to backend")}catch(e){_.warn("[DeviceSettings] Failed to auto-save settings:",e)}else try{const e=h.getPagesPayload();e.deviceName=h.deviceName,e.deviceModel=h.deviceModel,localStorage.setItem("esphome-designer-layout",JSON.stringify(e)),_.log("[DeviceSettings] Settings persisted to localStorage (offline mode)")}catch(e){_.warn("[DeviceSettings] Failed to save to localStorage:",e)}},1e3)}setupAutoSaveListeners(){const e=(n,s)=>{h.updateSettings({[n]:s}),_.log(`Auto-saved ${n}:`,s),this.persistToBackend()};let i=null;this.nameInput&&this.nameInput.addEventListener("input",()=>{const n=this.nameInput.value.trim();h.setDeviceName(n),D(A.STATE_CHANGED),i&&clearTimeout(i),i=setTimeout(async()=>{if(typeof saveLayoutToBackend=="function")try{await saveLayoutToBackend(),_.log("[DeviceSettings] Device name saved to backend")}catch(s){_.warn("[DeviceSettings] Failed to save device name:",s)}},500)}),this.modelInput&&this.modelInput.addEventListener("change",async()=>{const n=this.modelInput.value;window.currentDeviceModel=n,h.setDeviceModel(n),e("device_model",n),this.updateStrategyGroupVisibility(),_.log("Device model changed to:",n)}),this.orientationInput&&this.orientationInput.addEventListener("change",()=>{e("orientation",this.orientationInput.value)}),this.darkModeInput&&this.darkModeInput.addEventListener("change",()=>{e("darkMode",this.darkModeInput.checked)}),this.extendedLatinGlyphsInput&&this.extendedLatinGlyphsInput.addEventListener("change",()=>{e("extendedLatinGlyphs",this.extendedLatinGlyphsInput.checked)}),this.invertedColorsInput&&this.invertedColorsInput.addEventListener("change",()=>{e("invertedColors",this.invertedColorsInput.checked)}),this.renderingModeInput&&this.renderingModeInput.addEventListener("change",()=>{e("renderingMode",this.renderingModeInput.value),_.log("Rendering mode changed to:",this.renderingModeInput.value)}),[this.modeStandard,this.modeSleep,this.modeManual,this.modeDeepSleep,this.modeDaily].forEach(n=>{n&&n.addEventListener("change",()=>{n.checked&&(e("sleepEnabled",!!(this.modeSleep&&this.modeSleep.checked)),e("manualRefreshOnly",!!(this.modeManual&&this.modeManual.checked)),e("deepSleepEnabled",!!(this.modeDeepSleep&&this.modeDeepSleep.checked)),e("dailyRefreshEnabled",!!(this.modeDaily&&this.modeDaily.checked)),this.updateVisibility())})}),this.sleepStart&&this.sleepStart.addEventListener("change",()=>{e("sleepStartHour",parseInt(this.sleepStart.value)||0)}),this.sleepEnd&&this.sleepEnd.addEventListener("change",()=>{e("sleepEndHour",parseInt(this.sleepEnd.value)||0)}),this.dailyRefreshTime&&this.dailyRefreshTime.addEventListener("change",()=>{e("dailyRefreshTime",this.dailyRefreshTime.value)}),this.deepSleepInterval&&this.deepSleepInterval.addEventListener("input",()=>{const n=parseInt(this.deepSleepInterval.value)||600;e("deepSleepInterval",n),this.refreshIntervalInput&&(this.refreshIntervalInput.value=n,h.updateSettings({refreshInterval:n}))}),this.refreshIntervalInput&&this.refreshIntervalInput.addEventListener("input",()=>{const n=parseInt(this.refreshIntervalInput.value)||600;e("refreshInterval",n),this.deepSleepInterval&&this.modeDeepSleep&&this.modeDeepSleep.checked&&(this.deepSleepInterval.value=n,h.updateSettings({deepSleepInterval:n}))}),this.noRefreshStart&&this.noRefreshStart.addEventListener("change",()=>{const n=this.noRefreshStart.value===""?null:parseInt(this.noRefreshStart.value);e("noRefreshStartHour",n)}),this.noRefreshEnd&&this.noRefreshEnd.addEventListener("change",()=>{const n=this.noRefreshEnd.value===""?null:parseInt(this.noRefreshEnd.value);e("noRefreshEndHour",n)}),this.autoCycleEnabled&&this.autoCycleEnabled.addEventListener("change",()=>{e("autoCycleEnabled",this.autoCycleEnabled.checked),this.updateVisibility()}),this.autoCycleInterval&&this.autoCycleInterval.addEventListener("input",()=>{const n=Math.max(5,parseInt(this.autoCycleInterval.value)||30);e("autoCycleIntervalS",n)}),document.querySelectorAll('input[name="lcdEcoStrategy"]').forEach(n=>{n.addEventListener("change",()=>{n.checked&&(e("lcdEcoStrategy",n.value),this.sleepRow&&(this.sleepRow.style.display=n.value==="backlight_off"?"flex":"none"))})})}updateStrategyGroupVisibility(){const e=this.modelInput?this.modelInput.value:"reterminal_e1001";let i=!1;if(e==="custom")i=(h.project&&h.project.state&&h.project.state.customHardware||{}).tech==="lcd";else{const t=(window.DEVICE_PROFILES||F||{})[e];i=!!(t&&t.features&&(t.features.lcd||t.features.oled)),t&&t.features&&(t.features.lvgl||t.features.lv_display)}if(this.strategyEpaperGroup&&(this.strategyEpaperGroup.style.display=i?"none":"flex"),this.strategyLcdGroup&&(this.strategyLcdGroup.style.display=i?"flex":"none",i)){const o=h.settings.lcdEcoStrategy||"backlight_off",t=document.querySelector(`input[name="lcdEcoStrategy"][value="${o}"]`);t&&(t.checked=!0)}this.renderingModeField&&(this.renderingModeField.style.display=i?"block":"none",i&&this.renderingModeInput&&(this.renderingModeInput.value=h.settings.renderingMode||"lvgl"))}openSaveProfileModal(){return new Promise(e=>{if(!this.saveProfileModal){_.error("Save Profile Modal not found in DOM"),e(null);return}this.saveProfileResolve=e,this.saveProfileNameInput.value="My Custom Device",this.saveProfileModal.classList.remove("hidden"),this.saveProfileModal.style.display="flex",this.saveProfileNameInput.focus(),this.saveProfileNameInput.select();const i=()=>{this.saveProfileModal.classList.add("hidden"),this.saveProfileModal.style.display="none",this.saveProfileResolve&&(this.saveProfileResolve(null),this.saveProfileResolve=null),n()},o=()=>{const s=this.saveProfileNameInput.value.trim();if(!s){G("Please enter a profile name","warning"),this.saveProfileNameInput.focus();return}this.saveProfileModal.classList.add("hidden"),this.saveProfileModal.style.display="none",this.saveProfileResolve&&(this.saveProfileResolve(s),this.saveProfileResolve=null),n()},t=s=>{s.key==="Enter"&&o(),s.key==="Escape"&&i()},n=()=>{this.saveProfileCloseBtn.removeEventListener("click",i),this.saveProfileConfirmBtn.removeEventListener("click",o),this.saveProfileNameInput.removeEventListener("keyup",t)};this.saveProfileCloseBtn.addEventListener("click",i),this.saveProfileConfirmBtn.addEventListener("click",o),this.saveProfileNameInput.addEventListener("keyup",t)})}}class gs{constructor(){this.modal=document.getElementById("editorSettingsModal"),this.closeBtn=document.getElementById("editorSettingsClose"),this.doneBtn=document.getElementById("editorSettingsDone"),this.snapToGrid=document.getElementById("editorSnapToGrid"),this.showGrid=document.getElementById("editorShowGrid"),this.lightMode=document.getElementById("editorLightMode"),this.refreshEntitiesBtn=document.getElementById("editorRefreshEntities"),this.entityCountLabel=document.getElementById("editorEntityCount"),this.gridOpacity=document.getElementById("editorGridOpacity"),this.haManualUrl=document.getElementById("haManualUrl"),this.haLlatToken=document.getElementById("haLlatToken"),this.testHaBtn=document.getElementById("editorTestHaBtn"),this.haTestResult=document.getElementById("haTestResult"),this.aiProvider=document.getElementById("aiProvider"),this.aiApiKeyGemini=document.getElementById("aiApiKeyGemini"),this.aiApiKeyOpenai=document.getElementById("aiApiKeyOpenai"),this.aiApiKeyOpenrouter=document.getElementById("aiApiKeyOpenrouter"),this.aiModelFilter=document.getElementById("aiModelFilter"),this.aiModelSelect=document.getElementById("aiModelSelect"),this.aiRefreshModelsBtn=document.getElementById("aiRefreshModelsBtn"),this.aiTestResult=document.getElementById("aiTestResult"),this.aiKeyRows={gemini:document.getElementById("aiKeyGeminiRow"),openai:document.getElementById("aiKeyOpenaiRow"),openrouter:document.getElementById("aiKeyOpenrouterRow")}}init(){this.modal&&(this.closeBtn&&this.closeBtn.addEventListener("click",()=>this.close()),this.doneBtn&&this.doneBtn.addEventListener("click",()=>this.close()),this.setupListeners())}open(){if(!this.modal)return;const e=h.settings;this.snapToGrid&&(this.snapToGrid.checked=h.snapEnabled!==!1),this.showGrid&&(this.showGrid.checked=h.showGrid!==!1),this.lightMode&&(this.lightMode.checked=!!e.editor_light_mode),this.aiProvider&&(this.aiProvider.value=e.ai_provider||"gemini"),this.aiApiKeyGemini&&(this.aiApiKeyGemini.value=e.ai_api_key_gemini||""),this.aiApiKeyOpenai&&(this.aiApiKeyOpenai.value=e.ai_api_key_openai||""),this.aiApiKeyOpenrouter&&(this.aiApiKeyOpenrouter.value=e.ai_api_key_openrouter||""),this.aiModelFilter&&(this.aiModelFilter.value=e.ai_model_filter||""),this.updateAIKeyVisibility(),this.refreshModelSelect(),this.gridOpacity&&(this.gridOpacity.value=e.grid_opacity!==void 0?e.grid_opacity:20),this.haManualUrl&&(this.haManualUrl.value=yt()||""),this.haLlatToken&&(this.haLlatToken.value=_t()||""),this.haTestResult&&(this.haTestResult.textContent=""),this.aiTestResult&&(this.aiTestResult.textContent="");const i=document.getElementById("haOriginPlaceholder");i&&(i.textContent=window.location.origin),this.updateEntityCount()}close(){this.modal&&(this.modal.classList.add("hidden"),this.modal.style.display="none")}updateEntityCount(){if(this.entityCountLabel&&window.entityStatesCache){const e=Object.keys(window.entityStatesCache).length;this.entityCountLabel.textContent=`${e} entities cached`}}setupListeners(){this.snapToGrid&&this.snapToGrid.addEventListener("change",()=>{h.setSnapEnabled(this.snapToGrid.checked)}),this.showGrid&&this.showGrid.addEventListener("change",()=>{h.setShowGrid(this.showGrid.checked);const i=document.querySelector(".canvas-grid");i&&(i.style.display=this.showGrid.checked?"block":"none")}),this.lightMode&&this.lightMode.addEventListener("change",()=>{const i=this.lightMode.checked;h.updateSettings({editor_light_mode:i}),this.applyEditorTheme(i),D(A.STATE_CHANGED)}),this.gridOpacity&&this.gridOpacity.addEventListener("input",()=>{const i=parseInt(this.gridOpacity.value,10);h.updateSettings({grid_opacity:i})}),this.refreshEntitiesBtn&&this.refreshEntitiesBtn.addEventListener("click",async()=>{this.refreshEntitiesBtn.disabled=!0,this.refreshEntitiesBtn.textContent="Refreshing...",he?await he():window.fetchEntityStates&&await window.fetchEntityStates(),this.updateEntityCount(),this.refreshEntitiesBtn.disabled=!1,this.refreshEntitiesBtn.textContent="â» Refresh Entity List"}),this.haManualUrl&&this.haManualUrl.addEventListener("change",()=>{zt(this.haManualUrl.value.trim()),ot()}),this.haLlatToken&&this.haLlatToken.addEventListener("change",()=>{Gt(this.haLlatToken.value.trim())}),this.testHaBtn&&this.testHaBtn.addEventListener("click",async()=>{this.testHaBtn.disabled=!0,this.haTestResult.textContent="Testing...",this.haTestResult.style.color="var(--muted)";try{ot();const i=await he();i&&i.length>0?(this.haTestResult.textContent="â Success!",this.haTestResult.style.color="var(--success)",this.updateEntityCount()):(this.haTestResult.innerHTML="â Failed.<br>Did you add <strong>cors_allowed_origins</strong> to HA and <strong>restart</strong> it?",this.haTestResult.style.color="var(--danger)")}catch{this.haTestResult.innerHTML="â Connection Error.<br>Check browser console.",this.haTestResult.style.color="var(--danger)"}finally{this.testHaBtn.disabled=!1}}),this.aiProvider&&this.aiProvider.addEventListener("change",()=>{h.updateSettings({ai_provider:this.aiProvider.value}),this.updateAIKeyVisibility(),this.refreshModelSelect()});const e=(i,o)=>{const t=document.getElementById(i);t&&t.addEventListener("input",()=>h.updateSettings({[o]:t.value.trim()}))};e("aiApiKeyGemini","ai_api_key_gemini"),e("aiApiKeyOpenai","ai_api_key_openai"),e("aiApiKeyOpenrouter","ai_api_key_openrouter"),this.aiModelFilter&&this.aiModelFilter.addEventListener("input",()=>{h.updateSettings({ai_model_filter:this.aiModelFilter.value}),this.filterModels()}),this.aiModelSelect&&this.aiModelSelect.addEventListener("change",()=>{const i=h.settings.ai_provider;h.updateSettings({[`ai_model_${i}`]:this.aiModelSelect.value})}),this.aiRefreshModelsBtn&&this.aiRefreshModelsBtn.addEventListener("click",async()=>{const i=h.settings.ai_provider||"gemini";let o=h.settings[`ai_api_key_${i}`];const t=`aiApiKey${i.charAt(0).toUpperCase()+i.slice(1)}`,n=document.getElementById(t);if(n&&(o=n.value.trim(),h.updateSettings({[`ai_api_key_${i}`]:o})),!o){G("Please enter an API key first",3e3,"error");return}this.aiRefreshModelsBtn.disabled=!0,this.aiRefreshModelsBtn.textContent="...",this.aiTestResult&&(this.aiTestResult.textContent="Testing...",this.aiTestResult.style.color="var(--muted)");try{const s=await window.aiService.fetchModels(i,o);window.aiService.cache.models[i]=s,this.refreshModelSelect(),this.aiTestResult&&(this.aiTestResult.textContent=`â Success! Found ${s.length} models.`,this.aiTestResult.style.color="var(--success)")}catch{this.aiTestResult&&(this.aiTestResult.textContent="â Failed. Check key/console.",this.aiTestResult.style.color="var(--danger)")}finally{this.aiRefreshModelsBtn.disabled=!1,this.aiRefreshModelsBtn.textContent="Test & Load Models"}})}updateAIKeyVisibility(){const e=h.settings.ai_provider||"gemini";Object.keys(this.aiKeyRows).forEach(i=>{this.aiKeyRows[i]&&(this.aiKeyRows[i].style.display=i===e?"block":"none")})}async refreshModelSelect(){if(!this.aiModelSelect)return;const e=h.settings.ai_provider||"gemini";if(!window.aiService||!window.aiService.cache)return;let i=window.aiService.cache.models[e];i||(i=[],window.aiService.cache.models[e]=i),this.filterModels()}filterModels(){if(!this.aiModelSelect)return;const e=h.settings.ai_provider||"gemini",i=(h.settings.ai_model_filter||"").toLowerCase();if(!window.aiService||!window.aiService.cache)return;const t=(window.aiService.cache.models[e]||[]).filter(s=>s.name.toLowerCase().includes(i)||s.id.toLowerCase().includes(i));this.aiModelSelect.innerHTML="",t.forEach(s=>{const r=document.createElement("option");r.value=s.id,r.textContent=s.name,this.aiModelSelect.appendChild(r)});const n=h.settings[`ai_model_${e}`];n&&(this.aiModelSelect.value=n)}applyEditorTheme(e){e?document.documentElement.setAttribute("data-theme","light"):document.documentElement.removeAttribute("data-theme");try{localStorage.setItem("reterminal-editor-theme",e?"light":"dark")}catch(i){_.log("Could not save theme preference:",i)}}}class ms{constructor(){this.modal=document.getElementById("aiPromptModal"),this.closeBtn=document.getElementById("aiPromptClose"),this.submitBtn=document.getElementById("aiPromptSubmit"),this.applyBtn=document.getElementById("aiPromptApply"),this.input=document.getElementById("aiPromptInput"),this.status=document.getElementById("aiPromptStatus"),this.diffPanel=document.getElementById("aiPreviewDiff"),this.diffContent=document.getElementById("aiDiffContent"),this.generatedWidgets=null}init(){this.modal&&(this.closeBtn.onclick=()=>this.close(),this.submitBtn.onclick=()=>this.handleSubmit(),this.applyBtn.onclick=()=>this.handleApply(),window.addEventListener("click",e=>{e.target===this.modal&&this.close()}))}open(){if(!this.modal)return;this.modal.classList.remove("hidden"),this.modal.style.display="flex",this.input.focus();const e=window.AppState.settings.ai_provider||"gemini",i=window.AppState.settings[`ai_api_key_${e}`],o=document.getElementById("aiConfigWarning");o&&(o.style.display=i?"none":"block"),this.status.textContent="",this.status.style.color="",this.diffPanel.style.display="none",this.applyBtn.style.display="none",this.generatedWidgets=null}close(){this.modal&&(this.modal.classList.add("hidden"),this.modal.style.display="none")}async handleSubmit(){const e=this.input.value.trim();if(e){this.setLoading(!0),this.status.textContent="AI is thinking...",this.status.style.color="var(--accent)",this.diffPanel.style.display="none",this.applyBtn.style.display="none";try{const i=window.AppState.getCurrentPage(),o=h.deviceModel,t=F?.[o];let n="monochrome";t&&(t.features?.lcd?n="color_lcd":t.name?.includes("6-Color")||t.name?.includes("Color")?n="color_epaper":n="monochrome");const s={canvas:window.AppState.getCanvasDimensions(),current_page:i.id,widgets:i.widgets,selected_widget_id:window.AppState.selectedWidgetId,display_type:n},r=await window.aiService.processPrompt(e,s);if(r&&Array.isArray(r))this.generatedWidgets=r,this.showDiffPreview(i.widgets,r),this.status.textContent="Successfully generated changes!",this.status.style.color="var(--success)",this.applyBtn.style.display="inline-block";else throw new Error("Invalid response format from AI")}catch(i){_.error(i),this.status.textContent="Error: "+i.message,this.status.style.color="var(--danger)"}finally{this.setLoading(!1)}}}handleApply(){if(this.generatedWidgets)try{const e=window.AppState.getCurrentPage();e.widgets=this.generatedWidgets,window.AppState.project.rebuildWidgetsIndex(),D(A.STATE_CHANGED),G("AI changes applied!","success"),this.close()}catch(e){_.error(e),G("Failed to apply changes: "+e.message,"error")}}showDiffPreview(e,i){this.diffPanel.style.display="block";let o=`Widgets: ${e.length} â ${i.length}

`;const t=e.map(c=>c.id),n=i.map(c=>c.id),s=i.filter(c=>!t.includes(c.id)),r=e.filter(c=>!n.includes(c.id)),d=i.filter(c=>{const a=e.find(u=>u.id===c.id);return a&&JSON.stringify(a)!==JSON.stringify(c)});s.length>0&&(o+=`[ADDED]
${s.map(c=>`+ ${c.type} (${c.id})`).join(`
`)}

`),r.length>0&&(o+=`[REMOVED]
${r.map(c=>`- ${c.type} (${c.id})`).join(`
`)}

`),d.length>0&&(o+=`[MODIFIED]
${d.map(c=>`~ ${c.type} (${c.id})`).join(`
`)}`),s.length===0&&r.length===0&&d.length===0&&(o+="(No changes detected)"),this.diffContent.textContent=o}setLoading(e){this.submitBtn.disabled=e,this.submitBtn.textContent=e?"Processing...":"Generate",this.input.disabled=e}}window.llmPrompt=new ms;class fs{constructor(){this.modal=document.getElementById("pageSettingsModal"),this.closeBtn=document.getElementById("pageSettingsClose"),this.saveBtn=document.getElementById("pageSettingsSave"),this.nameInput=document.getElementById("pageSettingsName"),this.refreshInput=document.getElementById("pageSettingsRefresh"),this.refreshModeInput=document.getElementById("pageSettingsRefreshMode"),this.refreshTimeInput=document.getElementById("pageSettingsRefreshTime"),this.fieldInterval=document.getElementById("field-refresh-interval"),this.fieldTime=document.getElementById("field-refresh-time"),this.darkModeInput=document.getElementById("pageSettingsDarkMode"),this.layoutModeInput=document.getElementById("pageSettingsLayoutMode"),this.gridSizeInput=document.getElementById("pageSettingsGridSize"),this.fieldGridSize=document.getElementById("field-grid-size"),this.pageIndex=-1}init(){this.modal&&(this.closeBtn&&this.closeBtn.addEventListener("click",()=>this.close()),this.saveBtn&&this.saveBtn.addEventListener("click",()=>this.save()),this.refreshModeInput&&this.refreshModeInput.addEventListener("change",()=>this.updateVisibility()),this.layoutModeInput&&this.layoutModeInput.addEventListener("change",()=>this.updateGridVisibility()))}updateVisibility(){if(!this.refreshModeInput)return;const e=this.refreshModeInput.value;this.fieldInterval&&(this.fieldInterval.style.display=e==="interval"?"block":"none"),this.fieldTime&&(this.fieldTime.style.display=e==="daily"?"block":"none")}updateGridVisibility(){if(!this.layoutModeInput||!this.fieldGridSize)return;const e=this.layoutModeInput.value;this.fieldGridSize.style.display=e==="grid"?"block":"none"}open(e){if(!this.modal)return;this.pageIndex=e;const i=h.pages[e];if(!i)return;this.nameInput&&(this.nameInput.value=i.name||"");const o=i.refresh_type||"interval";this.refreshModeInput&&(this.refreshModeInput.value=o),this.refreshInput&&(this.refreshInput.value=i.refresh_s||""),this.refreshTimeInput&&(this.refreshTimeInput.value=i.refresh_time||"08:00"),this.darkModeInput&&(this.darkModeInput.value=i.dark_mode||"inherit"),this.layoutModeInput&&(this.layoutModeInput.value=i.layout?"grid":"absolute"),this.gridSizeInput&&(this.gridSizeInput.value=i.layout||"4x4"),this.updateVisibility(),this.updateGridVisibility(),this.modal.classList.remove("hidden"),this.modal.style.display="flex"}close(){this.modal&&(this.modal.classList.add("hidden"),this.modal.style.display="none")}save(){if(this.pageIndex===-1)return;const e=h.pages[this.pageIndex];if(!e)return;const i=this.nameInput?this.nameInput.value:e.name,o=this.refreshModeInput?this.refreshModeInput.value:"interval",t=this.refreshInput?parseInt(this.refreshInput.value,10):NaN,n=this.refreshTimeInput?this.refreshTimeInput.value:"08:00",s=this.darkModeInput?this.darkModeInput.value:"inherit",r=this.layoutModeInput?this.layoutModeInput.value:"absolute",d=this.gridSizeInput?this.gridSizeInput.value.trim():"";e.name=i,e.refresh_type=o,o==="interval"?(!isNaN(t)&&t>=0?e.refresh_s=t:delete e.refresh_s,delete e.refresh_time):(e.refresh_time=n,delete e.refresh_s),e.dark_mode=s,r==="grid"&&/^\d+x\d+$/.test(d)?e.layout=d:e.layout=null,h.setPages(h.pages),q()&&typeof xe=="function"&&xe().then(()=>_.log("[PageSettings] Pages persisted to backend")).catch(c=>_.warn("[PageSettings] Failed to save pages to backend:",c)),this.close()}}class ys{constructor(){this.modal=null,this.currentLayoutId="reterminal_e1001",this.layouts=[]}init(){this.createModal(),this.bindButton(),_.log("[LayoutManager] Initialized")}bindButton(){const e=document.getElementById("manageLayoutsBtn");e&&e.addEventListener("click",()=>this.open())}createModal(){if(document.getElementById("layoutManagerModal")){this.modal=document.getElementById("layoutManagerModal");return}const e=document.createElement("div");e.id="layoutManagerModal",e.className="modal-backdrop hidden",e.innerHTML=`
            <div class="modal" style="max-width: 600px;">
                <div class="modal-header">
                    <div>ð Manage Layouts</div>
                    <button id="layoutManagerClose" class="btn btn-secondary">Ã</button>
                </div>
                <div class="modal-body">
                    <div class="layout-manager-current" style="margin-bottom: 12px; padding: 8px; background: var(--bg-subtle); border-radius: 4px;">
                        <span class="prop-label" style="font-size: 11px; color: var(--muted);">Current Layout:</span>
                        <span id="layoutManagerCurrentName" style="font-weight: 500; margin-left: 8px;">Loading...</span>
                    </div>
                    
                    <div class="layout-manager-list-container" style="max-height: 300px; overflow-y: auto; margin-bottom: 12px;">
                        <table class="layout-manager-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 1px solid var(--border);">
                                    <th style="text-align: left; padding: 8px 4px; font-size: 11px;">Name</th>
                                    <th style="text-align: left; padding: 8px 4px; font-size: 11px;">Device</th>
                                    <th style="text-align: left; padding: 8px 4px; font-size: 11px;">Pages</th>
                                    <th style="text-align: right; padding: 8px 4px; font-size: 11px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="layoutManagerTableBody">
                                <tr><td colspan="4" style="text-align: center; color: var(--muted); padding: 16px;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="layout-manager-actions" style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button id="layoutManagerNew" class="btn btn-primary" style="flex: 1;">+ New Layout</button>
                        <button id="layoutManagerImport" class="btn btn-secondary" style="flex: 1;">ð¥ Import from File</button>
                        <input type="file" id="layoutManagerFileInput" accept=".json" style="display: none;">
                    </div>
                    
                    <div id="layoutManagerStatus" class="layout-manager-status" style="margin-top: 8px; font-size: 11px; min-height: 20px;"></div>
                </div>
            </div>
        `,document.body.appendChild(e),this.modal=e,document.getElementById("layoutManagerClose").addEventListener("click",()=>this.close()),document.getElementById("layoutManagerNew").addEventListener("click",()=>this.showNewLayoutDialog()),document.getElementById("layoutManagerImport").addEventListener("click",()=>{document.getElementById("layoutManagerFileInput").click()}),document.getElementById("layoutManagerFileInput").addEventListener("change",i=>this.handleFileImport(i)),e.addEventListener("click",i=>{i.target===e&&this.close()})}async open(){this.modal||this.createModal(),this.modal.classList.remove("hidden"),await this.loadLayouts()}close(){this.modal&&this.modal.classList.add("hidden")}setStatus(e,i="info"){const o=document.getElementById("layoutManagerStatus");if(o){const t={success:"var(--success, #22c55e)",error:"var(--danger, #ef4444)",info:"var(--muted, #888)"};o.textContent=e,o.style.color=t[i]||t.info,e&&setTimeout(()=>{o.textContent=""},5e3)}}async loadLayouts(){if(typeof q!="function"||!q()){this.setStatus("Not connected to Home Assistant","error");return}try{const e=await fetch(`${Z}/layouts`,{headers:ie()});if(!e.ok)throw new Error(`Failed to load layouts: ${e.status}`);const i=await e.json();this.layouts=i.layouts||[],i.last_active_layout_id&&this.layouts.some(o=>o.id===i.last_active_layout_id)&&(!window.AppState?.currentLayoutId||window.AppState.currentLayoutId==="reterminal_e1001")&&this.layouts.find(t=>t.id===i.last_active_layout_id)&&i.last_active_layout_id!==window.AppState?.currentLayoutId&&(_.log(`[LayoutManager] Syncing to last active layout: ${i.last_active_layout_id}`),this.currentLayoutId=i.last_active_layout_id,window.AppState&&typeof window.AppState.setCurrentLayoutId=="function"&&window.AppState.setCurrentLayoutId(i.last_active_layout_id)),this.renderLayoutList()}catch(e){_.error("[LayoutManager] Error loading layouts:",e),this.setStatus("Failed to load layouts","error")}}renderLayoutList(){const e=document.getElementById("layoutManagerTableBody"),i=document.getElementById("layoutManagerCurrentName");if(!e)return;window.AppState&&window.AppState.currentLayoutId&&(this.currentLayoutId=window.AppState.currentLayoutId);const o=this.layouts.find(t=>t.id===this.currentLayoutId);if(i&&(i.textContent=o?o.name:this.currentLayoutId),this.layouts.length===0){e.innerHTML='<tr><td colspan="4" style="text-align: center; color: var(--muted); padding: 16px;">No layouts found</td></tr>';return}e.innerHTML=this.layouts.map(t=>{const n=t.id===this.currentLayoutId,s=this.layouts.filter(r=>r.name===t.name).length>1;return`
                <tr style="border-bottom: 1px solid var(--border-subtle); ${n?"background: var(--accent-soft);":""}">
                    <td style="padding: 8px 4px;">
                        <span style="font-weight: 500;">${this.escapeHtml(t.name)}</span>
                        ${n?'<span style="background: var(--accent); color: white; font-size: 9px; padding: 2px 4px; border-radius: 2px; margin-left: 4px;">current</span>':""}
                        ${s?'<br><span style="font-size: 9px; color: var(--muted);">'+this.escapeHtml(t.id)+"</span>":""}
                    </td>
                    <td style="padding: 8px 4px; font-size: 11px; color: var(--muted);">${this.getDeviceDisplayName(t.device_model||t.device_type)}</td>
                    <td style="padding: 8px 4px; font-size: 11px; color: var(--muted);">${t.page_count} pages</td>
                    <td style="padding: 8px 4px; text-align: right;">
                        <div style="display: flex; gap: 4px; justify-content: flex-end;">
                            ${n?"":`<button class="btn btn-sm btn-primary" style="font-size: 10px; padding: 4px 8px;" onclick="window.layoutManager.loadLayout('${t.id}')">Load</button>`}
                            <button class="btn btn-sm btn-secondary" style="font-size: 10px; padding: 4px 8px;" onclick="window.layoutManager.exportLayout('${t.id}')">ð¤</button>
                            ${!n&&this.layouts.length>1?`<button class="btn btn-sm btn-secondary" style="font-size: 10px; padding: 4px 8px; color: var(--danger);" onclick="window.layoutManager.deleteLayout('${t.id}', '${this.escapeHtml(t.name)}')">ð</button>`:""}
                        </div>
                    </td>
                </tr>
            `}).join("")}escapeHtml(e){const i=document.createElement("div");return i.textContent=e||"",i.innerHTML}getDeviceDisplayName(e){if(F&&F[e]){let t=F[e].name;return(Be||[]).includes(e)||(t+=" (untested)"),t}return{reterminal_e1001:"E1001 (Mono)",reterminal_e1002:"E1002 (Color)",trmnl:"TRMNL",esp32_s3_photopainter:"PhotoPainter (7-Color)"}[e]||e||"Unknown"}async loadLayout(e){if(!(typeof q!="function"||!q()))try{this.setStatus("Loading layout...","info");const i=await fetch(`${Z}/layouts/${e}`,{headers:ie()});if(!i.ok)throw new Error(`Failed to load layout: ${i.status}`);const o=await i.json();o.device_id||(o.device_id=e),this.currentLayoutId=e,window.AppState&&typeof window.AppState.setCurrentLayoutId=="function"&&(window.AppState.setCurrentLayoutId(e),_.log(`[LayoutManager] Set currentLayoutId to: ${e}`));const t=document.getElementById("canvas");if(t){const n=t.querySelector(".canvas-grid");t.innerHTML="",n&&t.appendChild(n),_.log("[LayoutManager] Cleared canvas before loading layout")}document.querySelectorAll(".graph-axis-label").forEach(n=>n.remove()),typeof re=="function"&&re(o),window.AppState&&window.AppState.currentLayoutId!==e&&(window.AppState.setCurrentLayoutId(e),_.log(`[LayoutManager] Re-set currentLayoutId to: ${e} (was changed by loadLayoutIntoState)`)),typeof D=="function"&&typeof A<"u"&&D(A.LAYOUT_IMPORTED,o),this.setStatus(`Loaded: ${o.name||e}`,"success"),this.renderLayoutList(),setTimeout(()=>this.close(),500)}catch(i){_.error("[LayoutManager] Error loading layout:",i),this.setStatus("Failed to load layout","error")}}async exportLayout(e){if(!(typeof q!="function"||!q()))try{const i=`${Z}/export?id=${e}`,o=document.createElement("a");o.href=i,o.download=`${e}_layout.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o),this.setStatus("Export started...","success")}catch(i){_.error("[LayoutManager] Error exporting layout:",i),this.setStatus("Failed to export layout","error")}}async deleteLayout(e,i){if(!(typeof q!="function"||!q()||!confirm(`Are you sure you want to delete "${i}"?

This cannot be undone.`)))try{const t=await fetch(`${Z}/layouts/${e}`,{method:"DELETE",headers:ie()});if(!t.ok){const n=await t.json().catch(()=>({}));if(n.error==="cannot_delete_last_layout"){this.setStatus("Cannot delete the last layout","error");return}throw new Error(n.error||`Delete failed: ${t.status}`)}this.setStatus(`Deleted: ${i}`,"success"),await this.loadLayouts()}catch(t){_.error("[LayoutManager] Error deleting layout:",t),this.setStatus("Failed to delete layout","error")}}showNewLayoutDialog(){if(!document.getElementById("newLayoutModal")){const t=document.createElement("div");t.id="newLayoutModal",t.className="modal-backdrop hidden",t.innerHTML=`
                <div class="modal" style="max-width: 400px;">
                    <div class="modal-header">
                        <div>Create New Layout</div>
                        <button id="newLayoutClose" class="btn btn-secondary">Ã</button>
                    </div>
                    <div class="modal-body">
                        <div class="field" style="margin-bottom: 12px;">
                            <div class="prop-label">Layout Name</div>
                            <input id="newLayoutName" class="prop-input" type="text" placeholder="e.g. Living Room Display" />
                        </div>
                        <div class="field">
                            <div class="prop-label">Device Type</div>
                            <select id="newLayoutDeviceType" class="prop-input">
                                ${this.generateDeviceOptions()}
                            </select>
                            <p class="hint" style="color: var(--muted); font-size: 11px; margin-top: 4px;">Select the device that will display this layout.</p>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button id="newLayoutCancel" class="btn btn-secondary">Cancel</button>
                        <button id="newLayoutConfirm" class="btn btn-primary">Create Layout</button>
                    </div>
                </div>
            `,document.body.appendChild(t),document.getElementById("newLayoutClose").addEventListener("click",()=>{t.classList.add("hidden")}),document.getElementById("newLayoutCancel").addEventListener("click",()=>{t.classList.add("hidden")}),document.getElementById("newLayoutConfirm").addEventListener("click",()=>{const n=document.getElementById("newLayoutName").value.trim(),s=document.getElementById("newLayoutDeviceType").value;if(!n){alert("Please enter a layout name.");return}t.classList.add("hidden"),this.createLayout(n,s)}),t.addEventListener("click",n=>{n.target===t&&t.classList.add("hidden")})}const i=`Layout ${this.layouts.length+1}`;document.getElementById("newLayoutName").value=i,h.deviceModel||h.settings&&h.settings.device_model;const o=F?Object.keys(F)[0]:"reterminal_e1001";document.getElementById("newLayoutDeviceType").value=o,document.getElementById("newLayoutModal").classList.remove("hidden")}generateDeviceOptions(){if(F){const e=Be||[];return Object.entries(F).map(([i,o])=>{let t=o.name;return e.includes(i)||(t+=" (untested)"),`<option value="${i}">${t}</option>`}).join("")}return'<option value="reterminal_e1001">reTerminal E1001</option>'}async createLayout(e,i="reterminal_e1001"){if(typeof q!="function"||!q())return;let o=e.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_]/g,"");o||(o="layout");const t=o+"_"+Date.now();try{const n=await fetch(`${Z}/layouts`,{method:"POST",headers:ie(),body:JSON.stringify({id:t,name:e,device_type:i,device_model:i})});if(!n.ok){const s=await n.json().catch(()=>({}));throw new Error(s.error||`Create failed: ${n.status}`)}this.setStatus(`Created: ${e}`,"success"),await this.loadLayouts(),window.AppState&&(window.AppState.setPages([{id:"page_0",name:"Page 1",widgets:[]}]),window.AppState.setCurrentPageIndex(0),_.log("[LayoutManager] Cleared state before loading new layout")),await this.loadLayout(t),window.AppState&&(window.AppState.setDeviceModel(i),window.AppState.settings&&(window.AppState.settings.device_model=i),window.currentDeviceModel=i,typeof D=="function"&&typeof A<"u"&&D(A.STATE_CHANGED),_.log(`[LayoutManager] Created layout '${t}' with device_model: ${i}, pages: ${window.AppState.pages?.length}, widgets: ${window.AppState.getCurrentPage()?.widgets?.length||0}`))}catch(n){_.error("[LayoutManager] Error creating layout:",n),this.setStatus("Failed to create layout","error")}}async handleFileImport(e){const i=e.target.files[0];if(i){try{const o=await i.text(),t=JSON.parse(o);if(!t.pages&&!t.device_id){this.setStatus("Invalid layout file","error");return}await this.importLayout(t)}catch(o){_.error("[LayoutManager] Error importing file:",o),this.setStatus("Failed to import file: "+o.message,"error")}e.target.value=""}}async importLayout(e,i=!1){if(!(typeof q!="function"||!q()))try{const o=`${Z}/import${i?"?overwrite=true":""}`,t=await fetch(o,{method:"POST",headers:ie(),body:JSON.stringify(e)}),n=await t.json();if(!t.ok){if(n.error==="layout_exists"){if(confirm(`A layout with ID "${n.existing_id}" already exists.

Do you want to overwrite it?`)){await this.importLayout(e,!0);return}return}throw new Error(n.error||`Import failed: ${t.status}`)}this.setStatus(`Imported: ${n.name||n.id}`,"success"),await this.loadLayouts()}catch(o){_.error("[LayoutManager] Error importing layout:",o),this.setStatus("Failed to import layout","error")}}}window.layoutManager=new ys;function mt(){const l=document.getElementById("resizer-left"),e=document.getElementById("resizer-right"),i=document.querySelector(".sidebar"),o=document.querySelector(".right-panel");if(document.querySelector(".app-content"),!l||!e||!i||!o){_.warn("[Splitters] Layout elements not found, retrying..."),setTimeout(mt,500);return}_.log("[Splitters] Initializing draggable panels...");function t(r,d,c){let a,u;r.addEventListener("mousedown",function(m){c==="vertical"?(a=m.clientX,u=d.offsetWidth,document.body.style.cursor="col-resize"):(a=m.clientY,u=d.offsetHeight,document.body.style.cursor="row-resize"),r.classList.add("dragging"),document.body.style.userSelect="none";function g(v){let b;if(c==="vertical"){b=v.clientX-a,r.id==="resizer-right"&&(b=-b);const E=u+b,y=parseInt(getComputedStyle(d).minWidth)||100,S=parseInt(getComputedStyle(d).maxWidth)||800;E>=y&&E<=S&&(d.style.width=E+"px")}else{b=a-v.clientY;const E=u+b,y=parseInt(getComputedStyle(d).minHeight)||50,S=parseInt(getComputedStyle(d).maxHeight)||800;E>=y&&E<=S&&(d.style.height=E+"px")}window.dispatchEvent&&window.dispatchEvent(new Event("resize"))}function f(){r.classList.remove("dragging"),document.body.style.cursor="default",document.body.style.userSelect="",window.removeEventListener("mousemove",g),window.removeEventListener("mouseup",f)}window.addEventListener("mousemove",g),window.addEventListener("mouseup",f)})}const n=document.getElementById("resizer-bottom"),s=document.querySelector(".code-panel");t(l,i,"vertical"),t(e,o,"vertical"),n&&s&&t(n,s,"horizontal")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",mt):mt();function Ht(){_.log("[ModalWiring] Initializing modal buttons...");const l=document.getElementById("deviceSettingsBtn"),e=document.getElementById("deviceSettingsModal"),i=document.getElementById("deviceSettingsClose"),o=document.getElementById("deviceSettingsSave"),t=document.getElementById("deviceName"),n=document.getElementById("deviceModel"),s=document.getElementById("deviceOrientation"),r=document.getElementById("deviceDarkMode"),d=document.getElementById("mode-standard"),c=document.getElementById("setting-sleep-enabled"),a=document.getElementById("setting-manual-refresh"),u=document.getElementById("setting-deep-sleep-enabled"),m=document.getElementById("sleep-times-row"),g=document.getElementById("deep-sleep-interval-row"),f=document.getElementById("setting-sleep-start"),v=document.getElementById("setting-sleep-end"),b=document.getElementById("setting-deep-sleep-interval");function E(){_.log("[ModalWiring] Opening device settings");const M=window.AppState?h.settings:{},X=window.AppState?h.settings.device_name:"reTerminal E1001";t&&(t.value=X||"reTerminal E1001"),n&&(n.value=window.currentDeviceModel||"reterminal_e1001"),s&&(s.value=M.orientation||"landscape"),r&&(r.checked=!!M.dark_mode);const K=!!M.sleep_enabled,j=!!M.manual_refresh_only,p=!!M.deep_sleep_enabled,w=!K&&!j&&!p;d&&(d.checked=w),c&&(c.checked=K),a&&(a.checked=j),u&&(u.checked=p),f&&(f.value=M.sleep_start_hour??0),v&&(v.value=M.sleep_end_hour??5),b&&(b.value=M.deep_sleep_interval??600),m&&(m.style.display=K?"flex":"none"),g&&(g.style.display=p?"flex":"none"),e.classList.remove("hidden"),e.style.display="flex"}function y(){e.style.display="none",e.classList.add("hidden")}l&&l.addEventListener("click",E),i&&i.addEventListener("click",y),o&&o.addEventListener("click",y),c&&c.addEventListener("change",()=>{m&&(m.style.display=c.checked?"flex":"none")}),u&&u.addEventListener("change",()=>{g&&(g.style.display=u.checked?"flex":"none")});const S=document.getElementById("editorSettingsBtn"),T=document.getElementById("editorSettingsModal"),R=document.getElementById("editorSettingsClose"),B=document.getElementById("editorSettingsDone");function k(){_.log("[ModalWiring] Opening editor settings"),T.classList.remove("hidden")}function I(){T.classList.add("hidden")}S&&S.addEventListener("click",k),R&&R.addEventListener("click",I),B&&B.addEventListener("click",I);const L=document.getElementById("pageSettingsClose"),H=document.getElementById("pageSettingsSave"),N=document.getElementById("pageSettingsModal");function $(){N&&(N.classList.add("hidden"),N.style.display="none"),window.currentPageSettingsTarget=null}L&&L.addEventListener("click",$),H&&H.addEventListener("click",$),_.log("[ModalWiring] Modal buttons initialized")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ht):Ht();class _s{constructor(){this.isOpen=!1,this.selectedIndex=0,this.filteredWidgets=[],this.allWidgets=[],this.modal=null,this.input=null,this.resultsContainer=null,this.init()}init(){this.createModal(),this.bindEvents()}discoverWidgets(){this.allWidgets=[];const e=document.querySelectorAll(".widget-category .item[data-widget-type]");if(e.length===0){_.warn("[QuickSearch] No widgets found in palette");return}e.forEach(i=>{const o=i.getAttribute("data-widget-type"),t=i.querySelector(".label"),n=t?t.textContent.trim():o,s=i.closest(".widget-category"),r=s?s.querySelector(".category-name"):null,d=r?r.textContent.trim():"Widgets";this.allWidgets.push({type:o,label:n,category:d,searchText:`${n} ${o} ${d}`.toLowerCase()})}),_.log(`[QuickSearch] Discovered ${this.allWidgets.length} widgets`)}createModal(){this.modal=document.createElement("div"),this.modal.id="quick-search-modal",this.modal.className="quick-search-modal hidden",this.modal.innerHTML=`
            <div class="quick-search-backdrop"></div>
            <div class="quick-search-container">
                <div class="quick-search-header">
                    <span class="quick-search-icon">ð</span>
                    <input type="text" class="quick-search-input" placeholder="Search widgets..." autocomplete="off" />
                </div>
                <div class="quick-search-results"></div>
                <div class="quick-search-hint">
                    <span>ââ Navigate</span>
                    <span>âµ Add Widget</span>
                    <span>Esc Close</span>
                </div>
            </div>
        `,document.body.appendChild(this.modal),this.input=this.modal.querySelector(".quick-search-input"),this.resultsContainer=this.modal.querySelector(".quick-search-results")}bindEvents(){this.modal.querySelector(".quick-search-backdrop").addEventListener("click",()=>this.close()),this.input.addEventListener("input",()=>this.handleSearch()),this.input.addEventListener("keydown",e=>this.handleKeyDown(e))}open(){this.discoverWidgets(),this.isOpen=!0,this.modal.classList.remove("hidden"),this.input.value="",this.selectedIndex=0,this.handleSearch(),setTimeout(()=>this.input.focus(),50)}close(){this.isOpen=!1,this.modal.classList.add("hidden"),this.input.blur()}handleSearch(){const e=this.input.value.toLowerCase().trim();e===""?this.filteredWidgets=[...this.allWidgets]:this.filteredWidgets=this.allWidgets.filter(i=>i.searchText.includes(e)),this.selectedIndex=0,this.renderResults()}renderResults(){if(this.filteredWidgets.length===0){this.resultsContainer.innerHTML=`
                <div class="quick-search-empty">No widgets found</div>
            `;return}this.resultsContainer.innerHTML=this.filteredWidgets.map((i,o)=>`
            <div class="quick-search-item ${o===this.selectedIndex?"selected":""}" 
                 data-index="${o}" data-type="${i.type}">
                <span class="quick-search-item-label">${i.label}</span>
                <span class="quick-search-item-category">${i.category}</span>
            </div>
        `).join(""),this.resultsContainer.querySelectorAll(".quick-search-item").forEach(i=>{i.addEventListener("click",()=>{const o=parseInt(i.getAttribute("data-index"),10);this.selectedIndex=o,this.addSelectedWidget()})});const e=this.resultsContainer.querySelector(".quick-search-item.selected");e&&e.scrollIntoView({block:"nearest"})}handleKeyDown(e){switch(e.key){case"ArrowDown":e.preventDefault(),this.selectedIndex=Math.min(this.selectedIndex+1,this.filteredWidgets.length-1),this.renderResults();break;case"ArrowUp":e.preventDefault(),this.selectedIndex=Math.max(this.selectedIndex-1,0),this.renderResults();break;case"Enter":e.preventDefault(),this.addSelectedWidget();break;case"Escape":e.preventDefault(),this.close();break}}addSelectedWidget(){if(this.filteredWidgets.length===0)return;const e=this.filteredWidgets[this.selectedIndex];if(e)try{const i=WidgetFactory.createWidget(e.type);AppState.addWidget(i),_.log(`[QuickSearch] Added widget: ${e.label}`),this.close()}catch(i){_.error("[QuickSearch] Error adding widget:",i),AppState.notify("Failed to add widget: "+i.message,"error")}}}class bs{constructor(){this.active=!1,this.element=null,this.targetWidgetId=null,this.position={x:0,y:0},this.init()}init(){this.element||(this.element=document.createElement("div"),this.element.className="radial-menu",this.element.innerHTML=`
                <div class="radial-menu-center"></div>
                <div class="radial-menu-items"></div>
            `,document.body.appendChild(this.element),window.addEventListener("mousedown",e=>{this.active&&!this.element.contains(e.target)&&this.hide()},!0),window.addEventListener("keydown",e=>{e.key==="Escape"&&this.active&&this.hide()}))}show(e,i,o=null){this.targetWidgetId=o,this.position={x:e,y:i},this.active=!0,this.element.style.left=`${e}px`,this.element.style.top=`${i}px`,this.renderItems(),requestAnimationFrame(()=>{this.element.classList.add("active")})}hide(){this.active=!1,this.element.classList.remove("active"),this.targetWidgetId=null}renderItems(){const e=this.element.querySelector(".radial-menu-items");e.innerHTML="";const i=this.getAvailableActions(),o=2*Math.PI/i.length,t=70;i.forEach((n,s)=>{const r=s*o-Math.PI/2,d=Math.cos(r)*t,c=Math.sin(r)*t,a=document.createElement("div");a.className=`radial-menu-item ${n.className||""}`,a.style.setProperty("--x",`${d}px`),a.style.setProperty("--y",`${c}px`),a.title=n.label,a.innerHTML=`<i class="mdi ${n.icon}"></i>`,a.addEventListener("click",u=>{u.stopPropagation(),n.callback(),this.hide()}),e.appendChild(a)})}getAvailableActions(){const e=h,i=this.targetWidgetId?e.getWidgetById(this.targetWidgetId):null,o=[];if(i){o.push({label:"Copy",icon:"mdi-content-copy",callback:()=>{e.selectWidget(this.targetWidgetId,!1),e.copyWidget()}});const t=e.selectedWidgetIds,n=t.some(d=>{const c=e.getWidgetById(d);return c&&(c.type==="group"||c.parentId)});t.length>1&&!n&&o.push({label:"Group",icon:"mdi-group",callback:()=>e.groupSelection()}),(i.type==="group"||i.parentId)&&o.push({label:"Ungroup",icon:"mdi-ungroup",callback:()=>e.ungroupSelection(this.targetWidgetId)}),o.push({label:"Duplicate",icon:"mdi-content-duplicate",callback:()=>{e.copyWidget(),e.pasteWidget()}}),o.push({label:i.locked?"Unlock":"Lock",icon:i.locked?"mdi-lock-open-outline":"mdi-lock-outline",callback:()=>{e.updateWidget(this.targetWidgetId,{locked:!i.locked})}}),o.push({label:"Snap",icon:"mdi-magnet",callback:()=>{zi(this.targetWidgetId)}}),o.push({label:"Delete",icon:"mdi-delete-outline",className:"danger",callback:()=>{e.deleteWidget(this.targetWidgetId)}});const s=e.getCurrentPage(),r=s?.widgets.findIndex(d=>d.id===this.targetWidgetId);r!==-1&&(o.push({label:"Bring to Front",icon:"mdi-arrange-bring-to-front",callback:()=>{e.reorderWidget(e.currentPageIndex,r,s.widgets.length-1)}}),o.push({label:"Send to Back",icon:"mdi-arrange-send-to-back",callback:()=>{e.reorderWidget(e.currentPageIndex,r,0)}}))}else o.push({label:"Paste",icon:"mdi-content-paste",callback:()=>{e.pasteWidget()}});return o}}window.RadialMenu=new bs;class vs{constructor(){this.patterns=[{name:"comment",regex:/(#.*)/g},{name:"key",regex:/^(\s*)([^:\n]+)(:)/gm},{name:"string",regex:/("[^"]*"|'[^']*')/g},{name:"value",regex:/\b(true|false|null|[0-9]+(\.[0-9]+)?)\b/g},{name:"keyword",regex:/\b(lambda|script|on_.*|if|then|else|wait_until|delay)\b/g},{name:"tag",regex:/(![a-z_]+)/g}]}highlight(e){if(!e)return"";let i=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");const o=/^(\s*(?:-\s+)?)([^:\n]+)(:)|(#.*)|("[^"]*"|'[^']*')|(![a-z_]+)|\b(lambda|script|on_[a-z_]+|if|then|else|wait_until|delay)\b|\b(true|false|null|[0-9]+(?:\.[0-9]+)?)\b|(\|[-+]?|>[-+]?)/gm;return i.replace(o,(t,n,s,r,d,c,a,u,m,g)=>n!==void 0?`${n}<span class="hl-key">${s}</span><span class="hl-punc">${r}</span>`:d!==void 0?`<span class="hl-comment">${d}</span>`:c!==void 0?`<span class="hl-string">${c}</span>`:a!==void 0?`<span class="hl-tag">${a}</span>`:g!==void 0?`<span class="hl-punc">${g}</span>`:u!==void 0?`<span class="hl-keyword">${u}</span>`:m!==void 0?`<span class="hl-value">${m}</span>`:t)}}class ws{constructor(e){this.adapter=e,this.highlighter=new vs,this.suppressSnippetUpdate=!1,this.snippetDebounceTimer=null,this.lastGeneratedYaml="",this.isHighlighted=localStorage.getItem("esphome_designer_yaml_highlight")!=="false",this.init()}init(){this.bindEvents(),this.setupAutoUpdate(),this.setupScrollSync(),this.updateSnippetBox()}bindEvents(){const e=document.getElementById("fullscreenSnippetBtn");e&&e.addEventListener("click",()=>{this.openSnippetModal()});const i=document.getElementById("snippetFullscreenClose");i&&i.addEventListener("click",()=>{const a=document.getElementById("snippetFullscreenModal");a&&a.classList.add("hidden")});const o=document.getElementById("importSnippetConfirm");o&&o.addEventListener("click",async()=>{await this.handleImportSnippet()});const t=document.getElementById("updateLayoutBtn");t&&t.addEventListener("click",async()=>{await this.handleUpdateLayoutFromSnippetBox()});const n=document.getElementById("copySnippetBtn");n&&n.addEventListener("click",async()=>{this.copySnippetToClipboard(n)});const s=document.getElementById("toggleYamlBtn"),r=document.querySelector(".code-panel");s&&r&&(localStorage.getItem("esphome_designer_yaml_collapsed")==="true"&&r.classList.add("collapsed"),s.addEventListener("click",()=>{const u=r.classList.toggle("collapsed");localStorage.setItem("esphome_designer_yaml_collapsed",u),window.dispatchEvent(new Event("resize"))}));const d=document.getElementById("toggleHighlightBtn");document.querySelector(".snippet-container"),d&&(document.querySelectorAll(".snippet-container").forEach(a=>{a.classList.toggle("highlighted",this.isHighlighted)}),document.querySelectorAll('[id*="ToggleHighlightBtn"]').forEach(a=>{a.classList.toggle("active",this.isHighlighted)}),d.addEventListener("click",()=>{this.isHighlighted=!this.isHighlighted,localStorage.setItem("esphome_designer_yaml_highlight",this.isHighlighted),document.querySelectorAll(".snippet-container").forEach(a=>{a.classList.toggle("highlighted",this.isHighlighted)}),document.querySelectorAll('[id*="ToggleHighlightBtn"]').forEach(a=>{a.classList.toggle("active",this.isHighlighted)}),this.isHighlighted&&this.updateHighlightLayer()}));const c=document.getElementById("snippetBox");c&&c.addEventListener("input",()=>{this.isHighlighted&&this.updateHighlightLayer()})}setupScrollSync(){const e=document.getElementById("snippetBox"),i=document.getElementById("highlightLayer");e&&i&&e.addEventListener("scroll",()=>{i.scrollTop=e.scrollTop,i.scrollLeft=e.scrollLeft})}setupAutoUpdate(){Q(A.STATE_CHANGED,()=>{this.suppressSnippetUpdate||this.updateSnippetBox()}),Q(A.SELECTION_CHANGED,e=>{const i=e&&e.widgetIds?e.widgetIds:[];typeof Te=="function"&&Te(i)})}updateHighlightLayer(){if(!this.isHighlighted)return;const e=document.getElementById("snippetBox"),i=document.getElementById("highlightLayer");e&&i&&(i.innerHTML=this.highlighter.highlight(e.value));const o=document.getElementById("snippetFullscreenHighlight"),t=document.getElementById("snippetFullscreenContent");if(o&&t){const n=t.querySelector("textarea");n&&(o.innerHTML=this.highlighter.highlight(n.value))}}updateSnippetBox(){const e=document.getElementById("snippetBox");e&&(this.snippetDebounceTimer&&clearTimeout(this.snippetDebounceTimer),this.snippetDebounceTimer=setTimeout(()=>{if(!this.suppressSnippetUpdate)try{const i=window.AppState?window.AppState.getPagesPayload():{pages:[]};this.adapter.generate(i).then(o=>{this.lastGeneratedYaml=o,e.value=o,this.isHighlighted&&this.updateHighlightLayer();const t=window.AppState?window.AppState.selectedWidgetIds:[];typeof Te=="function"&&Te(t)}).catch(o=>{_.error("Error generating snippet via adapter:",o),e.value="# Error generating YAML (adapter): "+o.message,this.isHighlighted&&this.updateHighlightLayer()})}catch(i){_.error("Error generating snippet:",i),e.value="# Error generating YAML: "+i.message,this.isHighlighted&&this.updateHighlightLayer()}},50))}openSnippetModal(){const e=document.getElementById("snippetFullscreenModal"),i=document.getElementById("snippetFullscreenContainer"),o=document.getElementById("snippetFullscreenContent"),t=document.getElementById("snippetFullscreenHighlight"),n=document.getElementById("snippetBox"),s=document.getElementById("toggleFullscreenHighlightBtn");if(!e||!i||!o||!t||!n)return;i.classList.toggle("highlighted",this.isHighlighted),s&&s.classList.toggle("active",this.isHighlighted),s&&!s.hasListener&&(s.addEventListener("click",()=>{this.isHighlighted=!this.isHighlighted,localStorage.setItem("esphome_designer_yaml_highlight",this.isHighlighted);const d=document.querySelector(".snippet-container"),c=document.getElementById("toggleHighlightBtn");d&&d.classList.toggle("highlighted",this.isHighlighted),c&&c.classList.toggle("active",this.isHighlighted),i.classList.toggle("highlighted",this.isHighlighted),s.classList.toggle("active",this.isHighlighted),this.isHighlighted&&(t.innerHTML=this.highlighter.highlight(r.value),this.updateHighlightLayer())}),s.hasListener=!0);let r=o.querySelector("textarea");if(!r){o.innerHTML="",r=document.createElement("textarea"),r.className="snippet-box",r.style.width="100%",r.style.height="100%",r.style.background="transparent",r.spellcheck=!1,o.appendChild(r),r.addEventListener("scroll",()=>{t.scrollTop=r.scrollTop,t.scrollLeft=r.scrollLeft}),r.addEventListener("input",()=>{this.isHighlighted&&(t.innerHTML=this.highlighter.highlight(r.value))});let d=e.querySelector(".modal-actions");if(d&&!d.querySelector("#fullscreenUpdateBtn")){const c=document.createElement("button");c.id="fullscreenUpdateBtn",c.className="btn btn-primary",c.textContent="Update Layout from YAML",c.onclick=()=>{n.value=r.value,this.handleUpdateLayoutFromSnippetBox(),e.classList.add("hidden")},d.insertBefore(c,d.firstChild)}}r.value=n.value||"",this.isHighlighted&&(t.innerHTML=this.highlighter.highlight(r.value),setTimeout(()=>{t.scrollTop=r.scrollTop,t.scrollLeft=r.scrollLeft},50)),e.style.display="",e.classList.remove("hidden")}async handleImportSnippet(){const e=document.getElementById("importSnippetTextarea"),i=document.getElementById("importSnippetError");if(!e)return;const o=e.value;if(o.trim())try{i&&(i.textContent="");let t;try{t=Pt(o),_.log("[handleImportSnippet] Successfully used offline parser.")}catch(s){if(_.warn("[handleImportSnippet] Offline parser failed, falling back to backend:",s),q())t=await Ii(o);else throw s}re(t);const n=document.getElementById("importSnippetModal");n&&(n.classList.add("hidden"),n.style.display="none"),G("Layout imported successfully","success")}catch(t){_.error("Import failed:",t),i&&(i.textContent=`Error: ${t.message}`)}}async handleUpdateLayoutFromSnippetBox(){const e=document.getElementById("snippetBox");if(!e)return;const i=e.value;if(i.trim()){if(this.lastGeneratedYaml&&i.trim()===this.lastGeneratedYaml.trim()){_.log("[handleUpdateLayoutFromSnippetBox] Skipping update: Snippet matches last generated state.");return}try{const o=window.AppState?.currentLayoutId||"reterminal_e1001",t=window.AppState?.deviceName||"Layout 1",n=window.AppState?.deviceModel||window.AppState?.settings?.device_model||"reterminal_e1001";_.log(`[handleUpdateLayoutFromSnippetBox] Preserving context - ID: ${o}, Name: ${t}`);let s=Pt(i);s.device_id=o,s.name=t,s.device_model=n,s.settings||(s.settings={}),s.settings.device_model=n,s.settings.device_name=t;const r=window.AppState?.settings?.dark_mode||!1;s.settings.dark_mode=r,this.suppressSnippetUpdate=!0,this.snippetDebounceTimer&&(clearTimeout(this.snippetDebounceTimer),this.snippetDebounceTimer=null),re(s),setTimeout(()=>{this.suppressSnippetUpdate=!1},1500),G("Layout updated from YAML","success"),(i.includes("lambda:")||i.includes("script:"))&&setTimeout(()=>{G("Note: Custom C++ (lambda/script) may not fully preview.","warning",4e3)},800)}catch(o){_.error("Update layout failed:",o),G(`Update failed: ${o.message}`,"error"),this.suppressSnippetUpdate=!1}}}async copySnippetToClipboard(e){const i=document.getElementById("snippetBox");if(!i)return;const o=i.value||"",t=e.textContent,n=()=>{e.textContent="Copied!",e.style.minWidth=e.offsetWidth+"px",setTimeout(()=>{e.textContent=t,e.style.minWidth=""},2e3)};try{if(navigator.clipboard&&window.isSecureContext)await navigator.clipboard.writeText(o),G("Snippet copied to clipboard","success"),n();else{const s=document.createElement("textarea");s.value=o,s.style.position="fixed",s.style.left="-999999px",s.style.top="-999999px",document.body.appendChild(s),s.focus(),s.select();try{document.execCommand("copy"),G("Snippet copied to clipboard","success"),n()}catch{G("Unable to copy. Try selecting and copying manually.","error")}document.body.removeChild(s)}}catch(s){_.error("Copy failed:",s),G("Unable to copy snippet","error")}}}class di extends Ce{constructor(){super(),this.fonts=new ai,this.yaml=new li,this.reset()}reset(){this.fonts&&this.fonts.reset(),this.usedPlugins=new Set}async generate(e){if(!e)return console.error("ESPHomeAdapter: Missing layout"),"";this.reset();const i=e.pages||[],o=e.deviceModel||(h?h.deviceModel:null)||window.currentDeviceModel||"reterminal_e1001",t=F||{},n=window.DEVICE_PROFILES||{};let r={...t,...n}[o]||{};if(o==="custom"&&e.customHardware){const y=e.customHardware;r={id:"custom",name:"Custom Device",chip:y.chip||"esp32-s3",displayPlatform:y.displayDriver||"generic_st7789",resolution:{width:y.resWidth||800,height:y.resHeight||480},shape:y.shape||"rect",pins:{i2c:y.pins?.sda?{sda:y.pins.sda,scl:y.pins.scl}:null,spi:y.pins?.clk?{clk:y.pins.clk,mosi:y.pins.mosi}:null,display:{cs:y.pins?.cs,dc:y.pins?.dc,reset:y.pins?.rst,busy:y.pins?.busy}},features:{psram:!!y.psram,lcd:y.tech==="lcd",epaper:y.tech==="epaper",touch:y.touchTech&&y.touchTech!=="none"},backlight:y.pins?.backlight?{platform:"gpio",pin:y.pins.backlight}:null,touch:y.touchTech&&y.touchTech!=="none"?{platform:y.touchTech,sda:y.pins?.sda,scl:y.pins?.scl,interrupt_pin:y.pins?.touch_int,reset_pin:y.pins?.touch_rst}:null}}let d=!!(r.features&&(r.features.lvgl||r.features.lv_display));const c=e.renderingMode||(h?h.settings?.renderingMode:null);if(c==="direct"?(d=!1,_.log("[ESPHomeAdapter] Rendering mode set to 'direct', skipping LVGL generation")):c==="lvgl"&&(d=!0,_.log("[ESPHomeAdapter] Rendering mode set to 'lvgl', forcing LVGL generation")),!d)for(const y of i){if(y.widgets){for(const S of y.widgets.filter(T=>!T.hidden))if(S.type.startsWith("lvgl_")){d=!0;break}}if(d)break}const a=[];r.isPackageBased||(a.push(...this.yaml.generateInstructionHeader(r,e)),a.push(""));const u=r.features?.lcd?"my_display":"epaper_display";this.fonts.addFont("Roboto",400,20),this.preProcessWidgetsPromise=this.preProcessWidgets(i),await this.preProcessWidgetsPromise;let m=null;r.isPackageBased&&(r.isOfflineImport&&r.content?m=r.content:r.hardwarePackage&&(m=await this.fetchHardwarePackage(r.hardwarePackage)));const g=[];i.forEach((y,S)=>{y.widgets&&y.widgets.forEach(T=>{T.hidden||(T._pageIndex=S,g.push(T))})});const f={widgets:g,profile:r,displayId:u,adapter:this,isLvgl:d};if(Y){const y=[];y.push("- id: display_page","  type: int","  restore_value: true","  initial_value: '0'");const S=!!(r.features&&r.features.epaper),T=!!(r.features&&r.features.lcd)||!S,R=e.refreshInterval||(T?60:e.deepSleepInterval||600);y.push("- id: page_refresh_default_s","  type: int","  restore_value: true",`  initial_value: '${R}'`),y.push("- id: page_refresh_current_s","  type: int","  restore_value: false","  initial_value: '60'"),y.push("- id: last_page_switch_time","  type: uint32_t","  restore_value: false","  initial_value: '0'"),Y.onExportGlobals({...f,lines:y}),y.length>0&&(a.push("globals:"),a.push(...y.map(w=>"  "+w))),!r.isPackageBased&&Ge&&a.push(...Ge(r)),r.isPackageBased?a.some(C=>String(C).split(`
`).some(P=>P.trim()==="time:"))||a.push("time:","  - platform: homeassistant","    id: ha_time"):(a.push("http_request:","  verify_ssl: false","  timeout: 20s"),We&&a.push(...We(r)),Ne&&a.push(...Ne(r)),Oe&&a.push(...Oe(r)),je&&a.push(...je(r)),Ue&&a.push(...Ue(r)),De&&a.push(...De(r)),Ye&&a.push(...Ye(r)),Ve&&a.push(...Ve(r)),a.some(C=>String(C).split(`
`).some(P=>P.trim()==="time:"))||a.push("time:","  - platform: homeassistant","    id: ha_time")),He&&a.push(...He(r,[],u,g));const B=[];Y.onExportNumericSensors({...f,lines:B,mainLines:a}),B.length>0&&(a.some(w=>w==="sensor:")||a.push("sensor:"),a.push(...B.flatMap(w=>w.split(`
`).map(C=>"  "+C))));const k=i.flatMap(w=>w.widgets||[]),I=new Set,L=[];B.forEach(w=>{if(w.includes("entity_id:")){const C=w.match(/entity_id:\s*(.+)/);C&&I.add(C[1].trim())}}),k.forEach(w=>{let C=(w.entity_id||"").trim();const P=w.props||{};if(!C||P.is_local_sensor)return;["progress_bar","sensor_text","graph","battery_icon","wifi_signal","ondevice_temperature","ondevice_humidity"].includes(w.type)&&!C.includes(".")&&(C=`sensor.${C}`);const ee=C.includes(".")&&!C.startsWith("weather.")&&!C.startsWith("text_sensor.")&&!C.startsWith("binary_sensor."),O=["switch.","light.","fan.","input_boolean.","cover.","lock."].some(z=>C.startsWith(z));if(ee&&!O&&!I.has(C)){I.add(C);const z=C.replace(/[^a-zA-Z0-9_]/g,"_");L.push("- platform: homeassistant"),L.push(`  id: ${z}`),L.push(`  entity_id: ${C}`),L.push("  internal: true")}}),L.length>0&&(a.some(w=>w==="sensor:")||a.push("sensor:"),a.push(...L.flatMap(w=>w.split(`
`).map(C=>"  "+C))));const H=[];Y.onExportTextSensors({...f,lines:H}),H.length>0&&(a.push("text_sensor:"),a.push(...H.flatMap(w=>w.split(`
`).map(C=>"  "+C))));const N=[];if(!r.isPackageBased&&Fe){const w=Fe(r,i.length,u,[]);w.length>0&&w[0].trim()==="binary_sensor:"?N.push(...w.slice(1).map(C=>C.startsWith("  ")?C.slice(2):C)):N.push(...w)}Y.onExportBinarySensors({...f,lines:N}),N.length>0&&(a.push("binary_sensor:"),a.push(...N.flatMap(w=>w.split(`
`).map(C=>"  "+C))));const $=i.flatMap(w=>w.widgets||[]),M=new Set,X=["binary_sensor.","switch.","light.","input_boolean.","fan.","cover.","vacuum.","lock."],K=[];if(N.forEach(w=>{if(w.includes("entity_id:")){const C=w.match(/entity_id:\s*(.+)/);C&&M.add(C[1].trim())}}),$.forEach(w=>{const C=(w.condition_entity||"").trim(),P=(w.entity_id||"").trim();[C,P].forEach(x=>{if(!x)return;if(X.some(U=>x.startsWith(U))&&!M.has(x)){M.add(x);const U=x.replace(/[^a-zA-Z0-9_]/g,"_");K.push("- platform: homeassistant"),K.push(`  id: ${U}`),K.push(`  entity_id: ${x}`),K.push("  internal: true")}})}),K.length>0&&(a.some(w=>w==="binary_sensor:")||a.push("binary_sensor:"),a.push(...K.flatMap(w=>w.split(`
`).map(C=>"  "+C)))),!r.isPackageBased&&ze){const w=ze(r,i.length,u);w.length>0&&a.push(...w)}const j=Y.getAll(),p=["image","online_image","graph","qr_code"];j.sort((w,C)=>{const P=p.indexOf(w.id),x=p.indexOf(C.id);return P!==-1&&x!==-1?P-x:P!==-1?-1:x!==-1?1:w.id.localeCompare(C.id)}),j.forEach(w=>w.onExportComponents&&w.onExportComponents({...f,lines:a}))}const v=this.generateDisplayLambda(i,e,r);a.push(...this.fonts.getLines());const b=this.yaml.generateScriptSection(e,i,r);if(b.length>0&&a.push(...b),d&&be){const y=be(i,o);y&&y.length>0&&a.push(...y)}const E=d&&be;if(r.isPackageBased){if(m){const y=/^(\s*)# __LAMBDA_PLACEHOLDER__/m,S=m.match(y);if(S){const T=S[1],R="# __LAMBDA_PLACEHOLDER__",B=new RegExp(`lambda:\\s*\\|-\\s*[\\r\\n]+\\s*${R.replace("#","\\#")}`).test(m);if(E)m=m.replace(y,"");else{const k=(B?"":T+`lambda: |-
`)+v.map(I=>T+"  "+I).join(`
`);m=m.replace(y,k)}}return m=this.applyPackageOverrides(m,r,e.orientation),this.sanitizePackageContent(m)+`

`+a.join(`
`)}}else{const y=$e?$e(r,e.orientation):[];a.push(...y);for(let S=0;S<a.length;S++)if(a[S].trim()==="display:"){let T=S+1;for(;T<a.length&&(a[T].startsWith("  ")||a[T].trim()==="");)T++;E||a.splice(T,0,"    lambda: |-",...v.map(R=>"      "+R));break}}return a.join(`
`)}async preProcessWidgets(e){for(const i of e)if(i.widgets)for(const o of i.widgets.filter(t=>!t.hidden&&t.type!=="group")){const t=o.type,n=Y?await Y.load(t):null;n&&(this.usedPlugins.add(n),typeof n.collectRequirements=="function"&&n.collectRequirements(o,{trackIcon:(s,r)=>this.fonts.trackIcon(s,r),addFont:(s,r,d,c)=>this.fonts.addFont(s,r,d,c)}))}}generateDisplayLambda(e,i,o){const t=[],n=o.features?.inverted_colors||i.invertedColors,s=!!(o.features&&o.features.epaper);return n?(t.push("const auto COLOR_WHITE = Color(0, 0, 0); // Inverted for e-ink"),t.push("const auto COLOR_BLACK = Color(255, 255, 255); // Inverted for e-ink")):(t.push("const auto COLOR_WHITE = Color(255, 255, 255);"),t.push("const auto COLOR_BLACK = Color(0, 0, 0);")),t.push("const auto COLOR_RED = Color(255, 0, 0);"),t.push("const auto COLOR_GREEN = Color(0, 255, 0);"),t.push("const auto COLOR_BLUE = Color(0, 0, 255);"),t.push("const auto COLOR_YELLOW = Color(255, 255, 0);"),t.push("const auto COLOR_ORANGE = Color(255, 165, 0);"),t.push("auto color_off = COLOR_WHITE;"),t.push("auto color_on = COLOR_BLACK;"),t.push(""),t.push("// Helper to apply a simple grey dither mask for e-paper (checkerboard)"),t.push("auto apply_grey_dither_mask = [&](int x_start, int y_start, int w, int h) {"),t.push("  for (int y = y_start; y < y_start + h; y++) {"),t.push("    for (int x = x_start; x < x_start + w; x++) {"),t.push("      if ((x + y) % 2 == 0) it.draw_pixel_at(x, y, COLOR_WHITE);"),t.push("      else it.draw_pixel_at(x, y, COLOR_BLACK);"),t.push("    }"),t.push("  }"),t.push("};"),window.PluginRegistry&&window.PluginRegistry.onExportHelpers({lines:t,widgets:e.flatMap(r=>r.widgets||[])}),t.push("int currentPage = id(display_page);"),e.forEach((r,d)=>{t.push(`if (currentPage == ${d}) {`),t.push(`  // page:name "${r.name||"Page "+(d+1)}"`),t.push(`  // page:dark_mode "${r.dark_mode||"inherit"}"`),t.push(`  // page:refresh_type "${r.refresh_type||"interval"}"`),t.push(`  // page:refresh_time "${r.refresh_time||""}"`),t.push("  // Clear screen for this page"),t.push("  it.fill(COLOR_WHITE);"),t.push("  color_off = COLOR_WHITE;"),t.push("  color_on = COLOR_BLACK;"),r.widgets&&r.widgets.filter(c=>!c.hidden&&c.type!=="group").forEach(c=>{const a=this.generateWidget(c,{profile:o,layout:i,adapter:this,isEpaper:s});if(a.length>0){const u=a.reduce((g,f)=>{if(!f.trim())return g;const v=f.match(/^ */);return Math.min(g,v?v[0].length:0)},1/0),m=u===1/0?0:u;t.push(...a.map(g=>g.trim()?"  "+g.substring(m):""))}}),t.push("}")}),t}generateWidget(e,i){if(e.type==="group")return[];const o=[],t=Y?Y.get(e.type):null,n=e.type&&e.type.startsWith("lvgl_");if(t&&typeof t.export=="function"){const s={...i,lines:o,addFont:(d,c,a,u)=>this.fonts.addFont(d,c,a,u),getColorConst:d=>J?J.getColorConst(d):`"${d}"`,getAlignX:(d,c,a)=>J?J.getAlignX(d,c,a):c,getAlignY:(d,c,a)=>J?J.getAlignY(d,c,a):c,addDitherMask:(d,c,a,u,m,g,f)=>J?J.addDitherMask(d,c,a,u,m,g,f):null,sanitize:d=>this.sanitize(d),getCondProps:d=>this.getCondProps(d),getConditionCheck:d=>this.getConditionCheck(d),Utils:J,COLORS:qe,ALIGNMENT:Xe,TEXT_Y_OFFSET:0,RECT_Y_OFFSET:0},r=t.export(e,s);r&&Array.isArray(r)?o.push(...r):r&&typeof r=="string"&&o.push(r)}else n?Se?o.push(Se(e)):o.push(`// widget:${e.type} id:${e.id} x:${e.x} y:${e.y} w:${e.width} h:${e.height}`):(o.push(`// widget:${e.type} id:${e.id} status:unsupported`),o.push(`        // Unsupported widget type: ${e.type}`));return o}async fetchHardwarePackage(e){let i=e;window.location.pathname.includes("/esphome-designer")&&!e.startsWith("http")&&!e.startsWith("/")&&(i="/esphome-designer/static/"+e);try{const o=await fetch(i,{cache:"no-store"});if(!o.ok)throw new Error(`HTTP ${o.status}`);return await o.text()}catch(o){return _.error("Failed to fetch hardware package:",o),`# ERROR LOADING PROFILE: ${o.message}`}}sanitizePackageContent(e){if(!e)return"";const i=["esphome:","esp32:","wifi:","api:","ota:","logger:","web_server:","captive_portal:","platformio_options:","preferences:","substitutions:"],o=e.split(`
`),t=[];let n=!1;for(let s of o){const r=s.trim();if(r.length===0){t.push(s);continue}(s.match(/^\s*/)||[""])[0].length===0&&r.endsWith(":")?(n=i.some(c=>r.startsWith(c)),n?t.push("# "+s+" # (Auto-commented)"):t.push(s)):n?t.push("# "+s):t.push(s)}return t.join(`
`)}applyPackageOverrides(e,i,o){if(i.name?.includes("Waveshare Touch LCD 7")){let t=0;o==="portrait"?t=90:o==="landscape"?t=0:o==="portrait_inverted"?t=270:o==="landscape_inverted"&&(t=180),e=e.replace(/rotation:\s*\d+/g,`rotation: ${t}`);const n=e.match(/^(\s*)id:\s*my_touchscreen/m);if(n){const s=n[1];let r="";t===0?r=`transform:
${s}  swap_xy: false
${s}  mirror_x: false
${s}  mirror_y: false`:t===90?r=`transform:
${s}  swap_xy: true
${s}  mirror_x: false
${s}  mirror_y: true`:t===180?r=`transform:
${s}  swap_xy: false
${s}  mirror_x: true
${s}  mirror_y: true`:t===270&&(r=`transform:
${s}  swap_xy: true
${s}  mirror_x: true
${s}  mirror_y: false`),r&&(e=e.replace(/(id:\s*my_touchscreen[^\n\r]*[\r\n]+)/,`$1${s}${r}
`))}}return e}getCondProps(e){const i=(e.condition_entity||"").trim();if(!i)return"";const o=e.condition_operator||"==";let t=` cond_ent:"${i}" cond_op:"${o}"`;return o==="range"?(e.condition_min!==void 0&&e.condition_min!==null&&(t+=` cond_min:"${e.condition_min}"`),e.condition_max!==void 0&&e.condition_max!==null&&(t+=` cond_max:"${e.condition_max}"`)):e.condition_state!==void 0&&e.condition_state!==null&&(t+=` cond_state:"${e.condition_state}"`),t}getConditionCheck(e){const i=(e.condition_entity||"").trim();if(!i)return"";const o=e.condition_operator||"==",t=(e.condition_state||"").trim(),n=t.toLowerCase(),s=e.condition_min,r=e.condition_max,d=i.replace(/[^a-zA-Z0-9_]/g,"_"),a=["binary_sensor.","switch.","light.","input_boolean.","fan.","cover.","vacuum.","lock."].some(v=>i.startsWith(v));let m=i.startsWith("text_sensor.");if(!m&&!a&&o!=="range"){const v=parseFloat(t),b=["on","off","true","false","open","closed","locked","unlocked","home","not_home","occupied","clear","active","inactive","detected","idle"];t&&isNaN(v)&&!b.includes(n)&&(m=!0)}let g=`id(${d}).state`;m&&i.startsWith("text_sensor.");let f="";if(o==="=="||o==="!="||o===">"||o==="<"||o===">="||o==="<=")if(m)f=`${g} ${o} "${t}"`;else if(a){const b=["on","true","1","open","locked","home","occupied","active","detected"].includes(n);o==="=="?f=b?g:`!${g}`:o==="!="?f=b?`!${g}`:g:f=`(int)${g} ${o} ${b?1:0}`}else{let v=parseFloat(t);isNaN(v)&&(["on","true","open","locked","home","occupied","active","detected"].includes(n)?v=1:["off","false","closed","unlocked","not_home","clear","inactive","idle"].includes(n)&&(v=0)),f=`${g} ${o} ${isNaN(v)?0:v}`}else if(o==="range"){const v=parseFloat(s),b=parseFloat(r);f=`${g} >= ${isNaN(v)?0:v} && ${g} <= ${isNaN(b)?100:b}`}return f?`if (${f}) {`:""}sanitize(e){return e?e.replace(/"/g,'\\"'):""}}window.ESPHomeAdapter=di;class xs{constructor(){this.cache={models:{}}}getSettings(){return window.AppState.settings}async fetchModels(e,i){if(!i)return[];try{if(e==="openrouter")return(await(await fetch("https://openrouter.ai/api/v1/models",{headers:{Authorization:`Bearer ${i}`}})).json()).data.map(n=>({id:n.id,name:n.name,context:n.context_length}));if(e==="openai")return(await(await fetch("https://api.openai.com/v1/models",{headers:{Authorization:`Bearer ${i}`}})).json()).data.filter(n=>n.id.startsWith("gpt-")).map(n=>({id:n.id,name:n.id}));if(e==="gemini"){try{const t=await(await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${i}`)).json();if(t.models&&Array.isArray(t.models))return t.models.filter(n=>n.supportedGenerationMethods.includes("generateContent")).map(n=>({id:n.name.replace("models/",""),name:n.displayName||n.name.replace("models/",""),description:n.description}))}catch(o){throw _.warn("Dynamic Gemini model fetch failed:",o),new Error("Failed to fetch Gemini models. Check your API key.")}return[]}}catch(o){throw _.error(`Error fetching models for ${e}:`,o),o}return[]}async processPrompt(e,i){const o=this.getSettings(),t=o.ai_provider||"gemini",n=o[`ai_api_key_${t}`];let s=o[`ai_model_${t}`];if(!s&&t==="gemini"){_.log("No model selected, attempting to auto-detect...");try{const a=await this.fetchModels(t,n);if(a.length>0)s=(a.find(m=>m.id.includes("flash"))||a.find(m=>m.id.includes("1.5-pro"))||a.find(m=>m.id.includes("gemini-pro"))||a[0]).id,_.log(`Auto-detected model: ${s}`),window.AppState.updateSettings({[`ai_model_${t}`]:s});else throw new Error("No models found for this API Key.")}catch(a){_.error("Auto-detection failed:",a),s="gemini-1.5-flash"}}if(!n)throw new Error(`Missing API Key for ${t}`);if(!s)throw new Error(`No model selected for ${t}`);const r=this.getSystemPrompt(),d={...i,widgets:i.widgets.map(a=>this.minifyWidget(a))},c=`
Current Layout Context:
${JSON.stringify(d,null,2)}

User Request:
${e}

Respond ONLY with valid JSON containing the updated "widgets" array for the current page. Do not include any explanation.
`.trim();try{let a="";t==="gemini"?a=await this.callGemini(n,s,r,c):t==="openai"?a=await this.callOpenAI(n,s,r,c):t==="openrouter"&&(a=await this.callOpenRouter(n,s,r,c));let u=a.trim();if(u.includes("```")){const b=u.match(/```(?:json)?\s*([\s\S]*?)\s*```/);b&&b[1]&&(u=b[1].trim())}const m=u.indexOf("["),g=u.indexOf("{");let f=-1,v=-1;m!==-1&&(g===-1||m<g)?(f=m,v=u.lastIndexOf("]")):g!==-1&&(f=g,v=u.lastIndexOf("}")),f!==-1&&v!==-1&&v>f&&(u=u.substring(f,v+1));try{const b=JSON.parse(u);return Array.isArray(b)?b:b.widgets||b}catch(b){_.warn("Fast JSON parse failed, trying repair...",b);try{const E=this.repairJson(u),y=JSON.parse(E);return Array.isArray(y)?y:y.widgets||y}catch(E){throw _.error("JSON repair failed:",E),new Error("AI returned malformed JSON (possibly truncated). Try a shorter prompt or a more powerful model.")}}}catch(a){throw _.error("AI processing failed:",a),a}}async callGemini(e,i,o,t){const n=`https://generativelanguage.googleapis.com/v1beta/models/${i}:generateContent?key=${e}`,s={contents:[{role:"user",parts:[{text:o+`

`+t}]}],generationConfig:{temperature:.1,topP:.95,topK:40,maxOutputTokens:8192,responseMimeType:"application/json"}},r=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),d=await r.json();if(r.status===429)throw new Error("â ï¸ Rate Limit Exceeded: You are sending requests too quickly for the free tier. Please wait a minute and try again.");if(d.error)throw new Error(d.error.message);return d.candidates[0].content.parts[0].text}async callOpenAI(e,i,o,t){const s=i&&i.toLowerCase().includes("gpt-5")?{type:"json_schema",json_schema:{name:"widget_layout",strict:!0,schema:{type:"object",properties:{widgets:{type:"array",items:{type:"object"}}},required:["widgets"],additionalProperties:!1}}}:{type:"json_object"},d=await(await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:i,messages:[{role:"system",content:o},{role:"user",content:t}],temperature:.1,max_tokens:8192,response_format:s})})).json();if(d.error)throw new Error(d.error.message);return d.choices[0].message.content}async callOpenRouter(e,i,o,t){const s=await(await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:i,messages:[{role:"system",content:o},{role:"user",content:t}],temperature:.1,max_tokens:4096})})).json();if(s.error)throw new Error(s.error.message);return s.choices[0].message.content}getSystemPrompt(){return`
You are an expert UI designer and developer for ESPHome devices. 
Your task is to modify or create a widget list based on user instructions.

WIDGET TYPES & PROPS:
- text: { x, y, width, height, text, font_size, font_family, font_weight (400 or 700), color, align }
- sensor_text: { x, y, width, height, entity, prefix, suffix, font_size, color }
- datetime: { x, y, width, height, format, time_font_size, date_font_size, color }
- weather_forecast: { x, y, width, height, entity, layout ("horizontal"/"vertical"), icon_size, temp_font_size, day_font_size }
- weather_icon: { x, y, width, height, entity, size, color }
- icon: { x, y, width, height, icon, icon_size, color }
- battery_icon: { x, y, width, height, entity, color }
- progress_bar: { x, y, width, height, color, bar_height }
- graph: { x, y, width, height, entity, color, duration }
- shape_rect / rounded_rect / shape_circle: { x, y, width, height, color, fill (bool), border_width, opacity }
- lvgl_*: Advanced widgets (lvgl_button, lvgl_switch, lvgl_slider, lvgl_arc, etc).

STRICT OPERATIONAL RULES:
1. CONTENT ACCURACY: If the user says "reads 'X'", the 'text' property MUST BE "X". NEVER use generic placeholders like "Text".
2. TYPOGRAPHY: "Bold" = font_weight: 700. "Normal/Regular" = font_weight: 400. "Large" = font_size: 28+.
3. VISUAL HIERARCHY: Use 'shape_rect' or 'rounded_rect' to create headers, footers, or background cards for groups of widgets. Use small thin shapes as dividers.
4. UNIQUE IDS: Every new widget MUST have a unique ID like "w_" + timestamp or a short descriptive string. Never leave ID as null or undefined.
5. CANVAS BOUNDS: Stay within ${JSON.stringify(window.AppState.getCanvasDimensions())}.
6. COLOR USAGE: Check "display_type" in context:
   - "monochrome": Use ONLY "black" or "white". No grays, no colors.
   - "color_epaper": Use limited palette: black, white, red, green, blue, yellow, orange. No gradients.
   - "color_lcd": Full RGB colors allowed. Use hex codes like "#FF5722" or CSS names.
7. LVGL WIDGETS: If "display_type" is "monochrome" or "color_epaper", do NOT use lvgl_* widgets unless the user explicitly requests LVGL. Use standard widgets (text, shape_rect, icon, etc.) instead. LVGL is designed for LCDs with fast refresh.

FEW-SHOT EXAMPLE:
User: "Add a large bold title that reads 'Home Status' at the top with a separator line."
Response: [
  {"id": "w_title", "type": "text", "x": 20, "y": 10, "width": 760, "height": 50, "text": "Home Status", "font_size": 32, "font_weight": 700, "align": "CENTER"},
  {"id": "w_sep", "type": "shape_rect", "x": 20, "y": 65, "width": 760, "height": 2, "color": "black", "fill": true}
]

8. DROP SHADOWS: For LCD displays ("color_lcd"), add subtle drop shadows to shapes and cards.
   HOW TO: Create a DUPLICATE of the widget to be shadowed.
           - ID: [original_id]_shadow
           - X/Y: original.x + 4, original.y + 4
           - Color: "black" (or "white" if background is dark)
           - Z-Order: Place the shadow widget BEFORE the main widget in the list so it renders behind.
           - Opacity: If supported by the widget type ('shape_rect'), set opacity to 0.4. If not, use a gray color like "#333333".

DESIGN GOAL: Create "Beautiful" layouts. Use whitespace, professional alignment, and decorative shapes to make the UI look premium.
`.trim()}repairJson(e){let i=[],o=!1,t=!1;for(let s=0;s<e.length;s++){const r=e[s];if(t){t=!1;continue}if(r==="\\"){t=!0;continue}if(r==='"'){o=!o;continue}o||(r==="["||r==="{"?i.push(r==="["?"]":"}"):(r==="]"||r==="}")&&i.length>0&&i[i.length-1]===r&&i.pop())}let n=e;for(o&&(n+='"'),n=n.trim().replace(/,\s*$/,"");i.length>0;)n+=i.pop();return n}minifyWidget(e){const{id:i,type:o,x:t,y:n,width:s,height:r,...d}=e;return{id:i,type:o,x:t,y:n,width:s,height:r,...d}}}const Ft=[{id:"core",name:"Core Widgets",expanded:!0,widgets:[{type:"label",label:"Floating text",tag:"Text",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><text x="4" y="17" font-size="14" font-weight="bold" fill="currentColor">Aa</text></svg>'},{type:"sensor_text",label:"Sensor text",tag:"Entity",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><circle cx="8" cy="12" r="3" fill="none" stroke="currentColor" stroke-width="2" /><path d="M11 12h9M14 9l3 3-3 3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'},{type:"datetime",label:"Date & Time",tag:"Time",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2" /><path d="M12 7v5l3 3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'},{type:"icon",label:"MDI icon",tag:"Icon",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M12 2L9 9H2l6 4.5L5.5 22 12 17l6.5 5-2.5-8.5L22 9h-7z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round" /></svg>'},{type:"weather_icon",label:"Weather icon",tag:"Icon",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><circle cx="12" cy="10" r="4" fill="none" stroke="currentColor" stroke-width="2" /><path d="M12 2v2M12 16v2M4 10H2M22 10h-2M5.6 4.6l1.4 1.4M17 6l1.4-1.4M5.6 15.4l1.4-1.4M17 14l1.4 1.4" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'},{type:"image",label:"Image",tag:"Media",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="3" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><circle cx="8.5" cy="8.5" r="1.5" fill="currentColor" /><path d="M21 15l-5-5L11 15l-3-3-5 5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'},{type:"online_image",label:"Puppet image",tag:"Remote",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="5" width="14" height="14" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><circle cx="8" cy="10" r="1.5" fill="currentColor" /><path d="M17 12l-4-4-4 4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" /><circle cx="19" cy="6" r="3" fill="none" stroke="currentColor" stroke-width="2" /><path d="M19 5v2M19 9v.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'}]},{id:"shapes",name:"Shapes",expanded:!0,widgets:[{type:"shape_rect",label:"Rectangle",tag:"Shape",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="14" rx="2" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"rounded_rect",label:"Rounded Rect",tag:"Shape",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="14" rx="6" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"shape_circle",label:"Circle",tag:"Shape",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"line",label:"Line",tag:"Shape",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><line x1="4" y1="12" x2="20" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'}]},{id:"advanced",name:"Advanced",expanded:!0,widgets:[{type:"graph",label:"Graph / Chart",tag:"Data",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M3 3v18h18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" /><path d="M7 14l4-4 4 4 5-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'},{type:"progress_bar",label:"Progress bar",tag:"Entity",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="9" width="20" height="6" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><rect x="3" y="10" width="12" height="4" rx="1" fill="currentColor" /></svg>'},{type:"qr_code",label:"QR Code",tag:"Tools",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" fill="currentColor" /><rect x="14" y="3" width="7" height="7" fill="currentColor" /><rect x="3" y="14" width="7" height="7" fill="currentColor" /><rect x="14" y="14" width="3" height="3" fill="currentColor" /></svg>'},{type:"calendar",label:"Calendar",tag:"Events",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><path d="M16 2v4M8 2v4M3 10h18" stroke="currentColor" stroke-width="2" /></svg>'},{type:"weather_forecast",label:"Weather Forecast",tag:"Forecast",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><circle cx="12" cy="10" r="4" fill="none" stroke="currentColor" stroke-width="2" /><path d="M12 2v2M12 16v2M4 10H2M22 10h-2M5.6 4.6l1.4 1.4M17 6l1.4-1.4M5.6 15.4l1.4-1.4M17 14l1.4 1.4" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'},{type:"quote_rss",label:"Quote / RSS",tag:"Info",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M6 17h3l2-4V7H5v6h3M13 17h3l2-4V7h-6v6h3" fill="none" stroke="currentColor" stroke-width="2" /></svg>'}]},{id:"inputs",name:"Inputs",expanded:!1,icon:'<svg class="category-svg" viewBox="0 0 24 24" width="16" height="16"><path d="M9 11.24V7.5C9 6.12 10.12 5 11.5 5S14 6.12 14 7.5v3.74c1.21-.81 2-2.18 2-3.74C16 5.01 13.99 3 11.5 3S7 5.01 7 7.5c0 1.56.79 2.93 2 3.74zM16.06 17H15v-1l-1-1h-6l-1 1v1H5.94c-.58 0-1.06-.48-1.06-1.06V7.5c0-3.59 2.91-6.5 6.5-6.5s6.5 2.91 6.5 6.5v8.44c0 .58-.48 1.06-1.06 1.06z" fill="none" stroke="currentColor" stroke-width="2" /><circle cx="12" cy="13" r="1.5" fill="currentColor" /></svg>',widgets:[{type:"touch_area",label:"Touch Area",tag:"Input",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="5" y="5" width="14" height="14" rx="2" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="2,2" /><circle cx="12" cy="12" r="3" fill="currentColor" /></svg>'},{type:"nav_next_page",label:"Next Page",tag:"Nav",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M10 6l6 6-6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'},{type:"nav_previous_page",label:"Prev Page",tag:"Nav",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M14 6l-6 6 6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'},{type:"nav_reload_page",label:"Reload Page",tag:"Nav",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M23 4v6h-6M1 20v-6h6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'},{type:"template_nav_bar",label:"Navigation Bar",tag:"Template",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><path d="M7 12l-3-3 3-3M17 12l3-3-3-3M12 9v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'}]},{id:"ondevice",name:"On Device Sensors",expanded:!0,widgets:[{type:"battery_icon",label:"Battery",tag:"Sensor",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="7" width="18" height="10" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><rect x="4" y="9" width="8" height="6" fill="currentColor" /><path d="M20 10h2v4h-2" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"wifi_signal",label:"WiFi Signal",tag:"Sensor",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M12 3C7.5 3 3.8 5.4 2 9l2 2c1.3-2.5 4-4.2 8-4.2s6.7 1.7 8 4.2l2-2c-1.8-3.6-5.5-6-10-6z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" /><path d="M12 9c-2.7 0-5.1 1.4-6.5 3.5L7 14c1-1.4 2.8-2.3 5-2.3s4 .9 5 2.3l1.5-1.5C17.1 10.4 14.7 9 12 9z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" /><circle cx="12" cy="18" r="2" fill="currentColor" /></svg>'},{type:"ondevice_temperature",label:"Temperature",tag:"SHT4x",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M12 2a2 2 0 00-2 2v10.1a4 4 0 104 0V4a2 2 0 00-2-2z" fill="none" stroke="currentColor" stroke-width="2" /><circle cx="12" cy="18" r="2" fill="currentColor" /></svg>'},{type:"ondevice_humidity",label:"Humidity",tag:"SHT4x",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M12 2.69l5.66 5.66a8 8 0 11-11.31 0z" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"template_sensor_bar",label:"On-Board Sensor Bar",tag:"New",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><path d="M5 12h2M10 12h2M15 12h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'}]},{id:"lvgl",name:"LVGL Components",expanded:!1,icon:'<svg class="category-svg" viewBox="0 0 24 24" width="16" height="16"><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5l-2.5 1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round" /></svg>',widgets:[{type:"lvgl_obj",label:"Base Object",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"lvgl_label",label:"Label",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><text x="4" y="17" font-size="14" font-weight="bold" fill="currentColor">Aa</text></svg>'},{type:"lvgl_line",label:"LVGL Line",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><line x1="4" y1="12" x2="20" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'},{type:"lvgl_button",label:"Button",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="4" y="8" width="16" height="8" rx="2" fill="currentColor" fill-opacity="0.2" stroke="currentColor" stroke-width="2" /><text x="12" y="16.5" font-size="8" text-anchor="middle" fill="currentColor">BTN</text></svg>'},{type:"lvgl_switch",label:"Switch",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="4" y="8" width="16" height="8" rx="4" fill="none" stroke="currentColor" stroke-width="2" /><circle cx="16" cy="12" r="3" fill="currentColor" /></svg>'},{type:"lvgl_checkbox",label:"Checkbox",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><polyline points="9 12 11 14 15 10" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"lvgl_slider",label:"Slider",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><line x1="4" y1="12" x2="20" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" /><circle cx="12" cy="12" r="3" fill="currentColor" /></svg>'},{type:"lvgl_bar",label:"Bar",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="9" width="20" height="6" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><rect x="3" y="10" width="12" height="4" rx="1" fill="currentColor" /></svg>'},{type:"lvgl_arc",label:"Arc",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M4 18 A 10 10 0 1 1 20 18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'},{type:"lvgl_meter",label:"Meter",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M4 18 A 10 10 0 1 1 20 18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" /><line x1="12" y1="18" x2="16" y2="10" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>'},{type:"lvgl_spinner",label:"Spinner",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"lvgl_led",label:"LED",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="6" fill="currentColor" /><circle cx="12" cy="12" r="8" fill="none" stroke="currentColor" stroke-width="2" /></svg>'},{type:"lvgl_chart",label:"Chart",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><path d="M3 3v18h18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" /><path d="M7 14l4-4 4 4 5-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'},{type:"lvgl_img",label:"Image",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="3" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><circle cx="8.5" cy="8.5" r="1.5" fill="currentColor" /><path d="M21 15l-5-5L11 15l-3-3-5 5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>'},{type:"lvgl_qrcode",label:"QR Code",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" fill="currentColor" /><rect x="14" y="3" width="7" height="7" fill="currentColor" /><rect x="3" y="14" width="7" height="7" fill="currentColor" /><rect x="14" y="14" width="3" height="3" fill="currentColor" /></svg>'},{type:"lvgl_dropdown",label:"Dropdown",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="8" width="20" height="8" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><polyline points="16 11 18 13 20 11" fill="currentColor" /></svg>'},{type:"lvgl_roller",label:"Roller",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="6" y="2" width="12" height="20" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><line x1="6" y1="10" x2="18" y2="10" stroke="currentColor" stroke-width="1" /><line x1="6" y1="14" x2="18" y2="14" stroke="currentColor" stroke-width="1" /></svg>'},{type:"lvgl_spinbox",label:"Spinbox",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="4" y="8" width="16" height="8" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><path d="M6 12l2-2 2 2" fill="none" stroke="currentColor" stroke-width="1" /><path d="M14 12l2 2 2-2" fill="none" stroke="currentColor" stroke-width="1" /></svg>'},{type:"lvgl_textarea",label:"Textarea",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" fill="none" stroke="currentColor" stroke-width="2" /><line x1="6" y1="8" x2="14" y2="8" stroke="currentColor" stroke-width="2" /></svg>'},{type:"lvgl_keyboard",label:"Keyboard",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><line x1="6" y1="10" x2="8" y2="10" stroke="currentColor" stroke-width="2" /><line x1="10" y1="10" x2="12" y2="10" stroke="currentColor" stroke-width="2" /></svg>'},{type:"lvgl_buttonmatrix",label:"Btn Matrix",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="7" width="9" height="4" fill="none" stroke="currentColor" stroke-width="1" /><rect x="13" y="7" width="9" height="4" fill="none" stroke="currentColor" stroke-width="1" /><rect x="2" y="13" width="9" height="4" fill="none" stroke="currentColor" stroke-width="1" /><rect x="13" y="13" width="9" height="4" fill="none" stroke="currentColor" stroke-width="1" /></svg>'},{type:"lvgl_tabview",label:"Tabview",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2" fill="none" stroke="currentColor" stroke-width="2" /><line x1="2" y1="8" x2="22" y2="8" stroke="currentColor" stroke-width="1" /></svg>'},{type:"lvgl_tileview",label:"Tileview",icon:'<svg class="widget-icon" viewBox="0 0 24 24"><rect x="2" y="2" width="9" height="9" fill="none" stroke="currentColor" stroke-width="2" /><rect x="13" y="2" width="9" height="9" fill="none" stroke="currentColor" stroke-width="2" /><rect x="2" y="13" width="9" height="9" fill="none" stroke="currentColor" stroke-width="2" /><rect x="13" y="13" width="9" height="9" fill="none" stroke="currentColor" stroke-width="2" /></svg>'}]}];async function Es(l){const e=document.getElementById(l);if(!e)return;e.innerHTML='<div class="palette-loading" style="padding: 20px; color: #999; text-align: center; font-size: 13px;">Loading widgets...</div>';const i=[];Ft.forEach(o=>{o.widgets.forEach(t=>{i.includes(t.type)||i.push(t.type)})}),_.log(`[Palette] Pre-loading ${i.length} widget plugins...`);try{await Promise.all(i.map(o=>Y.load(o)))}catch(o){_.error("[Palette] Failed to load some plugins:",o)}e.innerHTML="",Ft.forEach(o=>{const t=document.createElement("div");t.className=`widget-category ${o.expanded?"expanded":""}`,t.dataset.category=o.id;const n=document.createElement("div");n.className="widget-category-header";let s='<span class="category-icon">âº</span>';o.icon&&(s+=o.icon),n.innerHTML=`
            ${s}
            <span class="category-name">${o.name}</span>
            ${o.widgets.length>0&&!o.expanded?`<span class="category-count">${o.widgets.length}</span>`:""}
        `,n.addEventListener("click",()=>{t.classList.toggle("expanded")});const r=document.createElement("div");r.className="widget-category-items",o.widgets.forEach(d=>{const c=document.createElement("div");c.className="item",c.draggable=!0,c.dataset.widgetType=d.type;const a=Y.get(d.type),u=d.label||a?.name;let m="";d.tag&&(m=`<span class="tag">${d.tag}</span>`),c.innerHTML=`
                ${d.icon}
                <span class="label">${u}</span>
                ${m}
            `,c.title=`Add ${u} to canvas`,c.addEventListener("dragstart",g=>{g.dataTransfer.setData("application/widget-type",d.type),g.dataTransfer.effectAllowed="copy"}),r.appendChild(c)}),t.appendChild(n),t.appendChild(r),e.appendChild(t)})}class Ss{constructor(){this.listContainer=null,this.header=null,this.panel=null,this.draggedIndex=null,this.render=this.render.bind(this),this.highlightSelected=this.highlightSelected.bind(this)}init(){if(this.listContainer=document.getElementById("hierarchyList"),this.header=document.getElementById("hierarchyHeader"),this.panel=document.getElementById("hierarchyPanel"),!this.listContainer||!this.header||!this.panel){_.error("[HierarchyView] Required DOM elements not found");return}this.controlsContainer=document.createElement("div"),this.controlsContainer.id="hierarchyControls",this.controlsContainer.className="hierarchy-controls",this.controlsContainer.style.padding="8px 8px",this.controlsContainer.style.borderTop="1px solid var(--border-subtle)",this.panel.appendChild(this.controlsContainer),this.bindEvents(),this.render(),this.renderHeaderActions(),_.log("[HierarchyView] Initialized")}renderHeaderActions(){if(!this.header)return;let e=this.header.querySelector(".hierarchy-header-toggles");if(!e){e=document.createElement("div"),e.className="hierarchy-header-toggles";const i=this.header.querySelector(".chevron");this.header.insertBefore(e,i);const o=this.createHeaderToggle("mdi-lock-outline","Toggle All Locks",()=>{const n=h.getCurrentPage()?.widgets||[],s=n.every(r=>r.locked);n.forEach(r=>h.updateWidget(r.id,{locked:!s}))}),t=this.createHeaderToggle("mdi-eye-outline","Toggle All Visibility",()=>{const n=h.getCurrentPage()?.widgets||[],s=n.every(r=>r.hidden);n.forEach(r=>h.updateWidget(r.id,{hidden:!s}))});e.appendChild(o),e.appendChild(t)}}createHeaderToggle(e,i,o){const t=document.createElement("div");return t.className="h-toggle",t.title=i,t.innerHTML=`<i class="mdi ${e}"></i>`,t.onclick=n=>{n.stopPropagation(),o()},t}bindEvents(){this.header.addEventListener("click",()=>this.toggleCollapse()),Q(A.STATE_CHANGED,this.render),Q(A.PAGE_CHANGED,this.render),Q(A.SELECTION_CHANGED,this.highlightSelected)}toggleCollapse(){const e=this.panel.classList.toggle("hidden"),i=this.header.querySelector(".chevron");i&&(i.style.transform=e?"rotate(-90deg)":"rotate(0deg)")}highlightSelected(){const e=h.selectedWidgetIds||[];this.listContainer.querySelectorAll(".hierarchy-item").forEach(o=>{e.includes(o.dataset.id)?o.classList.add("selected"):o.classList.remove("selected")}),this.renderControls()}render(){const e=h.getCurrentPage();if(!e)return;if(this.listContainer.innerHTML="",!e.widgets||e.widgets.length===0){this.listContainer.innerHTML='<div style="font-size: 10px; color: var(--muted); text-align: center; padding: 12px;">No widgets on this page</div>',this.controlsContainer.style.display="none";return}const i=e.widgets.filter(n=>!n.parentId).reverse(),o=new Map;e.widgets.forEach(n=>{n.parentId&&(o.has(n.parentId)||o.set(n.parentId,[]),o.get(n.parentId).push(n))});const t=(n,s=0)=>{const r=e.widgets.indexOf(n),d=this.createItem(n,r,s);this.listContainer.appendChild(d);const c=o.get(n.id);c&&n.expanded!==!1&&[...c].reverse().forEach(a=>t(a,s+1))};i.forEach(n=>t(n)),this.highlightSelected(),this.renderControls()}createItem(e,i,o=0){const t=document.createElement("div");t.className=`hierarchy-item ${e.hidden?"hidden-widget":""}`,o>0&&t.classList.add("child-item"),(h.selectedWidgetIds||[]).includes(e.id)&&t.classList.add("selected"),t.dataset.id=e.id,t.dataset.index=i,t.draggable=!e.locked,e.locked&&t.classList.add("locked"),t.style.paddingLeft=12+o*20+"px";const s=this.getWidgetIcon(e.type),r=this.getWidgetLabel(e),d=e.type==="group";return t.innerHTML=`
            <div class="hierarchy-item-drag-handle" style="${e.locked?"display:none":""}">
                <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="9" cy="5" r="1"></circle><circle cx="9" cy="12" r="1"></circle><circle cx="9" cy="19" r="1"></circle>
                    <circle cx="15" cy="5" r="1"></circle><circle cx="15" cy="12" r="1"></circle><circle cx="15" cy="19" r="1"></circle>
                </svg>
            </div>
            ${d?`
            <div class="hierarchy-group-toggle ${e.expanded!==!1?"expanded":""}">
                <i class="mdi mdi-chevron-down"></i>
            </div>
            `:'<div style="width: 16px;"></div>'}
            <div class="hierarchy-item-icon">${s}</div>
            <div class="hierarchy-item-label">${r}</div>
            <div class="hierarchy-item-actions">
                <div class="hierarchy-item-action toggle-lock" title="${e.locked?"Unlock":"Lock"}">
                     <i class="mdi ${e.locked?"mdi-lock-outline":"mdi-lock-open-outline"}"></i>
                </div>
                <div class="hierarchy-item-action toggle-visibility" title="Toggle Visibility">
                    <i class="mdi ${e.hidden?"mdi-eye-off-outline":"mdi-eye-outline"}"></i>
                </div>
                <div class="hierarchy-item-action delete-widget danger" title="Delete Widget">
                    <i class="mdi mdi-delete-outline"></i>
                </div>
            </div>
        `,d&&t.querySelector(".hierarchy-group-toggle").addEventListener("click",a=>{h.updateWidget(e.id,{expanded:e.expanded===!1}),a.stopPropagation()}),t.querySelector(".hierarchy-item-label").addEventListener("click",a=>{if(h.selectedWidgetIds.includes(e.id)){const u=prompt("Rename:",r);u!==null&&u!==""&&u!==r&&h.updateWidget(e.id,{title:u}),a.stopPropagation();return}}),t.addEventListener("click",a=>{const u=a.ctrlKey||a.shiftKey;h.selectWidget(e.id,u),a.stopPropagation()}),t.querySelector(".toggle-lock").addEventListener("click",a=>{h.updateWidget(e.id,{locked:!e.locked}),a.stopPropagation()}),t.querySelector(".toggle-visibility").addEventListener("click",a=>{h.updateWidget(e.id,{hidden:!e.hidden}),a.stopPropagation()}),t.querySelector(".delete-widget").addEventListener("click",a=>{confirm(`Delete widget "${r}"?`)&&h.deleteWidget(e.id),a.stopPropagation()}),t.addEventListener("dragstart",a=>{this.draggedIndex=i,t.classList.add("dragging"),a.dataTransfer.setData("application/widget-id",e.id),a.dataTransfer.effectAllowed="move"}),t.addEventListener("dragend",()=>{t.classList.remove("dragging"),this.draggedIndex=null,this.listContainer.querySelectorAll(".hierarchy-item").forEach(u=>u.classList.remove("drag-over"))}),t.addEventListener("dragover",a=>{a.preventDefault(),a.dataTransfer.dropEffect="move",t.classList.add("drag-over")}),t.addEventListener("dragleave",()=>{t.classList.remove("drag-over")}),t.addEventListener("drop",a=>{a.preventDefault();const u=a.dataTransfer.getData("application/widget-id"),m=t.dataset.id;if(u===m)return;const g=h.getWidgetById(m);if(!g)return;g.type==="group"?h.updateWidget(u,{parentId:m,expanded:!0}):h.updateWidget(u,{parentId:g.parentId||null});const f=parseInt(t.dataset.index);this.draggedIndex!==null&&h.reorderWidget(h.currentPageIndex,this.draggedIndex,f)}),t}renderControls(){const e=h.getSelectedWidgets();if(e.length===0){this.controlsContainer.style.display="none";return}this.controlsContainer.style.display="block",this.controlsContainer.innerHTML="";const i=d=>{const c=document.createElement("div");c.style.fontSize="10px",c.style.color="var(--muted)",c.style.marginBottom="6px",c.style.fontWeight="600",c.style.marginTop="8px",c.textContent=d,this.controlsContainer.appendChild(c)},o=()=>{const d=document.createElement("div");return d.style.display="flex",d.style.gap="4px",this.controlsContainer.appendChild(d),d};i("GROUPING");const t=o(),n=e.some(d=>d.type==="group"||d.parentId),s=document.createElement("button");s.className="btn btn-secondary",s.innerHTML='<i class="mdi mdi-group" style="margin-right:4px"></i>Group',s.style.flex="1",s.style.fontSize="10px",s.disabled=e.length<2||n,s.onclick=()=>h.groupSelection(),t.appendChild(s);const r=document.createElement("button");if(r.className="btn btn-secondary",r.innerHTML='<i class="mdi mdi-ungroup" style="margin-right:4px"></i>Ungroup',r.style.flex="1",r.style.fontSize="10px",r.disabled=!n,r.onclick=()=>h.ungroupSelection(),t.appendChild(r),e.length===1){const d=e[0];i("LAYER ORDER");const c=o();[{label:"Front",icon:"mdi-arrange-bring-to-front",action:()=>this.moveToFront(d)},{label:"Back",icon:"mdi-arrange-send-to-back",action:()=>this.moveToBack(d)},{label:"Up",icon:"mdi-arrow-up",action:()=>this.moveUp(d)},{label:"Down",icon:"mdi-arrow-down",action:()=>this.moveDown(d)}].forEach(u=>{const m=document.createElement("button");m.className="btn btn-secondary",m.innerHTML=`<i class="mdi ${u.icon}"></i>`,m.title=u.label,m.style.flex="1",m.style.fontSize="12px",m.style.padding="4px",m.onclick=()=>u.action(),c.appendChild(m)})}}moveToFront(e){const i=h.getCurrentPage(),o=i.widgets.findIndex(t=>t.id===e.id);o>-1&&o<i.widgets.length-1&&(i.widgets.splice(o,1),i.widgets.push(e),h.setPages(h.pages))}moveToBack(e){const i=h.getCurrentPage(),o=i.widgets.findIndex(t=>t.id===e.id);o>0&&(i.widgets.splice(o,1),i.widgets.unshift(e),h.setPages(h.pages))}moveUp(e){const i=h.getCurrentPage(),o=i.widgets.findIndex(t=>t.id===e.id);o>-1&&o<i.widgets.length-1&&([i.widgets[o],i.widgets[o+1]]=[i.widgets[o+1],i.widgets[o]],h.setPages(h.pages))}moveDown(e){const i=h.getCurrentPage(),o=i.widgets.findIndex(t=>t.id===e.id);o>0&&([i.widgets[o],i.widgets[o-1]]=[i.widgets[o-1],i.widgets[o]],h.setPages(h.pages))}getWidgetLabel(e){let i=e.props?.name||e.props?.title||e.props?.text||e.title;if(!i||i===""){const o=Y.get(e.type);i=o?o.name:e.type}if(i===e.type||Y.get(e.type)&&i===Y.get(e.type).name){const o=e.id.split("_").pop();i=`${i} (${o})`}return i}getWidgetIcon(e){return`<i class="mdi ${{text:"mdi-format-text",sensor_text:"mdi-numeric",icon:"mdi-emoticon-outline",image:"mdi-image",qr_code:"mdi-qrcode",line:"mdi-vector-line",lvgl_line:"mdi-vector-line",rect:"mdi-square-outline",shape_rect:"mdi-square-outline",arc:"mdi-circle-outline",shape_circle:"mdi-circle-outline",bar:"mdi-chart-gantt",button:"mdi-gesture-tap-button",checkbox:"mdi-checkbox-marked-outline",calendar:"mdi-calendar",weather_forecast:"mdi-weather-partly-cloudy",datetime:"mdi-clock-outline",graph:"mdi-chart-timeline-variant",touch_area:"mdi-fingerprint",group:"mdi-folder-outline"}[e]||"mdi-widgets-outline"}"></i>`}}window.aiService=new xs;class Is{constructor(){try{_.log("[App] Constructor started"),this.sidebar=new Ri,_.log("[App] Sidebar created"),this.canvas=new Zi,_.log("[App] Canvas created"),this.propertiesPanel=new ns,_.log("[App] PropertiesPanel created"),this.hierarchyView=new Ss,_.log("[App] HierarchyView created"),this.deviceSettings=new us,_.log("[App] DeviceSettings created"),this.editorSettings=new gs,_.log("[App] EditorSettings created"),this.pageSettings=new fs,_.log("[App] PageSettings created"),this.keyboardHandler=new ri,_.log("[App] KeyboardHandler created"),this.llmPrompt=window.llmPrompt,_.log("[App] LLMPrompt linked"),this.quickSearch=new _s,window.QuickSearch=this.quickSearch,_.log("[App] QuickSearch initialized"),this.adapter=new di,_.log("[App] ESPHomeAdapter initialized"),this.snippetManager=new ws(this.adapter),_.log("[App] SnippetManager initialized"),window.layoutManager&&(this.layoutManager=window.layoutManager,_.log("[App] LayoutManager linked")),this.init()}catch(e){_.error("[App] Critical Error in Constructor:",e)}}async init(){_.log("[App] Initializing ESPHome Designer Designer..."),_.log("[App] AppState:",window.AppState),this.isInitializing=!0,await Es("widgetPalette"),this.sidebar.init(),this.propertiesPanel.init(),this.hierarchyView.init(),this.deviceSettings.init(),this.editorSettings.init(),this.quickSearch.discoverWidgets(),await at();try{localStorage.getItem("reterminal-editor-theme")==="light"?(h.updateSettings({editor_light_mode:!0}),this.editorSettings.applyEditorTheme(!0)):this.editorSettings.applyEditorTheme(!1)}catch(e){_.log("Could not load theme preference:",e)}this.pageSettings.init(),this.llmPrompt&&this.llmPrompt.init(),this.layoutManager&&this.layoutManager.init(),this.setupAutoSave(),this.bindGlobalButtons();try{q()?(_.log("HA Backend detected attempt. Loading layout from backend..."),await Si(),await at(),await he()):(_.log("Running in standalone/offline mode."),this.loadFromLocalStorage())}catch(e){_.error("[App] Failed to load from backend, falling back to local storage:",e),this.loadFromLocalStorage()}window.AppState&&typeof window.AppState.updateLayoutIndicator=="function"&&window.AppState.updateLayoutIndicator(),setTimeout(()=>{this.canvas&&(_.log("[App] Forcing initial canvas centering..."),this.canvas.focusPage(h.currentPageIndex,!1))},100),_.log("Initialization complete."),this.isInitializing=!1}bindGlobalButtons(){const e=document.getElementById("saveLayoutBtn");e&&e.addEventListener("click",()=>{q()?xe().then(()=>G("Layout saved to Home Assistant","success")).catch(r=>G(`Save failed: ${r.message}`,"error")):os()});const i=document.getElementById("loadLayoutBtn");i&&i.addEventListener("change",as);const o=document.getElementById("importProjectBtn");o&&i&&o.addEventListener("click",()=>{i.click()});const t=document.getElementById("deviceSettingsBtn");t?(_.log("Device Settings button found, binding click listener."),t.addEventListener("click",()=>{_.log("Device Settings button clicked."),this.deviceSettings?this.deviceSettings.open():_.error("DeviceSettings instance not found on App.")})):_.error("Device Settings button NOT found in DOM.");const n=document.getElementById("editorSettingsBtn");n&&n.addEventListener("click",()=>{this.editorSettings.open()});const s=document.getElementById("aiPromptBtn");s&&s.addEventListener("click",()=>{this.llmPrompt?this.llmPrompt.open():_.error("LLMPrompt instance not found.")})}loadFromLocalStorage(){try{const e=h.loadFromLocalStorage();e?(_.log("[App] Found saved layout in localStorage, loading..."),re(e)):_.log("[App] No saved layout in localStorage, starting fresh.")}catch(e){_.error("[App] Error loading from local storage:",e)}}setupAutoSave(){let e=null;const i=2e3;W(async()=>{const{on:o,EVENTS:t}=await Promise.resolve().then(()=>fi);return{on:o,EVENTS:t}},void 0,import.meta.url).then(({on:o,EVENTS:t})=>{o(t.STATE_CHANGED,()=>{if(this.isInitializing){_.log("[AutoSave] Skipping during initialization...");return}e&&clearTimeout(e),e=setTimeout(()=>{q()?(_.log("[AutoSave] Triggering background save to HA..."),xe().catch(()=>{})):(_.log("[AutoSave] Saving to local storage..."),h.saveToLocalStorage())},i)})})}}document.addEventListener("DOMContentLoaded",()=>{const l=new Is;window.app=l,window.openDeviceSettings=()=>l.deviceSettings?.open(),window.openEditorSettingsModal=e=>l.editorSettings?.open(e),window.pageSettings=l.pageSettings,window.ESPHomeDesigner=window.ESPHomeDesigner||{},window.ESPHomeDesigner.app=l,window.ESPHomeDesigner.ui={sidebar:l.sidebar,canvas:l.canvas,properties:l.propertiesPanel}});export{ks as a,Ls as d,Cs as g};
